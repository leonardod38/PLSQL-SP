CREATE OR REPLACE PACKAGE ctactpa0001_001 IS

        /* VERSAO V 9.0 */

        --
        PROCEDURE Consulta_Saldo_Desconto(p_consulta_saldo_in      IN consulta_saldo_in
                                         ,p_consulta_saldo_out     OUT consulta_saldo_out
                                         ,p_data_provisao_stder_in IN DATE DEFAULT NULL);
        --
        
END CTACTPA0001_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0002_001 IS

        /* VERSAO V 9.0 */

        --
        PROCEDURE       Valida_Valor            (p_valida_valor_in      IN      valida_valor_in
                                                ,p_valida_valor_out     OUT     valida_valor_out);
        --

END     CTACTPA0002_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0003_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        PROCEDURE Provisiona_Valor(p_provisiona_valor_in   IN provisiona_valor_in
                                  ,p_provisiona_valor_out  OUT provisiona_valor_out
                                  ,p_data_provsao_stder_in IN DATE DEFAULT NULL);

        --
END CTACTPA0003_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0004_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        PROCEDURE       Efetiva_Provisao        (p_efetiva_provisao_in  IN      efetiva_provisao_in
                                                ,p_efetiva_provisao_out OUT     efetiva_provisao_out);
        --
END     CTACTPA0004_001;
/


CREATE OR REPLACE PACKAGE ctactpa0005_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        TYPE    verbas  IS      RECORD  (id_verba       NUMBER(38));
        --
        TYPE    t_verbas        IS      TABLE   OF      verbas  INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       Estorna_Provisao        (p_estorna_provisao_in  IN      estorna_provisao_in
                                                ,p_estorna_provisao_out OUT     estorna_provisao_out);
        --
END     CTACTPA0005_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0006_001 IS
        --
        PROCEDURE       Transfere_Verba_Corretor        (p_transfere_verba_corretor_in  IN      transfere_verba_corretor_in
                                                        ,p_transfere_verba_corretor_out OUT     transfere_verba_corretor_out);
        --
END     CTACTPA0006_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0007_001 IS
        --
        PROCEDURE       Distribui_Verba_Assessoria      (p_distribui_verba_assessor_in  IN      distribui_verba_assessoria_in
                                                        ,p_distribui_verba_assessor_out OUT     distribui_verba_assessoria_out);
        --
END     CTACTPA0007_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0008_001 IS
        --
        PROCEDURE       Transfere_Verba_Assessorias     (p_transf_verba_assessorias_in  IN      transf_verba_assessorias_in
                                                        ,p_transf_verba_assessorias_out OUT     transf_verba_assessorias_out);
        --
END     CTACTPA0008_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0009_001 IS
        --
        PROCEDURE       Credita_Verba_Carteira  (p_credita_verba_carteira_in    IN      credita_verba_carteira_in
                                                ,p_credita_verba_carteira_out   OUT     credita_verba_carteira_out);
        --
END     CTACTPA0009_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0010_001 IS
        --
        PROCEDURE       Atualiza_Cadastro_Corretores;
        --
END     CTACTPA0010_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0011_001 IS
        --
        PROCEDURE       Transfere_Corretor_Assessoria   (p_transfere_corretor_asses_in  IN      transfere_corretor_asses_in
                                                        ,p_transfere_corretor_asses_out OUT     transfere_corretor_asses_out);
        --
END     CTACTPA0011_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0012_001   IS
        --
        PROCEDURE       Consulta_Saldo_Portal   (p_consulta_saldo_in    IN      consulta_saldo_in
                                                ,p_consulta_saldo_out   OUT     consulta_saldo_out);
        --
END     CTACTPA0012_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0013_001 IS
        --
        PROCEDURE       Cancela_Verba   (p_cancela_verba_in     IN      cancela_verba_in
                                        ,p_cancela_verba_out    OUT     cancela_verba_out);
        --
END     CTACTPA0013_001;
/


CREATE OR REPLACE PACKAGE ctactpa0014_001 IS
        --
        PROCEDURE       Consulta_Lancamento     (p_consulta_lancamento_in       IN      consulta_lancamento_in
                                                ,p_consulta_lancamento_out      OUT     consulta_lancamento_out
                                                ,p_lista_lancamentos            OUT     sys_refcursor);
        --
        PROCEDURE       Relatorio_Lancamento    (p_relatorio_lancamento_in      IN      relatorio_lancamento_in
                                                ,p_relatorio_lancamento_out     OUT     relatorio_lancamento_out
                                                ,p_relatorio_lancamentos        OUT     sys_refcursor);
        --
        FUNCTION        RetornaLancamento       (p_nr_itseg             IN      NUMBER
                                                ,p_cd_situc_lacto       IN      VARCHAR2
                                                ,p_id_lacto             IN      NUMBER
                                                ,p_id_verba             IN      NUMBER          )
        RETURN          NUMBER;
        --
        FUNCTION        RetornaDescAgrav        (p_vl_agrvo_ppota       IN      NUMBER
                                                ,p_vl_lacto             IN      NUMBER
                                                ,p_cd_ngoco             IN      NUMBER
                                                ,p_tp_desct_agrvo       IN      VARCHAR2)
        RETURN          NUMBER;
        --
        FUNCTION        RetornaDsVerba  (p_cd_tipo_verba        IN      VARCHAR2)
        RETURN          VARCHAR2;
        --
        FUNCTION        RetornaDsVerbaVigencia  (p_cd_tipo_verba        IN      VARCHAR2
                                                ,p_dt_inico_vigen       IN      DATE
                                                ,p_dt_fim_vigen         IN      DATE    )
        RETURN          VARCHAR2;
        --
        FUNCTION        RetornaNmSegmt  (p_cd_segmt_prdut       IN      NUMBER)
        RETURN          VARCHAR2;
        --
        FUNCTION        RetornaCdMdupr  (p_id_prdut_sistm_origm IN      NUMBER)
        RETURN          NUMBER;
        --
END     ctactpa0014_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0015_001 IS
        --
        PROCEDURE       Consulta_Log    (p_consulta_log_in      IN      consulta_log_in
                                        ,p_consulta_log_out     OUT     consulta_log_out
                                        ,p_lista_logs           OUT     sys_refcursor);
        --
END     CTACTPA0015_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0016_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        PROCEDURE       Cancelamento_Proporcional       (p_cancelamento_prop_in         IN      cancelamento_proporcional_in
                                                        ,p_cancelamento_prop_out        OUT     cancelamento_proporcional_out);
        --
END     CTACTPA0016_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0017_001   IS

        --
        -- PROCEDURE FAZ A LIMPEZA DA BASE DE DADOS A PARTIR DE PARAMETROS
        --
        PROCEDURE       LIMPA_BASE_LOGS ;
        --

END     CTACTPA0017_001;
/


CREATE OR REPLACE PACKAGE ctactpa0018_001 IS
 --
 PROCEDURE GeraPlanilha (p_id_query IN NUMBER
 ,p_parametros IN t_param
 ,p_emails IN VARCHAR2
 ,p_usuario IN VARCHAR2
 ,p_tp_local IN NUMBER
 ,p_cd_local IN NUMBER
 ,p_cd_erro OUT NUMBER
 ,p_msg_erro OUT VARCHAR2);
 --
END ctactpa0018_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0019_001 IS
        --
        PROCEDURE       Credita_Verba_Sucsl_Diret  (p_credita_verba_sucs_diret_in         IN      credita_verba_sucs_diret_in
                                                   ,p_credita_verba_sucs_diret_out        OUT     credita_verba_sucs_diret_out);
        --
END     CTACTPA0019_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0020_001 IS

        --
        PROCEDURE       Distribui_Verba_Diretoria      (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                        ,p_distribui_verba_dir_out OUT     distribui_verba_diretoria_out);
        --

END     CTACTPA0020_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0021_001 IS

        --
        PROCEDURE       Distribui_Verba_Assessoria      (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                        ,p_distribui_verba_dir_out OUT     distribui_verba_diretoria_out);
        --

END     CTACTPA0021_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0022_001 IS
        --
        PROCEDURE       Efetiva_Primeira_Parcela        (p_efetiva_primeira_parcela_in  IN      efetiva_primeira_parcela_in
                                                        ,p_efetiva_primeira_parcela_out OUT     efetiva_primeira_parcela_out);
        --
END     CTACTPA0022_001;
/


CREATE OR REPLACE PACKAGE ctactpa0023_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       VerbasDiretoria         (       p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     CTACTPA0023_001;
/


CREATE OR REPLACE PACKAGE ctactpa0024_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       VerbasSucursal                  (p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     CTACTPA0024_001;
/


CREATE OR REPLACE PACKAGE ctactpa0025_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       LancamentosDiretoria    (       p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     CTACTPA0025_001;
/


CREATE OR REPLACE PACKAGE ctactpa0026_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       LancamentosSucursal     (       p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     CTACTPA0026_001;
/


CREATE OR REPLACE PACKAGE ctactpa0027_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       LancamentosProduto      (       p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     ctactpa0027_001;
/


CREATE OR REPLACE PACKAGE ctactpa0028_001 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       VerbasProduto   (p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;
        --
        FUNCTION        retornanmdiretoria (p_cd_diret IN NUMBER)
                        RETURN  VARCHAR2;
        --
END     ctactpa0028_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0029_ERRO_65 IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000)
                                                ,v_retorno_21   VARCHAR2(4000)
                                                ,v_retorno_22   VARCHAR2(4000)
                                                ,v_retorno_23   VARCHAR2(4000)
                                                ,v_retorno_24   VARCHAR2(4000)
                                                ,v_retorno_25   VARCHAR2(4000)
                                                ,v_retorno_26   VARCHAR2(4000)
                                                ,v_retorno_27   VARCHAR2(4000)
                                                ,v_retorno_28   VARCHAR2(4000)
                                                ,v_retorno_29   VARCHAR2(4000)
                                                ,v_retorno_30   VARCHAR2(4000)
                                                ,v_retorno_31   VARCHAR2(4000)
                                                ,v_retorno_32   VARCHAR2(4000)
                                                ,v_retorno_33   VARCHAR2(4000)
                                                ,v_retorno_34   VARCHAR2(4000)
                                                ,v_retorno_35   VARCHAR2(4000)
                                                ,v_retorno_36   VARCHAR2(4000)
                                                ,v_retorno_37   VARCHAR2(4000)
                                                ,v_retorno_38   VARCHAR2(4000)
                                                ,v_retorno_39   VARCHAR2(4000)
                                                ,v_retorno_40   VARCHAR2(4000)

                                                );
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       Gera_Planilha                   (p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;

        PROCEDURE       GeraProcessamentoRecepcao       (p_parametros    IN      admcta.t_param,
                                                        p_usuario       IN      VARCHAR2,
                                                        p_tp_local      IN      NUMBER,
                                                        p_cd_local      IN      NUMBER,
                                                        relatorio       OUT     t_rec_retorno,
                                                        cd_retorno      OUT     NUMBER,
                                                        msg_retorno     OUT     VARCHAR2)  ;

END CTACTPA0029_ERRO_65;
/


CREATE OR REPLACE PACKAGE CTACTPA0030_RELAT_MONITORADOS   IS

        PROCEDURE       RelatoriosMonitorados;

END  CTACTPA0030_RELAT_MONITORADOS;
/


CREATE OR REPLACE PACKAGE CTACTPA0031_MOTOR_CALCULO   IS
        --
        PROCEDURE       MONITORA;
        --
        PROCEDURE       MONITORA_SUBSCRICAO;
        --
END     CTACTPA0031_MOTOR_CALCULO;
/


CREATE OR REPLACE PACKAGE ctactpa0100_001 IS

    /* VERSAO V 7.9 */

    --
    TYPE t_corretor IS RECORD(
         cd_crtor_segur    cta0012_crtor.cd_crtor_segur%TYPE
        ,nm_crtor_segur    cta0012_crtor.nm_crtor_segur%TYPE
        ,cd_susep_crtor    cta0012_crtor.cd_susep_crtor%TYPE
        ,nr_cpf_cnpj_crtor cta0012_crtor.nr_cpf_cnpj_crtor%TYPE
        ,cd_sucsl_comrl    cta0012_crtor.cd_sucsl_comrl%TYPE
        ,nm_sucsl          cta0012_crtor.nm_sucsl%TYPE
        ,tp_pesoa          cta0012_crtor.tp_pesoa%TYPE
        ,cd_diret_comrl    cta0012_crtor.cd_diret_comrl%TYPE
        ,cd_local_captc    cta0012_crtor.cd_local_captc%TYPE
        ,cd_asses          cta0012_crtor.cd_asses%TYPE);

    --
    FUNCTION SistemaChamadorValido(p_sistema_chamador IN VARCHAR2) RETURN BOOLEAN;

    --
    PROCEDURE HabilitaSaldoCCStder(p_vl_param IN VARCHAR2
                                  ,p_cd_erro  OUT NUMBER
                                  ,p_msg_erro OUT VARCHAR2);

    --
    FUNCTION ConsultaSaldoCCStder RETURN BOOLEAN;

    --
    FUNCTION ModuloProdutoValido(p_cd_mdupr IN VARCHAR2
                                ,p_cd_sist  IN VARCHAR2
                                ,p_cd_segmt IN NUMBER
                                ,p_dt_procm IN DATE
                                ,p_cd_erro  OUT NUMBER
                                ,p_msg_erro OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION IsDataValida(p_data_in  IN VARCHAR2
                         ,p_data_out OUT DATE) RETURN BOOLEAN;

    --
    FUNCTION RetornaDtProcm RETURN DATE;

    --
    FUNCTION RetornaSegmentoProduto(p_sistema_chamador IN VARCHAR2
                                   ,p_cd_produto       IN VARCHAR2
                                   ,p_dt_procm         IN DATE
                                   ,p_cd_erro          OUT NUMBER
                                   ,p_msg_erro         OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION IsCorretorBloqueado(p_cd_crtor       IN NUMBER
                                ,p_cd_segmt_prdut IN NUMBER
                                ,p_cd_erro        OUT NUMBER
                                ,p_msg_erro       OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION ValidaSaldo(p_sq_log           IN NUMBER
                        ,p_sistema_chamador IN VARCHAR2
                        ,p_cd_crtor         IN NUMBER
                        ,p_vl_saldo_verba   IN NUMBER) RETURN NUMBER;

    --
    FUNCTION BuscaValorDescontoMaximo(p_sq_log           IN NUMBER
                                     ,p_cd_crtor         IN NUMBER
                                     ,p_pc_comis         IN NUMBER
                                     ,p_vl_premio        IN NUMBER
                                     ,p_pc_maxmo_desct   IN NUMBER) RETURN NUMBER;

    --
    FUNCTION BuscaSaldo(p_cd_crtor       IN NUMBER
                       ,p_cd_segmt_prdut IN NUMBER
                       ,p_dt_procm       IN DATE
                       ,p_cd_erro        OUT NUMBER
                       ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION RetornaProvisao(p_cd_ngoco       IN NUMBER
                            ,p_nr_item        IN NUMBER
                            ,p_cd_crtor       IN NUMBER
                            ,p_tp_desct_agrvo OUT VARCHAR2
                            ,p_cd_erro        OUT NUMBER
                            ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION RetornaProvisaoEnd(p_cd_ngoco       IN NUMBER
                               ,p_nr_item        IN NUMBER
                               ,p_cd_crtor       IN NUMBER
                               ,p_tp_desct_agrvo OUT VARCHAR2
                               ,p_cd_erro        OUT NUMBER
                               ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION BuscaDescontoMax(p_cd_mdupr       IN NUMBER
                             ,p_pc_comiss      IN NUMBER
                             ,p_dt_inico_vigen IN DATE
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION BuscaAgravoMax(p_cd_segmt_prdut IN NUMBER
                           ,p_dt_procm       IN DATE
                           ,p_cd_erro        OUT NUMBER
                           ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION IsSistemaIndisponivel(p_cd_erro  OUT NUMBER
                                  ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION RetornaQtDiasEstorno(p_cd_segmt_prdut IN NUMBER
                                 ,p_cd_erro        OUT NUMBER
                                 ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    FUNCTION ExisteCorretor(p_cd_crtor IN NUMBER
                           ,p_cd_erro  OUT NUMBER
                           ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION IsCorretorHabilitado(p_cd_crtor    IN NUMBER
                                 ,p_segmt_prdut IN NUMBER
                                 ,p_cd_erro     OUT NUMBER
                                 ,p_msg_erro    OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION IsAssessoriaAtiva(p_cd_assess IN NUMBER
                              ,p_cd_erro   OUT NUMBER
                              ,p_msg_erro  OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION ValidaCdProcesso(p_cd_tp_processo IN NUMBER
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER;

    --
    PROCEDURE RetornaDadosCorretor(p_cd_crtor   IN NUMBER
                                  ,p_t_corretor OUT t_corretor);

    --
    FUNCTION IsSegmentoValido(p_cd_segmt_prdut IN NUMBER
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN BOOLEAN;

    --
    PROCEDURE RetornaDadosAssessoria(p_cd_assessoria     IN NUMBER
                                    ,p_tp_pesoa          OUT VARCHAR2
                                    ,p_nm_crtor_segur    OUT VARCHAR2
                                    ,p_nr_cpf_cnpj_crtor OUT VARCHAR2
                                    ,p_cd_sucsl          OUT NUMBER
                                    ,p_cd_diret          OUT NUMBER
                                    ,p_cd_erro           OUT NUMBER
                                    ,p_msg_erro          OUT VARCHAR2);

    --
    FUNCTION ValidaValorDescAgrav(p_vl_descagrav IN NUMBER
                                 ,p_cd_erro      OUT NUMBER
                                 ,p_msg_erro     OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION IsCorretorValido(p_cd_crtor IN NUMBER
                             ,p_cd_erro  OUT NUMBER
                             ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION IsPermiteAgravoCorretor(p_cd_crtor        IN NUMBER
                                    ,p_agravo_desconto IN VARCHAR2
                                    ,p_cd_erro         OUT NUMBER
                                    ,p_msg_erro        OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION ValidaValorMinimoAgravDesc(p_vl_descagrav IN NUMBER
                                       ,p_cd_erro      OUT NUMBER
                                       ,p_msg_erro     OUT VARCHAR2) RETURN BOOLEAN;

    --
    FUNCTION RetornaParametro(p_nm_param IN VARCHAR2) RETURN VARCHAR2;

    --
    PROCEDURE IniciaLog(p_id_servc          IN NUMBER
                       ,p_sg_sistm_origm    IN VARCHAR2
                       ,p_cd_crtor_segur    IN NUMBER
                       ,p_cd_asses          IN NUMBER
                       ,p_cd_ctrat          IN NUMBER
                       ,p_cd_item_ctrat     IN NUMBER
                       ,p_tp_pesoa          IN VARCHAR2
                       ,p_nr_cpf_cnpj_clien IN NUMBER
                       ,p_nm_clien_sgrdo    IN VARCHAR2
                       ,p_cd_usuro          IN VARCHAR2
                       ,p_cd_tipo_procs     IN NUMBER
                       ,p_sq_log            OUT NUMBER);

    --
    PROCEDURE GravaLog(p_sq_log IN NUMBER
                      ,p_texto  IN VARCHAR2);

    --
    PROCEDURE FinalizaLog(p_sq_log IN NUMBER);

    --
    --
    --
    -- retorna TRUE se diferenca esta dentro do limite permitido
    -- retorna FALSE se diferenca NAO esta dentro do limite permitido
    -- function valida se valor esta dentro do diferencial permitido
    --
    FUNCTION validaValorProvisionadoMaior(p_cd_segm               IN NUMBER
                                         ,p_valor_agravo_desconto IN NUMBER
                                         ,p_valor_provisionado    IN NUMBER
                                         ,v_sq_log                IN NUMBER) RETURN BOOLEAN;

    --
    --
    FUNCTION retornaValorSomaDescontoAgravo(p_cd_segm IN NUMBER
                                           ,v_sq_log  IN NUMBER) RETURN NUMBER;

    --
    FUNCTION NaoIncluiNovaVerbaEstorno(p_cd_corretor IN NUMBER
                                      ,v_sq_log      IN NUMBER) RETURN BOOLEAN;

    --
    PROCEDURE RetornaInfoCCCrtor(p_cd_crtor_segur IN NUMBER
                                ,p_dt_movto       IN DATE
                                ,p_vl_crd_verba   OUT NUMBER
                                ,p_vl_usado_verba OUT NUMBER
                                ,p_vl_saldo_verba OUT NUMBER);
    --
        PROCEDURE       RetornaVerbasSucursal     (p_cd_sucsl_comrl       IN      NUMBER
                                        ,p_cd_segmt_prdut       IN      NUMBER
                                        ,p_dt_consulta         IN      DATE
                                        ,p_verbas_sucsl OUT     sys_refcursor);
--
END CTACTPA0100_001;
/


CREATE OR REPLACE PACKAGE CTACTPA0200_001 AS

        /* VERSAO V 7.8 */

        /*  CONSULTA SALDO CTA WAPPER - CTACTPA0001_001.CONSULTA_SALDO_DESCONTO_W
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_STRETORNO OUT NUMBER
            P_MSGRETORNO OUT VARCHAR2
            P_VLSALDODISPONIVEL OUT NUMBER
            P_VLDESCONTOMAXIMO OUT NUMBER
        */
        PROCEDURE CONSULTA_SALDO_DESCONTO(P_SISTEMACHAMADOR IN VARCHAR2
                                         ,P_CDPRODUTO IN VARCHAR2
                                         ,P_CDCORRETOR IN NUMBER
                                         ,P_CDCONTRATO IN NUMBER
                                         ,P_CDITEMCONTRATO IN NUMBER
                                         ,P_VLPREMIOLIQUIDO IN NUMBER
                                         ,P_PCCOMISSAO IN NUMBER
                                         ,P_DTINICIOVIGENCIA IN VARCHAR2
                                         ,P_TPPESSOA IN VARCHAR2
                                         ,P_CPFCNPJCLIENTE IN NUMBER
                                         ,P_CDUSUARIO IN VARCHAR2
                                         ,P_CDPROCESSO IN NUMBER
                                         ,P_STRETORNO OUT NUMBER
                                         ,P_MSGRETORNO OUT VARCHAR2
                                         ,P_VLSALDODISPONIVEL OUT NUMBER
                                         ,P_VLDESCONTOMAXIMO OUT NUMBER);
        --

        /*  VALIDA PROVISAO WAPPER - CTACTPA0002_001.VALIDA_VALOR
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_NMCLIENTE IN VARCHAR2
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_STRETORNO IN NUMBER
            P_MSGRETORNO IN VARCHAR2
        */
        --
        PROCEDURE VALIDA_VALOR(P_SISTEMACHAMADOR IN VARCHAR2
                              ,P_CDPRODUTO IN VARCHAR2
                              ,P_CDCORRETOR IN NUMBER
                              ,P_CDCONTRATO IN NUMBER
                              ,P_CDITEMCONTRATO IN NUMBER
                              ,P_INAGRAVODESCONTO IN VARCHAR2
                              ,P_VLAGRAVODESCONTO IN NUMBER
                              ,P_TPPESSOA IN VARCHAR2
                              ,P_CPFCNPJCLIENTE IN NUMBER
                              ,P_NMCLIENTE IN VARCHAR2
                              ,P_VLPREMIOLIQUIDO IN NUMBER
                              ,P_PCCOMISSAO IN NUMBER
                              ,P_DTINICIOVIGENCIA IN VARCHAR2
                              ,P_CDUSUARIO IN VARCHAR2
                              ,P_CDPROCESSO IN NUMBER
                              ,P_STRETORNO OUT NUMBER
                              ,P_MSGRETORNO OUT VARCHAR2);
        --

        /*  PROVISIONA VALOR WAPPER - CTACTPA0003_001.PROVISIONA_VALOR
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_NMCLIENTE IN VARCHAR2
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_IDCORRELATION IN VARCHAR 2
            P_STRETORNO IN NUMBER
            P_MSGRETORNO IN VARCHAR2
            P_NRNEGOCIORESERVADO IN NUMBER
            P_NRITEMRESERVADO IN NUMBER
        */
        --
        PROCEDURE PROVISIONA_VALOR(P_SISTEMACHAMADOR IN VARCHAR2
                                  ,P_CDPRODUTO IN VARCHAR2
                                  ,P_CDCORRETOR IN NUMBER
                                  ,P_CDCONTRATO IN NUMBER
                                  ,P_CDITEMCONTRATO IN NUMBER
                                  ,P_INAGRAVODESCONTO IN VARCHAR2
                                  ,P_VLAGRAVODESCONTO IN NUMBER
                                  ,P_TPPESSOA IN VARCHAR2
                                  ,P_CPFCNPJCLIENTE IN NUMBER
                                  ,P_NMCLIENTE IN VARCHAR2
                                  ,P_VLPREMIOLIQUIDO IN NUMBER
                                  ,P_PCCOMISSAO IN NUMBER
                                  ,P_DTINICIOVIGENCIA IN VARCHAR2
                                  ,P_CDUSUARIO IN VARCHAR2
                                  ,P_CDPROCESSO IN NUMBER
                                  ,P_IDCORRELATION IN VARCHAR2
                                  ,P_STRETORNO OUT NUMBER
                                  ,P_MSGRETORNO OUT VARCHAR2
                                  ,P_NRNEGOCIORESERVADO OUT NUMBER
                                  ,P_NRITEMRESERVADO OUT NUMBER);
        --

        /*  ESTORNA PROVISAO WAPPER - CTACTPA0005_001.ESTORNA_PROVISAO
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_IDCORRELATION IN VARCHAR2;
            P_STRETORNO OUT NUMBER
            P_MSGRETORNO OUT VARCHAR2
        */
        --
        PROCEDURE ESTORNA_PROVISAO(P_SISTEMACHAMADOR IN VARCHAR2
                                  ,P_CDPRODUTO IN VARCHAR2
                                  ,P_CDCORRETOR IN NUMBER
                                  ,P_CDCONTRATO IN NUMBER
                                  ,P_CDITEMCONTRATO IN NUMBER
                                  ,P_INAGRAVODESCONTO IN VARCHAR2
                                  ,P_VLAGRAVODESCONTO IN NUMBER
                                  ,P_TPPESSOA IN VARCHAR2
                                  ,P_CPFCNPJCLIENTE IN NUMBER
                                  ,P_CDUSUARIO IN VARCHAR2
                                  ,P_CDPROCESSO IN NUMBER
                                  ,P_IDCORRELATION IN VARCHAR2
                                  ,P_STRETORNO OUT NUMBER
                                  ,P_MSGRETORNO OUT VARCHAR2);
        --
END CTACTPA0200_001;
/


CREATE OR REPLACE PACKAGE CTARELPA0002_STDER_FORA_PRAZO IS
        --
        TYPE    rec_retorno     IS RECORD       (v_retorno_01   VARCHAR2(4000)
                                                ,v_retorno_02   VARCHAR2(4000)
                                                ,v_retorno_03   VARCHAR2(4000)
                                                ,v_retorno_04   VARCHAR2(4000)
                                                ,v_retorno_05   VARCHAR2(4000)
                                                ,v_retorno_06   VARCHAR2(4000)
                                                ,v_retorno_07   VARCHAR2(4000)
                                                ,v_retorno_08   VARCHAR2(4000)
                                                ,v_retorno_09   VARCHAR2(4000)
                                                ,v_retorno_10   VARCHAR2(4000)
                                                ,v_retorno_11   VARCHAR2(4000)
                                                ,v_retorno_12   VARCHAR2(4000)
                                                ,v_retorno_13   VARCHAR2(4000)
                                                ,v_retorno_14   VARCHAR2(4000)
                                                ,v_retorno_15   VARCHAR2(4000)
                                                ,v_retorno_16   VARCHAR2(4000)
                                                ,v_retorno_17   VARCHAR2(4000)
                                                ,v_retorno_18   VARCHAR2(4000)
                                                ,v_retorno_19   VARCHAR2(4000)
                                                ,v_retorno_20   VARCHAR2(4000));
        --
        TYPE    t_rec_retorno   IS      TABLE   OF      rec_retorno     INDEX   BY      BINARY_INTEGER;
        --
        PROCEDURE       RelatorioForaPrazo(      p_parametros    IN      admcta.t_param,
                                                        relatorio     OUT     t_rec_retorno,
                                                        cd_retorno    OUT     NUMBER,
                                                        msg_retorno   OUT     VARCHAR2)  ;
        --
        FUNCTION        DtErro1000      (p_id_ppota_contr       IN      NUMBER)
                --
                RETURN          DATE;

END     CTARELPA0002_STDER_FORA_PRAZO;
/
CREATE OR REPLACE PACKAGE BODY CTACTPA0001_001 IS

    /* VERSAO V 9.0 */

    --
    v_VlPremioLiquido NUMBER(15, 2);
    --
    
    --
    --------------------------------------------------------------------------
    --      Consulta_Saldo_Desconto:        Consultar o saldo do conta      --
    --                                      corrente para um corretor ou    --
    --                                      assessoria, e tambm o desconto --
    --                                      mximo para o item.             --
    --------------------------------------------------------------------------
    --
    PROCEDURE Consulta_Saldo_Desconto(p_consulta_saldo_in      IN consulta_saldo_in
                                     ,p_consulta_saldo_out     OUT consulta_saldo_out
                                     ,p_data_provisao_stder_in IN DATE DEFAULT NULL) IS
        --
        v_dt_procm             DATE;
        v_dt_inico_vigen       DATE;
        v_cd_segmt_prdut       cta0001_prdut.cd_segmt_prdut%TYPE;
        v_vl_saldo_verba       cta0002_verba.vl_saldo_verba%TYPE;
        v_pc_maxmo_desct       cta0009_pctis_comis_desct.pc_maxmo_desct%TYPE;
        v_vl_lacto             cta0004_lacto.vl_lacto%TYPE;
        --
        v_sq_log               NUMBER;
        v_id_prdut             NUMBER;
        v_cd_erro              NUMBER;
        v_msg_erro             VARCHAR2(4000);
        v_tp_desct_agrvo       VARCHAR2(3);
        --
        erro_fatal             EXCEPTION;
        --
    BEGIN
        --
        --      Inicializando o type
        --
        p_consulta_saldo_out := consulta_saldo_out(0, NULL, 0, 0);
        --
        v_VlPremioLiquido := Round(p_consulta_saldo_in.VlPremioLiquido, 2);
        --
        CTACTPA0100_001.IniciaLog(11, p_consulta_saldo_in.SistemaChamador, p_consulta_saldo_in.CdCorretor, NULL, p_consulta_saldo_in.CdContrato, p_consulta_saldo_in.CdItemContrato, p_consulta_saldo_in.TpPessoa, p_consulta_saldo_in.CPFCNPJCliente, NULL, p_consulta_saldo_in.CdUsuario, p_consulta_saldo_in.CdProcesso, v_sq_log);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 79, '=') || Chr(10) || 
                                'Incio execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || 
                                LPad('=', 79, '=') || Chr(10) || 
                                'Servio Consulta_Saldo_Desconto. Parmetros de entrada: ' || Chr(10) || 
                                'CdUsuario............. ' || p_consulta_saldo_in.CdUsuario || Chr(10) || 
                                'CdProcesso............ ' || p_consulta_saldo_in.CdProcesso || Chr(10) || 
                                'SistemaChamador....... ' || p_consulta_saldo_in.SistemaChamador || Chr(10) ||
                                'CdCorretor............ ' || p_consulta_saldo_in.CdCorretor || Chr(10) || 
                                'CdContrato............ ' || p_consulta_saldo_in.CdContrato || Chr(10) || 
                                'DtInicioVigencia...... ' || p_consulta_saldo_in.DtInicioVigencia || Chr(10) ||
                                'TpPessoa.............. ' || p_consulta_saldo_in.TpPessoa || Chr(10) || 
                                'CdProduto............. ' || p_consulta_saldo_in.CdProduto || Chr(10) || 
                                'VlPremioLiquido....... ' || p_consulta_saldo_in.VlPremioLiquido || Chr(10) || 
                                'v_VlPremioLiquido..... ' || v_VlPremioLiquido || Chr(10) || 
                                'Pccomissao............ ' || p_consulta_saldo_in.Pccomissao || Chr(10) ||
                                'CPFCNPJCliente........ ' || p_consulta_saldo_in.CPFCNPJCliente || Chr(10) || 
                                'CdItemContrato........ ' || p_consulta_saldo_in.CdItemContrato || Chr(10) || 
                                'Ambiente.............. ' || CTACTPA0100_001.RetornaParametro('AMBIENTE') || Chr(10) ||
                                LPad('=', 79, '='));
        --
        --      Validando o sistema chamador
        --
        IF NOT (CTACTPA0100_001.SistemaChamadorValido(p_consulta_saldo_in.SistemaChamador)) THEN
            --
            p_consulta_saldo_out.StRetorno  := 2;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Sistema chamador invlido: ' || p_consulta_saldo_in.SistemaChamador || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Valor Prmio Lquido
        --
        IF v_VlPremioLiquido IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 5;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Valor do prmio lquido est nulo' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando percentual de comisso
        --
        IF p_consulta_saldo_in.Pccomissao IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 6;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Percentual de comisso est nulo' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando incio de vigncia
        --
        IF p_consulta_saldo_in.DtInicioVigencia IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 7;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Data de incio de vigncia est nula' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        IF NOT (CTACTPA0100_001.IsDataValida(p_consulta_saldo_in.DtInicioVigencia, v_dt_inico_vigen)) THEN
            --
            p_consulta_saldo_out.StRetorno  := 7;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Data de incio de vigncia invlida: ' || p_consulta_saldo_in.DtInicioVigencia || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando tipo de pessoa
        --
        IF Nvl(p_consulta_saldo_in.TpPessoa, 'X') NOT IN ('F', 'J') THEN
            --
            p_consulta_saldo_out.StRetorno  := 8;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Tipo de pessoa invlido: ' || Nvl(p_consulta_saldo_in.TpPessoa, 'nulo') || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando CPF / CNPJ do cliente
        --
        IF p_consulta_saldo_in.CPFCNPJCliente IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 9;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - CPF / CNPJ est nulo' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        ELSE
            --
            IF p_consulta_saldo_in.TpPessoa = 'F' AND
               NOT (tms_util.valida_cpf(LPad(p_consulta_saldo_in.CPFCNPJCliente, 11, '0'))) THEN
                --
                p_consulta_saldo_out.StRetorno  := 9;
                p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - CPF invlido: ' || p_consulta_saldo_in.CPFCNPJCliente || '(' || v_sq_log || ')';
                --
                RAISE erro_fatal;
                --
            ELSIF p_consulta_saldo_in.TpPessoa = 'J' AND
                  NOT (tms_util.valida_cnpj(LPad(p_consulta_saldo_in.CPFCNPJCliente, 14, '0'))) THEN
                --
                p_consulta_saldo_out.StRetorno  := 9;
                p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - CNPJ invlido: ' || p_consulta_saldo_in.CPFCNPJCliente || '(' || v_sq_log || ')';
                --
                RAISE erro_fatal;
                --
            END IF;
            --
        END IF;
        --
        --      Validando usurio
        --
        IF p_consulta_saldo_in.CdUsuario IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 10;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Usurio est nulo' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando cdigo de processo
        --
        IF p_consulta_saldo_in.CdProcesso IS NULL THEN
            --
            p_consulta_saldo_out.StRetorno  := 11;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Cdigo de processo est nulo' || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      S validar o nmero de negcio e item se o sistema
        --      chamador for o SSV
        --
        IF p_consulta_saldo_in.SistemaChamador = 'SSV' THEN
            --
            --      Validando nmero de negcio
            --
            IF p_consulta_saldo_in.CdContrato IS NULL THEN
                --
                p_consulta_saldo_out.StRetorno  := 15;
                p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Nmero de negcio est nulo' || '(' || v_sq_log || ')';
                --
                RAISE erro_fatal;
                --
            END IF;
            --
            --      Validando nmero de item
            --
            IF p_consulta_saldo_in.CdItemContrato IS NULL THEN
                --
                p_consulta_saldo_out.StRetorno  := 16;
                p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - Nmero de item est nulo' || '(' || v_sq_log || ')';
                --
                RAISE erro_fatal;
                --
            END IF;
            --
        END IF;
        --
        --      Busca a data de processamento.
        --      Se o Codigo do Processo = 44 e o parametro 'p_data_provisao_stder_in' for diferente null
        --      atribuir o 'p_data_provisao_stder_in' para 'v_dt_procm'
        --
        IF p_consulta_saldo_in.CdProcesso = 44 AND
           p_data_provisao_stder_in IS NOT NULL THEN
            --
            v_dt_procm := p_data_provisao_stder_in;
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Utilizando a Data de Processamento passada via parametro (p_data_provisao_stder_in) ');
            --
        ELSE
            --
            v_dt_procm := CTACTPA0100_001.RetornaDtProcm;
            --
            CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaDtProcm] Busca a Data de Processamento');
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaDtProcm] Data de processamento: ' || v_dt_procm);
        --
        --      Busca segmento do produto
        --
        v_cd_segmt_prdut := CTACTPA0100_001.RetornaSegmentoProduto(p_consulta_saldo_in.SistemaChamador, p_consulta_saldo_in.CdProduto, v_dt_procm, v_cd_erro, v_msg_erro);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, 
                                '[RetornaSegmentoProduto] Segmento: ' || v_cd_segmt_prdut || 
                                ' - Sistema Chamador: ' || p_consulta_saldo_in.SistemaChamador || 
                                ' Produto: ' || p_consulta_saldo_in.CdProduto || 
                                ' Data: ' || v_dt_procm);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando o mdulo produto
        --
        v_id_prdut := CTACTPA0100_001.ModuloProdutoValido(p_consulta_saldo_in.CdProduto, p_consulta_saldo_in.SistemaChamador, v_cd_segmt_prdut, v_dt_procm, v_cd_erro, v_msg_erro);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, 
                                '[ModuloProdutoValido] - Id Produto: ' || v_id_prdut || 
                                ' Produto: ' || p_consulta_saldo_in.CdProduto ||
                                ' Sistema Chamador: ' || p_consulta_saldo_in.SistemaChamador || 
                                ' Segmento: ' || v_cd_segmt_prdut ||
                                ' Data: ' || v_dt_procm);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[IsCorretorBloqueado] Corretor: ' || p_consulta_saldo_in.CdCorretor || ' Segmento: ' || v_cd_segmt_prdut);
        --
        --      Valida corretor bloqueado
        --
        IF CTACTPA0100_001.IsCorretorBloqueado(p_consulta_saldo_in.CdCorretor, v_cd_segmt_prdut, v_cd_erro, v_msg_erro) THEN
            --
            p_consulta_saldo_out.StRetorno         := 20;
            p_consulta_saldo_out.MsgRetorno        := 'Corretor inabilitado para utilizao do conta-corrente.' || '(' || v_sq_log || ')';
            p_consulta_saldo_out.VlDescontoMaximo  := 0;
            p_consulta_saldo_out.VlSaldoDisponivel := 0;
            --
            CTACTPA0100_001.GravaLog(v_sq_log, '[Corretor est bloqueado. Retornando ao programa chamador com os valores zerados]');
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[IsCorretorHabilitado] Corretor: ' || p_consulta_saldo_in.CdCorretor || ' Segmento: ' || v_cd_segmt_prdut);
        --
        IF NOT (CTACTPA0100_001.IsCorretorHabilitado(p_consulta_saldo_in.CdCorretor, v_cd_segmt_prdut, v_cd_erro, v_msg_erro)) THEN
            --
            p_consulta_saldo_out.StRetorno         := 20;
            p_consulta_saldo_out.MsgRetorno        := v_msg_erro || '(' || v_sq_log || ')';
            p_consulta_saldo_out.VlDescontoMaximo  := 0;
            p_consulta_saldo_out.VlSaldoDisponivel := 0;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Buscar o saldo
        --      Se o sistema chamador for 'KCW' e o corretor 83501 verificar o parametro: PERMITE_DESC_KWC_STD da tabela: cta0008_param_cc
        --      Se o parametro estiver com o valor 'S' o saldo da verba dever ser 0
        --
        v_vl_saldo_verba := CTACTPA0100_001.BuscaSaldo(p_consulta_saldo_in.CdCorretor, v_cd_segmt_prdut, v_dt_procm, v_cd_erro, v_msg_erro);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[BuscaSaldo] Saldo: ' || v_vl_saldo_verba || ' Corretor: ' || p_consulta_saldo_in.CdCorretor || ' Segmento: ' || v_cd_segmt_prdut || ' Data: ' || v_dt_procm);
        --
        v_vl_saldo_verba := CTACTPA0100_001.ValidaSaldo(v_sq_log
                                                       ,p_consulta_saldo_in.SistemaChamador
                                                       ,p_consulta_saldo_in.CdCorretor
                                                       ,v_vl_saldo_verba);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Retorna a provisao do item e negocio
        --
        v_vl_lacto := CTACTPA0100_001.RetornaProvisao(p_consulta_saldo_in.CdContrato, p_consulta_saldo_in.CdItemContrato, p_consulta_saldo_in.CdCorretor, v_tp_desct_agrvo, v_cd_erro, v_msg_erro);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaProvisao] Lanamento: ' || v_vl_lacto || ' Negcio: ' || p_consulta_saldo_in.CdContrato || ' Item: ' || p_consulta_saldo_in.CdItemContrato || ' Corretor: ' || p_consulta_saldo_in.CdCorretor);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Atribuindo o valor do retorno de Saldo Disponvel.
        --      S deve somar se for um lanamento de desconto.
        --
        IF v_tp_desct_agrvo = 'D' THEN
            --
            p_consulta_saldo_out.VlSaldoDisponivel := v_vl_saldo_verba + v_vl_lacto;
            --
        ELSE
            --
            p_consulta_saldo_out.VlSaldoDisponivel := v_vl_saldo_verba;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[Saldo Disponvel] ' || p_consulta_saldo_out.VlSaldoDisponivel);
        --
        --      Busca o desconto mximo
        --
        v_pc_maxmo_desct := CTACTPA0100_001.BuscaDescontoMax(p_consulta_saldo_in.CdProduto, p_consulta_saldo_in.PcComissao, v_dt_inico_vigen, v_cd_erro, v_msg_erro);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[BuscaDescontoMax] Percentual mximo: ' || v_pc_maxmo_desct || ' Produto: ' ||
                                  p_consulta_saldo_in.CdProduto || ' Comisso ' || p_consulta_saldo_in.PcComissao || 'Incio de Vigncia: ' ||
                                  v_dt_inico_vigen);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Atribuindo o valor do retorno de Desconto Mximo
        --
        p_consulta_saldo_out.VlDescontoMaximo := CTACTPA0100_001.BuscaValorDescontoMaximo(v_sq_log
                                                                                         ,p_consulta_saldo_in.CdCorretor
                                                                                         ,p_consulta_saldo_in.PcComissao
                                                                                         ,v_VlPremioLiquido
                                                                                         ,v_pc_maxmo_desct);
        --
        --      Se processo diferente de 21 (chamada pela Recepo Eletrnica) e
        --      se o valor do desconto mximo for maior do que o saldo
        --      disponvel, devolver o saldo disponvel no campo de
        --      desconto maximo.
        --
        IF p_consulta_saldo_in.CdProcesso <> 21 THEN
            --
            IF p_consulta_saldo_out.VlDescontoMaximo > p_consulta_saldo_out.VlSaldoDisponivel THEN
                --
                p_consulta_saldo_out.VlDescontoMaximo := p_consulta_saldo_out.VlSaldoDisponivel;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Valor Desconto Mximo 2] ' || p_consulta_saldo_out.VlDescontoMaximo);
                --
            END IF;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[ValidaValorDescAgrav] Valor: ' || p_consulta_saldo_out.VlDescontoMaximo);
        --
        IF NOT (CTACTPA0100_001.ValidaValorDescAgrav(p_consulta_saldo_out.VlDescontoMaximo, v_cd_erro, v_msg_erro)) THEN
            --
            p_consulta_saldo_out.StRetorno  := v_cd_erro;
            p_consulta_saldo_out.MsgRetorno := '[Consulta Saldo Desconto] - ' || v_msg_erro || '(' || v_sq_log || ')';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 79, '=') || Chr(10) || 'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 79, '='));
        --
        CTACTPA0100_001.FinalizaLog(v_sq_log);
        --
    EXCEPTION
        --
        WHEN erro_fatal THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 79, '=') || Chr(10) || 'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 79, '='));
            --
            CTACTPA0100_001.FinalizaLog(v_sq_log);
            --
            RETURN;
            --
        WHEN OTHERS THEN
            --
            p_consulta_saldo_out.StRetorno  := 1;
            p_consulta_saldo_out.MsgRetorno := 'Erro Consulta_Saldo_Desconto: ' || SQLERRM || ' Parmetros: ' || p_consulta_saldo_in.SistemaChamador || ';' || p_consulta_saldo_in.CdProduto || ';' || p_consulta_saldo_in.CdCorretor || '(' || v_sq_log || ')';
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Erro Consulta_Saldo_Desconto: ' || SQLERRM);
            --
            CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 79, '=') || Chr(10) || 'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 79, '='));
            --
            CTACTPA0100_001.FinalizaLog(v_sq_log);
            --
    END Consulta_Saldo_Desconto;
    --

END CTACTPA0001_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0002_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        v_VlAgravoDesconto      NUMBER(15,2);
        v_VlPremioLiquido       NUMBER(15,2);
        --
        
        --------------------------------------------------------------------------
        --      Valida_Valor:   Valida se o valor de conta corrente pode ser    --
        --                      aplicado para a proposta.                       --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Valida_Valor            (p_valida_valor_in      IN      valida_valor_in
                                                ,p_valida_valor_out     OUT     valida_valor_out)       IS
        --
        v_dt_procm                      DATE;
        v_dt_inico_vigen                DATE;
        v_cd_segmt_prdut                cta0001_prdut.cd_segmt_prdut%TYPE;
        --
        v_cd_erro                       NUMBER;
        v_id_prdut                      NUMBER;
        v_msg_erro                      VARCHAR2(4000);
        v_vl_saldo_verba                cta0002_verba.vl_saldo_verba%TYPE;
        v_vl_lacto                      cta0004_lacto.vl_lacto%TYPE;
        v_pc_maxmo_desct                NUMBER;
        v_pc_agravo_desct               NUMBER;
        --
        v_vl_maxmo_desct                NUMBER;
        v_vl_maxmo_agravo               NUMBER;
        v_vl_restante                   NUMBER;
        --
        v_sq_log                        NUMBER;
        v_tp_desct_agrvo                VARCHAR2(3);
        --
        erro_fatal                      EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_valida_valor_out      :=      valida_valor_out        (0
                                                                        ,NULL);
                --
                v_VlAgravoDesconto      :=      Round(p_valida_valor_in.VlAgravoDesconto,       2);
                v_VlPremioLiquido       :=      Round(p_valida_valor_in.VlPremioLiquido,        2);
                --
                CTACTPA0100_001.IniciaLog       (21
                                                ,p_valida_valor_in.SistemaChamador
                                                ,p_valida_valor_in.CdCorretor
                                                ,NULL
                                                ,p_valida_valor_in.CdContrato
                                                ,p_valida_valor_in.CdItemContrato
                                                ,p_valida_valor_in.TpPessoa
                                                ,p_valida_valor_in.CPFCNPJCliente
                                                ,p_valida_valor_in.NmCliente
                                                ,p_valida_valor_in.CdUsuario
                                                ,p_valida_valor_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      79,     '=')                                                     ||Chr(10)||
                                                'Servio Valida_Valor. Parmetros de entrada: '                                 ||Chr(10)||
                                                'NmCliente.............. '||p_valida_valor_in.NmCliente                         ||Chr(10)||
                                                'CdProcesso............. '||p_valida_valor_in.CdProcesso                        ||Chr(10)||	
                                                'CdCorretor............. '||p_valida_valor_in.CdCorretor                        ||Chr(10)||
                                                'TpPessoa............... '||p_valida_valor_in.TpPessoa                          ||Chr(10)||
                                                'VlPremioLiquido........ '||p_valida_valor_in.VlPremioLiquido                   ||Chr(10)||
                                                'v_VlPremioLiquido...... '||v_VlPremioLiquido                                   ||Chr(10)||
                                                'CPFCNPJCliente......... '||p_valida_valor_in.CPFCNPJCliente                    ||Chr(10)||
                                                'CdUsuario.............. '||p_valida_valor_in.CdUsuario                         ||Chr(10)||
                                                'SistemaChamador........ '||p_valida_valor_in.SistemaChamador                   ||Chr(10)||
                                                'CdContrato............. '||p_valida_valor_in.CdContrato                        ||Chr(10)||
                                                'DtInicioVigencia....... '||p_valida_valor_in.DtInicioVigencia                  ||Chr(10)||
                                                'CdProduto.............. '||p_valida_valor_in.CdProduto                         ||Chr(10)||
                                                'PcComissao............. '||p_valida_valor_in.PcComissao                        ||Chr(10)||
                                                'VlAgravoDesconto....... '||p_valida_valor_in.VlAgravoDesconto                  ||Chr(10)||
                                                'v_VlAgravoDesconto..... '||v_VlAgravoDesconto                                  ||Chr(10)||
                                                'CdItemContrato......... '||p_valida_valor_in.CdItemContrato                    ||Chr(10)||
                                                'InAgravoDesconto....... '||p_valida_valor_in.InAgravoDesconto                  ||Chr(10)||
                                                'Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')         ||Chr(10)||
                                                LPad('=',       79,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_valida_valor_in.SistemaChamador))      THEN
                        --
                        p_valida_valor_out.StRetorno        :=      2;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Sistema chamador invlido: '||p_valida_valor_in.SistemaChamador || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_valida_valor_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de negcio
                --
                IF      p_valida_valor_in.CdContrato        IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      15;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Nmero de negcio est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de item
                --
                IF      p_valida_valor_in.CdItemContrato      IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      16;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Nmero de item est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando indicador de agravo / desconto
                --
                IF      Nvl(p_valida_valor_in.InAgravoDesconto,     'X')    NOT     IN      ('A',   'D')    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      24;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Indicador de desconto / agravo invlido: '||Nvl(p_valida_valor_in.InAgravoDesconto, 'nulo') || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida para NO PERMITIR proviso de agravo para corretor bloqueado.
                --
                IF NOT (CTACTPA0100_001.IsPermiteAgravoCorretor(p_valida_valor_in.CdCorretor
                                                               ,p_valida_valor_in.InAgravoDesconto
                                                               ,v_cd_erro
                                                               ,v_msg_erro)) THEN
                        --
                        p_valida_valor_out.StRetorno  := 27;
                        p_valida_valor_out.MsgRetorno := '[Valida Valor] - No permitido Agravo para o corretor: ' || p_valida_valor_in.CdCorretor || ' [' || v_sq_log || '] ';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando valor de agravo / desconto
                --
                IF      v_VlAgravoDesconto      IS      NULL
                OR      v_VlAgravoDesconto      <=      0       THEN
                        --
                        p_valida_valor_out.StRetorno        :=      25;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Valor de agravo / desconto invlido: '||v_VlAgravoDesconto || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.ValidaValorDescAgrav        (v_VlAgravoDesconto
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                        --
                        p_valida_valor_out.StRetorno    :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno   :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de pessoa
                --
                IF      Nvl(p_valida_valor_in.TpPessoa,       'X')    NOT     IN      ('F',   'J')    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      8;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Tipo de pessoa invlido: '||Nvl(p_valida_valor_in.TpPessoa, 'nulo') || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF / CNPJ do cliente
                --
                IF      p_valida_valor_in.CPFCNPJCliente      IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      9;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - CPF / CNPJ est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      p_valida_valor_in.TpPessoa      =       'F'
                        AND     NOT(tms_util.valida_cpf(LPad(p_valida_valor_in.CPFCNPJCliente,11,'0')))      THEN
                                --
                                p_valida_valor_out.StRetorno    :=      9;
                                p_valida_valor_out.MsgRetorno   :=      '[Valida Valor] - CPF invlido: '||p_valida_valor_in.CPFCNPJCliente || ' [' || v_sq_log || '] ';
                                --
                                RAISE   erro_fatal;
                                --
                        ELSIF   p_valida_valor_in.TpPessoa      =       'J'
                        AND     NOT(tms_util.valida_cnpj(LPad(p_valida_valor_in.CPFCNPJCliente,14,'0')))     THEN
                                --
                                p_valida_valor_out.StRetorno    :=      9;
                                p_valida_valor_out.MsgRetorno   :=      '[Valida Valor] - CNPJ invlido: '||p_valida_valor_in.CPFCNPJCliente || ' [' || v_sq_log || '] ';
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando nome do cliente
                --
                IF      p_valida_valor_in.NmCliente         IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      26;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Nome de cliente est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando Valor Prmio Lquido
                --
                IF      v_VlPremioLiquido               IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      5;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Valor do prmio lquido est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando percentual de comisso
                --
                IF      p_valida_valor_in.Pccomissao          IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      6;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Percentual de comisso est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando incio de vigncia
                --
                IF      p_valida_valor_in.DtInicioVigencia  IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      7;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Data de incio de vigncia est nula' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsDataValida        (p_valida_valor_in.DtInicioVigencia
                                                                ,v_dt_inico_vigen))     THEN
                        --
                        p_valida_valor_out.StRetorno        :=      7;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Data de incio de vigncia invlida: '||p_valida_valor_in.DtInicioVigencia || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_valida_valor_in.CdUsuario           IS      NULL    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      10;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Usurio est nulo' || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_valida_valor_in.CdProcesso,   0)      NOT     IN      (12,        13,     14,       61)     THEN
                        --
                        p_valida_valor_out.StRetorno        :=      11;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Cdigo de processo invlido: '||p_valida_valor_in.CdProcesso || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] - '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca segmento do produto
                --
                v_cd_segmt_prdut        :=      CTACTPA0100_001.RetornaSegmentoProduto  (p_valida_valor_in.SistemaChamador
                                                                                        ,p_valida_valor_in.CdProduto
                                                                                        ,v_dt_procm
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaSegmentoProduto] - '||v_cd_segmt_prdut||' Sistema Chamador: '||p_valida_valor_in.SistemaChamador||' Produto: '||p_valida_valor_in.CdProduto||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida corretor bloqueado
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[IsCorretorBloqueado] - Corretor: '||p_valida_valor_in.CdCorretor||' Segmento: '||v_cd_segmt_prdut);
                --
                IF      CTACTPA0100_001.IsCorretorBloqueado     (p_valida_valor_in.CdCorretor
                                                                ,v_cd_segmt_prdut
                                                                ,v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Verifica corretor habilitado
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[IsCorretorHabilitado] - Corretor: '||p_valida_valor_in.CdCorretor||' Segmento: '||v_cd_segmt_prdut);
                --
                IF      NOT(CTACTPA0100_001.IsCorretorHabilitado        (p_valida_valor_in.CdCorretor
                                                                        ,v_cd_segmt_prdut
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                        --
                        p_valida_valor_out.StRetorno    :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno   :=      '[Provisiona Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o mdulo produto
                --
                v_id_prdut      :=      CTACTPA0100_001.ModuloProdutoValido     (p_valida_valor_in.CdProduto
                                                                                ,p_valida_valor_in.SistemaChamador
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ModuloProdutoValido] - '||v_id_prdut||' Produto: '||p_valida_valor_in.CdProduto||' Sistema Chamador: '||p_valida_valor_in.SistemaChamador||' Segmento: '||v_cd_segmt_prdut||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_valida_valor_out.StRetorno    :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno   :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Buscar o saldo
                --
                v_vl_saldo_verba        :=      CTACTPA0100_001.BuscaSaldo      (p_valida_valor_in.CdCorretor
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log, '[BuscaSaldo] - '||v_vl_saldo_verba||' Corretor: '||p_valida_valor_in.CdCorretor||' Segmento: '||v_cd_segmt_prdut||' Data: '||v_dt_procm);
                --
                v_vl_saldo_verba := CTACTPA0100_001.ValidaSaldo(v_sq_log
                                                               ,p_valida_valor_in.SistemaChamador
                                                               ,p_valida_valor_in.CdCorretor
                                                               ,v_vl_saldo_verba);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Acrescentar Proviso Anterior para o item
                --
                v_vl_lacto      :=      CTACTPA0100_001.RetornaProvisao (p_valida_valor_in.CdContrato
                                                                        ,p_valida_valor_in.CdItemContrato
                                                                        ,p_valida_valor_in.CdCorretor
                                                                        ,v_tp_desct_agrvo
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaProvisao] - '||v_vl_lacto||' Negcio: '||p_valida_valor_in.CdContrato||' Item: '||p_valida_valor_in.CdItemContrato||' Corretor: '||p_valida_valor_in.CdCorretor);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_valida_valor_out.StRetorno        :=      v_cd_erro;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      S deve somar o valor do lanamento se for um desconto.
                --
                IF      v_tp_desct_agrvo        =       'D'     THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Novo Saldo Verba] - '||v_vl_saldo_verba||' + '||v_vl_lacto);
                        --
                        v_vl_saldo_verba        :=      v_vl_saldo_verba        +       v_vl_lacto;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Novo Saldo Verba] = '||v_vl_saldo_verba);
                        --
                END     IF;
                --
                --      Busca o valor de desconto, caso seja um desconto
                --
                IF      p_valida_valor_in.InAgravoDesconto  =       'D'     THEN
                        --
                        v_pc_maxmo_desct        :=      CTACTPA0100_001.BuscaDescontoMax        (p_valida_valor_in.CdProduto
                                                                                                ,p_valida_valor_in.PcComissao
                                                                                                ,v_dt_inico_vigen
                                                                                                ,v_cd_erro
                                                                                                ,v_msg_erro);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[BuscaDescontoMax] - '||v_pc_maxmo_desct||' Produto: '||p_valida_valor_in.CdProduto||' Comisso: '||p_valida_valor_in.PcComissao||' Incio Vigncia: '||v_dt_inico_vigen);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_valida_valor_out.StRetorno        :=      v_cd_erro;
                                p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Valor Mximo Desconto] - '||v_VlPremioLiquido||' * '||v_pc_maxmo_desct||'/100');
                        --
                        v_vl_maxmo_desct :=  CTACTPA0100_001.BuscaValorDescontoMaximo(v_sq_log
                                                                                     ,p_valida_valor_in.CdCorretor
                                                                                     ,p_valida_valor_in.PcComissao
                                                                                     ,v_VlPremioLiquido
                                                                                     ,v_pc_maxmo_desct);
                        --
                END     IF;
                --
                --      Busca agravo mximo
                --
                IF      p_valida_valor_in.InAgravoDesconto  =       'A'     THEN
                        --
                        v_pc_agravo_desct       :=      CTACTPA0100_001.BuscaAgravoMax  (v_cd_segmt_prdut
                                                                                        ,v_dt_procm
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[BuscaAgravoMax] - '||v_pc_agravo_desct||' Segmento: '||v_cd_segmt_prdut||' Data Processamento: '||v_dt_procm);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_valida_valor_out.StRetorno        :=      v_cd_erro;
                                p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - '||v_msg_erro || ' [' || v_sq_log || '] ';
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Valor Agravo Mximo] - '||v_VlPremioLiquido||' * '||v_pc_agravo_desct);
                        --
                        v_vl_maxmo_agravo       :=      Trunc(v_VlPremioLiquido *       (v_pc_agravo_desct/100),      2);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Valor Agravo Mximo] = '||v_vl_maxmo_agravo);
                        --
                END     IF;
                --
                --      Validaes o desconto informado
                --
                IF      p_valida_valor_in.InAgravoDesconto  =       'D'
                AND     v_VlAgravoDesconto      >       v_vl_maxmo_desct        THEN
                        --
                        p_valida_valor_out.StRetorno        :=      28;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Desconto informado: '||To_Char(v_VlAgravoDesconto,'9G999G999G999D99')||' superior ao desconto mximo permitido: '||To_Char(v_vl_maxmo_desct,'9G999G999G999D99') || ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Verificando o agravo informado
                --
                IF      p_valida_valor_in.InAgravoDesconto  =       'A'
                AND     v_VlAgravoDesconto      >       v_vl_maxmo_agravo       THEN
                        --
                        p_valida_valor_out.StRetorno        :=      29;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Agravo informado: '||Trim(To_Char(v_VlAgravoDesconto,'9G999G999G990D09'))||' superior ao agravo mximo permitido: '||Trim(To_Char(v_vl_maxmo_agravo,'9G999G999G990D09'))|| ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Verificando o desconto disponvel
                --
                IF      p_valida_valor_in.InAgravoDesconto  =       'D'
                AND     v_VlAgravoDesconto                      >       v_vl_saldo_verba        THEN
                        --
                        p_valida_valor_out.StRetorno        :=      30;
                        p_valida_valor_out.MsgRetorno       :=      '[Valida Valor] - Desconto informado: '||Trim(To_Char(v_VlAgravoDesconto,'9G999G999G990D09'))||' superior ao saldo disponvel para o corretor: '||Trim(To_Char(v_vl_saldo_verba,'9G999G999G990D09'))|| ' [' || v_sq_log || '] ';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                 'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                 LPad('=',      79,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'StRetorno - '||p_valida_valor_out.StRetorno||' MsgRetorno - '||p_valida_valor_out.MsgRetorno);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      79,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Valida_Valor: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      79,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_valida_valor_out.StRetorno        :=      1;
                        p_valida_valor_out.MsgRetorno       :=      'Erro Valida_Valor:'                        ||' '||
                                                                        SQLERRM                                 ||' '||
                                                                        p_valida_valor_in.SistemaChamador       ||' '||
                                                                        p_valida_valor_in.CdProduto             ||' '||
                                                                        p_valida_valor_in.CdCorretor            ||' '||
                                                                        p_valida_valor_in.CdContrato            ||' '||
                                                                        p_valida_valor_in.CdItemContrato        ||' '||
                                                                        p_valida_valor_in.InAgravoDesconto      ||' '||
                                                                        p_valida_valor_in.VlAgravoDesconto      ||' '||
                                                                        p_valida_valor_in.TpPessoa              ||' '||
                                                                        p_valida_valor_in.CPFCNPJCliente        ||' '||
                                                                        p_valida_valor_in.NmCliente             ||' '||
                                                                        p_valida_valor_in.VlPremioLiquido       ||' '||
                                                                        p_valida_valor_in.PcComissao            ||' '||
                                                                        p_valida_valor_in.DtInicioVigencia      ||' '||
                                                                        p_valida_valor_in.CdUsuario             ||' '||
                                                                        p_valida_valor_in.CdProcesso            || ' [' || v_sq_log || '] ';
                        --
        END     Valida_Valor;
        --

END;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0003_001 IS

        /* VERSAO V 9.0 */

        --
        v_VlAgravoDesconto NUMBER(15, 2);
        v_VlPremioLiquido NUMBER(15, 2);
        v_sq_log NUMBER;
        --
        
        --
        --
        --------------------------------------------------------------------------
        --      SEPARA_VERBA_CORRETOR:  SEPARA AS VERBAS A SEREM USADAS           --
        --------------------------------------------------------------------------
        --
        PROCEDURE SEPARA_VERBA_CORRETOR(P_PROVISIONA_VALOR_IN IN PROVISIONA_VALOR_IN
                                       ,P_CD_SEGMT_PRDUT      IN NUMBER
                                       ,P_DT_PROCM            IN DATE) IS
                --
                CURSOR C_CTA0002_VERBA IS
                        SELECT *
                        FROM   CTA0002_VERBA
                        WHERE  CD_CRTOR_SEGUR = P_PROVISIONA_VALOR_IN.CDCORRETOR
                        AND    CD_SEGMT_PRDUT = P_CD_SEGMT_PRDUT
                        AND    CD_SITUC_VERBA = 'ATI'
                        AND    DT_INICO_VIGEN <= P_DT_PROCM
                        AND    DT_FIM_VIGEN >= P_DT_PROCM
                        FOR    UPDATE;
                --
        BEGIN
                --
                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'SEPARANDO AS VERBAS PARA PROVISAO PARA O CORRETOR ' || P_PROVISIONA_VALOR_IN.CDCORRETOR);
                --
                FOR R_CTA0002_VERBA IN C_CTA0002_VERBA LOOP
                        --
                        NULL;
                        --
                END LOOP;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'ERRO A SEPARAR AS VERBAS PARA PROVISAO PARA O CORRETOR ' ||
                                                  P_PROVISIONA_VALOR_IN.CDCORRETOR);
                        --
                --
        END SEPARA_VERBA_CORRETOR;

        --
        --
        --------------------------------------------------------------------------
        --      IS_REGISTRO_LACTO_VALIDO: VERIFICA SE REGISTRO NAO ESTA EM      --
        --                                DUPLICIDADE COM ANTERIOR              --
        --      RETORNA TRUE SE REGISTRO PODE SER INSERIDO                      --
        --      RETORNA FALSE SE REGISTRO E POSSIVEL DUPLICIDADE                --
        --------------------------------------------------------------------------
        --
        FUNCTION IS_REGISTRO_LACTO_VALIDO(P_PROVISIONA_VALOR_IN IN PROVISIONA_VALOR_IN) RETURN BOOLEAN IS
                --
                V_DS_PARAM_CC CTA0008_PARAM_CC.DS_PARAM_CC%TYPE;
                V_DT_LACTO    CTA0004_LACTO.DT_LACTO%TYPE;
                V_VL_LACTO    CTA0004_LACTO.VL_LACTO%TYPE;
                V_DIF_INSERT  NUMBER;
                --
        BEGIN
                --
                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'IS_REGISTRO_LACTO_VALIDO - CONTRATO [' || P_PROVISIONA_VALOR_IN.CDCONTRATO || '] ITEM [' ||
                                          P_PROVISIONA_VALOR_IN.CDITEMCONTRATO || ' VALOR [' || P_PROVISIONA_VALOR_IN.VLAGRAVODESCONTO || ']');
                --
                BEGIN
                        --
                        SELECT DS_PARAM_CC
                        INTO   V_DS_PARAM_CC
                        FROM   CTA0008_PARAM_CC
                        WHERE  NM_PARAM_CC = 'TEMPO_MAX_LACTO_DUPL';
                        --
                        CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'PERIODO AGUARDO PARA INSERT EM SEGUNDOS: ' || V_DS_PARAM_CC);
                        --
                EXCEPTION
                        --
                        WHEN NO_DATA_FOUND THEN
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'NAO ENCONTROU PARAMETRO DE TEMPO PARA INSERT: ' || V_DS_PARAM_CC);
                                --
                                RETURN TRUE;
                                --
                        WHEN OTHERS THEN
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'ERRO AO BUSCAR PARAMETRO DE TEMPO PARA INSERT: ' || SQLERRM);
                                --
                                RETURN TRUE;
                                --
                END;
                --
                BEGIN
                        --
                        SELECT MAX(DT_LACTO)
                        INTO   V_DT_LACTO
                        FROM   CTA0004_LACTO
                        WHERE  CD_CTRAT = P_PROVISIONA_VALOR_IN.CDCONTRATO
                        AND    CD_ITEM_CTRAT = P_PROVISIONA_VALOR_IN.CDITEMCONTRATO
                        AND    CD_SITUC_LACTO NOT IN ('CAN', 'EST');
                        --
                        SELECT SUM(VL_LACTO)
                        INTO   V_VL_LACTO
                        FROM   CTA0004_LACTO
                        WHERE  CD_CTRAT = P_PROVISIONA_VALOR_IN.CDCONTRATO
                        AND    CD_ITEM_CTRAT = P_PROVISIONA_VALOR_IN.CDITEMCONTRATO
                        AND    CD_SITUC_LACTO NOT IN ('CAN', 'EST');
                        --
                        IF V_DT_LACTO IS NOT NULL AND
                           P_PROVISIONA_VALOR_IN.VLAGRAVODESCONTO = NVL(V_VL_LACTO, 0) THEN
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'VALIDANDO DATA' || TO_CHAR(V_DT_LACTO, 'DD/MM/RRRR HH24:MI:SS') ||
                                                          ', VALOR IGUAL ' || P_PROVISIONA_VALOR_IN.VLAGRAVODESCONTO || ' = ' || V_VL_LACTO);
                                --
                                V_VL_LACTO := V_VL_LACTO + (V_DS_PARAM_CC / 86400);
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'SYSDATE: ' || TO_CHAR(V_DT_LACTO, 'DD/MM/RRRR HH24:MI:SS'));
                                --
                                IF TRUNC(((V_DT_LACTO - SYSDATE) * 100000), 0) > 0 THEN
                                        --
                                        CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'POSSIVEL REGISTRO DUPLICADO, VERIFICAR.');
                                        --
                                        RETURN FALSE;
                                        --
                                ELSE
                                        --
                                        CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'REGISTRO FORA DOS PARAMETROS, PODE INSERIR NOVO REGISTRO.');
                                        --
                                        RETURN TRUE;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        RETURN TRUE;
                        --
                EXCEPTION
                        --
                        WHEN NO_DATA_FOUND THEN
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'NENHUM REGISTRO COM VALOR IGUAL: ' || P_PROVISIONA_VALOR_IN.VLAGRAVODESCONTO ||
                                                          ' LIBERA INSERIR REGISTRO');
                                --
                                RETURN TRUE;
                                --
                        WHEN OTHERS THEN
                                --
                                CTACTPA0100_001.GRAVALOG(V_SQ_LOG, 'ERRO AO BUSCAR REGISTRO COM BASE NO CORRETOR E VALOR DE LANCAMENTO: ' || SQLERRM);
                                --
                                RETURN TRUE;
                                --
                END;
                --
        END IS_REGISTRO_LACTO_VALIDO;

        --
        --
        --------------------------------------------------------------------------
        --      FUNCTION RETORNA_LINHA_ERRO:    Retorna linha em que ocorreu o  --
        --                                      erro.                           --
        --------------------------------------------------------------------------
        --
        FUNCTION RETORNA_LINHA_ERRO RETURN VARCHAR2 IS
                --
                l_trace     tms_util.error_rt;
                v_resultado VARCHAR2(100);
                --
        BEGIN
                --
                l_trace := tms_util.BACKTRACE_INFO(DBMS_UTILITY.format_error_backtrace);
                --
                v_resultado := l_trace.line_number;
                --
                RETURN v_resultado;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        RETURN NULL;
                        --
        END RETORNA_LINHA_ERRO;

        --
        --------------------------------------------------------------------------
        --
        --------------------------------------------------------------------------
        --
        PROCEDURE AtualizaProvisaoLIB(p_cd_ctrat      IN NUMBER
                                     ,p_cd_item_ctrat IN NUMBER
                                     ,p_cd_usuro      IN VARCHAR2
                                     ,p_cd_erro       OUT NUMBER
                                     ,p_msg_erro      OUT VARCHAR2) IS
                --
        BEGIN
                --
                UPDATE cta0004_lacto
                SET    cd_situc_lacto       = 'LIB'
                      ,cd_usuro_ultma_alter = p_cd_usuro
                      ,dt_ultma_alter       = SYSDATE
                WHERE  cd_ctrat = p_cd_ctrat
                AND    cd_item_ctrat = p_cd_item_ctrat
                AND    cd_situc_lacto = 'PRO';
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 1;
                        p_msg_erro := 'Erro AtualizaProvisao: ' || SQLERRM;
                        --
        END AtualizaProvisaoLIB;

        --
        --------------------------------------------------------------------------
        --
        --------------------------------------------------------------------------
        --
        PROCEDURE AtualizaProvisaoPRO(p_cd_ctrat      IN NUMBER
                                     ,p_cd_item_ctrat IN NUMBER
                                     ,p_cd_usuro      IN VARCHAR2
                                     ,p_cd_erro       OUT NUMBER
                                     ,p_msg_erro      OUT VARCHAR2) IS
                --
        BEGIN
                --
                UPDATE cta0004_lacto
                SET    cd_situc_lacto       = 'PRO'
                      ,cd_usuro_ultma_alter = p_cd_usuro
                      ,dt_ultma_alter       = SYSDATE
                WHERE  cd_ctrat = p_cd_ctrat
                AND    cd_item_ctrat = p_cd_item_ctrat
                AND    cd_situc_lacto = 'LIB';
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 1;
                        p_msg_erro := 'Erro AtualizaProvisao: ' || SQLERRM;
                        --
        END AtualizaProvisaoPRO;

        --
        --------------------------------------------------------------------------
        --      CriaLctoProvisaoDesconto:       Cria o lancamento da provisao   --
        --                                      de desconto.                    --
        --------------------------------------------------------------------------
        --
        PROCEDURE CriaLctoProvisaoDesconto(p_provisiona_valor_in   IN provisiona_valor_in
                                          ,p_id_verba              IN NUMBER
                                          ,p_vl_saldo              IN NUMBER
                                          ,p_vl_lacto              IN NUMBER
                                          ,p_dt_inico_vigen        IN DATE
                                          ,p_id_prdut_sistm_origm  IN NUMBER
                                          ,p_id_procs_criac        IN NUMBER
                                          ,p_corretor              IN CTACTPA0100_001.t_corretor
                                          ,p_cd_situc_lacto        IN VARCHAR2
                                          ,p_cd_ctrat              IN NUMBER
                                          ,p_cd_item_ctrat         IN NUMBER
                                          ,p_cd_erro               OUT NUMBER
                                          ,p_msg_erro              OUT VARCHAR2
                                          ,p_data_provsao_stder_in IN DATE DEFAULT NULL) IS
                --,
                --
                v_id_lacto NUMBER;
                v_corretor NUMBER;
                v_dt_lacto DATE;
                --
        BEGIN
                --
                p_cd_erro  := 0;
                p_msg_erro := NULL;
                v_dt_lacto := SYSDATE;
                --
                --  Se o processo for 45 (Proviso Fase 1  - Santander)
                --  incluir na proviso a data de proviso do Santander
                --
                IF p_provisiona_valor_in.CdProcesso = 45 THEN
                        --
                        IF p_data_provsao_stder_in IS NOT NULL THEN
                                --
                                v_dt_lacto := p_data_provsao_stder_in;
                                --
                                ctactpa0100_001.GravaLog(v_sq_log, '1 [Data de Lancamento] - CdProcesso = 45 e Data de Lanamento igual a data de proviso do Santander: ' ||
                                                          to_char(p_data_provsao_stder_in, 'DD/MM/YYYY'));
                                --
                        ELSE
                                --
                                v_dt_lacto := SYSDATE;
                                --
                                ctactpa0100_001.GravaLog(v_sq_log, '1 [Data de Lancamento] - CdProcesso = 45 e Data de Lanamento nula. Ser atribuido SYSDATE. ');
                                --                         
                        END IF;
                        --
                        --
                END IF;
                --
                --  Se o processo NO for 45 (Proviso Fase 1  - Santander)
                --  e o corretor for o 83501 recuperar a data de lancamento
                --  da previsao anterior com o contrato em questao e atribuit para a data de lanamento.
                --  Se no achar data de lancamento anterior utilizar o SYSDATE
                --
                IF p_provisiona_valor_in.CdProcesso <> 45 AND
                   p_provisiona_valor_in.CdCorretor = 83501 THEN
                        --
                        BEGIN
                                --
                                ctactpa0100_001.GravaLog(v_sq_log, '1 [Data de Lancamento] - CdProcesso: ' || p_provisiona_valor_in.CdProcesso ||
                                                          ' CdCorretor: 83501' ||
                                                          ' Recuperando uma data de Lanamento anterior para o contrato: ' || p_cd_ctrat);
                                SELECT l.dt_lacto
                                INTO   v_dt_lacto
                                FROM   cta0004_lacto l
                                WHERE  l.cd_ctrat = p_cd_ctrat
                                AND    l.id_lacto = (
                                       SELECT   MIN(lan.id_lacto)
                                       FROM     cta0004_lacto lan
                                       WHERE    lan.cd_ctrat = l.cd_ctrat
                                );
                                --
                                IF v_dt_lacto IS NULL THEN
                                        v_dt_lacto := SYSDATE;
                                        --
                                        ctactpa0100_001.GravaLog(v_sq_log, '1 [Data de Lancamento] - Data de Lanamento anterior NO encontrada para o contrato: ' ||
                                                                  p_cd_ctrat || ' data de lanamento ser o SYSDATE');
                                        --
                                END IF;
                                --
                        EXCEPTION
                                WHEN OTHERS THEN
                                        --
                                        p_cd_erro  := 35;
                                        p_msg_erro := 'Erro ao selecionar Data de lanamento anterior ctasq0004_lacto para o contrato: ' ||
                                                      p_cd_ctrat || ' : ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                END IF;
                --
                ctactpa0100_001.GravaLog(v_sq_log, '1 [Data de Lancamento] - Data de Lanamento para a Provisao: ' || v_dt_lacto);
                --
                BEGIN
                        --
                        SELECT ctasq0004_lacto.NEXTVAL
                        INTO   v_id_lacto
                        FROM   dual;
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 35;
                                p_msg_erro := 'Erro ao selecionar sequencia ctasq0004_lacto: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                BEGIN
                        --
                        ctactpa0100_001.GravaLog(v_sq_log, '1 [Data Incio Vigncia] - ' || To_Char(p_dt_inico_vigen, 'DD/MM/YYYY'));
                        --
                        INSERT INTO cta0004_lacto
                                (id_lacto
                                ,id_verba
                                ,cd_situc_lacto
                                ,cd_ctrat
                                ,cd_item_ctrat
                                ,cd_tipo_lacto
                                ,dt_lacto
                                ,vl_saldo_verba_anter
                                ,vl_lacto
                                ,vl_agrvo_ppota
                                ,vl_saldo_verba_postr
                                ,id_lacto_origm_trnsf
                                ,id_lacto_estor
                                ,tp_pesoa
                                ,nm_clien_sgrdo
                                ,nr_cpf_cnpj_clien
                                ,vl_prmio_liqui_ppota
                                ,pc_comis_crtor
                                ,dt_inico_vigen_segur
                                ,id_procs_criac
                                ,cd_usuro_criac
                                ,dt_criac
                                ,id_corrl_bus
                                ,id_prdut_sistm_origm
                                ,tp_desct_agrvo
                                ,cd_sucsl_comrl
                                ,cd_diret_comrl
                                ,cd_asses_atual_crtor)
                        --
                        VALUES
                                (v_id_lacto
                                ,p_id_verba
                                ,p_cd_situc_lacto
                                ,p_cd_ctrat
                                ,p_cd_item_ctrat
                                ,'P'
                                ,v_dt_lacto
                                ,p_vl_saldo
                                ,p_vl_lacto
                                ,0
                                ,p_vl_saldo - p_vl_lacto
                                ,NULL
                                ,NULL
                                ,p_provisiona_valor_in.TpPessoa
                                ,p_provisiona_valor_in.NmCliente
                                ,p_provisiona_valor_in.CPFCNPJCliente
                                ,v_VlPremioLiquido
                                ,p_provisiona_valor_in.PcComissao
                                ,p_dt_inico_vigen
                                ,p_id_procs_criac
                                ,p_provisiona_valor_in.CdUsuario
                                ,SYSDATE
                                ,p_provisiona_valor_in.IdCorrelation
                                ,p_id_prdut_sistm_origm
                                ,p_provisiona_valor_in.InAgravoDesconto
                                ,p_corretor.cd_sucsl_comrl
                                ,p_corretor.cd_diret_comrl
                                ,p_corretor.cd_asses);
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 35;
                                p_msg_erro := 'Erro ao inserir tabela cta0004_lacto: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 35;
                        p_msg_erro := 'Erro CriaLctoProvisaoDesconto: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END CriaLctoProvisaoDesconto;

        --
        --------------------------------------------------------------------------
        --      CriaLctoProvisaoAgravo: Cria o lancamento da provisao de        --
        --                              agravo.                                 --
        --------------------------------------------------------------------------
        --
        PROCEDURE CriaLctoProvisaoAgravo(p_provisiona_valor_in  IN provisiona_valor_in
                                        ,p_id_verba             IN NUMBER
                                        ,p_vl_saldo             IN NUMBER
                                        ,p_vl_lacto             IN NUMBER
                                        ,p_vl_credito           IN NUMBER
                                        ,p_dt_inico_vigen       IN DATE
                                        ,p_id_prdut_sistm_origm IN NUMBER
                                        ,p_id_procs_criac       IN NUMBER
                                        ,p_corretor             IN CTACTPA0100_001.t_corretor
                                        ,p_cd_situc_lacto       IN VARCHAR2
                                        ,p_cd_ctrat             IN NUMBER
                                        ,p_cd_item_ctrat        IN NUMBER
                                        ,p_cd_erro              OUT NUMBER
                                        ,p_msg_erro             OUT VARCHAR2) IS
                --
                v_id_lacto NUMBER;
                --
        BEGIN
                --
                p_cd_erro  := 0;
                p_msg_erro := NULL;
                --
                BEGIN
                        --
                        SELECT ctasq0004_lacto.NEXTVAL
                        INTO   v_id_lacto
                        FROM   dual;
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 38;
                                p_msg_erro := 'Erro ao selecionar sequencia ctasq0004_lacto: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                BEGIN
                        --
                        ctactpa0100_001.GravaLog(v_sq_log, '2 [Data Incio Vigncia] - ' || To_Char(p_dt_inico_vigen, 'DD/MM/YYYY'));
                        --
                        INSERT INTO cta0004_lacto
                                (id_lacto
                                ,id_verba
                                ,cd_situc_lacto
                                ,cd_ctrat
                                ,cd_item_ctrat
                                ,cd_tipo_lacto
                                ,dt_lacto
                                ,vl_saldo_verba_anter
                                ,vl_lacto
                                ,vl_agrvo_ppota
                                ,vl_saldo_verba_postr
                                ,id_lacto_origm_trnsf
                                ,id_lacto_estor
                                ,tp_pesoa
                                ,nm_clien_sgrdo
                                ,nr_cpf_cnpj_clien
                                ,vl_prmio_liqui_ppota
                                ,pc_comis_crtor
                                ,dt_inico_vigen_segur
                                ,id_procs_criac
                                ,cd_usuro_criac
                                ,dt_criac
                                ,id_corrl_bus
                                ,id_prdut_sistm_origm
                                ,tp_desct_agrvo
                                ,cd_sucsl_comrl
                                ,cd_diret_comrl
                                ,cd_asses_atual_crtor)
                        --
                        VALUES
                                (v_id_lacto --      id_lacto
                                ,p_id_verba --      id_verba
                                ,p_cd_situc_lacto --      cd_situc_lacto
                                ,p_cd_ctrat --      cd_ctrat
                                ,p_cd_item_ctrat --      cd_item_ctrat
                                ,'P' --      cd_tipo_lacto
                                ,SYSDATE --      dt_lacto
                                ,p_vl_saldo --      vl_saldo_verba_anter
                                ,p_vl_credito --      vl_lacto
                                ,p_vl_lacto --      vl_agrvo_ppota
                                ,p_vl_saldo --      vl_saldo_verba_postr
                                ,NULL --      id_lacto_origm_trnsf
                                ,NULL --      id_lacto_estor
                                ,p_provisiona_valor_in.TpPessoa --      tp_pesoa
                                ,p_provisiona_valor_in.NmCliente --      nm_clien_sgrdo
                                ,p_provisiona_valor_in.CPFCNPJCliente --      nr_cpf_cnpj_clien
                                ,v_VlPremioLiquido --      vl_prmio_liqui_ppota
                                ,p_provisiona_valor_in.PcComissao --      pc_comis_crtor
                                ,p_dt_inico_vigen --      dt_inico_vigen_segur
                                ,p_id_procs_criac --      id_procs_criac
                                ,p_provisiona_valor_in.CdUsuario --      cd_usuro_criac
                                ,SYSDATE --      dt_criac
                                ,p_provisiona_valor_in.IdCorrelation --      id_corrl_bus
                                ,p_id_prdut_sistm_origm --      id_prdut_sistm_origm
                                ,p_provisiona_valor_in.InAgravoDesconto --      tp_desct_agrvo
                                ,p_corretor.cd_sucsl_comrl --      cd_sucsl_comrl
                                ,p_corretor.cd_diret_comrl --      cd_diret_comrl
                                ,p_corretor.cd_asses); --      cd_asses_atual_crtor
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 38;
                                p_msg_erro := 'Erro ao inserir tabela cta0004_lacto: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 38;
                        p_msg_erro := 'Erro CriaLctoProvisaoAgravo: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END CriaLctoProvisaoAgravo;

        --
        --------------------------------------------------------------------------
        --      CriaVerbaVitalicia:     Cria verba vitalcia para um corretor.  --
        --                              Aps a criao da verba, provisiona o   --
        --                              agravo para o corretor.                 --
        --------------------------------------------------------------------------
        --
        PROCEDURE CriaVerbaVitalicia(p_provisiona_valor_in  IN provisiona_valor_in
                                    ,p_cd_segmt_prdut       IN NUMBER
                                    ,p_vl_credito           IN NUMBER
                                    ,p_dt_procs             IN DATE
                                    ,p_id_prdut_sistm_origm IN NUMBER
                                    ,p_id_procs_criac       IN NUMBER
                                    ,p_corretor             IN CTACTPA0100_001.t_corretor
                                    ,p_cd_situc_lacto       IN VARCHAR2
                                    ,p_cd_ctrat             IN NUMBER
                                    ,p_cd_item_ctrat        IN NUMBER
                                    ,p_dt_inico_vigen       IN DATE
                                    ,p_cd_erro              OUT NUMBER
                                    ,p_msg_erro             OUT VARCHAR2) IS
                --
                v_id_verba cta0002_verba.id_verba%TYPE;
                v_cd_erro  NUMBER;
                v_msg_erro VARCHAR2(4000);
                --
        BEGIN
                --
                BEGIN
                        --
                        SELECT ctasq0002_verba.NEXTVAL
                        INTO   v_id_verba
                        FROM   dual;
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 37;
                                p_msg_erro := 'Erro ao selecionar valor da sequencia: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                BEGIN
                        --
                        --      log chamada
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'corretor ' || p_provisiona_valor_in.CdCorretor);
                        CTACTPA0100_001.GravaLog(v_sq_log, 'valor credito ' || p_vl_credito);
                        CTACTPA0100_001.GravaLog(v_sq_log, 'segmento produto ' || p_cd_segmt_prdut);
                        --
                        INSERT INTO cta0002_verba
                                (id_verba
                                ,cd_segmt_prdut
                                ,cd_crtor_segur
                                ,cd_asses
                                ,cd_tipo_verba
                                ,vl_inicl_verba
                                ,vl_prvsn_verba
                                ,vl_eftdo_verba
                                ,vl_crdto_verba
                                ,vl_saldo_verba
                                ,dt_inico_vigen
                                ,dt_fim_vigen
                                ,id_verba_origm_trnsf
                                ,cd_usuro_ultma_alter
                                ,dt_ultma_alter
                                ,cd_situc_verba
                                ,id_arquv_carga_verba
                                ,vl_crdit_agrvo)
                        --
                        VALUES
                                (v_id_verba --      id_verba
                                ,p_cd_segmt_prdut --      cd_segmt_prdut
                                ,p_provisiona_valor_in.CdCorretor --      cd_crtor_segur
                                ,NULL --      cd_asses
                                ,'C' --      cd_tipo_verba
                                ,0 --      vl_inicl_verba
                                ,0 --      vl_prvsn_verba
                                ,0 --      vl_eftdo_verba
                                ,0 --      vl_crdto_verba
                                ,0 --      vl_saldo_verba
                                ,p_dt_procs --      dt_inico_vigen
                                ,To_Date('31/12/2699', 'DD/MM/YYYY') --      dt_fim_vigen
                                ,NULL --      id_verba_origm_trnsf
                                ,p_provisiona_valor_in.CdUsuario --      cd_usuro_ultma_alter
                                ,SYSDATE --      dt_ultma_alter
                                ,'ATI' --      cd_situc_verba
                                ,NULL --      id_arquv_carga_verba
                                ,p_vl_credito); --      vl_crdit_agrvo
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 37;
                                p_msg_erro := 'Erro ao inserir verba vitalcia: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                --      Depois de criar a verba vitalcia, criar a proviso do
                --      agravo
                --
                CriaLctoProvisaoAgravo(p_provisiona_valor_in, v_id_verba, 0, v_VlAgravoDesconto, p_vl_credito, p_dt_inico_vigen, p_id_prdut_sistm_origm, p_id_procs_criac, p_corretor, p_cd_situc_lacto, p_cd_ctrat, p_cd_item_ctrat, v_cd_erro, v_msg_erro);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_cd_erro  := v_cd_erro;
                        p_msg_erro := v_msg_erro;
                        --
                        RETURN;
                        --
                END IF;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 37;
                        p_msg_erro := 'Erro CriaVerbaVitalicia: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END CriaVerbaVitalicia;

        --
        --------------------------------------------------------------------------
        --      ProvisionaDesconto:     Provisiona o valor de um desconto nas   --
        --                              verbas do corretor.                     --
        --------------------------------------------------------------------------
        --
        PROCEDURE ProvisionaDesconto(p_cd_segmt_prdut        IN NUMBER
                                    ,p_dt_procm              IN DATE
                                    ,p_provisiona_valor_in   IN provisiona_valor_in
                                    ,p_dt_inico_vigen        IN DATE
                                    ,p_id_prdut_sistm_origm  IN NUMBER
                                    ,p_id_procs_criac        IN NUMBER
                                    ,p_corretor              IN CTACTPA0100_001.t_corretor
                                    ,p_cd_situc_lacto        IN VARCHAR2
                                    ,p_cd_ctrat              IN NUMBER
                                    ,p_cd_item_ctrat         IN NUMBER
                                    ,p_cd_erro               OUT NUMBER
                                    ,p_msg_erro              OUT VARCHAR2
                                    ,p_data_provsao_stder_in IN DATE DEFAULT NULL) IS
                --
                CURSOR c_vl_saldo IS
                --
                        SELECT a.id_verba
                              ,a.vl_saldo_verba
                              ,a.vl_prvsn_verba
                              ,b.nr_rnkng_utlzc
                        FROM   cta0002_verba      a
                              ,cta0003_tipo_verba b
                        WHERE  a.cd_tipo_verba = b.cd_tipo_verba
                        AND    a.cd_crtor_segur = p_provisiona_valor_in.CdCorretor
                        AND    a.cd_segmt_prdut = p_cd_segmt_prdut
                        AND    a.cd_situc_verba = 'ATI'
                        AND    a.dt_inico_vigen <= p_dt_procm
                        AND    a.dt_fim_vigen >= p_dt_procm
                        AND    a.vl_saldo_verba > 0
                        ORDER  BY b.nr_rnkng_utlzc ASC
                                 ,a.dt_fim_vigen   ASC
                        FOR    UPDATE;
                --
                v_resto NUMBER;
                v_reduz NUMBER;
                --
                v_cd_erro  NUMBER;
                v_msg_erro VARCHAR2(4000);
                --
        BEGIN
                --
                p_cd_erro  := 0;
                p_msg_erro := NULL;
                --
                v_resto := v_VlAgravoDesconto;
                --
                FOR r_vl_saldo IN c_vl_saldo LOOP
                        --
                        IF v_resto - r_vl_saldo.vl_saldo_verba >= 0 THEN
                                --
                                v_resto := v_resto - r_vl_saldo.vl_saldo_verba;
                                v_reduz := r_vl_saldo.vl_saldo_verba;
                                --
                        ELSE
                                --
                                v_reduz := v_resto;
                                v_resto := 0;
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[ProvisionaDesconto] Atualizando vl_saldo_verba = ' || r_vl_saldo.vl_saldo_verba || ' - ' ||
                                                  v_reduz);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[ProvisionaDesconto] Atualizando vl_prvsn_verba = ' || r_vl_saldo.vl_prvsn_verba || ' + ' ||
                                                  v_reduz);
                        --
                        BEGIN
                                --
                                UPDATE cta0002_verba
                                SET    vl_saldo_verba = Nvl(r_vl_saldo.vl_saldo_verba, 0) - v_reduz
                                      ,vl_prvsn_verba = Nvl(r_vl_saldo.vl_prvsn_verba, 0) + v_reduz
                                      ,dt_ultma_alter = SYSDATE
                                WHERE  id_verba = r_vl_saldo.id_verba;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        p_cd_erro  := 34;
                                        p_msg_erro := 'Erro ao atualizar verba na tabela cta0002_verba: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CriaLctoProvisaoDesconto(p_provisiona_valor_in, r_vl_saldo.id_verba, r_vl_saldo.vl_saldo_verba, v_reduz, p_dt_inico_vigen, p_id_prdut_sistm_origm, p_id_procs_criac, p_corretor, p_cd_situc_lacto, p_cd_ctrat, p_cd_item_ctrat, v_cd_erro, v_msg_erro, p_data_provsao_stder_in);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_cd_erro  := v_cd_erro;
                                p_msg_erro := v_msg_erro;
                                --
                                RETURN;
                                --
                        END IF;
                        --
                        IF v_resto = 0 THEN
                                --
                                EXIT;
                                --
                        END IF;
                        --
                END LOOP;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 34;
                        p_msg_erro := 'Erro no previsto em ProvisionaDesconto: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END ProvisionaDesconto;

        --
        --------------------------------------------------------------------------
        --      ProvisionaAgravo:       Provisiona o valor de um agravo nas     --
        --                              verbas do corretor.                     --
        --------------------------------------------------------------------------
        --
        PROCEDURE ProvisionaAgravo(p_provisiona_valor_in  IN provisiona_valor_in
                                  ,p_cd_segmt_prdut       IN NUMBER
                                  ,p_dt_procm             IN DATE
                                  ,p_dt_inico_vigen       IN DATE
                                  ,p_id_prdut_sistm_origm IN NUMBER
                                  ,p_id_procs_criac       IN NUMBER
                                  ,p_corretor             IN CTACTPA0100_001.t_corretor
                                  ,p_cd_situc_lacto       IN VARCHAR2
                                  ,p_cd_ctrat             IN NUMBER
                                  ,p_cd_item_ctrat        IN NUMBER
                                  ,p_vl_agrav_s_comiss    OUT NUMBER
                                  ,p_cd_erro              OUT NUMBER
                                  ,p_msg_erro             OUT VARCHAR2) IS
                --
                v_vl_credito  NUMBER;
                v_count_verba NUMBER;
                v_cd_erro     NUMBER;
                v_msg_erro    VARCHAR2(4000);
                --
                CURSOR c_vl_agravo IS
                --
                        SELECT a.id_verba
                              ,a.vl_saldo_verba
                              ,a.vl_crdit_agrvo
                        FROM   cta0002_verba a
                        WHERE  a.cd_crtor_segur = p_provisiona_valor_in.CdCorretor
                        AND    a.cd_tipo_verba = 'C'
                        AND    a.cd_segmt_prdut = p_cd_segmt_prdut
                        AND    a.cd_situc_verba = 'ATI'
                        FOR    UPDATE;
                --
        BEGIN
                --
                v_vl_credito        := Trunc((v_VlAgravoDesconto * (1 - (p_provisiona_valor_in.PcComissao / 100))), 2);
                p_vl_agrav_s_comiss := v_vl_credito;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, 'Valor do crdito: ' || v_vl_credito);
                --
                BEGIN
                        --
                        SELECT COUNT(1)
                        INTO   v_count_verba
                        FROM   cta0002_verba a
                        WHERE  a.cd_crtor_segur = p_provisiona_valor_in.CdCorretor
                        AND    a.cd_tipo_verba = 'C'
                        AND    a.cd_segmt_prdut = p_cd_segmt_prdut
                        AND    a.cd_situc_verba = 'ATI';
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                p_cd_erro  := 36;
                                p_msg_erro := 'Erro ao selecionar verba: ' || SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                --      Se no encontrar verba, criar verba vitalcia
                --
                IF v_count_verba = 0 THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Criando verba. Valor do crdito: ' || v_vl_credito);
                        --
                        CriaVerbaVitalicia(p_provisiona_valor_in, p_cd_segmt_prdut, v_vl_credito, p_dt_procm, p_id_prdut_sistm_origm, p_id_procs_criac, p_corretor, p_cd_situc_lacto, p_cd_ctrat, p_cd_item_ctrat, p_dt_inico_vigen, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_cd_erro  := v_cd_erro;
                                p_msg_erro := v_msg_erro;
                                --
                                RETURN;
                                --
                        END IF;
                        --
                ELSIF v_count_verba = 1 THEN
                        --
                        FOR r_vl_agravo IN c_vl_agravo LOOP
                                --
                                CriaLctoProvisaoAgravo(p_provisiona_valor_in, r_vl_agravo.id_verba, r_vl_agravo.vl_saldo_verba, v_VlAgravoDesconto, v_vl_credito, p_dt_inico_vigen, p_id_prdut_sistm_origm, p_id_procs_criac, p_corretor, p_cd_situc_lacto, p_cd_ctrat, p_cd_item_ctrat, v_cd_erro, v_msg_erro);
                                --
                                IF v_cd_erro <> 0 THEN
                                        --
                                        p_cd_erro  := v_cd_erro;
                                        p_msg_erro := v_msg_erro;
                                        --
                                        RETURN;
                                        --
                                END IF;
                                --
                                --      Atualizando registro
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, 'Atualizando verba ' || r_vl_agravo.id_verba ||
                                                          '. Valor do crdito [v_vl_credito] = ' || v_vl_credito ||
                                                          ' Valor anterior [vl_crdit_agrvo] = ' || r_vl_agravo.vl_crdit_agrvo);
                                --
                                BEGIN
                                        --
                                        UPDATE cta0002_verba
                                        SET    vl_crdit_agrvo = Nvl(vl_crdit_agrvo, 0) + v_vl_credito
                                              ,dt_ultma_alter = SYSDATE
                                        WHERE  id_verba = r_vl_agravo.id_verba;
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                p_cd_erro  := 0;
                                                p_msg_erro := NULL;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END LOOP;
                        --
                ELSE
                        --
                        p_cd_erro  := 39;
                        p_msg_erro := 'Foi encontrada mais de uma verba vitalcia para o corretor';
                        --
                        RETURN;
                        --
                END IF;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 36;
                        p_msg_erro := 'Erro ProvisionaDesconto: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END ProvisionaAgravo;

        --
        --------------------------------------------------------------------------
        --      Provisiona_Valor:       Provisionar saldo do Conta Corrente     --
        --                              para uma proposta efetivada no KCW. KTR --
        --                              ou SSV.                                 --
        --------------------------------------------------------------------------
        --
        PROCEDURE Provisiona_Valor(p_provisiona_valor_in   IN provisiona_valor_in
                                  ,p_provisiona_valor_out  OUT provisiona_valor_out
                                  ,p_data_provsao_stder_in IN DATE DEFAULT NULL) IS
                --
                v_dt_procm       DATE;
                v_dt_inico_vigen DATE;
                v_cd_segmt_prdut cta0001_prdut.cd_segmt_prdut%TYPE;
                v_id_prdut       cta0001_prdut.id_prdut%TYPE;
                v_id_procs_criac cta0007_procs.id_procs%TYPE;
                v_cd_situc_lacto VARCHAR2(3);
                v_tp_desct_agrvo VARCHAR2(3);
                --
                v_cd_erro         NUMBER;
                v_msg_erro        VARCHAR2(4000);
                v_vl_saldo_verba  cta0002_verba.vl_saldo_verba%TYPE;
                v_vl_lacto        cta0004_lacto.vl_lacto%TYPE;
                v_pc_maxmo_desct  cta0009_pctis_comis_desct.pc_maxmo_desct%TYPE;
                v_pc_agravo_desct NUMBER;
                v_vl_restante     NUMBER;
                --
                v_vl_maxmo_desct    NUMBER;
                v_vl_maxmo_agravo   NUMBER;
                v_vl_agrav_s_comiss NUMBER;
                --
                v_estorna_provisao_in  estorna_provisao_in;
                v_estorna_provisao_out estorna_provisao_out;
                --
                v_reserva_num_negocio_item_in  reserva_num_negocio_item_in;
                v_reserva_num_negocio_item_out reserva_num_negocio_item_out;
                --
                v_corretor CTACTPA0100_001.t_corretor;
                erro_fatal        EXCEPTION;
                atualiza_provisao EXCEPTION;
                --
                v_CdContrato     NUMBER;
                v_CdItemContrato NUMBER;
                --
                CURSOR verba_estorno(p_dt_procs IN DATE) IS
                --
                        SELECT a.id_lacto
                              ,a.id_verba
                              ,a.cd_situc_lacto
                              ,a.cd_ctrat
                              ,a.cd_item_ctrat
                              ,a.cd_tipo_lacto
                              ,a.dt_lacto
                              ,a.vl_saldo_verba_anter
                              ,a.vl_lacto
                              ,a.vl_agrvo_ppota
                              ,a.vl_saldo_verba_postr
                              ,a.id_lacto_origm_trnsf
                              ,a.id_lacto_estor
                              ,a.tp_pesoa
                              ,a.nm_clien_sgrdo
                              ,a.nr_cpf_cnpj_clien
                              ,a.vl_prmio_liqui_ppota
                              ,a.pc_comis_crtor
                              ,a.dt_inico_vigen_segur
                              ,a.id_procs_criac
                              ,a.cd_usuro_criac
                              ,a.dt_criac
                              ,a.id_procs_alter
                              ,a.cd_usuro_ultma_alter
                              ,a.dt_ultma_alter
                              ,a.id_corrl_bus
                              ,a.id_prdut_sistm_origm
                              ,a.tp_desct_agrvo
                              ,b.dt_fim_vigen - p_dt_procs qt_dias_verba_a_vencer
                              ,b.cd_segmt_prdut cd_segmt_prdut_vb
                              ,b.cd_crtor_segur cd_crtor_segur_vb
                              ,b.cd_asses cd_asses_vb
                              ,b.cd_tipo_verba cd_tipo_verba_vb
                              ,b.vl_inicl_verba vl_inicl_verba_vb
                              ,b.vl_prvsn_verba vl_prvsn_verba_vb
                              ,b.vl_eftdo_verba vl_eftdo_verba_vb
                              ,b.vl_crdto_verba vl_crdto_verba_vb
                              ,b.vl_saldo_verba vl_saldo_verba_vb
                              ,b.dt_inico_vigen dt_inico_vigen_vb
                              ,b.dt_fim_vigen dt_fim_vigen_vb
                              ,b.id_verba_origm_trnsf id_verba_origm_trnsf_vb
                              ,b.cd_usuro_ultma_alter cd_usuro_ultma_alter_vb
                              ,b.dt_ultma_alter dt_ultma_alter_vb
                              ,b.cd_situc_verba cd_situc_verba_vb
                              ,b.id_arquv_carga_verba id_arquv_carga_verba_vb
                              ,b.vl_eftdo_verba
                              ,b.vl_saldo_verba
                              ,b.vl_crdit_agrvo
                              ,b.vl_inicl_verba
                        FROM   cta0004_lacto a
                              ,cta0002_verba b
                        WHERE  a.cd_ctrat = p_provisiona_valor_in.CdContrato
                        AND    a.cd_item_ctrat = p_provisiona_valor_in.CdItemContrato
                        AND    a.cd_situc_lacto NOT IN ('CAN', 'AGB')
                        AND    a.id_lacto_estor IS NULL
                        AND    a.id_verba = b.id_verba;
                --
                CURSOR verba_estorno2(p_dt_procs IN DATE
                                     ,p_id_verba IN NUMBER) IS
                --
                        SELECT b.dt_fim_vigen - p_dt_procs qt_dias_verba_a_vencer
                              ,b.cd_segmt_prdut cd_segmt_prdut_vb
                              ,b.cd_crtor_segur cd_crtor_segur_vb
                              ,b.cd_asses cd_asses_vb
                              ,b.cd_tipo_verba cd_tipo_verba_vb
                              ,b.vl_inicl_verba vl_inicl_verba_vb
                              ,b.vl_prvsn_verba vl_prvsn_verba_vb
                              ,b.vl_eftdo_verba vl_eftdo_verba_vb
                              ,b.vl_crdto_verba vl_crdto_verba_vb
                              ,b.vl_saldo_verba vl_saldo_verba_vb
                              ,b.dt_inico_vigen dt_inico_vigen_vb
                              ,b.dt_fim_vigen dt_fim_vigen_vb
                              ,b.id_verba_origm_trnsf id_verba_origm_trnsf_vb
                              ,b.cd_usuro_ultma_alter cd_usuro_ultma_alter_vb
                              ,b.dt_ultma_alter dt_ultma_alter_vb
                              ,b.cd_situc_verba cd_situc_verba_vb
                              ,b.id_arquv_carga_verba id_arquv_carga_verba_vb
                              ,b.vl_eftdo_verba
                              ,b.vl_saldo_verba
                              ,b.vl_crdit_agrvo
                              ,b.vl_inicl_verba
                        FROM   cta0002_verba b
                        WHERE  b.id_verba = p_id_verba;
                --
                v_id_verba_aux NUMBER;
                --
                v_recepcao_achou_provisao VARCHAR2(1) := 'S';
                --
        BEGIN
                --
                --      Inicializando o type
                --
                p_provisiona_valor_out := provisiona_valor_out(0, NULL, NULL, NULL);
                --
                v_VlAgravoDesconto := Round(p_provisiona_valor_in.VlAgravoDesconto, 2);
                v_VlPremioLiquido  := Round(p_provisiona_valor_in.VlPremioLiquido, 2);
                --
                CTACTPA0100_001.IniciaLog(31, p_provisiona_valor_in.SistemaChamador, p_provisiona_valor_in.CdCorretor, NULL, p_provisiona_valor_in.CdContrato, p_provisiona_valor_in.CdItemContrato, p_provisiona_valor_in.TpPessoa, p_provisiona_valor_in.CPFCNPJCliente, p_provisiona_valor_in.NmCliente, p_provisiona_valor_in.CdUsuario, p_provisiona_valor_in.CdProcesso, v_sq_log);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 79, '=') || Chr(10) || 
                                        'Incio execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 79, '=') || Chr(10) ||
                                        'Servio Provisiona_Valor. Parmetros de entrada: ' || Chr(10) || 
                                        'NmCliente............. ' || p_provisiona_valor_in.NmCliente || Chr(10) ||
                                        'CdProcesso............ ' || p_provisiona_valor_in.CdProcesso || Chr(10) || 
                                        'CdCorretor............ ' || p_provisiona_valor_in.CdCorretor || Chr(10) || 
                                        'IdCorrelation......... ' || p_provisiona_valor_in.IdCorrelation || Chr(10) || 
                                        'TpPessoa.............. ' || p_provisiona_valor_in.TpPessoa || Chr(10) || 
                                        'VlPremioLiquido....... ' || p_provisiona_valor_in.VlPremioLiquido || Chr(10) ||
                                        'v_VlPremioLiquido..... ' || v_VlPremioLiquido || Chr(10) || 
                                        'CPFCNPJCliente........ ' || p_provisiona_valor_in.CPFCNPJCliente || Chr(10) ||
                                        'CdUsuario............. ' || p_provisiona_valor_in.CdUsuario || Chr(10) || 
                                        'SistemaChamador....... ' || p_provisiona_valor_in.SistemaChamador || Chr(10) || 
                                        'CdContrato............ ' || p_provisiona_valor_in.CdContrato || Chr(10) || 
                                        'DtInicioVigencia...... ' || p_provisiona_valor_in.DtInicioVigencia || Chr(10) || 
                                        'CdProduto............. ' || p_provisiona_valor_in.CdProduto || Chr(10) || 
                                        'PcComissao............ ' || p_provisiona_valor_in.PcComissao || Chr(10) || 
                                        'VlAgravoDesconto...... ' || p_provisiona_valor_in.VlAgravoDesconto || Chr(10) || 
                                        'v_VlAgravoDesconto.... ' || v_VlAgravoDesconto || Chr(10) || 
                                        'CdItemContrato........ ' || p_provisiona_valor_in.CdItemContrato || Chr(10) || 
                                        'InAgravoDesconto...... ' || p_provisiona_valor_in.InAgravoDesconto || Chr(10) || 
                                        'Ambiente.............. ' || CTACTPA0100_001.RetornaParametro('AMBIENTE') || Chr(10) || 
                                        LPad('=', 79, '='));
                --
                IF p_data_provsao_stder_in IS NOT NULL THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Data de proviso passada para o processo ' || p_provisiona_valor_in.CdProcesso || ' = ' || to_char(p_data_provsao_stder_in, 'DD/MM/YYYY'));
                        --
                END IF;
                --
                --
                --      Validando o sistema chamador
                --
                IF NOT (CTACTPA0100_001.SistemaChamadorValido(p_provisiona_valor_in.SistemaChamador)) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 2;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Sistema chamador invlido: ' || p_provisiona_valor_in.SistemaChamador;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando o corretor
                --
                IF NOT (CTACTPA0100_001.IsCorretorValido(p_provisiona_valor_in.CdCorretor, v_cd_erro, v_msg_erro)) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando nmero de negcio
                --
                IF p_provisiona_valor_in.CdContrato = 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 15;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Nmero de negcio igual a zero';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando nmero de item
                --
                IF p_provisiona_valor_in.CdContrato IS NULL THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 15;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Nmero de negcio est nulo';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando nmero de item
                --
                IF p_provisiona_valor_in.CdItemContrato IS NULL THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 16;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Nmero de item est nulo';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando indicador de agravo / desconto
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (06, 29, 34, 39) THEN
                        --
                        IF Nvl(p_provisiona_valor_in.InAgravoDesconto, 'X') NOT IN ('A', 'D') THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 24;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Indicador de desconto / agravo invlido: ' ||
                                                                     Nvl(p_provisiona_valor_in.InAgravoDesconto, 'nulo');
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Valida para NO PERMITIR proviso de agravo para corretor bloqueado.
                --
                IF NOT
                    (CTACTPA0100_001.IsPermiteAgravoCorretor(p_provisiona_valor_in.CdCorretor, p_provisiona_valor_in.InAgravoDesconto, v_cd_erro, v_msg_erro)) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 27;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - No permitido Agravo para o corretor: ' || p_provisiona_valor_in.CdCorretor || ' [' || v_sq_log || '] ';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando valor de agravo / desconto
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (06, 29, 34, 39) THEN
                        --
                        IF v_VlAgravoDesconto IS NULL OR
                           v_VlAgravoDesconto < 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 25;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Valor de agravo / desconto invlido: ' ||
                                                                     v_VlAgravoDesconto;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        IF NOT (CTACTPA0100_001.ValidaValorDescAgrav(v_VlAgravoDesconto, v_cd_erro, v_msg_erro)) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        IF      NOT(CTACTPA0100_001.ValidaValorMinimoAgravDesc  (v_VlAgravoDesconto
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro))   THEN
                                --
                                p_provisiona_valor_out.StRetorno        :=      v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno       :=      '[Provisiona Valor] - '||v_msg_erro;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                        --      Validando tipo de pessoa
                        --
                        IF Nvl(p_provisiona_valor_in.TpPessoa, 'X') NOT IN ('F', 'J') THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 8;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Tipo de pessoa invlido: ' ||
                                                                     Nvl(p_provisiona_valor_in.TpPessoa, 'nulo');
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Validando CPF / CNPJ do cliente
                --
                IF p_provisiona_valor_in.CPFCNPJCliente IS NULL THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 9;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - CPF / CNPJ est nulo';
                        --
                        RAISE erro_fatal;
                        --
                ELSE
                        --
                        IF p_provisiona_valor_in.TpPessoa = 'F' AND
                           NOT (tms_util.valida_cpf(LPad(p_provisiona_valor_in.CPFCNPJCliente, 11, '0'))) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 9;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - CPF invlido: ' || p_provisiona_valor_in.CPFCNPJCliente;
                                --
                                RAISE erro_fatal;
                                --
                        ELSIF p_provisiona_valor_in.TpPessoa = 'J' AND
                              NOT (tms_util.valida_cnpj(LPad(p_provisiona_valor_in.CPFCNPJCliente, 14, '0'))) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 9;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - CNPJ invlido: ' || p_provisiona_valor_in.CPFCNPJCliente;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Validando nome do cliente
                --
                IF p_provisiona_valor_in.NmCliente IS NULL THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 26;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Nome de cliente est nulo';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando Valor Prmio Lquido
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (29, 34, 39) THEN
                        --
                        IF v_VlPremioLiquido IS NULL THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 5;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Valor do prmio lquido est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        --      Validando percentual de comisso
                        --
                        IF p_provisiona_valor_in.Pccomissao IS NULL THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 6;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Percentual de comisso est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (29) THEN
                        --
                        --      Validando incio de vigncia
                        --
                        IF p_provisiona_valor_in.DtInicioVigencia IS NULL THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 7;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Data de incio de vigncia est nula';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        IF NOT (CTACTPA0100_001.IsDataValida(p_provisiona_valor_in.DtInicioVigencia, v_dt_inico_vigen)) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 7;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Data de incio de vigncia invlida: ' ||
                                                                     p_provisiona_valor_in.DtInicioVigencia;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Validando usurio
                --
                IF p_provisiona_valor_in.CdUsuario IS NULL THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 10;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Usurio est nulo';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando cdigo de processo
                --
                IF Nvl(p_provisiona_valor_in.CdProcesso, 0) NOT IN (1, 2, 6, 29, 30, 31, 34, 37, 39, 45, 62) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 11;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Cdigo de processo invlido: ' || p_provisiona_valor_in.CdProcesso;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm := CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaDtProcm] Data de processamento: ' || v_dt_procm);
                --
                --      Valida sistema indisponvel.
                --
                IF CTACTPA0100_001.IsSistemaIndisponivel(v_cd_erro, v_msg_erro) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Busca segmento do produto
                --
                v_cd_segmt_prdut := CTACTPA0100_001.RetornaSegmentoProduto(p_provisiona_valor_in.SistemaChamador, p_provisiona_valor_in.CdProduto, v_dt_procm, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaSegmentoProduto] - ' || v_cd_segmt_prdut || ' Sistema Chamador: ' ||
                                          p_provisiona_valor_in.SistemaChamador || ' Produto: ' || p_provisiona_valor_in.CdProduto ||
                                          ' Data: ' || v_dt_procm);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando o mdulo produto
                --
                v_id_prdut := CTACTPA0100_001.ModuloProdutoValido(p_provisiona_valor_in.CdProduto, p_provisiona_valor_in.SistemaChamador, v_cd_segmt_prdut, v_dt_procm, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[ModuloProdutoValido] - ' || v_id_prdut || ' Produto: ' || p_provisiona_valor_in.CdProduto ||
                                          ' Sistema Chamador: ' || p_provisiona_valor_in.SistemaChamador || ' Segmento: ' ||
                                          v_cd_segmt_prdut || ' Data: ' || v_dt_procm);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                v_id_procs_criac := CTACTPA0100_001.ValidaCdProcesso(p_provisiona_valor_in.CdProcesso, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[ValidaCdProcesso] - ' || v_id_procs_criac || ' Processo: ' || p_provisiona_valor_in.CdProcesso);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Valida corretor bloqueado
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[IsCorretorBloqueado] - Corretor: ' || p_provisiona_valor_in.CdCorretor || ' Segmento: ' ||
                                          v_cd_segmt_prdut);
                --
                IF v_VlAgravoDesconto > 0 THEN
                        --
                        IF CTACTPA0100_001.IsCorretorBloqueado(p_provisiona_valor_in.CdCorretor, v_cd_segmt_prdut, v_cd_erro, v_msg_erro) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        --      Valida se o corretor est habilitado
                        --
                        IF NOT (CTACTPA0100_001.IsCorretorHabilitado(p_provisiona_valor_in.CdCorretor, v_cd_segmt_prdut, v_cd_erro, v_msg_erro)) THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                CTACTPA0100_001.RetornaDadosCorretor(p_provisiona_valor_in.CdCorretor, v_corretor);
                --
                IF p_provisiona_valor_in.SistemaChamador IN ('KCW', 'KME') THEN
                        --
                        p_provisiona_valor_out.NrNegocioReservado := 0;
                        p_provisiona_valor_out.NrItemReservado    := 0;
                        --
                END IF;
                --
                --      Usando sempre o valor da entrada, independente do sistema.
                --
                v_CdContrato     := p_provisiona_valor_in.CdContrato;
                v_CdItemContrato := p_provisiona_valor_in.CdItemContrato;
                --
                --      Buscar o saldo
                --
                v_vl_saldo_verba        :=      CTACTPA0100_001.BuscaSaldo      (p_provisiona_valor_in.CdCorretor
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log,'[BuscaSaldo] - '||v_vl_saldo_verba||' Corretor: '||p_provisiona_valor_in.CdCorretor||' Segmento: '||v_cd_segmt_prdut||' Data: '||v_dt_procm);
                --
                v_vl_saldo_verba := CTACTPA0100_001.ValidaSaldo(v_sq_log
                                                               ,p_provisiona_valor_in.SistemaChamador
                                                               ,p_provisiona_valor_in.CdCorretor
                                                               ,v_vl_saldo_verba);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Acrescentar Proviso Anterior para o item
                --
                v_vl_lacto := CTACTPA0100_001.RetornaProvisao(v_CdContrato, v_CdItemContrato, p_provisiona_valor_in.CdCorretor, v_tp_desct_agrvo, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaProvisao] - ' || v_vl_lacto || ' Negcio: ' || v_CdContrato || ' Item: ' ||
                                          v_CdItemContrato || ' Corretor: ' || p_provisiona_valor_in.CdCorretor);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := v_cd_erro;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Se o codigo de processo for 29 (liberao SSV) e no
                --      existir proviso para o item, dar mensagem de erro
                --
                IF p_provisiona_valor_in.CdProcesso IN (29, 34, 39) AND
                   v_vl_lacto = 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 102;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Proviso no encontrada para o item: ' || v_CdItemContrato || ' negcio: ' || v_CdContrato;
                        --
                        RAISE erro_fatal;
                        --
                        --
                ELSIF p_provisiona_valor_in.CdProcesso IN (30, 31) AND
                      v_vl_lacto = 0 AND
                      p_provisiona_valor_in.CdUsuario <> 'RECEPCAO_PRIMEIRA_PROVISAO' THEN
                        --
                        -- Recepo no validar se o KCW provisionou
                        -- em vez de dar erro fatal, fazemos todo o processo de proviso e se no houver nenhum
                        -- outro erro damos o erro 12 no final do processo
                        --
                        v_recepcao_achou_provisao := 'N';
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Recepo no encontrou proviso anterior pelo KCW]');
                        --
                END IF;
                --
                --      S deve somar o valor no saldo da verba se for lanamento
                --      de desconto
                --
                IF v_tp_desct_agrvo = 'D' THEN
                        --
                        v_vl_saldo_verba := v_vl_saldo_verba + v_vl_lacto;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Novo Valor de Saldo da Verba] = ' || v_vl_saldo_verba || ' Saldo anterior: ' || v_vl_saldo_verba || ' Valor do lanamento: ' || v_vl_lacto);
                        --
                END IF;
                --
                --      Busca o valor de desconto, caso seja um desconto
                --
                IF      p_provisiona_valor_in.InAgravoDesconto  =       'D'     THEN
                        --
                        v_pc_maxmo_desct        :=      CTACTPA0100_001.BuscaDescontoMax        (p_provisiona_valor_in.CdProduto
                                                                                                ,p_provisiona_valor_in.PcComissao
                                                                                                ,v_dt_inico_vigen
                                                                                                ,v_cd_erro
                                                                                                ,v_msg_erro);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[BuscaDescontoMax] - '||v_pc_maxmo_desct||' Produto: '||p_provisiona_valor_in.CdProduto||' Corretor: '||p_provisiona_valor_in.CdCorretor||' Incio de vigncia: '||v_dt_inico_vigen);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_provisiona_valor_out.StRetorno        :=      v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno       :=      '[Provisiona Valor] - '||v_msg_erro;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                        v_vl_maxmo_desct :=  CTACTPA0100_001.BuscaValorDescontoMaximo(v_sq_log
                                                                                     ,p_provisiona_valor_in.CdCorretor
                                                                                     ,p_provisiona_valor_in.PcComissao
                                                                                     ,v_VlPremioLiquido
                                                                                     ,v_pc_maxmo_desct);
                        --
                        IF      p_provisiona_valor_in.CdProcesso        NOT     IN      (1 , 2)    THEN
                              --
                              CTACTPA0100_001.GravaLog        (v_sq_log, '[Valor arredondamento] = ' || CTACTPA0100_001.retornaValorSomaDescontoAgravo(v_cd_segmt_prdut , v_sq_log));
                              --
                              v_vl_maxmo_desct  := Nvl(v_vl_maxmo_desct, 0) + CTACTPA0100_001.retornaValorSomaDescontoAgravo(v_cd_segmt_prdut , v_sq_log);
                              --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog (v_sq_log, '[Valor Mximo de Desconto] = ' || v_vl_maxmo_desct || ' Valor Prmio Lquido: ' || v_VlPremioLiquido || ' Percentual mximo de desconto: ' || v_pc_maxmo_desct);
                        --
                END     IF;
                --
                --      Busca agravo mximo
                --
                IF p_provisiona_valor_in.InAgravoDesconto = 'A' THEN
                        --
                        v_pc_agravo_desct := CTACTPA0100_001.BuscaAgravoMax(v_cd_segmt_prdut, v_dt_procm, v_cd_erro, v_msg_erro);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[BuscaAgravoMax] - ' || v_pc_agravo_desct || ' Segmento: ' || v_cd_segmt_prdut ||
                                                  ' Data: ' || v_dt_procm);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        v_vl_maxmo_agravo := Trunc(v_VlPremioLiquido * (v_pc_agravo_desct / 100), 2);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Valor Mximo de Agravo] = ' || v_vl_maxmo_agravo || ' Valor Prmio Lquido: ' ||
                                                  v_VlPremioLiquido || ' Percentual mximo de agravo: ' || v_pc_agravo_desct);
                        --
                        IF p_provisiona_valor_in.CdProcesso NOT IN (1, 2) THEN
                                v_vl_maxmo_agravo := Nvl(v_vl_maxmo_agravo, 0) +
                                                     CTACTPA0100_001.retornaValorSomaDescontoAgravo(v_cd_segmt_prdut, v_sq_log);
                        END IF;
                END IF;
                --
                --      Validaes o desconto informado
                --
                --      No validar desconto maximo para o processo 34 (VSP) pois ao confirmar a proposta ser
                --      feita uma nova proviso.
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (34) THEN
                        --
                        IF p_provisiona_valor_in.InAgravoDesconto = 'D' AND
                           v_VlAgravoDesconto > v_vl_maxmo_desct THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 28;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Desconto informado: ' || v_VlAgravoDesconto || ' superior ao desconto mximo permitido: ' || v_vl_maxmo_desct;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Verificando o agravo informado
                --
                IF p_provisiona_valor_in.InAgravoDesconto = 'A' AND
                   v_VlAgravoDesconto > v_vl_maxmo_agravo THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 29;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Agravo informado: ' || v_VlAgravoDesconto ||
                                                             ' superior ao agravo mximo permitido: ' || v_vl_maxmo_agravo;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validaes o desconto informado
                --
                --      No validar desconto superior ao saldo para o processo 34 (VSP) pois ao confirmar a proposta ser
                --      feita uma nova proviso.
                --
                --      Verificando o desconto disponvel
                --
                IF p_provisiona_valor_in.CdProcesso NOT IN (34) THEN
                        --
                        IF p_provisiona_valor_in.InAgravoDesconto = 'D' AND
                           v_VlAgravoDesconto > 0 AND
                           v_VlAgravoDesconto > v_vl_saldo_verba THEN
                                --
                                p_provisiona_valor_out.StRetorno  := 13;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Desconto informado: ' || v_VlAgravoDesconto ||
                                                                     ' superior ao saldo disponvel para o corretor: ' || v_vl_saldo_verba;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Separa verbas a serem utilizadas
                --
                SEPARA_VERBA_CORRETOR(P_PROVISIONA_VALOR_IN, V_CD_SEGMT_PRDUT, V_DT_PROCM);
                --
                --
                --      Validacao Duplicidade no tempo determinado.
                --
                IF NOT (IS_REGISTRO_LACTO_VALIDO(P_PROVISIONA_VALOR_IN)) THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 35;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Possivel registro em duplicidade.';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Estornando a proviso anterior
                --
                IF v_vl_lacto > 0 AND
                   p_provisiona_valor_in.CdProcesso NOT IN (29, 34, 39) THEN
                        --
                        --      Ajustando a situao do lanamento quando for acionado pelo KME
                        --                        
                        IF p_provisiona_valor_in.CdProcesso IN (62) THEN
                                --
                                AtualizaProvisaoPRO(v_CdContrato, v_CdItemContrato, p_provisiona_valor_in.CdUsuario, v_cd_erro, v_msg_erro);
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================' || Chr(10) ||
                                                  '[Valores da verba antes do Estorna_Provisao]' || Chr(10) ||
                                                  '=====================================================');
                        --
                        FOR r_verba_estorno IN verba_estorno(v_dt_procm) LOOP
                                --
                                v_id_verba_aux := r_verba_estorno.id_verba;
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '  id_verba...................: ' || r_verba_estorno.id_verba || Chr(10) ||
                                                          '  cd_segmt_prdut.............: ' || r_verba_estorno.cd_segmt_prdut_vb || Chr(10) ||
                                                          '  cd_crtor_segur.............: ' || r_verba_estorno.cd_crtor_segur_vb || Chr(10) ||
                                                          '  cd_asses...................: ' || r_verba_estorno.cd_asses_vb || Chr(10) ||
                                                          '  cd_tipo_verba..............: ' || r_verba_estorno.cd_tipo_verba_vb || Chr(10) ||
                                                          '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba_vb || Chr(10) ||
                                                          '  vl_prvsn_verba.............: ' || r_verba_estorno.vl_prvsn_verba_vb || Chr(10) ||
                                                          '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba_vb || Chr(10) ||
                                                          '  vl_crdto_verba.............: ' || r_verba_estorno.vl_crdto_verba_vb || Chr(10) ||
                                                          '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba_vb || Chr(10) ||
                                                          '  dt_inico_vigen.............: ' || r_verba_estorno.dt_inico_vigen_vb || Chr(10) ||
                                                          '  dt_fim_vigen...............: ' || r_verba_estorno.dt_fim_vigen_vb || Chr(10) ||
                                                          '  id_verba_origm_trnsf.......: ' || r_verba_estorno.id_verba_origm_trnsf_vb ||
                                                          Chr(10) || '  cd_usuro_ultma_alter.......: ' ||
                                                          r_verba_estorno.cd_usuro_ultma_alter_vb || Chr(10) ||
                                                          '  dt_ultma_alter.............: ' || r_verba_estorno.dt_ultma_alter_vb || Chr(10) ||
                                                          '  cd_situc_verba.............: ' || r_verba_estorno.cd_situc_verba_vb || Chr(10) ||
                                                          '  id_arquv_carga_verba.......: ' || r_verba_estorno.id_arquv_carga_verba_vb ||
                                                          Chr(10) || '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba ||
                                                          Chr(10) || '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba ||
                                                          Chr(10) || '  vl_crdit_agrvo.............: ' || r_verba_estorno.vl_crdit_agrvo ||
                                                          Chr(10) || '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba);
                                --
                        END LOOP;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================');
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Estorna_Provisao] Parmetros: ' || Chr(10) || 'SistemaChamador....... ' ||
                                                  p_provisiona_valor_in.SistemaChamador || Chr(10) || 'CdProduto............. ' ||
                                                  p_provisiona_valor_in.CdProduto || Chr(10) || 'CdCorretor............ ' ||
                                                  p_provisiona_valor_in.CdCorretor || Chr(10) || 'CdContrato............ ' || v_CdContrato ||
                                                  Chr(10) || 'CdItemContrato........ ' || v_CdItemContrato || Chr(10) ||
                                                  'InAgravoDesconto...... ' || p_provisiona_valor_in.InAgravoDesconto || Chr(10) ||
                                                  'VlAgravoDesconto...... ' || v_VlAgravoDesconto || Chr(10) || 'TpPessoa.............. ' ||
                                                  p_provisiona_valor_in.TpPessoa || Chr(10) || 'CPFCNPJCliente........ ' ||
                                                  p_provisiona_valor_in.CPFCNPJCliente || Chr(10) || 'CdUsuario............. ' || 'PROV_VAL' ||
                                                  Chr(10) || 'CdProcesso............ ' || 32 || Chr(10) || 'IdCorrelation......... ' ||
                                                  p_provisiona_valor_in.IdCorrelation);
                        --
                        v_estorna_provisao_in := estorna_provisao_in(p_provisiona_valor_in.SistemaChamador, p_provisiona_valor_in.CdProduto, p_provisiona_valor_in.CdCorretor, v_CdContrato, v_CdItemContrato, p_provisiona_valor_in.InAgravoDesconto, v_VlAgravoDesconto, p_provisiona_valor_in.TpPessoa, p_provisiona_valor_in.CPFCNPJCliente, 'PROV_VAL', 32, p_provisiona_valor_in.IdCorrelation);
                        --
                        BEGIN
                                --
                                CTACTPA0005_001.Estorna_Provisao(v_estorna_provisao_in, v_estorna_provisao_out);
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        p_provisiona_valor_out.StRetorno  := 31;
                                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Erro ao executar servio Estorna_Provisao: ' ||
                                                                             SQLERRM;
                                        --
                                        RAISE erro_fatal;
                                        --
                        END;
                        --
                        IF v_estorna_provisao_out.StRetorno <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_estorna_provisao_out.StRetorno;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_estorna_provisao_out.MsgRetorno;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                IF p_provisiona_valor_in.CdProcesso = 29 THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[AtualizaProvisaoLIB] - Negcio: ' || v_CdContrato || ' Item: ' || v_CdItemContrato);
                        --
                        AtualizaProvisaoLIB(v_CdContrato, v_CdItemContrato, p_provisiona_valor_in.CdUsuario, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        RAISE atualiza_provisao;
                        --
                END IF;
                --
                IF p_provisiona_valor_in.CdProcesso IN (34, 39) THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[AtualizaProvisaoPRO] - Negcio: ' || v_CdContrato || ' Item: ' || v_CdItemContrato);
                        --
                        AtualizaProvisaoPRO(v_CdContrato, v_CdItemContrato, p_provisiona_valor_in.CdUsuario, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        RAISE atualiza_provisao;
                        --
                END IF;
                --
                --
                --      Provisionando descontos
                --
                IF p_provisiona_valor_in.InAgravoDesconto = 'D' AND
                   v_VlAgravoDesconto > 0 THEN
                        --
                        IF p_provisiona_valor_in.CdProcesso IN (30, 31, 62) THEN
                                --
                                v_cd_situc_lacto := 'LIB';
                                --
                        ELSE
                                --
                                v_cd_situc_lacto := 'PRO';
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[v_cd_situc_lacto] = ' || v_cd_situc_lacto);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[ProvisionaDesconto]');
                        --
                        ProvisionaDesconto(v_cd_segmt_prdut, v_dt_procm, p_provisiona_valor_in, v_dt_inico_vigen, v_id_prdut, v_id_procs_criac, v_corretor, v_cd_situc_lacto, v_CdContrato, V_CdItemContrato, v_cd_erro, v_msg_erro, p_data_provsao_stder_in);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                --      Provisionando agravos
                --
                IF p_provisiona_valor_in.InAgravoDesconto = 'A' AND
                   v_VlAgravoDesconto > 0 THEN
                        --
                        IF p_provisiona_valor_in.CdProcesso IN (30, 31, 62) THEN
                                --
                                v_cd_situc_lacto := 'LIB';
                                --
                        ELSE
                                --
                                v_cd_situc_lacto := 'PRO';
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[v_cd_situc_lacto] = ' || v_cd_situc_lacto);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[ProvisionaAgravo]');
                        --
                        ProvisionaAgravo(p_provisiona_valor_in, v_cd_segmt_prdut, v_dt_procm, v_dt_inico_vigen, v_id_prdut, v_id_procs_criac, v_corretor, v_cd_situc_lacto, v_CdContrato, v_cdItemContrato, v_vl_agrav_s_comiss, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_provisiona_valor_out.StRetorno  := v_cd_erro;
                                p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                IF p_provisiona_valor_in.InAgravoDesconto = 'D' AND
                   v_VlAgravoDesconto > 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 0;
                        p_provisiona_valor_out.MsgRetorno := 'Desconto concedido e aprovado mediante emisso da aplice ( vista) ou confirmao do pagamento da primeira parcela (a prazo).';
                        --
                ELSIF p_provisiona_valor_in.InAgravoDesconto = 'A' AND
                      v_VlAgravoDesconto > 0 THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 0;
                        p_provisiona_valor_out.MsgRetorno := 'Agravo concedido  de R$ ' || TRIM(To_Char(v_VlAgravoDesconto, '9G999G999G999D99')) || ' e o crdito concedido  de R$ ' || TRIM(To_Char(v_vl_agrav_s_comiss, '9G999G999G999D99')) || '. Aprovado mediante emisso da aplice ( vista) ou confirmao do pagamento da primeira parcela (a prazo).'; --mediante emisso da aplice.';
                        --
                END IF;
                --
                IF p_provisiona_valor_in.CdProcesso IN (30, 31) AND
                   v_recepcao_achou_provisao = 'N' THEN
                        --
                        p_provisiona_valor_out.StRetorno  := 12;
                        p_provisiona_valor_out.MsgRetorno := '[Provisiona Valor] - Proviso no encontrada para o item: ' || v_CdItemContrato || ' negcio: ' || v_CdContrato;
                        --
                END IF;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================' || Chr(10) ||
                                          '[Valores da verba depois do Estorna_Provisao]' || Chr(10) ||
                                          '=====================================================');
                --
                FOR r_verba_estorno IN verba_estorno2(v_dt_procm, v_id_verba_aux) LOOP
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '  cd_segmt_prdut.............: ' || r_verba_estorno.cd_segmt_prdut_vb || Chr(10) ||
                                                  '  cd_crtor_segur.............: ' || r_verba_estorno.cd_crtor_segur_vb || Chr(10) ||
                                                  '  cd_asses...................: ' || r_verba_estorno.cd_asses_vb || Chr(10) ||
                                                  '  cd_tipo_verba..............: ' || r_verba_estorno.cd_tipo_verba_vb || Chr(10) ||
                                                  '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba_vb || Chr(10) ||
                                                  '  vl_prvsn_verba.............: ' || r_verba_estorno.vl_prvsn_verba_vb || Chr(10) ||
                                                  '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba_vb || Chr(10) ||
                                                  '  vl_crdto_verba_vb..........: ' || r_verba_estorno.vl_crdto_verba_vb || Chr(10) ||
                                                  '  vl_saldo_verba_vb..........: ' || r_verba_estorno.vl_saldo_verba_vb || Chr(10) ||
                                                  '  dt_inico_vigen_vb..........: ' || r_verba_estorno.dt_inico_vigen_vb || Chr(10) ||
                                                  '  dt_fim_vigen_vb............: ' || r_verba_estorno.dt_fim_vigen_vb || Chr(10) ||
                                                  '  id_verba_origm_trnsf_vb....: ' || r_verba_estorno.id_verba_origm_trnsf_vb || Chr(10) ||
                                                  '  cd_usuro_ultma_alter_vb....: ' || r_verba_estorno.cd_usuro_ultma_alter_vb || Chr(10) ||
                                                  '  dt_ultma_alter_vb..........: ' || r_verba_estorno.dt_ultma_alter_vb || Chr(10) ||
                                                  '  cd_situc_verba_vb..........: ' || r_verba_estorno.cd_situc_verba_vb || Chr(10) ||
                                                  '  id_arquv_carga_verba_vb....: ' || r_verba_estorno.id_arquv_carga_verba_vb || Chr(10) ||
                                                  '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba || Chr(10) ||
                                                  '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba || Chr(10) ||
                                                  '  vl_crdit_agrvo.............: ' || r_verba_estorno.vl_crdit_agrvo || Chr(10) ||
                                                  '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba);
                        --
                END LOOP;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================');
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de retorno]: ' || p_provisiona_valor_out.StRetorno || ' [Mensagem de retorno]: ' ||
                                          p_provisiona_valor_out.MsgRetorno || Chr(10) || LPad('=', 79, '=') || Chr(10) ||
                                          'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) ||
                                          LPad('=', 79, '='));
                --
                CTACTPA0100_001.FinalizaLog(v_sq_log);
                --
                COMMIT;
                --
        EXCEPTION
                --
                WHEN atualiza_provisao THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de retorno]: ' || p_provisiona_valor_out.StRetorno || ' [Mensagem de retorno]: ' ||
                                                  p_provisiona_valor_out.MsgRetorno || Chr(10) || LPad('=', 79, '=') || Chr(10) ||
                                                  'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) ||
                                                  LPad('=', 79, '='));
                        --
                        CTACTPA0100_001.FinalizaLog(v_sq_log);
                        --
                        COMMIT;
                        --
                        RETURN;
                        --
                WHEN erro_fatal THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de retorno]: ' || p_provisiona_valor_out.StRetorno || ' [Mensagem de retorno]: ' ||
                                                  p_provisiona_valor_out.MsgRetorno || Chr(10) || LPad('=', 79, '=') || Chr(10) ||
                                                  'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) ||
                                                  LPad('=', 79, '='));
                        --
                        CTACTPA0100_001.FinalizaLog(v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro Provisiona_Valor: ' || SQLERRM);
                        --
                        CTACTPA0100_001.FinalizaLog(v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_provisiona_valor_out.StRetorno  := 1;
                        p_provisiona_valor_out.MsgRetorno := SubStr('Erro Provisiona_Valor:' || ' (' || RETORNA_LINHA_ERRO || ') ' || SQLERRM || ' ' ||
                                                                    p_provisiona_valor_in.SistemaChamador || ' ' || p_provisiona_valor_in.CdProduto || ' ' ||
                                                                    p_provisiona_valor_in.CdCorretor || ' ' || v_CdContrato || ' ' ||
                                                                    v_CdItemContrato || ' ' || p_provisiona_valor_in.InAgravoDesconto || ' ' ||
                                                                    p_provisiona_valor_in.VlAgravoDesconto || ' ' || p_provisiona_valor_in.TpPessoa || ' ' ||
                                                                    p_provisiona_valor_in.CPFCNPJCliente || ' ' || p_provisiona_valor_in.NmCliente || ' ' ||
                                                                    p_provisiona_valor_in.VlPremioLiquido || ' ' || p_provisiona_valor_in.PcComissao || ' ' ||
                                                                    p_provisiona_valor_in.DtInicioVigencia || ' ' || p_provisiona_valor_in.CdUsuario || ' ' ||
                                                                    p_provisiona_valor_in.CdProcesso || ' ' || p_provisiona_valor_in.IdCorrelation, 1, 200);
                        --
        END Provisiona_Valor;

--
END CTACTPA0003_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0004_001 IS
        
        /* VERSAO V 9.0 */
        
        --
        v_VlAgravoDesconto      NUMBER(15,2);
        v_VlPremioLiquido       NUMBER(15,2);
        v_sq_log                NUMBER;
        --
        
        --
        --------------------------------------------------------------------------
        --      VerificaProvisaoItem:   Verifica se j existe proviso para o   --
        --                              item / negcio.                         --
        --                              Valida tambm se as informaes da      --
        --                              efetivao so iguais s do             --
        --                              provisionamento.                        --
        --------------------------------------------------------------------------
        --
        PROCEDURE       VerificaProvisaoItem    (p_efetiva_provisao_in  IN      efetiva_provisao_in
                                                ,p_dt_inico_vigen       IN      DATE
                                                ,p_id_prdut             IN      NUMBER
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        v_vl_lacto              cta0004_lacto.vl_lacto%TYPE;
        v_vl_agrvo_ppota        cta0004_lacto.vl_agrvo_ppota%TYPE;
        --
        CURSOR  c_provisao_item IS
                --
                SELECT  a.tp_pesoa,
                        a.nm_clien_sgrdo,
                        a.nr_cpf_cnpj_clien,
                        a.vl_prmio_liqui_ppota,
                        a.pc_comis_crtor,
                        a.dt_inico_vigen_segur,
                        a.id_prdut_sistm_origm,
                        a.tp_desct_agrvo,
                        a.id_corrl_bus
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_provisao_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_provisao_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_provisao_in.CdCorretor;
        --
        BEGIN
                --
                p_cd_erro       :=      0;
                p_msg_erro      :=      NULL;
                --
                --      Verifica se a soma existe proviso para o item
                --
                SELECT  Nvl(Sum(a.vl_lacto),0),
                        Nvl(Sum(a.vl_agrvo_ppota),0)
                INTO    v_vl_lacto,
                        v_vl_agrvo_ppota
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_provisao_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_provisao_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_provisao_in.CdCorretor;
                --
                --      Se no encontrar a proviso, o programa chamador deve
                --      abortar o processo
                --
                IF      v_vl_lacto      =       0       THEN
                        --
                        p_cd_erro       :=      42;
                        p_msg_erro      :=      'No existe proviso para o item: '||p_efetiva_provisao_in.CdItemContrato||' e negcio: '||p_efetiva_provisao_in.CdContrato;
                        --
                        RETURN;
                        --
                ELSE
                        --
                        IF      p_efetiva_provisao_in.InAgravoDesconto  =       'D'     THEN
                                --

                                CTACTPA0100_001.GravaLog        (v_sq_log, 'Tipo Agravo / Desconto : D ');

                                 CTACTPA0100_001.GravaLog        (v_sq_log, '[v_vl_lacto] ' || v_vl_lacto);
                                 CTACTPA0100_001.GravaLog        (v_sq_log, '[v_VlAgravoDesconto] ' || v_VlAgravoDesconto);


                                IF      ( v_vl_lacto      <>      v_VlAgravoDesconto  )  THEN
                                        --
                                        p_cd_erro       :=      43;
                                        p_msg_erro      :=      'Informao de valor do lanamento: '||v_VlAgravoDesconto||' divergente do valor provisionado: '||v_vl_lacto;
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        ELSIF      p_efetiva_provisao_in.InAgravoDesconto  =       'A'     THEN

                                CTACTPA0100_001.GravaLog        (v_sq_log, 'Tipo Agravo / Desconto : A ');

                                --
                                IF      ( v_vl_agrvo_ppota        <>      v_VlAgravoDesconto )    THEN



                                        --
                                        p_cd_erro       :=      43;
                                        p_msg_erro      :=      'Informao de valor do Agravo: '||v_VlAgravoDesconto||' divergente do valor provisionado: '||v_vl_agrvo_ppota;
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Para cada item encontrado no cursor, realizar
                --      validao das informaes.
                --      Caso alguma informao esteja divergente, deve abortar.
                --
                FOR     r_provisao_item IN      c_provisao_item LOOP
                        --
                        IF      r_provisao_item.tp_pesoa        <>      p_efetiva_provisao_in.TpPessoa  THEN
                                --
                                p_cd_erro       :=      44;
                                p_msg_erro      :=      'Tipo de pessoa da efetivao: '||p_efetiva_provisao_in.TpPessoa||' divergente do tipo de pessoa provisionado: '||r_provisao_item.tp_pesoa;
                                --
                                RETURN;
                                --
                        /*ELSIF   r_provisao_item.nm_clien_sgrdo        <>      p_efetiva_provisao_in.NmCliente  THEN
                                --
                                p_cd_erro       :=      45;
                                p_msg_erro      :=      'Nome do segurado da efetivao: '||p_efetiva_provisao_in.NmCliente||' divergente do nome do segurado provisionado: '||r_provisao_item.nm_clien_sgrdo;
                                --
                                RETURN; */
                                --
                        ELSIF   r_provisao_item.nr_cpf_cnpj_clien        <>      p_efetiva_provisao_in.CPFCNPJCliente      THEN
                                --
                                p_cd_erro       :=      46;
                                p_msg_erro      :=      'Nmero do CPF/CNPJ da efetivao: '||p_efetiva_provisao_in.CPFCNPJCliente||' divergente do CPF/CNPJ provisionado: '||r_provisao_item.nr_cpf_cnpj_clien;
                                --
                                RETURN;
                                --
                        ELSIF   (r_provisao_item.vl_prmio_liqui_ppota        <>      v_VlPremioLiquido) AND NOT CTACTPA0100_001.validaValorProvisionadoMaior( p_id_prdut
                                                                                                                                ,r_provisao_item.vl_prmio_liqui_ppota
                                                                                                                                ,v_VlPremioLiquido
                                                                                                                                ,v_sq_log )      THEN
                                --
                                p_cd_erro       :=      47;
                                p_msg_erro      :=      'Valor do prmio lquido da efetivao: '||v_VlPremioLiquido||' divergente do prmio lquido provisionado: '||r_provisao_item.vl_prmio_liqui_ppota;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.pc_comis_crtor        <>      p_efetiva_provisao_in.PcComissao      THEN
                                --
                                p_cd_erro       :=      48;
                                p_msg_erro      :=      'Percentual de comisso da efetivao: '||p_efetiva_provisao_in.PcComissao||' divergente do percentual de comisso provisionado: '||r_provisao_item.pc_comis_crtor;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.dt_inico_vigen_segur    <>      p_dt_inico_vigen        THEN
                                --
                                p_cd_erro       :=      49;
                                p_msg_erro      :=      'Data de incio de vigncia da efetivao: '||To_Char(p_dt_inico_vigen,    'DD/MM/YYYY')||' divergente do incio de vigncia provisionado: '||To_Char(r_provisao_item.dt_inico_vigen_segur,   'DD/MM/YYYY');
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.id_prdut_sistm_origm    <>      p_id_prdut      THEN
                                --
                                p_cd_erro       :=      50;
                                p_msg_erro      :=      'Mdulo Produto da efetivao: '||p_efetiva_provisao_in.CdProduto||' divergente do Mdulo Produto provisionado: '||r_provisao_item.id_prdut_sistm_origm;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.tp_desct_agrvo        <>      p_efetiva_provisao_in.InAgravoDesconto      THEN
                                --
                                p_cd_erro       :=      51;
                                p_msg_erro      :=      'Indicador de desconto agravo da efetivao: '||p_efetiva_provisao_in.InAgravoDesconto||' divergente do indicador de desconto agravo provisionado: '||r_provisao_item.tp_desct_agrvo;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      21;
                        p_msg_erro      :=      'Erro VerificaProvisaoItem - Negcio: '||p_efetiva_provisao_in.CdContrato||' Item: '||p_efetiva_provisao_in.CdItemContrato||' Corretor: '||p_efetiva_provisao_in.CdCorretor||' '||SQLERRM;
                        --
                        RETURN;
                        --
        END     VerificaProvisaoItem;
        --
        --------------------------------------------------------------------------
        --      BaixaLancamentoProvisao:        Realiza a baixa do lancamento   --
        --                                      da provisao.                    --
        --------------------------------------------------------------------------
        --
        PROCEDURE       BaixaLancamentoProvisao (p_efetiva_provisao_in  IN      efetiva_provisao_in
                                                ,p_id_procs_criac       IN      NUMBER
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        CURSOR  c_provisao_item IS
                --
                SELECT  a.tp_pesoa,
                        a.id_lacto,
                        a.id_verba,
                        a.vl_lacto,
                        a.nm_clien_sgrdo,
                        a.nr_cpf_cnpj_clien,
                        a.vl_prmio_liqui_ppota,
                        a.pc_comis_crtor,
                        a.dt_inico_vigen_segur,
                        a.id_prdut_sistm_origm,
                        a.tp_desct_agrvo,
                        b.cd_crtor_segur,
                        a.vl_agrvo_ppota,
                        b.vl_saldo_verba,
                        a.cd_asses_atual_crtor,
                        a.cd_diret_comrl,
                        a.cd_sucsl_comrl,
                        a.id_procs_criac,
                        a.cd_tipo_lacto,
                        a.cd_ctrat,
                        a.cd_item_ctrat
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_provisao_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_provisao_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_provisao_in.CdCorretor
                FOR     UPDATE;
        --
        v_cd_suscl_comrl        cta0012_crtor.cd_sucsl_comrl%TYPE;
        v_cd_diret_comrl        cta0012_crtor.cd_diret_comrl%TYPE;
        v_cd_asses              cta0012_crtor.cd_asses%TYPE;
        --
        v_vl_lacto_s_comis      NUMBER;
        vl_saldo_verba_depois   NUMBER;
        vl_saldo_verba_antes    NUMBER;
        v_id_lacto              NUMBER;
        --
        BEGIN
                --
                p_cd_erro       :=      0;
                p_msg_erro      :=      NULL;
                --
                FOR     r_provisao_item IN      c_provisao_item LOOP
                        --
                        --      Selecionando o corretor do lanamento
                        --
                        BEGIN
                                --
                                SELECT  cd_sucsl_comrl,
                                        cd_diret_comrl,
                                        cd_asses
                                INTO    v_cd_suscl_comrl,
                                        v_cd_diret_comrl,
                                        v_cd_asses
                                FROM    cta0012_crtor
                                WHERE   cd_crtor_segur  =       r_provisao_item.cd_crtor_segur;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      54;
                                        p_msg_erro      :=      'Erro ao buscar corretor do lanamento: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --      Atualizando o lanamento
                        --
                        IF      p_efetiva_provisao_in.InAgravoDesconto  =       'D'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0004_lacto
                                        SET     cd_situc_lacto          =       'EFT',
                                                id_procs_alter          =       p_id_procs_criac,
                                                cd_usuro_ultma_alter    =       p_efetiva_provisao_in.CdUsuario,
                                                dt_ultma_alter          =       SYSDATE,
                                                cd_sucsl_comrl          =       v_cd_suscl_comrl,
                                                cd_diret_comrl          =       v_cd_diret_comrl,
                                                cd_asses_atual_crtor    =       v_cd_asses
                                        WHERE   id_lacto                =       r_provisao_item.id_lacto;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      53;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de lanamentos: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSIF   p_efetiva_provisao_in.InAgravoDesconto  =       'A'     THEN
                                --
                                v_vl_lacto_s_comis      :=      (v_VlAgravoDesconto     *       (1      -       (p_efetiva_provisao_in.PcComissao/100)));
                                --
                                vl_saldo_verba_antes    :=      r_provisao_item.vl_saldo_verba;
                                --
                                vl_saldo_verba_depois   :=      r_provisao_item.vl_saldo_verba  +       v_vl_lacto_s_comis;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[v_VlAgravoDesconto] '||v_VlAgravoDesconto||' [p_efetiva_provisao_in.PcComissao] '||p_efetiva_provisao_in.PcComissao);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Valor do lanamento sem comisso]: '||v_vl_lacto_s_comis);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Saldo da verba antes]: '||vl_saldo_verba_antes);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Saldo da verba depois]: '||vl_saldo_verba_depois);
                                --
                                --      Cria novo registro de lanamento
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      35;
                                                p_msg_erro      :=      'Erro ao selecionar sequencia ctasq0004_lacto: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        ctactpa0100_001.GravaLog        (v_sq_log
                                                                        ,'[Criando lanamento] '||v_id_lacto);
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,id_corrl_bus
                                                                        ,id_prdut_sistm_origm
                                                                        ,tp_desct_agrvo
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_asses_atual_crtor
                                                                        ,ic_prmra_prazo)
                                                                        --
                                                                VALUES  (v_id_lacto
                                                                        ,r_provisao_item.id_verba
                                                                        ,'EFT'
                                                                        ,r_provisao_item.cd_ctrat
                                                                        ,r_provisao_item.cd_item_ctrat
                                                                        ,r_provisao_item.cd_tipo_lacto
                                                                        ,SYSDATE
                                                                        ,vl_saldo_verba_antes
                                                                        ,v_vl_lacto_s_comis
                                                                        ,v_VlAgravoDesconto
                                                                        ,vl_saldo_verba_depois
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,r_provisao_item.tp_pesoa
                                                                        ,r_provisao_item.nm_clien_sgrdo
                                                                        ,r_provisao_item.nr_cpf_cnpj_clien
                                                                        ,r_provisao_item.vl_prmio_liqui_ppota
                                                                        ,r_provisao_item.pc_comis_crtor
                                                                        ,r_provisao_item.dt_inico_vigen_segur
                                                                        ,p_id_procs_criac
                                                                        ,p_efetiva_provisao_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,p_efetiva_provisao_in.IdCorrelation
                                                                        ,r_provisao_item.id_prdut_sistm_origm
                                                                        ,r_provisao_item.tp_desct_agrvo
                                                                        ,r_provisao_item.cd_sucsl_comrl
                                                                        ,r_provisao_item.cd_diret_comrl
                                                                        ,r_provisao_item.cd_asses_atual_crtor
                                                                        ,p_efetiva_provisao_in.IcPrmraPrazo);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      35;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Atualiza o lanamento atual para AGB
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0004_lacto
                                        SET     cd_situc_lacto          =       'AGB',
                                                id_procs_alter          =       p_id_procs_criac,
                                                cd_usuro_ultma_alter    =       p_efetiva_provisao_in.CdUsuario,
                                                dt_ultma_alter          =       SYSDATE,
                                                cd_sucsl_comrl          =       v_cd_suscl_comrl,
                                                cd_diret_comrl          =       v_cd_diret_comrl,
                                                cd_asses_atual_crtor    =       v_cd_asses,
                                                id_lacto_estor          =       v_id_lacto
                                        WHERE   id_lacto                =       r_provisao_item.id_lacto;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      53;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de lanamentos: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END     IF;
                        --
                        --      Atualizar saldo da verba
                        --
                        IF      p_efetiva_provisao_in.InAgravoDesconto  =       'D'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0002_verba
                                        SET     vl_prvsn_verba  =       Nvl(vl_prvsn_verba,0)   -       v_VlAgravoDesconto,
                                                vl_eftdo_verba  =       Nvl(vl_eftdo_verba,0)   +       v_VlAgravoDesconto
                                        WHERE   id_verba        =       r_provisao_item.id_verba;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      54;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de verbas [desconto]: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSIF   p_efetiva_provisao_in.InAgravoDesconto  =       'A'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0002_verba
                                        SET     vl_saldo_verba  =       vl_saldo_verba_depois,
                                                vl_crdit_agrvo  =       Nvl(vl_crdit_agrvo,0)   -       Nvl(v_vl_lacto_s_comis,0),
                                                vl_crdto_verba  =       Nvl(vl_crdto_verba,0)   +       Nvl(v_vl_lacto_s_comis,0) --Nvl(vl_crdit_agrvo,0)   -       v_vl_lacto_s_comis
                                        WHERE   id_verba        =       r_provisao_item.id_verba;
                                        --

                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      54;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de verbas [agravo]: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      52;
                        p_msg_erro      :=      'Erro ao lanar baixa da proviso: '||SQLERRM;
                        --
        END     BaixaLancamentoProvisao;
        --
        --------------------------------------------------------------------------
        --      AtualizaIcPrmraPrazo:   Atualiza o indicador de primeira a      --
        --                              prazo para todos os lanamentos do      --
        --                              negcio.                                --
        --------------------------------------------------------------------------
        --
        PROCEDURE       AtualizaIcPrmraPrazo    (p_CdContrato           IN      NUMBER
                                                ,p_IcPrmraPrazo         IN      VARCHAR2
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        BEGIN
                --
                UPDATE  cta0004_lacto
                SET     ic_prmra_prazo  =       p_IcPrmraPrazo
                WHERE   cd_ctrat        =       p_CdContrato
                AND     ic_prmra_prazo  IS      NULL
                AND     cd_situc_lacto  NOT     IN      ('CAN', 'EST');
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro AtualizaIcPrmraPrazo; '||SQLERRM;
                        --
        END     AtualizaIcPrmraPrazo;
        --
        --------------------------------------------------------------------------
        --      Efetiva_Provisao:       Efetuar a efetivao de uma proviso    --
        --                              feita anteriormente. Esse servio deve  --
        --                              ser chamado somente quando a aplice   --
        --                              efetivamente emitida. No SSV ser       --
        --                              quando o status do negcio mudar para   --
        --                              'APO' (aplice).                        --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Efetiva_Provisao        (p_efetiva_provisao_in  IN      efetiva_provisao_in
                                                ,p_efetiva_provisao_out OUT     efetiva_provisao_out)   IS
        --
        v_dt_procm              DATE;
        v_dt_inico_vigen        DATE;
        v_cd_erro               NUMBER;
        v_id_prdut              NUMBER;
        v_cd_segmt_prdut        NUMBER;
        v_vl_provisao           NUMBER;
        v_id_procs_criac        NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_efetiva_provisao_out  :=      efetiva_provisao_out    (0
                                                                        ,NULL);
                --
                --      Verificando se deve debugar o item / cpf
                --
                v_VlPremioLiquido       :=      Round(p_efetiva_provisao_in.VlPremioLiquido,    2);
                v_VlAgravoDesconto      :=      Round(p_efetiva_provisao_in.VlAgravoDesconto,   2);
                --
                CTACTPA0100_001.IniciaLog       (41
                                                ,p_efetiva_provisao_in.SistemaChamador
                                                ,p_efetiva_provisao_in.CdCorretor
                                                ,NULL
                                                ,p_efetiva_provisao_in.CdContrato
                                                ,p_efetiva_provisao_in.CdItemContrato
                                                ,p_efetiva_provisao_in.TpPessoa
                                                ,p_efetiva_provisao_in.CPFCNPJCliente
                                                ,p_efetiva_provisao_in.NmCliente
                                                ,p_efetiva_provisao_in.CdUsuario
                                                ,p_efetiva_provisao_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog   (v_sq_log
                                           ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                            'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                            LPad('=',      79,     '=')                                                    ||Chr(10)||
                                            'Servio Efetiva_Provisao. Parmetros de entrada: '                           ||Chr(10)||
                                            'NmCliente.............. '||p_efetiva_provisao_in.NmCliente                   ||Chr(10)||
                                            'CdProcesso............. '||p_efetiva_provisao_in.CdProcesso                  ||Chr(10)||
                                            'CdCorretor............. '||p_efetiva_provisao_in.CdCorretor                  ||Chr(10)||
                                            'IdCorrelation.......... '||p_efetiva_provisao_in.IdCorrelation               ||Chr(10)||
                                            'TpPessoa............... '||p_efetiva_provisao_in.TpPessoa                    ||Chr(10)||
                                            'VlPremioLiquido........ '||p_efetiva_provisao_in.VlPremioLiquido             ||Chr(10)||
                                            'v_VlPremioLiquido...... '||v_VlPremioLiquido                                 ||Chr(10)||
                                            'CPFCNPJCliente......... '||p_efetiva_provisao_in.CPFCNPJCliente              ||Chr(10)||
                                            'CdUsuario.............. '||p_efetiva_provisao_in.CdUsuario                   ||Chr(10)||
                                            'SistemaChamador........ '||p_efetiva_provisao_in.SistemaChamador             ||Chr(10)||
                                            'CdContrato............. '||p_efetiva_provisao_in.CdContrato                  ||Chr(10)||
                                            'DtInicioVigencia....... '||p_efetiva_provisao_in.DtInicioVigencia            ||Chr(10)||
                                            'IcPrmraPrazo........... '||p_efetiva_provisao_in.IcPrmraPrazo                ||Chr(10)||
                                            'CdProduto.............. '||p_efetiva_provisao_in.CdProduto                   ||Chr(10)||
                                            'PcComissao............. '||p_efetiva_provisao_in.PcComissao                  ||Chr(10)||
                                            'InAgravoDesconto....... '||p_efetiva_provisao_in.InAgravoDesconto            ||Chr(10)||
                                            'VlAgravoDesconto....... '||p_efetiva_provisao_in.VlAgravoDesconto            ||Chr(10)||
                                            'CdItemContrato......... '||p_efetiva_provisao_in.CdItemContrato              ||Chr(10)||
                                            'v_VlAgravoDesconto..... '||v_VlAgravoDesconto                                ||Chr(10)||
                                            'Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')       ||Chr(10)||
                                            LPad('=',       79,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_efetiva_provisao_in.SistemaChamador))        THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      2;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Sistema chamador invlido: '||p_efetiva_provisao_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_efetiva_provisao_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de negcio
                --
                IF      p_efetiva_provisao_in.CdContrato           IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      15;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Nmero de negcio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de item
                --
                IF      p_efetiva_provisao_in.CdItemContrato      IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      16;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Nmero de item est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando indicador de agravo / desconto
                --
                IF      Nvl(p_efetiva_provisao_in.InAgravoDesconto,     'X')    NOT     IN      ('A',   'D')    THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      24;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - Indicador de desconto / agravo invlido: '||Nvl(p_efetiva_provisao_in.InAgravoDesconto, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida para NO PERMITIR proviso de agravo para corretor bloqueado.
                --
                IF NOT
                    (CTACTPA0100_001.IsPermiteAgravoCorretor(p_efetiva_provisao_in.CdCorretor
                                                            ,p_efetiva_provisao_in.InAgravoDesconto
                                                            ,v_cd_erro
                                                            ,v_msg_erro)) THEN
                        --
                        p_efetiva_provisao_out.StRetorno  := 27;
                        p_efetiva_provisao_out.MsgRetorno := '[Efetiva Proviso] - No permitido Agravo para o corretor: ' || p_efetiva_provisao_in.CdCorretor || ' [' || v_sq_log || '] ';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                --      Validando valor de agravo / desconto
                --
                IF      v_VlAgravoDesconto      IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      25;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - Valor de agravo / desconto est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de pessoa
                --
                IF      Nvl(p_efetiva_provisao_in.TpPessoa,       'X')    NOT     IN      ('F',   'J')    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      8;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Tipo de pessoa invlido: '||Nvl(p_efetiva_provisao_in.TpPessoa, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF / CNPJ do cliente
                --
                IF      p_efetiva_provisao_in.CPFCNPJCliente      IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      9;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - CPF / CNPJ est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      p_efetiva_provisao_in.TpPessoa  =       'F'
                        AND     NOT(tms_util.valida_cpf(LPad(p_efetiva_provisao_in.CPFCNPJCliente,11,'0')))  THEN
                                --
                                p_efetiva_provisao_out.StRetorno        :=      9;
                                p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - CPF invlido: '||p_efetiva_provisao_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        ELSIF   p_efetiva_provisao_in.TpPessoa  =       'J'
                        AND     NOT(tms_util.valida_cnpj(LPad(p_efetiva_provisao_in.CPFCNPJCliente,14,'0'))) THEN
                                --
                                p_efetiva_provisao_out.StRetorno        :=      9;
                                p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - CNPJ invlido: '||p_efetiva_provisao_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando nome do cliente
                --
                IF      p_efetiva_provisao_in.NmCliente         IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      26;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - Nome de cliente est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valor Prmio Lquido
                --
                IF      v_VlPremioLiquido       IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      5;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Valor do prmio lquido est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando percentual de comisso
                --
                IF      p_efetiva_provisao_in.Pccomissao          IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      6;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Percentual de comisso est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando incio de vigncia
                --
                IF      p_efetiva_provisao_in.DtInicioVigencia    IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      7;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Data de incio de vigncia est nula';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsDataValida  (p_efetiva_provisao_in.DtInicioVigencia
                                                                ,v_dt_inico_vigen))     THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      7;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Data de incio de vigncia invlida: '||p_efetiva_provisao_in.DtInicioVigencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_efetiva_provisao_in.CdUsuario           IS      NULL    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      10;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_efetiva_provisao_in.CdProcesso,   0)      NOT     IN      (5, 63)     THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      11;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Cdigo de processo invlido: '||p_efetiva_provisao_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o indicador de primeira a prazo
                --
                IF      Nvl(p_efetiva_provisao_in.IcPrmraPrazo, 'X')    NOT     IN      ('S',   'N')    THEN
                        --
                        p_efetiva_provisao_out.StRetorno  :=      110;
                        p_efetiva_provisao_out.MsgRetorno :=      '[Efetiva Proviso] - Indicador de primeira parcela a prazo invlido: '||p_efetiva_provisao_in.IcPrmraPrazo;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log, '[RetornaDtProcm] - '||v_dt_procm);
                --
                --      Busca segmento do produto
                --
                v_cd_segmt_prdut        :=      CTACTPA0100_001.RetornaSegmentoProduto  (p_efetiva_provisao_in.SistemaChamador
                                                                                        ,p_efetiva_provisao_in.CdProduto
                                                                                        ,v_dt_procm
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaSegmentoProduto] - '||v_cd_segmt_prdut||' Sistema Chamador: '||p_efetiva_provisao_in.SistemaChamador||' Produto: '||p_efetiva_provisao_in.CdProduto||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o mdulo produto
                --
                v_id_prdut      :=      CTACTPA0100_001.ModuloProdutoValido     (p_efetiva_provisao_in.CdProduto
                                                                                ,p_efetiva_provisao_in.SistemaChamador
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ModuloProdutoValido] - '||v_id_prdut||' Produto: '||p_efetiva_provisao_in.CdProduto||' Sistema Chamador: '||p_efetiva_provisao_in.SistemaChamador||' Segmento: '||v_cd_segmt_prdut||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_efetiva_provisao_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log, '[ValidaCdProcesso] - '||v_id_procs_criac||' Processo: '||p_efetiva_provisao_in.CdProcesso);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Verifica se existe proviso para o item
                --
                VerificaProvisaoItem    (p_efetiva_provisao_in
                                        ,v_dt_inico_vigen
                                        ,v_id_prdut
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[VerificaProvisaoItem] - Incio de vigncia: '||v_dt_inico_vigen);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      OS 10105:       Primeira parcela a prazo.
                --
                --                      Atualizando a informao de primeira
                --                      parcela a prazo.
                --
                AtualizaIcPrmraPrazo    (p_efetiva_provisao_in.CdContrato
                                        ,p_efetiva_provisao_in.IcPrmraPrazo
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --                      S executar a procedure
                --                      BaixaLancamentoProvisao se o indicador
                --                      de primeira a prazo for igual a 'N'.
                --
                IF      ((p_efetiva_provisao_in.IcPrmraPrazo            =       'N')    OR
                         (p_efetiva_provisao_in.IcPrmraPrazo            =       'S'     AND
                          p_efetiva_provisao_in.InAgravoDesconto        <>      'A'))   THEN
                        --
                        --      Dar baixa no lanamento de proviso
                        --
                        BaixaLancamentoProvisao (p_efetiva_provisao_in
                                                ,v_id_procs_criac
                                                ,v_cd_erro
                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_efetiva_provisao_out.StRetorno        :=      v_cd_erro;
                                p_efetiva_provisao_out.MsgRetorno       :=      '[Efetiva Proviso] - '||v_msg_erro;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Cdigo de Retorno: '||p_efetiva_provisao_out.StRetorno||' - Mensagem: '||p_efetiva_provisao_out.MsgRetorno||']');
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                 'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                 LPad('=',      79,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
                COMMIT;
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_efetiva_provisao_out.StRetorno||' - Mensagem: '||p_efetiva_provisao_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      79,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Efetiva_Provisao: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      79,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      79,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_efetiva_provisao_out.StRetorno        :=      1;
                        p_efetiva_provisao_out.MsgRetorno       :=      'Erro Efetiva_Provisao: '               ||' '||
                                                                        p_efetiva_provisao_in.SistemaChamador   ||' '||
                                                                        p_efetiva_provisao_in.CdProduto         ||' '||
                                                                        p_efetiva_provisao_in.CdCorretor        ||' '||
                                                                        p_efetiva_provisao_in.CdContrato        ||' '||
                                                                        p_efetiva_provisao_in.CdItemContrato    ||' '||
                                                                        p_efetiva_provisao_in.InAgravoDesconto  ||' '||
                                                                        p_efetiva_provisao_in.VlAgravoDesconto  ||' '||
                                                                        p_efetiva_provisao_in.TpPessoa          ||' '||
                                                                        p_efetiva_provisao_in.CPFCNPJCliente    ||' '||
                                                                        p_efetiva_provisao_in.NmCliente         ||' '||
                                                                        p_efetiva_provisao_in.VlPremioLiquido   ||' '||
                                                                        p_efetiva_provisao_in.PcComissao        ||' '||
                                                                        p_efetiva_provisao_in.DtInicioVigencia  ||' '||
                                                                        p_efetiva_provisao_in.CdUsuario         ||' '||
                                                                        p_efetiva_provisao_in.CdProcesso        ||' '||
                                                                        p_efetiva_provisao_in.IdCorrelation     ||' '||
                                                                        SQLERRM;
                        --
        END     Efetiva_Provisao;
        --
END     CTACTPA0004_001;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0005_001 IS

        /* VERSAO V 9.0 */

        --
        v_sq_log NUMBER;

        --
        CURSOR c_estorna_item(p_cd_contrato      IN NUMBER
                             ,p_cd_item_contrato IN NUMBER
                             ,p_dt_procs         IN DATE) IS
        --
                SELECT a.id_lacto
                      ,a.id_verba
                      ,a.cd_situc_lacto
                      ,a.cd_ctrat
                      ,a.cd_item_ctrat
                      ,a.cd_tipo_lacto
                      ,a.dt_lacto
                      ,a.vl_saldo_verba_anter
                      ,a.vl_lacto
                      ,a.vl_agrvo_ppota
                      ,a.vl_saldo_verba_postr
                      ,a.id_lacto_origm_trnsf
                      ,a.id_lacto_estor
                      ,a.tp_pesoa
                      ,a.nm_clien_sgrdo
                      ,a.nr_cpf_cnpj_clien
                      ,a.vl_prmio_liqui_ppota
                      ,a.pc_comis_crtor
                      ,a.dt_inico_vigen_segur
                      ,a.id_procs_criac
                      ,a.cd_usuro_criac
                      ,a.dt_criac
                      ,a.id_procs_alter
                      ,a.cd_usuro_ultma_alter
                      ,a.dt_ultma_alter
                      ,a.id_corrl_bus
                      ,a.id_prdut_sistm_origm
                      ,a.tp_desct_agrvo
                      ,b.dt_fim_vigen - p_dt_procs qt_dias_verba_a_vencer
                      ,b.cd_segmt_prdut cd_segmt_prdut_vb
                      ,b.cd_crtor_segur cd_crtor_segur_vb
                      ,b.cd_asses cd_asses_vb
                      ,b.cd_tipo_verba cd_tipo_verba_vb
                      ,b.vl_inicl_verba vl_inicl_verba_vb
                      ,b.vl_prvsn_verba vl_prvsn_verba_vb
                      ,b.vl_eftdo_verba vl_eftdo_verba_vb
                      ,b.vl_crdto_verba vl_crdto_verba_vb
                      ,b.vl_saldo_verba vl_saldo_verba_vb
                      ,b.dt_inico_vigen dt_inico_vigen_vb
                      ,b.dt_fim_vigen dt_fim_vigen_vb
                      ,b.id_verba_origm_trnsf id_verba_origm_trnsf_vb
                      ,b.cd_usuro_ultma_alter cd_usuro_ultma_alter_vb
                      ,b.dt_ultma_alter dt_ultma_alter_vb
                      ,b.cd_situc_verba cd_situc_verba_vb
                      ,b.id_arquv_carga_verba id_arquv_carga_verba_vb
                      ,b.vl_eftdo_verba
                      ,b.vl_saldo_verba
                      ,b.vl_crdit_agrvo
                      ,b.vl_inicl_verba
                FROM   cta0004_lacto a
                      ,cta0002_verba b
                WHERE  a.cd_ctrat = p_cd_contrato
                AND    a.cd_item_ctrat = Nvl(p_cd_item_contrato, a.cd_item_ctrat)
                AND    a.cd_situc_lacto NOT IN ('CAN', 'AGB', 'END')
                AND    a.id_lacto_estor IS NULL
                AND    a.id_verba = b.id_verba;

        --
        CURSOR verba_estorno(p_cd_contrato      IN NUMBER
                            ,p_cd_item_contrato IN NUMBER
                            ,p_dt_procs         IN DATE) IS
        --
                SELECT a.id_lacto
                      ,a.id_verba
                      ,a.cd_situc_lacto
                      ,a.cd_ctrat
                      ,a.cd_item_ctrat
                      ,a.cd_tipo_lacto
                      ,a.dt_lacto
                      ,a.vl_saldo_verba_anter
                      ,a.vl_lacto
                      ,a.vl_agrvo_ppota
                      ,a.vl_saldo_verba_postr
                      ,a.id_lacto_origm_trnsf
                      ,a.id_lacto_estor
                      ,a.tp_pesoa
                      ,a.nm_clien_sgrdo
                      ,a.nr_cpf_cnpj_clien
                      ,a.vl_prmio_liqui_ppota
                      ,a.pc_comis_crtor
                      ,a.dt_inico_vigen_segur
                      ,a.id_procs_criac
                      ,a.cd_usuro_criac
                      ,a.dt_criac
                      ,a.id_procs_alter
                      ,a.cd_usuro_ultma_alter
                      ,a.dt_ultma_alter
                      ,a.id_corrl_bus
                      ,a.id_prdut_sistm_origm
                      ,a.tp_desct_agrvo
                      ,b.dt_fim_vigen - p_dt_procs qt_dias_verba_a_vencer
                      ,b.cd_segmt_prdut cd_segmt_prdut_vb
                      ,b.cd_crtor_segur cd_crtor_segur_vb
                      ,b.cd_asses cd_asses_vb
                      ,b.cd_tipo_verba cd_tipo_verba_vb
                      ,b.vl_inicl_verba vl_inicl_verba_vb
                      ,b.vl_prvsn_verba vl_prvsn_verba_vb
                      ,b.vl_eftdo_verba vl_eftdo_verba_vb
                      ,b.vl_crdto_verba vl_crdto_verba_vb
                      ,b.vl_saldo_verba vl_saldo_verba_vb
                      ,b.dt_inico_vigen dt_inico_vigen_vb
                      ,b.dt_fim_vigen dt_fim_vigen_vb
                      ,b.id_verba_origm_trnsf id_verba_origm_trnsf_vb
                      ,b.cd_usuro_ultma_alter cd_usuro_ultma_alter_vb
                      ,b.dt_ultma_alter dt_ultma_alter_vb
                      ,b.cd_situc_verba cd_situc_verba_vb
                      ,b.id_arquv_carga_verba id_arquv_carga_verba_vb
                      ,b.vl_eftdo_verba
                      ,b.vl_saldo_verba
                      ,b.vl_crdit_agrvo
                      ,b.vl_inicl_verba
                FROM   cta0004_lacto a
                      ,cta0002_verba b
                WHERE  a.cd_ctrat = p_cd_contrato
                AND    a.cd_item_ctrat = Nvl(p_cd_item_contrato, a.cd_item_ctrat)
                AND    a.cd_situc_lacto NOT IN ('CAN', 'AGB', 'END')
                AND    a.id_lacto_estor IS NULL
                AND    a.id_verba = b.id_verba;

        --
        CURSOR verba_estorno2(p_dt_procs IN DATE
                             ,p_id_verba IN NUMBER) IS
        --
                SELECT b.id_verba
                      ,b.dt_fim_vigen - p_dt_procs qt_dias_verba_a_vencer
                      ,b.cd_segmt_prdut cd_segmt_prdut_vb
                      ,b.cd_crtor_segur cd_crtor_segur_vb
                      ,b.cd_asses cd_asses_vb
                      ,b.cd_tipo_verba cd_tipo_verba_vb
                      ,b.vl_inicl_verba vl_inicl_verba_vb
                      ,b.vl_prvsn_verba vl_prvsn_verba_vb
                      ,b.vl_eftdo_verba vl_eftdo_verba_vb
                      ,b.vl_crdto_verba vl_crdto_verba_vb
                      ,b.vl_saldo_verba vl_saldo_verba_vb
                      ,b.dt_inico_vigen dt_inico_vigen_vb
                      ,b.dt_fim_vigen dt_fim_vigen_vb
                      ,b.id_verba_origm_trnsf id_verba_origm_trnsf_vb
                      ,b.cd_usuro_ultma_alter cd_usuro_ultma_alter_vb
                      ,b.dt_ultma_alter dt_ultma_alter_vb
                      ,b.cd_situc_verba cd_situc_verba_vb
                      ,b.id_arquv_carga_verba id_arquv_carga_verba_vb
                      ,b.vl_eftdo_verba
                      ,b.vl_saldo_verba
                      ,b.vl_crdit_agrvo
                      ,b.vl_inicl_verba
                FROM   cta0002_verba b
                WHERE  b.id_verba = p_id_verba;

        --
        v_id_verba_aux NUMBER;

        --
        v_VlAgravoDesconto NUMBER(15, 2);

        v_vl_prvsn_verba_vb NUMBER(15, 2);

        v_vl_saldo_verba_vb NUMBER(15, 2);

        --
        --------------------------------------------------------------------------
        --      RetornaIdVerbaEstorno:  Retorna o id_verba da verba de estorno. --
        --------------------------------------------------------------------------
        --
        FUNCTION RetornaIdVerbaEstorno(p_id_verba IN NUMBER) RETURN NUMBER IS
                --
                v_id_verba_estorno NUMBER;
                --
                --
        BEGIN
                SELECT MAX(id_verba)
                INTO   v_id_verba_estorno
                FROM   cta0002_verba
                WHERE  id_verba_origm_trnsf = p_id_verba
                AND    cd_usuro_ultma_alter = 'ESTORNO';
                --
                RETURN v_id_verba_estorno;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro RetornaIdVerbaEstorno: ' || SQLERRM);
                        --
                        RETURN NULL;
                        --
        END RetornaIdVerbaEstorno;

        --
        --------------------------------------------------------------------------
        --      RetornaIdVerbaEstorno:  Retorna o id_verba da verba de estorno. --
        --------------------------------------------------------------------------
        --
        FUNCTION VerificaSituacaoProvisaoLIB(p_cd_ctrat IN NUMBER
                                            ,P_cd_item_ctrat IN NUMBER) RETURN BOOLEAN IS
                --
                V_AUX NUMBER;
                --
        BEGIN
                --
                SELECT COUNT(1) AS TOTAL
                INTO V_AUX
                FROM cta0004_lacto
                WHERE cd_ctrat = p_cd_ctrat
                AND cd_item_ctrat = P_cd_item_ctrat
                AND cd_situc_lacto = 'LIB';
                --
                IF NVL(V_AUX, 0) > 0 THEN
                        --
                        RETURN TRUE;
                        --
                ELSE
                        --
                        RETURN FALSE;
                        --
                END IF;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro Atualiza Provisao LIB: ' || SQLERRM);
                        --
                        RETURN FALSE;
                        --
        END VerificaSituacaoProvisaoLIB;

        --
        --------------------------------------------------------------------------
        --      ProcessoReprovisiona:   Verifica se o processo chamador deve    --
        --                              inserir verba de estorno ou no.        --
        --------------------------------------------------------------------------
        --
        FUNCTION ProcessoReprovisiona(p_cd_processo IN NUMBER) RETURN BOOLEAN IS
                --
                v_ds_param_cc cta0008_param_cc.ds_param_cc%TYPE;
                --
        BEGIN
                --
                SELECT ds_param_cc
                INTO   v_ds_param_cc
                FROM   cta0008_param_cc
                WHERE  nm_param_cc = 'REPROVISIONA';
                --
                IF InStr(v_ds_param_cc, ';' || p_cd_processo || ';') <> 0 THEN
                        --
                        RETURN TRUE;
                        --
                ELSE
                        --
                        RETURN FALSE;
                        --
                END IF;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        RETURN FALSE;
                        --
        END ProcessoReprovisiona;

        --
        --------------------------------------------------------------------------
        --      RetornaIdVerba
        --------------------------------------------------------------------------
        --
        FUNCTION RetornaIdVerba RETURN NUMBER IS
                --
                v_id_verba NUMBER;
                --
        BEGIN
                --
                SELECT ctasq0002_verba.NEXTVAL
                INTO   v_id_verba
                FROM   dual;
                --
                RETURN v_id_verba;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro RetornaIdVerba: ' || SQLERRM);
                        --
                        RETURN NULL;
                        --
        END RetornaIdVerba;

        --
        --------------------------------------------------------------------------
        --      RetornaIdLacto
        --------------------------------------------------------------------------
        --
        FUNCTION RetornaIdLacto RETURN NUMBER IS
                --
                v_id_lacto NUMBER;
                --
        BEGIN
                --
                SELECT ctasq0004_lacto.NEXTVAL
                INTO   v_id_lacto
                FROM   dual;
                --
                RETURN v_id_lacto;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro RetornaIdLacto: ' || SQLERRM);
                        --
                        RETURN NULL;
                        --
        END RetornaIdLacto;

        --
        --------------------------------------------------------------------------
        --      ImprimeVerbaAntes                                               --
        --------------------------------------------------------------------------
        --
        PROCEDURE ImprimeVerbaAntes(p_cd_contrato   IN NUMBER
                                   ,p_item_contrato IN NUMBER
                                   ,p_dt_procm      IN DATE
                                   ,p_verbas        OUT t_verbas) IS
                --
        BEGIN
                --
                FOR r_verba_estorno IN verba_estorno(p_cd_contrato, p_item_contrato, p_dt_procm) LOOP
                        --
                        p_verbas(p_verbas.Count + 1).id_verba := r_verba_estorno.id_verba;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================' || Chr(10) || '[Valores da verba ' ||
                                                  r_verba_estorno.id_verba || 'antes]' || Chr(10) ||
                                                  '=====================================================');
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '  id_verba...................: ' || r_verba_estorno.id_verba || Chr(10) ||
                                                  '  cd_segmt_prdut.............: ' || r_verba_estorno.cd_segmt_prdut_vb || Chr(10) ||
                                                  '  cd_crtor_segur.............: ' || r_verba_estorno.cd_crtor_segur_vb || Chr(10) ||
                                                  '  cd_asses...................: ' || r_verba_estorno.cd_asses_vb || Chr(10) ||
                                                  '  cd_tipo_verba..............: ' || r_verba_estorno.cd_tipo_verba_vb || Chr(10) ||
                                                  '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba_vb || Chr(10) ||
                                                  '  vl_prvsn_verba.............: ' || r_verba_estorno.vl_prvsn_verba_vb || Chr(10) ||
                                                  '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba_vb || Chr(10) ||
                                                  '  vl_crdto_verba.............: ' || r_verba_estorno.vl_crdto_verba_vb || Chr(10) ||
                                                  '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba_vb || Chr(10) ||
                                                  '  dt_inico_vigen.............: ' || r_verba_estorno.dt_inico_vigen_vb || Chr(10) ||
                                                  '  dt_fim_vigen...............: ' || r_verba_estorno.dt_fim_vigen_vb || Chr(10) ||
                                                  '  id_verba_origm_trnsf.......: ' || r_verba_estorno.id_verba_origm_trnsf_vb || Chr(10) ||
                                                  '  cd_usuro_ultma_alter.......: ' || r_verba_estorno.cd_usuro_ultma_alter_vb || Chr(10) ||
                                                  '  dt_ultma_alter.............: ' || r_verba_estorno.dt_ultma_alter_vb || Chr(10) ||
                                                  '  cd_situc_verba.............: ' || r_verba_estorno.cd_situc_verba_vb || Chr(10) ||
                                                  '  id_arquv_carga_verba.......: ' || r_verba_estorno.id_arquv_carga_verba_vb || Chr(10) ||
                                                  '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba || Chr(10) ||
                                                  '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba || Chr(10) ||
                                                  '  vl_crdit_agrvo.............: ' || r_verba_estorno.vl_crdit_agrvo || Chr(10) ||
                                                  '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================');
                        --
                END LOOP;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro ImprimeVerbaAntes: ' || SQLERRM);
                        --
        END ImprimeVerbaAntes;

        --
        --------------------------------------------------------------------------
        --      ImprimeVerbaDepois
        --------------------------------------------------------------------------
        --
        PROCEDURE ImprimeVerbaDepois(p_dt_procm IN DATE
                                    ,p_verbas   IN t_verbas) IS
                --
        BEGIN
                --
                FOR r IN 1 .. p_verbas.Count LOOP
                        --
                        FOR r_verba_estorno IN verba_estorno2(p_dt_procm, p_verbas(r).id_verba) LOOP
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================' || Chr(10) ||
                                                          '[Valores da verba ' || r_verba_estorno.id_verba || 'depois]' || Chr(10) ||
                                                          '=====================================================');
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '  cd_segmt_prdut............: ' || r_verba_estorno.cd_segmt_prdut_vb || Chr(10) ||
                                                          '  cd_crtor_segur.............: ' || r_verba_estorno.cd_crtor_segur_vb || Chr(10) ||
                                                          '  cd_asses...................: ' || r_verba_estorno.cd_asses_vb || Chr(10) ||
                                                          '  cd_tipo_verba..............: ' || r_verba_estorno.cd_tipo_verba_vb || Chr(10) ||
                                                          '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba_vb || Chr(10) ||
                                                          '  vl_prvsn_verba.............: ' || r_verba_estorno.vl_prvsn_verba_vb || Chr(10) ||
                                                          '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba_vb || Chr(10) ||
                                                          '  vl_crdto_verba_vb..........: ' || r_verba_estorno.vl_crdto_verba_vb || Chr(10) ||
                                                          '  vl_saldo_verba_vb..........: ' || r_verba_estorno.vl_saldo_verba_vb || Chr(10) ||
                                                          '  dt_inico_vigen_vb..........: ' || r_verba_estorno.dt_inico_vigen_vb || Chr(10) ||
                                                          '  dt_fim_vigen_vb............: ' || r_verba_estorno.dt_fim_vigen_vb || Chr(10) ||
                                                          '  id_verba_origm_trnsf_vb....: ' || r_verba_estorno.id_verba_origm_trnsf_vb ||
                                                          Chr(10) || '  cd_usuro_ultma_alter_vb....: ' ||
                                                          r_verba_estorno.cd_usuro_ultma_alter_vb || Chr(10) ||
                                                          '  dt_ultma_alter_vb..........: ' || r_verba_estorno.dt_ultma_alter_vb || Chr(10) ||
                                                          '  cd_situc_verba_vb..........: ' || r_verba_estorno.cd_situc_verba_vb || Chr(10) ||
                                                          '  id_arquv_carga_verba_vb....: ' || r_verba_estorno.id_arquv_carga_verba_vb ||
                                                          Chr(10) || '  vl_eftdo_verba.............: ' || r_verba_estorno.vl_eftdo_verba ||
                                                          Chr(10) || '  vl_saldo_verba.............: ' || r_verba_estorno.vl_saldo_verba ||
                                                          Chr(10) || '  vl_crdit_agrvo.............: ' || r_verba_estorno.vl_crdit_agrvo ||
                                                          Chr(10) || '  vl_inicl_verba.............: ' || r_verba_estorno.vl_inicl_verba);
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '=====================================================');
                                --
                        END LOOP;
                        --
                END LOOP;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro ImprimeVerbaDepois: ' || SQLERRM);
                        --
        END ImprimeVerbaDepois;

        --
        --------------------------------------------------------------------------
        --      Estorna_Provisao_Endosso        Faz o estorno das provises de  --
        --                                      endossos de cancelamento por    --
        --                                      erro tcnico.                   --
        --------------------------------------------------------------------------
        --
        PROCEDURE Estorna_Provisao_Endosso(p_estorna_provisao_in IN estorna_provisao_in
                                          ,p_dt_procm            IN DATE
                                          ,p_qt_dias_estorno     IN NUMBER
                                          ,p_corretor            IN CTACTPA0100_001.t_corretor
                                          ,p_id_procs_criac      IN NUMBER
                                          ,p_cd_erro             OUT NUMBER
                                          ,p_msg_erro            OUT VARCHAR2) IS
                --
                v_cd_erro          NUMBER;
                v_vl_provisao      NUMBER;
                v_id_verba_estorno NUMBER;
                --
                v_vl_lacto       NUMBER;
                v_id_verba       NUMBER;
                v_id_lacto       NUMBER;
                v_vl_inicl_verba NUMBER;
                v_vl_prvsn_verba NUMBER;
                v_vl_eftdo_verba NUMBER;
                v_vl_saldo_verba NUMBER;
                --
                v_vl_prvsn_verba_vb NUMBER(15, 2);
                v_vl_saldo_verba_vb NUMBER(15, 2);
                --
                --
                v_msg_erro         VARCHAR2(4000);
                v_InAgravoDesconto VARCHAR2(4000);
                --
        BEGIN
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Dentro do Estorna_Provisao_Endosso]');
                --
                v_vl_provisao := CTACTPA0100_001.RetornaProvisaoEnd(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, p_estorna_provisao_in.CdCorretor, v_InAgravoDesconto, v_cd_erro, v_msg_erro);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_cd_erro  := v_cd_erro;
                        p_msg_erro := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RETURN;
                        --
                ELSE
                        --
                        IF v_vl_provisao = 0 THEN
                                --
                                p_cd_erro  := 102;
                                p_msg_erro := '[Estorna Proviso] - Proviso no encontrada para o item / negcio';
                                --
                                RETURN;
                                --
                        END IF;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Retornando os lanamentos que devem ser estornados      --
                ------------------------------------------------------------------
                --
                FOR r_estorna_item IN c_estorna_item(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, p_dt_procm) LOOP
                        --
                        ----------------------------------------------------------
                        --      SAF 21072 - Se o lanamento estiver liberado,   --
                        --      no deve estornar o lanamento                  --
                        ----------------------------------------------------------
                        --
                        IF r_estorna_item.cd_situc_lacto = 'LIB' AND
                           p_estorna_provisao_in.CdProcesso <> 3 THEN
                                --
                                p_cd_erro  := 103;
                                p_msg_erro := '[Estorna Proviso] - Item com lanamento liberado. No  possvel estornar o valor';
                                --
                                RETURN;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Verificando se j existe uma verba de estorno   --
                        --      criada.                                         --
                        ----------------------------------------------------------
                        --
                        v_id_verba_estorno := RetornaIdVerbaEstorno(r_estorna_item.id_verba);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Verba do Lanamento] ' || r_estorna_item.id_verba || Chr(10) || '[Valor Lanamento] ' ||
                                                  r_estorna_item.vl_lacto);
                        --
                        ----------------------------------------------------------
                        --      SAF 21072 - Se o lanamento estiver liberado,   --
                        --      no deve estornar o lanamento                  --
                        ----------------------------------------------------------
                        --
                        IF r_estorna_item.cd_situc_lacto = 'LIB' AND
                           p_estorna_provisao_in.CdProcesso <> 3 THEN
                                --
                                p_cd_erro  := 103;
                                p_msg_erro := '[Estorna Proviso] - Item com lanamento liberado. No  possvel estornar o valor';
                                --
                                RETURN;
                                --
                        ELSE
                                --
                                --------------------------------------------------
                                --      Lanamento no est estornado, verifica --
                                --      se est no intervalo do estorno.        --
                                --------------------------------------------------
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '[r_estorna_item.qt_dias_verba_a_vencer] = ' ||
                                                          r_estorna_item.qt_dias_verba_a_vencer || ' v_qt_dias_estorno = ' ||
                                                          p_qt_dias_estorno || ']');
                                --
                                IF r_estorna_item.qt_dias_verba_a_vencer >= p_qt_dias_estorno THEN
                                        --
                                        ------------------------------------------
                                        --      Verba no excede o prazo do     --
                                        --      estorno. Estorna na prpria     --
                                        --      verba.                          --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Estornando para a prpria verba]');
                                        --
                                        IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                --
                                                ----------------------------------
                                                --      Estorno de desconto.    --
                                                ----------------------------------
                                                --
                                                v_vl_prvsn_verba := Nvl(r_estorna_item.vl_prvsn_verba_vb, 0) - Nvl(r_estorna_item.vl_lacto, 0);
                                                v_vl_saldo_verba := Nvl(r_estorna_item.vl_saldo_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Desconto] - Atualizando verba.................. ' ||
                                                                          r_estorna_item.id_verba || Chr(10) ||
                                                                          ' [Desconto] - Valor anterior vl_prvsn_verba...... ' ||
                                                                          r_estorna_item.vl_prvsn_verba_vb || Chr(10) ||
                                                                          ' [Desconto] - Valor anterior vl_saldo_verba...... ' ||
                                                                          r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                                          ' [Desconto] - Valor do lanamento................ ' ||
                                                                          Nvl(r_estorna_item.vl_lacto, 0) || Chr(10) ||
                                                                          ' [Desconto] - Valor novo v_vl_prvsn_verba........ ' ||
                                                                          v_vl_prvsn_verba || Chr(10) ||
                                                                          ' [Desconto] - Valor novo v_vl_saldo_verba........ ' ||
                                                                          v_vl_saldo_verba);
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_prvsn_verba = v_vl_prvsn_verba
                                                              ,vl_saldo_verba = v_vl_saldo_verba
                                                        WHERE  id_verba = r_estorna_item.id_verba;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                --
                                                ----------------------------------
                                                --      Estorno de agravo.      --
                                                ----------------------------------
                                                --
                                                v_vl_eftdo_verba := r_estorna_item.vl_eftdo_verba - r_estorna_item.vl_lacto;
                                                v_vl_saldo_verba := r_estorna_item.vl_saldo_verba - r_estorna_item.vl_lacto;
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Agravo] - Atualizando verba.................. ' ||
                                                                          r_estorna_item.id_verba || Chr(10) ||
                                                                          ' [Agravo] - Valor anterior vl_eftdo_verba...... ' ||
                                                                          r_estorna_item.vl_eftdo_verba || Chr(10) ||
                                                                          ' [Agravo] - Valor anteriro vl_saldo_verba...... ' ||
                                                                          r_estorna_item.vl_saldo_verba || Chr(10) ||
                                                                          ' [Agravo] - Valor do lanamento................ ' ||
                                                                          r_estorna_item.vl_lacto || Chr(10) ||
                                                                          ' [Agravo] - Valor novo v_vl_eftdo_verba........ ' ||
                                                                          v_vl_eftdo_verba || Chr(10) ||
                                                                          ' [Agravo] - Valor novo v_vl_saldo_verba........ ' ||
                                                                          v_vl_saldo_verba);
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_eftdo_verba = v_vl_eftdo_verba
                                                              ,vl_saldo_verba = v_vl_saldo_verba
                                                        WHERE  id_verba = r_estorna_item.id_verba;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        END IF;
                                        --
                                ELSE
                                        --
                                        ------------------------------------------
                                        --      Faz o estorno na verba de       --
                                        --      estorno, se ela existir. Se no --
                                        --      existir, cria a verba.          --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Estornando para a verba de estorno]');
                                        --
                                        v_id_verba_estorno := RetornaIdVerbaEstorno(r_estorna_item.id_verba);
                                        --
                                        ------------------------------------------
                                        --      Se no existir verba de estorno --
                                        --      criar. Seno atualizar.         --
                                        ------------------------------------------
                                        --
                                        IF v_id_verba_estorno IS NULL THEN
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, '[Verba de estorno no encontrada. Criando verba]');
                                                --
                                                v_id_verba := RetornaIdVerba;
                                                --
                                                ----------------------------------
                                                --      Determinando o valor do --
                                                --      lanamento.             --
                                                ----------------------------------
                                                --
                                                IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                        --
                                                        --------------------------
                                                        --      Desconto assume --
                                                        --      o valor do      --
                                                        --      lanamento.     --
                                                        --------------------------
                                                        --
                                                        v_vl_lacto := Nvl(r_estorna_item.vl_lacto, 0);
                                                        --
                                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Desconto] - Criando verba.................. ' ||
                                                                                  v_id_verba || Chr(10) ||
                                                                                  ' [Desconto] - v_vl_lacto..................... ' ||
                                                                                  v_vl_lacto);
                                                        --
                                                ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                        --
                                                        --------------------------
                                                        --      Agravo desconta --
                                                        --      o valor da      --
                                                        --      comisso.       --
                                                        --------------------------
                                                        --
                                                        v_vl_lacto := Trunc(Nvl(r_estorna_item.vl_lacto, 0) *
                                                                            (1 - (r_estorna_item.pc_comis_crtor) / 100), 2);
                                                        --
                                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Agravo] - Criando verba.................. ' ||
                                                                                  v_id_verba || Chr(10) ||
                                                                                  ' [Agravo] - v_vl_lacto..................... ' ||
                                                                                  v_vl_lacto);
                                                        --
                                                END IF;
                                                --
                                                ----------------------------------
                                                --      Criando a verba de      --
                                                --      estorno.                --
                                                ----------------------------------
                                                --
                                                BEGIN
                                                        --
                                                        INSERT INTO cta0002_verba
                                                                (id_verba
                                                                ,cd_segmt_prdut
                                                                ,cd_crtor_segur
                                                                ,cd_asses
                                                                ,cd_tipo_verba
                                                                ,vl_inicl_verba
                                                                ,vl_prvsn_verba
                                                                ,vl_eftdo_verba
                                                                ,vl_crdto_verba
                                                                ,vl_saldo_verba
                                                                ,dt_inico_vigen
                                                                ,dt_fim_vigen
                                                                ,id_verba_origm_trnsf
                                                                ,cd_usuro_ultma_alter
                                                                ,dt_ultma_alter
                                                                ,cd_situc_verba
                                                                ,id_arquv_carga_verba)
                                                        --
                                                        VALUES
                                                                (v_id_verba
                                                                ,r_estorna_item.cd_segmt_prdut_vb
                                                                ,r_estorna_item.cd_crtor_segur_vb
                                                                ,r_estorna_item.cd_asses_vb
                                                                ,'T'
                                                                ,v_vl_lacto
                                                                ,0
                                                                ,0
                                                                ,0
                                                                ,v_vl_lacto
                                                                ,p_dt_procm
                                                                ,Last_Day(Add_Months(r_estorna_item.dt_fim_vigen_vb, 1))
                                                                ,r_estorna_item.id_verba
                                                                ,'ESTORNO'
                                                                ,r_estorna_item.dt_ultma_alter_vb
                                                                ,'ATI' --,r_estorna_item.cd_situc_verba_vb
                                                                ,r_estorna_item.id_arquv_carga_verba_vb);
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao inserir verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                                v_id_lacto := RetornaIdLacto;
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Criando lanamento de estorno] = ' || v_id_lacto);
                                                --
                                                BEGIN
                                                        --
                                                        INSERT INTO cta0004_lacto
                                                                (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,id_procs_alter
                                                                ,cd_usuro_ultma_alter
                                                                ,dt_ultma_alter
                                                                ,id_corrl_bus
                                                                ,id_prdut_sistm_origm
                                                                ,tp_desct_agrvo
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor)
                                                        --
                                                        VALUES
                                                                (v_id_lacto
                                                                ,v_id_verba
                                                                ,'EST'
                                                                ,r_estorna_item.cd_ctrat
                                                                ,r_estorna_item.cd_item_ctrat
                                                                ,'C'
                                                                ,SYSDATE
                                                                ,0
                                                                ,r_estorna_item.vl_lacto
                                                                ,0
                                                                ,r_estorna_item.vl_lacto
                                                                ,NULL
                                                                ,r_estorna_item.id_lacto
                                                                ,r_estorna_item.tp_pesoa
                                                                ,r_estorna_item.nm_clien_sgrdo
                                                                ,r_estorna_item.nr_cpf_cnpj_clien
                                                                ,r_estorna_item.vl_prmio_liqui_ppota
                                                                ,r_estorna_item.pc_comis_crtor
                                                                ,r_estorna_item.dt_inico_vigen_segur
                                                                ,p_id_procs_criac
                                                                ,p_estorna_provisao_in.CdUsuario
                                                                ,SYSDATE
                                                                ,NULL
                                                                ,NULL
                                                                ,NULL
                                                                ,r_estorna_item.id_corrl_bus
                                                                ,r_estorna_item.id_prdut_sistm_origm
                                                                ,'A'
                                                                ,p_corretor.cd_sucsl_comrl
                                                                ,p_corretor.cd_diret_comrl
                                                                ,p_corretor.cd_asses);
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento de estorno: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        ELSE
                                                --
                                                ----------------------------------
                                                --      Verba de estorno j     --
                                                --      existe.                 --
                                                ----------------------------------
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, '[Verba de estorno encontrada. Verba = ] ' || v_id_verba_estorno);
                                                --
                                                BEGIN
                                                        --
                                                        SELECT b.vl_inicl_verba
                                                              ,b.vl_saldo_verba
                                                        INTO   v_vl_prvsn_verba_vb
                                                              ,v_vl_saldo_verba_vb
                                                        FROM   cta0002_verba b
                                                        WHERE  b.id_verba = v_id_verba_estorno;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso Endosso] - Erro ao buscar valor verba estorno: ' ||
                                                                              SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                                IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                        --
                                                        v_vl_inicl_verba := Nvl(v_vl_prvsn_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                        v_vl_saldo_verba := Nvl(v_vl_saldo_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                        --
                                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Desconto] - Atualizando verba........ ' ||
                                                                                  v_id_verba_estorno || Chr(10) ||
                                                                                  '[Desconto] - v_vl_inicl_verba......... ' ||
                                                                                  v_vl_inicl_verba || Chr(10) ||
                                                                                  '[Desconto] - v_vl_saldo_verba......... ' ||
                                                                                  v_vl_saldo_verba);
                                                        --
                                                        BEGIN
                                                                --
                                                                UPDATE cta0002_verba
                                                                SET    vl_inicl_verba = v_vl_inicl_verba
                                                                      ,vl_saldo_verba = v_vl_saldo_verba
                                                                WHERE  id_verba = v_id_verba_estorno;
                                                                --
                                                        EXCEPTION
                                                                --
                                                                WHEN OTHERS THEN
                                                                        --
                                                                        p_cd_erro  := 1;
                                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                        --
                                                                        RETURN;
                                                                        --
                                                        END;
                                                        --
                                                ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                        --
                                                        v_vl_eftdo_verba := Nvl(v_vl_prvsn_verba_vb, 0) - r_estorna_item.vl_lacto;
                                                        v_vl_saldo_verba := Nvl(v_vl_saldo_verba_vb, 0) - r_estorna_item.vl_lacto;
                                                        --
                                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Agravo] - Atualizando verba........ ' ||
                                                                                  v_id_verba_estorno || Chr(10) ||
                                                                                  '[Agravo] - v_vl_eftdo_verba......... ' ||
                                                                                  v_vl_eftdo_verba || Chr(10) ||
                                                                                  '[Agravo] - v_vl_saldo_verba......... ' ||
                                                                                  v_vl_saldo_verba);
                                                        --
                                                        BEGIN
                                                                --
                                                                UPDATE cta0002_verba
                                                                SET    vl_eftdo_verba = v_vl_eftdo_verba
                                                                      ,vl_saldo_verba = v_vl_saldo_verba
                                                                WHERE  id_verba = v_id_verba_estorno;
                                                                --
                                                        EXCEPTION
                                                                --
                                                                WHEN OTHERS THEN
                                                                        --
                                                                        p_cd_erro  := 1;
                                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                        --
                                                                        RETURN;
                                                                        --
                                                        END;
                                                        --
                                                END IF;
                                                --
                                        END IF;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Criando o lanamento de estorno do endosso.     --
                        ----------------------------------------------------------
                        --
                        v_id_lacto := RetornaIdLacto;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Inserindo lanamento END.............. ' || v_id_lacto || Chr(10) ||
                                                  '[r_estorna_item.vl_saldo_verba_anter... ' || r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                  '[r_estorna_item.vl_saldo_verba_postr... ' || v_vl_saldo_verba);
                        --
                        BEGIN
                                --
                                INSERT INTO cta0004_lacto
                                        (id_lacto
                                        ,id_verba
                                        ,cd_situc_lacto
                                        ,cd_ctrat
                                        ,cd_item_ctrat
                                        ,cd_tipo_lacto
                                        ,dt_lacto
                                        ,vl_saldo_verba_anter
                                        ,vl_lacto
                                        ,vl_agrvo_ppota
                                        ,vl_saldo_verba_postr
                                        ,id_lacto_origm_trnsf
                                        ,id_lacto_estor
                                        ,tp_pesoa
                                        ,nm_clien_sgrdo
                                        ,nr_cpf_cnpj_clien
                                        ,vl_prmio_liqui_ppota
                                        ,pc_comis_crtor
                                        ,dt_inico_vigen_segur
                                        ,id_procs_criac
                                        ,cd_usuro_criac
                                        ,dt_criac
                                        ,id_procs_alter
                                        ,cd_usuro_ultma_alter
                                        ,dt_ultma_alter
                                        ,id_corrl_bus
                                        ,id_prdut_sistm_origm
                                        ,tp_desct_agrvo
                                        ,cd_sucsl_comrl
                                        ,cd_diret_comrl
                                        ,cd_asses_atual_crtor)
                                --
                                VALUES
                                        (v_id_lacto
                                        ,r_estorna_item.id_verba
                                        ,'END'
                                        ,r_estorna_item.cd_ctrat
                                        ,r_estorna_item.cd_item_ctrat
                                        ,'C'
                                        ,SYSDATE
                                        ,r_estorna_item.vl_saldo_verba_vb
                                        ,r_estorna_item.vl_lacto
                                        ,r_estorna_item.vl_agrvo_ppota
                                        ,v_vl_saldo_verba
                                        ,r_estorna_item.id_lacto_origm_trnsf
                                        ,NULL
                                        ,r_estorna_item.tp_pesoa
                                        ,r_estorna_item.nm_clien_sgrdo
                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                        ,r_estorna_item.pc_comis_crtor
                                        ,r_estorna_item.dt_inico_vigen_segur
                                        ,p_id_procs_criac
                                        ,p_estorna_provisao_in.CdUsuario
                                        ,SYSDATE
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,r_estorna_item.id_corrl_bus
                                        ,r_estorna_item.id_prdut_sistm_origm
                                        ,r_estorna_item.tp_desct_agrvo
                                        ,p_corretor.cd_sucsl_comrl
                                        ,p_corretor.cd_diret_comrl
                                        ,p_corretor.cd_asses);
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '[Inseriu Registro] Contrato = ' || r_estorna_item.cd_ctrat || ' Item = ' ||
                                                          r_estorna_item.cd_item_ctrat);
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Erro ao inserir lanamento] = ' || SQLERRM);
                                        p_cd_erro  := 1;
                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                END LOOP;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 1;
                        p_msg_erro := '[Estorna Proviso] - Erro Estorna_Provisao_Endosso: ' || SQLERRM;
                        --
                        RETURN;
                        --
        END Estorna_Provisao_Endosso;

        --
        --------------------------------------------------------------------------
        --      Estorna_Provisao_Reprovisiona                                   --
        --------------------------------------------------------------------------
        --
        PROCEDURE Estorna_Provisao_Reprovisiona(p_estorna_provisao_in IN estorna_provisao_in
                                               ,p_dt_procm            IN DATE
                                               ,p_qt_dias_estorno     IN NUMBER
                                               ,p_corretor            IN CTACTPA0100_001.t_corretor
                                               ,p_id_procs_criac      IN NUMBER
                                               ,p_cd_erro             OUT NUMBER
                                               ,p_msg_erro            OUT VARCHAR2) IS
                --
                v_id_verba_estorno NUMBER;
                v_vl_lacto         NUMBER;
                v_id_verba         NUMBER;
                v_id_lacto         NUMBER;
                v_vl_inicl_verba   NUMBER;
                v_vl_prvsn_verba   NUMBER;
                v_vl_eftdo_verba   NUMBER;
                v_vl_saldo_verba   NUMBER;
                v_vl_crdit_agrvo   NUMBER;
                --
        BEGIN
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Dentro do Estorna_Provisao_Reprovisiona]');
                --
                FOR r_estorna_item IN c_estorna_item(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, p_dt_procm) LOOP
                        --
                        ----------------------------------------------------------
                        --      SAF 21072 - Se o lanamento estiver liberado,   --
                        --      no deve estornar o lanamento                  --
                        ----------------------------------------------------------
                        --
                        IF r_estorna_item.cd_situc_lacto = 'LIB' AND
                           p_estorna_provisao_in.CdProcesso <> 3 THEN
                                --
                                p_cd_erro  := 103;
                                p_msg_erro := '[Estorna Proviso] - Item com lanamento liberado. No  possvel estornar o valor';
                                --
                                RETURN;
                                --
                        END IF;
                        --
                        v_id_verba_estorno := RetornaIdVerbaEstorno(r_estorna_item.id_verba);
                        --
                        ----------------------------------------------------------
                        --      Se no existir verba de estorrno, criar. Seno  --
                        --      atualizar.                                      --
                        ----------------------------------------------------------
                        --
                        IF v_id_verba_estorno IS NOT NULL THEN
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Encontrou verba de estorno] = ' || v_id_verba_estorno);
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Validando data processamento] = ' || p_dt_procm);
                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Validando data fim de vigencia] = ' || r_estorna_item.dt_fim_vigen_vb);
                        --
                        IF p_dt_procm > r_estorna_item.dt_fim_vigen_vb THEN
                                --
                                --------------------------------------------------
                                --      Verba est vencida                      --
                                --------------------------------------------------
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Verba vencida. Processamento: ' || To_Char(p_dt_procm, 'DD/MM/YYYY') ||
                                                          ' Fim de vigncia: ' || To_Char(r_estorna_item.dt_fim_vigen_vb, 'DD/MM/YYYY'));
                                --
                                IF v_id_verba_estorno IS NULL THEN
                                        --
                                        ------------------------------------------
                                        --      No encontrou verba de estorno  --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Verba vencida no tem correpsondente. Criando]');
                                        --
                                        ------------------------------------------
                                        --      Determinando o valor do         --
                                        --      lanamento e id_verba.          --
                                        ------------------------------------------
                                        --
                                        v_vl_lacto := Nvl(r_estorna_item.vl_lacto, 0);
                                        v_id_verba := RetornaIdVerba;
                                        --
                                        ------------------------------------------
                                        --      Criando verba de estorno.       --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' Criando verba........................ ' || v_id_verba || Chr(10) ||
                                                                  ' Valor do lanamento - v_vl_lacto..... ' || v_vl_lacto);
                                        --
                                        BEGIN
                                                --
                                                INSERT INTO cta0002_verba
                                                        (id_verba
                                                        ,cd_segmt_prdut
                                                        ,cd_crtor_segur
                                                        ,cd_asses
                                                        ,cd_tipo_verba
                                                        ,vl_inicl_verba
                                                        ,vl_prvsn_verba
                                                        ,vl_eftdo_verba
                                                        ,vl_crdto_verba
                                                        ,vl_saldo_verba
                                                        ,dt_inico_vigen
                                                        ,dt_fim_vigen
                                                        ,id_verba_origm_trnsf
                                                        ,cd_usuro_ultma_alter
                                                        ,dt_ultma_alter
                                                        ,cd_situc_verba
                                                        ,id_arquv_carga_verba)
                                                --
                                                VALUES
                                                        (v_id_verba
                                                        ,r_estorna_item.cd_segmt_prdut_vb
                                                        ,r_estorna_item.cd_crtor_segur_vb
                                                        ,r_estorna_item.cd_asses_vb
                                                        ,'T'
                                                        ,v_vl_lacto
                                                        ,0
                                                        ,0
                                                        ,0
                                                        ,v_vl_lacto
                                                        ,p_dt_procm
                                                        ,Last_Day(Add_Months(r_estorna_item.dt_fim_vigen_vb, 1))
                                                        ,r_estorna_item.id_verba
                                                        ,'ESTORNO'
                                                        ,r_estorna_item.dt_ultma_alter_vb
                                                        ,'ATI' --,r_estorna_item.cd_situc_verba_vb
                                                        ,r_estorna_item.id_arquv_carga_verba_vb);
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao inserir verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        ------------------------------------------
                                        --      Determinando o id_lacto.        --
                                        ------------------------------------------
                                        --
                                        v_id_lacto := RetornaIdLacto;
                                        --
                                        ------------------------------------------
                                        --      Criando lanamento de estorno.  --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' Criando lanamento de estorno........ ' || v_id_lacto);
                                        --
                                        BEGIN
                                                --
                                                INSERT INTO cta0004_lacto
                                                        (id_lacto
                                                        ,id_verba
                                                        ,cd_situc_lacto
                                                        ,cd_ctrat
                                                        ,cd_item_ctrat
                                                        ,cd_tipo_lacto
                                                        ,dt_lacto
                                                        ,vl_saldo_verba_anter
                                                        ,vl_lacto
                                                        ,vl_agrvo_ppota
                                                        ,vl_saldo_verba_postr
                                                        ,id_lacto_origm_trnsf
                                                        ,id_lacto_estor
                                                        ,tp_pesoa
                                                        ,nm_clien_sgrdo
                                                        ,nr_cpf_cnpj_clien
                                                        ,vl_prmio_liqui_ppota
                                                        ,pc_comis_crtor
                                                        ,dt_inico_vigen_segur
                                                        ,id_procs_criac
                                                        ,cd_usuro_criac
                                                        ,dt_criac
                                                        ,id_procs_alter
                                                        ,cd_usuro_ultma_alter
                                                        ,dt_ultma_alter
                                                        ,id_corrl_bus
                                                        ,id_prdut_sistm_origm
                                                        ,tp_desct_agrvo
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl
                                                        ,cd_asses_atual_crtor)
                                                --
                                                VALUES
                                                        (v_id_lacto
                                                        ,v_id_verba
                                                        ,'EST'
                                                        ,r_estorna_item.cd_ctrat
                                                        ,r_estorna_item.cd_item_ctrat
                                                        ,'C'
                                                        ,SYSDATE
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,NULL
                                                        ,r_estorna_item.id_lacto
                                                        ,r_estorna_item.tp_pesoa
                                                        ,r_estorna_item.nm_clien_sgrdo
                                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                                        ,r_estorna_item.pc_comis_crtor
                                                        ,r_estorna_item.dt_inico_vigen_segur
                                                        ,p_id_procs_criac
                                                        ,p_estorna_provisao_in.CdUsuario
                                                        ,SYSDATE
                                                        ,NULL
                                                        ,NULL
                                                        ,NULL
                                                        ,r_estorna_item.id_corrl_bus
                                                        ,r_estorna_item.id_prdut_sistm_origm
                                                        ,'A'
                                                        ,p_corretor.cd_sucsl_comrl
                                                        ,p_corretor.cd_diret_comrl
                                                        ,p_corretor.cd_asses);
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento de estorno: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                ELSE
                                        --
                                        ------------------------------------------
                                        --      J tem verba de estorno para a  --
                                        --      verba                           --
                                        ------------------------------------------
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Verba vencida tem correpsondente = ' || v_id_verba_estorno || ']');
                                        --
                                        BEGIN
                                                --
                                                SELECT b.vl_inicl_verba
                                                      ,b.vl_saldo_verba
                                                INTO   v_vl_prvsn_verba_vb
                                                      ,v_vl_saldo_verba_vb
                                                FROM   cta0002_verba b
                                                WHERE  b.id_verba = v_id_verba_estorno;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso Reprovisiona] - Erro ao buscar valores de provisao: ' ||
                                                                      SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                --
                                                ----------------------------------
                                                --      Desconto                --
                                                ----------------------------------
                                                --
                                                v_vl_inicl_verba := Nvl(v_vl_prvsn_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                v_vl_saldo_verba := Nvl(v_vl_saldo_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Desconto] - Atualizando verba....... ' || v_id_verba_estorno ||
                                                                          Chr(10) || ' [Desconto] - vl_inicl_verba antes.... ' ||
                                                                          r_estorna_item.vl_inicl_verba_vb || Chr(10) ||
                                                                          ' [Desconto] - vl_saldo_verba antes.... ' ||
                                                                          r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                                          ' [Desconto] - vl_inicl_verba aps..... ' || v_vl_inicl_verba ||
                                                                          Chr(10) || ' [Desconto] - vl_saldo_verba aps..... ' ||
                                                                          v_vl_saldo_verba);
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_inicl_verba = v_vl_inicl_verba
                                                              ,vl_saldo_verba = v_vl_saldo_verba
                                                        WHERE  id_verba = v_id_verba_estorno;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                --
                                                ----------------------------------
                                                --      Agravo                  --
                                                ----------------------------------
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Agravo] - Atualizando verba....... ' || r_estorna_item.id_verba ||
                                                                          Chr(10) || ' [Agravo] - vl_lacto................ ' ||
                                                                          r_estorna_item.vl_lacto || Chr(10) ||
                                                                          ' [Agravo] - vl_crdit_agrvo antes.... ' ||
                                                                          r_estorna_item.vl_crdit_agrvo || Chr(10) ||
                                                                          ' [Agravo] - vl_crdit_agrvo aps..... ' || v_vl_crdit_agrvo);
                                                --
                                                v_vl_crdit_agrvo := r_estorna_item.vl_crdit_agrvo - r_estorna_item.vl_lacto;
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_crdit_agrvo = v_vl_crdit_agrvo
                                                        WHERE  id_verba = r_estorna_item.id_verba;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        END IF;
                                        --
                                END IF;
                                --
                        ELSE
                                --
                                --------------------------------------------------
                                --      Verba no est vencida. Estorna para a  --
                                --      prpria verba.                          --
                                --------------------------------------------------
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, 'Verba no est vencida');
                                --
                                IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                        --
                                        v_vl_prvsn_verba := Nvl(r_estorna_item.vl_prvsn_verba_vb, 0) - Nvl(r_estorna_item.vl_lacto, 0);
                                        v_vl_saldo_verba := Nvl(r_estorna_item.vl_saldo_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Desconto] - Atualizando verba....... ' || r_estorna_item.id_verba ||
                                                                  Chr(10) || ' [Desconto] - vl_lacto................ ' ||
                                                                  r_estorna_item.vl_lacto || Chr(10) ||
                                                                  ' [Desconto] - vl_prvsn_verba antes.... ' ||
                                                                  r_estorna_item.vl_prvsn_verba_vb || Chr(10) ||
                                                                  ' [Desconto] - vl_saldo_verba antes.... ' ||
                                                                  r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                                  ' [Desconto] - vl_prvsn_verba aps..... ' || v_vl_prvsn_verba || Chr(10) ||
                                                                  ' [Desconto] - vl_saldo_verba aps..... ' || v_vl_saldo_verba);
                                        --
                                        BEGIN
                                                --
                                                UPDATE cta0002_verba
                                                SET    vl_prvsn_verba = v_vl_prvsn_verba
                                                      ,vl_saldo_verba = v_vl_saldo_verba
                                                WHERE  id_verba = r_estorna_item.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                        --
                                        v_vl_crdit_agrvo := r_estorna_item.vl_crdit_agrvo - r_estorna_item.vl_lacto;
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Agravo] - Atualizando verba....... ' || r_estorna_item.id_verba ||
                                                                  Chr(10) || ' [Agravo] - vl_lacto................ ' ||
                                                                  r_estorna_item.vl_lacto || Chr(10) ||
                                                                  ' [Agravo] - vl_crdit_agrvo antes.... ' || r_estorna_item.vl_crdit_agrvo ||
                                                                  Chr(10) || ' [Agravo] - vl_crdit_agrvo depois... ' || v_vl_crdit_agrvo);
                                        --
                                        BEGIN
                                                --
                                                UPDATE cta0002_verba
                                                SET    vl_crdit_agrvo = v_vl_crdit_agrvo
                                                WHERE  id_verba = r_estorna_item.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        v_id_lacto := RetornaIdLacto;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Inserindo lanamento................... ' || v_id_lacto || Chr(10) ||
                                                  ' r_estorna_item.vl_saldo_verba_anter... ' || r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                  ' r_estorna_item.vl_saldo_verba_postr... ' || v_vl_saldo_verba);
                        --
                        BEGIN
                                --
                                INSERT INTO cta0004_lacto
                                        (id_lacto
                                        ,id_verba
                                        ,cd_situc_lacto
                                        ,cd_ctrat
                                        ,cd_item_ctrat
                                        ,cd_tipo_lacto
                                        ,dt_lacto
                                        ,vl_saldo_verba_anter
                                        ,vl_lacto
                                        ,vl_agrvo_ppota
                                        ,vl_saldo_verba_postr
                                        ,id_lacto_origm_trnsf
                                        ,id_lacto_estor
                                        ,tp_pesoa
                                        ,nm_clien_sgrdo
                                        ,nr_cpf_cnpj_clien
                                        ,vl_prmio_liqui_ppota
                                        ,pc_comis_crtor
                                        ,dt_inico_vigen_segur
                                        ,id_procs_criac
                                        ,cd_usuro_criac
                                        ,dt_criac
                                        ,id_procs_alter
                                        ,cd_usuro_ultma_alter
                                        ,dt_ultma_alter
                                        ,id_corrl_bus
                                        ,id_prdut_sistm_origm
                                        ,tp_desct_agrvo
                                        ,cd_sucsl_comrl
                                        ,cd_diret_comrl
                                        ,cd_asses_atual_crtor)
                                --
                                VALUES
                                        (v_id_lacto
                                        ,r_estorna_item.id_verba
                                        ,'CAN'
                                        ,r_estorna_item.cd_ctrat
                                        ,r_estorna_item.cd_item_ctrat
                                        ,'C'
                                        ,SYSDATE
                                        ,r_estorna_item.vl_saldo_verba_vb
                                        ,r_estorna_item.vl_lacto
                                        ,r_estorna_item.vl_agrvo_ppota
                                        ,v_vl_saldo_verba
                                        ,r_estorna_item.id_lacto_origm_trnsf
                                        ,NULL
                                        ,r_estorna_item.tp_pesoa
                                        ,r_estorna_item.nm_clien_sgrdo
                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                        ,r_estorna_item.pc_comis_crtor
                                        ,r_estorna_item.dt_inico_vigen_segur
                                        ,p_id_procs_criac
                                        ,p_estorna_provisao_in.CdUsuario
                                        ,SYSDATE
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,r_estorna_item.id_corrl_bus
                                        ,r_estorna_item.id_prdut_sistm_origm
                                        ,r_estorna_item.tp_desct_agrvo
                                        ,p_corretor.cd_sucsl_comrl
                                        ,p_corretor.cd_diret_comrl
                                        ,p_corretor.cd_asses);
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '[Inseriu Registro] Contrato = ' || r_estorna_item.cd_ctrat || ' Item = ' ||
                                                          r_estorna_item.cd_item_ctrat);
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Erro ao inserir lanamento] = ' || SQLERRM);
                                        --
                                        p_cd_erro  := 1;
                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Atualizando Lanamento ' || r_estorna_item.id_lacto || ' para status EST] = Id Lacto:' ||
                                                  v_id_lacto);
                        --
                        BEGIN
                                --
                                UPDATE cta0004_lacto
                                SET    id_lacto_estor = v_id_lacto
                                      ,cd_situc_lacto = 'EST'
                                WHERE  id_lacto = r_estorna_item.id_lacto;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Erro na atualizao status EST]  ' || SQLERRM);
                                        --
                                        p_cd_erro  := 1;
                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar lanamento: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                END LOOP;
                --
                COMMIT;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 1;
                        p_msg_erro := 'Erro Estorna_Provisao_Reprovisiona: ' || SQLERRM;
                        --
        END Estorna_Provisao_Reprovisiona;

        --
        --------------------------------------------------------------------------
        --      Estorna_Provisao_Geral                                          --
        --------------------------------------------------------------------------
        --
        PROCEDURE Estorna_Provisao_Geral(p_estorna_provisao_in IN estorna_provisao_in
                                        ,p_dt_procm            IN DATE
                                        ,p_qt_dias_estorno     IN NUMBER
                                        ,p_corretor            IN CTACTPA0100_001.t_corretor
                                        ,p_id_procs_criac      IN NUMBER
                                        ,p_cd_erro             OUT NUMBER
                                        ,p_msg_erro            OUT VARCHAR2) IS
                --
                v_id_verba_estorno      NUMBER;
                v_vl_lacto              NUMBER;
                v_id_verba              NUMBER;
                v_id_lacto              NUMBER;
                v_vl_inicl_verba        NUMBER;
                v_vl_prvsn_verba        NUMBER;
                v_vl_eftdo_verba        NUMBER;
                v_vl_saldo_verba        NUMBER;
                v_vl_crdit_agrvo        NUMBER;
                v_vl_saldo_atual        NUMBER;
                v_nao_inclui_nova_verba BOOLEAN;
                --
        BEGIN
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Dentro do Estorna_Provisao_Geral]');
                --
                FOR r_estorna_item IN c_estorna_item(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, p_dt_procm) LOOP
                        --
                        ----------------------------------------------------------
                        --      SAF 21072 - Se o lanamento estiver liberado,   --
                        --      no deve estornar o lanamento                  --
                        ----------------------------------------------------------
                        --
                        IF r_estorna_item.cd_situc_lacto = 'LIB' AND
                           p_estorna_provisao_in.cdprocesso NOT IN (3, 7, 30, 32, 36, 65, 66) THEN
                                --
                                p_cd_erro  := 103;
                                p_msg_erro := '[Estorna Proviso] - Item com lanamento liberado. No  possvel estornar o valor';
                                --
                                RETURN;
                                --
                        END IF;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[r_estorna_item.qt_dias_verba_a_vencer] = ' || r_estorna_item.qt_dias_verba_a_vencer ||
                                                  ' v_qt_dias_estorno = ' || p_qt_dias_estorno || ']');
                        --
                        v_nao_inclui_nova_verba := CTACTPA0100_001.NaoIncluiNovaVerbaEstorno(p_estorna_provisao_in.CdCorretor, v_sq_log);
                        --
                        IF r_estorna_item.qt_dias_verba_a_vencer >= p_qt_dias_estorno OR
                           v_nao_inclui_nova_verba THEN
                                --
                                --------------------------------------------------
                                --      Verba no est vencida. Atualizar na    --
                                --      prpria verba.                          --
                                --------------------------------------------------
                                --
                                IF v_nao_inclui_nova_verba = TRUE THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[No if do estorno da verba] Corretor no permite incluso de nova verba de estorno!');
                                        --
                                ELSE
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[No if do estorno da verba]');
                                        --
                                END IF;
                                BEGIN
                                        --
                                        SELECT b.vl_saldo_verba
                                        INTO   v_vl_saldo_atual
                                        FROM   cta0004_lacto a
                                              ,cta0002_verba b
                                        WHERE  a.cd_ctrat = p_estorna_provisao_in.CdContrato
                                        AND    a.cd_item_ctrat = nvl(p_estorna_provisao_in.cditemcontrato, a.cd_item_ctrat)
                                        AND    a.cd_situc_lacto NOT IN ('CAN', 'AGB', 'END')
                                        AND    a.id_lacto_estor IS NULL
                                        AND    a.id_verba = r_estorna_item.id_verba
                                        AND    b.id_verba = a.id_verba;
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                p_cd_erro  := 1;
                                                p_msg_erro := '[Estorna Proviso Geral] - Erro ao buscar valores verba: ' || SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                        --
                                        v_vl_prvsn_verba := Nvl(r_estorna_item.vl_prvsn_verba_vb, 0) - Nvl(r_estorna_item.vl_lacto, 0);
                                        v_vl_saldo_verba := Nvl(v_vl_saldo_atual, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Desconto] - Atualizando verba.............. ' || r_estorna_item.id_verba ||
                                                                  Chr(10) || '[Desconto] - vl_lacto....................... ' ||
                                                                  r_estorna_item.vl_lacto || Chr(10) ||
                                                                  '[Desconto] - vl_prvsn_verba antes........... ' || v_vl_saldo_atual ||
                                                                  Chr(10) || '[Desconto] - vl_saldo_verba antes........... ' ||
                                                                  r_estorna_item.vl_saldo_verba_vb || Chr(10) ||
                                                                  '[Desconto] - vl_prvsn_verba depois.......... ' || v_vl_prvsn_verba ||
                                                                  Chr(10) || '[Desconto] - vl_saldo_verba depois.......... ' ||
                                                                  v_vl_saldo_verba);
                                        --
                                        BEGIN
                                                --
                                                UPDATE cta0002_verba
                                                SET    vl_prvsn_verba = v_vl_prvsn_verba
                                                      ,vl_saldo_verba = v_vl_saldo_verba
                                                WHERE  id_verba = r_estorna_item.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                        --
                                        v_vl_crdit_agrvo := r_estorna_item.vl_crdit_agrvo - r_estorna_item.vl_lacto;
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Agravo] - Atualizando verba.............. ' || r_estorna_item.id_verba ||
                                                                  Chr(10) || '[Agravo] - vl_lacto....................... ' ||
                                                                  r_estorna_item.vl_lacto || Chr(10) ||
                                                                  '[Agravo] - vl_crdit_agrvo antes........... ' ||
                                                                  r_estorna_item.vl_crdit_agrvo || Chr(10) ||
                                                                  '[Agravo] - vl_crdit_agrvo depois.......... ' || v_vl_crdit_agrvo);
                                        --
                                        BEGIN
                                                --
                                                UPDATE cta0002_verba
                                                SET    vl_crdit_agrvo = v_vl_crdit_agrvo
                                                WHERE  id_verba = r_estorna_item.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END IF;
                                --
                        ELSE
                                --
                                --------------------------------------------------
                                --      Qt_dias_verba_a_vencer menor que a      --
                                --      quantidade de dias do parametro         --
                                --------------------------------------------------
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '[No else do estorno da verba]');
                                --
                                v_id_verba_estorno := RetornaIdVerbaEstorno(r_estorna_item.id_verba);
                                --
                                --------------------------------------------------
                                --      Se no existir verba de estorno criar   --
                                --      Se j existir, atualizar.               --
                                --------------------------------------------------
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, ' [v_id_verba_estorno] = ' || v_id_verba_estorno);
                                --
                                IF v_id_verba_estorno IS NULL THEN
                                        --
                                        ------------------------------------------
                                        --      Determinando o valor do         --
                                        --      lanamento                      --
                                        ------------------------------------------
                                        --
                                        IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                --
                                                ----------------------------------
                                                --      Desconto                --
                                                ----------------------------------
                                                --
                                                v_vl_lacto := Nvl(r_estorna_item.vl_lacto, 0);
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Desconto] - v_vl_lacto = ' || v_vl_lacto);
                                                --
                                        ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                --
                                                ----------------------------------
                                                --      Agravo                  --
                                                ----------------------------------
                                                --
                                                v_vl_lacto := Trunc(Nvl(r_estorna_item.vl_lacto, 0) * (1 - (r_estorna_item.pc_comis_crtor) / 100), 2);
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, ' [Agravo] - v_vl_lacto = ' || v_vl_lacto);
                                                --
                                        END IF;
                                        --
                                        v_id_verba := RetornaIdVerba;
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Criando verba] = ' || v_id_verba);
                                        --
                                        BEGIN
                                                --
                                                INSERT INTO cta0002_verba
                                                        (id_verba
                                                        ,cd_segmt_prdut
                                                        ,cd_crtor_segur
                                                        ,cd_asses
                                                        ,cd_tipo_verba
                                                        ,vl_inicl_verba
                                                        ,vl_prvsn_verba
                                                        ,vl_eftdo_verba
                                                        ,vl_crdto_verba
                                                        ,vl_saldo_verba
                                                        ,dt_inico_vigen
                                                        ,dt_fim_vigen
                                                        ,id_verba_origm_trnsf
                                                        ,cd_usuro_ultma_alter
                                                        ,dt_ultma_alter
                                                        ,cd_situc_verba
                                                        ,id_arquv_carga_verba)
                                                --
                                                VALUES
                                                        (v_id_verba
                                                        ,r_estorna_item.cd_segmt_prdut_vb
                                                        ,r_estorna_item.cd_crtor_segur_vb
                                                        ,r_estorna_item.cd_asses_vb
                                                        ,'T'
                                                        ,v_vl_lacto
                                                        ,0
                                                        ,0
                                                        ,0
                                                        ,v_vl_lacto
                                                        ,P_dt_procm
                                                        ,Last_Day(Add_Months(r_estorna_item.dt_fim_vigen_vb, 1))
                                                        ,r_estorna_item.id_verba
                                                        ,'ESTORNO'
                                                        ,r_estorna_item.dt_ultma_alter_vb
                                                        ,'ATI' --,r_estorna_item.cd_situc_verba_vb
                                                        ,r_estorna_item.id_arquv_carga_verba_vb);
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao inserir verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        v_id_lacto := RetornaIdLacto;
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, ' [Criando lanamento de estorno] = ' || v_id_lacto);
                                        --
                                        BEGIN
                                                --
                                                INSERT INTO cta0004_lacto
                                                        (id_lacto
                                                        ,id_verba
                                                        ,cd_situc_lacto
                                                        ,cd_ctrat
                                                        ,cd_item_ctrat
                                                        ,cd_tipo_lacto
                                                        ,dt_lacto
                                                        ,vl_saldo_verba_anter
                                                        ,vl_lacto
                                                        ,vl_agrvo_ppota
                                                        ,vl_saldo_verba_postr
                                                        ,id_lacto_origm_trnsf
                                                        ,id_lacto_estor
                                                        ,tp_pesoa
                                                        ,nm_clien_sgrdo
                                                        ,nr_cpf_cnpj_clien
                                                        ,vl_prmio_liqui_ppota
                                                        ,pc_comis_crtor
                                                        ,dt_inico_vigen_segur
                                                        ,id_procs_criac
                                                        ,cd_usuro_criac
                                                        ,dt_criac
                                                        ,id_procs_alter
                                                        ,cd_usuro_ultma_alter
                                                        ,dt_ultma_alter
                                                        ,id_corrl_bus
                                                        ,id_prdut_sistm_origm
                                                        ,tp_desct_agrvo
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl
                                                        ,cd_asses_atual_crtor)
                                                --
                                                VALUES
                                                        (v_id_lacto
                                                        ,v_id_verba
                                                        ,'EST'
                                                        ,r_estorna_item.cd_ctrat
                                                        ,r_estorna_item.cd_item_ctrat
                                                        ,'C'
                                                        ,SYSDATE
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,NULL
                                                        ,r_estorna_item.id_lacto
                                                        ,r_estorna_item.tp_pesoa
                                                        ,r_estorna_item.nm_clien_sgrdo
                                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                                        ,r_estorna_item.pc_comis_crtor
                                                        ,r_estorna_item.dt_inico_vigen_segur
                                                        ,p_id_procs_criac
                                                        ,p_estorna_provisao_in.CdUsuario
                                                        ,SYSDATE
                                                        ,NULL
                                                        ,NULL
                                                        ,NULL
                                                        ,r_estorna_item.id_corrl_bus
                                                        ,r_estorna_item.id_prdut_sistm_origm
                                                        ,'A'
                                                        ,p_corretor.cd_sucsl_comrl
                                                        ,p_corretor.cd_diret_comrl
                                                        ,p_corretor.cd_asses);
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento de estorno: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                ELSE
                                        --
                                        ------------------------------------------
                                        --      Verba de estorno j existe      --
                                        ------------------------------------------
                                        --
                                        BEGIN
                                                --
                                                SELECT b.vl_inicl_verba
                                                      ,b.vl_saldo_verba
                                                INTO   v_vl_prvsn_verba_vb
                                                      ,v_vl_saldo_verba_vb
                                                FROM   cta0002_verba b
                                                WHERE  b.id_verba = v_id_verba_estorno;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso Geral] - Erro ao buscar valores verba: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        IF r_estorna_item.tp_desct_agrvo = 'D' THEN
                                                --
                                                ----------------------------------
                                                --      Desconto                --
                                                ----------------------------------
                                                --
                                                v_vl_inicl_verba := Nvl(v_vl_prvsn_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                v_vl_saldo_verba := Nvl(v_vl_saldo_verba_vb, 0) + Nvl(r_estorna_item.vl_lacto, 0);
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, '[Desconto] - Atualizando verba........ ' || v_id_verba_estorno ||
                                                                          Chr(10) || '[Desconto] - vl_inicl_verba antes..... ' ||
                                                                          v_vl_prvsn_verba_vb || Chr(10) ||
                                                                          '[Desconto] - vl_saldo_verba antes..... ' || v_vl_saldo_verba_vb ||
                                                                          Chr(10) || '[Desconto] - vl_inicl_verba depois.... ' ||
                                                                          v_vl_inicl_verba || Chr(10) ||
                                                                          '[Desconto] - vl_saldo_verba depois.... ' || v_vl_saldo_verba);
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_inicl_verba = v_vl_inicl_verba
                                                              ,vl_saldo_verba = v_vl_saldo_verba
                                                        WHERE  id_verba = v_id_verba_estorno;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        ELSIF r_estorna_item.tp_desct_agrvo = 'A' THEN
                                                --
                                                ----------------------------------
                                                --      Agravo                  --
                                                ----------------------------------
                                                --
                                                v_vl_crdit_agrvo := r_estorna_item.vl_crdit_agrvo - r_estorna_item.vl_lacto;
                                                --
                                                CTACTPA0100_001.GravaLog(v_sq_log, '[Agravo] - Atualizando verba.......... ' || v_id_verba_estorno ||
                                                                          Chr(10) || '[Agravo] - vl_lacto................... ' ||
                                                                          r_estorna_item.vl_lacto || Chr(10) ||
                                                                          '[Agravo] - vl_crdit_agrvo antes....... ' ||
                                                                          r_estorna_item.vl_crdit_agrvo || Chr(10) ||
                                                                          '[Agravo] - vl_crdit_agrvo depois...... ' || v_vl_crdit_agrvo);
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE cta0002_verba
                                                        SET    vl_crdit_agrvo = v_vl_crdit_agrvo
                                                        WHERE  id_verba = v_id_verba_estorno;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                p_cd_erro  := 1;
                                                                p_msg_erro := '[Estorna Proviso] - Erro ao atualizar verba: ' || SQLERRM;
                                                                --
                                                                RETURN;
                                                                --
                                                END;
                                                --
                                        END IF;
                                        BEGIN
                                                --
                                                v_id_lacto := RetornaIdLacto;
                                                --
                                                INSERT INTO cta0004_lacto
                                                        (id_lacto
                                                        ,id_verba
                                                        ,cd_situc_lacto
                                                        ,cd_ctrat
                                                        ,cd_item_ctrat
                                                        ,cd_tipo_lacto
                                                        ,dt_lacto
                                                        ,vl_saldo_verba_anter
                                                        ,vl_lacto
                                                        ,vl_agrvo_ppota
                                                        ,vl_saldo_verba_postr
                                                        ,id_lacto_origm_trnsf
                                                        ,id_lacto_estor
                                                        ,tp_pesoa
                                                        ,nm_clien_sgrdo
                                                        ,nr_cpf_cnpj_clien
                                                        ,vl_prmio_liqui_ppota
                                                        ,pc_comis_crtor
                                                        ,dt_inico_vigen_segur
                                                        ,id_procs_criac
                                                        ,cd_usuro_criac
                                                        ,dt_criac
                                                        ,id_procs_alter
                                                        ,cd_usuro_ultma_alter
                                                        ,dt_ultma_alter
                                                        ,id_corrl_bus
                                                        ,id_prdut_sistm_origm
                                                        ,tp_desct_agrvo
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl
                                                        ,cd_asses_atual_crtor)
                                                --
                                                VALUES
                                                        (v_id_lacto
                                                        ,v_id_verba_estorno
                                                        ,'EST'
                                                        ,r_estorna_item.cd_ctrat
                                                        ,r_estorna_item.cd_item_ctrat
                                                        ,'C'
                                                        ,SYSDATE
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,0
                                                        ,r_estorna_item.vl_lacto
                                                        ,NULL
                                                        ,r_estorna_item.id_lacto
                                                        ,r_estorna_item.tp_pesoa
                                                        ,r_estorna_item.nm_clien_sgrdo
                                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                                        ,r_estorna_item.pc_comis_crtor
                                                        ,r_estorna_item.dt_inico_vigen_segur
                                                        ,p_id_procs_criac
                                                        ,p_estorna_provisao_in.CdUsuario
                                                        ,SYSDATE
                                                        ,NULL
                                                        ,NULL
                                                        ,NULL
                                                        ,r_estorna_item.id_corrl_bus
                                                        ,r_estorna_item.id_prdut_sistm_origm
                                                        ,'A'
                                                        ,p_corretor.cd_sucsl_comrl
                                                        ,p_corretor.cd_diret_comrl
                                                        ,p_corretor.cd_asses);
                                                --
                                        EXCEPTION
                                                --
                                                WHEN OTHERS THEN
                                                        --
                                                        p_cd_erro  := 1;
                                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento de estorno: ' || SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        v_id_lacto := RetornaIdLacto;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Inserindo lanamento].................... ' || v_id_lacto || Chr(10) ||
                                                  '[r_estorna_item.vl_saldo_verba_anter]..... ' || r_estorna_item.vl_saldo_verba_vb ||
                                                  Chr(10) || '[r_estorna_item.vl_saldo_verba_postr]..... ' || v_vl_saldo_verba);
                        --
                        BEGIN
                                --
                                INSERT INTO cta0004_lacto
                                        (id_lacto
                                        ,id_verba
                                        ,cd_situc_lacto
                                        ,cd_ctrat
                                        ,cd_item_ctrat
                                        ,cd_tipo_lacto
                                        ,dt_lacto
                                        ,vl_saldo_verba_anter
                                        ,vl_lacto
                                        ,vl_agrvo_ppota
                                        ,vl_saldo_verba_postr
                                        ,id_lacto_origm_trnsf
                                        ,id_lacto_estor
                                        ,tp_pesoa
                                        ,nm_clien_sgrdo
                                        ,nr_cpf_cnpj_clien
                                        ,vl_prmio_liqui_ppota
                                        ,pc_comis_crtor
                                        ,dt_inico_vigen_segur
                                        ,id_procs_criac
                                        ,cd_usuro_criac
                                        ,dt_criac
                                        ,id_procs_alter
                                        ,cd_usuro_ultma_alter
                                        ,dt_ultma_alter
                                        ,id_corrl_bus
                                        ,id_prdut_sistm_origm
                                        ,tp_desct_agrvo
                                        ,cd_sucsl_comrl
                                        ,cd_diret_comrl
                                        ,cd_asses_atual_crtor)
                                --
                                VALUES
                                        (v_id_lacto
                                        ,r_estorna_item.id_verba
                                        ,'CAN'
                                        ,r_estorna_item.cd_ctrat
                                        ,r_estorna_item.cd_item_ctrat
                                        ,'C'
                                        ,SYSDATE
                                        ,r_estorna_item.vl_saldo_verba_vb
                                        ,r_estorna_item.vl_lacto
                                        ,r_estorna_item.vl_agrvo_ppota
                                        ,v_vl_saldo_verba
                                        ,r_estorna_item.id_lacto_origm_trnsf
                                        ,NULL
                                        ,r_estorna_item.tp_pesoa
                                        ,r_estorna_item.nm_clien_sgrdo
                                        ,r_estorna_item.nr_cpf_cnpj_clien
                                        ,r_estorna_item.vl_prmio_liqui_ppota
                                        ,r_estorna_item.pc_comis_crtor
                                        ,r_estorna_item.dt_inico_vigen_segur
                                        ,p_id_procs_criac
                                        ,p_estorna_provisao_in.CdUsuario
                                        ,SYSDATE
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,r_estorna_item.id_corrl_bus
                                        ,r_estorna_item.id_prdut_sistm_origm
                                        ,r_estorna_item.tp_desct_agrvo
                                        ,p_corretor.cd_sucsl_comrl
                                        ,p_corretor.cd_diret_comrl
                                        ,p_corretor.cd_asses);
                                --
                                CTACTPA0100_001.GravaLog(v_sq_log, '[Inseriu Registro] Contrato = ' || r_estorna_item.cd_ctrat || ' Item = ' ||
                                                          r_estorna_item.cd_item_ctrat);
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Erro ao inserir lanamento] = ' || SQLERRM);
                                        p_cd_erro  := 1;
                                        p_msg_erro := '[Estorna Proviso] - Erro ao criar lanamento: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Atualizando Lanamento ' || r_estorna_item.id_lacto || ' para status EST] = Id Lacto:' ||
                                                  v_id_lacto);
                        --
                        BEGIN
                                --
                                UPDATE cta0004_lacto
                                SET    id_lacto_estor = v_id_lacto
                                      ,cd_situc_lacto = 'EST'
                                WHERE  id_lacto = r_estorna_item.id_lacto;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        CTACTPA0100_001.GravaLog(v_sq_log, '[Erro na atualizao status EST]  ' || SQLERRM);
                                        --
                                        p_cd_erro  := 1;
                                        p_msg_erro := '[Estorna Proviso] - Erro ao atualizar lanamento: ' || SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                END LOOP;
                --
                COMMIT;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        p_cd_erro  := 1;
                        p_msg_erro := '[Estorna Proviso] - Erro Estorna_Provisao_Reprovisiona: ' || SQLERRM;
                        --
        END Estorna_Provisao_Geral;

        --
        --------------------------------------------------------------------------
        --      Estorna_Provisao:       Estornar uma proviso feita             --
        --                              anteriormente.                          --
        --------------------------------------------------------------------------
        --
        PROCEDURE Estorna_Provisao(p_estorna_provisao_in  IN estorna_provisao_in
                                  ,p_estorna_provisao_out OUT estorna_provisao_out) IS
                --
                v_dt_procm             DATE;
                v_cd_segmt_prdut       NUMBER;
                v_qt_dias_estorno      NUMBER;
                v_id_prdut             NUMBER;
                v_cd_erro              NUMBER;
                v_vl_saldo_verba_anter NUMBER;
                v_id_lacto             NUMBER;
                v_id_procs_criac       NUMBER;
                v_msg_erro             VARCHAR2(4000);
                v_InAgravoDesconto     VARCHAR2(4000);
                --
                v_vl_inicl_verba   NUMBER;
                v_vl_prvsn_verba   NUMBER;
                v_vl_saldo_verba   NUMBER;
                v_vl_crdit_agrvo   NUMBER;
                v_id_verba         NUMBER;
                v_vl_eftdo_verba   NUMBER;
                v_vl_lacto         NUMBER;
                v_id_verba_estorno NUMBER;
                --
                v_vl_provisao NUMBER;
                --
                erro_fatal EXCEPTION;
                --
                v_corretor CTACTPA0100_001.t_corretor;
                v_verbas   t_verbas;
                --
        BEGIN
                --
                ------------------------------------------------------------------
                --      Inicializando o type                                    --
                ------------------------------------------------------------------
                --
                p_estorna_provisao_out := estorna_provisao_out(0, NULL);
                --
                ------------------------------------------------------------------
                --      Definindo o valor do agravo / desconto                  --
                ------------------------------------------------------------------
                --
                v_VlAgravoDesconto := Round(p_estorna_provisao_in.VlAgravoDesconto, 2);
                --
                ------------------------------------------------------------------
                --      Iniciando o log                                         --
                ------------------------------------------------------------------
                --
                CTACTPA0100_001.IniciaLog(51, p_estorna_provisao_in.SistemaChamador, p_estorna_provisao_in.CdCorretor, NULL, p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, p_estorna_provisao_in.TpPessoa, p_estorna_provisao_in.CPFCNPJCliente, NULL, p_estorna_provisao_in.CdUsuario, p_estorna_provisao_in.CdProcesso, v_sq_log);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Incio execuo: ' ||
                                          To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '=') || Chr(10) ||
                                          ' Servio Estorna_Provisao. Parmetros de entrada: ' || Chr(10) || ' SistemaChamador........ ' ||
                                          p_estorna_provisao_in.SistemaChamador || Chr(10) || ' CdProduto.............. ' ||
                                          p_estorna_provisao_in.CdProduto || Chr(10) || ' CdCorretor............. ' ||
                                          p_estorna_provisao_in.CdCorretor || Chr(10) || ' CdContrato............. ' ||
                                          p_estorna_provisao_in.CdContrato || Chr(10) || ' CdItemContrato......... ' ||
                                          p_estorna_provisao_in.CdItemContrato || Chr(10) || ' InAgravoDesconto....... ' ||
                                          p_estorna_provisao_in.InAgravoDesconto || Chr(10) || ' VlAgravoDesconto....... ' ||
                                          p_estorna_provisao_in.VlAgravoDesconto || Chr(10) || ' v_VlAgravoDesconto..... ' ||
                                          v_VlAgravoDesconto || Chr(10) || ' TpPessoa............... ' || p_estorna_provisao_in.TpPessoa ||
                                          Chr(10) || ' CPFCNPJCliente......... ' || p_estorna_provisao_in.CPFCNPJCliente || Chr(10) ||
                                          ' CdUsuario.............. ' || p_estorna_provisao_in.CdUsuario || Chr(10) ||
                                          ' CdProcesso............. ' || p_estorna_provisao_in.CdProcesso || Chr(10) ||
                                          ' IdCorrelation.......... ' || p_estorna_provisao_in.IdCorrelation || Chr(10) ||
                                          ' Ambiente.............. ' || CTACTPA0100_001.RetornaParametro('AMBIENTE') || Chr(10) ||
                                          LPad('=', 80, '='));
                --
                ------------------------------------------------------------------
                --      Validando o sistema chamador                            --
                ------------------------------------------------------------------
                --
                IF NOT (CTACTPA0100_001.SistemaChamadorValido(p_estorna_provisao_in.SistemaChamador)) THEN
                        --
                        p_estorna_provisao_out.StRetorno  := 2;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Sistema chamador invlido: ' ||
                                                             p_estorna_provisao_in.SistemaChamador;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Validando o corretor                                    --
                ------------------------------------------------------------------
                --
                IF NOT (CTACTPA0100_001.IsCorretorValido(p_estorna_provisao_in.CdCorretor, v_cd_erro, v_msg_erro)) THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Validando nmero de negcio                             --
                ------------------------------------------------------------------
                --
                IF p_estorna_provisao_in.CdContrato IS NULL THEN
                        --
                        p_estorna_provisao_out.StRetorno  := 15;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Nmero de negcio est nulo';
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Validaes para os processos diferentes de 7 e 36       --
                ------------------------------------------------------------------
                --
                IF p_estorna_provisao_in.CdProcesso NOT IN (3, 4, 7, 36) THEN
                        --
                        ----------------------------------------------------------
                        --      Validando nmero de item                        --
                        ----------------------------------------------------------
                        --
                        IF p_estorna_provisao_in.CdItemContrato IS NULL THEN
                                --
                                p_estorna_provisao_out.StRetorno  := 16;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Nmero de item est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Validando indicador de agravo / desconto        --
                        ----------------------------------------------------------
                        --
                        IF p_estorna_provisao_in.CdProcesso <> 32 THEN
                                --
                                IF Nvl(p_estorna_provisao_in.InAgravoDesconto, 'X') NOT IN ('A', 'D') THEN
                                        --
                                        p_estorna_provisao_out.StRetorno  := 24;
                                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Indicador de desconto / agravo invlido: ' ||
                                                                             Nvl(p_estorna_provisao_in.InAgravoDesconto, 'nulo');
                                        --
                                        RAISE erro_fatal;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Validando valor de agravo / desconto            --
                        ----------------------------------------------------------
                        --
                        IF v_VlAgravoDesconto IS NULL THEN
                                --
                                p_estorna_provisao_out.StRetorno  := 25;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Valor de agravo / desconto est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Validando tipo de pessoa                        --
                        ----------------------------------------------------------
                        --
                        IF Nvl(p_estorna_provisao_in.TpPessoa, 'X') NOT IN ('F', 'J') THEN
                                --
                                p_estorna_provisao_out.StRetorno  := 8;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Tipo de pessoa invlido: ' ||
                                                                     Nvl(p_estorna_provisao_in.TpPessoa, 'nulo');
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Validando CPF / CNPJ do cliente                 --
                        ----------------------------------------------------------
                        --
                        IF p_estorna_provisao_in.CPFCNPJCliente IS NULL THEN
                                --
                                p_estorna_provisao_out.StRetorno  := 9;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - CPF / CNPJ est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        ELSE
                                --
                                IF p_estorna_provisao_in.TpPessoa = 'F' AND
                                   NOT (tms_util.valida_cpf(LPad(p_estorna_provisao_in.CPFCNPJCliente, 11, '0'))) THEN
                                        --
                                        p_estorna_provisao_out.StRetorno  := 9;
                                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - CPF invlido: ' ||
                                                                             p_estorna_provisao_in.CPFCNPJCliente;
                                        --
                                        RAISE erro_fatal;
                                        --
                                ELSIF p_estorna_provisao_in.TpPessoa = 'J' AND
                                      NOT (tms_util.valida_cnpj(LPad(p_estorna_provisao_in.CPFCNPJCliente, 14, '0'))) THEN
                                        --
                                        p_estorna_provisao_out.StRetorno  := 9;
                                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - CNPJ invlido: ' ||
                                                                             p_estorna_provisao_in.CPFCNPJCliente;
                                        --
                                        RAISE erro_fatal;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                        ----------------------------------------------------------
                        --      Validando usurio                               --
                        ----------------------------------------------------------
                        --
                        IF p_estorna_provisao_in.CdUsuario IS NULL THEN
                                --
                                p_estorna_provisao_out.StRetorno  := 10;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Usurio est nulo';
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Validando cdigo de processo                            --
                ------------------------------------------------------------------
                --
                IF Nvl(p_estorna_provisao_in.CdProcesso, 0) NOT IN (03, 04, 07, 24, 25, 32, 33, 36, 65, 66) THEN
                        --
                        p_estorna_provisao_out.StRetorno  := 11;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - Cdigo de processo invlido: ' || p_estorna_provisao_in.CdProcesso;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Busca a data de processamento                           --
                ------------------------------------------------------------------
                --
                v_dt_procm := CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaDtProcm] - ' || v_dt_procm);
                --
                ------------------------------------------------------------------
                --      Valida carga corretores                                 --
                ------------------------------------------------------------------
                --
                IF CTACTPA0100_001.IsSistemaIndisponivel(v_cd_erro, v_msg_erro) THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Busca segmento do produto                               --
                ------------------------------------------------------------------
                --
                v_cd_segmt_prdut := CTACTPA0100_001.RetornaSegmentoProduto(p_estorna_provisao_in.SistemaChamador, p_estorna_provisao_in.CdProduto, v_dt_procm, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaSegmentoProduto] - ' || v_cd_segmt_prdut || ' Sistema Chamador: ' ||
                                          p_estorna_provisao_in.SistemaChamador || ' Produto: ' || p_estorna_provisao_in.CdProduto ||
                                          ' Data Processamento: ' || v_dt_procm);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Validando o mdulo produto                              --
                ------------------------------------------------------------------
                --
                v_id_prdut := CTACTPA0100_001.ModuloProdutoValido(p_estorna_provisao_in.CdProduto, p_estorna_provisao_in.SistemaChamador, v_cd_segmt_prdut, v_dt_procm, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[ModuloProdutoValido] - ' || v_id_prdut || ' Produto: ' || p_estorna_provisao_in.CdProduto ||
                                          ' Sistema Chamador: ' || p_estorna_provisao_in.SistemaChamador || ' Segmento: ' ||
                                          v_cd_segmt_prdut || ' Data Processamento: ' || v_dt_procm);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Buscando o id processo de criao                       --
                ------------------------------------------------------------------
                --
                v_id_procs_criac := CTACTPA0100_001.ValidaCdProcesso(p_estorna_provisao_in.CdProcesso, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[ValidaCdProcesso] - ' || v_id_procs_criac || ' Processo: ' || p_estorna_provisao_in.CdProcesso);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Busca qt_dias_estorno                                   --
                ------------------------------------------------------------------
                --
                v_qt_dias_estorno := CTACTPA0100_001.RetornaQtDiasEstorno(v_cd_segmt_prdut, v_cd_erro, v_msg_erro);
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaQtDiasEstorno] - ' || v_qt_dias_estorno || '  Segmento: ' || v_cd_segmt_prdut);
                --
                IF v_cd_erro <> 0 THEN
                        --
                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                        --
                        RAISE erro_fatal;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Retornando informaes do corretor                      --
                ------------------------------------------------------------------
                --
                CTACTPA0100_001.RetornaDadosCorretor(p_estorna_provisao_in.CdCorretor, v_corretor);
                --
                ------------------------------------------------------------------
                --      Gravando no log as informaes da verba que vai ser     --
                --      estornada.                                              --
                ------------------------------------------------------------------
                --
                ImprimeVerbaAntes(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato, v_dt_procm, v_verbas);
                --
                ------------------------------------------------------------------
                --      Estornando a proviso de acordo com o processo chamador --
                ------------------------------------------------------------------
                --
                IF ProcessoReprovisiona(p_estorna_provisao_in.CdProcesso) THEN
                        --
                        ----------------------------------------------------------
                        --      Processo que estorna a proviso e faz outra     --
                        --      proviso em seguida.                            --
                        ----------------------------------------------------------
                        --
                        Estorna_Provisao_Reprovisiona(p_estorna_provisao_in, v_dt_procm, v_qt_dias_estorno, v_corretor, v_id_procs_criac, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_estorna_provisao_out.StRetorno  := v_cd_erro;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                ELSIF p_estorna_provisao_in.CdProcesso IN (36, 66) THEN
                        --
                        ----------------------------------------------------------
                        --      Valida se a Efetivao j ocorreu.              --
                        ----------------------------------------------------------
                        --
                        IF VerificaSituacaoProvisaoLIB(p_estorna_provisao_in.CdContrato, p_estorna_provisao_in.CdItemContrato) THEN
                                --
                                ----------------------------------------------------------
                                --      Qualquer outro tipo de estorno.                 --
                                ----------------------------------------------------------
                                --
                                Estorna_Provisao_Geral(p_estorna_provisao_in, v_dt_procm, v_qt_dias_estorno, v_corretor, v_id_procs_criac, v_cd_erro, v_msg_erro);
                                --
                                IF v_cd_erro <> 0 THEN
                                        --
                                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                                        --
                                        RAISE erro_fatal;
                                        --
                                END IF;
                                --
                        ELSE
                                --
                                ----------------------------------------------------------
                                --      Processo de endosso por cancelamento tcnico.   --
                                ----------------------------------------------------------
                                --
                                Estorna_Provisao_Endosso(p_estorna_provisao_in, v_dt_procm, v_qt_dias_estorno, v_corretor, v_id_procs_criac, v_cd_erro, v_msg_erro);
                                --
                                IF v_cd_erro <> 0 THEN
                                        --
                                        p_estorna_provisao_out.StRetorno  := v_cd_erro;
                                        p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                                        --
                                        RAISE erro_fatal;
                                        --
                                END IF;
                                --
                        END IF;
                        --
                ELSE
                        --
                        ----------------------------------------------------------
                        --      Qualquer outro tipo de estorno.                 --
                        ----------------------------------------------------------
                        --
                        Estorna_Provisao_Geral(p_estorna_provisao_in, v_dt_procm, v_qt_dias_estorno, v_corretor, v_id_procs_criac, v_cd_erro, v_msg_erro);
                        --
                        IF v_cd_erro <> 0 THEN
                                --
                                p_estorna_provisao_out.StRetorno  := v_cd_erro;
                                p_estorna_provisao_out.MsgRetorno := '[Estorna Proviso] - ' || v_msg_erro;
                                --
                                RAISE erro_fatal;
                                --
                        END IF;
                        --
                END IF;
                --
                ------------------------------------------------------------------
                --      Imprimindo a informao da verba depois do estorno da   --
                --      proviso.                                               --
                ------------------------------------------------------------------
                --
                ImprimeVerbaDepois(v_dt_procm, v_verbas);
                --
                ------------------------------------------------------------------
                --      Finalizando o processamento e o log.                    --
                ------------------------------------------------------------------
                --
                CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de Retorno: ' || p_estorna_provisao_out.StRetorno || ' - Mensagem: ' ||
                                          p_estorna_provisao_out.MsgRetorno || ']');
                --
                CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' ||
                                          To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '='));
                --
                CTACTPA0100_001.FinalizaLog(v_sq_log);
                --
        EXCEPTION
                --
                WHEN erro_fatal THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de Retorno: ' || p_estorna_provisao_out.StRetorno || ' - Mensagem: ' ||
                                                  p_estorna_provisao_out.MsgRetorno || ']');
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' ||
                                                  To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '='));
                        --
                        CTACTPA0100_001.FinalizaLog(v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, 'Erro Estorna_Provisao: ' || SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' ||
                                                  To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '='));
                        --
                        CTACTPA0100_001.FinalizaLog(v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_estorna_provisao_out.StRetorno  := 1;
                        p_estorna_provisao_out.MsgRetorno := 'Erro Estorna_Provisao: ' || SQLERRM;
                        --
        END Estorna_Provisao;

--
END CTACTPA0005_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0006_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        --
        v_sq_log                NUMBER;
        --
        --------------------------------------------------------------------------
        --      ValidaVerbaCorretor:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaCorretor     (p_transfere_verba_corretor_in  IN      transfere_verba_corretor_in
                                                ,p_dt_procs                     IN      DATE
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_id_procs_criac               IN      NUMBER
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_crtor   IS
                --
                SELECT  id_verba,
                        cd_crtor_segur,
                        vl_saldo_verba,
                        cd_tipo_verba,
                        vl_crdto_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_transfere_verba_corretor_in.CdVerbaCorretor
                FOR     UPDATE;
        --
        CURSOR  c_verba_vt_crtor        IS
                --
                SELECT  id_verba,
                        vl_saldo_verba,
                        vl_crdto_verba
                FROM    cta0002_verba
                WHERE   cd_crtor_segur  =       p_transfere_verba_corretor_in.CdCorretorCredito
                AND     cd_tipo_verba   =       'C'
                AND     cd_segmt_prdut  =       p_cd_segmento
                FOR     UPDATE;
                --
        v_count_verba           NUMBER;
        v_id_lacto              NUMBER;
        v_id_lacto_vb           NUMBER;
        v_id_verba              NUMBER;
        --
        v_t_corretor_dbt        ctactpa0100_001.t_corretor;
        v_t_corretor_crd        ctactpa0100_001.t_corretor;
        --
        v_tp_pesoa              cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur        cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor     cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_tp_pesoa_dbt          cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur_dbt    cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor_dbt cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_count_verba
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_transfere_verba_corretor_in.CdVerbaCorretor;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_count_verba   :=      1;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_count_verba   =       0       THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_transfere_verba_corretor_in.CdVerbaCorretor||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;
                --
                IF      p_transfere_verba_corretor_in.CdCorretorDebito  =       p_transfere_verba_corretor_in.CdCorretorCredito THEN
                        --
                        p_cd_erro       :=      93;
                        p_msg_erro      :=      'Cdigo de corretor de dbito e crdito informados so iguais';
                        --
                        RETURN;
                        --
                END     IF;
                --
                --      Retornando as informaes do corretor de debito e credito
                --
                CTACTPA0100_001.RetornaDadosCorretor    (p_transfere_verba_corretor_in.CdCorretorDebito
                                                        ,v_t_corretor_dbt);
                --
                CTACTPA0100_001.RetornaDadosCorretor    (p_transfere_verba_corretor_in.CdCorretorCredito
                                                        ,v_t_corretor_crd);
                --
                FOR     r_verba_crtor   IN      c_verba_crtor   LOOP
                        --
                        IF      r_verba_crtor.cd_crtor_segur    <>      p_transfere_verba_corretor_in.CdCorretorDebito  THEN
                                --
                                p_cd_erro       :=      92;
                                p_msg_erro      :=      'Cdigo de corretor cadastrado para a verba: '||r_verba_crtor.cd_crtor_segur||' diferente do informado: '||p_transfere_verba_corretor_in.CdCorretorDebito;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        IF      v_VlTransferencia       >       r_verba_crtor.vl_saldo_verba    THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_crtor.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        IF      r_verba_crtor.cd_tipo_verba     <>      'C'     THEN
                                --
                                p_cd_erro       :=      94;
                                p_msg_erro      :=      'Tipo de verba cadastrada no  vitalcia';
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Acessando a tabela de corretor para validar o
                        --      corretor de crdito
                        --
                        BEGIN
                                --
                                SELECT  tp_pesoa,
                                        nm_crtor_segur,
                                        nr_cpf_cnpj_crtor
                                INTO    v_tp_pesoa,
                                        v_nm_crtor_segur,
                                        v_nr_cpf_cnpj_crtor
                                FROM    cta0012_crtor
                                WHERE   cd_crtor_segur  =       p_transfere_verba_corretor_in.CdCorretorCredito;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      1;
                                        p_msg_erro      :=      'Erro ao selecionar corretor: '||SQLERRM;
                                        --
                        END;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        BEGIN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Vai inserir lanamento: '||v_id_lacto || ' para a verba ' || r_verba_crtor.id_verba);
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_verba_crtor.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_crtor.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_crtor.vl_saldo_verba   -       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Transf. Corretor: '||v_nm_crtor_segur, 1,      40)
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_id_procs_criac
                                                                ,p_transfere_verba_corretor_in.CdUsuario
                                                                ,SYSDATE
                                                                ,v_t_corretor_crd.cd_sucsl_comrl
                                                                ,v_t_corretor_crd.cd_diret_comrl
                                                                ,v_t_corretor_crd.cd_asses
                                                                ,'D'                                            -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_001 [1]: '||SQLERRM;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   cd_crtor_segur  =       p_transfere_verba_corretor_in.CdCorretorCredito
                                AND     cd_tipo_verba   =       'C'
                                AND     cd_segmt_prdut  =       p_cd_segmento;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        --      Acessando a tabela de corretor para validar o
                        --      corretor de crdito
                        --
                        BEGIN
                                --
                                SELECT  tp_pesoa,
                                        nm_crtor_segur,
                                        nr_cpf_cnpj_crtor
                                INTO    v_tp_pesoa_dbt,
                                        v_nm_crtor_segur_dbt,
                                        v_nr_cpf_cnpj_crtor_dbt
                                FROM    cta0012_crtor
                                WHERE   cd_crtor_segur  =       p_transfere_verba_corretor_in.CdCorretorDebito;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      1;
                                        p_msg_erro      :=      'Erro ao selecionar corretor: '||SQLERRM;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'v_count_verba: '||v_count_verba);

                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                BEGIN
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'Vai inserir verba: '||v_id_verba);
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_crtor_segur
                                                                        ,cd_asses
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba
                                                                        ,dt_ultma_alter)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,p_transfere_verba_corretor_in.CdCorretorCredito
                                                                        ,NULL
                                                                        ,'C'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_VlTransferencia
                                                                        ,p_dt_procs
                                                                        ,To_Date('31/12/2699',  'DD/MM/YYYY')
                                                                        ,r_verba_crtor.id_verba
                                                                        ,p_transfere_verba_corretor_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL
                                                                        ,SYSDATE);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'Vai inserir lanamento: '||v_id_lacto_vb || ' para a verba ' || v_id_verba);
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_asses_atual_crtor
                                                                        ,tp_desct_agrvo)
                                                                        --
                                                                VALUES  (v_id_lacto_vb
                                                                        ,v_id_verba
                                                                        ,'CRD'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,SYSDATE
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,v_id_lacto
                                                                        ,NULL
                                                                        ,v_tp_pesoa_dbt
                                                                        ,SubStr('Transf. Corretor: '||v_nm_crtor_segur_dbt,       1,      40)
                                                                        ,v_nr_cpf_cnpj_crtor_dbt
                                                                        ,0
                                                                        ,0
                                                                        ,NULL
                                                                        ,p_id_procs_criac
                                                                        ,p_transfere_verba_corretor_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,v_t_corretor_dbt.cd_sucsl_comrl
                                                                        ,v_t_corretor_dbt.cd_diret_comrl
                                                                        ,v_t_corretor_dbt.cd_asses
                                                                        ,'A'                                    -- tp_desct_agrvo
                                                                        );
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto [2]: '||SQLERRM;
                                                --
                                END;
                                --
                        ELSE
                                FOR     r_verba_vt_crtor        IN      c_verba_vt_crtor        LOOP
                                        --
                                        --      Criar lanamento de transferncia
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        BEGIN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Vai inserir lanamento: '||v_id_lacto_vb || ' para a verba ' || r_verba_vt_crtor.id_verba);
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,cd_asses_atual_crtor
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb
                                                                                ,r_verba_vt_crtor.id_verba
                                                                                ,'CRD'
                                                                                ,NULL
                                                                                ,NULL
                                                                                ,'T'
                                                                                ,SYSDATE
                                                                                ,r_verba_vt_crtor.vl_saldo_verba
                                                                                ,v_VlTransferencia
                                                                                ,0
                                                                                ,r_verba_vt_crtor.vl_saldo_verba        +       v_VlTransferencia
                                                                                ,v_id_lacto
                                                                                ,NULL
                                                                                ,v_tp_pesoa_dbt
                                                                                ,SubStr('Transf. Corretor: '||v_nm_crtor_segur_dbt,       1,      40)
                                                                                ,v_nr_cpf_cnpj_crtor_dbt
                                                                                ,0
                                                                                ,0
                                                                                ,NULL
                                                                                ,p_id_procs_criac
                                                                                ,p_transfere_verba_corretor_in.CdUsuario
                                                                                ,SYSDATE
                                                                                ,v_t_corretor_dbt.cd_sucsl_comrl
                                                                                ,v_t_corretor_dbt.cd_diret_comrl
                                                                                ,v_t_corretor_dbt.cd_asses
                                                                                ,'A'                    -- tp_desct_agrvo
                                                                                );
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto [3]: '||SQLERRM;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        BEGIN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Vai atualizar verba do cursor c_verba_vt_crtor (credito) - id_verba: ' ||  r_verba_vt_crtor.id_verba || ' vl_crdto_verba antes: '|| r_verba_vt_crtor.vl_crdto_verba || ' vl_saldo_verba antes: ' || r_verba_vt_crtor.vl_saldo_verba || ' vl_transferencia ' || v_VlTransferencia);
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_crdto_verba          =       Nvl(vl_crdto_verba,0)   +       v_VlTransferencia,
                                                        vl_saldo_verba          =       Nvl(vl_saldo_verba,0)   +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_transfere_verba_corretor_in.CdUsuario,
                                                        id_verba_origm_trnsf    =       r_verba_vt_crtor.id_verba
                                                WHERE   CURRENT OF      c_verba_vt_crtor;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Vai atualizar verba do cursor c_verba_crtor (debito) - id_verba: ' ||  r_verba_crtor.id_verba || ' vl_crdto_verba antes: '|| r_verba_crtor.vl_crdto_verba || ' vl_saldo_verba antes: ' || r_verba_crtor.vl_saldo_verba || ' vl_transferencia ' || v_VlTransferencia);

                                UPDATE  cta0002_verba
                                SET     vl_crdto_verba          =       Nvl(vl_crdto_verba,0)   -       v_VlTransferencia,
                                        vl_saldo_verba          =       Nvl(vl_saldo_verba,0)   -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_transfere_verba_corretor_in.CdUsuario
                                WHERE   CURRENT OF      c_verba_crtor;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro ValidaVerbaCorretor: '||SQLERRM;
                        --
        END     ValidaVerbaCorretor;
        --
        --------------------------------------------------------------------------
        --      Transfere_Verba_Corretor:       Transferncia de verba entre    --
        --                                      corretores.                     --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Transfere_Verba_Corretor        (p_transfere_verba_corretor_in  IN      transfere_verba_corretor_in
                                                        ,p_transfere_verba_corretor_out OUT     transfere_verba_corretor_out)   IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_id_procs_criac        NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_transfere_verba_corretor_out  :=      transfere_verba_corretor_out    (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_transfere_verba_corretor_in.VlTransferencia,    2);
                --
                CTACTPA0100_001.IniciaLog       (61
                                                ,p_transfere_verba_corretor_in.SistemaChamador
                                                ,p_transfere_verba_corretor_in.CdCorretorCredito
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_transfere_verba_corretor_in.CdUsuario
                                                ,p_transfere_verba_corretor_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                     ||Chr(10)||
                                                'Servio Consulta_Saldo_Desconto. Parmetros de entrada: '                      ||Chr(10)||
                                                ' SistemaChamador....... '||p_transfere_verba_corretor_in.SistemaChamador       ||Chr(10)||
                                                ' CdSegmento............ '||p_transfere_verba_corretor_in.CdSegmento            ||Chr(10)||
                                                ' CdCorretorCredito..... '||p_transfere_verba_corretor_in.CdCorretorCredito     ||Chr(10)||
                                                ' CdCorretorDebito...... '||p_transfere_verba_corretor_in.CdCorretorDebito      ||Chr(10)||
                                                ' VlTransferencia....... '||p_transfere_verba_corretor_in.VlTransferencia       ||Chr(10)||
                                                ' v_VlTransferencia..... '||v_VlTransferencia                                   ||Chr(10)||
                                                ' CdVerbaCorretor....... '||p_transfere_verba_corretor_in.CdVerbaCorretor       ||Chr(10)||
                                                ' CdUsuario............. '||p_transfere_verba_corretor_in.CdUsuario             ||Chr(10)||
                                                ' CdProcesso............ '||p_transfere_verba_corretor_in.CdProcesso            ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')        ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_transfere_verba_corretor_in.SistemaChamador))      THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      2;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - Sistema chamador invlido: '||p_transfere_verba_corretor_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando Corretor de Crdito
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_transfere_verba_corretor_in.CdCorretorCredito
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      89;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando Corretor de Dbito
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_transfere_verba_corretor_in.CdCorretorDebito
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      90;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida se o corretor de crdito est habilitado
                --
                IF      NOT(CTACTPA0100_001.IsCorretorHabilitado        (p_transfere_verba_corretor_in.CdCorretorCredito
                                                                        ,p_transfere_verba_corretor_in.CdSegmento
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida se o corretor de dbito est habilitado
                --
                IF      NOT(CTACTPA0100_001.IsCorretorHabilitado        (p_transfere_verba_corretor_in.CdCorretorDebito
                                                                        ,p_transfere_verba_corretor_in.CdSegmento
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL
                OR      v_VlTransferencia       =       0       THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      58;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando Verba do Corretor
                --
                IF      p_transfere_verba_corretor_in.CdVerbaCorretor   IS      NULL    THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      91;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - Cdigo de verba do corretor est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --
                --      Validando usurio
                --
                IF      p_transfere_verba_corretor_in.CdUsuario   IS      NULL    THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      10;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_transfere_verba_corretor_in.CdProcesso,     0)    <>      10      THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      11;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - Cdigo de processo invlido: '||p_transfere_verba_corretor_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_transfere_verba_corretor_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_transfere_verba_corretor_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs_criac||' Processo: '||p_transfere_verba_corretor_in.CdProcesso);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                ValidaVerbaCorretor     (p_transfere_verba_corretor_in
                                        ,v_dt_procm
                                        ,p_transfere_verba_corretor_in.CdSegmento
                                        ,v_id_procs_criac
                                        ,p_transfere_verba_corretor_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      v_cd_erro;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      '[Transfere Verba Corretor] - '||v_msg_erro;
                        --
                        ROLLBACK;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_transfere_verba_corretor_out.StRetorno||' - Mensagem: '||p_transfere_verba_corretor_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        p_transfere_verba_corretor_out.StRetorno        :=      1;
                        p_transfere_verba_corretor_out.MsgRetorno       :=      'Erro Transfere_Verba_Corretor: '||SQLERRM;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Transfere_Verba_Corretor: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
        END     Transfere_Verba_Corretor;
        --
END     CTACTPA0006_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0007_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        v_sq_log                NUMBER;


        --
        --------------------------------------------------------------------------
        --      IsRegistroValido:       Verifica se registro nao esta em dupli  --
        --                              cidade com anterior                     --
        --      RETORNA TRUE SE REGISTRO PODE SER INSERIDO                      --
        --      RETORNA FALSE SE REGISTRO E POSSIVEL DUPLICIDADE                --
        --------------------------------------------------------------------------
        --

        FUNCTION        IsRegistroValido        (p_id_corretor  IN      NUMBER
                                                ,p_vl_lacto     IN      NUMBER
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)
        RETURN  BOOLEAN IS

        --
        -- OS 9866
        -- para nao termos mais duplicidade no momento da distribuicao de verba,
        -- sera verificado diferenca de tempo entre ultimo
        -- registro inserido e o que est sendo inserido no momento.
        --

        -- parametro da tabela CTA0008_PARAM_CC com tempo em segundos a somar na data atual
        -- para comparar com data de insero do ultimo registro.
        v_param_periodo_insert  VARCHAR2(10);

        -- sysdate + periodo determinado acima.
        -- para somar os segundos a data atual, usa-se a formula: sysdate + ( v_param_periodo_insert / 86400)
        v_dt_atual_periodo      DATE;

        -- data de ultimo registro inserido para determinado corretor.

        -- parametro com diferenca entre data atual e data de insercao do ultimo registro.
        v_dif_insert            NUMBER;
        --
        -- FIM OS 9866
        --

        v_data_ultima_verba_corretor DATE;

        BEGIN

                BEGIN
                        SELECT  DS_PARAM_CC
                        INTO    v_param_periodo_insert
                        FROM    CTA0008_PARAM_CC
                        WHERE   NM_PARAM_CC = 'TEMPO_MAX_LACTO_DUPL';


                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'periodo aguardo para insert em segundos: ' || v_param_periodo_insert );

                EXCEPTION

                        -- caso nao tenha registro para o parametro
                        -- permite inserir registro, para nao atrapalhar funcionamento
                        -- do processo por causa de duplicidade.

                        WHEN    No_Data_Found THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nao encontrou parametro de tempo para insert: ' || v_param_periodo_insert );

                                RETURN TRUE;

                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar parametro de tempo para insert: ' || SQLERRM );

                                RETURN  TRUE;
                END;


                BEGIN

                        SELECT   Max(lacto.dt_lacto)--lacto.dt_ultma_alter
                        INTO     v_data_ultima_verba_corretor
                        FROM     cta0004_lacto lacto
                        WHERE    lacto.id_verba = (
                                                        SELECT   Max(verba.id_verba)
                                                        FROM     cta0002_verba VERBA
                                                        WHERE    VERBA.cd_crtor_segur = P_ID_CORRETOR
                                                )
                        AND     lacto.vl_lacto  =       p_vl_lacto
                        AND     lacto.cd_situc_lacto NOT IN ('CAN', 'EST');



                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Valor a verificar data de insercao: ' ||   p_vl_lacto  );

                        dbms_output.put_line('v_data_ultima_verba_corretor ' || v_data_ultima_verba_corretor);

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Dta de insercao: ' ||   v_data_ultima_verba_corretor  );

                        v_dt_atual_periodo := v_data_ultima_verba_corretor + (v_param_periodo_insert / 86400 );

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'data ultimo inser + periodo (segundos): ' || To_Char(v_dt_atual_periodo, 'DD/MM/RRRR HH24:MI:SS' ) );

                EXCEPTION

                        --      no_data_found neste caso indica que nao teve nenhum registro de verba anterior que
                        --      possa estar duplicado.

                        WHEN No_Data_Found THEN

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nenhum registro com valor igual ao procurado: ' || p_vl_lacto || ' libera inserir registro' );

                                RETURN TRUE;

                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar registro com base no corretor e valor de lancamento: ' || SQLERRM );

                                RETURN  TRUE;
                END;

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'sysdate: ' || To_Char(sysdate, 'DD/MM/RRRR HH24:MI:SS' ));

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'resultado v_dt_atual_periodo - sysdate se for > 0 erro senao deixa gravar = ' || (Trunc(((v_data_ultima_verba_corretor - SYSDATE )* 100000), 0)) );

                IF    Trunc(((v_dt_atual_periodo - SYSDATE )* 100000), 0) > 0 THEN

                        --
                        p_cd_erro       :=      109;
                        p_msg_erro      :=      'Possivel registro duplicado, verificar.';
                        --

                                                        -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Registro encontrado dentro dos parametros estabelecidos valor: ' || p_vl_lacto || ' corretor: ' || P_ID_CORRETOR );

                        RETURN FALSE;

                ELSE


                                -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Registro fora dos parametros, pode inserir novo registro. ' );


                        RETURN TRUE ;

                END IF;

                EXCEPTION
                WHEN OTHERS THEN
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Erro ao validar isRegistroValido. ' || SQLERRM );


        --
        END     IsRegistroValido;
        --

        --
        --------------------------------------------------------------------------
        --      IsCorretorAssessoria:   Verifica se um determinado corretor    --
        --                              de uma assessoria.                      --
        --------------------------------------------------------------------------
        --
        FUNCTION        IsCorretorAssessoria    (p_cd_crtor     IN      NUMBER
                                                ,p_cd_asses     IN      NUMBER
                                                ,p_cd_segmt     IN      NUMBER
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)
        RETURN  BOOLEAN IS
        --
        v_cd_asses      cta0012_crtor.cd_asses%TYPE;
        v_cd_erro       NUMBER;
        v_msg_erro      VARCHAR2(4000);
        --
        BEGIN
                --
                --      Verifica se o corretor que vai receber a verba est
                --      habilitado para o c/c.
                --
                IF      NOT(CTACTPA0100_001.IsCorretorHabilitado        (p_cd_crtor
                                                                        ,p_cd_segmt
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                        --
                        p_cd_erro       :=      v_cd_erro;
                        p_msg_erro      :=      v_msg_erro;
                        --
                        RETURN  FALSE;
                        --
                END     IF;
                --
                --      Verifica se o corretor que vai receber a verba est
                --      desbloqueado.
                --
                IF      CTACTPA0100_001.IsCorretorBloqueado     (p_cd_crtor
                                                                ,p_cd_segmt
                                                                ,v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_cd_erro       :=      v_cd_erro;
                        p_msg_erro      :=      v_msg_erro;
                        --
                        RETURN  FALSE;
                        --
                END     IF;
                --
                SELECT  Nvl(cd_asses,   0)
                INTO    v_cd_asses
                FROM    cta0012_crtor
                WHERE   cd_crtor_segur  =       p_cd_crtor;
                --
                IF      v_cd_asses      <>      p_cd_asses      THEN
                        --
                        p_cd_erro       :=      105;
                        p_msg_erro      :=      'Corretor: '||p_cd_crtor||' no est vinculado  assessoria: '||p_cd_asses;
                        --
                        RETURN  FALSE;
                        --
                END     IF;
                --
                RETURN  TRUE;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro IsCorretorAssessoria: '||SQLERRM;
                        --
                        RETURN  FALSE;
                        --
        END     IsCorretorAssessoria;
        --
        --------------------------------------------------------------------------
        --      ValidaVerbaAssessoria:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaAssessoria   (p_distribui_verba_assessor_in  IN      distribui_verba_assessoria_in
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_dt_procs                     IN      DATE
                                                ,p_id_procs                     IN      NUMBER
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_assess  IS
                --
                SELECT  id_verba,
                        cd_asses,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_distribui_verba_assessor_in.CdVerbaAssessoria
                FOR     UPDATE;
        --
        CURSOR  c_verba_crtor   IS
                --
                SELECT  id_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_assessor_in.CdVerbaAssessoria
                AND     cd_crtor_segur          =       p_distribui_verba_assessor_in.CdCorretor
                FOR     UPDATE;
        --
        v_cd_erro                       NUMBER;
        v_msg_erro                      VARCHAR2(4000);
        --
        v_id_verba                      NUMBER;
        v_id_lacto                      NUMBER;
        v_id_lacto_vb                   NUMBER;
        v_count_verba                   NUMBER;
        v_cd_asses                      cta0012_crtor.cd_asses%TYPE;
        v_tp_pesoa                      cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur                cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor             cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_t_corretor                    ctactpa0100_001.t_corretor;
        --
        v_cd_sucsl                      NUMBER;
        v_cd_diret                      NUMBER;
        --
        v_tp_pesoa_asses                cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur_asses          cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor_asses       cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        v_dt_inico_vigen                DATE;
        v_dt_fim_vigen                  DATE;

        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  dt_inico_vigen,
                                dt_fim_vigen
                        INTO    v_dt_inico_vigen,
                                v_dt_fim_vigen
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_distribui_verba_assessor_in.CdVerbaAssessoria;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_dt_inico_vigen        :=      NULL;
                                v_dt_fim_vigen          :=      NULL;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_dt_inico_vigen        IS      NULL    THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_distribui_verba_assessor_in.CdVerbaAssessoria||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;
                --
                --      Retornando as informaes do corretor de debito e credito
                --
                CTACTPA0100_001.RetornaDadosCorretor    (p_distribui_verba_assessor_in.CdCorretor
                                                        ,v_t_corretor);
                --
                --      Verificando as informaes da verba encontrada.
                --
                FOR     r_verba_assess  IN      c_verba_assess  LOOP
                        --
                        --      Validando a assessoria cadastrada e enviada
                        --
                        IF      r_verba_assess.cd_asses <>      p_distribui_verba_assessor_in.CdAssessoria      THEN
                                --
                                p_cd_erro       :=      83;
                                p_msg_erro      :=      'Cdigo de assessoria cadastrado para a verba: '||r_verba_assess.cd_asses||' diferente do enviado para o servio: '||p_distribui_verba_assessor_in.CdAssessoria;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Validando o saldo da verba da assessoria
                        --
                        IF      v_VlTransferencia       >       r_verba_assess.vl_saldo_verba   THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_assess.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Acessando a tabela de corretor para validar a assessoria
                        --
                        BEGIN
                                --
                                SELECT  cd_asses,
                                        tp_pesoa,
                                        nm_crtor_segur,
                                        nr_cpf_cnpj_crtor
                                INTO    v_cd_asses,
                                        v_tp_pesoa,
                                        v_nm_crtor_segur,
                                        v_nr_cpf_cnpj_crtor
                                FROM    cta0012_crtor
                                WHERE   cd_crtor_segur  =       p_distribui_verba_assessor_in.CdCorretor;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_cd_asses      :=      0;
                                        --
                        END;
                        --
                        IF      v_cd_asses      <>      p_distribui_verba_assessor_in.CdAssessoria      THEN
                                --
                                p_cd_erro       :=      87;
                                p_msg_erro      :=      'Cdigo de assessoria do corretor: '||v_cd_asses||' divergente do cadastrado para o corretor: '||p_distribui_verba_assessor_in.CdAssessoria;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'* Criando lanamento '||v_id_lacto||' para a verba '||r_verba_assess.id_verba);
                        --
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_verba_assess.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_assess.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_assess.vl_saldo_verba  -       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Distrib. Corretor: '||v_nm_crtor_segur, 1,      40)
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_id_procs
                                                                ,p_distribui_verba_assessor_in.CdUsuario
                                                                ,SYSDATE
                                                                ,v_t_corretor.cd_sucsl_comrl
                                                                ,v_t_corretor.cd_diret_comrl
                                                                ,v_t_corretor.cd_asses
                                                                ,'D'                    -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_001: [Corretor] '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_assessor_in.CdVerbaAssessoria
                                AND     cd_crtor_segur          =       p_distribui_verba_assessor_in.CdCorretor;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Contador de verbas para o corretor: '||p_distribui_verba_assessor_in.CdCorretor||' Segmento '||p_cd_segmento||' Data '||p_dt_procs||' = '||v_count_verba);
                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Criando verba: '||v_id_verba || ' corretor: ' || p_distribui_verba_assessor_in.CdCorretor);
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_crtor_segur
                                                                        ,cd_asses
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba
                                                                        ,dt_ultma_alter)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,p_distribui_verba_assessor_in.CdCorretor
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,v_VlTransferencia
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_dt_inico_vigen
                                                                        ,v_dt_fim_vigen
                                                                        ,r_verba_assess.id_verba
                                                                        ,p_distribui_verba_assessor_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL
                                                                        ,SYSDATE);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                CTACTPA0100_001.RetornaDadosAssessoria  (p_distribui_verba_assessor_in.CdAssessoria
                                                                        ,v_tp_pesoa_asses
                                                                        ,v_nm_crtor_segur_asses
                                                                        ,v_nr_cpf_cnpj_crtor_asses
                                                                        ,v_cd_sucsl
                                                                        ,v_cd_diret
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro);
                                --
                                IF      v_cd_erro       <>      0       THEN
                                        --
                                        p_cd_erro       :=      v_cd_erro;
                                        p_msg_erro      :=      v_msg_erro;
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'* Criando lanamento: '||v_id_lacto_vb);
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_asses_atual_crtor
                                                                        ,tp_desct_agrvo)
                                                                        --
                                                                VALUES  (v_id_lacto_vb
                                                                        ,v_id_verba
                                                                        ,'CRD'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,SYSDATE
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,v_id_lacto
                                                                        ,NULL
                                                                        ,v_tp_pesoa_asses
                                                                        ,SubStr('Distrib. Asses: '||v_nm_crtor_segur_asses,      1,      40)
                                                                        ,v_nr_cpf_cnpj_crtor_asses
                                                                        ,0
                                                                        ,0
                                                                        ,NULL
                                                                        ,p_id_procs
                                                                        ,p_distribui_verba_assessor_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,v_t_corretor.cd_sucsl_comrl
                                                                        ,v_t_corretor.cd_diret_comrl
                                                                        ,v_t_corretor.cd_asses
                                                                        ,'A'            -- tp_desct_agrvo
                                                                        );
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Assessoria] '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSE
                                --
                                FOR     r_verba_crtor   IN      c_verba_crtor   LOOP
                                        --
                                        --      Criar lanamento de transferncia
                                        --
                                        CTACTPA0100_001.RetornaDadosAssessoria  (p_distribui_verba_assessor_in.CdAssessoria
                                                                                ,v_tp_pesoa_asses
                                                                                ,v_nm_crtor_segur_asses
                                                                                ,v_nr_cpf_cnpj_crtor_asses
                                                                                ,v_cd_sucsl
                                                                                ,v_cd_diret
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                                        --
                                        IF      v_cd_erro       <>      0       THEN
                                                --
                                                p_cd_erro       :=      v_cd_erro;
                                                p_msg_erro      :=      v_msg_erro;
                                                --
                                                RETURN;
                                                --
                                        END     IF;
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'* [1] Criando lanamento: '||v_id_lacto_vb || ' Verba :' || r_verba_crtor.id_verba);
                                        --
                                        BEGIN
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,cd_asses_atual_crtor
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb          -- id_lacto
                                                                                ,r_verba_crtor.id_verba -- id_verba
                                                                                ,'CRD'                  -- cd_situc_lacto
                                                                                ,NULL                   -- cd_ctrat
                                                                                ,NULL                   -- cd_item_ctrat
                                                                                ,'T'                    -- cd_tipo_lacto
                                                                                ,SYSDATE                -- dt_lacto
                                                                                ,r_verba_crtor.vl_saldo_verba   -- vl_saldo_verba_anter
                                                                                ,v_VlTransferencia              -- vl_lacto
                                                                                ,0                              -- vl_agrvo_ppota
                                                                                ,r_verba_crtor.vl_saldo_verba   +       v_VlTransferencia
                                                                                ,v_id_lacto
                                                                                ,NULL
                                                                                ,v_tp_pesoa_asses
                                                                                ,SubStr('Distrib. Asses: '||v_nm_crtor_segur_asses,      1,      40)
                                                                                ,v_nr_cpf_cnpj_crtor_asses
                                                                                ,0
                                                                                ,0
                                                                                ,NULL
                                                                                ,p_id_procs
                                                                                ,p_distribui_verba_assessor_in.CdUsuario
                                                                                ,SYSDATE
                                                                                ,v_t_corretor.cd_sucsl_comrl
                                                                                ,v_t_corretor.cd_diret_comrl
                                                                                ,v_t_corretor.cd_asses
                                                                                ,'A'            -- tp_desct_agrvo
                                                                                );
                                                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Assessoria 2] '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[2] Atualizando verba: '||r_verba_assess.id_verba||' '||v_VlTransferencia);
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_inicl_verba          =       vl_inicl_verba  +       v_VlTransferencia,
                                                        vl_saldo_verba          =       vl_saldo_verba  +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_distribui_verba_assessor_in.CdUsuario
                                                WHERE   id_verba                =       r_verba_crtor.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[3] Atualizando verba: '||r_verba_assess.id_verba||' '||v_VlTransferencia);
                                --
                                UPDATE  cta0002_verba
                                SET     vl_eftdo_verba          =       Nvl(vl_eftdo_verba,0)   +       v_VlTransferencia,
                                        vl_saldo_verba          =       vl_saldo_verba          -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_distribui_verba_assessor_in.CdUsuario
                                WHERE   id_verba                =       r_verba_assess.id_verba;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto_vb;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'v_id_lacto_vb: '||v_id_lacto_vb||' p_id_lacto: '||p_id_lacto);
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      86;
                        p_msg_erro      :=      'Erro ValidaVerbaAssessoria: '||SQLERRM;
                        --
        END     ValidaVerbaAssessoria;
        --
        --------------------------------------------------------------------------
        --      Distribui_Verba_Assessoria:     Distribuir as verbas de uma     --
        --                                      assessoria para os corretores   --
        --                                      vinculados  assessoria, ou     --
        --                                      devolver a verba de um corretor --
        --                                      para a assessoria.              --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Distribui_Verba_Assessoria      (p_distribui_verba_assessor_in  IN      distribui_verba_assessoria_in
                                                        ,p_distribui_verba_assessor_out OUT     distribui_verba_assessoria_out) IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_id_procs              NUMBER;

        --
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_distribui_verba_assessor_out  :=      distribui_verba_assessoria_out  (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_distribui_verba_assessor_in.VlTransferencia,    2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (71
                                                ,p_distribui_verba_assessor_in.SistemaChamador
                                                ,p_distribui_verba_assessor_in.CdCorretor
                                                ,p_distribui_verba_assessor_in.CdAssessoria
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_distribui_verba_assessor_in.CPFCNPJAssessoria
                                                ,NULL
                                                ,p_distribui_verba_assessor_in.CdUsuario
                                                ,p_distribui_verba_assessor_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                                                     ||Chr(10)||
                                                'Servio Distribui_Verba_Assessoria. Parmetros de entrada: '                                                      ||Chr(10)||
                                                ' SistemaChamador....... '||p_distribui_verba_assessor_in.SistemaChamador       ||Chr(10)||
                                                ' CdSegmento............ '||p_distribui_verba_assessor_in.CdSegmento            ||Chr(10)||
                                                ' TpTransacao........... '||p_distribui_verba_assessor_in.TpTransacao           ||Chr(10)||
                                                ' CdAssessoria.......... '||p_distribui_verba_assessor_in.CdAssessoria          ||Chr(10)||
                                                ' CPFCNPJAssessoria..... '||p_distribui_verba_assessor_in.CPFCNPJAssessoria     ||Chr(10)||
                                                ' CdCorretor............ '||p_distribui_verba_assessor_in.CdCorretor            ||Chr(10)||
                                                ' VlTransferencia....... '||p_distribui_verba_assessor_in.VlTransferencia       ||Chr(10)||
                                                ' v_VlTransferencia..... '||v_VlTransferencia                                   ||Chr(10)||
                                                ' CdVerbaAssessoria..... '||p_distribui_verba_assessor_in.CdVerbaAssessoria     ||Chr(10)||
                                                ' CdUsuario............. '||p_distribui_verba_assessor_in.CdUsuario             ||Chr(10)||
                                                ' CdProcesso............ '||p_distribui_verba_assessor_in.CdProcesso            ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')        ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_distribui_verba_assessor_in.SistemaChamador))      THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      2;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Sistema chamador invlido: '||p_distribui_verba_assessor_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de transao
                --
                IF      Nvl(p_distribui_verba_assessor_in.TpTransacao,  'X')    NOT     IN      ('T',   'D')    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      79;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Tipo de transao invlido: '||p_distribui_verba_assessor_in.TpTransacao;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria
                --
                IF      p_distribui_verba_assessor_in.CdAssessoria      IS      NULL    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      57;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Cdigo de assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF/CNPJ da assessoria
                --
                IF      p_distribui_verba_assessor_in.CPFCNPJAssessoria IS      NULL    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      80;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - CPF / CNPJ da assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      NOT(tms_util.valida_cpf(LPad(p_distribui_verba_assessor_in.CPFCNPJAssessoria,11,'0')))
                        AND     NOT(tms_util.valida_cnpj(LPad(p_distribui_verba_assessor_in.CPFCNPJAssessoria,14,'0')))      THEN
                                --
                                p_distribui_verba_assessor_out.StRetorno        :=      80;
                                p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - CPF / CNPJ da assessoria invlido: '||p_distribui_verba_assessor_in.CPFCNPJAssessoria;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_distribui_verba_assessor_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL
                OR      v_VlTransferencia       <=      0       THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      58;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o cdigo de verba da assessoria
                --
                IF      p_distribui_verba_assessor_in.CdVerbaAssessoria IS      NULL    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      81;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Cdigo de verba da assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_distribui_verba_assessor_in.CdUsuario   IS      NULL    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      10;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_distribui_verba_assessor_in.CdProcesso,     0)      NOT     IN    (26,    27)     THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      11;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - Cdigo de processo invlido: '||p_distribui_verba_assessor_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_distribui_verba_assessor_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando se o corretor pertence quela assessoria.
                --
                IF      NOT(IsCorretorAssessoria        (p_distribui_verba_assessor_in.CdCorretor
                                                        ,p_distribui_verba_assessor_in.CdAssessoria
                                                        ,p_distribui_verba_assessor_in.CdSegmento
                                                        ,v_cd_erro
                                                        ,v_msg_erro))   THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,v_cd_erro);
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs      :=      CTACTPA0100_001.ValidaCdProcesso        (p_distribui_verba_assessor_in.CdProcesso
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --

                --
                --

                --      Valida registro anterior
                --      OS 9866


                IF      NOT(IsRegistroValido            (p_distribui_verba_assessor_in.CdCorretor
                                                        ,p_distribui_verba_assessor_in.VlTransferencia
                                                        ,v_cd_erro
                                                        ,v_msg_erro))   THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log    ,v_cd_erro);
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria - Registro vlido - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;

                --      FIM OS 9866
                --

                --      Validando a verba da assessoria
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_assessor_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_assessor_out.IdLancamento);
                --
                ValidaVerbaAssessoria   (p_distribui_verba_assessor_in
                                        ,p_distribui_verba_assessor_in.CdSegmento
                                        ,v_dt_procm
                                        ,v_id_procs
                                        ,p_distribui_verba_assessor_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_assessor_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_assessor_out.IdLancamento);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                COMMIT;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'StRetorno: '||p_distribui_verba_assessor_out.StRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'MsgRetorno: '||p_distribui_verba_assessor_out.MsgRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'IdLancamento: '||p_distribui_verba_assessor_out.IdLancamento     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_distribui_verba_assessor_out.StRetorno||' - Mensagem: '||p_distribui_verba_assessor_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Distribui_Verba_Assessoria: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_distribui_verba_assessor_out.StRetorno        :=      1;
                        p_distribui_verba_assessor_out.MsgRetorno       :=      'Erro Distribui_Verba_Assessoria: '||SQLERRM;
                        --
        END     Distribui_Verba_Assessoria;
        --
END     CTACTPA0007_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0008_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        --
        --------------------------------------------------------------------------
        --      ValidaVerbaAssessoria:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaAssessoria   (p_transf_verba_assessorias_in  IN      transf_verba_assessorias_in
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_dt_procs                     IN      DATE
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_assess  IS
                --
                SELECT  id_verba,
                        cd_asses,
                        cd_tipo_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_transf_verba_assessorias_in.CdVerbaAssessoria
                FOR     UPDATE;
        --
        CURSOR  c_verba_crtor   IS
                --
                SELECT  id_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   cd_crtor_segur  =       p_transf_verba_assessorias_in.CdAssessoriaCredito
                AND     cd_tipo_verba   <>      'C'
                AND     cd_segmt_prdut  =       p_cd_segmento
                AND     dt_inico_vigen  <=      p_dt_procs
                AND     dt_fim_vigen    >=      p_dt_procs
                AND     ROWNUM          =       1
                ORDER   BY      Decode(cd_tipo_verba    ,'M'    ,1
                                                        ,'E',   2),
                                dt_fim_vigen    ASC
                FOR     UPDATE;
        --
        v_id_verba                      NUMBER;
        v_id_lacto                      NUMBER;
        v_id_lacto_vb                   NUMBER;
        v_count_verba                   NUMBER;
        v_cd_asses                      cta0012_crtor.cd_asses%TYPE;
        v_tp_pesoa                      cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur                cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor             cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_cd_erro                       NUMBER;
        v_msg_erro                      VARCHAR2(4000);
        --
        v_t_corretor_dbt                ctactpa0100_001.t_corretor;
        --
        v_tp_pesoa_deb                  cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur_deb            cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor_deb         cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_cd_sucsl                      NUMBER;
        v_cd_diret                      NUMBER;
        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_count_verba
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_transf_verba_assessorias_in.CdVerbaAssessoria;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_count_verba   :=      1;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_count_verba   =       0       THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_transf_verba_assessorias_in.CdVerbaAssessoria||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;
                --
                --      Verificando as informaes da verba encontrada.
                --
                FOR     r_verba_assess  IN      c_verba_assess  LOOP
                        --
                        --      Validando a assessoria cadastrada e enviada
                        --
                        IF      r_verba_assess.cd_asses <>      p_transf_verba_assessorias_in.CdAssessoriaDebito        THEN
                                --
                                p_cd_erro       :=      83;
                                p_msg_erro      :=      'Cdigo de assessoria cadastrado para a verba: '||r_verba_assess.cd_asses||' diferente do enviado para o servio: '||p_transf_verba_assessorias_in.CdAssessoriaDebito;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Validando o saldo da verba da assessoria
                        --
                        IF      v_VlTransferencia       >       r_verba_assess.vl_saldo_verba   THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_assess.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        IF      r_verba_assess.cd_tipo_verba    <>      'C'     THEN
                                --
                                p_cd_erro       :=      94;
                                p_msg_erro      :=      'Tipo de verba cadastrada no  vitalcia';
                                --
                                RETURN;
                                --
                        END     IF;
                        IF      p_transf_verba_assessorias_in.cdAssessoriaDebito        =       p_transf_verba_assessorias_in.CdAssessoriaCredito       THEN
                                --
                                p_cd_erro       :=      99;
                                p_msg_erro      :=      'Cdigo de assessoria de dbito e de crdito informados so iguais: '||p_transf_verba_assessorias_in.cdAssessoriaDebito;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        CTACTPA0100_001.RetornaDadosAssessoria  (p_transf_verba_assessorias_in.CdAssessoriaCredito
                                                                ,v_tp_pesoa
                                                                ,v_nm_crtor_segur
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,v_cd_sucsl
                                                                ,v_cd_diret
                                                                ,v_cd_erro
                                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_cd_erro       :=      v_cd_erro;
                                p_msg_erro      :=      v_msg_erro;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_verba_assess.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_assess.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_assess.vl_saldo_verba   +       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Transf. Assessoria: '||v_nm_crtor_segur,       1,      40)
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_transf_verba_assessorias_in.CdProcesso
                                                                ,p_transf_verba_assessorias_in.CdUsuario
                                                                ,SYSDATE
                                                                ,v_cd_sucsl
                                                                ,v_cd_diret
                                                                ,'D'            -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_001 [1]: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   cd_crtor_segur  =       p_transf_verba_assessorias_in.CdAssessoriaCredito
                                AND     cd_segmt_prdut  =       p_cd_segmento
                                AND     dt_inico_vigen  <=      p_dt_procs
                                AND     dt_fim_vigen    >=      p_dt_procs;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_crtor_segur
                                                                        ,cd_asses
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba
                                                                        ,dt_ultma_alter)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,NULL
                                                                        ,p_transf_verba_assessorias_in.CdAssessoriaCredito
                                                                        ,'T'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_VlTransferencia
                                                                        ,p_dt_procs
                                                                        ,To_Date('31/12/2699',  'DD/MM/YYYY')
                                                                        ,r_verba_assess.id_verba
                                                                        ,p_transf_verba_assessorias_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL
                                                                        ,SYSDATE);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                BEGIN
                                        --
                                        SELECT  tp_pesoa,
                                                nm_crtor_segur,
                                                nr_cpf_cnpj_crtor
                                        INTO    v_tp_pesoa_deb,
                                                v_nm_crtor_segur_deb,
                                                v_nr_cpf_cnpj_crtor_deb
                                        FROM    cta0012_crtor
                                        WHERE   cd_crtor_segur  =       p_transf_verba_assessorias_in.CdAssessoriaDebito;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                v_cd_asses      :=      0;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,tp_desct_agrvo)
                                                                        --
                                                                VALUES  (v_id_lacto_vb
                                                                        ,v_id_verba
                                                                        ,'CRD'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,SYSDATE
                                                                        ,v_VlTransferencia
                                                                        ,v_VlTransferencia
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,v_id_lacto
                                                                        ,NULL
                                                                        ,v_tp_pesoa_deb
                                                                        ,'Transf. Assessoria: '||v_nm_crtor_segur_deb
                                                                        ,v_nr_cpf_cnpj_crtor_deb
                                                                        ,0
                                                                        ,0
                                                                        ,NULL
                                                                        ,p_transf_verba_assessorias_in.CdProcesso
                                                                        ,p_transf_verba_assessorias_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,v_cd_sucsl
                                                                        ,v_cd_diret
                                                                        ,'A'            -- tp_desct_agrvo
                                                                        );
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto [2]: '||SQLERRM;
                                                --
                                END;
                                --
                        ELSE
                                --
                                FOR     r_verba_crtor   IN      c_verba_crtor   LOOP
                                        --
                                        --      Criar lanamento de transferncia
                                        --
                                        BEGIN
                                                --
                                                SELECT  tp_pesoa,
                                                        nm_crtor_segur,
                                                        nr_cpf_cnpj_crtor
                                                INTO    v_tp_pesoa_deb,
                                                        v_nm_crtor_segur_deb,
                                                        v_nr_cpf_cnpj_crtor_deb
                                                FROM    cta0012_crtor
                                                WHERE   cd_crtor_segur  =       p_transf_verba_assessorias_in.CdAssessoriaDebito;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_asses      :=      0;
                                                        --
                                        END;
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        BEGIN
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb
                                                                                ,r_verba_crtor.id_verba
                                                                                ,'CRD'
                                                                                ,NULL
                                                                                ,NULL
                                                                                ,'T'
                                                                                ,SYSDATE
                                                                                ,r_verba_crtor.vl_saldo_verba
                                                                                ,v_VlTransferencia
                                                                                ,0
                                                                                ,r_verba_crtor.vl_saldo_verba   +       v_VlTransferencia
                                                                                ,v_id_lacto
                                                                                ,NULL
                                                                                ,v_tp_pesoa_deb
                                                                                ,'Transf. Assessoria: '||v_nm_crtor_segur_deb
                                                                                ,v_nr_cpf_cnpj_crtor_deb
                                                                                ,0
                                                                                ,0
                                                                                ,NULL
                                                                                ,p_transf_verba_assessorias_in.CdProcesso
                                                                                ,p_transf_verba_assessorias_in.CdUsuario
                                                                                ,SYSDATE
                                                                                ,v_cd_sucsl
                                                                                ,v_cd_diret
                                                                                ,'A'            -- tp_desct_agrvo
                                                                                );
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto [3]: '||SQLERRM;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_crdto_verba          =       vl_crdto_verba  +       v_VlTransferencia,
                                                        vl_saldo_verba          =       vl_saldo_verba  +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_transf_verba_assessorias_in.CdUsuario,
                                                        id_verba_origm_trnsf    =       r_verba_assess.id_verba
                                                WHERE   id_verba                =       r_verba_crtor.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                UPDATE  cta0002_verba
                                SET     vl_crdto_verba          =       vl_crdto_verba  -       v_VlTransferencia,
                                        vl_saldo_verba          =       vl_saldo_verba  -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_transf_verba_assessorias_in.CdUsuario
                                WHERE   id_verba                =       r_verba_assess.id_verba;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      86;
                        p_msg_erro      :=      'Erro ValidaVerbaAssessoria: '||SQLERRM;
                        --
        END     ValidaVerbaAssessoria;
        --
        --------------------------------------------------------------------------
        --      Transfere_Verba_Assessorias:    Distribuir as verbas de uma     --
        --                                      assessoria para outra.          --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Transfere_Verba_Assessorias     (p_transf_verba_assessorias_in  IN      transf_verba_assessorias_in
                                                        ,p_transf_verba_assessorias_out OUT     transf_verba_assessorias_out)   IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        v_sq_log                NUMBER;
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_transf_verba_assessorias_out  :=      transf_verba_assessorias_out    (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_transf_verba_assessorias_in.VlTransferencia,    2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (81
                                                ,p_transf_verba_assessorias_in.SistemaChamador
                                                ,NULL
                                                ,p_transf_verba_assessorias_in.CdAssessoriaCredito
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito
                                                ,NULL
                                                ,p_transf_verba_assessorias_in.CdUsuario
                                                ,p_transf_verba_assessorias_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                                                     ||Chr(10)||
                                                ' SistemaChamador............. '||p_transf_verba_assessorias_in.SistemaChamador                 ||Chr(10)||
                                                ' CdSegmento.................. '||p_transf_verba_assessorias_in.CdSegmento                      ||Chr(10)||
                                                ' CdAssessoriaCredito......... '||p_transf_verba_assessorias_in.CdAssessoriaCredito             ||Chr(10)||
                                                ' CPFCNPJAssessoriaCredito.... '||p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito        ||Chr(10)||
                                                ' CdAssessoriaDebito.......... '||p_transf_verba_assessorias_in.CdAssessoriaDebito              ||Chr(10)||
                                                ' CPFCNPJAssessoriaDebito..... '||p_transf_verba_assessorias_in.CPFCNPJAssessoriaDebito         ||Chr(10)||
                                                ' VlTransferencia............. '||p_transf_verba_assessorias_in.VlTransferencia                 ||Chr(10)||
                                                ' v_VlTransferencia........... '||v_VlTransferencia                                             ||Chr(10)||
                                                ' CdVerbaAssessoria........... '||p_transf_verba_assessorias_in.CdVerbaAssessoria               ||Chr(10)||
                                                ' CdUsuario................... '||p_transf_verba_assessorias_in.CdUsuario                       ||Chr(10)||
                                                ' CdProcesso.................. '||p_transf_verba_assessorias_in.CdProcesso                      ||Chr(10)||
                                                ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')                  ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_transf_verba_assessorias_in.SistemaChamador))      THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      2;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Sistema chamador invlido: '||p_transf_verba_assessorias_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria de crdito
                --
                IF      p_transf_verba_assessorias_in.CdAssessoriaCredito       IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      95;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Cdigo de assessoria de crdito est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF/CNPJ da assessoria de crdito
                --
                IF      p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito  IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      96;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - CPF / CNPJ da assessoria de crdito est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      NOT(tms_util.valida_cpf(LPad(p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito,11,'0')))
                        AND     NOT(tms_util.valida_cnpj(LPad(p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito,14,'0')))       THEN
                                --
                                p_transf_verba_assessorias_out.StRetorno        :=      96;
                                p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - CPF / CNPJ da assessoria de crdito invlido: '||p_transf_verba_assessorias_in.CPFCNPJAssessoriaCredito;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando a assessoria de crdito
                --
                IF      p_transf_verba_assessorias_in.CdAssessoriaCredito       IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      95;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Cdigo de assessoria de crdito est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria de crdito
                --
                IF      p_transf_verba_assessorias_in.CdAssessoriaDebito        IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      97;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Cdigo de assessoria de dbito est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF/CNPJ da assessoria de crdito
                --
                IF      p_transf_verba_assessorias_in.CPFCNPJAssessoriaDebito   IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      98;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - CPF / CNPJ da assessoria de dbito est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      NOT(tms_util.valida_cpf(LPad(p_transf_verba_assessorias_in.CPFCNPJAssessoriaDebito,11,'0')))
                        AND     NOT(tms_util.valida_cnpj(LPad(p_transf_verba_assessorias_in.CPFCNPJAssessoriaDebito,14,'0')))        THEN
                                --
                                p_transf_verba_assessorias_out.StRetorno        :=      98;
                                p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - CPF / CNPJ da assessoria de dbito invlido: '||p_transf_verba_assessorias_in.CPFCNPJAssessoriaDebito;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL
                OR      v_VlTransferencia       =       0       THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      58;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o cdigo de verba da assessoria
                --
                IF      p_transf_verba_assessorias_in.CdVerbaAssessoria IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      81;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Cdigo de verba da assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_transf_verba_assessorias_in.CdUsuario   IS      NULL    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      10;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_transf_verba_assessorias_in.CdProcesso,     0)      NOT     IN    (28)    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      11;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - Cdigo de processo invlido: '||p_transf_verba_assessorias_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm]: '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      v_cd_erro;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_transf_verba_assessorias_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      v_cd_erro;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Transferindo a verba da assessoria
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_transf_verba_assessorias_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Id Lanamento: '||p_transf_verba_assessorias_out.IdLancamento);
                --
                ValidaVerbaAssessoria   (p_transf_verba_assessorias_in
                                        ,p_transf_verba_assessorias_in.CdSegmento
                                        ,v_dt_procm
                                        ,p_transf_verba_assessorias_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      v_cd_erro;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      '[Transfere Verba Assessorias] - '||v_msg_erro;
                        p_transf_verba_assessorias_out.IdLancamento     :=      NULL;
                        --
                        ROLLBACK;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Se no deu nenhum erro, commitar o registro
                --
                COMMIT;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'IdLancamento: '||p_transf_verba_assessorias_out.IdLancamento);
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_transf_verba_assessorias_out.StRetorno||' - Mensagem: '||p_transf_verba_assessorias_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_transf_verba_assessorias_out.StRetorno        :=      1;
                        p_transf_verba_assessorias_out.MsgRetorno       :=      'Erro Distribui_Verba_Assessoria: '||SQLERRM;
                        --
        END     Transfere_Verba_Assessorias;
        --
END     CTACTPA0008_001;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0009_001 IS

    --
    v_VlTransferencia NUMBER(15, 2);

    --
    --------------------------------------------------------------------------
    --      ExisteIdArquivo:        Verifica se o id arquivo passado para   --
    --                              o servio existe nas bases do conta     --
    --                              corrente;
    --------------------------------------------------------------------------
    --
    FUNCTION ExisteIdArquivo(p_id_arquivo IN NUMBER
                            ,p_cd_erro    OUT NUMBER
                            ,p_msg_erro   OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_id_arquv_carga cta0013_arquv_carga.id_arquv_carga%TYPE;
        --
    BEGIN
        --
        SELECT id_arquv_carga
        INTO   v_id_arquv_carga
        FROM   cta0013_arquv_carga
        WHERE  id_arquv_carga = p_id_arquivo;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 74;
            p_msg_erro := 'Id arquivo de carga: ' || p_id_arquivo || ' no encontrado.';
            --
            RETURN FALSE;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 75;
            p_msg_erro := 'Erro ExisteIdArquivo: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ExisteIdArquivo;

    --
    --------------------------------------------------------------------------
    --      ExisteCdSegmento:       Verifica se o segmento passado para     --
    --                              o servio existe nas bases do conta     --
    --                              corrente;
    --------------------------------------------------------------------------
    --
    FUNCTION ExisteCdSegmento(p_cd_segmento IN NUMBER
                             ,p_cd_erro     OUT NUMBER
                             ,p_msg_erro    OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_cd_segmt_prdut cta0006_segmt_prdut.cd_segmt_prdut%TYPE;
        --
    BEGIN
        --
        SELECT cd_segmt_prdut
        INTO   v_cd_segmt_prdut
        FROM   cta0006_segmt_prdut
        WHERE  cd_segmt_prdut = p_cd_segmento;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 76;
            p_msg_erro := 'Cdigo de segmento no encontrado: ' || p_cd_segmento;
            --
            RETURN FALSE;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 77;
            p_msg_erro := 'Erro ExisteCdSegmento: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ExisteCdSegmento;

    --
    ---------------------------------------------------------------------------
    --      validaInicioVigencia:   Verifica se a data de inicio de vigencia --
    --                              est dentro do permitido para o corretor --
    ---------------------------------------------------------------------------
    --
    FUNCTION ValidaInicioVigencia(P_CD_CORRETOR        IN NUMBER
                                 ,P_DT_INICIO_VIGENCIA IN DATE
                                 ,P_CD_ERRO            OUT NUMBER
                                 ,P_MSG_ERRO           OUT VARCHAR2
                                 ,P_DT_RETROATIVA      OUT DATE) RETURN BOOLEAN IS
        --
        V_QT_DIAS_RETROATIVO     NUMBER;
        V_DT_ATUAL               DATE;
        V_CORRETORES_CADASTRADOS VARCHAR2(4000);
        --
    BEGIN
        --
        V_QT_DIAS_RETROATIVO := 0;
        V_DT_ATUAL           := TRUNC(SYSDATE);
        P_DT_RETROATIVA      := TRUNC(SYSDATE);
        --
        SELECT ';' || DS_PARAM_CC || ';' AS DS_PARAM_CC
        INTO   V_CORRETORES_CADASTRADOS
        FROM   CTA0008_PARAM_CC
        WHERE  NM_PARAM_CC = 'CORRETORES_INC_VERBA'
        AND    CD_SEGMT_PRDUT = 1;
        --
        IF INSTR(V_CORRETORES_CADASTRADOS, (';' || P_CD_CORRETOR || ';')) > 0 THEN
            --
            SELECT DS_PARAM_CC
            INTO   V_QT_DIAS_RETROATIVO
            FROM   CTA0008_PARAM_CC
            WHERE  NM_PARAM_CC = 'QT_DIA_VIGEN_RETRO'
            AND    CD_SEGMT_PRDUT = 1;
            --
            IF V_QT_DIAS_RETROATIVO IS NOT NULL AND
               V_QT_DIAS_RETROATIVO > 0 THEN
                --
                P_DT_RETROATIVA := (V_DT_ATUAL - V_QT_DIAS_RETROATIVO);
                --
                IF P_DT_RETROATIVA <= P_DT_INICIO_VIGENCIA THEN
                    --
                    RETURN TRUE;
                    --
                ELSE
                    --
                    RETURN FALSE;
                    --
                END IF;
                --
            ELSE
                --
                IF V_DT_ATUAL <= P_DT_INICIO_VIGENCIA THEN
                    --
                    RETURN TRUE;
                    --
                ELSE
                    --
                    RETURN FALSE;
                    --
                END IF;
                --
            END IF;
            --
        ELSE
            --
            IF V_DT_ATUAL <= P_DT_INICIO_VIGENCIA THEN
                --
                RETURN TRUE;
                --
            ELSE
                --
                RETURN FALSE;
                --
            END IF;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 77;
            p_msg_erro := 'Erro ValidaInicioVigencia: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ValidaInicioVigencia;

    --
    --------------------------------------------------------------------------
    --      Credita_Verba_Carteira: Efetuar o crdito de verba pela rea de --
    --                              produto.                                --
    --------------------------------------------------------------------------
    --
    PROCEDURE Credita_Verba_Carteira(p_credita_verba_carteira_in  IN credita_verba_carteira_in
                                    ,p_credita_verba_carteira_out OUT credita_verba_carteira_out) IS
        --
        v_dt_procm             DATE;
        v_dt_fim_vigen_verba   DATE;
        v_dt_inico_vigen_verba DATE;
        v_dt_inico_vigen       DATE;
        --
        v_cd_erro        NUMBER;
        v_id_verba       NUMBER;
        v_id_lacto       NUMBER;
        v_id_procs_criac NUMBER;
        v_msg_erro       VARCHAR2(4000);
        --
        v_sq_log NUMBER;
        erro_fatal EXCEPTION;
        --
        v_t_corretor ctactpa0100_001.t_corretor;
        --
    BEGIN
        --
        --      Inicializando o type
        --
        p_credita_verba_carteira_out := credita_verba_carteira_out(0, NULL);
        --
        v_VlTransferencia := Round(p_credita_verba_carteira_in.VlTransferencia, 2);
        --
        --      Verificando se deve debugar o item / cpf
        --
        CTACTPA0100_001.IniciaLog(91, p_credita_verba_carteira_in.SistemaChamador, p_credita_verba_carteira_in.CdCorretor, p_credita_verba_carteira_in.CdAssessoria, NULL, NULL, NULL, NULL, NULL, p_credita_verba_carteira_in.CdUsuario, p_credita_verba_carteira_in.CdProcesso, v_sq_log);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Incio execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') ||
                                  Chr(10) || LPad('=', 80, '=') || Chr(10) || 'Servio Credita_Verba_Carteira. Parmetros de entrada: ' ||
                                  Chr(10) || ' SistemaChamador............. ' || p_credita_verba_carteira_in.SistemaChamador || Chr(10) ||
                                  ' CdSegmento.................. ' || p_credita_verba_carteira_in.CdSegmento || Chr(10) ||
                                  ' IdArquivoCarga.............. ' || p_credita_verba_carteira_in.IdArquivoCarga || Chr(10) ||
                                  ' CdCorretor.................. ' || p_credita_verba_carteira_in.CdCorretor || Chr(10) ||
                                  ' CdAssessoria................ ' || p_credita_verba_carteira_in.CdAssessoria || Chr(10) ||
                                  ' VlTransferencia............. ' || p_credita_verba_carteira_in.VlTransferencia || Chr(10) ||
                                  ' v_VlTransferencia........... ' || v_VlTransferencia || Chr(10) || ' DtInicioVigenciaVerba....... ' ||
                                  p_credita_verba_carteira_in.DtInicioVigenciaVerba || Chr(10) || ' DtFimVigenciaVerba.......... ' ||
                                  p_credita_verba_carteira_in.DtFimVigenciaVerba || Chr(10) || ' CdUsuario................... ' ||
                                  p_credita_verba_carteira_in.CdUsuario || Chr(10) || ' CdProcesso.................. ' ||
                                  p_credita_verba_carteira_in.CdProcesso || Chr(10) || ' Ambiente.................... ' ||
                                  CTACTPA0100_001.RetornaParametro('AMBIENTE') || Chr(10) || LPad('=', 80, '='));
        --
        --      Validando o sistema chamador
        --
        IF NOT (CTACTPA0100_001.SistemaChamadorValido(p_credita_verba_carteira_in.SistemaChamador)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 2;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Sistema chamador invlido: ' ||
                                                       p_credita_verba_carteira_in.SistemaChamador;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando o segmento
        --
        IF p_credita_verba_carteira_in.CdSegmento IS NULL THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 55;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Valor do cdigo segmento est nulo';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando valor do crdito
        --
        IF v_VlTransferencia IS NULL OR
           v_VlTransferencia = 0 THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 58;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Valor do crdito invlido: ' || v_VlTransferencia;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando data de incio de vigncia da verba
        --
        IF p_credita_verba_carteira_in.DtInicioVigenciaVerba IS NULL OR
           NOT (CTACTPA0100_001.IsDataValida(p_credita_verba_carteira_in.DtInicioVigenciaVerba, v_dt_inico_vigen_verba)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 59;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Data de incio vigncia da verba invlida: ' ||
                                                       p_credita_verba_carteira_in.DtInicioVigenciaVerba;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando data de fim de vigncia da verba
        --
        IF p_credita_verba_carteira_in.DtFimVigenciaVerba IS NULL OR
           NOT (CTACTPA0100_001.IsDataValida(p_credita_verba_carteira_in.DtFimVigenciaVerba, v_dt_fim_vigen_verba)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 60;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Data de incio vigncia da verba invlida: ' ||
                                                       p_credita_verba_carteira_in.DtFimVigenciaVerba;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando usurio
        --
        IF p_credita_verba_carteira_in.CdUsuario IS NULL THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 10;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Usurio est nulo';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando cdigo de processo
        --
        IF Nvl(p_credita_verba_carteira_in.CdProcesso, 0) <> 11 THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 11;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Cdigo de processo invlido: ' ||
                                                       p_credita_verba_carteira_in.CdProcesso;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        IF p_credita_verba_carteira_in.CdCorretor IS NOT NULL THEN
            --
            IF NOT (CTACTPA0100_001.IsCorretorValido(p_credita_verba_carteira_in.CdCorretor, v_cd_erro, v_msg_erro)) THEN
                --
                p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
                p_credita_verba_carteira_out.MsgRetorno := v_msg_erro;
                --
                RAISE erro_fatal;
                --
            END IF;
            --
        END IF;
        --
        --      Recebendo o id_procs_criac
        --
        v_id_procs_criac := CTACTPA0100_001.ValidaCdProcesso(p_credita_verba_carteira_in.CdProcesso, v_cd_erro, v_msg_erro);
        --
        IF v_cd_erro <> 0 THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Busca a data de processamento.
        --
        v_dt_procm := CTACTPA0100_001.RetornaDtProcm;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[RetornaDtProcm] - ' || v_dt_procm);
        --
        --      Valida sistema indisponvel
        --
        IF CTACTPA0100_001.IsSistemaIndisponivel(v_cd_erro, v_msg_erro) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando o cdigo de corretor e cdigo de assessoria
        --
        IF p_credita_verba_carteira_in.CdCorretor = 0 AND
           p_credita_verba_carteira_in.CdAssessoria = 0 THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 61;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Cdigo de corretor e cdigo de assessoria esto zerados';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        IF p_credita_verba_carteira_in.CdCorretor <> 0 AND
           p_credita_verba_carteira_in.CdAssessoria <> 0 THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 62;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Cdigo de corretor e cdigo de assessoria esto diferente de zeros';
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validando se o corretor est cadastrado
        --
        IF Nvl(p_credita_verba_carteira_in.CdCorretor, 0) <> 0 AND
           NOT (CTACTPA0100_001.ExisteCorretor(p_credita_verba_carteira_in.CdCorretor, v_cd_erro, v_msg_erro)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Verificando se o corretor est habilitado
        --
        IF p_credita_verba_carteira_in.CdCorretor <> 0 THEN
            --
            IF NOT
                (CTACTPA0100_001.IsCorretorHabilitado(p_credita_verba_carteira_in.CdCorretor, p_credita_verba_carteira_in.CdSegmento, v_cd_erro, v_msg_erro)) THEN
                --
                p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
                p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
                --
                RAISE erro_fatal;
                --
            END IF;
            --
        END IF;
        --
        --      Verificando se a assessoria est ativa
        --
        IF p_credita_verba_carteira_in.CdAssessoria <> 0 AND
           NOT (CTACTPA0100_001.IsAssessoriaAtiva(p_credita_verba_carteira_in.CdAssessoria, v_cd_erro, v_msg_erro)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validar se a data de incio de vigncia  menor que
        --      a data de processamento ou se o corretor est cadastrado
        --      para com uma data de inicio de vigencia retroativa menor que a data informada.
        --
        IF NOT ValidaInicioVigencia(p_credita_verba_carteira_in.CdCorretor --
                                   , v_dt_inico_vigen_verba --
                                   , v_cd_erro --
                                   , v_msg_erro --
                                   , v_dt_inico_vigen) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 72;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Data de incio de vigncia: ' ||
                                                       To_Char(v_dt_inico_vigen_verba, 'DD/MM/YYYY') ||
                                                       ' est menor que a data de inicio de vigencia vlida: ' ||
                                                       To_Char(v_dt_inico_vigen, 'DD/MM/YYYY');
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --      Validar se a data de fim de vigncia  menor que
        --      a data de processamento.
        --
        IF v_dt_fim_vigen_verba < v_dt_procm THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 73;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Data de fim de vigncia: ' ||
                                                       To_Char(v_dt_fim_vigen_verba, 'DD/MM/YYYY') || ' est menor que a data de processamento: ' ||
                                                       To_Char(v_dt_procm, 'DD/MM/YYYY');
            --
        END IF;
        --
        IF v_dt_fim_vigen_verba > To_Date('31/12/2699', 'DD/MM/YYYY') THEN
            --
            p_credita_verba_carteira_out.StRetorno  := 73;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Data de fim de vigncia: ' ||
                                                       To_Char(v_dt_fim_vigen_verba, 'DD/MM/YYYY');
            --
        END IF;
        --
        IF p_credita_verba_carteira_in.IdArquivoCarga <> 0 AND
           NOT (ExisteIdArquivo(p_credita_verba_carteira_in.IdArquivoCarga, v_cd_erro, v_msg_erro)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        IF NOT (ExisteCdSegmento(p_credita_verba_carteira_in.CdSegmento, v_cd_erro, v_msg_erro)) THEN
            --
            p_credita_verba_carteira_out.StRetorno  := v_cd_erro;
            p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - ' || v_msg_erro;
            --
            RAISE erro_fatal;
            --
        END IF;
        --
        --
        --
        ctactpa0100_001.RetornaDadosCorretor(p_credita_verba_carteira_in.CdCorretor, v_t_corretor);
        --
        --      Inserindo verba
        --
        BEGIN
            --
            SELECT ctasq0002_verba.NEXTVAL
            INTO   v_id_verba
            FROM   dual;
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                p_credita_verba_carteira_out.StRetorno  := 78;
                p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Erro ao buscar sequencia ctasq0002_verba: ' || SQLERRM;
                --
                RAISE erro_fatal;
                --
        END;
        --
        BEGIN
            --
            INSERT INTO cta0002_verba
                (id_verba
                ,cd_segmt_prdut
                ,cd_crtor_segur
                ,cd_asses
                ,cd_tipo_verba
                ,vl_inicl_verba
                ,vl_prvsn_verba
                ,vl_eftdo_verba
                ,vl_crdto_verba
                ,vl_saldo_verba
                ,dt_inico_vigen
                ,dt_fim_vigen
                ,id_verba_origm_trnsf
                ,cd_usuro_ultma_alter
                ,cd_situc_verba
                ,id_arquv_carga_verba
                ,dt_ultma_alter)
            --
            VALUES
                (v_id_verba
                ,p_credita_verba_carteira_in.CdSegmento
                ,Decode(p_credita_verba_carteira_in.CdCorretor, 0, NULL, p_credita_verba_carteira_in.CdCorretor)
                ,Decode(p_credita_verba_carteira_in.CdAssessoria, 0, NULL, p_credita_verba_carteira_in.CdAssessoria)
                ,'T'
                ,v_VlTransferencia
                ,NULL
                ,NULL
                ,NULL
                ,v_VlTransferencia
                ,v_dt_inico_vigen_verba
                ,v_dt_fim_vigen_verba
                ,NULL
                ,p_credita_verba_carteira_in.CdUsuario
                ,'ATI'
                ,Decode(p_credita_verba_carteira_in.IdArquivoCarga, 0, NULL, p_credita_verba_carteira_in.IdArquivoCarga)
                ,SYSDATE);
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                p_credita_verba_carteira_out.StRetorno  := 78;
                p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Erro ao inserir tabela cta0002_verba: ' || SQLERRM;
                --
                ROLLBACK;
                --
                RAISE erro_fatal;
                --
        END;
        --
        --      Inserindo o lanamento da verba
        --
        BEGIN
            --
            SELECT ctasq0004_lacto.NEXTVAL
            INTO   v_id_lacto
            FROM   dual;
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                p_credita_verba_carteira_out.StRetorno  := 41;
                p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Erro ao buscar sequencia ctasq0004_lacto: ' || SQLERRM;
                --
                RAISE erro_fatal;
                --
        END;
        --
        BEGIN
            --
            INSERT INTO cta0004_lacto
                (id_lacto
                ,id_verba
                ,cd_situc_lacto
                ,cd_ctrat
                ,cd_item_ctrat
                ,cd_tipo_lacto
                ,dt_lacto
                ,vl_saldo_verba_anter
                ,vl_lacto
                ,vl_agrvo_ppota
                ,vl_saldo_verba_postr
                ,id_lacto_origm_trnsf
                ,id_lacto_estor
                ,tp_pesoa
                ,nm_clien_sgrdo
                ,nr_cpf_cnpj_clien
                ,vl_prmio_liqui_ppota
                ,pc_comis_crtor
                ,dt_inico_vigen_segur
                ,id_procs_criac
                ,cd_usuro_criac
                ,dt_criac
                ,dt_ultma_alter
                ,cd_sucsl_comrl
                ,cd_diret_comrl
                ,tp_desct_agrvo)
            --
            VALUES
                (v_id_lacto --      id_lacto
                ,v_id_verba --      id_verba
                ,'CRD' --      cd_situc_lacto
                ,NULL --      cd_ctrat
                ,NULL --      cd_item_ctrat
                ,'G' --      cd_tipo_lacto
                ,SYSDATE --      dt_lacto
                ,0 --      vl_saldo_verba_anter
                ,v_VlTransferencia --      vl_lacto
                ,0 --      vl_agrvo_ppota
                ,v_VlTransferencia --      vl_saldo_verba_postr
                ,NULL --      id_lacto_origm_trnsf
                ,NULL --      id_lacto_estor
                ,NULL --      tp_pesoa
                ,'Creditado pela rea de Produto' --      nm_clien_sgrdo
                ,NULL --      nr_cpf_cnpj_clien
                ,0 --      vl_prmio_liqui_ppota
                ,0 --      pc_comis_crtor
                ,NULL --      dt_inico_vigen_segur
                ,v_id_procs_criac --      id_procs_criac
                ,p_credita_verba_carteira_in.CdUsuario --      cd_usuro_criac
                ,SYSDATE --      dt_criac
                ,SYSDATE --      dt_ultma_alter
                ,v_t_corretor.cd_sucsl_comrl --      cd_sucsl_comrl
                ,v_t_corretor.cd_diret_comrl --      cd_diret_comrl
                ,'A' --      tp_desct_agrvo
                 );
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                p_credita_verba_carteira_out.StRetorno  := 41;
                p_credita_verba_carteira_out.MsgRetorno := '[Credita Verba Carteira] - Erro ao inserir tabela cta0004_lacto: ' || SQLERRM;
                --
                RAISE erro_fatal;
                --
        END;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' || To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') ||
                                  Chr(10) || LPad('=', 80, '='));
        --
        CTACTPA0100_001.FinalizaLog(v_sq_log);
        --
    EXCEPTION
        --
        WHEN erro_fatal THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, '[Cdigo de Retorno: ' || p_credita_verba_carteira_out.StRetorno || ' - Mensagem: ' ||
                                      p_credita_verba_carteira_out.MsgRetorno || ']');
            --
            CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' ||
                                      To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '='));
            --
            CTACTPA0100_001.FinalizaLog(v_sq_log);
            --
            RETURN;
            --
        WHEN OTHERS THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Erro Credita_Verba_Carteira: ' || SQLERRM);
            --
            CTACTPA0100_001.GravaLog(v_sq_log, LPad('=', 80, '=') || Chr(10) || 'Final execuo: ' ||
                                      To_Char(SYSTIMESTAMP, 'dd-mm-yyyy hh24:mi:ss.FF') || Chr(10) || LPad('=', 80, '='));
            --
            CTACTPA0100_001.FinalizaLog(v_sq_log);
            --
            p_credita_verba_carteira_out.StRetorno  := 1;
            p_credita_verba_carteira_out.MsgRetorno := 'Erro Credita_Verba_Carteira: ' || SQLERRM;
            --
    END Credita_Verba_Carteira;

--
END CTACTPA0009_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0010_001 IS
        --
        --------------------------------------------------------------------------
        --      Atualiza_Cadastro_Corretores:   Atualizar o cadastro de         --
        --                                      corretores do CTA a partir do   --
        --                                      cadastro do Acsel/X.            --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Atualiza_Cadastro_Corretores    IS
        --
        v_po_reg                ACXCDPA0040_002.tab_corretor@DBL_APPLKSSVACX01;
        v_po_mensagem           ACXCDPA0040_002.rec_mensagem@DBL_APPLKSSVACX01;
        --
        v_po_locais_suc         ACXCDPA0020_001.tab_locais@DBL_APPLKSSVACX01;
        v_po_mensagem_suc       ACXCDPA0020_001.rec_mensagem@DBL_APPLKSSVACX01;
        --
        v_po_locais_nm_suc      ACXCDPA0020_001.tab_locais@DBL_APPLKSSVACX01;
        v_po_mensagem_nm_suc    ACXCDPA0020_001.rec_mensagem@DBL_APPLKSSVACX01;
        --
        v_tab_loc_hierarq       ACXCDPA0020_001.tab_loc_hierarq@DBL_APPLKSSVACX01;
        v_po_mensagem_diret     ACXCDPA0020_001.rec_mensagem@DBL_APPLKSSVACX01;
        --
        v_tp_pesoa              VARCHAR2(1);
        saida                   VARCHAR2(1)     :=      'N';
        v_proxima_chave         VARCHAR2(6)     :=      LPad('0',       6,      '0');
        v_nr_cpf_cnpj           NUMBER;
        v_proximo               EXCEPTION;
        v_erro_fatal            EXCEPTION;
        --
        v_qt_reg                NUMBER          :=      0;
        v_qt_reg_ins            NUMBER          :=      0;
        v_qt_reg_del            NUMBER          :=      0;
        v_qt_reg_upd            NUMBER          :=      0;
        v_gpa_id                NUMBER;
        --
        v_cd_erro               NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        BEGIN
                --
                tms_gpa.iniciar_processo        ('CTA_ATUALIZA_CORRETORES'
                                                ,SubStr(USER,1,8)
                                                ,'4402');
                --
                --      Acessando a package do Acsel para ver se ela est
                --      disponvel. Se no estiver, abortar o programa
                --
                BEGIN
                        --
                        ACXCDPA0040_002.P_GET_CORRETOR@DBL_APPLKSSVACX01        (v_proxima_chave
                                                                                ,3
                                                                                ,1
                                                                                ,1000
                                                                                ,v_po_reg
                                                                                ,v_po_mensagem);

                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_cd_erro       :=      1;
                                v_msg_erro      :=      'Erro ao acessar ACXCDPA0040_002.P_GET_CORRETOR: '||SQLERRM;
                                --
                                RAISE   v_erro_fatal;
                                --
                END;
                --
                LOOP
                        --
                        BEGIN
                                --
                                BEGIN
                                        --
                                        ACXCDPA0040_002.P_GET_CORRETOR@DBL_APPLKSSVACX01        (v_proxima_chave
                                                                                                ,3
                                                                                                ,1
                                                                                                ,1000
                                                                                                ,v_po_reg
                                                                                                ,v_po_mensagem);

                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                v_cd_erro       :=      1;
                                                v_msg_erro      :=      'Erro ao acessar ACXCDPA0040_002.P_GET_CORRETOR: '||SQLERRM;
                                                --
                                END;
                                --
                                IF      (v_po_mensagem.status_retorno   <>      0       AND
                                         v_po_mensagem.status_retorno   <>      51      AND
                                         v_po_mensagem.status_retorno   <>      60)     THEN
                                        --
                                        v_cd_erro       :=      1;
                                        v_msg_erro      :=      'Erro ao executar p_get_corretor: '||v_po_mensagem.status_retorno||' '||v_po_mensagem.mensagem_retorno;
                                        --
                                        RAISE   v_erro_fatal;
                                        --
                                END     IF;
                                --
                                FOR     r       IN      1..v_po_reg.Count       LOOP
                                        --
                                        v_qt_reg        :=      v_qt_reg        +       1;
                                        --
                                        BEGIN
                                                --
                                                --      Se o corretor estiver ativo, deve atualizar ou inserir o registro.
                                                --
                                                --      Buscar a sucursal do corretor
                                                --
                                                BEGIN
                                                        --
                                                        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01  (LPad(NVL(v_po_reg(r).codnac,0),       5,      0)
                                                                                                        ,2
                                                                                                        ,2
                                                                                                        ,1
                                                                                                        ,v_po_locais_suc
                                                                                                        ,v_po_mensagem_suc);
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN    OTHERS  THEN
                                                                --
                                                                v_cd_erro       :=      1;
                                                                v_msg_erro      :=      'Erro ao buscar sucursal do corretor 1: codnac '|| v_po_reg(r).codnac || ' ' || SQLERRM;
                                                                --
                                                                RAISE   v_erro_fatal;
                                                                --
                                                END;
                                                --
                                                IF      v_po_mensagem_suc.status_retorno        <>      0       THEN
                                                        --
                                                        tms_gpa.alerta    (v_gpa_id
                                                                        ,'Erro ao buscar sucursal do corretor 2 : '|| v_po_reg(r).codnac || ' ' || v_po_mensagem_suc.mensagem_retorno
                                                                        ,v_po_reg(r).codcorretor);
                                                        --
                                                        RAISE   v_proximo;
                                                        --
                                                END     IF;
                                                --
                                                --      Buscar o nome da sucursal
                                                --
                                                BEGIN
                                                        --
                                                        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01  (RPad('RPSSA',  15,     ' ')||80||LPad(v_po_locais_suc(1).codcentcusto, 15,     '0')
                                                                                                        ,2
                                                                                                        ,1
                                                                                                        ,1
                                                                                                        ,v_po_locais_nm_suc
                                                                                                        ,v_po_mensagem_nm_suc);
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN    OTHERS  THEN
                                                                --
                                                                v_cd_erro       :=      1;
                                                                v_msg_erro      :=      'Erro ao buscar nome da sucursal(1): codcentcusto:' || v_po_locais_suc(1).codcentcusto || ' erro: '||SQLERRM;
                                                                --
                                                                RAISE   v_erro_fatal;
                                                                --
                                                END;
                                                --
                                                IF      v_po_mensagem_nm_suc.status_retorno     <>      0       THEN
                                                        --
                                                        tms_gpa.debug    (v_gpa_id
                                                                        ,'Erro ao buscar nome da sucursal(2): codcentcusto: '|| v_po_locais_suc(1).codcentcusto || ' erro: ' ||v_po_mensagem_nm_suc.mensagem_retorno
                                                                        ,v_po_reg(r).codcorretor);
                                                        --
                                                        RAISE   v_proximo;
                                                        --
                                                END     IF;
                                                --
                                                --      Buscar a diretoria da sucursal
                                                --
                                                BEGIN
                                                        --
                                                        ACXCDPA0020_001.P_GET_LOCHIERAQ@DBL_APPLKSSVACX01       (RPad('RPSSA',  15,     ' ')||'80'||LPad(v_po_locais_suc(1).codcentcusto,    15,     '0')||'23'
                                                                                                                ,1
                                                                                                                ,1
                                                                                                                ,v_tab_loc_hierarq
                                                                                                                ,v_po_mensagem_diret);
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN    OTHERS  THEN
                                                                --
                                                                v_cd_erro       :=      1;
                                                                v_msg_erro      :=      'Erro ao buscar a diretoria da sucursal(1): '||SQLERRM;
                                                                --
                                                                RAISE   v_erro_fatal;
                                                                --
                                                END;
                                                --
                                                IF      v_po_mensagem_diret.status_retorno      <>      0       THEN
                                                        --
                                                        tms_gpa.erro    (v_gpa_id
                                                                        ,'Erro ao buscar a diretoria da sucursal(2): '||v_po_mensagem_diret.mensagem_retorno
                                                                        ,v_po_reg(r).codcorretor);
                                                        --
                                                        RAISE   v_proximo;
                                                        --
                                                END     IF;
                                                --
                                                --      Criar registro na tabela cta0012_crtor
                                                --
                                                IF      v_po_reg(r).tipoter     =       'E'     THEN
                                                        --
                                                        v_tp_pesoa      :=      'J';
                                                        v_nr_cpf_cnpj   :=      v_po_reg(r).numid||v_po_reg(r).dvid;
                                                        --
                                                        IF      Length(v_nr_cpf_cnpj)   >       14      THEN
                                                                --
                                                                v_nr_cpf_cnpj   :=      SubStr(v_po_reg(r).numid,2,12)||v_po_reg(r).dvid;
                                                                --
                                                        END     IF;
                                                        --
                                                ELSIF   v_po_reg(r).tipoter     =       'P'     THEN
                                                        --
                                                        v_tp_pesoa      :=      'F';
                                                        v_nr_cpf_cnpj   :=      SubStr(v_po_reg(r).numid,       1,      Length(v_po_reg(r).numid)-4)||v_po_reg(r).dvid;
                                                        --
                                                END     IF;
                                                --
                                                BEGIN
                                                        --
                                                        UPDATE  cta0012_crtor   SET     nm_crtor_segur          =       SubStr(v_po_reg(r).nomter,     1,      40),
                                                                                        cd_susep_crtor          =       Nvl(v_po_reg(r).codsuperint,' '),
                                                                                        nr_cpf_cnpj_crtor       =       v_nr_cpf_cnpj,
                                                                                        cd_sucsl_comrl          =       v_po_locais_suc(1).codcentcusto,
                                                                                        nm_sucsl                =       v_po_locais_nm_suc(1).nm_loc,
                                                                                        tp_pesoa                =       v_tp_pesoa,
                                                                                        cd_diret_comrl          =       v_tab_loc_hierarq(1).codlocadm,
                                                                                        cd_local_captc          =       v_po_reg(r).codnac,
                                                                                        cd_asses                =       v_po_reg(r).codplataforma
                                                        WHERE   cd_crtor_segur          =       v_po_reg(r).codcorretor;
                                                        --
                                                EXCEPTION
                                                        --
                                                        WHEN    OTHERS  THEN
                                                                --
                                                                tms_gpa.erro    (v_gpa_id
                                                                                ,'Erro ao atualizar registro do corretor: '||v_po_reg(r).codcorretor||' - '||SQLERRM
                                                                                ,v_po_reg(r).codcorretor);
                                                                --
                                                END;
                                                --
                                                v_qt_reg_upd    :=      v_qt_reg_upd    +       SQL%ROWCOUNT;
                                                --
                                                --      Se no encontar o registro, deve inserir.
                                                --
                                                IF      SQL%ROWCOUNT    =       0       THEN
                                                        --
                                                        BEGIN
                                                                --
                                                                tms_gpa.info    (v_gpa_id
                                                                                ,'Inserindo corretor: '||v_po_reg(r).codcorretor||' - '||SubStr(v_po_reg(r).nomter,     1,      40)
                                                                                ,v_po_reg(r).codcorretor);
                                                                --
                                                                INSERT  INTO    cta0012_crtor   (cd_crtor_segur
                                                                                                ,nm_crtor_segur
                                                                                                ,cd_susep_crtor
                                                                                                ,nr_cpf_cnpj_crtor
                                                                                                ,cd_sucsl_comrl
                                                                                                ,nm_sucsl
                                                                                                ,tp_pesoa
                                                                                                ,cd_diret_comrl
                                                                                                ,cd_local_captc
                                                                                                ,cd_asses)
                                                                                                --
                                                                                        VALUES  (v_po_reg(r).codcorretor
                                                                                                ,SubStr(v_po_reg(r).nomter,     1,      40)
                                                                                                ,Nvl(v_po_reg(r).codsuperint,' ')
                                                                                                ,v_nr_cpf_cnpj
                                                                                                ,v_po_locais_suc(1).codcentcusto
                                                                                                ,v_po_locais_nm_suc(1).nm_loc
                                                                                                ,v_tp_pesoa
                                                                                                ,v_tab_loc_hierarq(1).codlocadm
                                                                                                ,v_po_reg(r).codnac
                                                                                                ,v_po_reg(r).codplataforma);
                                                                --
                                                                v_qt_reg_ins    :=      v_qt_reg_ins    +       1;
                                                                --
                                                                COMMIT;
                                                                --
                                                        EXCEPTION
                                                                --
                                                                WHEN    OTHERS  THEN
                                                                        --
                                                                        BEGIN
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'erro no insert' || SQLERRM
                                                                                                ,v_po_reg(r).codcorretor);

                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'01 - '||v_po_reg(r).codcorretor
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'02 - '||v_po_reg(r).nomter
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'03 - '||v_po_reg(r).codsuperint
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'04 - '||v_po_reg(r).numid||v_po_reg(r).dvid
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'05 - '||v_po_locais_suc(1).codcentcusto
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'06 - '||v_po_locais_nm_suc(1).nm_loc
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'07 - '||v_tp_pesoa
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'08 - '||v_tab_loc_hierarq(1).codlocadm
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'09 - '||v_po_reg(r).codnac
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                                tms_gpa.DEBUG   (v_gpa_id
                                                                                                ,'10 - '||v_po_reg(r).codplataforma
                                                                                                ,v_po_reg(r).codcorretor);
                                                                                --
                                                                        EXCEPTION
                                                                                --
                                                                                WHEN    OTHERS  THEN
                                                                                        --
                                                                                        NULL;
                                                                                        --
                                                                        END;
                                                                        --
                                                                        tms_gpa.erro    (v_gpa_id
                                                                                        ,'Erro ao inserir corretor: '||v_po_reg(r).codcorretor||' '||SQLERRM
                                                                                        ,v_po_reg(r).codcorretor);
                                                                        --
                                                                        ROLLBACK;
                                                                        --
                                                        END;
                                                        --
                                                END     IF;
                                                        --

                                        EXCEPTION
                                                --
                                                WHEN    v_proximo       THEN
                                                        --
                                                        v_proxima_chave :=      SubStr(v_po_mensagem.proxima_chave,1,6);
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                                COMMIT;
                                --
                                IF      v_po_mensagem.status_retorno    =       60      THEN
                                        --
                                        saida           :=      'S';
                                        --
                                END     IF;
                                --
                                IF      v_po_mensagem.status_retorno  =       0       THEN
                                        --
                                        v_proxima_chave :=      SubStr(v_po_mensagem.proxima_chave,1,6);
                                        --
                                END     IF;
                                --
                                EXIT    WHEN    saida   =       'S';
                                --
                                IF      v_po_mensagem.status_retorno  =       51      THEN
                                        --
                                        v_proxima_chave :=      SubStr(v_po_mensagem.proxima_chave,1,6);
                                        --
                                END     IF;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_cd_erro       :=      1;
                                        v_msg_erro      :=      'Erro loop corretores: '||SQLERRM;
                                        --
                        END;
                        --
                END     LOOP;
                --
                COMMIT;
                --
                tms_gpa.info    (v_gpa_id
                                ,'Total de corretores atualizados: '||v_qt_reg_upd);
                --
                tms_gpa.info    (v_gpa_id
                                ,'Total de corretores inseridos: '||v_qt_reg_ins);
                --
                tms_gpa.info    (v_gpa_id
                                ,'Total de corretores deletados: '||v_qt_reg_del);
                --
                tms_gpa.finalizar_processo;
                --
        EXCEPTION
                --
                WHEN    v_erro_fatal    THEN
                        --
                        tms_gpa.fatal                   (v_gpa_id
                                                        ,v_cd_erro||' '||v_msg_erro
                                                        ,NULL);
                        --
                        tms_gpa.abortar_processo        (v_gpa_id
                                                        ,v_cd_erro||' '||v_msg_erro
                                                        ,NULL);
                        --
                        Raise_Application_Error         (-20001
                                                        ,v_cd_erro||' '||v_msg_erro);
                        --
                WHEN    OTHERS  THEN
                        --
                        tms_gpa.fatal                   (v_gpa_id
                                                        ,'Erro Atualiza_Cadastro_Corretores: '||SQLERRM
                                                        ,NULL);
                        --
                        tms_gpa.abortar_processo        (v_gpa_id
                                                        ,'Erro Atualiza_Cadastro_Corretores: '||SQLERRM
                                                        ,NULL);
                        --
                        Raise_Application_Error         (-20002
                                                        ,'Erro Atualiza_Cadastro_Corretores: '||SQLERRM);
                        --
        END     Atualiza_Cadastro_Corretores;
        --
END     CTACTPA0010_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0011_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        --
        --------------------------------------------------------------------------
        --      ValidaVerbaCorretor:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaCorretor     (p_transfere_corretor_asses_in  IN      transfere_corretor_asses_in
                                                ,p_dt_procs                     IN      DATE
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_crtor   IS
                --
                SELECT  id_verba,
                        cd_crtor_segur,
                        vl_saldo_verba,
                        cd_tipo_verba,
                        dt_fim_vigen
                FROM    cta0002_verba
                WHERE   id_verba        =       p_transfere_corretor_asses_in.CdVerbaCorretor
                FOR     UPDATE;
        --
        CURSOR  c_verba_vt_crtor        IS
                --
                SELECT  id_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   cd_asses        =       p_transfere_corretor_asses_in.CdAssessoria
                AND     cd_segmt_prdut  =       p_cd_segmento
                AND     dt_inico_vigen  <=      p_dt_procs
                AND     dt_fim_vigen    >=      p_dt_procs
                AND     ROWNUM          =       1
                ORDER   BY      dt_fim_vigen    DESC
                FOR     UPDATE;
        --
        v_cd_erro               NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        v_count_verba           NUMBER;
        v_id_lacto              NUMBER;
        v_id_lacto_vb           NUMBER;
        v_id_verba              NUMBER;
        --
        v_cd_sucsl              NUMBER;
        v_cd_diret              NUMBER;
        --
        v_tp_pesoa              cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur        cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor     cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_count_verba
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_transfere_corretor_asses_in.CdVerbaCorretor;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_count_verba   :=      1;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_count_verba   =       0       THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_transfere_corretor_asses_in.CdVerbaCorretor||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;
                --
                FOR     r_verba_crtor   IN      c_verba_crtor   LOOP
                        --
                        IF      r_verba_crtor.cd_crtor_segur    <>      p_transfere_corretor_asses_in.CdCorretor        THEN
                                --
                                p_cd_erro       :=      92;
                                p_msg_erro      :=      'Cdigo de corretor cadastrado para a verba: '||r_verba_crtor.cd_crtor_segur||' diferente do informado: '||p_transfere_corretor_asses_in.CdCorretor;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        IF      v_VlTransferencia       >       r_verba_crtor.vl_saldo_verba    THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_crtor.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        IF      r_verba_crtor.cd_tipo_verba     <>      'C'     THEN
                                --
                                p_cd_erro       :=      94;
                                p_msg_erro      :=      'Tipo de verba cadastrada no  vitalcia';
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Acessando a tabela de corretor para validar a assessoria
                        --
                        CTACTPA0100_001.RetornaDadosAssessoria  (p_transfere_corretor_asses_in.CdAssessoria
                                                                ,v_tp_pesoa
                                                                ,v_nm_crtor_segur
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,v_cd_sucsl
                                                                ,v_cd_diret
                                                                ,v_cd_erro
                                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_cd_erro       :=      v_cd_erro;
                                p_msg_erro      :=      v_msg_erro;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        ROLLBACK;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_verba_crtor.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_crtor.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_crtor.vl_saldo_verba   +       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Transf. Assessoria: '||v_nm_crtor_segur,       1,      40)
                                                                ,v_nr_cpf_cnpj_crtor
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_transfere_corretor_asses_in.CdProcesso
                                                                ,p_transfere_corretor_asses_in.CdUsuario
                                                                ,SYSDATE
                                                                ,v_cd_sucsl
                                                                ,v_cd_diret
                                                                ,'D'                            -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_001: '||SQLERRM;
                                        --
                                        ROLLBACK;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   cd_asses        =       p_transfere_corretor_asses_in.CdAssessoria
                                AND     cd_segmt_prdut  =       p_cd_segmento
                                AND     dt_inico_vigen  <=      p_dt_procs
                                AND     dt_fim_vigen    >=      p_dt_procs;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                                ROLLBACK;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_crtor_segur
                                                                        ,cd_asses
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,NULL
                                                                        ,p_transfere_corretor_asses_in.CdAssessoria
                                                                        ,'M'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_VlTransferencia
                                                                        ,p_dt_procs
                                                                        ,r_verba_crtor.dt_fim_vigen
                                                                        ,r_verba_crtor.id_verba
                                                                        ,p_transfere_corretor_asses_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                ROLLBACK;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                ROLLBACK;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,tp_desct_agrvo)
                                                                        --
                                                                VALUES  (v_id_lacto_vb
                                                                        ,v_id_verba
                                                                        ,'CRD'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,SYSDATE
                                                                        ,v_VlTransferencia
                                                                        ,v_VlTransferencia
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,v_id_lacto
                                                                        ,NULL
                                                                        ,v_tp_pesoa
                                                                        ,SubStr('Transf. Corretor: '||v_nm_crtor_segur, 1,      40)
                                                                        ,v_nr_cpf_cnpj_crtor
                                                                        ,0
                                                                        ,0
                                                                        ,NULL
                                                                        ,p_transfere_corretor_asses_in.CdProcesso
                                                                        ,p_transfere_corretor_asses_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,v_cd_sucsl
                                                                        ,v_cd_diret
                                                                        ,'A'                    -- tp_desct_agrvo
                                                                        );
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: '||SQLERRM;
                                                --
                                                ROLLBACK;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSE
                                FOR     r_verba_vt_crtor        IN      c_verba_vt_crtor        LOOP
                                        --
                                        --      Criar lanamento de transferncia
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        ROLLBACK;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        BEGIN
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb
                                                                                ,r_verba_vt_crtor.id_verba                                              /*id_verba            */
                                                                                ,'CRD'                                                                  /*cd_situc_lacto      */
                                                                                ,NULL                                                                   /*cd_ctrat            */
                                                                                ,NULL                                                                   /*cd_item_ctrat       */
                                                                                ,'T'                                                                    /*cd_tipo_lacto       */
                                                                                ,SYSDATE                                                                /*dt_lacto            */
                                                                                ,r_verba_vt_crtor.vl_saldo_verba                                        /*vl_saldo_verba_anter*/
                                                                                ,v_VlTransferencia                                                      /*vl_lacto            */
                                                                                ,0                                                                      /*vl_agrvo_ppota      */
                                                                                ,r_verba_vt_crtor.vl_saldo_verba        +       v_VlTransferencia       /*vl_saldo_verba_postr*/
                                                                                ,v_id_lacto                                                             /*id_lacto_origm_trnsf*/
                                                                                ,NULL                                                                   /*id_lacto_estor      */
                                                                                ,v_tp_pesoa                                                             /*tp_pesoa            */
                                                                                ,SubStr('Transf. Corretor: '||v_nm_crtor_segur, 1,      40)             /*nm_clien_sgrdo      */
                                                                                ,v_nr_cpf_cnpj_crtor                                                    /*nr_cpf_cnpj_clien   */
                                                                                ,0                                                                      /*vl_prmio_liqui_ppota*/
                                                                                ,0                                                                      /*pc_comis_crtor      */
                                                                                ,NULL                                                                   /*dt_inico_vigen_segur*/
                                                                                ,p_transfere_corretor_asses_in.CdProcesso                               /*id_procs_criac      */
                                                                                ,p_transfere_corretor_asses_in.CdUsuario                                /*cd_usuro_criac      */
                                                                                ,SYSDATE                                                                /*dt_criac            */
                                                                                ,v_cd_sucsl                                                             /*cd_sucsl_comrl      */
                                                                                ,v_cd_diret                                                             /*cd_diret_comrl)     */
                                                                                ,'A'                                                                    /*tp_desct_agrvo      */
                                                                                );
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: '||SQLERRM;
                                                        --
                                                        ROLLBACK;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_crdto_verba          =       vl_crdto_verba  +       v_VlTransferencia,
                                                        vl_saldo_verba          =       vl_saldo_verba  +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_transfere_corretor_asses_in.CdUsuario,
                                                        id_verba_origm_trnsf    =       r_verba_vt_crtor.id_verba
                                                WHERE   CURRENT OF      c_verba_vt_crtor;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        ROLLBACK;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                UPDATE  cta0002_verba
                                SET     vl_crdto_verba          =       vl_crdto_verba  -       v_VlTransferencia,
                                        vl_saldo_verba          =       vl_saldo_verba  -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_transfere_corretor_asses_in.CdUsuario
                                WHERE   CURRENT OF      c_verba_crtor;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        ROLLBACK;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro ValidaVerbaCorretor: '||SQLERRM;
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
        END     ValidaVerbaCorretor;
        --
        --------------------------------------------------------------------------
        --      Transfere_Corretor_Assessoria:  Transferncia de verba do       --
        --                                      corretor para a assessoria.     --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Transfere_Corretor_Assessoria   (p_transfere_corretor_asses_in  IN      transfere_corretor_asses_in
                                                        ,p_transfere_corretor_asses_out OUT     transfere_corretor_asses_out)   IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        v_sq_log                NUMBER;
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_transfere_corretor_asses_out  :=      transfere_corretor_asses_out    (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_transfere_corretor_asses_in.VlTransferencia,    2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (111
                                                ,p_transfere_corretor_asses_in.SistemaChamador
                                                ,p_transfere_corretor_asses_in.CdCorretor
                                                ,p_transfere_corretor_asses_in.CdAssessoria
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_transfere_corretor_asses_in.CPFCNPJAssessoria
                                                ,NULL
                                                ,p_transfere_corretor_asses_in.CdUsuario
                                                ,p_transfere_corretor_asses_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                                                     ||Chr(10)||
                                                'Servio Consulta_Saldo_Desconto. Parmetros de entrada: '                                                      ||Chr(10)||
                                                ' SistemaChamador............. '||p_transfere_corretor_asses_in.SistemaChamador         ||Chr(10)||
                                                ' CdSegmento.................. '||p_transfere_corretor_asses_in.CdSegmento              ||Chr(10)||
                                                ' TpTransacao................. '||p_transfere_corretor_asses_in.TpTransacao             ||Chr(10)||
                                                ' CdAssessoria................ '||p_transfere_corretor_asses_in.CdAssessoria            ||Chr(10)||
                                                ' CPFCNPJAssessoria........... '||p_transfere_corretor_asses_in.CPFCNPJAssessoria       ||Chr(10)||
                                                ' CdCorretor.................. '||p_transfere_corretor_asses_in.CdCorretor              ||Chr(10)||
                                                ' VlTransferencia............. '||p_transfere_corretor_asses_in.VlTransferencia         ||Chr(10)||
                                                ' v_VlTransferencia........... '||v_VlTransferencia                                     ||Chr(10)||
                                                ' CdVerbaCorretor............. '||p_transfere_corretor_asses_in.CdVerbaCorretor         ||Chr(10)||
                                                ' CdUsuario................... '||p_transfere_corretor_asses_in.CdUsuario               ||Chr(10)||
                                                ' CdProcesso.................. '||p_transfere_corretor_asses_in.CdProcesso              ||Chr(10)||
                                                ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')          ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_transfere_corretor_asses_in.SistemaChamador))      THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      2;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Sistema chamador invlido: '||p_transfere_corretor_asses_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de transao
                --
                IF      Nvl(p_transfere_corretor_asses_in.TpTransacao,  'X')    NOT     IN      ('T',   'D')    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      79;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Tipo de transao invlido: '||p_transfere_corretor_asses_in.TpTransacao;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria
                --
                IF      p_transfere_corretor_asses_in.CdAssessoria      IS      NULL    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      57;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Cdigo de assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF/CNPJ da assessoria
                --
                IF      p_transfere_corretor_asses_in.CPFCNPJAssessoria IS      NULL    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      80;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - CPF / CNPJ da assessoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      NOT(tms_util.valida_cpf(LPad(p_transfere_corretor_asses_in.CPFCNPJAssessoria,11,'0')))
                        AND     NOT(tms_util.valida_cnpj(LPad(p_transfere_corretor_asses_in.CPFCNPJAssessoria,14,'0')))      THEN
                                --
                                p_transfere_corretor_asses_out.StRetorno        :=      80;
                                p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - CPF / CNPJ da assessoria invlido: '||p_transfere_corretor_asses_in.CPFCNPJAssessoria;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_transfere_corretor_asses_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      v_cd_erro;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL
                OR      v_VlTransferencia       =       0       THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      58;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando Verba do Corretor
                --
                IF      p_transfere_corretor_asses_in.CdVerbaCorretor   IS      NULL    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      91;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Cdigo de verba do corretor est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --
                --      Validando usurio
                --
                IF      p_transfere_corretor_asses_in.CdUsuario   IS      NULL    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      10;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_transfere_corretor_asses_in.CdProcesso,     0)      NOT     IN      (8,   9)      THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      11;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      'Cdigo de processo invlido: '||p_transfere_corretor_asses_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm: '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      v_cd_erro;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_transfere_corretor_asses_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      v_cd_erro;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaCorretor] - Data: '||v_dt_procm||' Segmento: '||p_transfere_corretor_asses_in.CdSegmento||' Lanamento: '||p_transfere_corretor_asses_out.IdLancamento);
                --
                ValidaVerbaCorretor     (p_transfere_corretor_asses_in
                                        ,v_dt_procm
                                        ,p_transfere_corretor_asses_in.CdSegmento
                                        ,p_transfere_corretor_asses_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      v_cd_erro;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      '[Transfere Corretor Assessoria] - '||v_msg_erro;
                        p_transfere_corretor_asses_out.IdLancamento     :=      NULL;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        ROLLBACK;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_transfere_corretor_asses_out.StRetorno||' - Mensagem: '||p_transfere_corretor_asses_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        ROLLBACK;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Transfere_Corretor_Assessoria: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_transfere_corretor_asses_out.StRetorno        :=      1;
                        p_transfere_corretor_asses_out.MsgRetorno       :=      'Erro Transfere_Corretor_Assessoria: '||SQLERRM;
                        --
        END     Transfere_Corretor_Assessoria;
        --
END     CTACTPA0011_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0012_001 IS
        --
        v_VlPremioLiquido       NUMBER(15,2);
        v_sq_log                NUMBER;

        --
        --------------------------------------------------------------------------
        --      Consulta_Saldo_Desconto:        Consultar o saldo do conta      --
        --                                      corrente para um corretor ou    --
        --                                      assessoria, e tambm o desconto --
        --                                      mximo para o item.             --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Consulta_Saldo_Portal   (p_consulta_saldo_in    IN      consulta_saldo_in
                                                ,p_consulta_saldo_out   OUT     consulta_saldo_out)     IS
        --
        v_dt_procm              DATE;
        v_dt_inico_vigen        DATE;
        v_cd_segmt_prdut        cta0001_prdut.cd_segmt_prdut%TYPE;
        v_ic_crtor_ativo_segmt  cta0016_crtor_segmt.ic_crtor_ativo_segmt%TYPE;
        v_vl_saldo_verba        cta0002_verba.vl_saldo_verba%TYPE;
        v_pc_maxmo_desct        cta0009_pctis_comis_desct.pc_maxmo_desct%TYPE;
        v_vl_lacto              cta0004_lacto.vl_lacto%TYPE;
        --
        v_id_prdut              NUMBER;
        v_cd_erro               NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --

        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_consulta_saldo_out    :=      consulta_saldo_out      (0
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL);
                --
                v_VlPremioLiquido       :=      Round(p_consulta_saldo_in.VlPremioLiquido,      2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (121
                                                ,p_consulta_saldo_in.SistemaChamador
                                                ,p_consulta_saldo_in.CdCorretor
                                                ,NULL
                                                ,p_consulta_saldo_in.CdContrato
                                                ,p_consulta_saldo_in.CdItemContrato
                                                ,p_consulta_saldo_in.TpPessoa
                                                ,p_consulta_saldo_in.CPFCNPJCliente
                                                ,NULL
                                                ,p_consulta_saldo_in.CdUsuario
                                                ,p_consulta_saldo_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                     ||Chr(10)||
                                                'Servio Consulta_Saldo_Desconto. Parmetros de entrada: '                      ||Chr(10)||
                                                ' SistemaChamador............. '||p_consulta_saldo_in.SistemaChamador           ||Chr(10)||
                                                ' CdProduto................... '||p_consulta_saldo_in.CdProduto                 ||Chr(10)||
                                                ' CdCorretor.................. '||p_consulta_saldo_in.CdCorretor                ||Chr(10)||
                                                ' CdContrato.................. '||p_consulta_saldo_in.CdContrato                ||Chr(10)||
                                                ' CdItemContrato.............. '||p_consulta_saldo_in.CdItemContrato            ||Chr(10)||
                                                ' VlPremioLiquido............. '||p_consulta_saldo_in.VlPremioLiquido           ||Chr(10)||
                                                ' v_VlPremioLiquido........... '||v_VlPremioLiquido                             ||Chr(10)||
                                                ' Pccomissao.................. '||p_consulta_saldo_in.Pccomissao                ||Chr(10)||
                                                ' DtInicioVigencia............ '||p_consulta_saldo_in.DtInicioVigencia          ||Chr(10)||
                                                ' TpPessoa.................... '||p_consulta_saldo_in.TpPessoa                  ||Chr(10)||
                                                ' CPFCNPJCliente.............. '||p_consulta_saldo_in.CPFCNPJCliente            ||Chr(10)||
                                                ' CdUsuario................... '||p_consulta_saldo_in.CdUsuario                 ||Chr(10)||
                                                ' CdProcesso.................. '||p_consulta_saldo_in.CdProcesso                ||Chr(10)||
                                                ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')  ||Chr(10)||
                                                LPad('=',       80,     '='));
                        --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_consulta_saldo_in.SistemaChamador))        THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      2;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - Sistema chamador invlido: '||p_consulta_saldo_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_consulta_saldo_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      v_cd_erro;
                        p_consulta_saldo_out.MsgRetorno :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o segmento. Para esse servio, o segmento vem
                --      no campo de produto
                --
                IF      p_consulta_saldo_in.CdProduto   IS      NULL    THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      100;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - Cdigo de segmento invlido: '||p_consulta_saldo_in.CdProduto;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_consulta_saldo_in.CdProduto
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      v_cd_erro;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - '||v_msg_erro;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      p_consulta_saldo_in.CdProcesso  NOT     IN      (21,    22,     23)     THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      11;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - Cdigo de processo invlido: '||p_consulta_saldo_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm              :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] '||v_dt_procm);
                --
                --      Valida corretor bloqueado
                --
                IF      CTACTPA0100_001.IsCorretorBloqueado     (p_consulta_saldo_in.CdCorretor
                                                                ,p_consulta_saldo_in.CdProduto
                                                                ,v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      v_cd_erro;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Buscar o saldo
                --
                v_vl_saldo_verba        :=      CTACTPA0100_001.BuscaSaldo      (p_consulta_saldo_in.CdCorretor
                                                                                ,p_consulta_saldo_in.CdProduto
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log,'[BuscaSaldo] - '||v_vl_saldo_verba||' Corretor: '||p_consulta_saldo_in.CdCorretor||' Produto: '||p_consulta_saldo_in.CdProduto||' Data Processamento: '||v_dt_procm);
                --
                v_vl_saldo_verba := CTACTPA0100_001.ValidaSaldo(v_sq_log
                                                               ,p_consulta_saldo_in.SistemaChamador
                                                               ,p_consulta_saldo_in.CdCorretor
                                                               ,v_vl_saldo_verba);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_consulta_saldo_out.StRetorno  :=      v_cd_erro;
                        p_consulta_saldo_out.MsgRetorno :=      '[Consulta Saldo Portal] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Atribuindo o valor do retorno de Saldo Disponvel
                --
                p_consulta_saldo_out.VlSaldoDisponivel  :=      v_vl_saldo_verba;
                --

                -- se for processo 21, adiciona valor parametro.

                IF      p_consulta_saldo_in.CdProcesso        IN      (21)    THEN

                        p_consulta_saldo_out.VlSaldoDisponivel  :=      Nvl(p_consulta_saldo_out.VlSaldoDisponivel, 0) + CTACTPA0100_001.retornaValorSomaDescontoAgravo(p_consulta_saldo_in.CdProduto , v_sq_log) ;

                END IF;


                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Consulta_Saldo_Portal: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_consulta_saldo_out.StRetorno  :=      1;
                        p_consulta_saldo_out.MsgRetorno :=      'Erro Consulta_Saldo_Desconto: '        ||SQLERRM       ||' Parmetros: '||
                                                                p_consulta_saldo_in.SistemaChamador     ||';'           ||
                                                                p_consulta_saldo_in.CdProduto           ||';'           ||
                                                                p_consulta_saldo_in.CdCorretor;
                        --
        END     Consulta_Saldo_Portal;
        --
END     CTACTPA0012_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0013_001  IS
        --
        v_sq_log        NUMBER;
        --
        --------------------------------------------------------------------------
        --      IsVerbaAtiva:   Verifica se uma determinada verba existe e est --
        --                      ativa.                                          --
        --------------------------------------------------------------------------
        --
        FUNCTION        IsVerbaAtiva    (p_id_verba             IN      NUMBER
                                        ,p_vl_saldo_verba       OUT     NUMBER
                                        ,p_cd_erro              OUT     NUMBER
                                        ,p_msg_erro             OUT     VARCHAR2)
        RETURN  BOOLEAN IS
        --
        v_cd_situc_verba        cta0002_verba.cd_situc_verba%TYPE;
        --
        BEGIN
                --
                SELECT  cd_situc_verba,
                        vl_saldo_verba
                INTO    v_cd_situc_verba,
                        p_vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_id_verba;
                --
                IF      v_cd_situc_verba        =       'ATI'   THEN
                        --
                        RETURN  TRUE;
                        --
                ELSE
                        --
                        p_cd_erro       :=      104;
                        p_msg_erro      :=      'Verba: '||p_id_verba||' est com status: '||v_cd_situc_verba||'. No  possvel cancelar.'  || '(' || v_sq_log || ')';
                        --
                        RETURN  FALSE;
                        --
                END     IF;
                --
        EXCEPTION
                --
                WHEN    No_Data_Found   THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_id_verba||' no encontrada.' || '(' || v_sq_log || ')';
                        --
                        RETURN  FALSE;
                        --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro IsVerbaAtiva: ' || '(' || v_sq_log || ')'||SQLERRM;
                        --
                        RETURN  FALSE;
                        --
        END     IsVerbaAtiva;
        --
        --------------------------------------------------------------------------
        --      IsVerbaCorretor:        Verifica se uma determinada verba  do  --
        --                              corretor passado nas variveis de       --
        --                              entrada.                                --
        --------------------------------------------------------------------------
        --
        FUNCTION        IsVerbaCorretor (p_id_verba     IN      NUMBER
                                        ,p_cd_corretor  IN      NUMBER
                                        ,p_cd_erro      OUT     NUMBER
                                        ,p_msg_erro     OUT     VARCHAR2)
        RETURN  BOOLEAN IS
        --
        v_cd_crtor_segur        cta0002_verba.cd_crtor_segur%TYPE;
        --
        BEGIN
                --
                SELECT  cd_crtor_segur
                INTO    v_cd_crtor_segur
                FROM    cta0002_verba
                WHERE   id_verba        =       p_id_verba;
                --
                IF      p_cd_corretor   <>      v_cd_crtor_segur        THEN
                        --
                        p_cd_erro       :=      41;
                        p_msg_erro      :=      'Corretor cadastrado para a verba: '||p_id_verba||'['||v_cd_crtor_segur||']  diferente do corretor enviado ['||p_cd_corretor||']' || '(' || v_sq_log || ')';
                        --
                        RETURN  FALSE;
                        --
                END     IF;
                --
                RETURN  TRUE;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro IsVerbaCorretor: ' || '(' || v_sq_log || ')'||SQLERRM;
                        --
                        RETURN  FALSE;
                        --
        END     IsVerbaCorretor;
        --
        --------------------------------------------------------------------------
        --      CriaLactoCancelamento:  Cria um lanamento de cancelamento da   --
        --                              verba.                                  --
        --------------------------------------------------------------------------
        --
        PROCEDURE       CriaLactoCancelamento   (p_cancela_verba_in     IN      cancela_verba_in
                                                ,p_id_procs_criac       IN      NUMBER
                                                ,p_vl_saldo_verba       IN      NUMBER
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        v_id_lacto              NUMBER;
        v_vl_saldo_verba        NUMBER;
        --
        v_t_corretor            ctactpa0100_001.t_corretor;
        --
        BEGIN
                --
                p_cd_erro       :=      0;
                p_msg_erro      :=      NULL;
                --
                --      Selecionando o saldo da verba
                --
                BEGIN
                        --
                        SELECT  vl_saldo_verba
                        INTO    v_vl_saldo_verba
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_cancela_verba_in.IdVerba;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      35;
                                p_msg_erro      :=      'Erro ao selecionar saldo da verba: ' || '(' || v_sq_log || ')'||SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                --      Selecionando o valor da sequencia
                --
                BEGIN
                        --
                        SELECT  ctasq0004_lacto.NEXTVAL
                        INTO    v_id_lacto
                        FROM    dual;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      35;
                                p_msg_erro      :=      'Erro ao selecionar sequencia ctasq0004_lacto: ' || '(' || v_sq_log || ')'||SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                --      Retornar informaes do corretor
                --
                CTACTPA0100_001.RetornaDadosCorretor    (p_cancela_verba_in.CdCorretor
                                                        ,v_t_corretor);
                --
                --
                --      Criar lanamento de debito cujo valor de lanamento
                --       igual ao saldo da verba
                --
                BEGIN
                        --
                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                        ,id_verba
                                                        ,cd_situc_lacto
                                                        ,cd_tipo_lacto
                                                        ,dt_lacto
                                                        ,vl_lacto
                                                        ,vl_saldo_verba_anter
                                                        ,vl_saldo_verba_postr
                                                        ,vl_agrvo_ppota
                                                        ,nm_clien_sgrdo
                                                        ,id_procs_criac
                                                        ,cd_usuro_criac
                                                        ,dt_criac
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl
                                                        ,tp_desct_agrvo)
                                                        --
                                                VALUES  (v_id_lacto                     --      id_lacto
                                                        ,p_cancela_verba_in.IdVerba     --      id_verba
                                                        ,'DBT'                          --      cd_situc_lacto
                                                        ,'D'                            --      cd_tipo_lacto
                                                        ,SYSDATE                        --      cd_tipo_lactodt_lacto
                                                        ,p_vl_saldo_verba               --      vl_lacto
                                                        ,v_vl_saldo_verba               --      vl_saldo_verba_anter
                                                        ,0                              --      vl_saldo_verba_postr
                                                        ,v_vl_saldo_verba               --      vl_agrvo_ppota
                                                        ,'Cancelamento Verba'           --      nm_clien_sgrdo
                                                        ,p_id_procs_criac               --      id_procs_criac
                                                        ,p_cancela_verba_in.CdUsuario   --      cd_usuro_criac
                                                        ,SYSDATE                        --      dt_criac
                                                        ,v_t_corretor.cd_sucsl_comrl    --      cd_sucsl_comrl
                                                        ,v_t_corretor.cd_diret_comrl    --      cd_diret_comrl
                                                        ,'D');                          --      tp_desct_agrvo
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      35;
                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: ' || '(' || v_sq_log || ')'||SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      35;
                        p_msg_erro      :=      'Erro CriaLactoCancelamento: ' || '(' || v_sq_log || ')'||SQLERRM;
                        --
                        RETURN;
                        --
        END     CriaLactoCancelamento;
        --
        --------------------------------------------------------------------------
        --      Cancela_Verba:  Servio que cancela uma verba.                  --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Cancela_Verba   (p_cancela_verba_in     IN      cancela_verba_in
                                        ,p_cancela_verba_out    OUT     cancela_verba_out)      IS
        --
        erro_fatal              EXCEPTION;
        v_cd_erro               NUMBER;
        v_id_procs_criac        NUMBER;
        v_vl_saldo_verba        NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        BEGIN
                --
                --      Inicializando type
                --
                p_cancela_verba_out     :=      cancela_verba_out       (0
                                                                        ,NULL);
                --
                --      Iniciando o log do servio
                --
                CTACTPA0100_001.IniciaLog       (131
                                                ,p_cancela_verba_in.SistemaChamador
                                                ,p_cancela_verba_in.CdCorretor
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_cancela_verba_in.CdUsuario
                                                ,p_cancela_verba_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                     ||Chr(10)||
                                                'Servio Cancela_Verba. Parmetros de entrada: '                                ||Chr(10)||
                                                ' SistemaChamador............. '||p_cancela_verba_in.SistemaChamador            ||Chr(10)||
                                                ' IdVerba..................... '||p_cancela_verba_in.IdVerba                    ||Chr(10)||
                                                ' CdCorretor.................. '||p_cancela_verba_in.CdCorretor                 ||Chr(10)||
                                                ' CdUsuario................... '||p_cancela_verba_in.CdUsuario                  ||Chr(10)||
                                                ' CdProcesso.................. '||p_cancela_verba_in.CdProcesso                 ||Chr(10)||
                                                ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')  ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando os parmetros de entrada
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_cancela_verba_in.SistemaChamador))      THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      2;
                        p_cancela_verba_out.MsgRetorno  :=      '[Cancela Verba] - Sistema chamador invlido: '||p_cancela_verba_in.SistemaChamador || '(' || v_sq_log || ')';
                                --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o IdVerba
                --
                IF      p_cancela_verba_in.IdVerba      IS      NULL    THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      91;
                        p_cancela_verba_out.MsgRetorno  :=      '[Cancela Verba] - Id Verba est nulo' || '(' || v_sq_log || ')';
                        --
                END     IF;
                --
                --      Validando o Corretor
                --
                IF      p_cancela_verba_in.CdCorretor   IS      NOT     NULL    THEN
                        --
                        IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_cancela_verba_in.CdCorretor
                                                                        ,v_cd_erro
                                                                        ,v_msg_erro))   THEN
                                --
                                p_cancela_verba_out.StRetorno   :=      v_cd_erro;
                                p_cancela_verba_out.MsgRetorno  :=      '[Cancela Verba] - '||v_msg_erro || '(' || v_sq_log || ')';
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando o Usurio
                --
                IF      p_cancela_verba_in.CdUsuario    IS      NULL    THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      10;
                        p_cancela_verba_out.MsgRetorno  :=      '[Cancela Verba] - Cdigo de usurio est nulo.' || '(' || v_sq_log || ')';
                        --
                END     IF;
                --
                --      Validando o Processo
                --
                IF      p_cancela_verba_in.CdProcesso   IS      NULL
                OR      p_cancela_verba_in.CdProcesso   <>      35      THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      11;
                        p_cancela_verba_out.MsgRetorno  :=      '[Cancela Verba] - Cdigo de processo invlido: '||p_cancela_verba_in.CdProcesso || '(' || v_sq_log || ')';
                        --
                END     IF;
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_cancela_verba_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs_criac||' Processo: '||p_cancela_verba_in.CdProcesso);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      v_cd_erro;
                        p_cancela_verba_out.MsgRetorno  :=      '[Provisiona Valor] - '||v_msg_erro || '(' || v_sq_log || ')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Verificar se a verba est ativa.
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[IsVerbaAtiva]');
                --
                IF      NOT(IsVerbaAtiva        (p_cancela_verba_in.IdVerba
                                                ,v_vl_saldo_verba
                                                ,v_cd_erro
                                                ,v_msg_erro))   THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      v_cd_erro;
                        p_cancela_verba_out.MsgRetorno  :=      v_msg_erro || '(' || v_sq_log || ')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validar, pelo id_verba, se a verba  do corretor do
                --      parametro de entrada
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[IsVerbaCorretor]');
                --
                IF      NOT(IsVerbaCorretor     (p_cancela_verba_in.IdVerba
                                                ,p_cancela_verba_in.CdCorretor
                                                ,v_cd_erro
                                                ,v_msg_erro))   THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      v_cd_erro;
                        p_cancela_verba_out.MsgRetorno  :=      v_msg_erro || '(' || v_sq_log || ')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Mudar o status da verba para CAN e atualizar o saldo
                --      da verba para zero.
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Atualizando verba '||p_cancela_verba_in.IdVerba||' para CAN]');
                --
                BEGIN
                        --
                        UPDATE  cta0002_verba
                        SET     cd_situc_verba  =       'CAN',
                                vl_eftdo_verba  =       Nvl(vl_eftdo_verba,     0)      +       Nvl(vl_saldo_verba,     0),
                                vl_saldo_verba  =       0
                        WHERE   id_verba        =       p_cancela_verba_in.IdVerba;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cancela_verba_out.StRetorno   :=      1;
                                p_cancela_verba_out.MsgRetorno  :=      'Erro ao atualizar status da verba: ' || '(' || v_sq_log || ')'||SQLERRM;
                                --
                                RAISE   erro_fatal;
                                --
                END;
                --
                --      Criar lanamento de debito
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[CriaLactoCancelamento]');
                --
                CriaLactoCancelamento   (p_cancela_verba_in
                                        ,v_id_procs_criac
                                        ,v_vl_saldo_verba
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancela_verba_out.StRetorno   :=      v_cd_erro;
                        p_cancela_verba_out.MsgRetorno  :=      v_msg_erro || '(' || v_sq_log || ')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Finalizando o log do servio
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
                COMMIT;
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'StRetorno - '||p_cancela_verba_out.StRetorno||' MsgRetorno - '||p_cancela_verba_out.MsgRetorno);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                         LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Cancela_Verba: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_cancela_verba_out.StRetorno   :=      1;
                        p_cancela_verba_out.MsgRetorno  :=      'Erro Cancela_Verba: ' || '(' || v_sq_log || ')'||SQLERRM;
                        --
        END     Cancela_Verba;
        --
END     ctactpa0013_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0014_001  IS
        --
        v_sq_log                NUMBER;
        --
        --------------------------------------------------------------------------
        --      RetornaDsVerba
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaDsVerba  (p_cd_tipo_verba        IN      VARCHAR2)
        RETURN          VARCHAR2        IS
        --
        v_tp_verba      VARCHAR2(4000);
        --
        BEGIN
                --
                SELECT  InitCap(nm_tipo_verba)
                INTO    v_tp_verba
                FROM    cta0003_tipo_verba
                WHERE   cd_tipo_verba   =       p_cd_tipo_verba;
                --
                RETURN  v_tp_verba;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_tp_verba      :=      ' ';
                        --
                        RETURN  v_tp_verba;
                        --
        END     RetornaDsVerba;
        --
        --------------------------------------------------------------------------
        --      RetornaDsVerbaVigencia
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaDsVerbaVigencia  (p_cd_tipo_verba        IN      VARCHAR2
                                                ,p_dt_inico_vigen       IN      DATE
                                                ,p_dt_fim_vigen         IN      DATE    )
        RETURN          VARCHAR2        IS
        --
        v_tp_verba      VARCHAR2(4000);
        --
        BEGIN
                --
                SELECT  InitCap(nm_tipo_verba)
                INTO    v_tp_verba
                FROM    cta0003_tipo_verba
                WHERE   cd_tipo_verba   =       p_cd_tipo_verba;
                --
                IF      p_cd_tipo_verba =       'C'     THEN
                        --
                        RETURN  v_tp_verba;
                        --
                ELSE
                        --
                        RETURN  v_tp_verba || ' - ' || to_char(p_dt_inico_vigen,'dd/mm/yyyy') || ' a ' || to_char(p_dt_fim_vigen,'dd/mm/yyyy');
                        --
                END     IF;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_tp_verba      :=      ' ';
                        --
                        RETURN  v_tp_verba;
                        --
        END     RetornaDsVerbaVigencia;
        --------------------------------------------------------------------------
        --      RetornaLancamento:      Verifica se o lanamento deve ser       --
        --                              retornado na query.                     --
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaLancamento       (p_nr_itseg             IN      NUMBER
                                                ,p_cd_situc_lacto       IN      VARCHAR2
                                                ,p_id_lacto             IN      NUMBER
                                                ,p_id_verba             IN      NUMBER  )
        RETURN          NUMBER  IS
        --
        v_count_lacto_PRO       NUMBER;
        v_count_lacto_EST       NUMBER;
        --
        BEGIN
                --
                IF      p_cd_situc_lacto        =       'EST'   THEN
                        --
                        SELECT  Count(1) soma
                        INTO    v_count_lacto_PRO
                        FROM    cta0004_lacto
                        WHERE   cd_item_ctrat   =       p_nr_itseg
                        AND     id_verba        =       p_id_verba
                        AND     cd_situc_lacto  IN      ('PRO', 'LIB',  'EFT');
                        --
                        --
                        IF      v_count_lacto_PRO       =       0       THEN
                                --
                                -- se no tem lanamento PRO/LIB/EFT, verifica se
                                -- o lanamento EST lido  o ultimo lanamento
                                -- EST do item para a verba.
                                --
                                SELECT  Count(1)
                                INTO    v_count_lacto_EST
                                FROM    cta0004_lacto
                                WHERE   cd_item_ctrat   =       p_nr_itseg
                                AND     cd_situc_lacto  =       'EST'
                                AND     id_lacto        =       p_id_lacto
                                AND     id_lacto        =       (SELECT  Max(id_lacto)
                                                                FROM    cta0004_lacto
                                                                WHERE   cd_item_ctrat   =       p_nr_itseg
                                                                AND     id_verba        =       p_id_verba
                                                                AND     cd_situc_lacto  =       'EST');
                                --
                                IF      v_count_lacto_EST       =       0       THEN
                                        --
                                        RETURN  1; -- no mostra o lanamento
                                        --
                                ELSE
                                        --
                                        RETURN  0; -- mostra o lanamento
                                        --
                                END     IF;
                                --
                        ELSE
                                --
                                RETURN  1; -- no mostra o lanamento
                                --
                        END     IF;
                        --
                ELSE
                        --
                        RETURN  0; -- mostra o lanamento
                        --
                END     IF;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  0;
                        --
        END     RetornaLancamento;
        --
        --------------------------------------------------------------------------
        --      RetornaDescAgrav:       Retorna o valor do lanamento no campo  --
        --                              desc/agrav quando for proviso de       --
        --                              debito                                  --
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaDescAgrav        (p_vl_agrvo_ppota       IN      NUMBER
                                                ,p_vl_lacto             IN      NUMBER
                                                ,p_cd_ngoco             IN      NUMBER
                                                ,p_tp_desct_agrvo       IN      VARCHAR2)
        RETURN          NUMBER  IS
        --
        BEGIN
                --
                IF      p_tp_desct_agrvo        =       'D'     THEN
                        --
                        IF      p_cd_ngoco      >       0       THEN
                                --
                                RETURN  p_vl_lacto;
                                --
                        ELSE
                                --
                                RETURN  0;
                                --
                        END     IF;
                        --
                ELSIF   p_tp_desct_agrvo        =       'A'     THEN
                        --
                        IF      p_cd_ngoco      >       0       THEN
                                --
                                RETURN  p_vl_agrvo_ppota;
                                --
                        ELSE
                                --
                                RETURN  0;
                                --
                        END     IF;
                        --
                ELSE
                        --
                        RETURN  0;
                        --
                END     IF;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  0;
                        --
        END     RetornaDescAgrav;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoAssessoria
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoAssessoriaVT        (p_id_verba_origm_trnsf IN      NUMBER
                                                        ,p_qt_registros         OUT     NUMBER
                                                        ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        v_qt_registros1 NUMBER;
        v_qt_registros2 NUMBER;
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    v_qt_registros1
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.id_verba_origm_trnsf  =       p_id_verba_origm_trnsf
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB','CRD')
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                SELECT  Count(1)
                INTO    v_qt_registros2
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.id_verba              =       p_id_verba_origm_trnsf
                AND     b.cd_situc_lacto        IN      ('CRD','DBT')
                AND     a.id_verba_origm_trnsf  IS      NULL
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB');
                --
                p_qt_registros  :=      v_qt_registros1 +       v_qt_registros2;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.id_verba_origm_trnsf  =       p_id_verba_origm_trnsf
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB','CRD')
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        UNION
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.id_verba              =       p_id_verba_origm_trnsf
                        AND     b.cd_situc_lacto        IN      ('CRD','DBT')
                        AND     a.id_verba_origm_trnsf  IS      NULL
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        ORDER   BY      7                        ;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoAssessoriaVT;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoCorretor
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoCorretorVT  (p_id_verba             IN      NUMBER
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.id_verba              =       p_id_verba
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.id_verba              =       p_id_verba
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoCorretorVT;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoAssessoria
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoAssessoriaVC        (p_cd_assessoria        IN      NUMBER
                                                        ,p_cd_segmento          IN      NUMBER
                                                        ,p_dt_inico_consulta    IN      DATE
                                                        ,p_dt_fim_consulta      IN      DATE
                                                        ,p_qt_registros         OUT     NUMBER
                                                        ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_asses              =       p_cd_assessoria
                AND     a.cd_segmt_prdut        =       p_cd_segmento
                AND     a.cd_tipo_verba         =       'C'
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_asses              =       p_cd_assessoria
                        AND     a.cd_segmt_prdut        =       p_cd_segmento
                        AND     a.cd_tipo_verba         =       'C'
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoAssessoriaVC;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoAssessoria
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoCorretorVC  (p_cd_corretor          IN      NUMBER
                                                ,p_cd_segmento          IN      NUMBER
                                                ,p_dt_inico_consulta    IN      DATE
                                                ,p_dt_fim_consulta      IN      DATE
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_crtor_segur        =       p_cd_corretor
                AND     a.cd_segmt_prdut        =       p_cd_segmento
                AND     a.cd_tipo_verba         =       'C'
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_crtor_segur        =       p_cd_corretor
                        AND     a.cd_segmt_prdut        =       p_cd_segmento
                        AND     a.cd_tipo_verba         =       'C'
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoCorretorVC;
        --
        --
        --------------------------------------------------------------------------
        --      RetornaLactoCPFCNPJ
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoCPFCNPJ     (p_cd_corretor          IN      NUMBER
                                                ,p_nr_cpf_cnpj          IN      NUMBER
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_crtor_segur        =       Nvl(p_cd_corretor,a.cd_crtor_segur)
                AND     b.nr_cpf_cnpj_clien     =       p_nr_cpf_cnpj
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_crtor_segur        =       Nvl(p_cd_corretor,a.cd_crtor_segur)
                        AND     b.nr_cpf_cnpj_clien     =       p_nr_cpf_cnpj
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoCPFCNPJ;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoContrato
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoContrato    (p_cd_corretor          IN      NUMBER
                                                ,p_cd_contrato          IN      NUMBER
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_crtor_segur        =       Nvl(p_cd_corretor,a.cd_crtor_segur)
                AND     b.cd_ctrat              =       p_cd_contrato
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  a.cd_crtor_segur                                        "CdCorretor",
                                b.id_lacto                                              "IdLancamento",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.nr_cpf_cnpj_clien                                     "CPFCNPJCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                b.dt_lacto                                              "DtLancamento",
                                ctactpa0014_001.RetornaDsVerbaVigencia  (a.cd_tipo_verba
                                                                ,a.dt_inico_vigen
                                                                ,a.dt_fim_vigen)        "TipoVerba",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_crtor_segur        =       Nvl(p_cd_corretor,a.cd_crtor_segur)
                        AND     b.cd_ctrat              =       p_cd_contrato
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoContrato;
        --
        --------------------------------------------------------------------------
        --      Consulta_Lancamento:    Consulta os lanamentos de um corretor  --
        --                              ou assessoria.                          --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Consulta_Lancamento     (p_consulta_lancamento_in       IN      consulta_lancamento_in
                                                ,p_consulta_lancamento_out      OUT     consulta_lancamento_out
                                                ,p_lista_lancamentos            OUT     sys_refcursor)        IS
        --
        v_dt_inico_consulta     DATE;
        v_dt_fim_consulta       DATE;
        v_qt_cpf                NUMBER;
        v_qt_contrato           NUMBER;
        --
        BEGIN
                --
                --      Iniciando o type de entrada
                --
                p_consulta_lancamento_out       :=      consulta_lancamento_out (0
                                                                                ,NULL
                                                                                ,0
                                                                                ,0
                                                                                ,null);
                --
                CTACTPA0100_001.IniciaLog       (141
                                                ,'CTA'
                                                ,p_consulta_lancamento_in.CdCorretor
                                                ,p_consulta_lancamento_in.CdAssessoria
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                            ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')            ||Chr(10)||
                                                 LPad('=',      80,     '=')                                                            ||Chr(10)||
                                                 'Servio Consulta_Lancamento. Parmetros de entrada: '                              ||Chr(10)||
                                                 ' TpAcesso.................... '||p_consulta_lancamento_in.TpAcesso                    ||Chr(10)||
                                                 ' IdVerba..................... '||p_consulta_lancamento_in.IdVerba                     ||Chr(10)||
                                                 ' CdAssessoria................ '||p_consulta_lancamento_in.CdAssessoria                ||Chr(10)||
                                                 ' CdCorretor.................. '||p_consulta_lancamento_in.CdCorretor                  ||Chr(10)||
                                                 ' CdSegmento.................. '||p_consulta_lancamento_in.CdSegmento                  ||Chr(10)||
                                                 ' DtInicioConsulta............ '||p_consulta_lancamento_in.DtInicioConsulta            ||Chr(10)||
                                                 ' DtFimConsulta............... '||p_consulta_lancamento_in.DtFimConsulta               ||Chr(10)||
                                                 ' QtRegistros................. '||p_consulta_lancamento_in.QtRegistros                 ||Chr(10)||
                                                 ' ChaveInicio................. '||p_consulta_lancamento_in.ChaveInicio                 ||Chr(10)||
                                                 ' NrCPFCNPJ................... '||p_consulta_lancamento_in.NrCPFCNPJ                   ||Chr(10)||
                                                 ' CdContrato.................. '||p_consulta_lancamento_in.CdContrato                  ||Chr(10)||
                                                 ' SistemaOrigem............... '||p_consulta_lancamento_in.SistemaOrigem               ||Chr(10)||
                                                 ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')         ||Chr(10)||
                                                 LPad('=',       80,     '='));
                --
                --      Transformando os types de entrada
                --
                v_dt_inico_consulta     :=      To_Date(p_consulta_lancamento_in.DtInicioConsulta,      'YYYYMMDD');
                v_dt_fim_consulta       :=      To_Date(p_consulta_lancamento_in.DtFimConsulta,         'YYYYMMDD');
                --
                -- Valida se o CPF/CNPJ/Negcio consultado  do corretor/assessoria somente se vier do PORTAL.
                --
                IF      p_consulta_lancamento_in.SistemaOrigem  =       'PTL'   THEN
                        --
                        IF      p_consulta_lancamento_in.TpAcesso       =       5       THEN
                                --
                                --      Validando se o CPF  uma proposta do corretor
                                --
                                IF      p_consulta_lancamento_in.CdCorretor     IS      NOT     NULL    THEN
                                        --
                                        SELECT  Count(1)
                                        INTO    v_qt_cpf
                                        FROM    cta0002_verba   a,
                                                cta0004_lacto   b
                                        WHERE   a.id_verba              =       b.id_verba
                                        AND     b.nr_cpf_cnpj_clien     =       p_consulta_lancamento_in.NrCPFCNPJ
                                        AND     a.cd_crtor_segur        =       p_consulta_lancamento_in.CdCorretor;
                                        --
                                        IF      v_qt_cpf   =       0       THEN
                                                --
                                                p_consulta_lancamento_out.StRetorno     :=      2;
                                                p_consulta_lancamento_out.MsgRetorno    :=      'Lanamento por CPF/CNPJ no encontrado para o corretor especificado';
                                                p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Erro Consulta_Lancamento: CPF/CNPJ ' || p_consulta_lancamento_in.NrCPFCNPJ || ' invlido para o corretor ' || p_consulta_lancamento_in.CdCorretor);
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                                LPad('=',      80,     '='));
                                                --
                                                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                                --
                                                RETURN;
                                                --
                                        END     IF;
                                        --
                                ELSIF   p_consulta_lancamento_in.CdAssessoria   IS      NOT     NULL    THEN
                                        --
                                        SELECT  count(1)
                                        INTO    v_qt_cpf
                                        FROM    cta0002_verba   a,
                                                cta0004_lacto   b,
                                                cta0012_crtor   c
                                        WHERE   a.id_verba              =       b.id_verba
                                        AND     c.cd_crtor_segur        =       a.cd_crtor_segur
                                        AND     b.nr_cpf_cnpj_clien     =       p_consulta_lancamento_in.NrCPFCNPJ
                                        AND     c.cd_asses              =       p_consulta_lancamento_in.CdAssessoria;
                                        --
                                        IF      v_qt_cpf   =       0       THEN
                                                --
                                                p_consulta_lancamento_out.StRetorno     :=      2;
                                                p_consulta_lancamento_out.MsgRetorno    :=      'Lanamento por CPF/CNPJ no encontrado para a assessoria especificada';
                                                p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Erro Consulta_Lancamento: CPF/CNPJ ' || p_consulta_lancamento_in.NrCPFCNPJ || ' invlido para a assessoria ' || p_consulta_lancamento_in.CdAssessoria );
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                                LPad('=',      80,     '='));
                                                --
                                                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                                --
                                                RETURN;
                                                --
                                        END     IF;
                                        --

                                        --
                                ELSE    -- corretor e assessoria nulos
                                        --
                                        p_consulta_lancamento_out.StRetorno     :=      3;
                                        p_consulta_lancamento_out.MsgRetorno    :=      'Para consulta por CPF/CNPJ  preciso indicar o cdigo do corretor ou da assessoria';
                                        p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'Erro Consulta_Lancamento: CPF/CNPJ ' || p_consulta_lancamento_in.NrCPFCNPJ || ' invlido para o corretor/assessoria' );
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                        LPad('=',      80,     '='));
                                        --
                                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        END     IF;
                        --
                        IF      p_consulta_lancamento_in.TpAcesso       =       6       THEN
                                --
                                --      Validando se o negcio  uma proposta do corretor
                                --
                                IF      p_consulta_lancamento_in.CdCorretor     IS      NOT     NULL    THEN
                                        --
                                        SELECT  Count(1)
                                        INTO    v_qt_contrato
                                        FROM    cta0002_verba   a,
                                                cta0004_lacto   b
                                        WHERE   a.id_verba              =       b.id_verba
                                        AND     b.cd_ctrat              =       p_consulta_lancamento_in.CdContrato
                                        AND     a.cd_crtor_segur        =       p_consulta_lancamento_in.CdCorretor;
                                        --
                                        IF      v_qt_contrato   =       0       THEN
                                                --
                                                p_consulta_lancamento_out.StRetorno     :=      2;
                                                p_consulta_lancamento_out.MsgRetorno    :=      'Lanamento por contrato no encontrado para o corretor especificado';
                                                p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Erro Consulta_Lancamento: Contrato ' || p_consulta_lancamento_in.CdContrato || ' invlido para o corretor ' || p_consulta_lancamento_in.CdCorretor);
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                                LPad('=',      80,     '='));
                                                --
                                                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                                --
                                                RETURN;
                                                --
                                        END     IF;
                                        --
                                ELSIF   p_consulta_lancamento_in.CdAssessoria   IS      NOT     NULL    THEN
                                        --
                                        SELECT  Count(1)
                                        INTO    v_qt_contrato
                                        FROM    cta0002_verba   a,
                                                cta0004_lacto   b,
                                                cta0012_crtor   c
                                        WHERE   a.id_verba              =       b.id_verba
                                        AND     c.cd_crtor_segur        =       a.cd_crtor_segur
                                        AND     b.cd_ctrat              =       p_consulta_lancamento_in.CdContrato
                                        AND     c.cd_asses      =       p_consulta_lancamento_in.CdAssessoria;
                                        --
                                        IF      v_qt_contrato   =       0       THEN
                                                --
                                                p_consulta_lancamento_out.StRetorno     :=      2;
                                                p_consulta_lancamento_out.MsgRetorno    :=      'Lanamento por contrato no encontrado para a assessoria especificada';
                                                p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'Erro Consulta_Lancamento: Contrato ' || p_consulta_lancamento_in.CdContrato || ' invlido para a assessoria ' || p_consulta_lancamento_in.CdAssessoria );
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                                LPad('=',      80,     '='));
                                                --
                                                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                                --
                                                RETURN;
                                                --
                                        END     IF;
                                        --
                                ELSE    -- corretor e assessoria nulos
                                        --
                                        p_consulta_lancamento_out.StRetorno     :=      3;
                                        p_consulta_lancamento_out.MsgRetorno    :=      'Para consulta por contrato  preciso indicar o cdigo do corretor ou da assessoria';
                                        p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'Erro Consulta_Lancamento: Contrato ' || p_consulta_lancamento_in.NrCPFCNPJ || ' invlido para o corretor/assessoria' );
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                                        LPad('=',      80,     '='));
                                        --
                                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        END     IF;
                        --
                END     IF;
                IF      p_consulta_lancamento_in.TpAcesso       =       1       THEN
                        --
                        --      Lanamentos Assessoria - Verba Tokio
                        --
                        RetornaLactoAssessoriaVT        (p_consulta_lancamento_in.IdVerba
                                                        ,p_consulta_lancamento_out.QtTotalRegistros
                                                        ,p_lista_lancamentos);
                        --
                ELSIF   p_consulta_lancamento_in.TpAcesso       =       2       THEN
                        --
                        --      Lanamentos Corretor - Verba Tokio
                        --
                        RetornaLactoCorretorVT          (p_consulta_lancamento_in.IdVerba
                                                        ,p_consulta_lancamento_out.QtTotalRegistros
                                                        ,p_lista_lancamentos);
                        --
                ELSIF   p_consulta_lancamento_in.TpAcesso       =       3       THEN
                        --
                        --      Lanamentos Assessoria - Verba Corretor
                        --
                        RetornaLactoAssessoriaVC        (p_consulta_lancamento_in.CdAssessoria
                                                        ,p_consulta_lancamento_in.CdSegmento
                                                        ,v_dt_inico_consulta
                                                        ,v_dt_fim_consulta
                                                        ,p_consulta_lancamento_out.QtTotalRegistros
                                                        ,p_lista_lancamentos);
                        --
                ELSIF   p_consulta_lancamento_in.TpAcesso       =       4       THEN
                        --
                        --      Lanamentos Corretor - Verba Corretor
                        --
                        RetornaLactoCorretorVC  (p_consulta_lancamento_in.CdCorretor
                                                ,p_consulta_lancamento_in.CdSegmento
                                                ,v_dt_inico_consulta
                                                ,v_dt_fim_consulta
                                                ,p_consulta_lancamento_out.QtTotalRegistros
                                                ,p_lista_lancamentos);
                        --
                ELSIF   p_consulta_lancamento_in.TpAcesso       =       5       THEN
                        --
                        --      Lanamentos por CPF/CNPJ
                        --
                        RetornaLactoCPFCNPJ     (p_consulta_lancamento_in.CdCorretor
                                                ,p_consulta_lancamento_in.NrCPFCNPJ
                                                ,p_consulta_lancamento_out.QtTotalRegistros
                                                ,p_lista_lancamentos);
                        --
                ELSIF   p_consulta_lancamento_in.TpAcesso       =       6       THEN
                        --
                        --      Lanamentos por Contrato (Negcio)
                        --
                        RetornaLactoContrato    (p_consulta_lancamento_in.CdCorretor
                                                ,p_consulta_lancamento_in.CdContrato
                                                ,p_consulta_lancamento_out.QtTotalRegistros
                                                ,p_lista_lancamentos);
                        --
                END     IF;
                --

                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Consulta_Lancamento: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_consulta_lancamento_out.StRetorno     :=      1;
                        p_consulta_lancamento_out.MsgRetorno    :=      'Erro Consulta_Lancamento: '||SQLERRM;
                        p_consulta_lancamento_out.IdLog         :=      v_sq_log;
                        --
        END     Consulta_Lancamento;
        --
        /*************************************************************************
         *      Procedures auxiliares do Relatorio_Lancamento                   **
         *************************************************************************/
        --
        --------------------------------------------------------------------------
        --      RetornaCdMdupr
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaCdMdupr  (p_id_prdut_sistm_origm IN      NUMBER)
        RETURN          NUMBER  IS
        --
        v_cd_prdut_sistm_origm  VARCHAR2(4000);
        --
        BEGIN
                --
                SELECT  To_Number(cd_prdut_sistm_origm)
                INTO    v_cd_prdut_sistm_origm
                FROM    cta0001_prdut
                WHERE   id_prdut        =       p_id_prdut_sistm_origm;
                --
                RETURN  v_cd_prdut_sistm_origm;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  NULL;
                        --
        END     RetornaCdMdupr;
        --
        --------------------------------------------------------------------------
        --      RetornaNmSegmt
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaNmSegmt  (p_cd_segmt_prdut       IN      NUMBER)
        RETURN          VARCHAR2        IS
        --
        v_nm_segmt_prdut        VARCHAR2(4000);
        --
        BEGIN
                --
                SELECT  nm_segmt_prdut
                INTO    v_nm_segmt_prdut
                FROM    cta0006_segmt_prdut
                WHERE   cd_segmt_prdut  =       p_cd_segmt_prdut;
                --
                RETURN  v_nm_segmt_prdut;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  ' ';
                        --
        END     RetornaNmSegmt;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoCorretor
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoCorretor    (p_cd_corretor          IN      NUMBER
                                                ,p_dt_inico_consulta    IN      DATE
                                                ,p_dt_fim_consulta      IN      DATE
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_crtor_segur        =       p_cd_corretor
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  b.id_lacto                                              "IdLancamento",
                                b.cd_diret_comrl                                        "CdDiretoria",
                                b.cd_sucsl_comrl                                        "CdSucursal",
                                a.cd_asses                                              "CdAssessoria",
                                a.cd_crtor_segur                                        "CdCorretor",
                                ctactpa0014_001.RetornaCdMdupr(b.id_prdut_sistm_origm)  "CdModulo",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                ctactpa0014_001.RetornaNmSegmt(a.cd_segmt_prdut)        "NmSegmento",
                                a.id_verba                                              "IdVerba",
                                ctactpa0014_001.RetornaDsVerba(a.cd_tipo_verba)         "DsVerba",
                                b.vl_prmio_liqui_ppota                                  "VlSemAgravoDesconto",
                                Decode(b.tp_desct_agrvo,        'D',    b.vl_prmio_liqui_ppota  -       b.vl_lacto,
                                                                'A',    b.vl_prmio_liqui_ppota  +       b.vl_lacto,
                                                                '0')                    "VlComAgravoDesconto",
                                b.dt_lacto                                              "DtLancamento",
                                To_Char(a.dt_inico_vigen,       'DD/MM/YYYY')||' - '||To_Char(a.dt_fim_vigen,       'DD/MM/YYYY')       "DtVerba",
                                b.vl_saldo_verba_postr                                  "VlSaldo",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido",
                                a.cd_situc_verba                                        "StatusVerba"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_crtor_segur        =       p_cd_corretor
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro RetornaLactoCorretor: '||SQLERRM);
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoCorretor;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoAssessoria
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoAssessoria  (p_cd_assessoria        IN      NUMBER
                                                ,p_dt_inico_consulta    IN      DATE
                                                ,p_dt_fim_consulta      IN      DATE
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_asses              =       p_cd_assessoria
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  b.id_lacto                                              "IdLancamento",
                                b.cd_diret_comrl                                        "CdDiretoria",
                                b.cd_sucsl_comrl                                        "CdSucursal",
                                a.cd_asses                                              "CdAssessoria",
                                a.cd_crtor_segur                                        "CdCorretor",
                                ctactpa0014_001.RetornaCdMdupr(b.id_prdut_sistm_origm)  "CdModulo",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                ctactpa0014_001.RetornaNmSegmt(a.cd_segmt_prdut)        "NmSegmento",
                                a.id_verba                                              "IdVerba",
                                ctactpa0014_001.RetornaDsVerba(a.cd_tipo_verba)         "DsVerba",
                                b.vl_prmio_liqui_ppota                                  "VlSemAgravoDesconto",
                                Decode(b.tp_desct_agrvo,        'D',    b.vl_prmio_liqui_ppota  -       b.vl_lacto,
                                                                'A',    b.vl_prmio_liqui_ppota  +       b.vl_lacto,
                                                                '0')                    "VlComAgravoDesconto",
                                b.dt_lacto                                              "DtLancamento",
                                To_Char(a.dt_inico_vigen,       'DD/MM/YYYY')||' - '||To_Char(a.dt_fim_vigen,       'DD/MM/YYYY')       "DtVerba",
                                b.vl_saldo_verba_postr                                  "VlSaldo",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido",
                                a.cd_situc_verba                                        "StatusVerba"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     a.cd_asses              =       p_cd_assessoria
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoAssessoria;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoSucursal
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoSucursal    (p_cd_sucursal          IN      NUMBER
                                                ,p_dt_inico_consulta    IN      DATE
                                                ,p_dt_fim_consulta      IN      DATE
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     b.cd_sucsl_comrl        =       p_cd_sucursal
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  b.id_lacto                                              "IdLancamento",
                                b.cd_diret_comrl                                        "CdDiretoria",
                                b.cd_sucsl_comrl                                        "CdSucursal",
                                a.cd_asses                                              "CdAssessoria",
                                a.cd_crtor_segur                                        "CdCorretor",
                                ctactpa0014_001.RetornaCdMdupr(b.id_prdut_sistm_origm)  "CdModulo",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                ctactpa0014_001.RetornaNmSegmt(a.cd_segmt_prdut)        "NmSegmento",
                                a.id_verba                                              "IdVerba",
                                ctactpa0014_001.RetornaDsVerba(a.cd_tipo_verba)         "DsVerba",
                                b.vl_prmio_liqui_ppota                                  "VlSemAgravoDesconto",
                                Decode(b.tp_desct_agrvo,        'D',    b.vl_prmio_liqui_ppota  -       b.vl_lacto,
                                                                'A',    b.vl_prmio_liqui_ppota  +       b.vl_lacto,
                                                                '0')                    "VlComAgravoDesconto",
                                b.dt_lacto                                              "DtLancamento",
                                To_Char(a.dt_inico_vigen,       'DD/MM/YYYY')||' - '||To_Char(a.dt_fim_vigen,       'DD/MM/YYYY')       "DtVerba",
                                b.vl_saldo_verba_postr                                  "VlSaldo",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido",
                                a.cd_situc_verba                                        "StatusVerba"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     b.cd_sucsl_comrl        =       p_cd_sucursal
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoSucursal;
        --
        --------------------------------------------------------------------------
        --      RetornaLactoDiretoria
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaLactoDiretoria   (p_cd_diretoria         IN      NUMBER
                                                ,p_dt_inico_consulta    IN      DATE
                                                ,p_dt_fim_consulta      IN      DATE
                                                ,p_qt_registros         OUT     NUMBER
                                                ,p_lista_lancamentos    OUT     sys_refcursor)  IS
        --
        BEGIN
                --
                --      Retornando o nmero de registros
                --
                SELECT  Count(1)
                INTO    p_qt_registros
                FROM    cta0002_verba   a,
                        cta0004_lacto   b
                WHERE   a.id_verba              =       b.id_verba
                AND     b.cd_diret_comrl        =       p_cd_diretoria
                AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                ,b.cd_situc_lacto
                                                                ,b.id_lacto
                                                                ,b.id_verba)    =       0;
                --
                --      Retornando os registros
                --
                OPEN    p_lista_lancamentos     FOR
                        --
                        SELECT  b.id_lacto                                              "IdLancamento",
                                b.cd_diret_comrl                                        "CdDiretoria",
                                b.cd_sucsl_comrl                                        "CdSucursal",
                                a.cd_asses                                              "CdAssessoria",
                                a.cd_crtor_segur                                        "CdCorretor",
                                ctactpa0014_001.RetornaCdMdupr(b.id_prdut_sistm_origm)  "CdModulo",
                                b.nm_clien_sgrdo                                        "NmCliente",
                                b.cd_ctrat                                              "CdContrato",
                                b.cd_item_ctrat                                         "CdItemContrato",
                                ctactpa0014_001.RetornaNmSegmt(a.cd_segmt_prdut)        "NmSegmento",
                                a.id_verba                                              "IdVerba",
                                ctactpa0014_001.RetornaDsVerba(a.cd_tipo_verba)         "DsVerba",
                                b.vl_prmio_liqui_ppota                                  "VlSemAgravoDesconto",
                                Decode(b.tp_desct_agrvo,        'D',    b.vl_prmio_liqui_ppota  -       b.vl_lacto,
                                                                'A',    b.vl_prmio_liqui_ppota  +       b.vl_lacto,
                                                                '0')                    "VlComAgravoDesconto",
                                b.dt_lacto                                              "DtLancamento",
                                To_Char(a.dt_inico_vigen,       'DD/MM/YYYY')||' - '||To_Char(a.dt_fim_vigen,       'DD/MM/YYYY')       "DtVerba",
                                b.vl_saldo_verba_postr                                  "VlSaldo",
                                Decode(b.cd_situc_lacto ,'PRO', 'Provisionado'
                                                        ,'EST', 'Estornado'
                                                        ,'LIB', 'Liberado'
                                                        ,'EFT', 'Efetivado'
                                                        ,'CRD', 'Creditado'
                                                        ,'DBT', 'Debitado'
                                                        ,'END', 'Est. Endosso'
                                                        ,'*********')                   "StLancamento",
                                b.tp_desct_agrvo                                        "InDescontoAgravo",
                                ctactpa0014_001.RetornaDescAgrav(b.vl_agrvo_ppota
                                                                ,b.vl_lacto
                                                                ,b.cd_ctrat
                                                                ,b.tp_desct_agrvo)      "VlCreditoAgravo",
                                b.vl_lacto                                              "VlLancamento",
                                b.vl_prmio_liqui_ppota                                  "VlPremioLiquido",
                                a.cd_situc_verba                                        "StatusVerba"
                        FROM    cta0002_verba   a,
                                cta0004_lacto   b
                        WHERE   a.id_verba              =       b.id_verba
                        AND     b.cd_diret_comrl        =       p_cd_diretoria
                        AND     b.cd_situc_lacto        NOT     IN      ('CAN', 'AGB')
                        AND     b.dt_lacto              BETWEEN p_dt_inico_consulta     AND     p_dt_fim_consulta
                        AND     ctactpa0014_001.RetornaLancamento       (b.cd_item_ctrat
                                                                        ,b.cd_situc_lacto
                                                                        ,b.id_lacto
                                                                        ,b.id_verba)    =       0
                        ORDER   BY      b.dt_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_qt_registros  :=      0;
                        --
        END     RetornaLactoDiretoria;
        --
        --------------------------------------------------------------------------
        --      Relatorio_Lancamento:   Gerar relatrio dos lanamentos de um   --
        --                              corretor / assessoria / diretoria ou    --
        --                              sucursal.                               --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Relatorio_Lancamento    (p_relatorio_lancamento_in      IN      relatorio_lancamento_in
                                                ,p_relatorio_lancamento_out     OUT     relatorio_lancamento_out
                                                ,p_relatorio_lancamentos        OUT     sys_refcursor)  IS
        --
        v_dt_inico_consulta     DATE;
        v_dt_fim_consulta       DATE;
        --
        BEGIN
                --
                p_relatorio_lancamento_out      :=      relatorio_lancamento_out        (0
                                                                                        ,NULL
                                                                                        ,0
                                                                                        ,NULL);
                --
                v_dt_inico_consulta     :=      To_Date(p_relatorio_lancamento_in.DtInicoConsulta,      'YYYYMMDD');
                v_dt_fim_consulta       :=      To_Date(p_relatorio_lancamento_in.DtFimConsulta,        'YYYYMMDD');
                --
                CTACTPA0100_001.IniciaLog       (142
                                                ,'CTA'
                                                ,p_relatorio_lancamento_in.CdCorretor
                                                ,p_relatorio_lancamento_in.CdAssessoria
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                            ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')            ||Chr(10)||
                                                 LPad('=',      80,     '=')                                                            ||Chr(10)||
                                                 'Servio Relatorio_Lancamento. Parmetros de entrada: '                                ||Chr(10)||
                                                 ' TpAcesso.................... '||p_relatorio_lancamento_in.TpAcesso                   ||Chr(10)||
                                                 ' CdAssessoria................ '||p_relatorio_lancamento_in.CdAssessoria               ||Chr(10)||
                                                 ' CdCorretor.................. '||p_relatorio_lancamento_in.CdCorretor                 ||Chr(10)||
                                                 ' CdSucursal.................. '||p_relatorio_lancamento_in.CdSucursal                 ||Chr(10)||
                                                 ' CdDiretoria................. '||p_relatorio_lancamento_in.CdDiretoria                ||Chr(10)||
                                                 ' DtInicoConsulta............. '||v_dt_inico_consulta                                  ||Chr(10)||
                                                 ' DtFimConsulta............... '||v_dt_fim_consulta                                    ||Chr(10)||
                                                 ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')         ||Chr(10)||
                                                 LPad('=',       80,     '='));
                --
                IF      p_relatorio_lancamento_in.TpAcesso      =       1       THEN
                        --
                        --      Lanamentos Corretor
                        --
                        RetornaLactoCorretor    (p_relatorio_lancamento_in.CdCorretor
                                                ,v_dt_inico_consulta
                                                ,v_dt_fim_consulta
                                                ,p_relatorio_lancamento_out.QtTotalRegistros
                                                ,p_relatorio_lancamentos);
                        --
                ELSIF   p_relatorio_lancamento_in.TpAcesso      =       2       THEN
                        --
                        --      Lanamentos Assessoria
                        --
                        RetornaLactoAssessoria  (p_relatorio_lancamento_in.CdAssessoria
                                                ,v_dt_inico_consulta
                                                ,v_dt_fim_consulta
                                                ,p_relatorio_lancamento_out.QtTotalRegistros
                                                ,p_relatorio_lancamentos);
                        --
                ELSIF   p_relatorio_lancamento_in.TpAcesso      =       3       THEN
                        --
                        --      Lanamentos Sucursal
                        --
                        RetornaLactoSucursal    (p_relatorio_lancamento_in.CdSucursal
                                                ,v_dt_inico_consulta
                                                ,v_dt_fim_consulta
                                                ,p_relatorio_lancamento_out.QtTotalRegistros
                                                ,p_relatorio_lancamentos);
                        --
                ELSIF   p_relatorio_lancamento_in.TpAcesso      =       4       THEN
                        --
                        --      Lanamentos Diretoria
                        --
                        RetornaLactoDiretoria   (p_relatorio_lancamento_in.CdDiretoria
                                                ,v_dt_inico_consulta
                                                ,v_dt_fim_consulta
                                                ,p_relatorio_lancamento_out.QtTotalRegistros
                                                ,p_relatorio_lancamentos);
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Registros retornados: '||p_relatorio_lancamento_out.QtTotalRegistros);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                p_relatorio_lancamento_out.IdLog        :=      v_sq_log;
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Consulta_Lancamento: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_relatorio_lancamento_out.StRetorno    :=      1;
                        p_relatorio_lancamento_out.MsgRetorno   :=      'Erro Relatorio_Lancamento: '||SQLERRM;
                        p_relatorio_lancamento_out.IdLog        :=      v_sq_log;
                        --
        END     Relatorio_Lancamento;
        --
END     ctactpa0014_001;
/


CREATE OR REPLACE PACKAGE BODY    ctactpa0015_001 IS
        --
        v_sq_log        NUMBER;
        --
        --------------------------------------------------------------------------
        --      Consulta_Log:   Retorna uma lista de log's do conta corrente de --
        --                      acordo com os parmetros enviados.              --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Consulta_Log    (p_consulta_log_in      IN      consulta_log_in
                                        ,p_consulta_log_out     OUT     consulta_log_out
                                        ,p_lista_logs           OUT     sys_refcursor)  IS
        --
        v_cont_registros        NUMBER;
        erro_fatal              EXCEPTION;
        v_dt_inicio_pesquisa    DATE;
        v_dt_fim_pesquisa       DATE;
        aux                     VARCHAR2(30);
        v_HrFimPesquisa         NUMBER;
        --
        BEGIN
                --
                p_consulta_log_out      :=      consulta_log_out        (0
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL);
                --
                CTACTPA0100_001.IniciaLog       (151
                                                ,'CTA'
                                                ,p_consulta_log_in.CdCorretor
                                                ,NULL
                                                ,p_consulta_log_in.CdContrato
                                                ,p_consulta_log_in.CdItemContrato
                                                ,NULL
                                                ,p_consulta_log_in.NrCPFCNPJ
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                     ||Chr(10)||
                                                'Servio Consulta_Log. Parmetros de entrada: '                                 ||Chr(10)||
                                                ' CdCorretor............ '||p_consulta_log_in.CdCorretor                        ||Chr(10)||
                                                ' CdContrato............ '||p_consulta_log_in.CdContrato                        ||Chr(10)||
                                                ' CdItemContrato........ '||p_consulta_log_in.CdItemContrato                    ||Chr(10)||
                                                ' DtInicioPesquisa...... '||p_consulta_log_in.DtInicioPesquisa                  ||Chr(10)||
                                                ' HrInicioPesquisa...... '||p_consulta_log_in.HrInicioPesquisa                  ||Chr(10)||
                                                ' DtFimPesquisa......... '||p_consulta_log_in.DtFimPesquisa                     ||Chr(10)||
                                                ' HrFimPesquisa......... '||p_consulta_log_in.HrFimPesquisa                     ||Chr(10)||
                                                ' CdServicoSelecionado.. '||p_consulta_log_in.CdServicoSelecionado              ||Chr(10)||
                                                ' CdServicoExcluido..... '||p_consulta_log_in.CdServicoExcluido                 ||Chr(10)||
                                                ' NrCPFCNPJ............. '||p_consulta_log_in.NrCPFCNPJ                         ||Chr(10)||
                                                ' CdProduto............. '||p_consulta_log_in.CdProduto                         ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')        ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Se o servio selecionado e o excludo estiver NULL,
                --      dar erro.
                --
                IF      p_consulta_log_in.CdServicoSelecionado  IS      NOT     NULL
                AND     p_consulta_log_in.CdServicoExcluido     IS      NOT     NULL    THEN
                        --
                        p_consulta_log_out.StRetorno    :=      106;
                        p_consulta_log_out.MsgRetorno   :=      'Cdigo de servio selecionado e excluido no podem ser usados em conjunto.';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                BEGIN
                        --
                        v_dt_inicio_pesquisa    :=      To_Date(p_consulta_log_in.DtInicioPesquisa,'yyyymmdd');
                        --
                EXCEPTION
                        --
                        WHEN Others THEN
                                --
                                v_dt_inicio_pesquisa     :=      NULL;
                                --
                END;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Inicio Pesquisa] = '|| To_Char(v_dt_inicio_pesquisa,'dd/mm/yyyy'));
                --
                BEGIN
                        --
                        v_dt_fim_pesquisa       :=      To_Date(p_consulta_log_in.DtFimPesquisa,'yyyymmdd');
                        --
                EXCEPTION
                        --
                        WHEN Others THEN
                                --
                                v_dt_fim_pesquisa       :=      NULL;
                                --
                END;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Fim Pesquisa] = '|| To_Char(v_dt_fim_pesquisa,'dd/mm/yyyy'));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Inicio Pesquisa com Hora] = '|| To_Char(v_dt_inicio_pesquisa,'dd/mm/yyyy hh24:mi:ss'));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Fim Pesquisa com Hora] = '|| To_Char(v_dt_fim_pesquisa,'dd/mm/yyyy hh24:mi:ss'));
                --
                IF      v_dt_inicio_pesquisa    IS      NOT     NULL    THEN
                        --
                        IF      p_consulta_log_in.HrInicioPesquisa      IS      NOT     NULL    THEN
                                --
                                BEGIN
                                        --
                                        aux     :=      Lpad(p_consulta_log_in.HrInicioPesquisa,6,'0');
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[aux] = '|| aux);
                                        --
                                        v_dt_inicio_pesquisa       :=      To_Date(To_Char(v_dt_inicio_pesquisa,'yyyymmdd') || ' ' || Lpad(p_consulta_log_in.HrInicioPesquisa,6,'0'),'yyyymmdd hh24miss') ;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[Inicio Pesquisa com Hora aps converso] = '|| To_Char(v_dt_inicio_pesquisa,'dd/mm/yyyy hh24:mi:ss'));

                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'[Erro Converso Hora - Inicio Pesquisa] = '|| To_Char(v_dt_inicio_pesquisa,'dd/mm/yyyy hh24:mi:ss'));
                                        --
                                END;
                                --
                        END     IF;
                        --
                END     IF;
                --
                IF      v_dt_fim_pesquisa       IS      NOT     NULL    THEN
                        --
                        IF      p_consulta_log_in.HrFimPesquisa IS      NULL    THEN
                                --
                                v_HrFimPesquisa :=      235959;
                                --
                        ELSE
                                --
                                v_HrFimPesquisa :=      p_consulta_log_in.HrFimPesquisa;
                                --
                        END     IF;
                        --
                        IF      v_HrFimPesquisa IS      NOT     NULL    THEN
                                --
                                BEGIN
                                        --
                                        aux     :=      Lpad(v_HrFimPesquisa,6,'0');
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[aux] = '|| aux);
                                        --
                                        aux     :=      To_Char(v_dt_fim_pesquisa,'yyyymmdd') || ' ' || Lpad(v_HrFimPesquisa,6,'0');
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[aux2] = '|| aux);
                                        --
                                        v_dt_fim_pesquisa       :=      To_Date(To_Char(v_dt_fim_pesquisa,'yyyymmdd') || ' ' || Lpad(v_HrFimPesquisa,6,'0'),'yyyymmdd hh24miss') ;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[Fim Pesquisa com Hora aps converso] = '|| To_Char(v_dt_fim_pesquisa,'dd/mm/yyyy hh24:mi:ss'));

                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                                ,'[Erro Converso Hora - Fim Pesquisa] = '|| To_Char(v_dt_fim_pesquisa,'dd/mm/yyyy hh24:mi:ss'));
                                        --
                                END;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Retornando cursor de Servio Selecionado
                --
                IF      p_consulta_log_in.CdServicoSelecionado  IS      NOT     NULL    THEN
                        --
                        --      Retornando quantidade de registros
                        --
                        SELECT  Count(1)
                        INTO    p_consulta_log_out.QtTotalRegistros
                        FROM    cta0017_log_servc
                        WHERE   cd_crtor_segur                  =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                        AND     cd_ctrat                        =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                        AND     cd_item_ctrat                   =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                        AND     nr_cpf_cnpj_clien               =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                        AND     id_servc                        =       Nvl(p_consulta_log_in.CdServicoSelecionado,id_servc)
                        AND     dt_hora_inico_log_servc  >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                        AND     dt_hora_fim_log_servc    <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[CdServicoSelecionado - Total de Registros] = '||p_consulta_log_out.QtTotalRegistros);
                        --
                        OPEN    p_lista_logs    FOR
                                --
                                SELECT  id_log_servc                            AS      IdLogServico,
                                        Decode  (id_servc
                                                ,011,   'ConsultaSaldoDesconto'
                                                ,021,   'ValidaValor'
                                                ,031,   'ProvisionaValor'
                                                ,041,   'EfetivaProviso'
                                                ,051,   'EstornaProviso'
                                                ,061,   'TransfereVerbaCorretor'
                                                ,071,   'DistribuiVerbaAssessoria'
                                                ,081,   'TransfereVerbaAssessorias'
                                                ,091,   'CreditaVerbaCarteira'
                                                ,101,   'AtualizaCadastroCorretores'
                                                ,111,   'TransfereCorretorAssessoria'
                                                ,121,   'ConsultaSaldoPortal'
                                                ,131,   'CancelaVerba'
                                                ,141,   'ConsultaLanamento'
                                                ,142,   'RelatorioLanamento'
                                                ,151,   'ConsultaLog'
                                                ,511,   'ValidaTrocaCorretorAuto'
                                                ,521,   'ValidaTrocaCorretorMr'
                                                ,521,   'ReservaNumNegocioItem'
                                                ,'** No Especificado **')      AS      DsServico,
                                        cd_asses                                AS      CdAssessoria,
                                        cd_crtor_segur                          AS      CdCorretor  ,
                                        nm_clien_sgrdo                          AS      NmCliente   ,
                                        nr_cpf_cnpj_clien                       AS      NrCPFCNPJ   ,
                                        cd_ctrat                                AS      CdContrato    ,
                                        cd_item_ctrat                           AS      CdItemContrato,
                                        cd_usuro                                AS      CdUsuario     ,
                                        b.nm_tipo_procs                         AS      DsTipoProcesso,
                                        SYSDATE                                 AS      DtInicioExecucao,
                                        SYSDATE                                 AS      DtFimExecucao
                                FROM    cta0017_log_servc       a,
                                        cta0015_tipo_procs      b
                                WHERE   a.cd_tipo_procs         =       b.cd_tipo_procs (+)
                                AND     cd_crtor_segur          =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                                AND     cd_ctrat                =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                                AND     cd_item_ctrat           =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                                AND     nr_cpf_cnpj_clien       =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                                AND     id_servc                =       Nvl(p_consulta_log_in.CdServicoSelecionado,id_servc)
                                AND     dt_hora_inico_log_servc >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                                AND     dt_hora_fim_log_servc   <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc)
                                ORDER BY id_log_servc;
                                --
                ELSIF   p_consulta_log_in.CdServicoExcluido     IS      NOT     NULL    THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Segundo Select] CdServicoSelecionado nulo');
                        --
                        SELECT  Count(1)
                        INTO    p_consulta_log_out.QtTotalRegistros
                        FROM    cta0017_log_servc
                        WHERE   cd_crtor_segur          =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                        AND     cd_ctrat                =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                        AND     cd_item_ctrat           =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                        AND     nr_cpf_cnpj_clien       =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                        AND     id_servc                <>      Nvl(p_consulta_log_in.CdServicoExcluido,id_servc)
                        AND     dt_hora_inico_log_servc >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                        AND     dt_hora_fim_log_servc   <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[CdServicoExcluido - Total de Registros] = '||p_consulta_log_out.QtTotalRegistros);                        --
                        OPEN    p_lista_logs    FOR
                                --
                                SELECT  id_log_servc                            AS      IdLogServico,
                                        Decode  (id_servc
                                                ,011,   'ConsultaSaldoDesconto'
                                                ,021,   'ValidaValor'
                                                ,031,   'ProvisionaValor'
                                                ,041,   'EfetivaProviso'
                                                ,051,   'EstornaProviso'
                                                ,061,   'TransfereVerbaCorretor'
                                                ,071,   'DistribuiVerbaAssessoria'
                                                ,081,   'TransfereVerbaAssessorias'
                                                ,091,   'CreditaVerbaCarteira'
                                                ,101,   'AtualizaCadastroCorretores'
                                                ,111,   'TransfereCorretorAssessoria'
                                                ,121,   'ConsultaSaldoPortal'
                                                ,131,   'CancelaVerba'
                                                ,141,   'ConsultaLanamento'
                                                ,142,   'RelatorioLanamento'
                                                ,151,   'ConsultaLog'
                                                ,511,   'ValidaTrocaCorretorAuto'
                                                ,521,   'ValidaTrocaCorretorMr'
                                                ,521,   'ReservaNumNegocioItem'
                                                ,'** No Especificado **')      AS      DsServico,
                                        cd_asses                                AS      CdAssessoria,
                                        cd_crtor_segur                          AS      CdCorretor,
                                        nm_clien_sgrdo                          AS      NmCliente,
                                        nr_cpf_cnpj_clien                       AS      NrCPFCNPJ,
                                        cd_ctrat                                AS      CdContrato,
                                        cd_item_ctrat                           AS      CdItemContrato,
                                        cd_usuro                                AS      CdUsuario,
                                        b.nm_tipo_procs                         AS      DsTipoProcesso,
                                        SYSDATE                                 AS      DtInicioExecucao,
                                        SYSDATE                                 AS      DtFimExecucao
                                FROM    cta0017_log_servc       a,
                                        cta0015_tipo_procs      b
                                WHERE   a.cd_tipo_procs         =       b.cd_tipo_procs (+)
                                AND     cd_crtor_segur          =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                                AND     cd_ctrat                =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                                AND     cd_item_ctrat           =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                                AND     nr_cpf_cnpj_clien       =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                                AND     id_servc                <>      Nvl(p_consulta_log_in.CdServicoExcluido,id_servc)
                                AND     dt_hora_inico_log_servc >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                                AND     dt_hora_fim_log_servc   <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc)
                                ORDER BY id_log_servc;
                        --
                ELSE
                        SELECT  Count(1)
                        INTO    p_consulta_log_out.QtTotalRegistros
                        FROM    cta0017_log_servc
                        WHERE   cd_crtor_segur          =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                        AND     cd_ctrat                =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                        AND     cd_item_ctrat           =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                        AND     nr_cpf_cnpj_clien       =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                        AND     dt_hora_inico_log_servc >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                        AND     dt_hora_fim_log_servc   <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Total de Registros] = '||p_consulta_log_out.QtTotalRegistros);                        --
                        OPEN    p_lista_logs    FOR
                                --
                                SELECT  id_log_servc                            AS      IdLogServico,
                                        Decode  (id_servc
                                                ,011,   'ConsultaSaldoDesconto'
                                                ,021,   'ValidaValor'
                                                ,031,   'ProvisionaValor'
                                                ,041,   'EfetivaProviso'
                                                ,051,   'EstornaProviso'
                                                ,061,   'TransfereVerbaCorretor'
                                                ,071,   'DistribuiVerbaAssessoria'
                                                ,081,   'TransfereVerbaAssessorias'
                                                ,091,   'CreditaVerbaCarteira'
                                                ,101,   'AtualizaCadastroCorretores'
                                                ,111,   'TransfereCorretorAssessoria'
                                                ,121,   'ConsultaSaldoPortal'
                                                ,131,   'CancelaVerba'
                                                ,141,   'ConsultaLanamento'
                                                ,142,   'RelatorioLanamento'
                                                ,151,   'ConsultaLog'
                                                ,511,   'ValidaTrocaCorretorAuto'
                                                ,521,   'ValidaTrocaCorretorMr'
                                                ,521,   'ReservaNumNegocioItem'
                                                ,'** No Especificado **')      AS      DsServico,
                                        cd_asses                                AS      CdAssessoria,
                                        cd_crtor_segur                          AS      CdCorretor,
                                        nm_clien_sgrdo                          AS      NmCliente,
                                        nr_cpf_cnpj_clien                       AS      NrCPFCNPJ,
                                        cd_ctrat                                AS      CdContrato,
                                        cd_item_ctrat                           AS      CdItemContrato,
                                        cd_usuro                                AS      CdUsuario,
                                        b.nm_tipo_procs                         AS      DsTipoProcesso,
                                        SYSDATE                                 AS      DtInicioExecucao,
                                        SYSDATE                                 AS      DtFimExecucao
                                FROM    cta0017_log_servc       a,
                                        cta0015_tipo_procs      b
                                WHERE   a.cd_tipo_procs         =       b.cd_tipo_procs (+)
                                AND     cd_crtor_segur          =       Nvl(p_consulta_log_in.CdCorretor,cd_crtor_segur)
                                AND     cd_ctrat                =       Nvl(p_consulta_log_in.CdContrato,cd_ctrat)
                                AND     cd_item_ctrat           =       Nvl(p_consulta_log_in.CdItemContrato,cd_item_ctrat)
                                AND     nr_cpf_cnpj_clien       =       Nvl(p_consulta_log_in.NrCPFCNPJ,nr_cpf_cnpj_clien)
                                AND     dt_hora_inico_log_servc >=      Nvl(v_dt_inicio_pesquisa,dt_hora_inico_log_servc)
                                AND     dt_hora_fim_log_servc   <=      Nvl(v_dt_fim_pesquisa,dt_hora_fim_log_servc)
                                ORDER BY id_log_servc;
                        --

                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Cdigo de retorno]: '||p_consulta_log_out.StRetorno||' [Mensagem de retorno]: '||p_consulta_log_out.MsgRetorno       ||Chr(10)||
                                                 LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                 'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                 LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_consulta_log_out.StRetorno||' - Mensagem: '||p_consulta_log_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Consulta_Log: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_consulta_log_out.StRetorno    :=      1;
                        p_consulta_log_out.MsgRetorno   :=      'Erro Consulta_Log: '||SQLERRM;
                        --
        END     Consulta_Log;
        --
END     CTACTPA0015_001;
/


CREATE OR REPLACE PACKAGE BODY    ctactpa0016_001 IS

		/* VERSAO V 9.0 */

        --
        v_sq_log                NUMBER;
        v_VlAgravoDesconto      NUMBER(15,2);
        --
        --------------------------------------------------------------------------
        --      RetornaIdVerbaEstorno:  Retorna o id_verba da verba de estorno. --
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaIdVerbaEstorno   (p_id_verba     IN      NUMBER)
        RETURN          NUMBER  IS
        --
        v_id_verba_estorno      NUMBER;
        --
        BEGIN
                --
                SELECT  Max(id_verba)
                INTO    v_id_verba_estorno
                FROM    cta0002_verba
                WHERE   id_verba_origm_trnsf    =       p_id_verba
                AND     cd_usuro_ultma_alter    =       'ESTORNO';
                --
                RETURN  v_id_verba_estorno;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro RetornaIdVerbaEstorno: '||SQLERRM);
                        --
                        RETURN  NULL;
                        --
        END     RetornaIdVerbaEstorno;
        --
        --------------------------------------------------------------------------
        --      RetornaIdVerba
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaIdVerba
        RETURN          NUMBER  IS
        --
        v_id_verba      NUMBER;
        --
        BEGIN
                --
                SELECT  ctasq0002_verba.NEXTVAL
                INTO    v_id_verba
                FROM    dual;
                --
                RETURN  v_id_verba;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro RetornaIdVerba: '||SQLERRM);
                        --
                        RETURN  NULL;
                        --
        END     RetornaIdVerba;
        --
        --------------------------------------------------------------------------
        --      RetornaIdLacto
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaIdLacto
        RETURN          NUMBER  IS
        --
        v_id_lacto      NUMBER;
        --
        BEGIN
                --
                SELECT  ctasq0004_lacto.NEXTVAL
                INTO    v_id_lacto
                FROM    dual;
                --
                RETURN  v_id_lacto;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro RetornaIdLacto: '||SQLERRM);
                        --
                        RETURN  NULL;
                        --
        END     RetornaIdLacto;
        --
        --------------------------------------------------------------------------
        --      Cancelamento_Proporcional:      Realiza o cancelamento          --
        --                                      proporcional de uma proviso de --
        --                                      Conta Corrente.                 --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Cancelamento_Proporcional       (p_cancelamento_prop_in         IN      cancelamento_proporcional_in
                                                        ,p_cancelamento_prop_out        OUT     cancelamento_proporcional_out)  IS
        --
        CURSOR  c_estorna_item  (p_cd_contrato          IN      NUMBER
                                ,p_cd_item_contrato     IN      NUMBER
                                ,p_dt_procs             IN      DATE)   IS
                --
                SELECT  a.id_lacto,
                        a.id_verba,
                        a.cd_situc_lacto,
                        a.cd_ctrat,
                        a.cd_item_ctrat,
                        a.cd_tipo_lacto,
                        a.dt_lacto,
                        a.vl_saldo_verba_anter,
                        a.vl_lacto,
                        a.vl_agrvo_ppota,
                        a.vl_saldo_verba_postr,
                        a.id_lacto_origm_trnsf,
                        a.id_lacto_estor,
                        a.tp_pesoa,
                        a.nm_clien_sgrdo,
                        a.nr_cpf_cnpj_clien,
                        a.vl_prmio_liqui_ppota,
                        a.pc_comis_crtor,
                        a.dt_inico_vigen_segur,
                        a.id_procs_criac,
                        a.cd_usuro_criac,
                        a.dt_criac,
                        a.id_procs_alter,
                        a.cd_usuro_ultma_alter,
                        a.dt_ultma_alter,
                        a.id_corrl_bus,
                        a.id_prdut_sistm_origm,
                        a.tp_desct_agrvo,
                        b.dt_fim_vigen  -       p_dt_procs      qt_dias_verba_a_vencer,
                        b.cd_segmt_prdut        cd_segmt_prdut_vb,
                        b.cd_crtor_segur        cd_crtor_segur_vb,
                        b.cd_asses              cd_asses_vb,
                        b.cd_tipo_verba         cd_tipo_verba_vb,
                        b.vl_inicl_verba        vl_inicl_verba_vb,
                        b.vl_prvsn_verba        vl_prvsn_verba_vb,
                        b.vl_eftdo_verba        vl_eftdo_verba_vb,
                        b.vl_crdto_verba        vl_crdto_verba_vb,
                        b.vl_saldo_verba        vl_saldo_verba_vb,
                        b.dt_inico_vigen        dt_inico_vigen_vb,
                        b.dt_fim_vigen          dt_fim_vigen_vb,
                        b.id_verba_origm_trnsf  id_verba_origm_trnsf_vb,
                        b.cd_usuro_ultma_alter  cd_usuro_ultma_alter_vb,
                        b.dt_ultma_alter        dt_ultma_alter_vb,
                        b.cd_situc_verba        cd_situc_verba_vb,
                        b.id_arquv_carga_verba  id_arquv_carga_verba_vb,
                        b.vl_eftdo_verba,
                        b.vl_saldo_verba,
                        b.vl_crdit_agrvo,
                        b.vl_inicl_verba
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.cd_ctrat              =       p_cd_contrato
                AND     a.cd_item_ctrat         =       Nvl(p_cd_item_contrato, a.cd_item_ctrat)
                AND     a.cd_situc_lacto        NOT     IN      ('CAN', 'AGB',  'END')
                AND     a.id_lacto_estor        IS      NULL
                AND     a.id_verba              =       b.id_verba;
        --
        erro_fatal              EXCEPTION;
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_vl_provisao           NUMBER;
        v_id_verba_estorno      NUMBER;
        --
        v_vl_lacto              NUMBER;
        v_id_verba              NUMBER;
        v_id_lacto              NUMBER;
        v_vl_inicl_verba        NUMBER;
        v_vl_prvsn_verba        NUMBER;
        v_vl_saldo_verba        NUMBER;
        v_cd_segmt_prdut        NUMBER;
        v_id_prdut              NUMBER;
        v_id_procs_criac        NUMBER;
        v_qt_dias_estorno       NUMBER;
        v_vl_estornar           NUMBER;
        v_vl_saldo_atual        NUMBER;
        v_vl_prvsn_verba_vb     NUMBER;
        v_vl_saldo_verba_vb     NUMBER;
        --
        v_msg_erro              VARCHAR2(4000);
        v_InAgravoDesconto      VARCHAR2(4000);
        --
        v_DtCancelamento        DATE;
        v_DtFimVigencia         DATE;
        --
        v_corretor              CTACTPA0100_001.t_corretor;
        --
        v_dias_vigencia         NUMBER;
        v_dias_estornar         NUMBER;
        --
        BEGIN
                --
                p_cancelamento_prop_out :=      cancelamento_proporcional_out   (0
                                                                                ,NULL);
                --
                v_VlAgravoDesconto      :=      Round(p_cancelamento_prop_in.VlAgravoDesconto,  2);
                --
                CTACTPA0100_001.IniciaLog       (161
                                                ,p_cancelamento_prop_in.SistemaChamador
                                                ,p_cancelamento_prop_in.CdCorretor
                                                ,NULL
                                                ,p_cancelamento_prop_in.CdContrato
                                                ,p_cancelamento_prop_in.CdItemContrato
                                                ,p_cancelamento_prop_in.TpPessoa
                                                ,p_cancelamento_prop_in.CPFCNPJCliente
                                                ,NULL
                                                ,p_cancelamento_prop_in.CdUsuario
                                                ,p_cancelamento_prop_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                     ||Chr(10)||
                                                'Servio Cancelamento_Proporcional. Parmetros de entrada: '                    ||Chr(10)||
                                                ' SistemaChamador....... '||p_cancelamento_prop_in.SistemaChamador              ||Chr(10)||
                                                ' CdCorretor............ '||p_cancelamento_prop_in.CdCorretor                   ||Chr(10)||
                                                ' CdContrato............ '||p_cancelamento_prop_in.CdContrato                   ||Chr(10)||
                                                ' CdItemContrato........ '||p_cancelamento_prop_in.CdItemContrato               ||Chr(10)||
                                                ' TpPessoa.............. '||p_cancelamento_prop_in.TpPessoa                     ||Chr(10)||
                                                ' NrCPFCNPJ............. '||p_cancelamento_prop_in.CPFCNPJCliente               ||Chr(10)||
                                                ' CdUsuario............. '||p_cancelamento_prop_in.CdUsuario                    ||Chr(10)||
                                                ' CdProcesso............ '||p_cancelamento_prop_in.CdProcesso                   ||Chr(10)||
                                                ' DtFimVigencia......... '||p_cancelamento_prop_in.DtFimVigencia                ||Chr(10)||
                                                ' DtCancelamento........ '||p_cancelamento_prop_in.DtCancelamento               ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')        ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido       (p_cancelamento_prop_in.SistemaChamador))       THEN
                        --
                        p_cancelamento_prop_out.StRetorno        :=      2;
                        p_cancelamento_prop_out.MsgRetorno       :=      '[Cancelamento Proporcional] - Sistema chamador invlido: '||p_cancelamento_prop_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_cancelamento_prop_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_cancelamento_prop_out.StRetorno        :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno       :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de negcio
                --
                IF      p_cancelamento_prop_in.CdContrato       IS      NULL    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      15;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Nmero de negcio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de item
                --
                IF      p_cancelamento_prop_in.CdItemContrato   IS      NULL    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      16;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Nmero de item est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando indicador de agravo / desconto
                --
                /*
                IF      Nvl(p_cancelamento_prop_in.InAgravoDesconto,    'X')    <>      'A'     THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      24;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Indicador de desconto / agravo invlido: '||Nvl(p_cancelamento_prop_in.InAgravoDesconto, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                */
                --
                --      Validando valor de agravo / desconto
                --
                /*
                IF      v_VlAgravoDesconto      IS      NULL    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      25;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Valor de agravo / desconto est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                */
                --
                --      Validando tipo de pessoa
                --
                /*
                IF      Nvl(p_cancelamento_prop_in.TpPessoa,    'X')    NOT     IN      ('F',   'J')    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      8;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Tipo de pessoa invlido: '||Nvl(p_cancelamento_prop_in.TpPessoa, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                */
                --
                --      Validando CPF / CNPJ do cliente
                --
                /*
                IF      p_cancelamento_prop_in.CPFCNPJCliente   IS      NULL    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      9;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - CPF / CNPJ est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      p_cancelamento_prop_in.TpPessoa =       'F'
                        AND     NOT(tms_util.valida_cpf(LPad(p_cancelamento_prop_in.CPFCNPJCliente,11,'0')))    THEN
                                --
                                p_cancelamento_prop_out.StRetorno       :=      9;
                                p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - CPF invlido: '||p_cancelamento_prop_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        ELSIF   p_cancelamento_prop_in.TpPessoa =       'J'
                        AND     NOT(tms_util.valida_cnpj(LPad(p_cancelamento_prop_in.CPFCNPJCliente,14,'0')))   THEN
                                --
                                p_cancelamento_prop_out.StRetorno       :=      9;
                                p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - CNPJ invlido: '||p_cancelamento_prop_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                */
                --
                --      Validando usurio
                --
                IF      p_cancelamento_prop_in.CdUsuario        IS      NULL    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      10;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_cancelamento_prop_in.CdProcesso,  0)      NOT     IN      (40)     THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      11;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Cdigo de processo invlido: '||p_cancelamento_prop_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsDataValida        (p_cancelamento_prop_in.DtFimVigencia
                                                                ,v_DtFimVigencia))      THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      107;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Data de Fim de Vigncia invlido: '||p_cancelamento_prop_in.DtFimVigencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsDataValida        (p_cancelamento_prop_in.DtCancelamento
                                                                ,v_DtCancelamento))     THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      108;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Data de Cancelamento invlido: '||p_cancelamento_prop_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento
                --
                v_dt_procm              :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] - '||v_dt_procm);
                --
                --      Valida carga corretores
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca segmento do produto
                --
                v_cd_segmt_prdut        :=      CTACTPA0100_001.RetornaSegmentoProduto  (p_cancelamento_prop_in.SistemaChamador
                                                                                        ,p_cancelamento_prop_in.CdProduto
                                                                                        ,v_dt_procm
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaSegmentoProduto] - '||v_cd_segmt_prdut||' Sistema Chamador: '||p_cancelamento_prop_in.SistemaChamador||' Produto: '||p_cancelamento_prop_in.CdProduto||' Data Processamento: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o mdulo produto
                --
                v_id_prdut      :=      CTACTPA0100_001.ModuloProdutoValido     (p_cancelamento_prop_in.CdProduto
                                                                                ,p_cancelamento_prop_in.SistemaChamador
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ModuloProdutoValido] - '||v_id_prdut||' Produto: '||p_cancelamento_prop_in.CdProduto||' Sistema Chamador: '||p_cancelamento_prop_in.SistemaChamador||' Segmento: '||v_cd_segmt_prdut||' Data Processamento: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Buscando o id processo de criao
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_cancelamento_prop_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs_criac||' Processo: '||p_cancelamento_prop_in.CdProcesso);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca qt_dias_estorno
                --
                v_qt_dias_estorno       :=      CTACTPA0100_001.RetornaQtDiasEstorno    (v_cd_segmt_prdut
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaQtDiasEstorno] - '||v_qt_dias_estorno||'  Segmento: '||v_cd_segmt_prdut);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Quando no tiver proviso para o item, deve dar erro.
                --
                v_vl_provisao   :=      CTACTPA0100_001.RetornaProvisaoEnd      (p_cancelamento_prop_in.CdContrato
                                                                                ,p_cancelamento_prop_in.CdItemContrato
                                                                                ,p_cancelamento_prop_in.CdCorretor
                                                                                ,v_InAgravoDesconto
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_cancelamento_prop_out.StRetorno       :=      v_cd_erro;
                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      v_vl_provisao   =       0       THEN
                                --
                                p_cancelamento_prop_out.StRetorno       :=      102;
                                p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Proviso no encontrada para o item / negcio';
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Retornando informaes do corretor                      --
                --
                CTACTPA0100_001.RetornaDadosCorretor    (p_cancelamento_prop_in.CdCorretor
                                                        ,v_corretor);
                --
                --      Retornando os lanamentos que devem ser estornados
                --
                FOR     r_estorna_item  IN      c_estorna_item  (p_cancelamento_prop_in.CdContrato
                                                                ,p_cancelamento_prop_in.CdItemContrato
                                                                ,v_dt_procm)    LOOP
                        --
                        --      Calculando os dias de vigencia e dias a estornar
                        --
                        v_dias_vigencia :=      v_DtFimVigencia -       r_estorna_item.dt_inico_vigen_segur;
                        v_dias_estornar :=      v_DtFimVigencia -       v_DtCancelamento;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Dias vigncia: '      ||v_dias_vigencia     ||Chr(10)||
                                                         'Dias estornar: '      ||v_dias_estornar);

                        --
                        --      Verificando se j existe uma verba de estorno
                        --      criada
                        --
                        v_id_verba_estorno      :=      RetornaIdVerbaEstorno   (r_estorna_item.id_verba);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Verba do Lanamento] '       ||r_estorna_item.id_verba       ||Chr(10)||
                                                         '[Valor Lanamento] '          ||r_estorna_item.vl_lacto);
                        --
                        --      Se o lanamento estiver liberado, no deve
                        --      estornar o lanamento
                        --
                        IF      r_estorna_item.cd_situc_lacto           =       'LIB'
                        AND     p_cancelamento_prop_in.CdProcesso       <>      3       THEN
                                --
                                p_cancelamento_prop_out.StRetorno       :=      103;
                                p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Item com lanamento liberado. No  possvel estornar o valor';
                                --
                                RAISE   erro_fatal;
                        --
                        --      Se o lanamento no for de agravo, dar erro
                        --
                        ELSIF   r_estorna_item.tp_desct_agrvo   <>      'A'     THEN
                                --
                                p_cancelamento_prop_out.StRetorno       :=      1;
                                p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Lanamento sendo estornado no  de agravo. Verificar.';
                                --
                                RAISE   erro_fatal;
                                --
                        ELSE
                                --
                                --      Lanamento no est estornado, verifica
                                --      se est no intervalo do estorno
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[r_estorna_item.qt_dias_verba_a_vencer] = '||r_estorna_item.qt_dias_verba_a_vencer||' v_qt_dias_estorno = '||v_qt_dias_estorno||']');
                                --
                                IF      r_estorna_item.qt_dias_verba_a_vencer   >=      v_qt_dias_estorno       THEN
                                        --
                                        --      Verba no excede o prazo do
                                        --      estorno. Estorna na prpria
                                        --      verba
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[Estornando para a prpria verba]');
                                        --
                                        BEGIN
                                                --
                                                SELECT  b.vl_saldo_verba
                                                INTO    v_vl_saldo_atual
                                                FROM    cta0004_lacto   a,
                                                        cta0002_verba   b
                                                WHERE   a.cd_ctrat              =       p_cancelamento_prop_in.CdContrato
                                                AND     a.cd_item_ctrat         =       p_cancelamento_prop_in.CdItemContrato
                                                AND     a.cd_situc_lacto        NOT     IN      ('CAN', 'AGB',  'END')
                                                AND     a.id_lacto_estor        IS      NULL
                                                AND     a.id_verba              =       r_estorna_item.id_verba
                                                AND     b.id_verba              =       a.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cancelamento_prop_out.StRetorno       :=      1;
                                                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Erro ao selecionar valor atual da verba: '||SQLERRM;
                                                        --
                                                        RAISE   erro_fatal;
                                                        --
                                        END;
                                        --
                                        ------------------------------------------
                                        --      Estorno de agravo.              --
                                        ------------------------------------------
                                        --
                                        --      Calculando o valor a estornar
                                        --
                                        v_vl_estornar           :=      Trunc((r_estorna_item.vl_lacto        /       v_dias_vigencia)        *       v_dias_estornar,  2);
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[Valor a estornar - Proporcional: ] '||v_vl_estornar);
                                        --
                                        v_vl_saldo_verba        :=      v_vl_saldo_atual                -       v_vl_estornar;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,' [Agravo] - Atualizando verba.................. '||r_estorna_item.id_verba            ||Chr(10)||
                                                                         ' [Agravo] - Valor anterior vl_saldo_verba...... '||r_estorna_item.vl_saldo_verba      ||Chr(10)||
                                                                         ' [Agravo] - Valor do lanamento................ '||r_estorna_item.vl_lacto            ||Chr(10)||
                                                                         ' [Agravo] - Valor novo v_vl_saldo_verba........ '||v_vl_saldo_verba);
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_saldo_verba  =       v_vl_saldo_verba
                                                WHERE   id_verba        =       r_estorna_item.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cancelamento_prop_out.StRetorno       :=      1;
                                                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Erro ao atualizar verba: '||SQLERRM;
                                                        --
                                                        RAISE   erro_fatal;
                                                        --
                                        END;
                                        --
                                ELSE
                                        --
                                        p_cancelamento_prop_out.StRetorno       :=      1;
                                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Verba para estornar est vencida. Verificar.';
                                        --
                                        RAISE   erro_fatal;
                                        --
                                END     IF;
                                --
                        END     IF;
                        --
                        ----------------------------------------------------------
                        --      Criando o lanamento de estorno do endosso.     --
                        ----------------------------------------------------------
                        --
                        v_id_lacto      :=      RetornaIdLacto;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Inserindo lanamento END.............. '||v_id_lacto                         ||Chr(10)||
                                                         '[r_estorna_item.vl_saldo_verba_anter... '||r_estorna_item.vl_saldo_verba_vb   ||Chr(10)||
                                                         '[r_estorna_item.vl_saldo_verba_postr... '||v_vl_saldo_verba);
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,id_procs_alter
                                                                ,cd_usuro_ultma_alter
                                                                ,dt_ultma_alter
                                                                ,id_corrl_bus
                                                                ,id_prdut_sistm_origm
                                                                ,tp_desct_agrvo
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_estorna_item.id_verba
                                                                ,'ENP'
                                                                ,r_estorna_item.cd_ctrat
                                                                ,r_estorna_item.cd_item_ctrat
                                                                ,'E'
                                                                ,SYSDATE
                                                                ,r_estorna_item.vl_saldo_verba_vb
                                                                ,v_vl_estornar
                                                                ,r_estorna_item.vl_agrvo_ppota
                                                                ,v_vl_saldo_verba
                                                                ,r_estorna_item.id_lacto_origm_trnsf
                                                                ,NULL
                                                                ,r_estorna_item.tp_pesoa
                                                                ,r_estorna_item.nm_clien_sgrdo
                                                                ,r_estorna_item.nr_cpf_cnpj_clien
                                                                ,r_estorna_item.vl_prmio_liqui_ppota
                                                                ,r_estorna_item.pc_comis_crtor
                                                                ,r_estorna_item.dt_inico_vigen_segur
                                                                ,v_id_procs_criac
                                                                ,p_cancelamento_prop_in.CdUsuario
                                                                ,SYSDATE
                                                                ,NULL
                                                                ,NULL
                                                                ,NULL
                                                                ,r_estorna_item.id_corrl_bus
                                                                ,r_estorna_item.id_prdut_sistm_origm
                                                                ,'D'
                                                                ,v_corretor.cd_sucsl_comrl
                                                                ,v_corretor.cd_diret_comrl
                                                                ,v_corretor.cd_asses);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Inseriu Registro] Contrato = ' || r_estorna_item.cd_ctrat || ' Item = ' || r_estorna_item.cd_item_ctrat);
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[Erro ao inserir lanamento] = '||SQLERRM);

                                        p_cancelamento_prop_out.StRetorno       :=      1;
                                        p_cancelamento_prop_out.MsgRetorno      :=      '[Cancelamento Proporcional] - Erro ao criar lanamento: '||SQLERRM;
                                        --
                                        RAISE   erro_fatal;
                                        --
                        END;
                        --
                END     LOOP;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Cdigo de retorno]: '||p_cancelamento_prop_out.StRetorno||' [Mensagem de retorno]: '||p_cancelamento_prop_out.MsgRetorno     ||Chr(10)||
                                                 LPad('=',      80,     '=')                                                                                                    ||Chr(10)||
                                                 'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')                                                    ||Chr(10)||
                                                 LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_cancelamento_prop_out.StRetorno||' - Mensagem: '||p_cancelamento_prop_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Cancelamento_Proporcional: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_cancelamento_prop_out.StRetorno       :=      1;
                        p_cancelamento_prop_out.MsgRetorno      :=      'Erro Cancelamento_Proporcional: '||SQLERRM;
                        --
        END     Cancelamento_Proporcional;
        --
END     CTACTPA0016_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0017_001 IS
        --
        v_gpa_id        NUMBER;
        --
        PROCEDURE       LIMPA_BASE_LOGS IS

                 P_PROCESSO              NUMBER;
                 P_DIAS_LIMPA            NUMBER;
                 v_sq_log                NUMBER;
                 P_contrato              NUMBER;
                 p_conta_reg_limp        NUMBER;

                 v_DATA_INICIO           DATE;

                 v_proximo               EXCEPTION;
                 --
                 v_ct_delete_log        NUMBER  :=      0;
                 v_ct_delete_detal_log  NUMBER  :=      0;
                 v_ct_delete_log_proc   NUMBER  :=      0;
                 v_ct_delete_detal_proc NUMBER  :=      0;
                 v_chave_limpeza        VARCHAR2(400);

                 /* CURSOR QUE BUSCA OS PROCESSOS CADASTRADOS NA TABELA DE PARAMETROS */
                 CURSOR  PROCESSOS_CUR IS
                         SELECT  PARAM.ds_param_cc
                         FROM    cta0008_param_cc  PARAM
                         WHERE   PARAM.nm_param_cc LIKE 'PROCESSO_CTA_%';

                 /* CURSOR QUE BUSCA LOGS APARTIR DE DATA CALCULADA E ID DO PROCESSO CADASTRADO */
                 CURSOR  LOG_CUR (p_data_inicio IN      DATE)   IS
                         SELECT  CTA.CD_ASSES, CTA.CD_CRTOR_SEGUR, CTA.CD_CTRAT, CTA.CD_ITEM_CTRAT, CTA.CD_TIPO_PROCS,
                                 CTA.CD_USURO, CTA.DT_HORA_FIM_LOG_SERVC, CTA.DT_HORA_INICO_LOG_SERVC, CTA.ID_LOG_SERVC, CTA.ID_SERVC, CTA.NM_CLIEN_SGRDO,
                                 CTA.NR_CPF_CNPJ_CLIEN, CTA.SG_SISTM_ORIGM, CTA.TP_PESOA
                         FROM    CTA0017_LOG_SERVC CTA
                         WHERE   Trunc(CTA.DT_HORA_INICO_LOG_SERVC) <= P_DATA_INICIO
                         AND     CTA.ID_SERVC =  P_PROCESSO
                         ORDER BY id_log_servc;

        BEGIN
                --
                --      Iniciando GPA
                --
                BEGIN
                        --
                        tms_gpa.iniciar_processo        ('CTA_LIMPEZA_LOG'
                                                        ,SubStr(USER,1,8)
                                                        ,'4402');
                        --
                        v_gpa_id        :=      tms_session.get_gpa_id;
                        --
                        Dbms_Output.Put_Line('Processo GPA (CTA - Limpeza de Log) iniciado: '||v_gpa_id);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                Raise_Application_Error (-20005
                                                        ,'Erro ao iniciar GPA: '||SQLERRM);
                                --
                END;



                 P_DIAS_LIMPA    :=      0;
                 P_PROCESSO      :=      0;

                tms_gpa.info    (v_gpa_id
                                ,'Iniciando loop de parametros'
                                ,NULL);
                --

                 BEGIN
                        --
                         FOR PARAMETRO IN PROCESSOS_CUR LOOP
                                --
                                 BEGIN
                                        tms_gpa.info    (v_gpa_id
                                                ,'Parametro processo: ' || parametro.ds_param_cc
                                                ,NULL);

                                        P_PROCESSO      :=   parametro.ds_param_cc;

                                        --Dbms_Output.Put_Line('Processo - ' || P_PROCESSO);

                                        -- BUSCA PARAMETRO DE PERIODO PARA LIMPEZA DE BASE
                                        v_chave_limpeza        :=      'LIMPEZA_PROC_' || LPad(P_PROCESSO,3,'0');
                                        --
                                        tms_gpa.info    (v_gpa_id
                                                ,'Chave para buscar periodo de limpeza: ' || v_chave_limpeza
                                                ,NULL);
                                         --
                                         BEGIN

                                                 SELECT  PARAM.DS_PARAM_CC
                                                 INTO    P_DIAS_LIMPA
                                                 FROM    CTA0008_PARAM_CC PARAM
                                                 WHERE   PARAM.NM_PARAM_CC = v_chave_limpeza;

                                         EXCEPTION
                                                 WHEN No_Data_Found THEN

                                                 BEGIN

                                                         SELECT  PARAM.DS_PARAM_CC
                                                         INTO    P_DIAS_LIMPA
                                                         FROM    CTA0008_PARAM_CC PARAM
                                                         WHERE   PARAM.NM_PARAM_CC = 'LIMPEZA_PROC_X';

                                                 EXCEPTION
                                                         WHEN No_Data_Found THEN

                                                         P_DIAS_LIMPA := 0; -- no limpa

                                                 END;

                                         END;
                                        --
                                        tms_gpa.info    (v_gpa_id
                                                ,'Dias para Limpeza: ' || p_dias_limpa
                                                ,NULL);
                                        --
                                         --Dbms_Output.Put_Line('P_DIAS_LIMPA - ' || P_DIAS_LIMPA);

                                         IF P_DIAS_LIMPA > 0 THEN

                                                 v_DATA_INICIO := Trunc(SYSDATE) - P_DIAS_LIMPA;
                                                --
                                                tms_gpa.info    (v_gpa_id
                                                        ,'Data inicio para limpeza: ' || v_data_inicio
                                                        ,NULL);
                                                --

                                         ELSE
                                                --
                                                tms_gpa.info    (v_gpa_id
                                                        ,'Dias para limpeza zerado ou no encontrado, no faz limpeza.'
                                                        ,NULL);
                                                --
                                                RAISE v_proximo;
                                                --
                                        END IF;
                                        --
                                        v_ct_delete_log_proc    :=      0;
                                        --
                                        v_ct_delete_detal_proc  :=      0;
                                        --
                                         FOR    Xlog    IN      LOG_CUR (v_data_inicio)    LOOP

                                                 BEGIN
                                                        --
                                                        SELECT  Count(1)
                                                        INTO    p_conta_reg_limp
                                                        FROM    cta0018_detal_log_servc logServ
                                                        WHERE   id_log_servc = Xlog.ID_LOG_SERVC;
                                                        --
                                                        v_ct_delete_log_proc    :=      v_ct_delete_log_proc    +       1;
                                                        --
                                                        v_ct_delete_detal_proc  :=      v_ct_delete_detal_proc  +       p_conta_reg_limp;
                                                        --
                                                        v_ct_delete_log         :=      v_ct_delete_log         +       1;
                                                        --
                                                        v_ct_delete_detal_log   :=      v_ct_delete_detal_log   +       p_conta_reg_limp;
                                                        --
                                                        -- LIMPA DETALHES DO LOG
                                                        --
                                                        DELETE  cta0018_detal_log_servc
                                                        WHERE   id_log_servc = Xlog.ID_LOG_SERVC;
                                                        --
                                                        -- LIMPA LOG
                                                        --
                                                        DELETE  cta0017_log_servc
                                                        WHERE   id_log_servc = Xlog.ID_LOG_SERVC;
                                                        --
                                                        COMMIT;
                                                        --
                                                        tms_gpa.DEBUG   (v_gpa_id
                                                                ,'Proc: ' || P_PROCESSO || ' Id log: ' || Xlog.id_log_servc ||  ' Inicio Log: ' || To_Char(Xlog.dt_hora_inico_log_servc,'dd/mm/yyyy') || ' Linhas deletadas at o momento: ' || v_ct_delete_detal_log
                                                                ,Xlog.CD_CTRAT);
                                                        --
                                                 EXCEPTION
                                                        --
                                                        WHEN OTHERS THEN
                                                                --
                                                                tms_gpa.erro    (v_gpa_id
                                                                        ,'Problema ao deletar registro: ' || Xlog.ID_LOG_SERVC ||  ' ' || SQLERRM
                                                                        ,Xlog.CD_CTRAT);
                                                        ROLLBACK;
                                                        --
                                                 END;

                                         END LOOP;

                                tms_gpa.info    (v_gpa_id
                                        ,'Total linhas deletadas do processo ' || P_PROCESSO || ': ' || v_ct_delete_log_proc
                                        ,NULL);

                                tms_gpa.info    (v_gpa_id
                                        ,'Total linhas deletadas do processo ' || P_PROCESSO || ' - Detalhe Log : ' || v_ct_delete_detal_proc
                                        ,NULL);



                                 EXCEPTION
                                         WHEN v_proximo THEN
                                                 NULL;

                                 END;

                         END LOOP;

                        tms_gpa.info    (v_gpa_id
                                ,'Trmino de Processamento : '
                                ,NULL);

                        tms_gpa.info    (v_gpa_id
                                ,'Total linhas deletadas - Log : ' || v_ct_delete_log
                                ,NULL);

                        tms_gpa.info    (v_gpa_id
                                ,'Total linhas deletadas - Detalhe Log : ' || v_ct_delete_detal_log
                                ,NULL);
                        --
                        tms_gpa.finalizar_processo;
                        --
                 END;

         END LIMPA_BASE_LOGS;

END CTACTPA0017_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0018_001   IS
        --
        v_id_log_servc  NUMBER;
        --
        --------------------------------------------------------------------------
        --      FUNCTION RetornaTpCondicao
        --------------------------------------------------------------------------
        --
        FUNCTION        RetornaTpCondicao       (p_id_query     IN      NUMBER
                                                ,p_sq_condicao  IN      NUMBER)
        RETURN          VARCHAR2        IS
        --
        v_cd_forto_campo        cta0023_campo_condc_query.cd_forto_campo%TYPE;
        --
        BEGIN
                --
                SELECT  cd_forto_campo
                INTO    v_cd_forto_campo
                FROM    cta0023_campo_condc_query
                WHERE   id_query        =       p_id_query
                AND     sq_campo        =       p_sq_condicao;
                --
                RETURN  Upper(v_cd_forto_campo);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  'NR';
                        --
        END     RetornaTpCondicao;
        --
        --------------------------------------------------------------------------
        --      FUNCTION RETORNA_LINHA_ERRO:    Retorna linha do erro           --
        --------------------------------------------------------------------------
        --
        FUNCTION RETORNA_LINHA_ERRO(p_dbms IN VARCHAR2) RETURN VARCHAR2 IS
                --
                l_trace     tms_util.error_rt;
                v_resultado VARCHAR2(100);
                --
        BEGIN
                --
                l_trace := tms_util.BACKTRACE_INFO(p_dbms);
                --
                v_resultado := l_trace.line_number;
                --
                RETURN v_resultado;
                --
        EXCEPTION
                --
                WHEN OTHERS THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_id_log_servc, 'Erro no retorna linha erro: ' || SQLERRM);
                        --
        END RETORNA_LINHA_ERRO;
        --------------------------------------------------------------------------
        --      PROCEDURE GravaLog:     Grava mensagem de erro no arquivo.      --
        --------------------------------------------------------------------------
        --
        PROCEDURE       GravaLog        (p_mensagem     IN      VARCHAR2)    IS
        --
        BEGIN
                --
                CTACTPA0100_001.GravaLog        (v_id_log_servc
                                                ,substr(p_mensagem,1,4000));
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_id_log_servc
                                                        ,'Erro no GravaLog: ' || SQLERRM );
                        --
                        --Dbms_Output.put_line('Erro GravaLog: '||SQLERRM);
                        --
        END     GravaLog;

        --------------------------------------------------------------------------
        --      PROCEDURE TRANSFORMA_BLOB_FILE: Transforma um BLOB em arquivo   --
        --                                      que ser lido pelo processo da  --
        --                                      recepo.                       --
        --------------------------------------------------------------------------
        --
        PROCEDURE       TRANSFORMA_BLOB_FILE    (p_blob         IN      BLOB
                                                ,p_nm_arq       IN      VARCHAR2
                                                ,p_cd_retorno   OUT     NUMBER
                                                ,p_msg_retorno  OUT     VARCHAR2)       IS
        --
        --      Usados na converso do arquivo
        --
        my_vr                   BLOB;
        inicio                  NUMBER  :=      1;
        tam_byte                NUMBER  :=      32000;
        tamanho                 NUMBER;
        len                     NUMBER;
        v_arquivo               utl_file.file_type;
        --
        BEGIN
                --
                --      Definindo o arquivo de sada da transformao do BLOB.
                --
                v_arquivo       :=      utl_file.fopen  ('DIR_RECEPCAO'
                                                        ,p_nm_arq
                                                        ,'W');
                --
                --      Guardando o tamanho do BLOB enviado.
                --
                BEGIN
                        --
                        SELECT  dbms_lob.getlength(p_blob)
                        INTO    len
                        FROM    dual;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN

                                GravaLog('Erro ao executar getlength :' || SQLERRM);
                                --
                                len     :=      0;
                                --
                END;
                --
                tamanho :=      len;
                --
                IF      len     <       32760   THEN
                        --
                        --      Se o tamanho do BLOB couber em uma leitura s.
                        --
                        utl_file.put_raw        (v_arquivo
                                                ,p_blob);
                        --
                        utl_file.fflush(v_arquivo);
                        --
                ELSE
                        --
                        --      Grava o arquivo em pedaos
                        --
                        inicio  :=      1;
                        --
                        WHILE   inicio  <       len     LOOP
                                --
                                dbms_lob.READ           (p_blob
                                                        ,tam_byte
                                                        ,inicio
                                                        ,my_vr);
                                --
                                utl_file.put_raw        (v_arquivo
                                                        ,my_vr);
                                --
                                utl_file.fflush         (v_arquivo);
                                --
                                --      Determina posio da prxima leitura.
                                --
                                inicio  :=      inicio  +       tam_byte;
                                --
                                --      Determina a posio final, caso o
                                --      tamanho seja menor que 32000
                                --
                                tamanho :=      tamanho -       tam_byte;
                                --
                                IF      tamanho <       32000   THEN
                                        --
                                        tam_byte        :=      tamanho;
                                        --
                                END     IF;
                                --
                        END LOOP;
                        --
                END IF;
                --
                utl_file.fclose (v_arquivo);
                --
                p_cd_retorno    :=      0;
                p_msg_retorno   :=      'Arquivo transformado com sucesso.';
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_retorno    :=      99;
                        p_msg_retorno   :=      'Erro ao transformar BLOB em arquivo: '||SQLERRM;
                        --
        END     TRANSFORMA_BLOB_FILE;
        --

        PROCEDURE executapackproc       (p_id_query     IN      NUMBER
                                        ,p_owner        IN      VARCHAR2
                                        ,p_package      IN      VARCHAR2
                                        ,p_procedure    IN      VARCHAR2
                                        ,p_nm_arq       IN      VARCHAR2
                                        ,p_usuario      IN      VARCHAR2
                                        ,p_tp_local     IN      NUMBER
                                        ,p_cd_local     IN      NUMBER
                                        ,p_param        t_param)        IS
                --
                v_execute       VARCHAR2(32000);
                v_param         VARCHAR2(32000);
                arquivo         Utl_File.file_type;
                --
                CURSOR  c1      IS
                        --
                        SELECT  nm_campo
                        FROM    cta0022_campo_saida_query
                        WHERE   id_query        =       p_id_query
                        ORDER BY sq_campo;
                --
                v_cabecalho     VARCHAR2(4000);
                --
                j       NUMBER;
                --
        BEGIN
                --
                GravaLog('Dentro executapackproc');
                --
                GravaLog('p_param.Count: ' || p_param.Count);
                --
                IF      p_param.Count   >       0       THEN
                        --
                        v_param :=      'v_parametros    :=      admcta.t_param();';
                        --
                        FOR     r       IN      1..p_param.Count        LOOP
                                --
                                v_param :=      v_param ||'     v_parametros.extend;
                                                                --
                                                                v_parametros(v_parametros.Count)        :=      '''||p_param(r)||''';';
                                --
                        END     LOOP;
                        --
                END     IF;
                --
                GravaLog('antes fopen');
                --
                arquivo :=      Utl_File.fopen  ('DIR_RECEPCAO'
                                                ,'log.txt'
                                                ,'W');
                --
                j       :=      0;
                --
                FOR     r1      IN      c1      LOOP
                        --
                        j       :=      j       +       1;
                        --
                        IF      j       =       1       THEN
                                --
                                v_cabecalho     :=      r1.nm_campo;
                                --
                        ELSE
                                --
                                v_cabecalho     :=      v_cabecalho     ||      ';'     ||      r1.nm_campo;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
                GravaLog('v_cabecalho' || v_cabecalho);
                --
                GravaLog('antes atribuio para v_execute');
                --
                GravaLog('v_param: ' || v_param);
                GravaLog('p_package: ' || p_package);
                GravaLog('p_procedure: ' || p_procedure);
                GravaLog('p_nm_arq: ' || p_nm_arq);
                v_execute       :=
                '
                DECLARE
                --
                v_parametros    admcta.t_param;
                v_relatorio     ' || p_package || '.t_rec_retorno;
                v_cd_retorno    NUMBER;
                v_msg_retorno   VARCHAR2(4000);
                --
                v_arquivo       Utl_File.file_type;
                v_nm_arquivo    VARCHAR2(200);
                v_linha         VARCHAR2(4000);
                v_usuario       varchar2(400) :=' || '''' || p_usuario || '''' || ';' ||
                'v_tp_local       NUMBER :=' || p_tp_local || ';' ||
                'v_cd_local       NUMBER :=' || p_cd_local || ';' ||
                'v_cd_erro       NUMBER;
                v_msg_erro      VARCHAR2(4000);
                --
                BEGIN
                        --'||Chr(10)
                        ||v_param||'
                        --
                        '||p_package||'.'||p_procedure||'       (v_parametros
                                                                ,v_usuario
                                                                ,v_tp_local
                                                                ,v_cd_local
                                                                ,v_relatorio
                                                                ,v_cd_retorno
                                                                ,v_msg_retorno);
                        --
                        v_nm_arquivo    :=      '''||p_nm_arq||''';
                        --
                        v_arquivo       :=      Utl_File.fopen  (''DIR_RECEPCAO''
                                                                ,v_nm_arquivo
                                                                ,''W''
                                                                ,32000);
                        --
                        v_linha :=      ''' || v_cabecalho ||''';
                        --
                        Utl_File.put_line       (v_arquivo
                                                ,v_linha);
                        --
                        FOR     i       IN      1..v_relatorio.Count    LOOP
                                --
                                v_linha :=      v_relatorio(i).v_retorno_01     ||      '';''     ||
                                                v_relatorio(i).v_retorno_02     ||      '';''     ||
                                                v_relatorio(i).v_retorno_03     ||      '';''     ||
                                                v_relatorio(i).v_retorno_04     ||      '';''     ||
                                                v_relatorio(i).v_retorno_05     ||      '';''     ||
                                                v_relatorio(i).v_retorno_06     ||      '';''     ||
                                                v_relatorio(i).v_retorno_07     ||      '';''     ||
                                                v_relatorio(i).v_retorno_08     ||      '';''     ||
                                                v_relatorio(i).v_retorno_09     ||      '';''     ||
                                                v_relatorio(i).v_retorno_10     ||      '';''     ||
                                                v_relatorio(i).v_retorno_11     ||      '';''     ||
                                                v_relatorio(i).v_retorno_12     ||      '';''     ||
                                                v_relatorio(i).v_retorno_13     ||      '';''     ||
                                                v_relatorio(i).v_retorno_14     ||      '';''     ||
                                                v_relatorio(i).v_retorno_15     ||      '';''     ||
                                                v_relatorio(i).v_retorno_16     ||      '';''     ||
                                                v_relatorio(i).v_retorno_17     ||      '';''     ||
                                                v_relatorio(i).v_retorno_18     ||      '';''     ||
                                                v_relatorio(i).v_retorno_19     ||      '';''     ||
                                                v_relatorio(i).v_retorno_20     ||      '';''     ||
                                                v_relatorio(i).v_retorno_21     ||      '';''     ||
                                                v_relatorio(i).v_retorno_22     ||      '';''     ||
                                                v_relatorio(i).v_retorno_23     ||      '';''     ||
                                                v_relatorio(i).v_retorno_24     ||      '';''     ||
                                                v_relatorio(i).v_retorno_25     ||      '';''     ||
                                                v_relatorio(i).v_retorno_26     ||      '';''     ||
                                                v_relatorio(i).v_retorno_27     ||      '';''     ||
                                                v_relatorio(i).v_retorno_28     ||      '';''     ||
                                                v_relatorio(i).v_retorno_29     ||      '';''     ||
                                                v_relatorio(i).v_retorno_30     ||      '';''     ||
                                                v_relatorio(i).v_retorno_31     ||      '';''     ||
                                                v_relatorio(i).v_retorno_32     ||      '';''     ||
                                                v_relatorio(i).v_retorno_33     ||      '';''     ||
                                                v_relatorio(i).v_retorno_34     ||      '';''     ||
                                                v_relatorio(i).v_retorno_35     ||      '';''     ||
                                                v_relatorio(i).v_retorno_36     ||      '';''     ||
                                                v_relatorio(i).v_retorno_37     ||      '';''     ||
                                                v_relatorio(i).v_retorno_38     ||      '';''     ||
                                                v_relatorio(i).v_retorno_39     ||      '';''     ||
                                                v_relatorio(i).v_retorno_40;
                                --
                                Utl_File.put_line       (v_arquivo
                                                        ,v_linha);
                                --
                        END     LOOP;
                        --
                        Utl_File.fclose (v_arquivo);
                        --
                END gera_relatorio;';
                --
                GravaLog('v_execute: ' || v_execute);
                --
                Utl_File.put_line       (arquivo
                                        ,v_execute);
                --
                Utl_File.fclose (arquivo);
                --
                GravaLog('antes do execute immediate');
                --
                BEGIN
                        --
                        EXECUTE IMMEDIATE       v_execute;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                        --
                        GravaLog('Erro no execute imediate' || SQLERRM);
                        --
                END;

                --
                GravaLog('aps o execute immediate');
                --

        END     executaPackProc;
        --
        PROCEDURE executaPackSemRetorno (p_id_query     IN      NUMBER
                                        ,p_owner        IN      VARCHAR2
                                        ,p_package      IN      VARCHAR2
                                        ,p_procedure    IN      VARCHAR2
                                        ,p_declare      IN      VARCHAR2
                                        ,p_nm_arq       IN      VARCHAR2
                                        ,p_usuario      IN      VARCHAR2
                                        ,p_tp_local     IN      NUMBER
                                        ,p_cd_local     IN      NUMBER
                                        ,p_param        t_param)        IS
                --
                v_execute       VARCHAR2(32000);
                v_param         VARCHAR2(4000);
                arquivo         Utl_File.file_type;
                --
                CURSOR  c1      IS
                        --
                        SELECT  nm_campo,
                                cd_forto_campo
                        FROM    cta0023_campo_condc_query
                        WHERE   id_query        =       p_id_query
                        ORDER BY sq_campo;
                --
                v_cabecalho     VARCHAR2(4000);
                v_declare       VARCHAR2(4000);
                --
                i       NUMBER;
                --
        BEGIN
                --
                GravaLog('Dentro executaPackSemRetorno');
                --
                GravaLog('p_param.Count: ' || p_param.Count);
                --
                /*
                IF      p_param.Count   >       0       THEN
                        --
                        i       :=      0;
                        --
                        v_param :=      '(';
                        --
                        GravaLog('antes do for: ' || v_param);
                        --
                        FOR     r1      IN      c1      LOOP
                                --
                                i       :=      i       +       1;
                                --
                                GravaLog('v_param: *' || p_param(i) || '*');
                                --
                                IF      r1.cd_forto_campo       =       'VR'    THEN
                                        --
                                        v_param :=      v_param || p_param(i);
                                        --
                                END     IF;
                                --
                        END     LOOP;
                        --
                        v_param :=      v_param || ')';
                        --
                END     IF;
                */
                --
                GravaLog('antes atribuio para v_execute');
                --
                GravaLog('v_param: *' || v_param || '*');
                --
                v_declare       :=      Trim(REPLACE(REPLACE(p_declare,Chr(10),''),Chr(13),''));
                --
                GravaLog('v_declare: *' || v_declare || '*');
                GravaLog('p_package: ' || p_package);
                GravaLog('p_procedure: ' || p_procedure);
                GravaLog('p_nm_arq: ' || p_nm_arq);
                v_execute       :=
                'DECLARE ' || v_declare ||' BEGIN '||p_package||'.'||p_procedure||'END gera_relatorio;';
                --
                GravaLog('v_execute: ' || v_execute);
                --
                GravaLog('antes do execute immediate');
                --
                BEGIN
                        --
                        EXECUTE IMMEDIATE       v_execute;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                        --
                        GravaLog('Erro no execute imediate' || SQLERRM);
                        --
                END;

                --
                GravaLog('aps o execute immediate');
                --

        END     executaPackSemRetorno;

        --
        --------------------------------------------------------------------------
        --      RetornaQuery
        --------------------------------------------------------------------------
        --
        PROCEDURE       RetornaQuery    (p_id_query     IN      NUMBER
                                        ,p_parametros   IN      t_param
                                        ,p_titulo       OUT     VARCHAR2
                                        ,p_texto_query  OUT     VARCHAR2
                                        ,p_is_select    OUT     BOOLEAN
                                        ,p_pack_sem_retorno     OUT     BOOLEAN
                                        ,p_declare      OUT     VARCHAR2
                                        ,p_nm_query     OUT     VARCHAR2
                                        ,p_cd_erro      OUT     NUMBER
                                        ,p_msg_erro     OUT     VARCHAR2)       IS
        --
        v_replace       VARCHAR2(4000);
        v_qt_replaces   NUMBER;
        v_qt_condicoes  NUMBER;
        v_pos_titulo    NUMBER;
        v_pos_pack_sem_retorno  NUMBER;
        v_pos_ponto_e_virgula    NUMBER;
        v_pos_select    NUMBER;
        v_titulo        VARCHAR2(4000);
        v_qt_select     NUMBER;
        --
        v_query_txt     NUMBER;
        v_arquivo       utl_file.file_type;
        v_linha		VARCHAR2(4000);
        v_blob          BLOB;
        v_error         tms_storage.r_request_fault;
        v_tp_query      cta0021_query.tp_query%TYPE;
        --

        BEGIN
                --
                v_qt_replaces   :=      0;
                p_cd_erro       :=      0;
                GravaLog        ('Dentro do RetornaQuery: ');
                --
                --      Verificando quantidade de condies da query
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_qt_condicoes
                        FROM    cta0023_campo_condc_query
                        WHERE   id_query        =       p_id_query;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro ao contar condies da query: '||SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                --GravaLog        ('Passou do cta0023_campo_condc_query');
                --DIEGO
                --
                BEGIN
                        --
                        SELECT  nm_query,
                                tp_query
                        INTO    p_nm_query,
                                v_tp_query
                        FROM    cta0021_query
                        WHERE   id_query      =       p_id_query;
                        --
                EXCEPTION
                        --
                        WHEN    No_Data_Found   THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Nome da query: '||p_id_query||' no encontrado';
                                --
                                RETURN;
                                --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro no previsto ao recuperar o nome da query: '||SQLERRM;
                                --
                                RETURN;
                END;
                --

                v_query_txt            :=      InStr(Upper(p_nm_query),'_TXT');
                --
                GravaLog        ('v_query_txt: '||v_query_txt);
                --
                IF      v_query_txt    <>      0                THEN
                        --

                        BEGIN
                                --
                                v_blob          :=      tms_storage.getBlobFile ('Recepcao/XLS'
                                                                                ,p_nm_query || '.txt'
                                                                                ,v_error);
				                        --
                                TRANSFORMA_BLOB_FILE    (v_blob
                                                         ,p_nm_query || '.txt'
                                                         ,p_cd_erro
                                                         ,p_msg_erro);

                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN

                                        GravaLog('Erro ao executar getBlobFile :' || SQLERRM);

                        END;
                        --
                        GravaLog        (p_nm_query || '.txt');
                        --
                        BEGIN
                                --
                                v_arquivo       :=      utl_file.fopen  ('DIR_RECEPCAO'
                                                                        ,p_nm_query || '.txt'
                                                                        ,'R');


                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN

                                        GravaLog('Erro teste1 :' || SQLERRM);

                        END;
                        --
                        BEGIN
                        --
                                LOOP
                                        --
                                        GravaLog        (SubStr(v_linha,        1,      200));
                                        --
                                        /*
                                        BEGIN
                                                --
                                                */
                                                UTL_FILE.Get_Line       (v_arquivo
                                                                        ,v_linha);
                                                --
                                                p_texto_query := p_texto_query ||  v_linha;
                                                --
                                        /*
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        GravaLog('Erro teste2 :' || SQLERRM);
                                                        --
                                        END;
                                        */
                                        --
                                END LOOP;

                        EXCEPTION
                                --
                                WHEN    No_Data_Found   THEN


                                        Dbms_Output.Put_Line('Fim da leitura do arquivo' || p_id_query);

                                        Utl_File.fclose (v_arquivo);

                                        BEGIN
                                                Utl_File.fremove ('DIR_RECEPCAO'
                                                            ,p_nm_query || '.txt');
                                        EXCEPTION

                                                WHEN OTHERS THEN

                                                GravaLog('ERRO ao deletar arquivo :' || SQLERRM);
                                        END;
                        END;
                        --
                ELSE
                --
                        BEGIN
                                --
                                SELECT  ds_texto_query
                                INTO    p_texto_query
                                FROM    cta0021_query
                                WHERE   id_query      =       p_id_query;
                                --
                        EXCEPTION
                                --
                                WHEN    No_Data_Found   THEN
                                        --
                                        p_cd_erro       :=      1;
                                        p_msg_erro      :=      'Texto da query: '||p_id_query||' no encontrado';
                                        --
                                        RETURN;
                                        --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      1;
                                        p_msg_erro      :=      'Erro no previsto ao recuperar texto da query: '||SQLERRM;
                                        --
                                        RETURN;
                        END;
                        --
                END     IF;
                --DIEGO
                GravaLog        (SubStr(p_texto_query,  1,      100));
                --
                --      Tirando o Titulo:
                --
                v_pos_titulo            :=      InStr(Upper(p_texto_query),'TITULO');
                --
                v_pos_ponto_e_virgula   :=      InStr(Upper(p_texto_query),';');
                --
                v_pos_select            :=      InStr(Upper(p_texto_query),'SELECT');
                --
                IF      v_pos_titulo    <>      0
                AND     v_pos_titulo    <       v_pos_select    THEN
                        --
                        GravaLog        ('entrou no titulo .....' || v_pos_titulo || ' ; ' || v_pos_ponto_e_virgula || ' ; ' || v_pos_select);
                        --
                        v_titulo        :=      SubStr(p_texto_query,v_pos_titulo+8,v_pos_ponto_e_virgula-9);
                        --
                        GravaLog        (v_titulo);
                        --
                        p_texto_query   :=      SubStr(p_texto_query,v_pos_ponto_e_virgula+1,4000);
                        --
                        GravaLog        ('aps retirar o titulo');
                        --
                        GravaLog        (p_texto_query);
                        --
                END     IF;
                --
                v_pos_pack_sem_retorno  :=      InStr(Upper(p_texto_query),'PACKAGESEMRETORNO');
                --
                GravaLog        ('v_pos_pack_sem_retorno: *' || v_pos_pack_sem_retorno || '*');
                --
                GravaLog        ('p_texto_query: *' || p_texto_query || '*');
                --
                IF      v_pos_pack_sem_retorno  <>      0       OR
                        v_tp_query              =       'E'     THEN    -- Package Sem Retorno
                        --
                        --      Substituindo as condies do where
                        --
                        IF      v_pos_pack_sem_retorno  >       1       THEN
                                --
                                p_declare       :=      SubStr(p_texto_query,1,v_pos_pack_sem_retorno-1);
                                --
                        END     IF;
                        --
                        FOR     r       IN      1..p_parametros.Count   LOOP
                                --
                                BEGIN
                                        --
                                        v_replace       :=      'COND'||LPad(r, 2,      '0');
                                        --
                                        IF      InStr(p_texto_query,    v_replace)      <>      0       THEN
                                                --
                                                v_qt_replaces   :=      v_qt_replaces   +       1;
                                                --
                                        END     IF;
                                        --
                                        IF      RetornaTpCondicao       (p_id_query
                                                                        ,r)             =       'VR'    THEN
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,''''||p_parametros(r)||'''');
                                                --
                                        ELSIF   RetornaTpCondicao       (p_id_query
                                                                        ,r)             =       'DT'    THEN
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,'to_date('''||p_parametros(r)||''',''DD/MM/YYYY'')');
                                                --
                                        ELSE
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,p_parametros(r));
                                                --
                                        END     IF;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      1;
                                                p_msg_erro      :=      'Erro ao substituir condies: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --
                        END     LOOP;
                        --
                        p_pack_sem_retorno      :=      TRUE;
                        --
                        IF      v_qt_replaces   <>      p_parametros.Count      THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Query espera receber '||p_parametros.Count||' parmetros e recebeu apenas '||v_qt_replaces||'.';
                                --
                        END     IF;
                        --
                        IF      v_qt_condicoes  <>      v_qt_replaces   THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Query espera substituir '||v_qt_condicoes||' condio(es) e substituiu apenas '||v_qt_replaces||'.';
                                --
                        END     IF;
                        --
                END     IF;
                --
                v_qt_select     :=      InStr(Upper(p_texto_query),'SELECT');
                --
                IF      v_qt_select     >       0       THEN
                        --
                        p_is_select     :=      TRUE;
                        --
                        --      Substituindo as condies do where
                        --
                        FOR     r       IN      1..p_parametros.Count   LOOP
                                --
                                BEGIN
                                        --
                                        v_replace       :=      'COND'||LPad(r, 2,      '0');
                                        --
                                        IF      InStr(p_texto_query,    v_replace)      <>      0       THEN
                                                --
                                                v_qt_replaces   :=      v_qt_replaces   +       1;
                                                --
                                        END     IF;
                                        --
                                        IF      RetornaTpCondicao       (p_id_query
                                                                        ,r)             =       'VR'    THEN
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,''''||p_parametros(r)||'''');
                                                --
                                        ELSIF   RetornaTpCondicao       (p_id_query
                                                                        ,r)             =       'DT'    THEN
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,'to_date('''||p_parametros(r)||''',''DD/MM/YYYY'')');
                                                --
                                        ELSE
                                                --
                                                p_texto_query   :=      REPLACE (Upper(p_texto_query)
                                                                                ,v_replace
                                                                                ,p_parametros(r));
                                                --
                                        END     IF;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      1;
                                                p_msg_erro      :=      'Erro ao substituir condies: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END     LOOP;
                        --
                        IF      v_qt_replaces   <>      p_parametros.Count      THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Query espera receber '||p_parametros.Count||' parmetros e recebeu apenas '||v_qt_replaces||'.';
                                --
                        END     IF;
                        --
                        IF      v_qt_condicoes  <>      v_qt_replaces   THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Query espera substituir '||v_qt_condicoes||' condio(es) e substituiu apenas '||v_qt_replaces||'.';
                                --
                        END     IF;
                        --
                ELSE
                        --
                        p_is_select     :=      FALSE;
                        --
                END     IF;
                --
                p_titulo        :=      v_titulo;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro RetornaQuery: '||SQLERRM;
                        --
        END     RetornaQuery;
        --
        --------------------------------------------------------------------------
        --      MontaQuery
        --------------------------------------------------------------------------
        --
        FUNCTION        MontaQuery      (p_texto_query  IN      VARCHAR2
                                        ,p_id_query     IN      NUMBER
                                        ,p_cd_erro      OUT     NUMBER
                                        ,p_msg_erro     OUT     VARCHAR2)
        RETURN          VARCHAR2        IS
        --
        v_tem_union     BOOLEAN;
        --
        v_qt_ocorr      NUMBER;
        v_qt_iteracoes  NUMBER;
        --
        v_ate_from              VARCHAR2(4000);
        v_ate_union             VARCHAR2(4000);
        v_depois_union          VARCHAR2(4000);
        v_ate_from_union        VARCHAR2(4000);
        v_ate_from_depois_union VARCHAR2(4000);
        v_where                 VARCHAR2(4000);
        v_query_sem_pr          VARCHAR2(4000);
        v_new_query             VARCHAR2(4000);
        --
        v_from1                 VARCHAR2(4000);
        v_from2                 VARCHAR2(4000);
        --
        BEGIN
                --
                --      Verificando quantos campos  preciso concatenar na
                --      query
                --
                p_cd_erro       :=      0;
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_qt_ocorr
                        FROM     cta0022_campo_saida_query
                        WHERE   id_query        =       p_id_query;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_qt_ocorr      :=      0;
                                --
                END;
                --
                --      Verificando se a query possui UNION
                --
                IF      InStr(Upper(p_texto_query),     'UNION')        <>      0       THEN
                        --
                        v_tem_union     :=      TRUE;
                        --
                ELSE
                        --
                        v_tem_union     :=      FALSE;
                        --
                END     IF;
                --
                --      Montando a nova query
                --
                IF      v_tem_union     THEN
                        --
                        v_ate_union             :=      SubStr(p_texto_query,   1,      InStr(Upper(p_texto_query),    'UNION')  -       1);
                        --
                        v_from1                 :=      SubStr(v_ate_union,     InStr(Upper(v_ate_union),      'FROM') -       1,      Length(v_ate_union));
                        --
                        v_depois_union          :=      SubStr(p_texto_query,   InStr(Upper(p_texto_query),    'UNION')  +      5,      Length(p_texto_query));
                        --
                        v_from2                 :=      SubStr(v_depois_union,  InStr(Upper(v_depois_union),      'FROM') -       1,      Length(v_depois_union));
                        --
                        v_ate_from_union        :=      SubStr(p_texto_query,   1,      InStr(Upper(p_texto_query),    'FROM')  -       1);
                        --
                        v_ate_from_depois_union :=      SubStr(v_depois_union,  1,      InStr(Upper(v_depois_union),    'FROM')  -       1);
                        --
                        v_qt_iteracoes  :=      30      -       v_qt_ocorr;
                        --
                        FOR     r       IN      1..v_qt_iteracoes       LOOP
                                --
                                v_ate_from_union        :=      v_ate_from_union||', NULL';
                                --
                        END     LOOP;
                        --
                        v_ate_from      :=      SubStr(p_texto_query,   InStr(Upper(p_texto_query),    'UNION')  +      5,     InStr(Upper(p_texto_query),    'FROM')  -       1);
                        --
                        FOR     r       IN      1..v_qt_iteracoes       LOOP
                                --
                                v_ate_from_depois_union :=      v_ate_from_depois_union||', NULL';
                                --
                        END     LOOP;
                        --
                        v_new_query     :=      v_ate_from_union||' '||v_from1||' UNION '||v_ate_from_depois_union||' '||v_from2;
                        --
                        v_new_query     :=      REPLACE(v_new_query,    ';',    NULL);
                        --
                ELSE
                        --
                        v_ate_from      :=      SubStr(p_texto_query,   1,      InStr(Upper(p_texto_query),    'FROM')  -       1);
                        --
                        v_where         :=      REPLACE(SubStr(p_texto_query,   InStr(Upper(p_texto_query),     'FROM'),        Length(p_Texto_query)), ';',    NULL);
                        --
                        v_qt_iteracoes  :=      30      -       v_qt_ocorr;
                        --
                        GravaLog        (v_qt_iteracoes);
                        --
                        FOR     r       IN      1..v_qt_iteracoes       LOOP
                                --
                                v_ate_from      :=      v_ate_from||', NULL';
                                --
                        END     LOOP;
                        --
                        v_new_query     :=      v_ate_from||' '||v_where;
                        --
                END     IF;
                --
                RETURN  v_new_query;
                --

        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro MontaQuery: '||SQLERRM;
                        --
        END     MontaQuery;
        --
        --------------------------------------------------------------------------
        --      GeraArquivoGenerico
        --------------------------------------------------------------------------
        --
        PROCEDURE       GeraArquivoGenerico     (p_id_query     IN      NUMBER
                                                ,p_texto_query  IN      VARCHAR2
                                                ,p_titulo       IN      VARCHAR2
                                                ,p_parametros   IN      t_param
                                                ,p_nm_arquivo   OUT     VARCHAR2
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)       IS
        --
        v_header        VARCHAR2(4000);
        arq_generico    Utl_File.file_type;
        c_query         SYS_REFCURSOR;
        --
        v_nm_query      cta0021_query.nm_query%TYPE;
        --
        v_result1       VARCHAR2(4000);
        v_result2       VARCHAR2(4000);
        v_result3       VARCHAR2(4000);
        v_result4       VARCHAR2(4000);
        v_result5       VARCHAR2(4000);
        v_result6       VARCHAR2(4000);
        v_result7       VARCHAR2(4000);
        v_result8       VARCHAR2(4000);
        v_result9       VARCHAR2(4000);
        v_result10      VARCHAR2(4000);
        v_result11      VARCHAR2(4000);
        v_result12      VARCHAR2(4000);
        v_result13      VARCHAR2(4000);
        v_result14      VARCHAR2(4000);
        v_result15      VARCHAR2(4000);
        v_result16      VARCHAR2(4000);
        v_result17      VARCHAR2(4000);
        v_result18      VARCHAR2(4000);
        v_result19      VARCHAR2(4000);
        v_result20      VARCHAR2(4000);
        v_result21      VARCHAR2(4000);
        v_result22      VARCHAR2(4000);
        v_result23      VARCHAR2(4000);
        v_result24      VARCHAR2(4000);
        v_result25      VARCHAR2(4000);
        v_result26      VARCHAR2(4000);
        v_result27      VARCHAR2(4000);
        v_result28      VARCHAR2(4000);
        v_result29      VARCHAR2(4000);
        v_result30      VARCHAR2(4000);
        --
        v_qt_linhas     NUMBER;
        --
        i               NUMBER;
        --
        v_qt_select     NUMBER;
        --
        CURSOR  c_header        IS
                --
                SELECT  nm_campo
                FROM    cta0022_campo_saida_query
                WHERE   id_query        =       p_id_query
                ORDER BY sq_campo;
        --
        CURSOR  c_parametros_entrada    IS
                --
                SELECT  nm_campo
                FROM    cta0023_campo_condc_query
                WHERE   id_query        =       p_id_query
                order BY sq_campo;
        --
        BEGIN
                --
                v_qt_linhas     :=      0;
                --
                BEGIN
                        --
                        SELECT  nm_query
                        INTO    v_nm_query
                        FROM    cta0021_query
                        WHERE   id_query        =       p_id_query;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                GravaLog        ('Erro ao recuperar nome da query: '||p_id_query||'. - '||SQLERRM);
                                --
                                v_nm_query      :=      NULL;
                                --
                END;
                --
                p_nm_arquivo    :=      'relatorio_'||v_nm_query||'.xls';
                --
                arq_generico    :=      Utl_File.fopen  ('DIR_RECEPCAO'
                                                        ,p_nm_arquivo
                                                        ,'W');
                --
                Utl_File.put_line       (arq_generico
                                        ,p_titulo);
                --
                Utl_File.put_line       (arq_generico
                                        ,' ');
                --
                GravaLog        ('dentro do GeraArquivoGenerico antes do for');
                --
                i       :=      1;
                --
                FOR     r_parametros_entrada    IN      c_parametros_entrada    LOOP
                        --
                        IF      i       =       1       THEN
                                --
                                Utl_File.put_line       (arq_generico
                                                        ,'Parametros de Entrada:');
                                --
                        END     IF;
                        --
                        Utl_File.put_line       (arq_generico
                                                ,r_parametros_entrada.nm_campo || Chr(9) || p_parametros(i));
                        --
                        i       :=      i       +       1;
                        --
                END     LOOP;
                --
                IF      i       >       1       THEN
                        --
                        Utl_File.put_line       (arq_generico
                                                ,' ');
                        --
                END     IF;
                --
                FOR     r_header        IN      c_header        LOOP
                        --
                        v_header        :=      v_header||r_header.nm_campo||Chr(9);
                        --
                END     LOOP;
                --
                GravaLog        ('dentro do GeraArquivoGenerico depois do for');
                --
                Utl_File.put_line       (arq_generico
                                        ,v_header);
                --
                v_qt_select     :=      InStr(Upper(p_texto_query),'SELECT');
                --
                IF      v_qt_select     >       0       THEN
                        --
                        GravaLog        ('p_texto_query');
                        --
                        GravaLog        (p_texto_query);
                        --
                        OPEN    c_query FOR     p_texto_query;
                        --
                        GravaLog        ('depois do open');
                        --
                        LOOP
                                --
                                FETCH   c_query INTO    v_result1,
                                                        v_result2,
                                                        v_result3,
                                                        v_result4,
                                                        v_result5,
                                                        v_result6,
                                                        v_result7,
                                                        v_result8,
                                                        v_result9,
                                                        v_result10,
                                                        v_result11,
                                                        v_result12,
                                                        v_result13,
                                                        v_result14,
                                                        v_result15,
                                                        v_result16,
                                                        v_result17,
                                                        v_result18,
                                                        v_result19,
                                                        v_result20,
                                                        v_result21,
                                                        v_result22,
                                                        v_result23,
                                                        v_result24,
                                                        v_result25,
                                                        v_result26,
                                                        v_result27,
                                                        v_result28,
                                                        v_result29,
                                                        v_result30;
                                --
                                EXIT    WHEN    c_query%NOTFOUND;
                                --
                                Utl_File.put_line       (arq_generico
                                                        ,v_result1      ||Chr(9)||
                                                         v_result2      ||Chr(9)||
                                                         v_result3      ||Chr(9)||
                                                         v_result4      ||Chr(9)||
                                                         v_result5      ||Chr(9)||
                                                         v_result6      ||Chr(9)||
                                                         v_result7      ||Chr(9)||
                                                         v_result8      ||Chr(9)||
                                                         v_result9      ||Chr(9)||
                                                         v_result10     ||Chr(9)||
                                                         v_result11     ||Chr(9)||
                                                         v_result12     ||Chr(9)||
                                                         v_result13     ||Chr(9)||
                                                         v_result14     ||Chr(9)||
                                                         v_result15     ||Chr(9)||
                                                         v_result16     ||Chr(9)||
                                                         v_result17     ||Chr(9)||
                                                         v_result18     ||Chr(9)||
                                                         v_result19     ||Chr(9)||
                                                         v_result20     ||Chr(9)||
                                                         v_result21     ||Chr(9)||
                                                         v_result22     ||Chr(9)||
                                                         v_result23     ||Chr(9)||
                                                         v_result24     ||Chr(9)||
                                                         v_result25     ||Chr(9)||
                                                         v_result26     ||Chr(9)||
                                                         v_result27     ||Chr(9)||
                                                         v_result28     ||Chr(9)||
                                                         v_result29     ||Chr(9)||
                                                         v_result30);
                                --
                                v_qt_linhas     :=      v_qt_linhas     +       1;
                                --
                        END     LOOP;
                        --
                ELSE
                        --
                        GravaLog('entrou no else');
                        --
                        Utl_File.put_line       (arq_generico
                                                ,'entrou no else');
                        --
                END     IF;
                --
                GravaLog('depois do loop');
                --
                Utl_File.fclose (arq_generico);
                --
                GravaLog        ('Quantidade de linhas da query: '||v_qt_linhas);
                --
                IF      v_qt_linhas     =       0       THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Relatrio no encontrou informaes para retornar na planilha.';
                        --
                        BEGIN
                                --
                                Utl_File.fremove        ('DIR_RECEPCAO'
                                                        ,p_nm_arquivo);
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        NULL;   --      No precisa dar erro.
                                        --
                        END;
                        --
                END     IF;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro GeraArquivoGenerico: '||SQLERRM;
                        --
        END     GeraArquivoGenerico;
        --
        --------------------------------------------------------------------------
        --      EnviaArquivoEmail
        --------------------------------------------------------------------------
        --
        PROCEDURE       EnviaArquivoEmail       (p_id_query     IN      NUMBER
                                                ,p_nm_arquivo   IN      VARCHAR2
                                                ,p_emails       IN      VARCHAR2
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)       IS
        --
        v_indx                  NUMBER;
        v_fault_a               tms_storage.r_request_fault;
        v_correlation_id        tms_util.correlation_id;
        v_body                  CLOB;
        v_blob                  BLOB;
        v_file                  tms_mail.file_type;
        v_to                    tms_mail.address_type;
        v_cc                    tms_mail.address_type;
        v_bcc                   tms_mail.address_type;
        --
        v_ambiente              VARCHAR2(4000);
        v_destinatarios         VARCHAR2(4000);
        --
        CURSOR  dest_query      (p_id_query     IN      NUMBER) IS
                --
                SELECT  REPLACE(cd_email_desnt_query,   '@tokiomarine.com.br',  NULL)||';'       cd_email_desnt_query
                FROM    cta0025_desnt_query
                WHERE   id_query        =       p_id_query;
                --
        BEGIN
                --
                IF      p_emails        IS      NOT     NULL    THEN
                        --
                        v_destinatarios :=      REPLACE(p_emails,       '@tokiomarine.com.br',  NULL);
                        --
                ELSE
                        --
                        FOR     r_dest_query    IN      dest_query      (p_id_query)    LOOP
                                --
                                v_destinatarios :=      v_destinatarios||       r_dest_query.cd_email_desnt_query;
                                --
                        END     LOOP;
                        --
                END     IF;
                --
                GravaLog        ('Destinatrios: '||v_destinatarios);
                --
                BEGIN
                        --
                        v_ambiente      :=      tms_param.get_param     ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
                        --
                        v_indx          :=      0;
                        --
                        WHILE   v_destinatarios IS      NOT     NULL    LOOP
                                --
                                IF      InStr(v_destinatarios, ';')    <>      0       THEN
                                        --
                                        v_indx                  :=      v_indx  +       1;
                                        --
                                        v_to(v_indx)            :=      SubStr(v_destinatarios, 1,  InStr(v_destinatarios, ';')-1)||'@tokiomarine.com.br;';
                                        --
                                        v_destinatarios     :=      SubStr(v_destinatarios, InStr(v_destinatarios, ';')+1,Length(v_destinatarios));
                                        --
                                ELSE
                                        --
                                        v_indx                  :=      v_indx  +       1;
                                        --
                                        v_to(v_indx)            :=      SubStr(v_destinatarios, 1, Length(v_destinatarios))||'@tokiomarine.com.br';
                                        --
                                        v_destinatarios     :=      NULL;
                                        --
                                END     IF;
                                --
                        END     LOOP;
                        --
                        --      Enviando o arquivo por e-mail.
                        --
                        v_blob          :=      tms_storage.readFileAndLoadAsBLOB       ('DIR_RECEPCAO'
                                                                                        ,p_nm_arquivo);
                        --
                        v_body          :=      to_clob('Segue o arquivo do relatrio.');
                        --
                        v_file(1)       :=      TMS_FILE_RECORD (p_nm_arquivo
                                                                ,v_blob);
                        --
                        BEGIN
                                --
                                TMS_MAIL.send_html      ('recepcao.eletronica@tokiomarine.com.br'
                                                        ,v_to
                                                        ,v_cc
                                                        ,v_bcc
                                                        ,'['||v_ambiente||'] - Arquivo '||p_nm_arquivo
                                                        ,v_body
                                                        ,v_file
                                                        ,v_fault_a
                                                        ,v_correlation_id);
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      1;
                                        p_msg_erro      :=      '[' || v_id_log_servc || ']' || '[1]Erro ao enviar e-mail: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      '[' || v_id_log_servc || ']' || '[2]Erro ao enviar arquivo por e-mail: '||SQLERRM;
                                --
                                RETURN;
                                --
                END;
                --
                BEGIN
                        --
                        utl_file.fremove        ('DIR_RECEPCAO'
                                                ,p_nm_arquivo);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                NULL;
                                --
                END;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      'Erro EnviaArquivoEmail: '||SQLERRM;
                        --
        END     EnviaArquivoEmail;
        --
        --------------------------------------------------------------------------
        --      GeraPlanilha
        --------------------------------------------------------------------------
        --
        PROCEDURE       GeraPlanilha    (p_id_query     IN      NUMBER
                                        ,p_parametros   IN      t_param
                                        ,p_emails       IN      VARCHAR2
                                        ,p_usuario      IN      VARCHAR2
                                        ,p_tp_local     IN      NUMBER
                                        ,p_cd_local     IN      NUMBER
                                        ,p_cd_erro      OUT     NUMBER
                                        ,p_msg_erro     OUT     VARCHAR2)       IS
        --
        v_texto_query   VARCHAR2(32000);
        v_nova_query    VARCHAR2(4000);
        v_nm_arquivo    VARCHAR2(4000);
        --
        erro_impeditivo EXCEPTION;
        v_cd_erro       NUMBER;
        v_msg_erro      VARCHAR2(4000);
        v_titulo        VARCHAR2(4000);
        v_is_select     BOOLEAN;
        v_pack_sem_retorno      BOOLEAN;
        --
        v_titulo_query  VARCHAR2(4000);
        v_onwer_query   VARCHAR2(4000);
        v_pack_query    VARCHAR2(4000);
        v_proc_query    VARCHAR2(4000);
        v_nm_query      VARCHAR2(100);
        v_tp_erro_impeditivo    NUMBER (02);
        v_declare               VARCHAR2(4000);
        --
        BEGIN
                --
                --      Insere id_log_servio
                --
                ctactpa0100_001.IniciaLog       (181
                                                ,'CTA'          -- p_sg_sistm_origm               IN      VARCHAR2
                                                ,NULL           -- p_cd_crtor_segur               IN      NUMBER
                                                ,NULL           -- p_cd_asses                     IN      NUMBER
                                                ,p_id_query     -- p_cd_ctrat                     IN      NUMBER
                                                ,NULL           -- p_cd_item_ctrat                IN      NUMBER
                                                ,NULL           -- p_tp_pesoa                     IN      VARCHAR2
                                                ,NULL           -- p_nr_cpf_cnpj_clien            IN      NUMBER
                                                ,NULL           -- p_nm_clien_sgrdo               IN      VARCHAR2
                                                ,NULL           -- p_cd_usuro                     IN      VARCHAR2
                                                ,NULL           -- p_cd_tipo_procs                IN      NUMBER
                                                ,v_id_log_servc -- p_sq_log                       OUT     NUMBER
                                                );
                Dbms_Output.Put_Line('Log: '||v_id_log_servc);

                GravaLog('passou do inicialog :' || v_id_log_servc);
                --
                --      Remove o log de execues anteriores, para no
                --      sobrecarregar o file system
                --
                GravaLog        (LPad('=',      80,     '='));
                GravaLog        (' p_id_query....: '||p_id_query);
                --
                IF      p_parametros    IS      NOT     NULL    THEN
                        --
                        FOR     r       IN      1..p_parametros.Count   LOOP
                                --
                                GravaLog        (' p_parametros('||r||') = '||p_parametros(r));
                                --
                        END     LOOP;
                        --
                END     IF;
                --
                --      Retorna o texto da query, j com as condies
                --      substituidas
                --
                GravaLog        ('- RetornaQuery');
                --

                --
                RetornaQuery    (p_id_query
                                ,p_parametros
                                ,v_titulo
                                ,v_texto_query
                                ,v_is_select
                                ,v_pack_sem_retorno
                                ,v_declare
                                ,v_nm_query
                                ,v_cd_erro
                                ,v_msg_erro);
                --
                GravaLog        ('passou do retornaquery : ' || v_cd_erro);
                --
                IF      v_pack_sem_retorno      THEN
                        --
                        GravaLog        ('v_pack_sem_retorno true');
                        --
                ELSE
                        --
                        GravaLog        ('v_pack_sem_retorno false');
                        --
                END     IF;
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        v_tp_erro_impeditivo    :=      1;
                        --
                        RAISE   erro_impeditivo;
                        --
                END     IF;
                --
                IF      v_is_select     THEN
                        --
                        GravaLog        (v_texto_query);
                        --
                        --      Monta a nova query, concatenando os campos necessrios
                        --      para a planilha dinmica
                        --
                        GravaLog        ('- MontaQuery');
                        --
                        GravaLog        ('vai chamar o montaquery');
                        GravaLog        (SubStr('v_texto_query :' || v_texto_query,1,250));
                        v_nova_query    :=      MontaQuery      (v_texto_query
                                                                ,p_id_query
                                                                ,v_cd_erro
                                                                ,v_msg_erro);
                        --
                        GravaLog        ('passou do montaquery');
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                v_tp_erro_impeditivo    :=      2;
                                --
                                RAISE   erro_impeditivo;
                                --
                        END     IF;
                        --
                        GravaLog        (v_nova_query);
                        --
                        --      Gera o arquivo a partir da query gerada pela procedure
                        --      MontaQuery
                        --
                        GravaLog        ('- GeraArquivoGenerico');
                        --
                        GeraArquivoGenerico     (p_id_query
                                                ,v_nova_query
                                                ,v_titulo
                                                ,p_parametros
                                                ,v_nm_arquivo
                                                ,v_cd_erro
                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                v_tp_erro_impeditivo    :=      3;
                                --
                                RAISE   erro_impeditivo;
                                --
                        END     IF;
                        --
                        GravaLog        ('- EnviaArquivoEmail');
                        --
                        EnviaArquivoEmail       (p_id_query
                                                ,v_nm_arquivo
                                                ,p_emails
                                                ,v_cd_erro
                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                v_tp_erro_impeditivo    :=      4;
                                --
                                RAISE   erro_impeditivo;
                                --
                        END     IF;
                        --
                        GravaLog        (LPad('=',      80,     '=')||Chr(10));
                        --
                ELSIF   v_pack_sem_retorno      THEN
                        --
                        --
                        v_titulo_query  :=      SubStr(v_texto_query,1,InStr(v_texto_query,'|')-1);
                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'|')+1,Length(v_texto_query));
                        --
                        v_onwer_query   :=      SubStr(v_texto_query,1 ,InStr(v_texto_query,'.')-1);

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        v_pack_query   :=       SubStr(v_texto_query,1 ,InStr(v_texto_query,'.')-1);

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        v_proc_query   :=       v_texto_query;

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        GravaLog        ('No  um select. Chamando a package sem retorno.');
                        --
                        executaPackSemRetorno   (p_id_query
                                                ,v_onwer_query
                                                ,v_pack_query
                                                ,v_proc_query
                                                ,v_declare
                                                ,v_nm_arquivo
                                                ,p_usuario
                                                ,p_tp_local
                                                ,p_cd_local
                                                ,p_parametros);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                v_tp_erro_impeditivo    :=      5;
                                --
                                RAISE   erro_impeditivo;
                                --
                        END     IF;
                        --
                ELSE
                        --
                        v_titulo_query  :=      SubStr(v_texto_query,1,InStr(v_texto_query,'|')-1);
                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'|')+1,Length(v_texto_query));
                        --
                        v_onwer_query   :=      SubStr(v_texto_query,1 ,InStr(v_texto_query,'.')-1);

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        v_pack_query   :=       SubStr(v_texto_query,1 ,InStr(v_texto_query,'.')-1);

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        v_proc_query   :=       v_texto_query;

                        --
                        v_texto_query   :=      SubStr(v_texto_query,InStr(v_texto_query,'.')+1,Length(v_texto_query));
                        --
                        GravaLog        ('No  um select. Chamando a package genrica.');
                        --
                        v_nm_arquivo    :=      v_nm_query      || '.csv';
                        --
                        ExecutaPackProc         (p_id_query
                                                ,v_onwer_query
                                                ,v_pack_query
                                                ,v_proc_query
                                                ,v_nm_arquivo
                                                ,p_usuario
                                                ,p_tp_local
                                                ,p_cd_local
                                                ,p_parametros);
                        --
                        GravaLog        ('- EnviaArquivoEmail');
                        --
                        EnviaArquivoEmail       (p_id_query
                                                ,v_nm_arquivo
                                                ,p_emails
                                                ,v_cd_erro
                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                v_tp_erro_impeditivo    :=      5;
                                --
                                RAISE   erro_impeditivo;
                                --
                        END     IF;
                        --
                        GravaLog        (LPad('=',      80,     '=')||Chr(10));
                        --
                END     IF;
                --
                CTACTPA0100_001.FinalizaLog     (v_id_log_servc);
                --
        EXCEPTION
                --
                WHEN    erro_impeditivo THEN
                        --
                        p_cd_erro       :=      v_cd_erro;
                        p_msg_erro      :=      v_msg_erro;
                        --
                        GravaLog        ('Sada anormal: '|| retorna_linha_erro(DBMS_UTILITY.format_error_backtrace) || ' ' || v_tp_erro_impeditivo||p_cd_erro||' - '||p_msg_erro);
                        CTACTPA0100_001.FinalizaLog     (181);
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      1;
                        p_msg_erro      :=      '[' || v_id_log_servc || ']' || 'Erro GeraPlanilha: '||SQLERRM;
                        --
                        GravaLog        ('Erro geral: '|| retorna_linha_erro(DBMS_UTILITY.format_error_backtrace) || ' ' ||SQLERRM);
                        CTACTPA0100_001.FinalizaLog     (181);
        END     GeraPlanilha;
        --
END     ctactpa0018_001;
/


CREATE OR REPLACE PACKAGE BODY    CTACTPA0019_001 IS
        --
        --------------------------------------------------------------------------
        --      ExisteCdSegmento:       Verifica se o segmento passado para     --
        --                              o servio existe nas bases do conta     --
        --                              corrente;
        --------------------------------------------------------------------------
        --
        FUNCTION        ExisteCdSegmento        (p_cd_segmento  IN      NUMBER
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)
        RETURN          BOOLEAN IS
        --
        v_cd_segmt_prdut        cta0006_segmt_prdut.cd_segmt_prdut%TYPE;
        --
        BEGIN
                --
                SELECT  cd_segmt_prdut
                INTO    v_cd_segmt_prdut
                FROM    cta0006_segmt_prdut
                WHERE   cd_segmt_prdut  =       p_cd_segmento;
                --
                RETURN  TRUE;
                --
        EXCEPTION
                --
                WHEN    No_Data_Found   THEN
                        --
                        p_cd_erro       :=      76;
                        p_msg_erro      :=      'Cdigo de segmento no encontrado: '||p_cd_segmento;
                        --
                        RETURN  FALSE;
                        --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      77;
                        p_msg_erro      :=      'Erro ExisteCdSegmento: '||SQLERRM;
                        --
                        RETURN  FALSE;
                        --
        END     ExisteCdSegmento;
        --
        --------------------------------------------------------------------------
        --      ExisteDiretoria:        Verifica se a diretoria passado para    --
        --                              o servio existe nas bases do acselx    --
        --------------------------------------------------------------------------
        --
        FUNCTION        ExisteDiretoria        (p_cd_diretoria  IN      NUMBER)
        RETURN          BOOLEAN IS
        --
        po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
        po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
        v_chave       VARCHAR2(32);
        --
        BEGIN
                --
                v_chave := 'RPSSA          24' || LPAD(p_cd_diretoria, 15, 0);
                --
                ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01(V_CHAVE, 2, 1, 1, po_locais, po_mensagem);                
                --
                IF    po_mensagem.status_retorno  =   0     THEN 
                  --
                  IF  po_locais(1).DC_ENCE_LOC    IS NULL   THEN 
                    --
                    RETURN  TRUE;
                    --
                  END   IF;
                  --
                END   IF;
                --
                RETURN  FALSE;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  FALSE;
                        --
        END     ExisteDiretoria;
        --
        --------------------------------------------------------------------------
        --      ExisteSucursal:         Verifica se a sucursal passado para    --
        --                              o servio existe nas bases do acselx    --
        --------------------------------------------------------------------------
        --
        FUNCTION        ExisteSucursal        (p_cd_sucursal  IN      NUMBER)
        RETURN          BOOLEAN IS
        --
        po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKEMPTOACX02;
        po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKEMPTOACX02;
        v_chave       VARCHAR2(32);
        --
        BEGIN
                --
                v_chave := 'RPSSA          80' || LPAD(p_cd_sucursal, 15, 0);
                --
                ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKEMPTOACX02(V_CHAVE, 2, 1, 1, po_locais, po_mensagem);
                --
                IF    po_mensagem.status_retorno  =   0     THEN 
                  --
                  IF  po_locais(1).DC_ENCE_LOC    IS NULL   THEN 
                    --
                    RETURN  TRUE;
                    --
                  END   IF;
                  --
                END   IF;
                --
                RETURN  FALSE;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        RETURN  FALSE;
                        --
        END     ExisteSucursal;
		
		--
		---------------------------------------------------------------------------
		--      validaInicioVigencia:   Verifica se a data de inicio de vigencia --
		--                              est dentro do permitido para o corretor --
		---------------------------------------------------------------------------
		--
		FUNCTION ValidaInicioVigencia(P_CODIGO_SELECIONADO IN NUMBER
									 ,P_DT_INICIO_VIGENCIA IN DATE
									 ,P_PARAMETRO          IN VARCHAR2
									 ,P_CD_ERRO            OUT NUMBER
									 ,P_MSG_ERRO           OUT VARCHAR2
									 ,P_DT_RETROATIVA      OUT DATE) RETURN BOOLEAN IS
			--
			V_QT_DIAS_RETROATIVO     NUMBER;
			V_DT_ATUAL               DATE;
			V_CODIGOS_CADASTRADOS VARCHAR2(4000);
			--
		BEGIN
			--
			V_QT_DIAS_RETROATIVO := 0;
			V_DT_ATUAL           := TRUNC(SYSDATE);
			P_DT_RETROATIVA      := TRUNC(SYSDATE);
			--
			SELECT ';' || DS_PARAM_CC || ';' AS DS_PARAM_CC
			INTO   V_CODIGOS_CADASTRADOS
			FROM   CTA0008_PARAM_CC
			WHERE  NM_PARAM_CC = P_PARAMETRO
			AND    CD_SEGMT_PRDUT = 1;
			--
			IF INSTR(V_CODIGOS_CADASTRADOS, (';' || P_CODIGO_SELECIONADO || ';')) > 0 THEN
				--
				SELECT DS_PARAM_CC
				INTO   V_QT_DIAS_RETROATIVO
				FROM   CTA0008_PARAM_CC
				WHERE  NM_PARAM_CC = 'QT_DIA_VIGEN_RETRO'
				AND    CD_SEGMT_PRDUT = 1;
				--
				IF V_QT_DIAS_RETROATIVO IS NOT NULL AND
				   V_QT_DIAS_RETROATIVO > 0 THEN
					--
					P_DT_RETROATIVA := (V_DT_ATUAL - V_QT_DIAS_RETROATIVO);
					--
					IF P_DT_RETROATIVA <= P_DT_INICIO_VIGENCIA THEN
						--
						RETURN TRUE;
						--
					ELSE
						--
						RETURN FALSE;
						--
					END IF;
					--
				ELSE
					--
					IF V_DT_ATUAL <= P_DT_INICIO_VIGENCIA THEN
						--
						RETURN TRUE;
						--
					ELSE
						--
						RETURN FALSE;
						--
					END IF;
					--
				END IF;
				--
			ELSE
				--
				IF V_DT_ATUAL <= P_DT_INICIO_VIGENCIA THEN
					--
					RETURN TRUE;
					--
				ELSE
					--
					RETURN FALSE;
					--
				END IF;
				--
			END IF;
			--
		EXCEPTION
			--
			WHEN OTHERS THEN
				--
				p_cd_erro  := 77;
				p_msg_erro := 'Erro ValidaInicioVigencia: ' || SQLERRM;
				--
				RETURN FALSE;
				--
		END ValidaInicioVigencia;
        --
        --------------------------------------------------------------------------
        --      Credita_Verba_Sucsl_Diret: Efetuar o crdito de verba pela rea --
        --                                 de produto.                          --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Credita_Verba_Sucsl_Diret  (p_credita_verba_sucs_diret_in         IN      credita_verba_sucs_diret_in
                                                   ,p_credita_verba_sucs_diret_out        OUT     credita_verba_sucs_diret_out)  IS
        --
        v_dt_procm              DATE;
        v_dt_fim_vigen_verba    DATE;
        v_dt_inico_vigen_verba  DATE;
        --
        v_cd_erro               NUMBER;
        v_id_verba              NUMBER;
        v_id_lacto              NUMBER;
        v_id_procs_criac        NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        v_sq_log                NUMBER;
        erro_fatal              EXCEPTION;
        --
        v_VlTransferencia       NUMBER(15,2);
        v_dt_inico_vigen        DATE;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_credita_verba_sucs_diret_out    :=      credita_verba_sucs_diret_out      (0
                                                                                            ,NULL
                                                                                            ,NULL);
                --
                v_VlTransferencia       :=      Round(p_credita_verba_sucs_diret_in.VlTransferencia,  2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (191
                                                ,p_credita_verba_sucs_diret_in.SistemaChamador
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_credita_verba_sucs_diret_in.CdUsuario
                                                ,p_credita_verba_sucs_diret_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                              ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')              ||Chr(10)||
                                                LPad('=',      80,     '=')                                                               ||Chr(10)||
                                                'Servio Credita_Verba_Sucsl_Diret. Parmetros de entrada: '                              ||Chr(10)||
                                                ' SistemaChamador............. '||p_credita_verba_sucs_diret_in.SistemaChamador           ||Chr(10)||
                                                ' CdSegmento.................. '||p_credita_verba_sucs_diret_in.CdSegmento                ||Chr(10)||
                                                ' CdDiretoria................. '||p_credita_verba_sucs_diret_in.CdDiretoria               ||Chr(10)||
                                                ' CdSucursal.................. '||p_credita_verba_sucs_diret_in.CdSucursal                ||Chr(10)||
                                                ' VlTransferencia............. '||p_credita_verba_sucs_diret_in.VlTransferencia           ||Chr(10)||
                                                ' VlTransferencia............. '||v_VlTransferencia                                       ||Chr(10)||
                                                ' DtInicioVigenciaVerba....... '||p_credita_verba_sucs_diret_in.DtInicioVigenciaVerba     ||Chr(10)||
                                                ' DtFimVigenciaVerba.......... '||p_credita_verba_sucs_diret_in.DtFimVigenciaVerba        ||Chr(10)||
                                                ' CdUsuario................... '||p_credita_verba_sucs_diret_in.CdUsuario                 ||Chr(10)||
                                                ' CdProcesso.................. '||p_credita_verba_sucs_diret_in.CdProcesso                ||Chr(10)||
                                                ' Ambiente.................... '||CTACTPA0100_001.RetornaParametro('AMBIENTE')            ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_credita_verba_sucs_diret_in.SistemaChamador))      THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      2;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Sistema chamador invlido: '||p_credita_verba_sucs_diret_in.SistemaChamador  ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o segmento
                --
                IF      p_credita_verba_sucs_diret_in.CdSegmento  IS      NULL    THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      55;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Valor do cdigo segmento est nulo' ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o segmento
                --
                IF      NOT(ExisteCdSegmento    (p_credita_verba_sucs_diret_in.CdSegmento
                                                ,v_cd_erro
                                                ,v_msg_erro))   THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      v_cd_erro;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Carteira] - '||v_msg_erro ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL
                OR      v_VlTransferencia       =       0       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      58;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Valor do crdito invlido: '||v_VlTransferencia ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando data de incio de vigncia da verba
                --
                IF      p_credita_verba_sucs_diret_in.DtInicioVigenciaVerba       IS      NULL
                OR      NOT(CTACTPA0100_001.IsDataValida        (p_credita_verba_sucs_diret_in.DtInicioVigenciaVerba
                                                                ,v_dt_inico_vigen_verba))       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      59;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Data de incio vigncia da verba invlida: '||p_credita_verba_sucs_diret_in.DtInicioVigenciaVerba ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando data de fim de vigncia da verba
                --
                IF      p_credita_verba_sucs_diret_in.DtFimVigenciaVerba       IS      NULL
                OR      NOT(CTACTPA0100_001.IsDataValida        (p_credita_verba_sucs_diret_in.DtFimVigenciaVerba
                                                                ,v_dt_fim_vigen_verba))       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      60;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Data de incio vigncia da verba invlida: '||p_credita_verba_sucs_diret_in.DtFimVigenciaVerba ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validar se a data de incio de vigncia  menor que
                --      a data de processamento.
                --
                IF      v_dt_inico_vigen_verba  <       v_dt_procm      THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      72;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Data de incio de vigncia: '||To_Char(v_dt_inico_vigen_verba, 'DD/MM/YYYY')||' est menor que a data de processamento: '||To_Char(v_dt_procm, 'DD/MM/YYYY') ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
				--
				--      Validar se a data de incio de vigncia  menor que
				--      a data de processamento ou se o corretor est cadastrado
				--      para com uma data de inicio de vigencia retroativa menor que a data informada.
				--
				IF p_credita_verba_sucs_diret_in.CdDiretoria IS NOT NULL THEN
						IF NOT ValidaInicioVigencia(p_credita_verba_sucs_diret_in.CdDiretoria --
												   , v_dt_inico_vigen_verba --
												   , 'SUPERINT_INC_VERBA'
												   , v_cd_erro --
												   , v_msg_erro --
												   , v_dt_inico_vigen) THEN
								--
								p_credita_verba_sucs_diret_out.StRetorno  := 72;
								p_credita_verba_sucs_diret_out.MsgRetorno := '[Credita Verba Carteira] - Data de incio de vigncia: ' ||
																		   To_Char(v_dt_inico_vigen_verba, 'DD/MM/YYYY') ||
																		   ' est menor que a data de inicio de vigencia vlida: ' ||
																		   To_Char(v_dt_inico_vigen, 'DD/MM/YYYY');
								--
								RAISE erro_fatal;
								--
						END IF;
				ELSIF p_credita_verba_sucs_diret_in.CdSucursal IS NOT NULL THEN
						IF NOT ValidaInicioVigencia(p_credita_verba_sucs_diret_in.CdSucursal --
												   , v_dt_inico_vigen_verba --
												   , 'SUCURSAL_INC_VERBA'
												   , v_cd_erro --
												   , v_msg_erro --
												   , v_dt_inico_vigen) THEN
								--
								p_credita_verba_sucs_diret_out.StRetorno  := 72;
								p_credita_verba_sucs_diret_out.MsgRetorno := '[Credita Verba Carteira] - Data de incio de vigncia: ' ||
																		   To_Char(v_dt_inico_vigen_verba, 'DD/MM/YYYY') ||
																		   ' est menor que a data de inicio de vigencia vlida: ' ||
																		   To_Char(v_dt_inico_vigen, 'DD/MM/YYYY');
								--
								RAISE erro_fatal;
								--
						END IF;
				END IF;
                --
                --      Validar se a data de fim de vigncia  menor que
                --      a data de processamento.
                --
                IF      v_dt_fim_vigen_verba    <       v_dt_procm      THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      73;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Data de fim de vigncia: '||To_Char(v_dt_fim_vigen_verba, 'DD/MM/YYYY')||' est menor que a data de processamento: '||To_Char(v_dt_procm, 'DD/MM/YYYY') ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      v_dt_fim_vigen_verba    >       To_Date('31/12/2699',   'DD/MM/YYYY')   THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      73;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Data de fim de vigncia: '||To_Char(v_dt_fim_vigen_verba, 'DD/MM/YYYY') ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;               
                --
                --      Validando usurio
                --
                IF      p_credita_verba_sucs_diret_in.CdUsuario   IS      NULL    THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      10;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_credita_verba_sucs_diret_in.CdProcesso,     0)      <>      41      AND      Nvl(p_credita_verba_sucs_diret_in.CdProcesso,     0)      <>      42 THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      11;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Cdigo de processo invlido: '||p_credita_verba_sucs_diret_in.CdProcesso ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo / codigo sucursal
                --
                IF      Nvl(p_credita_verba_sucs_diret_in.CdProcesso,     0)      =      41      AND        p_credita_verba_sucs_diret_in.CdSucursal IS NOT NULL       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      12;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Cdigo de processo invlido, cdigo de sucursal esta preenchido: '||p_credita_verba_sucs_diret_in.CdProcesso ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo / codigo diretoria
                --
                IF      Nvl(p_credita_verba_sucs_diret_in.CdProcesso,     0)      =      42      AND        p_credita_verba_sucs_diret_in.CdDiretoria IS NOT NULL       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      13;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Cdigo de processo invlido, cdigo da diretoria esta preenchido: '||p_credita_verba_sucs_diret_in.CdProcesso ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo diretoria
                --
                IF      p_credita_verba_sucs_diret_in.CdDiretoria IS NOT NULL AND NOT(ExisteDiretoria(p_credita_verba_sucs_diret_in.CdDiretoria))       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      14;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Cdigo da superintendencia invlido: '||p_credita_verba_sucs_diret_in.CdDiretoria ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo sucursal
                --
                IF      p_credita_verba_sucs_diret_in.CdSucursal IS NOT NULL AND NOT(ExisteSucursal(p_credita_verba_sucs_diret_in.CdSucursal))       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      15;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Cdigo da diretoria invlido: '||p_credita_verba_sucs_diret_in.CdSucursal ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;                
                --
                --      Validando cdigo de processo / codigo diretoria
                --
                IF      p_credita_verba_sucs_diret_in.CdSucursal IS NOT NULL      AND        p_credita_verba_sucs_diret_in.CdDiretoria IS NOT NULL       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      14;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Favor informar o cdigo da diretoria ou da sucursal: '||p_credita_verba_sucs_diret_in.CdProcesso ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;                
                --
                --      Recebendo o id_procs_criac
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_credita_verba_sucs_diret_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      v_cd_erro;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - '||v_msg_erro ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] - '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      v_cd_erro;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - '||v_msg_erro ||' ('||v_sq_log||')';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Inserindo verba
                --
                BEGIN
                        --
                        SELECT  ctasq0002_verba.NEXTVAL
                        INTO    v_id_verba
                        FROM    dual;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_credita_verba_sucs_diret_out.StRetorno  :=      78;
                                p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Erro ao buscar sequencia ctasq0002_verba: '||SQLERRM ||' ('||v_sq_log||')';
                                --
                                RAISE   erro_fatal;
                                --
                END;
                --
                BEGIN
                        --
                        INSERT  INTO    cta0002_verba   (id_verba
                                                        ,cd_segmt_prdut
                                                        ,cd_crtor_segur
                                                        ,cd_asses
                                                        ,cd_tipo_verba
                                                        ,vl_inicl_verba
                                                        ,vl_prvsn_verba
                                                        ,vl_eftdo_verba
                                                        ,vl_crdto_verba
                                                        ,vl_saldo_verba
                                                        ,dt_inico_vigen
                                                        ,dt_fim_vigen
                                                        ,id_verba_origm_trnsf
                                                        ,cd_usuro_ultma_alter
                                                        ,cd_situc_verba
                                                        ,id_arquv_carga_verba
                                                        ,dt_ultma_alter
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl)
                                                        --
                                                VALUES  (v_id_verba
                                                        ,p_credita_verba_sucs_diret_in.CdSegmento
                                                        ,NULL
                                                        ,NULL
                                                        ,'T'
                                                        ,v_VlTransferencia
                                                        ,NULL
                                                        ,NULL
                                                        ,NULL
                                                        ,v_VlTransferencia
                                                        ,v_dt_inico_vigen_verba
                                                        ,v_dt_fim_vigen_verba
                                                        ,NULL
                                                        ,p_credita_verba_sucs_diret_in.CdUsuario
                                                        ,'ATI'
                                                        ,NULL
                                                        ,SYSDATE
                                                        ,p_credita_verba_sucs_diret_in.CdSucursal
                                                        ,p_credita_verba_sucs_diret_in.CdDiretoria);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_credita_verba_sucs_diret_out.StRetorno  :=      78;
                                p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Erro ao inserir tabela cta0002_verba: '||SQLERRM ||' ('||v_sq_log||')';
                                --
                                ROLLBACK;
                                --
                                RAISE   erro_fatal;
                                --
                END;
                --
                --      Inserindo o lanamento da verba
                --
                BEGIN
                        --
                        SELECT  ctasq0004_lacto.NEXTVAL
                        INTO    v_id_lacto
                        FROM    dual;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_credita_verba_sucs_diret_out.StRetorno  :=      41;
                                p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Erro ao buscar sequencia ctasq0004_lacto: '||SQLERRM ||' ('||v_sq_log||')';
                                --
                                RAISE   erro_fatal;
                                --
                END;
                --
                BEGIN
                        --
                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                        ,id_verba
                                                        ,cd_situc_lacto
                                                        ,cd_ctrat
                                                        ,cd_item_ctrat
                                                        ,cd_tipo_lacto
                                                        ,dt_lacto
                                                        ,vl_saldo_verba_anter
                                                        ,vl_lacto
                                                        ,vl_agrvo_ppota
                                                        ,vl_saldo_verba_postr
                                                        ,id_lacto_origm_trnsf
                                                        ,id_lacto_estor
                                                        ,tp_pesoa
                                                        ,nm_clien_sgrdo
                                                        ,nr_cpf_cnpj_clien
                                                        ,vl_prmio_liqui_ppota
                                                        ,pc_comis_crtor
                                                        ,dt_inico_vigen_segur
                                                        ,id_procs_criac
                                                        ,cd_usuro_criac
                                                        ,dt_criac
                                                        ,dt_ultma_alter
                                                        ,cd_sucsl_comrl
                                                        ,cd_diret_comrl
                                                        ,tp_desct_agrvo)
                                                        --
                                                VALUES  (v_id_lacto                                 --      id_lacto
                                                        ,v_id_verba                                 --      id_verba
                                                        ,'CRD'                                      --      cd_situc_lacto
                                                        ,NULL                                       --      cd_ctrat
                                                        ,NULL                                       --      cd_item_ctrat
                                                        ,'G'                                        --      cd_tipo_lacto
                                                        ,SYSDATE                                    --      dt_lacto
                                                        ,0                                          --      vl_saldo_verba_anter
                                                        ,v_VlTransferencia                          --      vl_lacto
                                                        ,0                                          --      vl_agrvo_ppota
                                                        ,v_VlTransferencia                          --      vl_saldo_verba_postr
                                                        ,NULL                                       --      id_lacto_origm_trnsf
                                                        ,NULL                                       --      id_lacto_estor
                                                        ,NULL                                       --      tp_pesoa
                                                        ,'Creditado pela rea de Produto'           --      nm_clien_sgrdo
                                                        ,NULL                                       --      nr_cpf_cnpj_clien
                                                        ,0                                          --      vl_prmio_liqui_ppota
                                                        ,0                                          --      pc_comis_crtor
                                                        ,NULL                                       --      dt_inico_vigen_segur
                                                        ,v_id_procs_criac                           --      id_procs_criac
                                                        ,p_credita_verba_sucs_diret_in.CdUsuario    --      cd_usuro_criac
                                                        ,SYSDATE                                    --      dt_criac
                                                        ,SYSDATE                                    --      dt_ultma_alter
                                                        ,p_credita_verba_sucs_diret_in.CdSucursal   --      cd_sucsl_comrl
                                                        ,p_credita_verba_sucs_diret_in.CdDiretoria  --      cd_diret_comrl
                                                        ,'A'                                        --      tp_desct_agrvo
                                                        );
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                p_credita_verba_sucs_diret_out.StRetorno  :=      41;
                                p_credita_verba_sucs_diret_out.MsgRetorno :=      '[Credita Verba Sucursal Diretoria] - Erro ao inserir tabela cta0004_lacto: '||SQLERRM ||' ('||v_sq_log||')';
                                --
                                RAISE   erro_fatal;
                                --
                END;
                --
                p_credita_verba_sucs_diret_out.IdLog := v_sq_log;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_credita_verba_sucs_diret_out.StRetorno||' - Mensagem: '||p_credita_verba_sucs_diret_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Credita_Verba_Sucsl_Diret: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        p_credita_verba_sucs_diret_out.StRetorno  :=      1;
                        p_credita_verba_sucs_diret_out.MsgRetorno :=      'Erro Credita_Verba_Sucsl_Diret: '||SQLERRM;
                        --
        END     Credita_Verba_Sucsl_Diret;
        --
END     CTACTPA0019_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0020_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        v_sq_log                NUMBER;


        --
        --------------------------------------------------------------------------
        --      IsRegistroValido:       Verifica se registro nao esta em dupli  --
        --                              cidade com anterior                     --
        --      RETORNA TRUE SE REGISTRO PODE SER INSERIDO                      --
        --      RETORNA FALSE SE REGISTRO E POSSIVEL DUPLICIDADE                --
        --------------------------------------------------------------------------
        --

        FUNCTION        IsRegistroValido        (p_id_sucursal  IN      NUMBER
                                                ,p_vl_lacto     IN      NUMBER
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)
        RETURN  BOOLEAN IS

        --
        -- OS 9866
        -- para nao termos mais duplicidade no momento da distribuicao de verba,
        -- sera verificado diferenca de tempo entre ultimo
        -- registro inserido e o que est sendo inserido no momento.
        --

        -- parametro da tabela CTA0008_PARAM_CC com tempo em segundos a somar na data atual
        -- para comparar com data de insero do ultimo registro.
        v_param_periodo_insert  VARCHAR2(10);

        -- sysdate + periodo determinado acima.
        -- para somar os segundos a data atual, usa-se a formula: sysdate + ( v_param_periodo_insert / 86400)
        v_dt_atual_periodo      DATE;

        -- data de ultimo registro inserido para determinado corretor.

        -- parametro com diferenca entre data atual e data de insercao do ultimo registro.
        v_dif_insert            NUMBER;
        --
        -- FIM OS 9866
        --

        v_data_ultima_verba_sucursal DATE;

        BEGIN

                BEGIN
                        SELECT  DS_PARAM_CC
                        INTO    v_param_periodo_insert
                        FROM    CTA0008_PARAM_CC
                        WHERE   NM_PARAM_CC = 'TEMPO_MAX_LACTO_DUPL';


                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'periodo aguardo para insert em segundos: ' || v_param_periodo_insert );

                EXCEPTION

                        -- caso nao tenha registro para o parametro
                        -- permite inserir registro, para nao atrapalhar funcionamento
                        -- do processo por causa de duplicidade.

                        WHEN    No_Data_Found THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nao encontrou parametro de tempo para insert: ' || v_param_periodo_insert );

                                RETURN TRUE;

                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar parametro de tempo para insert: ' || SQLERRM );

                                RETURN  TRUE;
                END;


                BEGIN

                        SELECT   Max(lacto.dt_lacto)--lacto.dt_ultma_alter
                        INTO     v_data_ultima_verba_sucursal
                        FROM     cta0004_lacto lacto
                        WHERE    lacto.id_verba = (
                                                        SELECT   Max(verba.id_verba)
                                                        FROM     cta0002_verba VERBA
                                                        WHERE    VERBA.CD_SUCSL_COMRL = p_id_sucursal
                                                )
                        AND     lacto.vl_lacto  =       p_vl_lacto
                        AND     lacto.cd_situc_lacto NOT IN ('CAN', 'EST');



                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Valor a verificar data de insercao: ' ||   p_vl_lacto  );

                        dbms_output.put_line('v_data_ultima_verba_sucursal ' || v_data_ultima_verba_sucursal);

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Dta de insercao: ' ||   v_data_ultima_verba_sucursal  );

                        v_dt_atual_periodo := v_data_ultima_verba_sucursal + (v_param_periodo_insert / 86400 );

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'data ultimo inser + periodo (segundos): ' || To_Char(v_dt_atual_periodo, 'DD/MM/RRRR HH24:MI:SS' ) );

                EXCEPTION

                        --      no_data_found neste caso indica que nao teve nenhum registro de verba anterior que
                        --      possa estar duplicado.

                        WHEN No_Data_Found THEN

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nenhum registro com valor igual ao procurado: ' || p_vl_lacto || ' libera inserir registro' );

                                RETURN TRUE;

                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar registro com base no corretor e valor de lancamento: ' || SQLERRM );

                                RETURN  TRUE;
                END;

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'sysdate: ' || To_Char(sysdate, 'DD/MM/RRRR HH24:MI:SS' ));

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'resultado v_dt_atual_periodo - sysdate se for > 0 erro senao deixa gravar = ' || (Trunc(((v_data_ultima_verba_sucursal - SYSDATE )* 100000), 0)) );

                IF    Trunc(((v_dt_atual_periodo - SYSDATE )* 100000), 0) > 0 THEN

                        --
                        p_cd_erro       :=      109;
                        p_msg_erro      :=      'Possivel registro duplicado, verificar.';
                        --

                                                        -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Registro encontrado dentro dos parametros estabelecidos valor: ' || p_vl_lacto || ' corretor: ' || p_id_sucursal );

                        RETURN FALSE;

                ELSE


                                -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Registro fora dos parametros, pode inserir novo registro. ' );


                        RETURN TRUE ;

                END IF;

                EXCEPTION
                WHEN OTHERS THEN
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Erro ao validar isRegistroValido. ' || SQLERRM );


        --
        END     IsRegistroValido;
        --

        --------------------------------------------------------------------------
        --      ValidaVerbaDiretoria:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaDiretoria   (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_dt_procs                     IN      DATE
                                                ,p_id_procs                     IN      NUMBER
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_diretoria  IS
                --
                SELECT  id_verba,
                        cd_asses,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_distribui_verba_dir_in.CdVerbaDiretoria
                FOR     UPDATE;

        --
        CURSOR  c_verba_sucursal   IS
                --
                SELECT  id_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_dir_in.CdVerbaDiretoria
                AND     CD_SUCSL_COMRL          =       p_distribui_verba_dir_in.CdSucursal
                FOR     UPDATE;
        --
        v_cd_erro                       NUMBER;
        v_msg_erro                      VARCHAR2(4000);
        --
        v_id_verba                      NUMBER;
        v_id_lacto                      NUMBER;
        v_id_lacto_vb                   NUMBER;
        v_count_verba                   NUMBER;

        v_cd_asses                      cta0012_crtor.cd_asses%TYPE;
        v_tp_pesoa                      cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur                cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor             cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_t_corretor                    ctactpa0100_001.t_corretor;
        --
        v_cd_sucsl                      NUMBER;
        v_cd_diret                      NUMBER;
        --
        v_tp_pesoa_asses                cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur_asses          cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor_asses       cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        v_dt_inico_vigen                DATE;
        v_dt_fim_vigen                  DATE;

        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  dt_inico_vigen,   dt_fim_vigen
                        INTO    v_dt_inico_vigen, v_dt_fim_vigen
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_distribui_verba_dir_in.CdVerbaDiretoria
;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_dt_inico_vigen        :=      NULL;
                                v_dt_fim_vigen          :=      NULL;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_dt_inico_vigen        IS      NULL    THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_distribui_verba_dir_in.CdVerbaDiretoria||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;

                --
                --      Verificando as informaes da verba encontrada.
                --
                FOR     r_verba_diretoria  IN      c_verba_diretoria  LOOP
                        --
                        --      Validando o saldo da verba da assessoria
                        --
                        IF      v_VlTransferencia       >       r_verba_diretoria.vl_saldo_verba   THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_diretoria.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'* Criando lanamento '||v_id_lacto||' para a verba '||r_verba_diretoria.id_verba);
                        --
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto
                                                                ,r_verba_diretoria.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_diretoria.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_diretoria.vl_saldo_verba  -       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Distrib. Diretoria: '||p_distribui_verba_dir_in.CdDiretoria, 1,      40)
                                                                ,null
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_id_procs
                                                                ,p_distribui_verba_dir_in.CdUsuario
                                                                ,SYSDATE
                                                                ,p_distribui_verba_dir_in.CdSucursal
                                                                ,p_distribui_verba_dir_in.CdDiretoria
                                                                ,null
                                                                ,'D'                    -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Diretoria] '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_dir_in.CdVerbaDiretoria
                                AND     CD_SUCSL_COMRL          =       p_distribui_verba_dir_in.CdSucursal;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Contador de verbas para a sucursal: '||p_distribui_verba_dir_in.CdSucursal||' Segmento '||p_cd_segmento||' Data '||p_dt_procs||' = '||v_count_verba);
                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Criando verba: '||v_id_verba || ' sucursal: ' || p_distribui_verba_dir_in.CdSucursal);
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba
                                                                        ,dt_ultma_alter)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,p_distribui_verba_dir_in.CdSucursal
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,v_VlTransferencia
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_dt_inico_vigen
                                                                        ,v_dt_fim_vigen
                                                                        ,r_verba_diretoria.id_verba
                                                                        ,p_distribui_verba_dir_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL
                                                                        ,SYSDATE);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'* Criando lanamento: '||v_id_lacto_vb);
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_asses_atual_crtor
                                                                        ,tp_desct_agrvo)
                                                                        --
                                                                VALUES  (v_id_lacto_vb
                                                                        ,v_id_verba
                                                                        ,'CRD'
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,'T'
                                                                        ,SYSDATE
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,0
                                                                        ,v_VlTransferencia
                                                                        ,v_id_lacto
                                                                        ,NULL
                                                                        ,v_tp_pesoa_asses
                                                                        ,SubStr('Distrib. Diretoria: '||p_distribui_verba_dir_in.CdDiretoria, 1,      40)
                                                                        ,null
                                                                        ,0
                                                                        ,0
                                                                        ,NULL
                                                                        ,p_id_procs
                                                                        ,p_distribui_verba_dir_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,p_distribui_verba_dir_in.CdSucursal
                                                                        ,p_distribui_verba_dir_in.CdDiretoria
                                                                        ,null
                                                                        ,'A'            -- tp_desct_agrvo
                                                                        );

                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Diretoria] '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSE
                                --
                                FOR     r_verba_crtor   IN      c_verba_sucursal   LOOP
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'* [1] Criando lanamento: '||v_id_lacto_vb || ' Verba :' || r_verba_crtor.id_verba);
                                        --
                                        BEGIN
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,cd_asses_atual_crtor
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb          -- id_lacto
                                                                                ,r_verba_crtor.id_verba -- id_verba
                                                                                ,'CRD'                  -- cd_situc_lacto
                                                                                ,NULL                   -- cd_ctrat
                                                                                ,NULL                   -- cd_item_ctrat
                                                                                ,'T'                    -- cd_tipo_lacto
                                                                                ,SYSDATE                -- dt_lacto
                                                                                ,r_verba_crtor.vl_saldo_verba   -- vl_saldo_verba_anter
                                                                                ,v_VlTransferencia              -- vl_lacto
                                                                                ,0                              -- vl_agrvo_ppota
                                                                                ,r_verba_crtor.vl_saldo_verba   +       v_VlTransferencia
                                                                                ,v_id_lacto
                                                                                ,NULL
                                                                                ,v_tp_pesoa_asses
                                                                                ,SubStr('Distrib. Diretoria: '||p_distribui_verba_dir_in.CdDiretoria, 1,      40)
                                                                                ,null
                                                                                ,0
                                                                                ,0
                                                                                ,NULL
                                                                                ,p_id_procs
                                                                                ,p_distribui_verba_dir_in.CdUsuario
                                                                                ,SYSDATE
                                                                                ,v_t_corretor.cd_sucsl_comrl
                                                                                ,v_t_corretor.cd_diret_comrl
                                                                                ,null
                                                                                ,'A'            -- tp_desct_agrvo
                                                                                );
                                                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Assessoria 2] '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[2] Atualizando verba: '||r_verba_diretoria.id_verba||' '||v_VlTransferencia);
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_inicl_verba          =       vl_inicl_verba  +       v_VlTransferencia,
                                                        vl_saldo_verba          =       vl_saldo_verba  +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_distribui_verba_dir_in.CdUsuario
                                                WHERE   id_verba                =       r_verba_crtor.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[3] Atualizando verba: '||r_verba_diretoria.id_verba||' '||v_VlTransferencia);
                                --
                                UPDATE  cta0002_verba
                                SET     vl_eftdo_verba          =       Nvl(vl_eftdo_verba,0)   +       v_VlTransferencia,
                                        vl_saldo_verba          =       vl_saldo_verba          -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_distribui_verba_dir_in.CdUsuario
                                WHERE   id_verba                =       r_verba_diretoria.id_verba;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto_vb;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'v_id_lacto_vb: '||v_id_lacto_vb||' p_id_lacto: '||p_id_lacto);
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      86;
                        p_msg_erro      :=      'Erro ValidaVerbaAssessoria: '||SQLERRM;
                        --
        END     ValidaVerbaDiretoria;

        --
        --------------------------------------------------------------------------
        --      Distribui_Verba_Diretoria:     Distribuir as verbas de uma     --
        --                                      assessoria para os corretores   --
        --                                      vinculados  assessoria, ou     --
        --                                      devolver a verba de um corretor --
        --                                      para a assessoria.              --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Distribui_Verba_Diretoria      (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                        ,p_distribui_verba_dir_out OUT     distribui_verba_diretoria_out) IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_id_procs              NUMBER;

        --
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_distribui_verba_dir_out  :=      distribui_verba_diretoria_out  (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_distribui_verba_dir_in.VlTransferencia,    2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (201
                                                ,p_distribui_verba_dir_in.SistemaChamador
                                                ,p_distribui_verba_dir_in.CdDiretoria
                                                ,p_distribui_verba_dir_in.CdSucursal
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_distribui_verba_dir_in.CdUsuario
                                                ,p_distribui_verba_dir_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                                                     ||Chr(10)||
                                                'Servio Distribui_Verba_Assessoria. Parmetros de entrada: '                                                      ||Chr(10)||
                                                ' SistemaChamador....... '||p_distribui_verba_dir_in.SistemaChamador       ||Chr(10)||
                                                ' CdSegmento............ '||p_distribui_verba_dir_in.CdSegmento            ||Chr(10)||
                                                ' TpTransacao........... '||p_distribui_verba_dir_in.TpTransacao           ||Chr(10)||
                                                ' CdSucursal............ '||p_distribui_verba_dir_in.CdSucursal            ||Chr(10)||
                                                ' CdDiretoria........... '||p_distribui_verba_dir_in.CdDiretoria           ||Chr(10)||
                                                ' VlTransferencia....... '||p_distribui_verba_dir_in.VlTransferencia       ||Chr(10)||
                                                ' v_VlTransferencia..... '||v_VlTransferencia                              ||Chr(10)||
                                                ' CdVerbaDiretoria...... '||p_distribui_verba_dir_in.CdVerbaDiretoria      ||Chr(10)||
                                                ' CdUsuario............. '||p_distribui_verba_dir_in.CdUsuario             ||Chr(10)||
                                                ' CdProcesso............ '||p_distribui_verba_dir_in.CdProcesso            ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')   ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --

                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_distribui_verba_dir_in.SistemaChamador))      THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      2;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Sistema chamador invlido: '||p_distribui_verba_dir_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de transao
                --
                IF      Nvl(p_distribui_verba_dir_in.TpTransacao,  'X')    NOT     IN      ('T',   'D')    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      79;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Tipo de transao invlido: '||p_distribui_verba_dir_in.TpTransacao;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria
                --
                IF      p_distribui_verba_dir_in.CdSucursal      IS      NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      57;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Cdigo de sucursal est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL      OR      v_VlTransferencia       <=      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      58;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o cdigo de verba da assessoria
                --
                IF      p_distribui_verba_dir_in.CdVerbaDiretoria IS      NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      81;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Cdigo de verba da diretoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_distribui_verba_dir_in.CdUsuario   IS      NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      10;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_distribui_verba_dir_in.CdProcesso,     0)      NOT     IN    (26,    27)     THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      11;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Cdigo de processo invlido: '||p_distribui_verba_dir_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_distribui_verba_dir_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs      :=      CTACTPA0100_001.ValidaCdProcesso        (p_distribui_verba_dir_in.CdProcesso
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --

                --
                --

                --      Valida registro anterior
                --      OS 9866


                IF      NOT(IsRegistroValido            (p_distribui_verba_dir_in.CdSucursal
                                                        ,p_distribui_verba_dir_in.VlTransferencia
                                                        ,v_cd_erro
                                                        ,v_msg_erro))   THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log    ,v_cd_erro);
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria - Registro vlido - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;

                --      FIM OS 9866
                --

                --      Validando a verba da assessoria
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_dir_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_dir_out.IdLancamento);
                --
                ValidaVerbaDiretoria   (p_distribui_verba_dir_in
                                        ,p_distribui_verba_dir_in.CdSegmento
                                        ,v_dt_procm
                                        ,v_id_procs
                                        ,p_distribui_verba_dir_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_dir_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_dir_out.IdLancamento);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                COMMIT;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'StRetorno: '||p_distribui_verba_dir_out.StRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'MsgRetorno: '||p_distribui_verba_dir_out.MsgRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'IdLancamento: '||p_distribui_verba_dir_out.IdLancamento     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_distribui_verba_dir_out.StRetorno||' - Mensagem: '||p_distribui_verba_dir_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Distribui_Verba_Assessoria: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      1;
                        p_distribui_verba_dir_out.MsgRetorno       :=      'Erro Distribui_Verba_Assessoria: '||SQLERRM;
                        --

        END     Distribui_Verba_Diretoria;
        --



END     CTACTPA0020_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0021_001 IS
        --
        v_VlTransferencia       NUMBER(15,2);
        v_sq_log                NUMBER;


        --
        --------------------------------------------------------------------------
        --      IsRegistroValido:       Verifica se registro nao esta em dupli  --
        --                              cidade com anterior                     --
        --      RETORNA TRUE SE REGISTRO PODE SER INSERIDO                      --
        --      RETORNA FALSE SE REGISTRO E POSSIVEL DUPLICIDADE                --
        --------------------------------------------------------------------------
        --

        FUNCTION        IsRegistroValido        (p_id_sucursal  IN      NUMBER
                                                ,p_vl_lacto     IN      NUMBER
                                                ,p_cd_erro      OUT     NUMBER
                                                ,p_msg_erro     OUT     VARCHAR2)
        RETURN  BOOLEAN IS

        --
        -- OS 9866
        -- para nao termos mais duplicidade no momento da distribuicao de verba,
        -- sera verificado diferenca de tempo entre ultimo
        -- registro inserido e o que est sendo inserido no momento.
        --

        -- parametro da tabela CTA0008_PARAM_CC com tempo em segundos a somar na data atual
        -- para comparar com data de insero do ultimo registro.
        v_param_periodo_insert  VARCHAR2(10);

        -- sysdate + periodo determinado acima.
        -- para somar os segundos a data atual, usa-se a formula: sysdate + ( v_param_periodo_insert / 86400)
        v_dt_atual_periodo      DATE;

        -- data de ultimo registro inserido para determinado corretor.

        -- parametro com diferenca entre data atual e data de insercao do ultimo registro.
        v_dif_insert            NUMBER;
        --
        -- FIM OS 9866
        --

        v_data_ultima_verba_sucursal DATE;

        BEGIN

                BEGIN
                        SELECT  DS_PARAM_CC
                        INTO    v_param_periodo_insert
                        FROM    CTA0008_PARAM_CC
                        WHERE   NM_PARAM_CC = 'TEMPO_MAX_LACTO_DUPL';


                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'periodo aguardo para insert em segundos: ' || v_param_periodo_insert );

                EXCEPTION

                        -- caso nao tenha registro para o parametro
                        -- permite inserir registro, para nao atrapalhar funcionamento
                        -- do processo por causa de duplicidade.

                        WHEN    No_Data_Found THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nao encontrou parametro de tempo para insert: ' || v_param_periodo_insert );

                                RETURN TRUE;

                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar parametro de tempo para insert: ' || SQLERRM );

                                RETURN  TRUE;
                END;


                BEGIN

                        SELECT   Max(lacto.dt_lacto)--lacto.dt_ultma_alter
                        INTO     v_data_ultima_verba_sucursal
                        FROM     cta0004_lacto lacto
                        WHERE    lacto.id_verba = (
                                                        SELECT   Max(verba.id_verba)
                                                        FROM     cta0002_verba VERBA
                                                        WHERE    VERBA.CD_SUCSL_COMRL = p_id_sucursal
                                                )
                        AND     lacto.vl_lacto  =       p_vl_lacto
                        AND     lacto.cd_situc_lacto NOT IN ('CAN', 'EST');



                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Valor a verificar data de insercao: ' ||   p_vl_lacto  );

                        dbms_output.put_line('v_data_ultima_verba_sucursal ' || v_data_ultima_verba_sucursal);

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Dta de insercao: ' ||   v_data_ultima_verba_sucursal  );

                        v_dt_atual_periodo := v_data_ultima_verba_sucursal + (v_param_periodo_insert / 86400 );

                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'data ultimo inser + periodo (segundos): ' || To_Char(v_dt_atual_periodo, 'DD/MM/RRRR HH24:MI:SS' ) );

                EXCEPTION

                        --      no_data_found neste caso indica que nao teve nenhum registro de verba anterior que
                        --      possa estar duplicado.

                        WHEN No_Data_Found THEN

                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Nenhum registro com valor igual ao procurado: ' || p_vl_lacto || ' libera inserir registro' );

                                RETURN TRUE;

                        --
                        WHEN    OTHERS  THEN
                                --
                                p_cd_erro       :=      1;
                                p_msg_erro      :=      'Erro IsRegistroValido: '||SQLERRM;
                                --
                                -- nao para o processo por este motivo
                                CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Erro ao buscar registro com base no corretor e valor de lancamento: ' || SQLERRM );

                                RETURN  TRUE;
                END;

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'sysdate: ' || To_Char(sysdate, 'DD/MM/RRRR HH24:MI:SS' ));

                CTACTPA0100_001.GravaLog        (v_sq_log,
                        'resultado v_dt_atual_periodo - sysdate se for > 0 erro senao deixa gravar = ' || (Trunc(((v_data_ultima_verba_sucursal - SYSDATE )* 100000), 0)) );

                IF    Trunc(((v_dt_atual_periodo - SYSDATE )* 100000), 0) > 0 THEN

                        --
                        --p_cd_erro       :=      109;                                          // COMENTADO A PEDIDO DE EDMILSON, SERVIA PARA RETORNAR UM ERRO DE UMA POSSIVEL DUPLICIDADE DE CHAMADA
                        --p_msg_erro      :=      'Possivel registro duplicado, verificar.';    // COMENTADO A PEDIDO DE EDMILSON, SERVIA PARA RETORNAR UM ERRO DE UMA POSSIVEL DUPLICIDADE DE CHAMADA
                        --
                        -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                        'Registro encontrado dentro dos parametros estabelecidos valor: ' || p_vl_lacto || ' corretor: ' || p_id_sucursal );

                        --RETURN FALSE;                                                         // COMENTADO A PEDIDO DE EDMILSON, SERVIA PARA RETORNAR UM ERRO DE UMA POSSIVEL DUPLICIDADE DE CHAMADA
                        --
                        RETURN TRUE;
                        --
                ELSE


                                -- nao para o processo por este motivo
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Registro fora dos parametros, pode inserir novo registro. ' );


                        RETURN TRUE ;

                END IF;

                EXCEPTION
                WHEN OTHERS THEN
                        CTACTPA0100_001.GravaLog        (v_sq_log,
                                'Erro ao validar isRegistroValido. ' || SQLERRM );


        --
        END     IsRegistroValido;
        --

        --------------------------------------------------------------------------
        --      ValidaVerbaDiretoria:
        --------------------------------------------------------------------------
        --
        PROCEDURE       ValidaVerbaDiretoria   (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                ,p_cd_segmento                  IN      NUMBER
                                                ,p_dt_procs                     IN      DATE
                                                ,p_id_procs                     IN      NUMBER
                                                ,p_id_lacto                     OUT     NUMBER
                                                ,p_cd_erro                      OUT     NUMBER
                                                ,p_msg_erro                     OUT     VARCHAR2)       IS
        --
        CURSOR  c_verba_diretoria  IS
                --
                SELECT  id_verba,
                        cd_asses,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba        =       p_distribui_verba_dir_in.CdVerbaDiretoria
                FOR     UPDATE;

        --
        CURSOR  c_verba_sucursal   IS
                --
                SELECT  id_verba,
                        vl_saldo_verba
                FROM    cta0002_verba
                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_dir_in.CdVerbaDiretoria
                AND     cd_asses                =       Nvl(p_distribui_verba_dir_in.CdAssessoria ,cd_asses)
                AND     cd_crtor_segur          =       Nvl(p_distribui_verba_dir_in.CdCorretor   , cd_crtor_segur)
                FOR     UPDATE;
        --
        v_cd_erro                       NUMBER;
        v_msg_erro                      VARCHAR2(4000);
        --
        v_id_verba                      NUMBER;
        v_id_lacto                      NUMBER;
        v_id_lacto_vb                   NUMBER;
        v_count_verba                   NUMBER;

        v_cd_asses                      cta0012_crtor.cd_asses%TYPE;
        v_tp_pesoa                      cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur                cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor             cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        --
        v_t_corretor                    ctactpa0100_001.t_corretor;
        --
        v_cd_sucsl                      NUMBER;
        v_cd_diret                      NUMBER;
        --
        v_tp_pesoa_asses                cta0012_crtor.tp_pesoa%TYPE;
        v_nm_crtor_segur_asses          cta0012_crtor.nm_crtor_segur%TYPE;
        v_nr_cpf_cnpj_crtor_asses       cta0012_crtor.nr_cpf_cnpj_crtor%TYPE;
        v_dt_inico_vigen                DATE;
        v_dt_fim_vigen                  DATE;

        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  dt_inico_vigen,   dt_fim_vigen
                        INTO    v_dt_inico_vigen, v_dt_fim_vigen
                        FROM    cta0002_verba
                        WHERE   id_verba        =       p_distribui_verba_dir_in.CdVerbaDiretoria
;
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_dt_inico_vigen        :=      NULL;
                                v_dt_fim_vigen          :=      NULL;
                                --
                END;
                --
                --      Se no encontrar a verba, abortar o programa.
                --
                IF      v_dt_inico_vigen        IS      NULL    THEN
                        --
                        p_cd_erro       :=      82;
                        p_msg_erro      :=      'Verba: '||p_distribui_verba_dir_in.CdVerbaDiretoria||' no encontrada';
                        --
                        RETURN;
                        --
                END     IF;

                --
                --      Verificando as informaes da verba encontrada.
                --
                FOR     r_verba_diretoria  IN      c_verba_diretoria  LOOP
                        --
                        --      Validando o saldo da verba da assessoria
                        --
                        IF      v_VlTransferencia       >       r_verba_diretoria.vl_saldo_verba   THEN
                                --
                                p_cd_erro       :=      84;
                                p_msg_erro      :=      'Valor da verba cadastrado: '||r_verba_diretoria.vl_saldo_verba||' diferente do enviado para o servio: '||v_VlTransferencia;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                        --      Criar lanamento de transferncia [Dbito]
                        --
                        BEGIN
                                --
                                SELECT  ctasq0004_lacto.NEXTVAL
                                INTO    v_id_lacto
                                FROM    dual;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'* Criando lanamento '||v_id_lacto||' para a verba '||r_verba_diretoria.id_verba);
                        --
                        --
                        BEGIN
                                --
                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (ctasq0004_lacto.NEXTVAL
                                                                ,r_verba_diretoria.id_verba
                                                                ,'DBT'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_diretoria.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_diretoria.vl_saldo_verba  -       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Distrib. Sucursal: '||p_distribui_verba_dir_in.CdSucursal, 1,      40)
                                                                ,null
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_id_procs
                                                                ,p_distribui_verba_dir_in.CdUsuario
                                                                ,SYSDATE
                                                                ,null
                                                                ,null
                                                                ,null
                                                                ,'D'                    -- tp_desct_agrvo
                                                                );
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      41;
                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Diretoria] '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --
                        --
                        BEGIN
                                --
                                SELECT  Count(1)
                                INTO    v_count_verba
                                FROM    cta0002_verba
                                WHERE   id_verba_origm_trnsf    =       p_distribui_verba_dir_in.CdVerbaDiretoria
                                AND     cd_crtor_segur          =       Nvl(p_distribui_verba_dir_in.CdCorretor,cd_crtor_segur)
                                AND     cd_asses                =       Nvl(p_distribui_verba_dir_in.CdAssessoria,cd_asses);
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        v_count_verba   :=      1;
                                        --
                        END;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Contador de verbas para a sucursal: '||p_distribui_verba_dir_in.CdSucursal||' Segmento '||p_cd_segmento||' Data '||p_dt_procs||' = '||v_count_verba);
                        --
                        IF      v_count_verba   =       0       THEN
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0002_verba.NEXTVAL
                                        INTO    v_id_verba
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao recuperar sequencia ctasq0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criando verba
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Criando verba: '||v_id_verba || ' sucursal: ' || p_distribui_verba_dir_in.CdSucursal);
                                --
                                BEGIN
                                        --
                                        INSERT  INTO    cta0002_verba   (id_verba
                                                                        ,cd_segmt_prdut
                                                                        ,cd_crtor_segur
                                                                        ,cd_asses
                                                                        ,cd_tipo_verba
                                                                        ,vl_inicl_verba
                                                                        ,vl_prvsn_verba
                                                                        ,vl_eftdo_verba
                                                                        ,vl_crdto_verba
                                                                        ,vl_saldo_verba
                                                                        ,dt_inico_vigen
                                                                        ,dt_fim_vigen
                                                                        ,id_verba_origm_trnsf
                                                                        ,cd_usuro_ultma_alter
                                                                        ,cd_situc_verba
                                                                        ,id_arquv_carga_verba
                                                                        ,dt_ultma_alter)
                                                                        --
                                                                VALUES  (v_id_verba
                                                                        ,p_cd_segmento
                                                                        ,p_distribui_verba_dir_in.CdCorretor
                                                                        ,p_distribui_verba_dir_in.CdAssessoria
                                                                        ,'T'
                                                                        ,v_VlTransferencia
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,v_VlTransferencia
                                                                        ,v_dt_inico_vigen
                                                                        ,v_dt_fim_vigen
                                                                        ,r_verba_diretoria.id_verba
                                                                        ,p_distribui_verba_dir_in.CdUsuario
                                                                        ,'ATI'
                                                                        ,NULL
                                                                        ,SYSDATE);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      78;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0002_verba: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Criar lanamento de transferncia
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto_vb
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'* Criando lanamento: '||v_id_lacto_vb);
                                --
                                BEGIN

                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                ,id_verba
                                                                ,cd_situc_lacto
                                                                ,cd_ctrat
                                                                ,cd_item_ctrat
                                                                ,cd_tipo_lacto
                                                                ,dt_lacto
                                                                ,vl_saldo_verba_anter
                                                                ,vl_lacto
                                                                ,vl_agrvo_ppota
                                                                ,vl_saldo_verba_postr
                                                                ,id_lacto_origm_trnsf
                                                                ,id_lacto_estor
                                                                ,tp_pesoa
                                                                ,nm_clien_sgrdo
                                                                ,nr_cpf_cnpj_clien
                                                                ,vl_prmio_liqui_ppota
                                                                ,pc_comis_crtor
                                                                ,dt_inico_vigen_segur
                                                                ,id_procs_criac
                                                                ,cd_usuro_criac
                                                                ,dt_criac
                                                                ,cd_sucsl_comrl
                                                                ,cd_diret_comrl
                                                                ,cd_asses_atual_crtor
                                                                ,tp_desct_agrvo)
                                                                --
                                                        VALUES  (v_id_lacto_vb
                                                                ,v_id_verba
                                                                ,'CRD'
                                                                ,NULL
                                                                ,NULL
                                                                ,'T'
                                                                ,SYSDATE
                                                                ,r_verba_diretoria.vl_saldo_verba
                                                                ,v_VlTransferencia
                                                                ,0
                                                                ,r_verba_diretoria.vl_saldo_verba  +       v_VlTransferencia
                                                                ,NULL
                                                                ,NULL
                                                                ,v_tp_pesoa
                                                                ,SubStr('Distrib. Sucursal: '||p_distribui_verba_dir_in.CdSucursal, 1,      40)
                                                                ,null
                                                                ,0
                                                                ,0
                                                                ,NULL
                                                                ,p_id_procs
                                                                ,p_distribui_verba_dir_in.CdUsuario
                                                                ,SYSDATE
                                                                ,null
                                                                ,null
                                                                ,null
                                                                ,'A'                    -- tp_desct_agrvo
                                                                );


                                        --

                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      41;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Assessoria / Corretor] '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSE
                                --
                                FOR     r_verba_crtor   IN      c_verba_sucursal   LOOP
                                        --
                                        BEGIN
                                                --
                                                SELECT  ctasq0004_lacto.NEXTVAL
                                                INTO    v_id_lacto_vb
                                                FROM    dual;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao selecionar sequncia ctasq0004_lacto: '||SQLERRM;                                        --
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'* [1] Criando lanamento: '||v_id_lacto_vb || ' Verba :' || r_verba_crtor.id_verba);
                                        --
                                        BEGIN
                                                --
                                                INSERT  INTO    cta0004_lacto   (id_lacto
                                                                                ,id_verba
                                                                                ,cd_situc_lacto
                                                                                ,cd_ctrat
                                                                                ,cd_item_ctrat
                                                                                ,cd_tipo_lacto
                                                                                ,dt_lacto
                                                                                ,vl_saldo_verba_anter
                                                                                ,vl_lacto
                                                                                ,vl_agrvo_ppota
                                                                                ,vl_saldo_verba_postr
                                                                                ,id_lacto_origm_trnsf
                                                                                ,id_lacto_estor
                                                                                ,tp_pesoa
                                                                                ,nm_clien_sgrdo
                                                                                ,nr_cpf_cnpj_clien
                                                                                ,vl_prmio_liqui_ppota
                                                                                ,pc_comis_crtor
                                                                                ,dt_inico_vigen_segur
                                                                                ,id_procs_criac
                                                                                ,cd_usuro_criac
                                                                                ,dt_criac
                                                                                ,cd_sucsl_comrl
                                                                                ,cd_diret_comrl
                                                                                ,cd_asses_atual_crtor
                                                                                ,tp_desct_agrvo)
                                                                                --
                                                                        VALUES  (v_id_lacto_vb          -- id_lacto
                                                                                ,r_verba_crtor.id_verba -- id_verba
                                                                                ,'CRD'                  -- cd_situc_lacto
                                                                                ,NULL                   -- cd_ctrat
                                                                                ,NULL                   -- cd_item_ctrat
                                                                                ,'T'                    -- cd_tipo_lacto
                                                                                ,SYSDATE                -- dt_lacto
                                                                                ,r_verba_crtor.vl_saldo_verba   -- vl_saldo_verba_anter
                                                                                ,v_VlTransferencia              -- vl_lacto
                                                                                ,0                              -- vl_agrvo_ppota
                                                                                ,r_verba_crtor.vl_saldo_verba   +       v_VlTransferencia
                                                                                ,v_id_lacto
                                                                                ,NULL
                                                                                ,v_tp_pesoa_asses
                                                                                ,SubStr('Distrib. Sucursal: '||p_distribui_verba_dir_in.CdSucursal, 1,      40)
                                                                                ,null
                                                                                ,0
                                                                                ,0
                                                                                ,NULL
                                                                                ,p_id_procs
                                                                                ,p_distribui_verba_dir_in.CdUsuario
                                                                                ,SYSDATE
                                                                                ,null
                                                                                ,null
                                                                                ,null
                                                                                ,'A'            -- tp_desct_agrvo
                                                                                );
                                                                                --




                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      41;
                                                        p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: [Assessoria 2] '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                        --      Atualizar verba
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                                        ,'[2] Atualizando verba: '||r_verba_diretoria.id_verba||' '||v_VlTransferencia);
                                        --
                                        BEGIN
                                                --
                                                UPDATE  cta0002_verba
                                                SET     vl_inicl_verba          =       vl_inicl_verba  +       v_VlTransferencia,
                                                        vl_saldo_verba          =       vl_saldo_verba  +       v_VlTransferencia,
                                                        cd_usuro_ultma_alter    =       p_distribui_verba_dir_in.CdUsuario
                                                WHERE   id_verba                =       r_verba_crtor.id_verba;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        p_cd_erro       :=      88;
                                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                                        --
                                                        RETURN;
                                                        --
                                        END;
                                        --
                                END     LOOP;
                                --
                        END     IF;
                        --
                        --      Atualizar verba [Dbito]
                        --
                        BEGIN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[3] Atualizando verba: '||r_verba_diretoria.id_verba||' '||v_VlTransferencia);
                                --
                                UPDATE  cta0002_verba
                                SET     vl_eftdo_verba          =       Nvl(vl_eftdo_verba,0)   +       v_VlTransferencia,
                                        vl_saldo_verba          =       vl_saldo_verba          -       v_VlTransferencia,
                                        cd_usuro_ultma_alter    =       p_distribui_verba_dir_in.CdUsuario
                                WHERE   id_verba                =       r_verba_diretoria.id_verba;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      88;
                                        p_msg_erro      :=      'Erro ao atualizar tabela cta0002_verba: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        p_id_lacto      :=      v_id_lacto_vb;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'v_id_lacto_vb: '||v_id_lacto_vb||' p_id_lacto: '||p_id_lacto);
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      86;
                        p_msg_erro      :=      'Erro ValidaVerbaAssessoria: '||SQLERRM;
                        --
        END     ValidaVerbaDiretoria;

        --
        --------------------------------------------------------------------------
        --      Distribui_Verba_Diretoria:     Distribuir as verbas de uma     --
        --                                      assessoria para os corretores   --
        --                                      vinculados  assessoria, ou     --
        --                                      devolver a verba de um corretor --
        --                                      para a assessoria.              --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Distribui_Verba_Assessoria      (p_distribui_verba_dir_in  IN      distribui_verba_diretoria_in
                                                        ,p_distribui_verba_dir_out OUT     distribui_verba_diretoria_out) IS
        --
        v_dt_procm              DATE;
        v_cd_erro               NUMBER;
        v_id_procs              NUMBER;

        --
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_distribui_verba_dir_out  :=      distribui_verba_diretoria_out  (0
                                                                                        ,NULL
                                                                                        ,NULL);
                --
                v_VlTransferencia       :=      Round(p_distribui_verba_dir_in.VlTransferencia,    2);
                --
                --      Verificando se deve debugar o item / cpf
                --
                CTACTPA0100_001.IniciaLog       (211
                                                ,p_distribui_verba_dir_in.SistemaChamador
                                                ,p_distribui_verba_dir_in.CdDiretoria
                                                ,p_distribui_verba_dir_in.CdSucursal
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,NULL
                                                ,p_distribui_verba_dir_in.CdUsuario
                                                ,p_distribui_verba_dir_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                LPad('=',      80,     '=')                                                                                     ||Chr(10)||
                                                'Servio Distribui_Verba_Assessoria. Parmetros de entrada: '                                                      ||Chr(10)||
                                                ' SistemaChamador....... '||p_distribui_verba_dir_in.SistemaChamador       ||Chr(10)||
                                                ' CdSegmento............ '||p_distribui_verba_dir_in.CdSegmento            ||Chr(10)||
                                                ' TpTransacao........... '||p_distribui_verba_dir_in.TpTransacao           ||Chr(10)||
                                                ' CdAssessoria.......... '||p_distribui_verba_dir_in.CdAssessoria          ||Chr(10)||
                                                ' CdVerbaDiretoria...... '||p_distribui_verba_dir_in.CdVerbaDiretoria   ||Chr(10)||
                                                ' CdCorretor............ '||p_distribui_verba_dir_in.CdCorretor            ||Chr(10)||
                                                ' VlTransferencia....... '||p_distribui_verba_dir_in.VlTransferencia       ||Chr(10)||
                                                ' v_VlTransferencia..... '||v_VlTransferencia                                   ||Chr(10)||
                                                ' CdUsuario............. '||p_distribui_verba_dir_in.CdUsuario             ||Chr(10)||
                                                ' CdProcesso............ '||p_distribui_verba_dir_in.CdProcesso            ||Chr(10)||
                                                ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')        ||Chr(10)||
                                                LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --

                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_distribui_verba_dir_in.SistemaChamador))      THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      2;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Sistema chamador invlido: '||p_distribui_verba_dir_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de transao
                --
                IF      Nvl(p_distribui_verba_dir_in.TpTransacao,  'X')    NOT     IN      ('T',   'D')    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      79;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Assessoria / Corretor] - Tipo de transao invlido: '||p_distribui_verba_dir_in.TpTransacao;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando a assessoria
                --
                IF      p_distribui_verba_dir_in.CdCorretor      IS      NULL AND p_distribui_verba_dir_in.CdAssessoria IS NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      57;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Assessoria / Corretor] - Cdigo de assessoria ou corretor deve ser informado';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor do crdito
                --
                IF      v_VlTransferencia       IS      NULL      OR      v_VlTransferencia       <=      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      58;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Valor do crdito invlido: '||v_VlTransferencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o cdigo de verba da assessoria
                --
                IF      p_distribui_verba_dir_in.CdVerbaDiretoria IS      NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      81;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Cdigo de verba da diretoria est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_distribui_verba_dir_in.CdUsuario   IS      NULL    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      10;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_distribui_verba_dir_in.CdProcesso,     0)      NOT     IN    (26,    27)     THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      11;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - Cdigo de processo invlido: '||p_distribui_verba_dir_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] '||v_dt_procm);
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Assessoria / Corretor] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida segmento do produto
                --
                IF      NOT(CTACTPA0100_001.IsSegmentoValido    (p_distribui_verba_dir_in.CdSegmento
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs      :=      CTACTPA0100_001.ValidaCdProcesso        (p_distribui_verba_dir_in.CdProcesso
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --

                --
                --

                --      Valida registro anterior
                --      OS 9866


                IF      NOT(IsRegistroValido            (p_distribui_verba_dir_in.CdSucursal
                                                        ,p_distribui_verba_dir_in.VlTransferencia
                                                        ,v_cd_erro
                                                        ,v_msg_erro))   THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log    ,v_cd_erro);
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Diretoria - Registro vlido - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;

                --      FIM OS 9866
                --

                --      Validando a verba da assessoria
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_dir_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_dir_out.IdLancamento);
                --
                ValidaVerbaDiretoria   (p_distribui_verba_dir_in
                                        ,p_distribui_verba_dir_in.CdSegmento
                                        ,v_dt_procm
                                        ,v_id_procs
                                        ,p_distribui_verba_dir_out.IdLancamento
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaVerbaAssessoria] - Segmento: '||p_distribui_verba_dir_in.CdSegmento||' Data Processamento: '||v_dt_procm||' Lanamento: '||p_distribui_verba_dir_out.IdLancamento);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      v_cd_erro;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[Distribui Verba Assessoria] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                COMMIT;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'StRetorno: '||p_distribui_verba_dir_out.StRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'MsgRetorno: '||p_distribui_verba_dir_out.MsgRetorno     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'IdLancamento: '||p_distribui_verba_dir_out.IdLancamento     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    erro_fatal      THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_distribui_verba_dir_out.StRetorno||' - Mensagem: '||p_distribui_verba_dir_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        RETURN;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Distribui_Verba_Assessoria: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                        'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                        LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_distribui_verba_dir_out.StRetorno        :=      1;
                        p_distribui_verba_dir_out.MsgRetorno       :=      '[ValidaVerbaAssessoria] ' || '[' || v_sq_log || ']' ||' - Erro Distribui_Verba_Assessoria: '||SQLERRM;
                        --

        END     Distribui_Verba_Assessoria;
        --



END     CTACTPA0021_001;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0022_001 IS
        --
        v_VlAgravoDesconto      NUMBER(15,2);
        v_VlPremioLiquido       NUMBER(15,2);
        v_sq_log                NUMBER;
        --
        --------------------------------------------------------------------------
        --      VerificaProvisaoItem:   Verifica se j existe proviso para o   --
        --                              item / negcio.                         --
        --                              Valida tambm se as informaes da      --
        --                              efetivao so iguais s do             --
        --                              provisionamento.                        --
        --------------------------------------------------------------------------
        --
        PROCEDURE       VerificaProvisaoItem    (p_efetiva_primeira_parcela_in  IN      efetiva_primeira_parcela_in
                                                ,p_dt_inico_vigen       IN      DATE
                                                ,p_id_prdut             IN      NUMBER
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        v_vl_lacto              cta0004_lacto.vl_lacto%TYPE;
        v_vl_agrvo_ppota        cta0004_lacto.vl_agrvo_ppota%TYPE;
        --
        CURSOR  c_provisao_item IS
                --
                SELECT  a.tp_pesoa,
                        a.nm_clien_sgrdo,
                        a.nr_cpf_cnpj_clien,
                        a.vl_prmio_liqui_ppota,
                        a.pc_comis_crtor,
                        a.dt_inico_vigen_segur,
                        a.id_prdut_sistm_origm,
                        a.tp_desct_agrvo,
                        a.id_corrl_bus
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_primeira_parcela_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_primeira_parcela_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_primeira_parcela_in.CdCorretor;
        --
        BEGIN
                --
                p_cd_erro       :=      0;
                p_msg_erro      :=      NULL;
                --
                --      Verifica se a soma existe proviso para o item
                --
                SELECT  Nvl(Sum(a.vl_lacto),0),
                        Nvl(Sum(a.vl_agrvo_ppota),0)
                INTO    v_vl_lacto,
                        v_vl_agrvo_ppota
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_primeira_parcela_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_primeira_parcela_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_primeira_parcela_in.CdCorretor;
                --
                --      Se no encontrar a proviso, o programa chamador deve
                --      abortar o processo
                --
                IF      v_vl_lacto      =       0       THEN
                        --
                        p_cd_erro       :=      42;
                        p_msg_erro      :=      'No existe proviso para o item: '||p_efetiva_primeira_parcela_in.CdItemContrato||' e negcio: '||p_efetiva_primeira_parcela_in.CdContrato;
                        --
                        RETURN;
                        --
                ELSE
                        --
                        IF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'D'     THEN
                                --

                                CTACTPA0100_001.GravaLog        (v_sq_log, 'Tipo Agravo / Desconto : D ');

                                 CTACTPA0100_001.GravaLog        (v_sq_log, '[v_vl_lacto] ' || v_vl_lacto);
                                 CTACTPA0100_001.GravaLog        (v_sq_log, '[v_VlAgravoDesconto] ' || v_VlAgravoDesconto);


                                IF      ( v_vl_lacto      <>      v_VlAgravoDesconto  )  THEN
                                        --
                                        p_cd_erro       :=      43;
                                        p_msg_erro      :=      'Informao de valor do lanamento: '||v_VlAgravoDesconto||' divergente do valor provisionado: '||v_vl_lacto;
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        ELSIF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'A'     THEN

                                CTACTPA0100_001.GravaLog        (v_sq_log, 'Tipo Agravo / Desconto : A ');

                                --
                                IF      ( v_vl_agrvo_ppota        <>      v_VlAgravoDesconto )    THEN



                                        --
                                        p_cd_erro       :=      43;
                                        p_msg_erro      :=      'Informao de valor do Agravo: '||v_VlAgravoDesconto||' divergente do valor provisionado: '||v_vl_agrvo_ppota;
                                        --
                                        RETURN;
                                        --
                                END     IF;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Para cada item encontrado no cursor, realizar
                --      validao das informaes.
                --      Caso alguma informao esteja divergente, deve abortar.
                --
                FOR     r_provisao_item IN      c_provisao_item LOOP
                        --
                        IF      r_provisao_item.tp_pesoa        <>      p_efetiva_primeira_parcela_in.TpPessoa  THEN
                                --
                                p_cd_erro       :=      44;
                                p_msg_erro      :=      'Tipo de pessoa da efetivao: '||p_efetiva_primeira_parcela_in.TpPessoa||' divergente do tipo de pessoa provisionado: '||r_provisao_item.tp_pesoa;
                                --
                                RETURN;
                                --
                        /*ELSIF   r_provisao_item.nm_clien_sgrdo        <>      p_efetiva_primeira_parcela_in.NmCliente  THEN
                                --
                                p_cd_erro       :=      45;
                                p_msg_erro      :=      'Nome do segurado da efetivao: '||p_efetiva_primeira_parcela_in.NmCliente||' divergente do nome do segurado provisionado: '||r_provisao_item.nm_clien_sgrdo;
                                --
                                RETURN; */
                                --
                        ELSIF   r_provisao_item.nr_cpf_cnpj_clien        <>      p_efetiva_primeira_parcela_in.CPFCNPJCliente      THEN
                                --
                                p_cd_erro       :=      46;
                                p_msg_erro      :=      'Nmero do CPF/CNPJ da efetivao: '||p_efetiva_primeira_parcela_in.CPFCNPJCliente||' divergente do CPF/CNPJ provisionado: '||r_provisao_item.nr_cpf_cnpj_clien;
                                --
                                RETURN;
                                --
                        ELSIF   (r_provisao_item.vl_prmio_liqui_ppota        <>      v_VlPremioLiquido) AND NOT CTACTPA0100_001.validaValorProvisionadoMaior( p_id_prdut
                                                                                                                                ,r_provisao_item.vl_prmio_liqui_ppota
                                                                                                                                ,v_VlPremioLiquido
                                                                                                                                ,v_sq_log )      THEN
                                --
                                p_cd_erro       :=      47;
                                p_msg_erro      :=      'Valor do prmio lquido da efetivao: '||v_VlPremioLiquido||' divergente do prmio lquido provisionado: '||r_provisao_item.vl_prmio_liqui_ppota;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.pc_comis_crtor        <>      p_efetiva_primeira_parcela_in.PcComissao      THEN
                                --
                                p_cd_erro       :=      48;
                                p_msg_erro      :=      'Percentual de comisso da efetivao: '||p_efetiva_primeira_parcela_in.PcComissao||' divergente do percentual de comisso provisionado: '||r_provisao_item.pc_comis_crtor;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.dt_inico_vigen_segur    <>      p_dt_inico_vigen        THEN
                                --
                                p_cd_erro       :=      49;
                                p_msg_erro      :=      'Data de incio de vigncia da efetivao: '||To_Char(p_dt_inico_vigen,    'DD/MM/YYYY')||' divergente do incio de vigncia provisionado: '||To_Char(r_provisao_item.dt_inico_vigen_segur,   'DD/MM/YYYY');
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.id_prdut_sistm_origm    <>      p_id_prdut      THEN
                                --
                                p_cd_erro       :=      50;
                                p_msg_erro      :=      'Mdulo Produto da efetivao: '||p_efetiva_primeira_parcela_in.CdProduto||' divergente do Mdulo Produto provisionado: '||r_provisao_item.id_prdut_sistm_origm;
                                --
                                RETURN;
                                --
                        ELSIF   r_provisao_item.tp_desct_agrvo        <>      p_efetiva_primeira_parcela_in.InAgravoDesconto      THEN
                                --
                                p_cd_erro       :=      51;
                                p_msg_erro      :=      'Indicador de desconto agravo da efetivao: '||p_efetiva_primeira_parcela_in.InAgravoDesconto||' divergente do indicador de desconto agravo provisionado: '||r_provisao_item.tp_desct_agrvo;
                                --
                                RETURN;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      21;
                        p_msg_erro      :=      'Erro VerificaProvisaoItem - Negcio: '||p_efetiva_primeira_parcela_in.CdContrato||' Item: '||p_efetiva_primeira_parcela_in.CdItemContrato||' Corretor: '||p_efetiva_primeira_parcela_in.CdCorretor||' '||SQLERRM;
                        --
                        RETURN;
                        --
        END     VerificaProvisaoItem;
        --
        --------------------------------------------------------------------------
        --      BaixaLancamentoProvisao:        Realiza a baixa do lancamento   --
        --                                      da provisao.                    --
        --------------------------------------------------------------------------
        --
        PROCEDURE       BaixaLancamentoProvisao (p_efetiva_primeira_parcela_in  IN      efetiva_primeira_parcela_in
                                                ,p_id_procs_criac       IN      NUMBER
                                                ,p_cd_erro              OUT     NUMBER
                                                ,p_msg_erro             OUT     VARCHAR2)       IS
        --
        CURSOR  c_provisao_item IS
                --
                SELECT  a.tp_pesoa,
                        a.id_lacto,
                        a.id_verba,
                        a.vl_lacto,
                        a.nm_clien_sgrdo,
                        a.nr_cpf_cnpj_clien,
                        a.vl_prmio_liqui_ppota,
                        a.pc_comis_crtor,
                        a.dt_inico_vigen_segur,
                        a.id_prdut_sistm_origm,
                        a.tp_desct_agrvo,
                        b.cd_crtor_segur,
                        a.vl_agrvo_ppota,
                        b.vl_saldo_verba,
                        a.cd_asses_atual_crtor,
                        a.cd_diret_comrl,
                        a.cd_sucsl_comrl,
                        a.id_procs_criac,
                        a.cd_tipo_lacto,
                        a.cd_ctrat,
                        a.cd_item_ctrat
                FROM    cta0004_lacto   a,
                        cta0002_verba   b
                WHERE   a.id_verba              =       b.id_verba
                AND     a.cd_ctrat              =       p_efetiva_primeira_parcela_in.CdContrato
                AND     a.cd_item_ctrat         =       p_efetiva_primeira_parcela_in.CdItemContrato
                AND     a.cd_situc_lacto        =       'LIB'
                AND     a.id_lacto_estor        IS      NULL
                AND     b.cd_crtor_segur        =       p_efetiva_primeira_parcela_in.CdCorretor
                FOR     UPDATE;
        --
        v_cd_suscl_comrl        cta0012_crtor.cd_sucsl_comrl%TYPE;
        v_cd_diret_comrl        cta0012_crtor.cd_diret_comrl%TYPE;
        v_cd_asses              cta0012_crtor.cd_asses%TYPE;
        --
        v_vl_lacto_s_comis      NUMBER;
        vl_saldo_verba_depois   NUMBER;
        vl_saldo_verba_antes    NUMBER;
        v_id_lacto              NUMBER;
        --
        BEGIN
                --
                p_cd_erro       :=      0;
                p_msg_erro      :=      NULL;
                --
                FOR     r_provisao_item IN      c_provisao_item LOOP
                        --
                        --      Selecionando o corretor do lanamento
                        --
                        BEGIN
                                --
                                SELECT  cd_sucsl_comrl,
                                        cd_diret_comrl,
                                        cd_asses
                                INTO    v_cd_suscl_comrl,
                                        v_cd_diret_comrl,
                                        v_cd_asses
                                FROM    cta0012_crtor
                                WHERE   cd_crtor_segur  =       r_provisao_item.cd_crtor_segur;
                                --
                        EXCEPTION
                                --
                                WHEN    OTHERS  THEN
                                        --
                                        p_cd_erro       :=      54;
                                        p_msg_erro      :=      'Erro ao buscar corretor do lanamento: '||SQLERRM;
                                        --
                                        RETURN;
                                        --
                        END;
                        --
                        --      Atualizando o lanamento
                        --
                        IF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'D'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0004_lacto
                                        SET     cd_situc_lacto          =       'EFT',
                                                id_procs_alter          =       p_id_procs_criac,
                                                cd_usuro_ultma_alter    =       p_efetiva_primeira_parcela_in.CdUsuario,
                                                dt_ultma_alter          =       SYSDATE,
                                                cd_sucsl_comrl          =       v_cd_suscl_comrl,
                                                cd_diret_comrl          =       v_cd_diret_comrl,
                                                cd_asses_atual_crtor    =       v_cd_asses
                                        WHERE   id_lacto                =       r_provisao_item.id_lacto;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      53;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de lanamentos: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSIF   p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'A'     THEN
                                --
                                v_vl_lacto_s_comis      :=      (v_VlAgravoDesconto     *       (1      -       (p_efetiva_primeira_parcela_in.PcComissao/100)));
                                --
                                vl_saldo_verba_antes    :=      r_provisao_item.vl_saldo_verba;
                                --
                                vl_saldo_verba_depois   :=      r_provisao_item.vl_saldo_verba  +       v_vl_lacto_s_comis;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[v_VlAgravoDesconto] '||v_VlAgravoDesconto||' [p_efetiva_primeira_parcela_in.PcComissao] '||p_efetiva_primeira_parcela_in.PcComissao);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Valor do lanamento sem comisso]: '||v_vl_lacto_s_comis);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Saldo da verba antes]: '||vl_saldo_verba_antes);
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'[Saldo da verba depois]: '||vl_saldo_verba_depois);
                                --
                                --      Cria novo registro de lanamento
                                --
                                BEGIN
                                        --
                                        SELECT  ctasq0004_lacto.NEXTVAL
                                        INTO    v_id_lacto
                                        FROM    dual;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      35;
                                                p_msg_erro      :=      'Erro ao selecionar sequencia ctasq0004_lacto: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        ctactpa0100_001.GravaLog        (v_sq_log
                                                                        ,'[Criando lanamento] '||v_id_lacto);
                                        --
                                        INSERT  INTO    cta0004_lacto   (id_lacto
                                                                        ,id_verba
                                                                        ,cd_situc_lacto
                                                                        ,cd_ctrat
                                                                        ,cd_item_ctrat
                                                                        ,cd_tipo_lacto
                                                                        ,dt_lacto
                                                                        ,vl_saldo_verba_anter
                                                                        ,vl_lacto
                                                                        ,vl_agrvo_ppota
                                                                        ,vl_saldo_verba_postr
                                                                        ,id_lacto_origm_trnsf
                                                                        ,id_lacto_estor
                                                                        ,tp_pesoa
                                                                        ,nm_clien_sgrdo
                                                                        ,nr_cpf_cnpj_clien
                                                                        ,vl_prmio_liqui_ppota
                                                                        ,pc_comis_crtor
                                                                        ,dt_inico_vigen_segur
                                                                        ,id_procs_criac
                                                                        ,cd_usuro_criac
                                                                        ,dt_criac
                                                                        ,id_corrl_bus
                                                                        ,id_prdut_sistm_origm
                                                                        ,tp_desct_agrvo
                                                                        ,cd_sucsl_comrl
                                                                        ,cd_diret_comrl
                                                                        ,cd_asses_atual_crtor
                                                                        ,ic_prmra_prazo)
                                                                        --
                                                                VALUES  (v_id_lacto
                                                                        ,r_provisao_item.id_verba
                                                                        ,'EFT'
                                                                        ,r_provisao_item.cd_ctrat
                                                                        ,r_provisao_item.cd_item_ctrat
                                                                        ,r_provisao_item.cd_tipo_lacto
                                                                        ,SYSDATE
                                                                        ,vl_saldo_verba_antes
                                                                        ,v_vl_lacto_s_comis
                                                                        ,v_VlAgravoDesconto
                                                                        ,vl_saldo_verba_depois
                                                                        ,NULL
                                                                        ,NULL
                                                                        ,r_provisao_item.tp_pesoa
                                                                        ,r_provisao_item.nm_clien_sgrdo
                                                                        ,r_provisao_item.nr_cpf_cnpj_clien
                                                                        ,r_provisao_item.vl_prmio_liqui_ppota
                                                                        ,r_provisao_item.pc_comis_crtor
                                                                        ,r_provisao_item.dt_inico_vigen_segur
                                                                        ,p_id_procs_criac
                                                                        ,p_efetiva_primeira_parcela_in.CdUsuario
                                                                        ,SYSDATE
                                                                        ,p_efetiva_primeira_parcela_in.IdCorrelation
                                                                        ,r_provisao_item.id_prdut_sistm_origm
                                                                        ,r_provisao_item.tp_desct_agrvo
                                                                        ,r_provisao_item.cd_sucsl_comrl
                                                                        ,r_provisao_item.cd_diret_comrl
                                                                        ,r_provisao_item.cd_asses_atual_crtor
                                                                        ,p_efetiva_primeira_parcela_in.IcPrmraPrazo);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      35;
                                                p_msg_erro      :=      'Erro ao inserir tabela cta0004_lacto: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                                --      Atualiza o lanamento atual para AGB
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0004_lacto
                                        SET     cd_situc_lacto          =       'AGB',
                                                id_procs_alter          =       p_id_procs_criac,
                                                cd_usuro_ultma_alter    =       p_efetiva_primeira_parcela_in.CdUsuario,
                                                dt_ultma_alter          =       SYSDATE,
                                                cd_sucsl_comrl          =       v_cd_suscl_comrl,
                                                cd_diret_comrl          =       v_cd_diret_comrl,
                                                cd_asses_atual_crtor    =       v_cd_asses,
                                                id_lacto_estor          =       v_id_lacto
                                        WHERE   id_lacto                =       r_provisao_item.id_lacto;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      53;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de lanamentos: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END     IF;
                        --
                        --      Atualizar saldo da verba
                        --
                        IF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'D'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0002_verba
                                        SET     vl_prvsn_verba  =       Nvl(vl_prvsn_verba,0)   -       v_VlAgravoDesconto,
                                                vl_eftdo_verba  =       Nvl(vl_eftdo_verba,0)   +       v_VlAgravoDesconto
                                        WHERE   id_verba        =       r_provisao_item.id_verba;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      54;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de verbas [desconto]: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        ELSIF   p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'A'     THEN
                                --
                                BEGIN
                                        --
                                        UPDATE  cta0002_verba
                                        SET     vl_saldo_verba  =       vl_saldo_verba_depois,
                                                vl_crdit_agrvo  =       Nvl(vl_crdit_agrvo,0)   -       Nvl(v_vl_lacto_s_comis,0),
                                                vl_crdto_verba  =       Nvl(vl_crdto_verba,0)   +       Nvl(v_vl_lacto_s_comis,0) --Nvl(vl_crdit_agrvo,0)   -       v_vl_lacto_s_comis
                                        WHERE   id_verba        =       r_provisao_item.id_verba;
                                        --

                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                p_cd_erro       :=      54;
                                                p_msg_erro      :=      'Erro ao atualizar tabela de verbas [agravo]: '||SQLERRM;
                                                --
                                                RETURN;
                                                --
                                END;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        p_cd_erro       :=      52;
                        p_msg_erro      :=      'Erro ao lanar baixa da proviso: '||SQLERRM;
                        --
        END     BaixaLancamentoProvisao;
        --
        --------------------------------------------------------------------------
        --      Efetiva_Primeira_Parcela:       Efetuar a efetivao de uma     --
        --                                      proviso feita anteriormente.   --
        --                                      Esse servio deve ser chamado   --
        --                                      quando a aplice for emitida e  --
        --                                      a primeira parcela da aplice   --
        --                                      for a prazo.                    --
        --------------------------------------------------------------------------
        --
        PROCEDURE       Efetiva_Primeira_Parcela        (p_efetiva_primeira_parcela_in  IN      efetiva_primeira_parcela_in
                                                        ,p_efetiva_primeira_parcela_out OUT     efetiva_primeira_parcela_out)   IS
        --
        v_dt_procm              DATE;
        v_dt_inico_vigen        DATE;
        v_cd_erro               NUMBER;
        v_id_prdut              NUMBER;
        v_cd_segmt_prdut        NUMBER;
        v_vl_provisao           NUMBER;
        v_id_procs_criac        NUMBER;
        v_msg_erro              VARCHAR2(4000);
        --
        erro_fatal              EXCEPTION;
        nao_efetiva_parcela     EXCEPTION;
        --
        BEGIN
                --
                --      Inicializando o type
                --
                p_efetiva_primeira_parcela_out  :=      efetiva_primeira_parcela_out    (0
                                                                                        ,NULL);
                --
                --      Verificando se deve debugar o item / cpf
                --
                v_VlPremioLiquido       :=      Round(p_efetiva_primeira_parcela_in.VlPremioLiquido,    2);
                v_VlAgravoDesconto      :=      Round(p_efetiva_primeira_parcela_in.VlAgravoDesconto,   2);
                --
                CTACTPA0100_001.IniciaLog       (221
                                                ,p_efetiva_primeira_parcela_in.SistemaChamador
                                                ,p_efetiva_primeira_parcela_in.CdCorretor
                                                ,NULL
                                                ,p_efetiva_primeira_parcela_in.CdContrato
                                                ,p_efetiva_primeira_parcela_in.CdItemContrato
                                                ,p_efetiva_primeira_parcela_in.TpPessoa
                                                ,p_efetiva_primeira_parcela_in.CPFCNPJCliente
                                                ,p_efetiva_primeira_parcela_in.NmCliente
                                                ,p_efetiva_primeira_parcela_in.CdUsuario
                                                ,p_efetiva_primeira_parcela_in.CdProcesso
                                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog   (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                                 LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                 ' Servio Efetiva_Primeira_Parcela. Parmetros de entrada: '                           ||Chr(10)||
                                                 ' SistemaChamador........ '||p_efetiva_primeira_parcela_in.SistemaChamador             ||Chr(10)||
                                                 ' CdProduto.............. '||p_efetiva_primeira_parcela_in.CdProduto                   ||Chr(10)||
                                                 ' CdCorretor............. '||p_efetiva_primeira_parcela_in.CdCorretor                  ||Chr(10)||
                                                 ' CdContrato............. '||p_efetiva_primeira_parcela_in.CdContrato                  ||Chr(10)||
                                                 ' CdItemContrato......... '||p_efetiva_primeira_parcela_in.CdItemContrato              ||Chr(10)||
                                                 ' InAgravoDesconto....... '||p_efetiva_primeira_parcela_in.InAgravoDesconto            ||Chr(10)||
                                                 ' VlAgravoDesconto....... '||p_efetiva_primeira_parcela_in.VlAgravoDesconto            ||Chr(10)||
                                                 ' v_VlAgravoDesconto..... '||v_VlAgravoDesconto                                ||Chr(10)||
                                                 ' TpPessoa............... '||p_efetiva_primeira_parcela_in.TpPessoa                    ||Chr(10)||
                                                 ' CPFCNPJCliente......... '||p_efetiva_primeira_parcela_in.CPFCNPJCliente              ||Chr(10)||
                                                 ' NmCliente.............. '||p_efetiva_primeira_parcela_in.NmCliente                   ||Chr(10)||
                                                 ' VlPremioLiquido........ '||p_efetiva_primeira_parcela_in.VlPremioLiquido             ||Chr(10)||
                                                 ' v_VlPremioLiquido...... '||v_VlPremioLiquido                                 ||Chr(10)||
                                                 ' PcComissao............. '||p_efetiva_primeira_parcela_in.PcComissao                  ||Chr(10)||
                                                 ' DtInicioVigencia....... '||p_efetiva_primeira_parcela_in.DtInicioVigencia            ||Chr(10)||
                                                 ' CdUsuario.............. '||p_efetiva_primeira_parcela_in.CdUsuario                   ||Chr(10)||
                                                 ' CdProcesso............. '||p_efetiva_primeira_parcela_in.CdProcesso                  ||Chr(10)||
                                                 ' IdCorrelation.......... '||p_efetiva_primeira_parcela_in.IdCorrelation               ||Chr(10)||
                                                 ' IcPrmraPrazo........... '||p_efetiva_primeira_parcela_in.IcPrmraPrazo                ||Chr(10)||
                                                 ' Ambiente.............. '||CTACTPA0100_001.RetornaParametro('AMBIENTE')       ||Chr(10)||
                                                 LPad('=',       80,     '='));
                --
                --      Validando o sistema chamador
                --
                IF      NOT(CTACTPA0100_001.SistemaChamadorValido (p_efetiva_primeira_parcela_in.SistemaChamador))        THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      2;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Sistema chamador invlido: '||p_efetiva_primeira_parcela_in.SistemaChamador;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o corretor
                --
                IF      NOT(CTACTPA0100_001.IsCorretorValido    (p_efetiva_primeira_parcela_in.CdCorretor
                                                                ,v_cd_erro
                                                                ,v_msg_erro))   THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de negcio
                --
                IF      p_efetiva_primeira_parcela_in.CdContrato           IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      15;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Nmero de negcio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando nmero de item
                --
                IF      p_efetiva_primeira_parcela_in.CdItemContrato      IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      16;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Nmero de item est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando indicador de agravo / desconto
                --
                IF      Nvl(p_efetiva_primeira_parcela_in.InAgravoDesconto,     'X')    NOT     IN      ('A',   'D')    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      24;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - Indicador de desconto / agravo invlido: '||Nvl(p_efetiva_primeira_parcela_in.InAgravoDesconto, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando valor de agravo / desconto
                --
                IF      v_VlAgravoDesconto      IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      25;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - Valor de agravo / desconto est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando tipo de pessoa
                --
                IF      Nvl(p_efetiva_primeira_parcela_in.TpPessoa,       'X')    NOT     IN      ('F',   'J')    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      8;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Tipo de pessoa invlido: '||Nvl(p_efetiva_primeira_parcela_in.TpPessoa, 'nulo');
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando CPF / CNPJ do cliente
                --
                IF      p_efetiva_primeira_parcela_in.CPFCNPJCliente      IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      9;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - CPF / CNPJ est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                ELSE
                        --
                        IF      p_efetiva_primeira_parcela_in.TpPessoa  =       'F'
                        AND     NOT(tms_util.valida_cpf(LPad(p_efetiva_primeira_parcela_in.CPFCNPJCliente,11,'0')))  THEN
                                --
                                p_efetiva_primeira_parcela_out.StRetorno        :=      9;
                                p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - CPF invlido: '||p_efetiva_primeira_parcela_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        ELSIF   p_efetiva_primeira_parcela_in.TpPessoa  =       'J'
                        AND     NOT(tms_util.valida_cnpj(LPad(p_efetiva_primeira_parcela_in.CPFCNPJCliente,14,'0'))) THEN
                                --
                                p_efetiva_primeira_parcela_out.StRetorno        :=      9;
                                p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - CNPJ invlido: '||p_efetiva_primeira_parcela_in.CPFCNPJCliente;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                --      Validando nome do cliente
                --
                IF      p_efetiva_primeira_parcela_in.NmCliente         IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      26;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - Nome de cliente est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valor Prmio Lquido
                --
                IF      v_VlPremioLiquido       IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      5;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Valor do prmio lquido est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando percentual de comisso
                --
                IF      p_efetiva_primeira_parcela_in.Pccomissao          IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      6;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Percentual de comisso est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando incio de vigncia
                --
                IF      p_efetiva_primeira_parcela_in.DtInicioVigencia    IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      7;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Data de incio de vigncia est nula';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      NOT(CTACTPA0100_001.IsDataValida  (p_efetiva_primeira_parcela_in.DtInicioVigencia
                                                                ,v_dt_inico_vigen))     THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      7;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Data de incio de vigncia invlida: '||p_efetiva_primeira_parcela_in.DtInicioVigencia;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando usurio
                --
                IF      p_efetiva_primeira_parcela_in.CdUsuario           IS      NULL    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      10;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Usurio est nulo';
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando cdigo de processo
                --
                IF      Nvl(p_efetiva_primeira_parcela_in.CdProcesso,   0)      NOT     IN      (43)    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      11;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Cdigo de processo invlido: '||p_efetiva_primeira_parcela_in.CdProcesso;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o indicador de primeira a prazo
                --
                IF      Nvl(p_efetiva_primeira_parcela_in.IcPrmraPrazo, 'X')    NOT     IN      ('S',   'N')    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno  :=      110;
                        p_efetiva_primeira_parcela_out.MsgRetorno :=      '[Efetiva Primeira Parcela] - Indicador de primeira parcela a prazo invlido: '||p_efetiva_primeira_parcela_in.IcPrmraPrazo;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Valida sistema indisponvel
                --
                IF      CTACTPA0100_001.IsSistemaIndisponivel   (v_cd_erro
                                                                ,v_msg_erro)    THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Busca a data de processamento.
                --
                v_dt_procm      :=      CTACTPA0100_001.RetornaDtProcm;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaDtProcm] - '||v_dt_procm);
                --
                --      Busca segmento do produto
                --
                v_cd_segmt_prdut        :=      CTACTPA0100_001.RetornaSegmentoProduto  (p_efetiva_primeira_parcela_in.SistemaChamador
                                                                                        ,p_efetiva_primeira_parcela_in.CdProduto
                                                                                        ,v_dt_procm
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[RetornaSegmentoProduto] - '||v_cd_segmt_prdut||' Sistema Chamador: '||p_efetiva_primeira_parcela_in.SistemaChamador||' Produto: '||p_efetiva_primeira_parcela_in.CdProduto||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Validando o mdulo produto
                --
                v_id_prdut      :=      CTACTPA0100_001.ModuloProdutoValido     (p_efetiva_primeira_parcela_in.CdProduto
                                                                                ,p_efetiva_primeira_parcela_in.SistemaChamador
                                                                                ,v_cd_segmt_prdut
                                                                                ,v_dt_procm
                                                                                ,v_cd_erro
                                                                                ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ModuloProdutoValido] - '||v_id_prdut||' Produto: '||p_efetiva_primeira_parcela_in.CdProduto||' Sistema Chamador: '||p_efetiva_primeira_parcela_in.SistemaChamador||' Segmento: '||v_cd_segmt_prdut||' Data: '||v_dt_procm);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                v_id_procs_criac        :=      CTACTPA0100_001.ValidaCdProcesso        (p_efetiva_primeira_parcela_in.CdProcesso
                                                                                        ,v_cd_erro
                                                                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[ValidaCdProcesso] - '||v_id_procs_criac||' Processo: '||p_efetiva_primeira_parcela_in.CdProcesso);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                --      Se o indicador de agravo = 'D' ou o indicador de
                --      primeira parcela a prazo = 'N', retornar sem fazer nada
                --
                IF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'D'
                OR      p_efetiva_primeira_parcela_in.IcPrmraPrazo      =       'N'     THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Retornando ao programa chamador] InAgravoDesconto = '||p_efetiva_primeira_parcela_in.InAgravoDesconto||' IcPrmraPrazo = '||p_efetiva_primeira_parcela_in.IcPrmraPrazo );
                        --
                        RAISE   nao_efetiva_parcela;
                        --
                END     IF;
                --
                --      Verifica se existe proviso para o item
                --
                VerificaProvisaoItem    (p_efetiva_primeira_parcela_in
                                        ,v_dt_inico_vigen
                                        ,v_id_prdut
                                        ,v_cd_erro
                                        ,v_msg_erro);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[VerificaProvisaoItem] - Incio de vigncia: '||v_dt_inico_vigen);
                --
                IF      v_cd_erro       <>      0       THEN
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                        --
                        RAISE   erro_fatal;
                        --
                END     IF;
                --
                IF      p_efetiva_primeira_parcela_in.InAgravoDesconto  =       'A'
                AND     p_efetiva_primeira_parcela_in.IcPrmraPrazo      =       'S'     THEN
                        --
                        --      Dar baixa no lanamento de proviso
                        --
                        BaixaLancamentoProvisao (p_efetiva_primeira_parcela_in
                                                ,v_id_procs_criac
                                                ,v_cd_erro
                                                ,v_msg_erro);
                        --
                        IF      v_cd_erro       <>      0       THEN
                                --
                                p_efetiva_primeira_parcela_out.StRetorno        :=      v_cd_erro;
                                p_efetiva_primeira_parcela_out.MsgRetorno       :=      '[Efetiva Primeira Parcela] - '||v_msg_erro;
                                --
                                RAISE   erro_fatal;
                                --
                        END     IF;
                        --
                END     IF;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'[Cdigo de Retorno: '||p_efetiva_primeira_parcela_out.StRetorno||' - Mensagem: '||p_efetiva_primeira_parcela_out.MsgRetorno||']');
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                 'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                 LPad('=',      80,     '='));
                --
                CTACTPA0100_001.FinalizaLog     (v_sq_log);
                --
        EXCEPTION
                --
                WHEN    nao_efetiva_parcela     THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                WHEN    erro_fatal              THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'[Cdigo de Retorno: '||p_efetiva_primeira_parcela_out.StRetorno||' - Mensagem: '||p_efetiva_primeira_parcela_out.MsgRetorno||']');
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro Efetiva_Provisao: '||SQLERRM);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                                         LPad('=',      80,     '='));
                        --
                        CTACTPA0100_001.FinalizaLog     (v_sq_log);
                        --
                        ROLLBACK;
                        --
                        p_efetiva_primeira_parcela_out.StRetorno        :=      1;
                        p_efetiva_primeira_parcela_out.MsgRetorno       :=      'Erro Efetiva_Provisao: '               ||' '||
                                                                        p_efetiva_primeira_parcela_in.SistemaChamador   ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdProduto         ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdCorretor        ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdContrato        ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdItemContrato    ||' '||
                                                                        p_efetiva_primeira_parcela_in.InAgravoDesconto  ||' '||
                                                                        p_efetiva_primeira_parcela_in.VlAgravoDesconto  ||' '||
                                                                        p_efetiva_primeira_parcela_in.TpPessoa          ||' '||
                                                                        p_efetiva_primeira_parcela_in.CPFCNPJCliente    ||' '||
                                                                        p_efetiva_primeira_parcela_in.NmCliente         ||' '||
                                                                        p_efetiva_primeira_parcela_in.VlPremioLiquido   ||' '||
                                                                        p_efetiva_primeira_parcela_in.PcComissao        ||' '||
                                                                        p_efetiva_primeira_parcela_in.DtInicioVigencia  ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdUsuario         ||' '||
                                                                        p_efetiva_primeira_parcela_in.CdProcesso        ||' '||
                                                                        p_efetiva_primeira_parcela_in.IdCorrelation     ||' '||
                                                                        SQLERRM;
                        --
        END     Efetiva_Primeira_Parcela;
        --
END     CTACTPA0022_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0023_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       VerbasDiretoria                 (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR IS
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            C.CD_ASSES AS ASSESSORIA,
            C.CD_SUCSL_COMRL AS COD_SUCURSAL,
            C.NM_SUCSL AS NOME_SUCURSAL,
            V.CD_DIRET_COMRL AS CD_DIRETORIA,
            RETORNANMDIRETORIA(V.CD_DIRET_COMRL) AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    UNION
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            V.CD_ASSES AS ASSESSORIA,
            CASE WHEN  V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_SUCSL_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) ELSE V.CD_SUCSL_COMRL END AS COD_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.NM_SUCSL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL THEN (SELECT SUC.NM_SUCSL FROM CTA0012_CRTOR SUC WHERE SUC.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NOT NULL THEN '' ELSE '' END AS NOME_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1) ELSE V.CD_DIRET_COMRL END AS CD_DIRETORIA,
            CASE WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NOT NULL THEN RETORNANMDIRETORIA((SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NULL THEN RETORNANMDIRETORIA((SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA  WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NOT NULL THEN RETORNANMDIRETORIA(V.CD_DIRET_COMRL) ELSE NULL END AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR(+) = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    AND     C.CD_CRTOR_SEGUR IS      NULL
    ORDER BY COD_CORRETOR, ASSESSORIA, COD_SUCURSAL, CD_DIRETORIA;
                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (231
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        IF      v_parm_tp_local         <>      22      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) NOT     IN      ('C','T')       THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Tipo verba invalida. Tipo informado: ' || p_parametros(1);
                --
                RETURN;
                --
        END     IF;
        --
        IF      p_parametros(1) =       'C'     THEN
                --
                v_tipo_verba    :=      'Corretor';
                --
        ELSIF   p_parametros(1) =       'T'     THEN
                --
                v_tipo_verba    :=      'Tokio';
                --
        ELSE
                --
                v_tipo_verba    :=      NULL;
                --
        END     IF;
        --
        IF      p_parametros(2) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(2) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(2) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(2) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 4:' || p_parametros(4));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(4),'dd/mm/yyyy');
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Local para seleo:' || v_parm_cd_local);
        --
	FOR     R_CURSOR        IN      C_CURSOR        LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --
                        IF      r_cursor.cd_diretoria   IS      NULL    THEN
                                --
                                IF      r_cursor.assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cod_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cod_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        ELSE
                                --
                                v_cd_diretoria  :=      r_cursor.cd_diretoria;
                                --
                        END     IF;
                        --
                        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_cd_diretoria: ' || v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_verba: *' || v_tipo_verba || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.TIPO_VERBA: ' || r_cursor.TIPO_VERBA);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.SEGMENTO: ' || r_cursor.SEGMENTO);
                        --
                        --
                        IF      v_cd_diretoria          =       v_parm_cd_local
                        AND     r_cursor.TIPO_VERBA     =       Nvl(v_tipo_verba,r_cursor.TIPO_VERBA)
                        AND     r_cursor.SEGMENTO       =       Nvl(v_tipo_produto,r_cursor.SEGMENTO)
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.id_verba);
                                --
                                v_achou :=      'S';
                                --
                                V_ESTORNO := 'N';
                                --
                                BEGIN
                                    --
                                    IF R_CURSOR.ID_VERBA_ORIGEM IS NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                        --
                                    ELSE
                                        --
                                        BEGIN
                                            --
                                            SELECT  CD_USURO_ULTMA_ALTER
                                            INTO    V_CD_USURO_ULTMA_ALTER
                                            FROM    CTA0002_VERBA
                                            WHERE   ID_VERBA = R_CURSOR.ID_VERBA;
                                              --
                                              IF V_CD_USURO_ULTMA_ALTER = 'ESTORNO' THEN
                                                  --
                                                  V_ESTORNO           := 'S';
                                                  --
                                              ELSE
                                                  --
                                                  V_ESTORNO           := 'N';
                                                  --
                                              END IF;
                                              --
                                              SELECT  CD_CRTOR_SEGUR,
                                                      CD_SUCSL_COMRL,
                                                      CD_ASSES,
                                                      CD_DIRET_COMRL,
                                                      ID_VERBA_ORIGM_TRNSF
                                              INTO    V_CD_CRTOR_SEGUR,
                                                      V_CD_SUCSL_COMRL,
                                                      V_CD_ASSES,
                                                      V_CD_DIRET_COMRL,
                                                      V_ID_VERBA_DESTINO
                                              FROM    CTA0002_VERBA
                                              WHERE   ID_VERBA = R_CURSOR.ID_VERBA_ORIGEM;
                                              --
                                              IF V_ESTORNO = 'S' AND V_ID_VERBA_DESTINO IS NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                                  --
                                              ELSIF V_CD_CRTOR_SEGUR IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'CORRETOR';
                                                  --
                                              ELSIF V_CD_ASSES IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'ASSESSORIA';
                                                  --
                                              ELSIF V_CD_SUCSL_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'SUCURSAL';
                                                  --
                                              ELSIF V_CD_DIRET_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'DIRETORIA';
                                                  --
                                              END IF;
                                              --
                                        EXCEPTION
                                            --
                                            WHEN OTHERS THEN
                                              --
                                              V_TIPO_DISTRIBUICAO := 'DESCONHECIDO';
                                              --
                                        END;
                                        --
                                    END IF;
                                    --
                                    IF R_CURSOR.COD_CORRETOR IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'CORRETOR';
                                        --
                                    ELSIF R_CURSOR.ASSESSORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'ASSESSORIA';
                                        --
                                    ELSIF R_CURSOR.COD_SUCURSAL IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'SUCURSAL';
                                        --
                                    ELSIF R_CURSOR.CD_DIRETORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'DIRETORIA';
                                        --
                                    END IF;
                                    --
                                    V_NOME_ARQUIVO := ADMCTA.ARQUIVO_CARGA(R_CURSOR.ID_VERBA);
                                    --
                                    v_valor_utilizado   :=      R_CURSOR.VALOR_PROVISIONADO     +       R_CURSOR.VALOR_EFETIVADO;
                                                --
                                    IF  r_cursor.valor_inicial                  =       0       AND
                                        v_valor_utilizado                       =       0       AND
                                        r_cursor.valor_credito_agravo_bloqueado =       0       AND
                                        r_cursor.valor_transferencia_credito    =       0       AND
                                        r_cursor.valor_transferencia_debito     =       0       AND
                                        r_cursor.valor_saldo                    =       0       THEN
                                        --
                                        RAISE   v_proxima;
                                        --
                                    ELSE
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.ID_VERBA;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.ID_VERBA_ORIGEM;
                                        relatorio(i_retorno).v_retorno_03       :=      V_NOME_ARQUIVO;
                                        relatorio(i_retorno).v_retorno_04       :=      V_ESTORNO;
                                        relatorio(i_retorno).v_retorno_05       :=      V_TIPO_DISTRIBUICAO;
                                        relatorio(i_retorno).v_retorno_06       :=      V_TIPO_DISTRIBUICAO_P;
                                        relatorio(i_retorno).v_retorno_07       :=      R_CURSOR.SEGMENTO;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.COD_CORRETOR;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.ASSESSORIA;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.COD_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_13       :=      v_cd_diretoria;
                                        relatorio(i_retorno).v_retorno_14       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_15       :=      R_CURSOR.TIPO_VERBA;
                                        relatorio(i_retorno).v_retorno_16       :=      R_CURSOR.VALOR_INICIAL;
                                        relatorio(i_retorno).v_retorno_17       :=      v_valor_utilizado;
                                        relatorio(i_retorno).v_retorno_18       :=      R_CURSOR.VALOR_CREDITO_AGRAVO_BLOQUEADO;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.VALOR_TRANSFERENCIA_CREDITO;
                                        relatorio(i_retorno).v_retorno_20       :=      R_CURSOR.VALOR_TRANSFERENCIA_DEBITO;
                                        relatorio(i_retorno).v_retorno_21       :=      R_CURSOR.VALOR_SALDO;
                                        relatorio(i_retorno).v_retorno_22       :=      TO_CHAR(R_CURSOR.INICIO_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_23       :=      TO_CHAR(R_CURSOR.FIM_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_24       :=      R_CURSOR.STATUS_VERBA;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                END     IF;
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);

        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     VerbasDiretoria;
--
END CTACTPA0023_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0024_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       VerbasSucursal                  (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR IS
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            C.CD_ASSES AS ASSESSORIA,
            C.CD_SUCSL_COMRL AS COD_SUCURSAL,
            C.NM_SUCSL AS NOME_SUCURSAL,
            V.CD_DIRET_COMRL AS CD_DIRETORIA,
            RETORNANMDIRETORIA(V.CD_DIRET_COMRL) AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    UNION
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            V.CD_ASSES AS ASSESSORIA,
            CASE WHEN  V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_SUCSL_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) ELSE V.CD_SUCSL_COMRL END AS COD_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.NM_SUCSL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL THEN (SELECT SUC.NM_SUCSL FROM CTA0012_CRTOR SUC WHERE SUC.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NOT NULL THEN '' ELSE '' END AS NOME_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1) ELSE V.CD_DIRET_COMRL END AS CD_DIRETORIA,
            CASE WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NOT NULL THEN RETORNANMDIRETORIA((SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NULL THEN RETORNANMDIRETORIA((SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA  WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NOT NULL THEN RETORNANMDIRETORIA(V.CD_DIRET_COMRL) ELSE NULL END AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR(+) = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    AND     C.CD_CRTOR_SEGUR IS      NULL
    ORDER BY COD_CORRETOR, ASSESSORIA, COD_SUCURSAL, CD_DIRETORIA;
                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (241
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        IF      v_parm_tp_local         <>      80      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) NOT     IN      ('C','T')       THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Tipo verba invalida. Tipo informado: ' || p_parametros(1);
                --
                RETURN;
                --
        END     IF;
        --
        IF      p_parametros(1) =       'C'     THEN
                --
                v_tipo_verba    :=      'Corretor';
                --
        ELSIF   p_parametros(1) =       'T'     THEN
                --
                v_tipo_verba    :=      'Tokio';
                --
        ELSE
                --
                v_tipo_verba    :=      NULL;
                --
        END     IF;
        --
        IF      p_parametros(2) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(2) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(2) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(2) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 4:' || p_parametros(4));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(4),'dd/mm/yyyy');
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Local para seleo:' || v_parm_cd_local);
        --
	FOR     R_CURSOR        IN      C_CURSOR        LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --
                        IF      r_cursor.cd_diretoria   IS      NULL    THEN
                                --
                                IF      r_cursor.assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cod_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cod_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        ELSE
                                --
                                v_cd_diretoria  :=      r_cursor.cd_diretoria;
                                --
                        END     IF;
                        --
                        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_cd_diretoria: ' || v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_verba: *' || v_tipo_verba || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.TIPO_VERBA: ' || r_cursor.TIPO_VERBA);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.SEGMENTO: ' || r_cursor.SEGMENTO);
                        --
                        --
                        IF      R_CURSOR.COD_SUCURSAL   =       v_parm_cd_local
                        AND     r_cursor.TIPO_VERBA     =       Nvl(v_tipo_verba,r_cursor.TIPO_VERBA)
                        AND     r_cursor.SEGMENTO       =       Nvl(v_tipo_produto,r_cursor.SEGMENTO)
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.id_verba);
                                --
                                v_achou :=      'S';
                                --
                                V_ESTORNO := 'N';
                                --
                                BEGIN
                                    --
                                    IF R_CURSOR.ID_VERBA_ORIGEM IS NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                        --
                                    ELSE
                                        --
                                        BEGIN
                                            --
                                            SELECT  CD_USURO_ULTMA_ALTER
                                            INTO    V_CD_USURO_ULTMA_ALTER
                                            FROM    CTA0002_VERBA
                                            WHERE   ID_VERBA = R_CURSOR.ID_VERBA;
                                              --
                                              IF V_CD_USURO_ULTMA_ALTER = 'ESTORNO' THEN
                                                  --
                                                  V_ESTORNO           := 'S';
                                                  --
                                              ELSE
                                                  --
                                                  V_ESTORNO           := 'N';
                                                  --
                                              END IF;
                                              --
                                              SELECT  CD_CRTOR_SEGUR,
                                                      CD_SUCSL_COMRL,
                                                      CD_ASSES,
                                                      CD_DIRET_COMRL,
                                                      ID_VERBA_ORIGM_TRNSF
                                              INTO    V_CD_CRTOR_SEGUR,
                                                      V_CD_SUCSL_COMRL,
                                                      V_CD_ASSES,
                                                      V_CD_DIRET_COMRL,
                                                      V_ID_VERBA_DESTINO
                                              FROM    CTA0002_VERBA
                                              WHERE   ID_VERBA = R_CURSOR.ID_VERBA_ORIGEM;
                                              --
                                              IF V_ESTORNO = 'S' AND V_ID_VERBA_DESTINO IS NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                                  --
                                              ELSIF V_CD_CRTOR_SEGUR IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'CORRETOR';
                                                  --
                                              ELSIF V_CD_ASSES IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'ASSESSORIA';
                                                  --
                                              ELSIF V_CD_SUCSL_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'SUCURSAL';
                                                  --
                                              ELSIF V_CD_DIRET_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'DIRETORIA';
                                                  --
                                              END IF;
                                              --
                                        EXCEPTION
                                            --
                                            WHEN OTHERS THEN
                                              --
                                              V_TIPO_DISTRIBUICAO := 'DESCONHECIDO';
                                              --
                                        END;
                                        --
                                    END IF;
                                    --
                                    IF R_CURSOR.COD_CORRETOR IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'CORRETOR';
                                        --
                                    ELSIF R_CURSOR.ASSESSORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'ASSESSORIA';
                                        --
                                    ELSIF R_CURSOR.COD_SUCURSAL IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'SUCURSAL';
                                        --
                                    ELSIF R_CURSOR.CD_DIRETORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'DIRETORIA';
                                        --
                                    END IF;
                                    --
                                    V_NOME_ARQUIVO := ADMCTA.ARQUIVO_CARGA(R_CURSOR.ID_VERBA);
                                    --
                                    v_valor_utilizado   :=      R_CURSOR.VALOR_PROVISIONADO     +       R_CURSOR.VALOR_EFETIVADO;
                                                --
                                    IF  r_cursor.valor_inicial                  =       0       AND
                                        v_valor_utilizado                       =       0       AND
                                        r_cursor.valor_credito_agravo_bloqueado =       0       AND
                                        r_cursor.valor_saldo                    =       0       THEN
                                        --
                                        RAISE   v_proxima;
                                        --
                                    ELSE
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.ID_VERBA;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.ID_VERBA_ORIGEM;
                                        relatorio(i_retorno).v_retorno_03       :=      V_NOME_ARQUIVO;
                                        relatorio(i_retorno).v_retorno_04       :=      V_ESTORNO;
                                        relatorio(i_retorno).v_retorno_05       :=      V_TIPO_DISTRIBUICAO;
                                        relatorio(i_retorno).v_retorno_06       :=      V_TIPO_DISTRIBUICAO_P;
                                        relatorio(i_retorno).v_retorno_07       :=      R_CURSOR.SEGMENTO;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.COD_CORRETOR;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.ASSESSORIA;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.COD_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_13       :=      v_cd_diretoria;
                                        relatorio(i_retorno).v_retorno_14       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_15       :=      R_CURSOR.TIPO_VERBA;
                                        relatorio(i_retorno).v_retorno_16       :=      R_CURSOR.VALOR_INICIAL;
                                        relatorio(i_retorno).v_retorno_17       :=      v_valor_utilizado;
                                        relatorio(i_retorno).v_retorno_18       :=      R_CURSOR.VALOR_CREDITO_AGRAVO_BLOQUEADO;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.VALOR_TRANSFERENCIA_CREDITO;
                                        relatorio(i_retorno).v_retorno_20       :=      R_CURSOR.VALOR_TRANSFERENCIA_DEBITO;
                                        relatorio(i_retorno).v_retorno_21       :=      R_CURSOR.VALOR_SALDO;
                                        relatorio(i_retorno).v_retorno_22       :=      TO_CHAR(R_CURSOR.INICIO_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_23       :=      TO_CHAR(R_CURSOR.FIM_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_24       :=      R_CURSOR.STATUS_VERBA;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                END     IF;
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     VerbasSucursal;
--
END CTACTPA0024_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0025_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       LancamentosDiretoria            (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR (p_cd_diretoria IN      number) IS
        --
    SELECT  C.CD_CRTOR_SEGUR_PRCPA      AS CORRETOR,
            D.NM_CRTOR_SEGUR                AS NOME_CORRETOR,
            c.cd_asses                      AS CD_ASSESSORIA,
            c.CD_CRTOR_SEGUR_PRCPA          AS cd_corretor,
            D.CD_SUCSL_COMRL                AS SUCURSAL,
            D.NM_SUCSL                      AS NOME_SUCURSAL,
            C.CD_USURO_CADMT_PPOTA          AS USUARIO,
            C.CD_SITUC_NGOCO                AS STATUS,
            B.CD_MDUPR                      AS MODULO,
            B.CD_NGOCO                      AS NEGOCIO,
            B.NR_ITSEG                      AS ITEM,
            A.TP_AGRVC_DESCT_CRTOR_EMISS    AS IND_DESC_AGRAV,
            VL_TOTAL_AGRVC_DESCT_EMISS      AS VALOR_DESC_AGRAV,
            D.CD_DIRET_COMRL                AS DIRETORIA,
            c.DT_PROCM_RCEL                 AS Data_Transmissao
            FROM    SSV0019_COBTU_ITSEG     A,
                    SSV0076_ITSEG           B,
                    SSV0084_NGOCO           C,
                    CTA0012_CRTOR           D
            WHERE   TP_AGRVC_DESCT_CRTOR_EMISS      IS      NOT     NULL
            AND     DT_PROCM_RCEL   BETWEEN v_dt_ini_vig_verba AND v_dt_fim_vig_verba
            AND     A.NR_ITSEG       =       B.NR_ITSEG
            AND     A.TP_HISTO_ITSEG =       '0'
            AND     B.CD_NGOCO       =       C.CD_NGOCO
            AND     d.cd_diret_comrl    =       p_cd_diretoria
            --AND     c.cd_ngoco          =       19643766
            AND     B.TP_HISTO_NGOCO =       '0'
            AND     B.TP_HISTO_ITSEG =       '0'
            AND     C.TP_HISTO       =       '0'
            AND     D.CD_CRTOR_SEGUR =       C.CD_CRTOR_SEGUR_PRCPA
            ORDER BY C.CD_CRTOR_SEGUR_PRCPA;

                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_tipo_produto_lacto    VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
        P_VL_PRMIO_DEVID_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_DEVID_EMISS%TYPE;
        P_VL_PRMIO_TOTAL_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        P_PREMIO_LIQUIDO_NORMAL SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (251
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        IF      v_parm_tp_local         <>      22      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(1) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(1) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(1) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(2),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Local para seleo:' || v_parm_cd_local);
        --
        v_cd_diretoria          :=      v_parm_cd_local;
        --
        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
        --
	FOR     R_CURSOR        IN      C_CURSOR        (v_cd_diretoria)       LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --
                        /*
                                IF      r_cursor.cd_assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.cd_assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cd_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cd_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        */
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'Negocio: ' || r_cursor.negocio);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --
                        IF      r_cursor.modulo IN      (7,9,20)        THEN
                                --
                                v_tipo_produto_lacto  :=      'Automvel';
                                --
                        ELSIF   r_cursor.modulo       IN      (14)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Residencial';
                                --
                        ELSIF   r_cursor.modulo       IN      (12)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Condomnio';
                                --
                        ELSIF   r_cursor.modulo       IN      (11)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Empresarial';
                                --
                        ELSE
                                --
                                v_tipo_produto_lacto  :=      NULL;
                                --
                        END     IF;
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto_lacto: *' || v_tipo_produto_lacto || '*');

                        --
                        --IF      v_tipo_produto_lacto    =       Nvl(v_tipo_produto,v_tipo_produto_lacto)        THEN
                                --
                        --        CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                        ,'Produto est igual');
                        --END     IF;
                        --
                        IF      v_tipo_produto_lacto    =       Nvl(v_tipo_produto,v_tipo_produto_lacto)
                                --
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.negocio);
                                --
                                SELECT NVL(SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),0),
                                       NVL(SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0)),0)
                                INTO   P_VL_PRMIO_DEVID_EMISS,
                                       P_VL_PRMIO_TOTAL_EMISS
                                FROM  SSV0075_HISTO_VLTAX_COBTU_ITEM VL
                                WHERE VL.NR_ITSEG = R_CURSOR.ITEM
                                AND   VL.SQ_HISTO_COBTU_ITSEG = (
                                      SELECT  MIN(X.SQ_HISTO_COBTU_ITSEG)
                                      FROM    SSV0075_HISTO_VLTAX_COBTU_ITEM X
                                      WHERE   X.NR_ITSEG = R_CURSOR.ITEM
                                );
                                --
                                IF P_VL_PRMIO_DEVID_EMISS = 0 THEN
                                    --
                                    -- VERIFICA REGISTRO NA SSV0117
                                    --
                                    SELECT  SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),
                                            SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0))
                                    INTO    P_VL_PRMIO_DEVID_EMISS,
                                            P_VL_PRMIO_TOTAL_EMISS
                                    FROM SSV0117_VLTAX_COBTU_ITEM VL
                                    WHERE VL.NR_ITSEG = R_CURSOR.ITEM;
                                    --
                                END IF;
                                --
                                IF R_CURSOR.IND_DESC_AGRAV = 'A' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS - R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                ELSIF R_CURSOR.IND_DESC_AGRAV = 'D' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS + R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                END IF;
                                --
                                BEGIN
                                    --
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.CORRETOR;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_03       :=      R_CURSOR.cd_assessoria;
                                        relatorio(i_retorno).v_retorno_04       :=      R_CURSOR.SUCURSAL;
                                        relatorio(i_retorno).v_retorno_05       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_06       :=      R_CURSOR.DIRETORIA;
                                        relatorio(i_retorno).v_retorno_07       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.USUARIO;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.STATUS;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.MODULO;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.NEGOCIO;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.ITEM;
                                        relatorio(i_retorno).v_retorno_13       :=      R_CURSOR.IND_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_14       :=      R_CURSOR.VALOR_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_15       :=      P_VL_PRMIO_DEVID_EMISS;
                                        relatorio(i_retorno).v_retorno_16       :=      P_PREMIO_LIQUIDO_NORMAL;
                                        relatorio(i_retorno).v_retorno_17       :=      P_VL_PRMIO_TOTAL_EMISS;
                                        relatorio(i_retorno).v_retorno_18       :=      To_Char(R_CURSOR.Data_transmissao,'dd/mm/yyyy');
                                        relatorio(i_retorno).v_retorno_19       :=      NULL;
                                        relatorio(i_retorno).v_retorno_20       :=      NULL;
                                        relatorio(i_retorno).v_retorno_21       :=      NULL;
                                        relatorio(i_retorno).v_retorno_22       :=      NULL;
                                        relatorio(i_retorno).v_retorno_23       :=      NULL;
                                        relatorio(i_retorno).v_retorno_24       :=      NULL;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     LancamentosDiretoria;
--
END CTACTPA0025_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0026_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       LancamentosSucursal            (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR (p_cd_sucursal IN      number) IS
        --
    SELECT  C.CD_CRTOR_SEGUR_PRCPA      AS CORRETOR,
            D.NM_CRTOR_SEGUR                AS NOME_CORRETOR,
            c.cd_asses                      AS CD_ASSESSORIA,
            c.CD_CRTOR_SEGUR_PRCPA          AS cd_corretor,
            D.CD_SUCSL_COMRL                AS SUCURSAL,
            D.NM_SUCSL                      AS NOME_SUCURSAL,
            C.CD_USURO_CADMT_PPOTA          AS USUARIO,
            C.CD_SITUC_NGOCO                AS STATUS,
            B.CD_MDUPR                      AS MODULO,
            B.CD_NGOCO                      AS NEGOCIO,
            B.NR_ITSEG                      AS ITEM,
            A.TP_AGRVC_DESCT_CRTOR_EMISS    AS IND_DESC_AGRAV,
            VL_TOTAL_AGRVC_DESCT_EMISS      AS VALOR_DESC_AGRAV,
            D.CD_DIRET_COMRL                AS DIRETORIA,
            c.DT_PROCM_RCEL                 AS Data_Transmissao
            FROM    SSV0019_COBTU_ITSEG     A,
                    SSV0076_ITSEG           B,
                    SSV0084_NGOCO           C,
                    CTA0012_CRTOR           D
            WHERE   TP_AGRVC_DESCT_CRTOR_EMISS      IS      NOT     NULL
            AND     DT_PROCM_RCEL   BETWEEN v_dt_ini_vig_verba AND v_dt_fim_vig_verba
            AND     A.NR_ITSEG       =       B.NR_ITSEG
            AND     A.TP_HISTO_ITSEG =       '0'
            AND     B.CD_NGOCO       =       C.CD_NGOCO
            AND     d.cd_sucsl_comrl    =       p_cd_sucursal
            --AND     c.cd_ngoco          =       19643766
            AND     B.TP_HISTO_NGOCO =       '0'
            AND     B.TP_HISTO_ITSEG =       '0'
            AND     C.TP_HISTO       =       '0'
            AND     D.CD_CRTOR_SEGUR =       C.CD_CRTOR_SEGUR_PRCPA
            ORDER BY C.CD_CRTOR_SEGUR_PRCPA;

                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_tipo_produto_lacto    VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_cd_sucursal  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
        P_VL_PRMIO_DEVID_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_DEVID_EMISS%TYPE;
        P_VL_PRMIO_TOTAL_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        P_PREMIO_LIQUIDO_NORMAL SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (261
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        IF      v_parm_tp_local         <>      80      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(1) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(1) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(1) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(2),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Local para seleo:' || v_parm_cd_local);
        --
        v_cd_sucursal           :=      v_parm_cd_local;
        --
        BEGIN
                --
                SELECT  cd_crtor_segur,
                        cd_diret_comrl
                INTO    v_cd_crtor_segur,
                        v_cd_diretoria
                FROM    CTA0012_CRTOR
                WHERE   cd_sucsl_comrl  =       v_cd_sucursal
                AND     ROWNUM  =       1;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Diretoria  encontrada para sucursal:' || v_cd_sucursal || ' corretor ' || v_cd_crtor_segur);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Diretoria no encontrada para sucursal:' || v_cd_sucursal);
                        --
                --
        END;
        --
        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
        --
	FOR     R_CURSOR        IN      C_CURSOR        (v_cd_sucursal)       LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --
                        /*
                                IF      r_cursor.cd_assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.cd_assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cd_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cd_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        */
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'Negocio: ' || r_cursor.negocio);
                        ---
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --
                        IF      r_cursor.modulo IN      (7,9,20)        THEN
                                --
                                v_tipo_produto_lacto  :=      'Automvel';
                                --
                        ELSIF   r_cursor.modulo       IN      (14)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Residencial';
                                --
                        ELSIF   r_cursor.modulo       IN      (12)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Condomnio';
                                --
                        ELSIF   r_cursor.modulo       IN      (11)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Empresarial';
                                --
                        ELSE
                                --
                                v_tipo_produto_lacto  :=      NULL;
                                --
                        END     IF;
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto_lacto: *' || v_tipo_produto_lacto || '*');

                        --
                        IF      v_tipo_produto_lacto    =       Nvl(v_tipo_produto,v_tipo_produto_lacto)
                                --
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.negocio);
                                --
                                SELECT NVL(SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),0),
                                       NVL(SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0)),0)
                                INTO   P_VL_PRMIO_DEVID_EMISS,
                                       P_VL_PRMIO_TOTAL_EMISS
                                FROM  SSV0075_HISTO_VLTAX_COBTU_ITEM VL
                                WHERE VL.NR_ITSEG = R_CURSOR.ITEM
                                AND   VL.SQ_HISTO_COBTU_ITSEG = (
                                      SELECT  MIN(X.SQ_HISTO_COBTU_ITSEG)
                                      FROM    SSV0075_HISTO_VLTAX_COBTU_ITEM X
                                      WHERE   X.NR_ITSEG = R_CURSOR.ITEM
                                );
                                --
                                IF P_VL_PRMIO_DEVID_EMISS = 0 THEN
                                    --
                                    -- VERIFICA REGISTRO NA SSV0117
                                    --
                                    SELECT  SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),
                                            SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0))
                                    INTO    P_VL_PRMIO_DEVID_EMISS,
                                            P_VL_PRMIO_TOTAL_EMISS
                                    FROM SSV0117_VLTAX_COBTU_ITEM VL
                                    WHERE VL.NR_ITSEG = R_CURSOR.ITEM;
                                    --
                                END IF;
                                --
                                IF R_CURSOR.IND_DESC_AGRAV = 'A' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS - R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                ELSIF R_CURSOR.IND_DESC_AGRAV = 'D' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS + R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                END IF;
                                --
                                BEGIN
                                    --
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.CORRETOR;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_03       :=      R_CURSOR.cd_assessoria;
                                        relatorio(i_retorno).v_retorno_04       :=      R_CURSOR.SUCURSAL;
                                        relatorio(i_retorno).v_retorno_05       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_06       :=      R_CURSOR.DIRETORIA;
                                        relatorio(i_retorno).v_retorno_07       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.USUARIO;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.STATUS;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.MODULO;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.NEGOCIO;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.ITEM;
                                        relatorio(i_retorno).v_retorno_13       :=      R_CURSOR.IND_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_14       :=      R_CURSOR.VALOR_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_15       :=      P_VL_PRMIO_DEVID_EMISS;
                                        relatorio(i_retorno).v_retorno_16       :=      P_PREMIO_LIQUIDO_NORMAL;
                                        relatorio(i_retorno).v_retorno_17       :=      P_VL_PRMIO_TOTAL_EMISS;
                                        relatorio(i_retorno).v_retorno_18       :=      To_Char(R_CURSOR.Data_transmissao,'dd/mm/yyyy');
                                        relatorio(i_retorno).v_retorno_19       :=      NULL;
                                        relatorio(i_retorno).v_retorno_20       :=      NULL;
                                        relatorio(i_retorno).v_retorno_21       :=      NULL;
                                        relatorio(i_retorno).v_retorno_22       :=      NULL;
                                        relatorio(i_retorno).v_retorno_23       :=      NULL;
                                        relatorio(i_retorno).v_retorno_24       :=      NULL;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     LancamentosSucursal;
--
END CTACTPA0026_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0027_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       LancamentosProduto            (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR IS
        --
    SELECT  C.CD_CRTOR_SEGUR_PRCPA      AS CORRETOR,
            D.NM_CRTOR_SEGUR                AS NOME_CORRETOR,
            c.cd_asses                      AS CD_ASSESSORIA,
            c.CD_CRTOR_SEGUR_PRCPA          AS cd_corretor,
            D.CD_SUCSL_COMRL                AS SUCURSAL,
            D.NM_SUCSL                      AS NOME_SUCURSAL,
            C.CD_USURO_CADMT_PPOTA          AS USUARIO,
            C.CD_SITUC_NGOCO                AS STATUS,
            B.CD_MDUPR                      AS MODULO,
            B.CD_NGOCO                      AS NEGOCIO,
            B.NR_ITSEG                      AS ITEM,
            A.TP_AGRVC_DESCT_CRTOR_EMISS    AS IND_DESC_AGRAV,
            VL_TOTAL_AGRVC_DESCT_EMISS      AS VALOR_DESC_AGRAV,
            D.CD_DIRET_COMRL                AS DIRETORIA,
            c.DT_PROCM_RCEL                 AS Data_Transmissao
            FROM    SSV0019_COBTU_ITSEG     A,
                    SSV0076_ITSEG           B,
                    SSV0084_NGOCO           C,
                    CTA0012_CRTOR           D
            WHERE   TP_AGRVC_DESCT_CRTOR_EMISS      IS      NOT     NULL
            AND     DT_PROCM_RCEL   BETWEEN v_dt_ini_vig_verba AND v_dt_fim_vig_verba
            AND     A.NR_ITSEG       =       B.NR_ITSEG
            AND     A.TP_HISTO_ITSEG =       '0'
            AND     B.CD_NGOCO       =       C.CD_NGOCO
            AND     B.TP_HISTO_NGOCO =       '0'
            AND     B.TP_HISTO_ITSEG =       '0'
            AND     C.TP_HISTO       =       '0'
            AND     D.CD_CRTOR_SEGUR =       C.CD_CRTOR_SEGUR_PRCPA
            ORDER BY C.CD_CRTOR_SEGUR_PRCPA;

                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_tipo_produto_lacto    VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
        P_VL_PRMIO_DEVID_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_DEVID_EMISS%TYPE;
        P_VL_PRMIO_TOTAL_EMISS  SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        P_PREMIO_LIQUIDO_NORMAL SSV0117_VLTAX_COBTU_ITEM.VL_PRMIO_TOTAL_EMISS%TYPE;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (271
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        /*
        IF      v_parm_tp_local         <>      22      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        */
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(1) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(1) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(1) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(2),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Local para seleo:' || v_parm_cd_local);
        --
        v_cd_diretoria          :=      v_parm_cd_local;
        --
        --
	FOR     R_CURSOR        IN      C_CURSOR        LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --

                                IF      r_cursor.cd_assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.cd_assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cd_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cd_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        --
                        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'Negocio: ' || r_cursor.negocio);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --
                        IF      r_cursor.modulo IN      (7,9,20)        THEN
                                --
                                v_tipo_produto_lacto  :=      'Automvel';
                                --
                        ELSIF   r_cursor.modulo       IN      (14)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Residencial';
                                --
                        ELSIF   r_cursor.modulo       IN      (12)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Condomnio';
                                --
                        ELSIF   r_cursor.modulo       IN      (11)     THEN
                                --
                                v_tipo_produto_lacto  :=      'Empresarial';
                                --
                        ELSE
                                --
                                v_tipo_produto_lacto  :=      NULL;
                                --
                        END     IF;
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto_lacto: *' || v_tipo_produto_lacto || '*');

                        --
                        --IF      v_tipo_produto_lacto    =       Nvl(v_tipo_produto,v_tipo_produto_lacto)        THEN
                                --
                        --        CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                        ,'Produto est igual');
                        --END     IF;
                        --
                        IF      v_tipo_produto_lacto    =       Nvl(v_tipo_produto,v_tipo_produto_lacto)
                                --
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.negocio);
                                --
                                SELECT NVL(SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),0),
                                       NVL(SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0)),0)
                                INTO   P_VL_PRMIO_DEVID_EMISS,
                                       P_VL_PRMIO_TOTAL_EMISS
                                FROM  SSV0075_HISTO_VLTAX_COBTU_ITEM VL
                                WHERE VL.NR_ITSEG = R_CURSOR.ITEM
                                AND   VL.SQ_HISTO_COBTU_ITSEG = (
                                      SELECT  MIN(X.SQ_HISTO_COBTU_ITSEG)
                                      FROM    SSV0075_HISTO_VLTAX_COBTU_ITEM X
                                      WHERE   X.NR_ITSEG = R_CURSOR.ITEM
                                );
                                --
                                IF P_VL_PRMIO_DEVID_EMISS = 0 THEN
                                    --
                                    -- VERIFICA REGISTRO NA SSV0117
                                    --
                                    SELECT  SUM(NVL(VL.VL_PRMIO_DEVID_EMISS, 0)),
                                            SUM(NVL(VL.VL_PRMIO_TOTAL_EMISS, 0))
                                    INTO    P_VL_PRMIO_DEVID_EMISS,
                                            P_VL_PRMIO_TOTAL_EMISS
                                    FROM SSV0117_VLTAX_COBTU_ITEM VL
                                    WHERE VL.NR_ITSEG = R_CURSOR.ITEM;
                                    --
                                END IF;
                                --
                                IF R_CURSOR.IND_DESC_AGRAV = 'A' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS - R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                ELSIF R_CURSOR.IND_DESC_AGRAV = 'D' THEN
                                    --
                                    P_PREMIO_LIQUIDO_NORMAL := P_VL_PRMIO_DEVID_EMISS + R_CURSOR.VALOR_DESC_AGRAV;
                                    --
                                END IF;
                                --
                                BEGIN
                                    --
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.CORRETOR;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_03       :=      R_CURSOR.cd_assessoria;
                                        relatorio(i_retorno).v_retorno_04       :=      R_CURSOR.SUCURSAL;
                                        relatorio(i_retorno).v_retorno_05       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_06       :=      R_CURSOR.DIRETORIA;
                                        relatorio(i_retorno).v_retorno_07       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.USUARIO;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.STATUS;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.MODULO;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.NEGOCIO;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.ITEM;
                                        relatorio(i_retorno).v_retorno_13       :=      R_CURSOR.IND_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_14       :=      R_CURSOR.VALOR_DESC_AGRAV;
                                        relatorio(i_retorno).v_retorno_15       :=      P_VL_PRMIO_DEVID_EMISS;
                                        relatorio(i_retorno).v_retorno_16       :=      P_PREMIO_LIQUIDO_NORMAL;
                                        relatorio(i_retorno).v_retorno_17       :=      P_VL_PRMIO_TOTAL_EMISS;
                                        relatorio(i_retorno).v_retorno_18       :=      To_Char(R_CURSOR.Data_transmissao,'dd/mm/yyyy');
                                        relatorio(i_retorno).v_retorno_19       :=      NULL;
                                        relatorio(i_retorno).v_retorno_20       :=      NULL;
                                        relatorio(i_retorno).v_retorno_21       :=      NULL;
                                        relatorio(i_retorno).v_retorno_22       :=      NULL;
                                        relatorio(i_retorno).v_retorno_23       :=      NULL;
                                        relatorio(i_retorno).v_retorno_24       :=      NULL;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     LancamentosProduto;
--
END ctactpa0027_001;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0028_001 IS
--

FUNCTION retornanmdiretoria (p_cd_diret IN NUMBER)
RETURN VARCHAR2 IS
--
po_locais     acxcdpa0020_001.tab_locais@DBL_APPLKSSVACX01;
po_mensagem   acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
qtde_ocorrencias number(5);
v_chave       VARCHAR2(32);
achou         VARCHAR2(1)     :=      'N';
--
BEGIN
--
        qtde_ocorrencias := 1;
        v_chave := 'RPSSA          2200000000000' || p_cd_diret;
        ACXCDPA0020_001.P_GET_LOCAIS@DBL_APPLKSSVACX01( V_CHAVE , 2 , 1 , 1, po_locais , po_mensagem );
        --
        FOR   i       IN      1..po_mensagem.QTDE_OCORRENCIAS LOOP
              --
              achou   :=      'S';
              --
              RETURN  po_locais(i).nm_loc;
              --
        END   LOOP    ;
        --
        IF    achou   <>      'S'     THEN
              --
              RETURN 'Diretoria no encontrada';
              --
        END   IF;
        --
END;
--
PROCEDURE       VerbasProduto                  (p_parametros    IN      admcta.t_param
                                                ,p_usuario       IN      VARCHAR2
                                                ,p_tp_local      IN      NUMBER
                                                ,p_cd_local      IN      NUMBER
                                                ,relatorio       OUT     t_rec_retorno
                                                ,cd_retorno      OUT     NUMBER
                                                ,msg_retorno     OUT     VARCHAR2)       IS
        --
        --relatorio       t_rec_retorno;
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        --
        v_ds_param_cc   VARCHAR2(100);
        --
        --
        V_ARQUIVO               UTL_FILE.FILE_TYPE;
        V_NM_ARQ                VARCHAR2(4000);
        V_AMBIENTE              VARCHAR2(4000);
        V_INDX                  NUMBER;
        V_FAULT_A               TMS_STORAGE.R_REQUEST_FAULT;
        V_CORRELATION_ID        TMS_UTIL.CORRELATION_ID;
        V_BODY                  CLOB;
        V_BLOB                  BLOB;
        V_FILE                  TMS_MAIL.FILE_TYPE;
        V_TO                    TMS_MAIL.ADDRESS_TYPE;
        V_CC                    TMS_MAIL.ADDRESS_TYPE;
        V_BCC                   TMS_MAIL.ADDRESS_TYPE;
        V_CD_CRTOR_SEGUR        CTA0002_VERBA.CD_CRTOR_SEGUR%TYPE;
        V_CD_SUCSL_COMRL        CTA0002_VERBA.CD_SUCSL_COMRL%TYPE;
        V_CD_ASSES              CTA0002_VERBA.CD_ASSES%TYPE;
        V_CD_DIRET_COMRL        CTA0002_VERBA.CD_DIRET_COMRL%TYPE;
        V_ID_VERBA_DESTINO      CTA0002_VERBA.ID_VERBA_ORIGM_TRNSF%TYPE;
        V_CD_USURO_ULTMA_ALTER  CTA0002_VERBA.CD_USURO_ULTMA_ALTER%TYPE;
        --V_DATA_INI              VARCHAR2(10) := '01/04/2012';
        --V_DATA_FIM              VARCHAR2(10) := '30/04/2012';
        V_TIPO_DISTRIBUICAO     VARCHAR(100);
        V_TIPO_DISTRIBUICAO_P   VARCHAR(100);
        V_ESTORNO               VARCHAR(3);
        V_NOME_ARQUIVO          VARCHAR(100);
        v_dt_ini_vig_verba      DATE;
        v_dt_fim_vig_verba      DATE;

        --
CURSOR C_CURSOR IS
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            C.CD_ASSES AS ASSESSORIA,
            C.CD_SUCSL_COMRL AS COD_SUCURSAL,
            C.NM_SUCSL AS NOME_SUCURSAL,
            V.CD_DIRET_COMRL AS CD_DIRETORIA,
            RETORNANMDIRETORIA(V.CD_DIRET_COMRL) AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    UNION
    SELECT  V.ID_VERBA AS ID_VERBA,
            V.ID_VERBA_ORIGM_TRNSF AS ID_VERBA_ORIGEM,
            S.NM_SEGMT_PRDUT AS SEGMENTO,
            V.CD_CRTOR_SEGUR AS COD_CORRETOR,
            C.NM_CRTOR_SEGUR AS NOME_CORRETOR,
            V.CD_ASSES AS ASSESSORIA,
            CASE WHEN  V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_SUCSL_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) ELSE V.CD_SUCSL_COMRL END AS COD_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.NM_SUCSL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL THEN (SELECT SUC.NM_SUCSL FROM CTA0012_CRTOR SUC WHERE SUC.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM  = 1) WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NOT NULL THEN '' ELSE '' END AS NOME_SUCURSAL,
            CASE WHEN V.CD_SUCSL_COMRL IS NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1) WHEN V.CD_SUCSL_COMRL IS NOT NULL AND V.CD_DIRET_COMRL IS NULL THEN (SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1) ELSE V.CD_DIRET_COMRL END AS CD_DIRETORIA,
            CASE WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NOT NULL THEN RETORNANMDIRETORIA((SELECT DIRET.CD_DIRET_COMRL FROM CTA0012_CRTOR DIRET WHERE DIRET.CD_SUCSL_COMRL = V.CD_SUCSL_COMRL AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NULL AND V.CD_SUCSL_COMRL IS NULL THEN RETORNANMDIRETORIA((SELECT ASSESSORIA.CD_DIRET_COMRL FROM CTA0012_CRTOR ASSESSORIA  WHERE ASSESSORIA.CD_ASSES = V.CD_ASSES AND ROWNUM = 1)) WHEN V.CD_DIRET_COMRL IS NOT NULL THEN RETORNANMDIRETORIA(V.CD_DIRET_COMRL) ELSE NULL END AS NM_DIRETORIA,
            T.NM_TIPO_VERBA AS TIPO_VERBA,
            V.VL_INICL_VERBA AS VALOR_INICIAL,
            V.VL_PRVSN_VERBA AS VALOR_PROVISIONADO,
            V.VL_EFTDO_VERBA AS VALOR_EFETIVADO,
            V.VL_CRDIT_AGRVO AS VALOR_CREDITO_AGRAVO_BLOQUEADO,
            V.VL_TRNSF_CRTRS AS VALOR_TRANSFERENCIA_CREDITO,
            V.VL_TRNSF_DEBIT AS VALOR_TRANSFERENCIA_DEBITO,
            V.VL_SALDO_VERBA AS VALOR_SALDO,
            V.DT_INICO_VIGEN AS INICIO_VIGENCIA,
            V.DT_FIM_VIGEN AS FIM_VIGENCIA,
            V.CD_SITUC_VERBA AS STATUS_VERBA
    FROM    CTA0002_VERBA V,
            CTA0006_SEGMT_PRDUT S,
            CTA0012_CRTOR C,
            CTA0003_TIPO_VERBA T
    WHERE   V.DT_INICO_VIGEN BETWEEN  v_dt_ini_vig_verba AND v_dt_fim_vig_verba
    AND     S.CD_SEGMT_PRDUT = V.CD_SEGMT_PRDUT
    AND     C.CD_CRTOR_SEGUR(+) = V.CD_CRTOR_SEGUR
    AND     T.CD_TIPO_VERBA = V.CD_TIPO_VERBA
    AND     C.CD_CRTOR_SEGUR IS      NULL
    ORDER BY COD_CORRETOR, ASSESSORIA, COD_SUCURSAL, CD_DIRETORIA;
                --
                v_parm_tp_local     NUMBER;
                v_parm_cd_local     NUMBER;
                --
        v_proxima       EXCEPTION;
        --
        v_tipo_verba    VARCHAR2(400);
        v_tipo_produto  VARCHAR2(400);
        v_cd_diretoria  NUMBER  (4);
        v_nm_diretoria  VARCHAR2(400);
        v_achou         VARCHAR2(1);
        v_sq_log                NUMBER;
        v_valor_utilizado       NUMBER;
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (281
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        BEGIN
                SELECT  DS_PARAM_CC
                INTO    v_ds_param_cc
                FROM    cta0008_param_cc
                WHERE   NM_PARAM_CC     =       p_usuario;
                --
                v_parm_tp_local    :=      SubStr(v_ds_param_cc,1,InStr(v_ds_param_cc,';')-1);
                --
                v_parm_cd_local    :=      SubStr(v_ds_param_cc,InStr(v_ds_param_cc,';')+1,length(v_ds_param_cc));
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Encontrou usuario na tabela de parametro. Tipo: ' || v_parm_tp_local || ' Local: ' || v_parm_cd_local);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_parm_tp_local :=      p_tp_local;
                        v_parm_cd_local :=      p_cd_local;
                --
        END;
        --
        /*
        IF      v_parm_tp_local         <>      80      THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Usuario no  diretoria. Local: ' || v_parm_tp_local;
                --
                RETURN;
                --
        END     IF;
        */
        --
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        --V_NM_ARQ        :=      'RELATORIO_CTA.CSV';

        --
        --V_ARQUIVO       :=      UTL_FILE.FOPEN  ('DIR_RECEPCAO'
        --                                        ,V_NM_ARQ
        --                                        ,'W');
        --
        --UTL_FILE.PUT_LINE       (V_ARQUIVO
        --                        ,'ID_VERBA;ID_VERBA_ORIGEM;ARQUIVO_CARGA;ESTORNO;DISTRIBUIDO POR;DISTRIBUIDO PARA;SEGMENTO;COD_CORRETOR;NOME_CORRETOR;ASSESSORIA;COD_SUCURSAL;NOME_SUCURSAL;CD_DIRETORIA;NM_DIRETORIA;TIPO_VERBA;VALOR_INICIAL;VALOR_PROVISIONADO;VALOR_EFETIVADO;VALOR_CREDITO_AGRAVO_BLOQUEADO;VALOR_TRANSFERENCIA_CREDITO;VALOR_TRANSFERENCIA_DEBITO;VALOR_SALDO;INICIO_VIGENCIA;FIM_VIGENCIA;STATUS_VERBA;');
        --
        IF      p_parametros(1) NOT     IN      ('C','T')       THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      'Tipo verba invalida. Tipo informado: ' || p_parametros(1);
                --
                RETURN;
                --
        END     IF;
        --
        IF      p_parametros(1) =       'C'     THEN
                --
                v_tipo_verba    :=      'Corretor';
                --
        ELSIF   p_parametros(1) =       'T'     THEN
                --
                v_tipo_verba    :=      'Tokio';
                --
        ELSE
                --
                v_tipo_verba    :=      NULL;
                --
        END     IF;
        --
        IF      p_parametros(2) =       'AU'     THEN
                --
                v_tipo_produto  :=      'Automvel';
                --
        ELSIF   p_parametros(2) =       'RE'     THEN
                --
                v_tipo_produto  :=      'Residencial';
                --
        ELSIF   p_parametros(2) =       'CO'     THEN
                --
                v_tipo_produto  :=      'Condomnio';
                --
        ELSIF   p_parametros(2) =       'EM'     THEN
                --
                v_tipo_produto  :=      'Empresarial';
                --
        ELSE
                --
                v_tipo_produto  :=      NULL;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 4:' || p_parametros(4));
        --
        v_dt_ini_vig_verba      :=      To_Date(p_parametros(3),'dd/mm/yyyy');
        --
        v_dt_fim_vig_verba      :=      To_Date(p_parametros(4),'dd/mm/yyyy');
        --
        --CTACTPA0100_001.GravaLog        (v_sq_log
        --                                ,'Local para seleo:' || v_parm_cd_local);
        --
	FOR     R_CURSOR        IN      C_CURSOR        LOOP
		--
                BEGIN
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'*******************************');
                        --
                        -- Busca Codigo da Diretoria
                        --
                        IF      r_cursor.cd_diretoria   IS      NULL    THEN
                                --
                                IF      r_cursor.assessoria     IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_asses     =       r_cursor.assessoria
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSIF   r_cursor.cod_corretor   IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  a.cd_diret_comrl
                                                INTO    v_cd_diretoria
                                                FROM    cta0012_crtor   a
                                                WHERE   a.cd_crtor_segur        =       r_cursor.cod_corretor
                                                AND     ROWNUM = 1;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        v_cd_diretoria  :=      0;
                                        END;
                                        --
                                ELSE
                                        --
                                        v_cd_diretoria  :=      0;
                                        --
                                END     IF;
                                --
                        ELSE
                                --
                                v_cd_diretoria  :=      r_cursor.cd_diretoria;
                                --
                        END     IF;
                        --
                        v_nm_diretoria  :=      RETORNANMDIRETORIA(v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_cd_diretoria: ' || v_cd_diretoria);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_verba: *' || v_tipo_verba || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.TIPO_VERBA: ' || r_cursor.TIPO_VERBA);
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'v_tipo_produto: *' || v_tipo_produto || '*');
                        --
                        --CTACTPA0100_001.GravaLog        (v_sq_log
                        --                                ,'r_cursor.SEGMENTO: ' || r_cursor.SEGMENTO);
                        --
                        --
                        IF      r_cursor.TIPO_VERBA     =       Nvl(v_tipo_verba,r_cursor.TIPO_VERBA)
                        AND     r_cursor.SEGMENTO       =       Nvl(v_tipo_produto,r_cursor.SEGMENTO)
                                THEN
                                --
                                --CTACTPA0100_001.GravaLog        (v_sq_log
                                --                                ,'Entrou no criterio de seleo. Id verba' || r_cursor.id_verba);
                                --
                                v_achou :=      'S';
                                --
                                V_ESTORNO := 'N';
                                --
                                BEGIN
                                    --
                                    IF R_CURSOR.ID_VERBA_ORIGEM IS NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                        --
                                    ELSE
                                        --
                                        BEGIN
                                            --
                                            SELECT  CD_USURO_ULTMA_ALTER
                                            INTO    V_CD_USURO_ULTMA_ALTER
                                            FROM    CTA0002_VERBA
                                            WHERE   ID_VERBA = R_CURSOR.ID_VERBA;
                                              --
                                              IF V_CD_USURO_ULTMA_ALTER = 'ESTORNO' THEN
                                                  --
                                                  V_ESTORNO           := 'S';
                                                  --
                                              ELSE
                                                  --
                                                  V_ESTORNO           := 'N';
                                                  --
                                              END IF;
                                              --
                                              SELECT  CD_CRTOR_SEGUR,
                                                      CD_SUCSL_COMRL,
                                                      CD_ASSES,
                                                      CD_DIRET_COMRL,
                                                      ID_VERBA_ORIGM_TRNSF
                                              INTO    V_CD_CRTOR_SEGUR,
                                                      V_CD_SUCSL_COMRL,
                                                      V_CD_ASSES,
                                                      V_CD_DIRET_COMRL,
                                                      V_ID_VERBA_DESTINO
                                              FROM    CTA0002_VERBA
                                              WHERE   ID_VERBA = R_CURSOR.ID_VERBA_ORIGEM;
                                              --
                                              IF V_ESTORNO = 'S' AND V_ID_VERBA_DESTINO IS NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'PRODUTO';
                                                  --
                                              ELSIF V_CD_CRTOR_SEGUR IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'CORRETOR';
                                                  --
                                              ELSIF V_CD_ASSES IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'ASSESSORIA';
                                                  --
                                              ELSIF V_CD_SUCSL_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'SUCURSAL';
                                                  --
                                              ELSIF V_CD_DIRET_COMRL IS NOT NULL THEN
                                                  --
                                                  V_TIPO_DISTRIBUICAO := 'DIRETORIA';
                                                  --
                                              END IF;
                                              --
                                        EXCEPTION
                                            --
                                            WHEN OTHERS THEN
                                              --
                                              V_TIPO_DISTRIBUICAO := 'DESCONHECIDO';
                                              --
                                        END;
                                        --
                                    END IF;
                                    --
                                    IF R_CURSOR.COD_CORRETOR IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'CORRETOR';
                                        --
                                    ELSIF R_CURSOR.ASSESSORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'ASSESSORIA';
                                        --
                                    ELSIF R_CURSOR.COD_SUCURSAL IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'SUCURSAL';
                                        --
                                    ELSIF R_CURSOR.CD_DIRETORIA IS NOT NULL THEN
                                        --
                                        V_TIPO_DISTRIBUICAO_P := 'DIRETORIA';
                                        --
                                    END IF;
                                    --
                                    V_NOME_ARQUIVO := ADMCTA.ARQUIVO_CARGA(R_CURSOR.ID_VERBA);
                                    --
                                    v_valor_utilizado   :=      R_CURSOR.VALOR_PROVISIONADO     +       R_CURSOR.VALOR_EFETIVADO;
                                                --
                                    IF  r_cursor.valor_inicial                  =       0       AND
                                        v_valor_utilizado                       =       0       AND
                                        r_cursor.valor_credito_agravo_bloqueado =       0       AND
                                        r_cursor.valor_saldo                    =       0       THEN
                                        --
                                        RAISE   v_proxima;
                                        --
                                    ELSE
                                        --
                                        --
                                        -- Dbms_Output.Put_Line('vai formatar o type');
                                        --
                                        i_retorno       :=      i_retorno       +       1;
                                        --
                                        relatorio(i_retorno).v_retorno_01       :=      R_CURSOR.ID_VERBA;
                                        relatorio(i_retorno).v_retorno_02       :=      R_CURSOR.ID_VERBA_ORIGEM;
                                        relatorio(i_retorno).v_retorno_03       :=      V_NOME_ARQUIVO;
                                        relatorio(i_retorno).v_retorno_04       :=      V_ESTORNO;
                                        relatorio(i_retorno).v_retorno_05       :=      V_TIPO_DISTRIBUICAO;
                                        relatorio(i_retorno).v_retorno_06       :=      V_TIPO_DISTRIBUICAO_P;
                                        relatorio(i_retorno).v_retorno_07       :=      R_CURSOR.SEGMENTO;
                                        relatorio(i_retorno).v_retorno_08       :=      R_CURSOR.COD_CORRETOR;
                                        relatorio(i_retorno).v_retorno_09       :=      R_CURSOR.NOME_CORRETOR;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.ASSESSORIA;
                                        relatorio(i_retorno).v_retorno_11       :=      R_CURSOR.COD_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_12       :=      R_CURSOR.NOME_SUCURSAL;
                                        relatorio(i_retorno).v_retorno_13       :=      v_cd_diretoria;
                                        relatorio(i_retorno).v_retorno_14       :=      v_nm_diretoria;
                                        relatorio(i_retorno).v_retorno_15       :=      R_CURSOR.TIPO_VERBA;
                                        relatorio(i_retorno).v_retorno_16       :=      R_CURSOR.VALOR_INICIAL;
                                        relatorio(i_retorno).v_retorno_17       :=      v_valor_utilizado;
                                        relatorio(i_retorno).v_retorno_18       :=      R_CURSOR.VALOR_CREDITO_AGRAVO_BLOQUEADO;
                                        relatorio(i_retorno).v_retorno_10       :=      R_CURSOR.VALOR_TRANSFERENCIA_CREDITO;
                                        relatorio(i_retorno).v_retorno_20       :=      R_CURSOR.VALOR_TRANSFERENCIA_DEBITO;
                                        relatorio(i_retorno).v_retorno_21       :=      R_CURSOR.VALOR_SALDO;
                                        relatorio(i_retorno).v_retorno_22       :=      TO_CHAR(R_CURSOR.INICIO_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_23       :=      TO_CHAR(R_CURSOR.FIM_VIGENCIA, 'DD/MM/YYYY');
                                        relatorio(i_retorno).v_retorno_24       :=      R_CURSOR.STATUS_VERBA;
                                        relatorio(i_retorno).v_retorno_25       :=      NULL;
                                        relatorio(i_retorno).v_retorno_26       :=      NULL;
                                        relatorio(i_retorno).v_retorno_27       :=      NULL;
                                        relatorio(i_retorno).v_retorno_28       :=      NULL;
                                        relatorio(i_retorno).v_retorno_29       :=      NULL;
                                        relatorio(i_retorno).v_retorno_30       :=      NULL;
                                        relatorio(i_retorno).v_retorno_31       :=      NULL;
                                        relatorio(i_retorno).v_retorno_32       :=      NULL;
                                        relatorio(i_retorno).v_retorno_33       :=      NULL;
                                        relatorio(i_retorno).v_retorno_34       :=      NULL;
                                        relatorio(i_retorno).v_retorno_35       :=      NULL;
                                        relatorio(i_retorno).v_retorno_36       :=      NULL;
                                        relatorio(i_retorno).v_retorno_37       :=      NULL;
                                        relatorio(i_retorno).v_retorno_38       :=      NULL;
                                        relatorio(i_retorno).v_retorno_39       :=      NULL;
                                        relatorio(i_retorno).v_retorno_40       :=      NULL;
                                        --
                                END     IF;
                                --
                                EXCEPTION
                                        --
                                        WHEN    v_proxima       THEN
                                                --
                                                NULL;
                                                --
                                        WHEN OTHERS THEN
                                        --
                                        DBMS_OUTPUT.PUT_LINE('ERRO');
                                        --
                                END;
                                --
                        END     IF;
                        --
                EXCEPTION
                        --
                        WHEN    v_proxima       THEN
                                --
                                NULL;
                                --
                        WHEN OTHERS THEN
                        --
                        DBMS_OUTPUT.PUT_LINE('ERRO');
                        --
                --
                END;
                --
	END LOOP;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Linhas Geradas: ' || i_retorno);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                         'Final execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')     ||Chr(10)||
                                         LPad('=',      80,     '='));
        --
        CTACTPA0100_001.FinalizaLog     (v_sq_log);
        --
        IF      v_achou =      'S'     THEN
                --
                Dbms_Output.Put_Line('ACHOU');
                --
        END     IF;
	--
--
END     VerbasProduto;
--
END ctactpa0028_001;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0029_ERRO_65 IS
--

PROCEDURE       Gera_Planilha                   (p_parametros    IN      admcta.t_param,
                                                p_usuario       IN      VARCHAR2,
                                                p_tp_local      IN      NUMBER,
                                                p_cd_local      IN      NUMBER,
                                                relatorio       OUT     t_rec_retorno,
                                                cd_retorno      OUT     NUMBER,
                                                msg_retorno     OUT     VARCHAR2)  as
        --
        v_linha NUMBER;
        --
        v_dt_ini_periodo        DATE;
        v_dt_fim_periodo        DATE;
        --
        CURSOR  c_auto  IS
                --
                SELECT  PROPOSTA ,
                        To_Char(DATA,'dd/mm/yyyy') Data ,
                        PERIODO  ,
                        ERRO  ,
                        CLIENTE ,
                        CORRETOR ,
                        MODULO ,
                        NEGOCIO  ,
                        CALCULO_KCW  ,
                        VALOR_KCW ,
                        VALOR_RECEPCAO,
                        DIFERENCA  ,
                        SISTEMA_A_MENOR  ,
                        a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA Causa,
                        Decode(STATUS_PROBLEMA,'R','Resolvido','P','Pendente',STATUS_PROBLEMA) Status ,
                        SISTEMA_CAUSADOR_PROBLEMA,
                        c.cd_sucsl_comrl Sucursal,
                        f327140.retornanmsucursal(c.cd_local_captc) NomeSucursal
                FROM    f327140.erro_65_planilha        a,
                        f327140.erro_65_causa           b,
                        ssv0084_ngoco           c
                WHERE   a.id_causa_diferenca =       b.id_causa_diferenca
                AND     a.negocio               =       c.cd_ngoco      (+)
                AND     Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),a.id_causa_diferenca) =       a.id_causa_diferenca
                AND     a.modulo          IN      (7,9,20)
                ORDER BY  DATA, periodo, id_ppota_contr;
        --
        CURSOR  c_multi IS
                --
                SELECT  PROPOSTA ,
                        To_Char(DATA,'dd/mm/yyyy') Data ,
                        PERIODO  ,
                        ERRO  ,
                        CLIENTE ,
                        CORRETOR ,
                        MODULO ,
                        NEGOCIO  ,
                        CALCULO_KCW  ,
                        VALOR_KCW ,
                        VALOR_RECEPCAO,
                        DIFERENCA  ,
                        SISTEMA_A_MENOR  ,
                        a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA Causa,
                        Decode(STATUS_PROBLEMA,'R','Resolvido','P','Pendente',STATUS_PROBLEMA) Status ,
                        SISTEMA_CAUSADOR_PROBLEMA,
                        c.cd_sucsl_comrl Sucursal,
                        f327140.retornanmsucursal(c.cd_local_captc) NomeSucursal
                FROM    f327140.erro_65_planilha        a,
                        f327140.erro_65_causa           b,
                        ssv0084_ngoco           c
                WHERE   a.id_causa_diferenca =       b.id_causa_diferenca
                AND     a.negocio               =       c.cd_ngoco      (+)
                AND     Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),a.id_causa_diferenca) =       a.id_causa_diferenca
                AND     a.modulo          NOT   IN      (7,9,20)
                ORDER BY  DATA, periodo, id_ppota_contr;
        --
        CURSOR  c_auto_agrupado IS
                --
                SELECT  a.id_causa_diferenca, 'Cod.' || a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA LiteralCausaDiferenca, Count(1) contador
                FROM    f327140.erro_65_planilha        a,
                        f327140.erro_65_causa           b,
                        ssv0084_ngoco           c
                WHERE   a.id_causa_diferenca =       b.id_causa_diferenca
                AND     a.negocio               =       c.cd_ngoco      (+)
                AND     Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),a.id_causa_diferenca) =       a.id_causa_diferenca
                AND     a.modulo          IN      (7,9,20)
                GROUP BY a.id_causa_diferenca , 'Cod.' || a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA
                ORDER BY a.id_causa_diferenca;
        --
        CURSOR  c_mr_agrupado IS
                --
                SELECT  a.id_causa_diferenca ,'Cod.' || a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA LiteralCausaDiferenca, Count(1) contador
                FROM    f327140.erro_65_planilha        a,
                        f327140.erro_65_causa           b,
                        ssv0084_ngoco           c
                WHERE   a.id_causa_diferenca =       b.id_causa_diferenca
                AND     a.negocio               =       c.cd_ngoco      (+)
                AND     Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),a.id_causa_diferenca) =       a.id_causa_diferenca
                AND     a.modulo          NOT IN        (7,9,20)
                GROUP BY a.id_causa_diferenca , 'Cod.' || a.id_causa_diferenca || '-' || DESCRICAO_CAUSA_DIFERENCA
                ORDER BY a.id_causa_diferenca;
        --
        v_dif_auto_kcw_menor    NUMBER;
        v_dif_auto_kcw_maior    NUMBER;
        v_dif_MR_kcw_menor    NUMBER;
        v_dif_MR_kcw_maior    NUMBER;
        v_blob                  BLOB;
        v_nm_arq                VARCHAR2(4000);
        v_fault_a               tms_storage.r_request_fault;
        v_correlation_id        tms_util.correlation_id;
        v_body                  CLOB;
        v_file                  tms_mail.file_type;
        v_to                    tms_mail.address_type;
        v_cc                    tms_mail.address_type;
        v_bcc                   tms_mail.address_type;
        --
        v_destinatarios         VARCHAR2(4000);
        v_destinatarios_cc      VARCHAR2(4000);
        v_ambiente              VARCHAR2(4000);
        v_indx                  NUMBER;
        v_css                   CLOB;
        v_cabecalho             CLOB;
        v_assinatura            CLOB;
        v_date                  DATE;
        v_sq_log                NUMBER;
        v_cont_param_4          NUMBER;
        v_descricao_causa_diferenca     VARCHAR2(4000);
        --
        cedilha                 VARCHAR2(40)    :=      Chr(294)||'ccedil;';
        atil                    VARCHAR2(40)    :=      Chr(294)||'atilde;';
        otil                    VARCHAR2(40)    :=      Chr(294)||'otilde;';
        ocirc                   VARCHAR2(40)    :=      Chr(294)||'ocirc;';
        ecirc                   VARCHAR2(40)    :=      Chr(294)||'ecirc;';
        aagudo                  VARCHAR2(40)    :=      Chr(294)||'aacute;';
        iagudo                  VARCHAR2(40)    :=      Chr(294)||'iacute;';
        oagudo                  VARCHAR2(40)    :=      Chr(294)||'oacute;';
        --
        v_texto1                VARCHAR2(4000);
        v_texto2                VARCHAR2(4000);
        v_texto3                VARCHAR2(4000);
        v_texto4                VARCHAR2(4000);
        v_texto5                VARCHAR2(4000);
        --
        v_cont_auto             NUMBER;
        v_cont_MR               NUMBER;
        v_execucao_eventual     VARCHAR2(50)            :=      ' (execu' || cedilha || atil || 'o eventual)';
        v_execucao_eventual_titulo      VARCHAR2(50)    :=      ' (execuo eventual)';
        --
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (291
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));
	--
        V_AMBIENTE              :=      TMS_PARAM.GET_PARAM             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        IF      p_parametros(1) IS      NOT     NULL                    AND
                p_parametros(1) NOT     IN      ('AU','MR','DIARIA')    THEN
                --
                cd_retorno      :=      1;
                msg_retorno     :=      '(' || v_sq_log || ') Tipo de produto invlido. Tipo informado: ' || p_parametros(1);
                --
                RETURN;
                --
        END     IF;
        --
        IF      p_parametros(1) =       'DIARIA'        THEN
                --
                v_execucao_eventual             :=      NULL;
                v_execucao_eventual_titulo      :=      NULL;
                --
        END     IF;
        --
        IF      p_parametros(4) IS      NOT     NULL    THEN
                --
                BEGIN
                        --
                        SELECT  Count(1)
                        INTO    v_cont_param_4
                        FROM    f327140.erro_65_causa
                        WHERE   id_causa_diferenca      =       p_parametros(4);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                cd_retorno      :=      2;
                                msg_retorno     :=      '(' || v_sq_log || ') Id causa diferena no cadastrado. Id causa informado: ' || p_parametros(4) || SQLERRM;
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'Id causa diferena no cadastrado. Id causa informado: ' || p_parametros(4));

                                RETURN;
                                --
                END;
                --
                IF      v_cont_param_4  =       0       THEN
                        --
                        cd_retorno      :=      5;
                        msg_retorno     :=      '(' || v_sq_log || ') Id causa diferena no cadastrado. Id causa informado: ' || p_parametros(4) ;
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Id causa diferena no cadastrado. Id causa informado: ' || p_parametros(4));
                        --
                        RETURN;
                        --
                END     IF;
                --
        END     IF;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Quantidade de Parametros:' || p_parametros.count);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 1:' || p_parametros(1));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 2:' || p_parametros(2));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 3:' || p_parametros(3));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Parametro 4:' || p_parametros(4));
        --
        BEGIN
                --
                v_dt_ini_periodo        :=      To_Date(p_parametros(2),'dd/mm/yyyy');
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        cd_retorno      :=      3;
                        msg_retorno     :=      '(' || v_sq_log || ') Inicio periodo invlido: ' || p_parametros(2);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Inicio periodo invlido: ' || p_parametros(2));

                        RETURN;
        END;
        --
        BEGIN
                --
                v_dt_fim_periodo        :=      To_Date(p_parametros(3),'dd/mm/yyyy');
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        cd_retorno      :=      4;
                        msg_retorno     :=      '(' || v_sq_log || ') Fim periodo invlido: ' || p_parametros(3);
                        --
                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Fim periodo invlido: ' || p_parametros(3));

                        --
                        RETURN;
        END;
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Data Inicio: ' || To_Char(v_dt_ini_periodo,'dd/mm/yyyy'));
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Data Fim: ' || To_Char(v_dt_fim_periodo,'dd/mm/yyyy'));
        --
        BEGIN
                --
                SELECT  Count(1)
                INTO    v_cont_auto
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                IN      (7,9,20);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_cont_auto     :=      0;
                        --
        END;
        --
        BEGIN
                --
                SELECT  Count(1)
                INTO    v_cont_MR
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                NOT IN      (7,9,20);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_cont_MR       :=      0;
                        --
        END;
        --
        BEGIN
                --
                SELECT  Sum(diferenca)
                INTO    v_dif_auto_kcw_menor
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                IN      (7,9,20)
                AND     a.SISTEMA_A_MENOR       =       'KCW';
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_dif_auto_kcw_menor    :=      0;
                        --
        END;
        --
        BEGIN
                --
                SELECT  Sum(diferenca)
                INTO    v_dif_auto_kcw_maior
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                IN      (7,9,20)
                AND     a.SISTEMA_A_MENOR       =       'SSV';
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_dif_auto_kcw_maior    :=      0;
                        --
        END;
        --
        BEGIN
                --
                SELECT  Sum(diferenca)
                INTO    v_dif_MR_kcw_menor
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                NOT     IN      (7,9,20)
                AND     a.SISTEMA_A_MENOR       =       'KCW';
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_dif_MR_kcw_menor    :=      0;
                        --
        END;
        --
        BEGIN
                --
                SELECT  Sum(diferenca)
                INTO    v_dif_MR_kcw_maior
                FROM    f327140.erro_65_planilha        a
                WHERE   Trunc(a.data)           BETWEEN v_dt_ini_periodo        AND     v_dt_fim_periodo
                AND     Nvl(p_parametros(4),id_causa_diferenca) =       id_causa_diferenca
                AND     a.modulo                NOT     IN      (7,9,20)
                AND     a.SISTEMA_A_MENOR       =       'SSV';
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        v_dif_MR_kcw_maior    :=      0;
                        --
        END;
        --
        IF      Nvl(p_parametros(1),' ')        <>      'DIARIA'        THEN
                --
                ssvrppa0026_001.new_sheet     ('Parmetros');
                --
                v_linha :=      1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,1 -- linha
                                                ,3 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Parmetros de Entrada'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       2;
                --
                ssvrppa0026_001.set_column_width        (1
                                                        ,27);
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Produto:'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.set_column_width        (2
                                                        ,12);
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,Nvl(p_parametros(1),'(todos)')
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Data Incio:'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,p_parametros(2)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Data Fim:'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,p_parametros(3)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Causa Diferena de Prmio:'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,Nvl(p_parametros(4),'(todas)')
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                BEGIN
                        --
                        SELECT  descricao_causa_diferenca
                        INTO    v_descricao_causa_diferenca
                        FROM    f327140.erro_65_causa
                        WHERE   id_causa_diferenca      =       p_parametros(4);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_descricao_causa_diferenca     :=      NULL;
                                --
                END;
                --
                ssvrppa0026_001.cell    (3
                                        ,v_linha
                                        ,v_descricao_causa_diferenca
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Solicitante:'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,p_usuario
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
        END     IF;
        --
        IF      p_parametros(1) IS      NULL            OR
                p_parametros(1) =       'DIARIA'        OR
                p_parametros(1) =       'AU'            THEN
                --
                v_linha :=      1;
                --
                --      Aba automvel
                --
                ssvrppa0026_001.new_sheet     ('Dados Auto');
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,1 -- linha
                                                ,18 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Anlise de Diferenas - Auto -  Erros 65 (Geral) e 1056 (Santander)'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena KCW Menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_auto_kcw_menor,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                ssvrppa0026_001.cell    (6
                                        ,v_linha
                                        ,v_sq_log
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE, p_rgb   =>      'FFFFFF') -- Imprime em branco
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena Recepo Menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_auto_kcw_maior,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena Geral'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_auto_kcw_menor,0) + Nvl(v_dif_auto_kcw_maior,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       2;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Proposta'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (2
                                                        ,12);
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,'Data'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (3
                                        ,v_linha
                                        ,'Perodo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (4
                                        ,v_linha
                                        ,'Erro'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (5
                                                        ,50);
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,'Cliente'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (6
                                        ,v_linha
                                        ,'Corretor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (7
                                        ,v_linha
                                        ,'Mdulo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (8
                                        ,v_linha
                                        ,'Negcio'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (9
                                                        ,12);
                --
                ssvrppa0026_001.cell    (9
                                        ,v_linha
                                        ,'Clculo KCW'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (10
                                                        ,15);
                --
                ssvrppa0026_001.cell    (10
                                        ,v_linha
                                        ,'Valor KCW'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (11
                                                        ,15);
                --
                ssvrppa0026_001.cell    (11
                                        ,v_linha
                                        ,'Valor Recepo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (12
                                        ,v_linha
                                        ,'Diferena'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (13
                                                        ,20);
                --
                ssvrppa0026_001.cell    (13
                                        ,v_linha
                                        ,'Sistema a menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (14
                                                        ,80);
                --
                ssvrppa0026_001.cell    (14
                                        ,v_linha
                                        ,'Causa Diferena'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (15
                                                        ,15);
                --
                ssvrppa0026_001.cell    (15
                                        ,v_linha
                                        ,'Status'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (16
                                                        ,16);
                --
                ssvrppa0026_001.cell    (16
                                        ,v_linha
                                        ,'Sistema Causador'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (17
                                                        ,12);
                --
                ssvrppa0026_001.cell    (17
                                        ,v_linha
                                        ,'CdSucursal'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (18
                                                        ,30);
                --
                ssvrppa0026_001.cell    (18
                                        ,v_linha
                                        ,'NomeSucursal'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                FOR     r_auto  IN      c_auto  LOOP
                        --
                        v_linha :=      v_linha +       1;
                        --
                        ssvrppa0026_001.cell    (1
                                                ,v_linha
                                                ,r_auto.proposta
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (2
                                                ,v_linha
                                                ,r_auto.data
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (3
                                                ,v_linha
                                                ,r_auto.periodo
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (4
                                                ,v_linha
                                                ,r_auto.erro
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (5
                                                ,v_linha
                                                ,r_auto.cliente
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (6
                                                ,v_linha
                                                ,r_auto.corretor
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (7
                                                ,v_linha
                                                ,r_auto.modulo
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (8
                                                ,v_linha
                                                ,r_auto.negocio
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (9
                                                ,v_linha
                                                ,r_auto.calculo_kcw
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (10
                                                ,v_linha
                                                ,r_auto.valor_kcw
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (11
                                                ,v_linha
                                                ,r_auto.valor_recepcao
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (12
                                                ,v_linha
                                                ,r_auto.diferenca
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (13
                                                ,v_linha
                                                ,r_auto.sistema_a_menor
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (14
                                                ,v_linha
                                                ,r_auto.causa
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (15
                                                ,v_linha
                                                ,r_auto.status
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (16
                                                ,v_linha
                                                ,r_auto.sistema_causador_problema
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (17
                                                ,v_linha
                                                ,r_auto.sucursal
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (18
                                                ,v_linha
                                                ,r_auto.nomesucursal
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                END     LOOP;
                --
        END     IF;    -- Fim Aba Auto
        --
        IF      p_parametros(1) IS      NULL            OR
                p_parametros(1) =       'DIARIA'        OR
                p_parametros(1) =       'MR'            THEN
                --
                --      Aba multirisco
                --
                v_linha :=      1;
                --
                ssvrppa0026_001.new_sheet     ('Dados MR');
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,1 -- linha
                                                ,18 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Anlise de Diferenas - MR -  Erros 65 (Geral)'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena KCW Menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_MR_kcw_menor,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                ssvrppa0026_001.cell    (6
                                        ,v_linha
                                        ,v_sq_log
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE, p_rgb   =>      'FFFFFF') -- Imprime em branco
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena Recepo Menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_MR_kcw_maior,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       1;
                --
                ssvrppa0026_001.Mergecelulas    (1 -- coluna
                                                ,v_linha -- linha
                                                ,4 -- qtde colunas para merge
                                                ,1 -- qtde linhhas para merge
                                                );
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Total Diferena Geral'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                        );
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,Nvl(v_dif_MR_kcw_menor,0) + Nvl(v_dif_MR_kcw_maior,0)
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                        );
                --
                v_linha :=      v_linha +       2;
                --
                ssvrppa0026_001.cell    (1
                                        ,v_linha
                                        ,'Proposta'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (2
                                                        ,12);
                --
                ssvrppa0026_001.cell    (2
                                        ,v_linha
                                        ,'Data'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (3
                                        ,v_linha
                                        ,'Perodo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (4
                                        ,v_linha
                                        ,'Erro'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (5
                                                        ,50);
                --
                ssvrppa0026_001.cell    (5
                                        ,v_linha
                                        ,'Cliente'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (6
                                        ,v_linha
                                        ,'Corretor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (7
                                        ,v_linha
                                        ,'Mdulo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (8
                                        ,v_linha
                                        ,'Negcio'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (9
                                                        ,12);
                --
                ssvrppa0026_001.cell    (9
                                        ,v_linha
                                        ,'Clculo KCW'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (10
                                                        ,15);
                --
                ssvrppa0026_001.cell    (10
                                        ,v_linha
                                        ,'Valor KCW'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (11
                                                        ,15);
                --
                ssvrppa0026_001.cell    (11
                                        ,v_linha
                                        ,'Valor Recepo'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.cell    (12
                                        ,v_linha
                                        ,'Diferena'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (13
                                                        ,20);
                --
                ssvrppa0026_001.cell    (13
                                        ,v_linha
                                        ,'Sistema a menor'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (14
                                                        ,80);
                --
                ssvrppa0026_001.cell    (14
                                        ,v_linha
                                        ,'Causa Diferena'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (15
                                                        ,15);
                --
                ssvrppa0026_001.cell    (15
                                        ,v_linha
                                        ,'Status'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (16
                                                        ,16);
                --
                ssvrppa0026_001.cell    (16
                                        ,v_linha
                                        ,'Sistema Causador'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (17
                                                        ,12);
                --
                ssvrppa0026_001.cell    (17
                                        ,v_linha
                                        ,'CdSucursal'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                ssvrppa0026_001.set_column_width        (18
                                                        ,30);
                --
                ssvrppa0026_001.cell    (18
                                        ,v_linha
                                        ,'NomeSucursal'
                                        ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri', p_bold => TRUE)
                                        ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                        ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                        ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                        ,'thin'));
                --
                FOR     r_multi IN      c_multi LOOP
                        --
                        v_linha :=      v_linha +       1;
                        --
                        ssvrppa0026_001.cell    (1
                                                ,v_linha
                                                ,r_multi.proposta
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (2
                                                ,v_linha
                                                ,r_multi.data
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (3
                                                ,v_linha
                                                ,r_multi.periodo
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (4
                                                ,v_linha
                                                ,r_multi.erro
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (5
                                                ,v_linha
                                                ,r_multi.cliente
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (6
                                                ,v_linha
                                                ,r_multi.corretor
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (7
                                                ,v_linha
                                                ,r_multi.modulo
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (8
                                                ,v_linha
                                                ,r_multi.negocio
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (9
                                                ,v_linha
                                                ,r_multi.calculo_kcw
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (10
                                                ,v_linha
                                                ,r_multi.valor_kcw
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (11
                                                ,v_linha
                                                ,r_multi.valor_recepcao
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (12
                                                ,v_linha
                                                ,r_multi.diferenca
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'rigth' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (13
                                                ,v_linha
                                                ,r_multi.sistema_a_menor
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (14
                                                ,v_linha
                                                ,r_multi.causa
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (15
                                                ,v_linha
                                                ,r_multi.status
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (16
                                                ,v_linha
                                                ,r_multi.sistema_causador_problema
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (17
                                                ,v_linha
                                                ,r_multi.sucursal
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'center' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                        ssvrppa0026_001.cell    (18
                                                ,v_linha
                                                ,r_multi.nomesucursal
                                                ,p_fontId       =>      ssvrppa0026_001.get_font( 'Calibri')
                                                ,p_alignment    =>      ssvrppa0026_001.get_alignment( p_vertical => 'center', p_horizontal => 'left' )
                                                ,p_borderId        =>      ssvrppa0026_001.Get_border      ('thin'--p_top          VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_bottom       VARCHAR2        :=      'thin'
                                                                                ,'thin'--p_left         VARCHAR2        :=      'thin'
                                                                                ,'thin'));
                        --
                END     LOOP;
                --
        END     IF;    -- Fim Aba MR
        --
        v_nm_arq        :=      'Erro_65_' || To_Char(v_dt_ini_periodo,'DD_MM') || '_' || v_sq_log || '.xlsx';
        --
        ssvrppa0026_001.save    ('DIR_RECEPCAO'
                                ,v_nm_arq);
        --
        v_blob          :=      tms_storage.readFileAndLoadAsBLOB       ('DIR_RECEPCAO'
                                                                        ,v_nm_arq);
        --
        v_file(1)       :=      TMS_FILE_RECORD (v_nm_arq
                                                ,v_blob);
        --
        --v_destinatarios         :=      Trim(tms_param.get_param        ('RECEPCAO'
        --                                                                ,'DEST_EMAIL_SINISTRO'));
        --
        v_destinatarios         :=      'edmilson.martins';
        --
        v_destinatarios_cc      :=      'edmilson.martins';
        --
        --v_destinatarios_cc      :=      Trim(tms_param.get_param        ('RECEPCAO'
        --                                                                ,'DEST_EMAIL_SINISTRO_CC'));
        --
        v_indx  :=      0;
        --
        WHILE   v_destinatarios IS      NOT     NULL    LOOP
                --
                v_indx  :=      v_indx  +       1;
                --
                IF      InStr(v_destinatarios,  ';')    <>      0       THEN
                        --
                        v_to(v_indx)    :=      SubStr(v_destinatarios, 1,  InStr(v_destinatarios,      ';')-1)||'@tokiomarine.com.br;';
                        --
                        v_destinatarios :=      SubStr(v_destinatarios, InStr(v_destinatarios,  ';')+1,Length(v_destinatarios));
                        --
                ELSE
                        --
                        v_to(v_indx)    :=      SubStr(v_destinatarios, 1, Length(v_destinatarios))||'@tokiomarine.com.br';
                        --
                        v_destinatarios :=      NULL;
                        --
                END     IF;
                --
        END     LOOP;
        --
        v_indx  :=      0;
        --
        WHILE   v_destinatarios_cc      IS      NOT     NULL    LOOP
                --
                v_indx  :=      v_indx  +       1;
                --
                IF      InStr(v_destinatarios_cc,       ';')    <>      0       THEN
                        --
                        v_cc(v_indx)    :=      SubStr(v_destinatarios_cc,      1,  InStr(v_destinatarios_cc,      ';')-1)||'@tokiomarine.com.br;';
                        --
                        v_destinatarios_cc :=      SubStr(v_destinatarios_cc, InStr(v_destinatarios_cc,  ';')+1,Length(v_destinatarios_cc));
                        --
                ELSE
                        --
                        v_cc(v_indx)    :=      SubStr(v_destinatarios_cc, 1, Length(v_destinatarios_cc))||'@tokiomarine.com.br';
                        --
                        v_destinatarios_cc      :=      NULL;
                        --
                END     IF;
                --
        END     LOOP;
        --
        --v_to(1) :=      'gabriel.cortez@tokiomarine.com.br';
        --
        v_css   :=      '<head>
                         <meta http-equiv=Content-Type content="text/html; charset=windows-1257">
                         <meta name=ProgId content=Word.Document>
                         <meta name=Generator content="Microsoft Word 11">
                         <meta name=Originator content="Microsoft Word 11">
                         <link rel=File-List href="teste_arquivos/filelist.xml">
                         <!--[if gte mso 9]><xml>
                          <o:DocumentProperties>
                           <o:Author>e105762</o:Author>
                           <o:LastAuthor>e105762</o:LastAuthor>
                           <o:Revision>19</o:Revision>
                           <o:TotalTime>57</o:TotalTime>
                           <o:Created>2011-07-27T19:13:00Z</o:Created>
                           <o:LastSaved>2011-09-26T13:52:00Z</o:LastSaved>
                           <o:Pages>1</o:Pages>
                           <o:Words>156</o:Words>
                           <o:Characters>844</o:Characters>
                           <o:Company>Tokio Marine Seguradora S.A.</o:Company>
                           <o:Lines>7</o:Lines>
                           <o:Paragraphs>1</o:Paragraphs>
                           <o:CharactersWithSpaces>999</o:CharactersWithSpaces>
                           <o:Version>11.9999</o:Version>
                          </o:DocumentProperties>
                         </xml><![endif]--><!--[if gte mso 9]><xml>
                          <w:WordDocument>
                           <w:Zoom>118</w:Zoom>
                           <w:SpellingState>Clean</w:SpellingState>
                           <w:GrammarState>Clean</w:GrammarState>
                           <w:HyphenationZone>21</w:HyphenationZone>
                           <w:ValidateAgainstSchemas/>
                           <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
                           <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
                           <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
                           <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
                          </w:WordDocument>
                         </xml><![endif]--><!--[if gte mso 9]><xml>
                          <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
                          </w:LatentStyles>
                         </xml><![endif]-->
                         <style>
                         <!--
                          /* Font Definitions */
                          '||Chr(64)||'font-face
                         	{font-family:Calibri;
                         	panose-1:2 15 5 2 2 2 4 3 2 4;
                         	mso-font-charset:0;
                         	mso-generic-font-family:swiss;
                         	mso-font-pitch:variable;
                         	mso-font-signature:-1610611985 1073750139 0 0 159 0;}
                         '||Chr(64)||'font-face
                         	{font-family:"Microsoft Sans Serif";
                         	panose-1:2 11 6 4 2 2 2 2 2 4;
                         	mso-font-charset:0;
                         	mso-generic-font-family:swiss;
                         	mso-font-pitch:variable;
                         	mso-font-signature:1627421663 -2147483648 8 0 66047 0;}
                          /* Style Definitions */
                          p.MsoNormal, li.MsoNormal, div.MsoNormal
                         	{mso-style-parent:"";
                         	margin:0cm;
                         	margin-bottom:.0001pt;
                         	mso-pagination:widow-orphan;
                         	font-size:12.0pt;
                         	font-family:"Times New Roman";
                         	mso-fareast-font-family:"Times New Roman";}
                         a:link, span.MsoHyperlink
                         	{color:blue;
                         	text-decoration:underline;
                         	text-underline:single;}
                         a:visited, span.MsoHyperlinkFollowed
                         	{color:purple;
                         	text-decoration:underline;
                         	text-underline:single;}
                         span.style11
                         	{mso-style-name:style11;
                         	mso-ansi-font-size:9.0pt;
                         	mso-bidi-font-size:9.0pt;
                         	font-family:"Microsoft Sans Serif";
                         	mso-ascii-font-family:"Microsoft Sans Serif";
                         	mso-hansi-font-family:"Microsoft Sans Serif";
                         	mso-bidi-font-family:"Microsoft Sans Serif";
                         	color:teal;}
                         span.msonormal0
                         	{mso-style-name:msonormal;}
                         span.style81
                         	{mso-style-name:style81;
                         	mso-ansi-font-size:8.0pt;
                         	mso-bidi-font-size:8.0pt;
                         	color:gray;}
                         span.style71
                         	{mso-style-name:style71;
                         	color:blue;}
                         span.SpellE
                         	{mso-style-name:"";
                         	mso-spl-e:yes;}
                         span.GramE
                         	{mso-style-name:"";
                         	mso-gram-e:yes;}
                         '||Chr(64)||'page Section1
                         	{size:595.3pt 841.9pt;
                         	margin:70.85pt 3.0cm 70.85pt 3.0cm;
                         	mso-header-margin:35.4pt;
                         	mso-footer-margin:35.4pt;
                         	mso-paper-source:0;}
                         div.Section1
                         	{page:Section1;}
                         -->
                         </style>
                         <!--[if gte mso 10]>
                         <style>
                          /* Style Definitions */
                          table.MsoNormalTable
                         	{mso-style-name:"Tabela normal";
                         	mso-tstyle-rowband-size:0;
                         	mso-tstyle-colband-size:0;
                         	mso-style-noshow:yes;
                         	mso-style-parent:"";
                         	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
                         	mso-para-margin:0cm;
                         	mso-para-margin-bottom:.0001pt;
                         	mso-pagination:widow-orphan;
                         	font-size:11.0pt;
                         	font-family:"Times New Roman";
                         	mso-ansi-language:#0400;
                         	mso-fareast-language:#0400;
                         	mso-bidi-language:#0400;}
                         table.MsoTableGrid
                         	{mso-style-name:"Tabela com grade";
                         	mso-tstyle-rowband-size:0;
                         	mso-tstyle-colband-size:0;
                         	border:solid windowtext 1.0pt;
                         	mso-border-alt:solid windowtext .5pt;
                         	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
                         	mso-border-insideh:.5pt solid windowtext;
                         	mso-border-insidev:.5pt solid windowtext;
                         	mso-para-margin:0cm;
                         	mso-para-margin-bottom:.0001pt;
                         	mso-pagination:widow-orphan;
                         	font-size:11.0pt;
                         	font-family:"Times New Roman";
                         	mso-ansi-language:#0400;
                         	mso-fareast-language:#0400;
                         	mso-bidi-language:#0400;}
                         </style>
                         <![endif]-->
                         </head>
                         <body lang=PT-BR link=blue vlink=purple style=''tab-interval:35.4pt''>';
        --
        --      Parte fixa do cabealho
        --
        v_cabecalho     :=      '<body lang=PT-BR link=blue vlink=purple style=''tab-interval:35.4pt''>
                                        <div class=Section1>
                                                <p class=MsoNormal style=''tab-stops:378.0pt''>
                                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>Pessoal,<br><br>
                                                                Segue rela'||cedilha||atil||'o de diverg'||ecirc||'ncias de pr'||ecirc||'mio do per'||iagudo ||'odo de '|| p_parametros(2) || ' a ' || p_parametros(3) || v_execucao_eventual || '.' ||'<br><o:p></o:p>
                                                        </span>
                                                </p>';
        --
        v_assinatura    :=      '<body lang=PT-BR link=blue vlink=purple style=''tab-interval:35.4pt''>
                                        <div class=Section1>
                                                <p class=MsoNormal style=''margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt;margin-left:0cm''><span class=SpellE>

                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''></b><br></i>Att,</span></span><o:p></o:p></p>

                                                <p class=MsoNormal style=''margin-top:1.0pt;margin-right:0cm;margin-bottom:1.0pt;margin-left:0cm''><b></p>
                                                <p class=MsoNormal>
                                                        <b><span style=''font-size:11.0pt;font-family:Calibri;color:#006156''>Recep'||cedilha||atil||'o Eletr'||ocirc||'nica</span></b>
                                                        <b><span style=''font-size:9.0pt;font-family:Calibri;color:#696969''> <br>'||v_ambiente||'<br></span></b></b>
                                                        <span style=''font-size:9.0pt;font-family:Calibri;color:#6D6D6D''>
                                                                Tokio Marine Seguradora<br>
                                                                Fone: (55) (11) 3265-7430 / (55) (11) 3265-7437<u4:p></u4:p><br>
                                                                VOIP:(cdigo) 27430 / 27437<br>
                                                        <a href="mailto:gabriel.cortez@tokiomarine.com.br"><span style=''color:#6D6D6D;text-decoration:none;text-underline:none''>gabriel.cortez@tokiomarine.com.br</span></a> / <a href="mailto:edmilson.martins@tokiomarine.com.br"><span style=''color:#6D6D6D;text-decoration:none;text-underline:none''>edmilson.martins@tokiomarine.com.br</span></a><br>
                                                        <a href="http://www.tokiomarine.com.br/"><span style=''color:#6D6D6D;text-decoration:none;text-underline:none''>http://www.tokiomarine.com.br</span></a></span><spanstyle=''color:#6D6D6D''><o:p></o:p></span></p>
                                        </div>
                                 </body>';
        --
        v_texto1        :=      v_texto1        ||
                        '<p class=MsoNormal style=''tab-stops:378.0pt''>
                        <span class=style71><b>
                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>Resumo: </b><br><br>
                        </span>
                        </p>';
        --
        IF      p_parametros(1) IS      NULL            OR
                p_parametros(1) =       'DIARIA'        OR
                p_parametros(1) =       'AU'            THEN
                --
                v_texto2        :=
                                '<p class=MsoNormal>
                                <span class=SpellE><b>
                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>Produto Auto:</b><br>
                                </span>
                                </p>';
                --
                IF      v_cont_auto     =       0       THEN
                        --
                        v_texto2        :=      v_texto2        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>Nenhum caso.<br>
                                        </span>
                                        </p>';
                        --
                ELSE
                        --
                        v_texto3        :=      v_texto3        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || v_cont_auto || ' caso(s), sendo a(s) causa(s):<br>
                                        </span>
                                        </p>';
                        --
                        FOR     r_auto_agrupado IN      c_auto_agrupado      LOOP
                                --
                                v_texto3        :=      v_texto3        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || r_auto_agrupado.LiteralCausaDiferenca || ': ' ||r_auto_agrupado.contador || ' caso(s) <br>
                                                </span>
                                                </p>';
                                --
                        END     LOOP;
                        --
                        v_texto3        :=      v_texto3        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || '<br>Valor Total da diferen' || cedilha || 'a: ' || '<br>
                                        </span>
                                        </p>';
                        --
                        IF      v_dif_auto_kcw_menor    >       0       THEN
                                --
                                v_texto3        :=      v_texto3        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || 'R$ ' || v_dif_auto_kcw_menor || ' (KCW calculou a menor) <br>
                                                </span>
                                                </p>';
                                --
                        END     IF;
                        --
                        IF      v_dif_auto_kcw_maior    >       0       THEN
                                --
                                v_texto3        :=      v_texto3        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || 'R$ '|| v_dif_auto_kcw_maior || ' (KCW calculou a maior) <br>
                                                </span>
                                                </p>';
                                --
                        END     IF;
                        --
                END     IF;
                --
        END     IF;
        --
        IF      p_parametros(1) IS      NULL            OR
                p_parametros(1) =       'DIARIA'        OR
                p_parametros(1) =       'MR'            THEN

                --
                v_texto4        :=
                                '<p class=MsoNormal>
                                <span class=SpellE><b>
                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''><br>Produto MR:</b><br>
                                </span>
                                </p>';
                --
                IF      v_cont_MR       =       0       THEN
                        --
                        v_texto4        :=      v_texto4        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>Nenhum caso.<br>
                                        </span>
                                        </p>';
                        --
                ELSE
                        --
                        v_texto5        :=      v_texto5        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || v_cont_mr || ' caso(s), sendo a(s) causa(s):<br>
                                        </span>
                                        </p>';
                        --
                        FOR     r_mr_agrupado IN      c_mr_agrupado      LOOP
                                --
                                v_texto5        :=      v_texto5        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || r_mr_agrupado.LiteralCausaDiferenca || ': ' ||r_mr_agrupado.contador || ' caso(s) <br>
                                                </span>
                                                </p>';
                                --
                        END     LOOP;
                        --
                        v_texto5        :=      v_texto5        ||
                                        '<p class=MsoNormal>
                                        <span class=SpellE>
                                        <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || '<br>Valor Total da diferen' || cedilha || 'a: ' || '<br>
                                        </span>
                                        </p>';
                        --
                        IF      v_dif_mr_kcw_menor    >       0       THEN
                                --
                                v_texto5        :=      v_texto5        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || 'R$ ' || v_dif_mr_kcw_menor || ' (KCW calculou a menor) <br>
                                                </span>
                                                </p>';
                                --
                        END     IF;
                        --
                        IF      v_dif_mr_kcw_maior    >       0       THEN
                                --
                                v_texto5        :=      v_texto5        ||
                                                '<p class=MsoNormal>
                                                <span class=SpellE>
                                                <span style=''font-size:11.0pt;font-family:Calibri;color:#1F497D''>' || 'R$ '|| v_dif_mr_kcw_maior || ' (KCW calculou a maior) <br>
                                                </span>
                                                </p>';
                                --
                        END     IF;
                        --
                END     IF;
                --
        END     IF;
        --
        v_body  :=      v_css           ||
                        v_cabecalho     ||
                        v_texto1        ||
                        v_texto2        ||
                        v_texto3        ||
                        v_texto4        ||
                        v_texto5        ||
                        v_assinatura;
        --
        BEGIN
                --
                TMS_MAIL.send_html      ('recepcao.eletronica@tokiomarine.com.br'
                                        ,v_to
                                        ,v_cc
                                        ,v_bcc
                                        ,'Relatrio Divergncia de Prmio - dia '|| p_parametros(2) || ' a ' || p_parametros(3) || v_execucao_eventual_titulo || ''
                                        ,v_body
                                        ,v_file
                                        ,v_fault_a
                                        ,v_correlation_id);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        Dbms_Output.Put_Line('Erro ao enviar e-mail: '||SQLERRM);
                        --
        END;
        --
END     Gera_Planilha;
--
PROCEDURE       GeraProcessamentoRecepcao
                                                (p_parametros    IN      admcta.t_param,
                                                p_usuario       IN      VARCHAR2,
                                                p_tp_local      IN      NUMBER,
                                                p_cd_local      IN      NUMBER,
                                                relatorio       OUT     t_rec_retorno,
                                                cd_retorno      OUT     NUMBER,
                                                msg_retorno     OUT     VARCHAR2)
IS
        --
        v_indx                  NUMBER;
        v_fault_a               tms_storage.r_request_fault;
        v_correlation_id        tms_util.correlation_id;
        v_body                  CLOB;
        v_blob                  BLOB;
        v_file                  tms_mail.file_type;
        v_to                    tms_mail.address_type;
        v_cc                    tms_mail.address_type;
        v_bcc                   tms_mail.address_type;
        v_ambiente              VARCHAR2(4000);
        --
        v_ini_manha     DATE    :=      To_Date(To_Char(SYSDATE -       1,        'DDMMYYYY')||'1700',    'DDMMYYYYHH24MI');
        v_fim_manha     DATE    :=      To_Date(To_Char(SYSDATE,        'DDMMYYYY')||'1100',    'DDMMYYYYHH24MI');
        v_ini_tarde     DATE    :=      To_Date(To_Char(SYSDATE,        'DDMMYYYY')||'1101',    'DDMMYYYYHH24MI');
        v_fim_tarde     DATE    :=      To_Date(To_Char(SYSDATE,        'DDMMYYYY')||'1659',    'DDMMYYYYHH24MI');
        --
        v_ini   DATE;
        v_fim   DATE;
        --
        CURSOR  c1      (p_dt_ini       IN      DATE
                        ,p_dt_fim       IN      DATE)   IS
                --
                SELECT  a.id_ppota_contr,
                        a.id_rcel,
                        d.dt_ultma_alter
                FROM    ssv5230_histo_ppota_contr       a,
                        ssv5250_histo_ppota_rcel        b,
                        ssv5220_histo_item_rcel         c,
                        ssv5120_histo_erro_contr        d
                WHERE   a.id_ppota_contr        =       b.id_ppota_contr
                AND     a.id_ppota_contr        =       c.id_ppota_contr
                AND     c.tp_segur              IN      (1,     2,      3)
                AND     a.cd_situc_ngoco        =       'G'
                AND     a.cd_mdupr              IN      (9)
                AND     a.dt_inico_vigen        >=      To_Date('16/01/2013',   'DD/MM/YYYY')
                AND     a.dt_movto              =      To_Date('23/01/2013',   'DD/MM/YYYY')
                AND     a.cd_convo              <>      'SANX'
                AND     d.id_ppota_contr        =       a.id_ppota_contr
                AND     d.cd_erro_rcel          =       293
                AND     d.dt_ultma_alter        BETWEEN p_dt_ini        AND     p_dt_fim
                AND     b.qt_parcl              <>      12
                --AND     ROWNUM                  <=      25
                --
                UNION
                --
                SELECT  a.id_ppota_contr,
                        a.id_rcel,
                        d.dt_ultma_alter
                FROM    ssv5230_histo_ppota_contr       a,
                        ssv5250_histo_ppota_rcel        b,
                        ssv5220_histo_item_rcel         c,
                        ssv5120_histo_erro_contr        d
                WHERE   a.id_ppota_contr        =       b.id_ppota_contr
                AND     a.id_ppota_contr        =       c.id_ppota_contr
                AND     c.tp_segur              IN      (1,     2,      3)
                AND     a.cd_situc_ngoco        =       'G'
                AND     a.cd_mdupr              IN      (7)
                AND     a.dt_inico_vigen        >=      To_Date('16/01/2013',   'DD/MM/YYYY')
                AND     a.dt_movto              =      To_Date('23/01/2013',   'DD/MM/YYYY')
                AND     a.cd_convo              <>      'SANX'
                AND     d.id_ppota_contr        =       a.id_ppota_contr
                AND     d.cd_erro_rcel          =       293
                AND     d.dt_ultma_alter        BETWEEN p_dt_ini        AND     p_dt_fim
                AND     b.qt_parcl              <>      12
                --AND     ROWNUM                  <=      50
                --
                UNION
                --
                SELECT  a.id_ppota_contr,
                        a.id_rcel,
                        d.dt_ultma_alter
                FROM    ssv5230_histo_ppota_contr       a,
                        ssv5250_histo_ppota_rcel        b,
                        ssv5220_histo_item_rcel         c,
                        ssv5120_histo_erro_contr        d
                WHERE   a.id_ppota_contr        =       b.id_ppota_contr
                AND     a.id_ppota_contr        =       c.id_ppota_contr
                AND     c.tp_segur              IN      (1,     2,      3)
                AND     a.cd_situc_ngoco        =       'G'
                AND     a.cd_mdupr              IN      (20)
                AND     a.dt_inico_vigen        >=      To_Date('16/01/2013',   'DD/MM/YYYY')
                AND     a.cd_convo              <>      'SANX'
                AND     d.id_ppota_contr        =       a.id_ppota_contr
                AND     d.cd_erro_rcel          =       293
                AND     d.dt_ultma_alter        BETWEEN p_dt_ini        AND     p_dt_fim
                AND     b.qt_parcl              <>      12
                --AND     ROWNUM                  <=      25
                --
                UNION
                --
                SELECT  a.id_ppota_contr,
                        a.id_rcel,
                        d.dt_ultma_alter
                FROM    ssv5230_histo_ppota_contr       a,
                        ssv5250_histo_ppota_rcel        b,
                        ssv5220_histo_item_rcel         c,
                        ssv5120_histo_erro_contr        d
                WHERE   a.id_ppota_contr        =       b.id_ppota_contr
                AND     a.id_ppota_contr        =       c.id_ppota_contr
                AND     c.tp_segur              IN      (1,     2,      3)
                AND     a.cd_situc_ngoco        =       'G'
                AND     a.cd_mdupr              IN      (7,     9,      20)
                AND     a.dt_inico_vigen        >=      To_Date('16/01/2013',   'DD/MM/YYYY')
                AND     a.cd_convo              <>      'SANX'
                AND     d.id_ppota_contr        =       a.id_ppota_contr
                AND     d.cd_erro_rcel          =       293
                AND     d.dt_ultma_alter        BETWEEN p_dt_ini        AND     p_dt_fim
                --AND     ROWNUM                  <=      25
                AND     b.qt_parcl              =       12;
        --
        CURSOR  c_rcel_detal    (v_id_rcel      number) IS
                --
                SELECT  id_rcel,
                        sq_rcel_detal,
                        tp_rgist_rcel,
                        nr_cpf_cnpj_detal,
                        cd_mdupr_detal,
                        cd_brokr_detal,
                        nr_item_contr_detal,
                        tp_rgist_detal,
                        ds_linha_detal
                FROM    ssv5254_histo_rcel_detal
                WHERE   id_rcel =       v_id_rcel
                ORDER BY        id_rcel,
                                sq_rcel_detal;
        --
        linha           VARCHAR2(5000);
        arquivo         utl_file.file_type;
        v_nm_arq        VARCHAR2(4000);
        v_contador      NUMBER  :=      0;
        --
        --
        v_sq_log                NUMBER;
BEGIN
        --
        CTACTPA0100_001.IniciaLog       (292
                                        ,'CTA'
                                        ,NULL
                                        ,NULL
                                        ,p_tp_local
                                        ,p_cd_local
                                        ,NULL
                                        ,NULL
                                        ,NULL
                                        ,p_usuario
                                        ,NULL
                                        ,v_sq_log);
        --
        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,LPad('=',      80,     '=')                                                    ||Chr(10)||
                                        'Incio execuo: '||To_Char(SYSTIMESTAMP,       'dd-mm-yyyy hh24:mi:ss.FF')    ||Chr(10)||
                                           ' Usuario....... '||p_usuario  ||Chr(10)||
                                           ' TpLocal....... '||p_tp_local ||Chr(10)||
                                           ' CdLocal....... '||p_cd_local ||Chr(10));

        IF      SYSDATE >       v_fim_manha     THEN
                --
                v_ini   :=      v_ini_tarde;
                v_fim   :=      v_fim_tarde;
                --
        ELSE
                --
                v_ini   :=      v_ini_manha;
                v_fim   :=      v_fim_manha;
                --
        END     IF;
        --
        v_ambiente              :=      tms_param.get_param             ('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS'
                                                                        ,'AMBIENTE');
        --
        v_nm_arq        :=      'INTEP_'||To_Char(v_ini,        'DDMMYYYYHH24MI')||'.txt';
        --
        arquivo :=      utl_file.fopen  ('DIR_RECEPCAO'
                                        ,v_nm_arq
                                        ,'W'
                                        ,32000);
        --
        FOR     r1      IN      c1      (v_ini
                                        ,v_fim) LOOP
                --
                v_contador      :=      v_contador      +       1;
                --
                FOR     r_rcel_detal        IN      c_rcel_detal    (r1.id_rcel)        LOOP
                        --
                        linha   :=      r_rcel_detal.tp_rgist_rcel      ||
                                        r_rcel_detal.nr_cpf_cnpj_detal  ||
                                        r_rcel_detal.cd_mdupr_detal     ||
                                        r_rcel_detal.cd_brokr_detal     ||
                                        r_rcel_detal.nr_item_contr_detal||
                                        r_rcel_detal.tp_rgist_detal     ||
                                        r_rcel_detal.ds_linha_detal;
                        --
                        Utl_File.put_line       (arquivo
                                                ,linha);
                        --
                END     LOOP;
                --
        END     LOOP;
        --
        Utl_File.fclose(arquivo);
        --
        --      Enviando o arquivo por e-mail.
        --
        v_to(1)         :=      'gabriel.cortez@tokiomarine.com.br';
        v_to(2)         :=      'edmilson.martins@tokiomarine.com.br';
        --
        v_blob          :=      tms_storage.readFileAndLoadAsBLOB       ('DIR_RECEPCAO'
                                                                        ,v_nm_arq);
        --
        v_body          :=      to_clob('Segue o arquivo: '||v_nm_arq);
        --
        v_file(1)       :=      TMS_FILE_RECORD (v_nm_arq
                                                ,v_blob);
        --
        BEGIN
                --
                TMS_MAIL.send_html      ('recepcao.eletronica@tokiomarine.com.br'
                                        ,v_to
                                        ,v_cc
                                        ,v_bcc
                                        ,'['||v_ambiente||' - Recepo Eletrnica] - Arquivo '||v_nm_arq
                                        ,v_body
                                        ,v_file
                                        ,v_fault_a
                                        ,v_correlation_id);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        Dbms_Output.Put_Line('Erro ao enviar e-mail: '||SQLERRM);
                        --
        END;
        --
END GeraProcessamentoRecepcao;
        --
END     CTACTPA0029_ERRO_65;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0030_RELAT_MONITORADOS   IS

FUNCTION        RecuperaParametro       (p_sql          IN      VARCHAR2)
--
RETURN  VARCHAR2        is
--
v_sql_regra     VARCHAR2(4000);
--
v_cursor        SYS_REFCURSOR;
--
p_saida         VARCHAR2(4000);
--
BEGIN
        --

        IF      p_sql   LIKE    'Regra:%'        THEN
                --
                BEGIN
                        --
                        SELECT  R.DS_REGRA_RCEL_VRIFC
                        INTO    v_sql_regra
                        FROM    SSV5805_REGRA_RCEL      r
                        WHERE   r.ID_REGRA_RCEL =       SubStr(p_sql,7,Length(p_sql));
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                v_sql_regra     :=      NULL;
                END;
                --
        ELSE
                --
                v_sql_regra     :=      p_sql;
                --
        END     IF;
        --
        IF      v_sql_regra     IS      NOT     NULL    THEN
                --
                OPEN v_CURSOR FOR v_sql_regra;
                --
                LOOP
                        --
                        FETCH   V_CURSOR        INTO    p_saida;
                        --
                        EXIT    WHEN    V_CURSOR%NOTFOUND;
                        --
                        DBMS_OUTPUT.PUT_LINE(p_saida);
                        --
                END     LOOP;
                --
        ELSE
                --
                p_saida :=      NULL;
                --
        END     IF;
        --
        RETURN  p_saida;
        --
END     RecuperaParametro;

PROCEDURE       RelatoriosMonitorados   IS
--
CURSOR  c_relat_do_dia_e_horario IS
        SELECT  cd_perdc_relat
                ,dd_gerac_relat
                ,hh_gerac_relat
                ,id_query
        FROM    cta0021_query
        WHERE   ic_relat_autmc  =       'S'
        ORDER BY id_query;
        --
        p_cd_erro               NUMBER;
        p_msg_erro              VARCHAR2(4000);
        v_executa_relatorio     VARCHAR2(1);
        p_parametros            admcta.t_param;
        --
CURSOR  c_parametros_entrada    (p_id_query     IN      NUMBER) IS
        --
        SELECT  ds_condc_relat_autmc
        FROM    CTA0023_CAMPO_CONDC_QUERY
        WHERE   id_query        =       p_id_query
        ORDER BY sq_campo;

BEGIN
        --
        p_parametros    :=      t_param();
        --
        FOR     r_relat IN      c_relat_do_dia_e_horario        LOOP
                --
                --Dbms_Output.Put_Line('dentro do loop Query: ' || r_relat.id_query);
                --
                v_executa_relatorio     :=      'N';
                --
                --      T = Total, ou seja, sempre executa
                --
                IF      r_relat.cd_perdc_relat  =       'T'     THEN
                        --
                        v_executa_relatorio     :=      'S';
                        --
                --      Execuo em um dia e hora especficos
                --
                ELSIF   r_relat.cd_perdc_relat  =       'D'                      AND
                        r_relat.dd_gerac_relat  =       To_Char(SYSDATE,'dd')    AND
                        r_relat.hh_gerac_relat  =       To_Char(SYSDATE,'HH24')  AND
                        To_Char(SYSDATE,'MI')   <       15              THEN
                        --
                        v_executa_relatorio     :=      'S';
                        --
                --      Execuo uma vez por semana, em um horario especifico
                --      O comando To_Char(SYSDATE,'D') retorna o dia da semana, sendo:
                --      1       =       Domingo
                --      2       =       Segunda-feira, e assim por diante
                --
                ELSIF   To_Char(SYSDATE,'D')    =       r_relat.cd_perdc_relat  AND
                        r_relat.hh_gerac_relat  =       To_Char(SYSDATE,'HH24') AND
                        To_Char(SYSDATE,'MI')   <       15              THEN
                        --
                        v_executa_relatorio     :=      'S';
                        --
                END     IF;
                --
                IF      v_executa_relatorio     =       'S'     THEN
                        --
                        --Dbms_Output.Put_Line('vai executar Query: ' || r_relat.id_query);
                        --
                        p_parametros    :=      t_param();
                        --
                        FOR     r_param IN      c_parametros_entrada (r_relat.id_query) LOOP
                                --
                                p_parametros.extend;
                                --
                                p_parametros(p_parametros.Count)        :=      RecuperaParametro       (r_param.ds_condc_relat_autmc);
                                --
                        END     LOOP;
                        --
                        ctactpa0018_001.GeraPlanilha    (r_relat.id_query       -- id_query
                                                        ,p_parametros           -- p_parametros   IN      t_param
                                                        ,NULL                   -- p_emails       IN      VARCHAR2
                                                        ,'BATCH'                -- p_usuario      IN      VARCHAR2
                                                        ,NULL                   -- p_tp_local     IN      NUMBER
                                                        ,NULL                   -- p_cd_local     IN      NUMBER
                                                        ,p_cd_erro
                                                        ,p_msg_erro);
                        --
                END     IF;
                --
        END     LOOP;
        --
END     RelatoriosMonitorados;
--
END  CTACTPA0030_RELAT_MONITORADOS;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0031_MOTOR_CALCULO IS

        --
        PROCEDURE MONITORA IS
                --
                v_contador       NUMBER;
                v_tempo_execucao NUMBER;
                v_maximo         NUMBER;
                v_desvio_padrao  NUMBER;
                v_erro           VARCHAR2(4000);
                --
                v_fault_a        tms_storage.r_request_fault;
                v_correlation_id tms_util.correlation_id;
                v_body           CLOB;
                v_file           tms_mail.file_type;
                v_to             tms_mail.address_type;
                v_cc             tms_mail.address_type;
                v_bcc            tms_mail.address_type;
                v_texto_body     VARCHAR2(4000);
                --
                v_ambiente VARCHAR2(4000);
                v_indx     NUMBER := 0;
                --
                v_data_ini             DATE;
                v_data_fim             DATE;
                v_minutos              NUMBER;
                v_limite_desvio_padrao NUMBER;
                --
                v_id_query NUMBER;
                --
                CURSOR dest_query(p_id_query IN NUMBER) IS
                --
                        SELECT REPLACE(cd_email_desnt_query, '@tokiomarine.com.br', NULL) || '@tokiomarine.com.br' cd_email_desnt_query
                        FROM   cta0025_desnt_query
                        WHERE  id_query = p_id_query;
                --
                CURSOR c_desvio(p_data_ini IN DATE
                               ,p_data_fim IN DATE) IS
                --
                        SELECT COUNT(*) AS Contador
                              ,Round(AVG(lg.nr_tempo_execo / 1000), 3) AS tempo_em_segs
                              ,MAX(lg.nr_tempo_execo / 1000) AS maximo
                              ,Round(STDDEV(lg.nr_tempo_execo / 1000), 3) AS desvio_padrao
                        FROM   ssv0666_log_contr_emiss_ids lg
                        WHERE  lg.dt_incls BETWEEN p_data_ini AND p_data_fim;
                --
        BEGIN
                --
                BEGIN
                        --
                        SELECT MAX(id_query)
                        INTO   v_id_query
                        FROM   cta0021_query
                        WHERE  nm_query = 'Monitora Motor Clculo';
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                v_erro := 'Erro ao buscar id_query ' || SQLERRM;
                                --
                END;
                --
                --      Montando os destinatrios da query
                --
                FOR r_dest_query IN dest_query(v_id_query) LOOP
                        --
                        v_indx := v_indx + 1;
                        --
                        v_to(v_indx) := r_dest_query.cd_email_desnt_query;
                        --
                END LOOP;
                --
                v_minutos              := tms_param.get_param('SSV_UTIL', 'INTERVALO_MONITORA_CALCULO');
                v_limite_desvio_padrao := tms_param.get_param('SSV_UTIL', 'LIMITE_DESVIO_PADRAO');
                v_ambiente             := tms_param.get_param('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS', 'AMBIENTE');
                --
                IF v_minutos IS NULL THEN
                        --
                        v_minutos := 15;
                        --
                END IF;
                --
                IF v_limite_desvio_padrao IS NULL THEN
                        --
                        v_limite_desvio_padrao := -1;
                        --
                END IF;
                --
                v_data_ini := Trunc(SYSDATE, 'MI') - v_minutos / 1440;
                v_data_fim := Trunc(SYSDATE, 'MI');
                --
                FOR r_desvio IN c_desvio(v_data_ini, v_data_fim) LOOP
                        --
                        v_contador       := r_desvio.contador;
                        v_tempo_execucao := r_desvio.tempo_em_segs;
                        v_maximo         := r_desvio.maximo;
                        v_desvio_padrao  := r_desvio.desvio_padrao;
                        --
                END LOOP;
                --
                IF Nvl(v_desvio_padrao, 0) > v_limite_desvio_padrao THEN
                        --
                        BEGIN
                                --
                                v_texto_body := 'Parmetro Minutos.............: ' || Chr(9) || To_Char(v_minutos,'990')                        || '<br>' ||
                                                'Parmetro Limite Desvio Padro: ' || Chr(9) || To_Char(v_limite_desvio_padrao,'990D999')       || '<br>' ||
                                                'Registros.....................: ' || Chr(9) || v_contador                                      || '<br>' ||
                                                'Horrio Incio Pesquisa.......: ' || Chr(9) || To_Char(v_data_ini, 'dd/mm/yyyy hh24:mi:ss')    || '<br>' ||
                                                'Horrio Fim Pesquisa..........: ' || Chr(9) || To_Char(v_data_fim, 'dd/mm/yyyy hh24:mi:ss')    || '<br>' ||
                                                'Tempo Execuo................: ' || Chr(9) || To_Char(v_tempo_execucao      ,'999999990D999') || '<br>' || --
                                                'Maximo........................: ' || Chr(9) || To_Char(v_maximo              ,'999999990D999') || '<br>' || --
                                                'Desvio Padro.................: ' || Chr(9) || To_Char(v_desvio_padrao       ,'999999990D999');
                                --
                                v_body := to_clob(v_texto_body);
                                --
                                BEGIN
                                        --
                                        TMS_MAIL.send_html('monitoramento@tokiomarine.com.br', v_to, v_cc, v_bcc, '[' || v_ambiente ||
                                                            '] - Monitoramento Motor de Clculo: Desvio Padro maior do que 1', v_body, v_file, v_fault_a, v_correlation_id);
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                                --
                                END;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                        --
                        END;
                        --
                END IF;
                --
                IF v_erro IS NOT NULL THEN
                        --
                        BEGIN
                                --
                                v_texto_body := 'Horrio Incio Pesquisa...: ' || To_Char(v_data_ini, 'dd/mm/yyyy hh24:mi:ss') || Chr(13) ||
                                                'Horrio Fim Pesquisa......: ' || To_Char(v_data_fim, 'dd/mm/yyyy hh24:mi:ss') || Chr(13) || 'Erro: ' ||
                                                v_erro;
                                --
                                v_body := to_clob(v_texto_body);
                                --        --
                                BEGIN
                                        --
                                        TMS_MAIL.send_html('monitoramento@tokiomarine.com.br' --
                                                          , v_to --
                                                          , v_cc --
                                                          , v_bcc --
                                                          , '[' || v_ambiente || '] - Monitoramento Motor de Clculo: Erro', v_body, v_file, v_fault_a, v_correlation_id);
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                                --
                                END;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                        --
                        END;
                        --
                END IF;
                --
        END monitora;
        --
        PROCEDURE MONITORA_SUBSCRICAO IS
                --
                v_contador       NUMBER;
                v_tempo_execucao NUMBER;
                v_maximo         NUMBER;
                v_desvio_padrao  NUMBER;
                v_erro           VARCHAR2(4000);
                --
                v_fault_a        tms_storage.r_request_fault;
                v_correlation_id tms_util.correlation_id;
                v_body           CLOB;
                v_file           tms_mail.file_type;
                v_to             tms_mail.address_type;
                v_cc             tms_mail.address_type;
                v_bcc            tms_mail.address_type;
                v_texto_body     VARCHAR2(4000);
                --
                v_ambiente VARCHAR2(4000);
                v_indx     NUMBER := 0;
                --
                v_data_ini             DATE;
                v_data_fim             DATE;
                v_minutos              NUMBER;
                v_limite_desvio_padrao NUMBER;
                --
                v_id_query NUMBER;
                --
                CURSOR dest_query(p_id_query IN NUMBER) IS
                --
                        SELECT REPLACE(cd_email_desnt_query, '@tokiomarine.com.br', NULL) || '@tokiomarine.com.br' cd_email_desnt_query
                        FROM   cta0025_desnt_query
                        WHERE  id_query = p_id_query;
                --
                CURSOR c_desvio(p_data_ini IN DATE
                               ,p_data_fim IN DATE) IS
                --
                        SELECT COUNT(*) AS Contador
                              ,Round(AVG(lg.nr_tempo_execo / 1000), 3) AS tempo_em_segs
                              ,MAX(lg.nr_tempo_execo / 1000) AS maximo
                              ,Round(STDDEV(lg.nr_tempo_execo / 1000), 3) AS desvio_padrao
                        FROM   ssv0665_log_emiss_ids_subcr lg
                        WHERE  lg.dt_incls BETWEEN p_data_ini AND p_data_fim;
                --
        BEGIN
                --
                BEGIN
                        --
                        SELECT MAX(id_query)
                        INTO   v_id_query
                        FROM   cta0021_query
                        WHERE  nm_query = 'Monitora Motor Clculo Subscrio';
                        --
                EXCEPTION
                        --
                        WHEN OTHERS THEN
                                --
                                v_erro := 'Erro ao buscar id_query ' || SQLERRM;
                                --
                END;
                --
                --      Montando os destinatrios da query
                --
                FOR r_dest_query IN dest_query(v_id_query) LOOP
                        --
                        v_indx := v_indx + 1;
                        --
                        v_to(v_indx) := r_dest_query.cd_email_desnt_query;
                        --
                END LOOP;
                --
                v_minutos              := tms_param.get_param('SSV_UTIL', 'SUBSCRICAO_INTERVALO_MONITORA_CALCULO');
                v_limite_desvio_padrao := tms_param.get_param('SSV_UTIL', 'SUBSCRICAO_LIMITE_DESVIO_PADRAO');
                v_ambiente             := tms_param.get_param('RECEPCAO.ELETRONICA.CASOS.ABORTIVOS', 'AMBIENTE');
                --
                IF v_minutos IS NULL THEN
                        --
                        v_minutos := 15;
                        --
                END IF;
                --
                IF v_limite_desvio_padrao IS NULL THEN
                        --
                        v_limite_desvio_padrao := -1;
                        --
                END IF;
                --
                v_data_ini := Trunc(SYSDATE, 'MI') - v_minutos / 1440;
                v_data_fim := Trunc(SYSDATE, 'MI');
                --
                FOR r_desvio IN c_desvio(v_data_ini, v_data_fim) LOOP
                        --
                        v_contador       := r_desvio.contador;
                        v_tempo_execucao := r_desvio.tempo_em_segs;
                        v_maximo         := r_desvio.maximo;
                        v_desvio_padrao  := r_desvio.desvio_padrao;
                        --
                END LOOP;
                --
                IF Nvl(v_desvio_padrao, 0) > v_limite_desvio_padrao THEN
                        --
                        BEGIN
                                --
                                v_texto_body := 'Motor de Clculo Subscrio'   || Chr(9) ||
                                                'Parmetro Minutos.............: ' || Chr(9) || To_Char(v_minutos,'990')                        || '<br>' ||
                                                'Parmetro Limite Desvio Padro: ' || Chr(9) || To_Char(v_limite_desvio_padrao,'990D999')       || '<br>' ||
                                                'Registros.....................: ' || Chr(9) || v_contador                                      || '<br>' ||
                                                'Horrio Incio Pesquisa.......: ' || Chr(9) || To_Char(v_data_ini, 'dd/mm/yyyy hh24:mi:ss')    || '<br>' ||
                                                'Horrio Fim Pesquisa..........: ' || Chr(9) || To_Char(v_data_fim, 'dd/mm/yyyy hh24:mi:ss')    || '<br>' ||
                                                'Tempo Execuo................: ' || Chr(9) || To_Char(v_tempo_execucao      ,'999999990D999') || '<br>' || --
                                                'Maximo........................: ' || Chr(9) || To_Char(v_maximo              ,'999999990D999') || '<br>' || --
                                                'Desvio Padro.................: ' || Chr(9) || To_Char(v_desvio_padrao       ,'999999990D999');
                                --
                                v_body := to_clob(v_texto_body);
                                --
                                BEGIN
                                        --
                                        TMS_MAIL.send_html('monitoramento@tokiomarine.com.br', v_to, v_cc, v_bcc, '[' || v_ambiente ||
                                                            '] - Monitoramento Motor de Clculo Subscrio: Desvio Padro maior do que 1', v_body, v_file, v_fault_a, v_correlation_id);
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                                --
                                END;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                        --
                        END;
                        --
                END IF;
                --
                IF v_erro IS NOT NULL THEN
                        --
                        BEGIN
                                --
                                v_texto_body := 'Horrio Incio Pesquisa...: ' || To_Char(v_data_ini, 'dd/mm/yyyy hh24:mi:ss') || Chr(13) ||
                                                'Horrio Fim Pesquisa......: ' || To_Char(v_data_fim, 'dd/mm/yyyy hh24:mi:ss') || Chr(13) || 'Erro: ' ||
                                                v_erro;
                                --
                                v_body := to_clob(v_texto_body);
                                --        --
                                BEGIN
                                        --
                                        TMS_MAIL.send_html('monitoramento@tokiomarine.com.br' --
                                                          , v_to --
                                                          , v_cc --
                                                          , v_bcc --
                                                          , '[' || v_ambiente || '] - Monitoramento Motor de Clculo Subscrio: Erro', v_body, v_file, v_fault_a, v_correlation_id);
                                        --
                                EXCEPTION
                                        --
                                        WHEN OTHERS THEN
                                                --
                                                Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                                --
                                END;
                                --
                        EXCEPTION
                                --
                                WHEN OTHERS THEN
                                        --
                                        Dbms_Output.Put_Line('Erro ao enviar e-mail: ' || SQLERRM);
                                        --
                        END;
                        --
                END IF;
                --
        END MONITORA_SUBSCRICAO;

--
END CTACTPA0031_MOTOR_CALCULO;
/


CREATE OR REPLACE PACKAGE BODY ctactpa0100_001 IS

    /* VERSAO V 7.9 */

    --
    --------------------------------------------------------------------------
    --      SistemaChamadorValido:  Valida se o parmetro passado para as   --
    --                              packages como sistema chamador  vlido --
    --                              a partir da lista pr-determinada.      --
    --------------------------------------------------------------------------
    --
    FUNCTION SistemaChamadorValido(p_sistema_chamador IN VARCHAR2) RETURN BOOLEAN IS
        --
    BEGIN
        --
        IF Upper(p_sistema_chamador) IN ('KCW', 'MUL', 'CTA', 'SSV', 'SPE', 'KME') THEN
            --
            RETURN TRUE;
            --
        ELSE
            --
            RETURN FALSE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            RETURN FALSE;
            --
    END SistemaChamadorValido;

    --
    --------------------------------------------------------------------------
    --      HabilitaSaldoCCStder:  Habilita 'S' / Desabilita 'N' a consulta --
    --                             de saldo para proviso do Santander      --
    --------------------------------------------------------------------------
    --
    PROCEDURE HabilitaSaldoCCStder(p_vl_param IN VARCHAR2
                                  ,p_cd_erro  OUT NUMBER
                                  ,p_msg_erro OUT VARCHAR2) IS
        --
    BEGIN
        --
        IF p_vl_param NOT IN ('S', 'N') THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Parametro so permite valor S ou N';
            RETURN;
            --
        END IF;
        --
        UPDATE cta0008_param_cc
        SET    ds_param_cc = p_vl_param
        WHERE  nm_param_cc = 'PERMITE_DESC_KCW_STD'
        AND    cd_segmt_prdut = 1;
        --
        p_cd_erro  := 0;
        p_msg_erro := '';
        RETURN;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Erro ao habilitar a consulta de saldo Santander ' || SQLERRM;
            RETURN;
            --
    END HabilitaSaldoCCStder;

    --
    --------------------------------------------------------------------------
    --      ConsultaSaldoCCStder:  Valida a consulta de saldo para proviso --
    --      do Santander                                                    --
    --------------------------------------------------------------------------
    --
    FUNCTION ConsultaSaldoCCStder RETURN BOOLEAN IS
        --
        v_vl_param VARCHAR2(10);
        --
    BEGIN
        --
        SELECT ds_param_cc
        INTO   v_vl_param
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'PERMITE_DESC_KCW_STD'
        AND    cd_segmt_prdut = 1;
        --
        IF v_vl_param = 'S' THEN
            --
            RETURN TRUE;
            --
        END IF;
        --
        RETURN FALSE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            RETURN FALSE;
            --
    END ConsultaSaldoCCStder;

    --
    --------------------------------------------------------------------------
    --      ModuloProdutoValido:    Valida se o parmetro passado para as   --
    --                              packages como mdulo produto  vlido   --
    --                              a partir da lista pr-determinada.      --
    --------------------------------------------------------------------------
    --
    FUNCTION ModuloProdutoValido(p_cd_mdupr IN VARCHAR2
                                ,p_cd_sist  IN VARCHAR2
                                ,p_cd_segmt IN NUMBER
                                ,p_dt_procm IN DATE
                                ,p_cd_erro  OUT NUMBER
                                ,p_msg_erro OUT VARCHAR2) RETURN NUMBER IS
        --
        v_sistema_chamador cta0001_prdut.sg_sistm_origm_prdut%TYPE;
        v_id_prdut         cta0001_prdut.id_prdut%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        IF Upper(p_cd_sist) IN ('KCW', 'SPE', 'MUL') THEN
            --
            v_sistema_chamador := 'SSV';
            --
        ELSE
            --
            v_sistema_chamador := Upper(p_cd_sist);
            --
        END IF;
        --
        SELECT id_prdut
        INTO   v_id_prdut
        FROM   cta0001_prdut
        WHERE  sg_sistm_origm_prdut = v_sistema_chamador
        AND    cd_prdut_sistm_origm = p_cd_mdupr
        AND    cd_segmt_prdut = p_cd_segmt
        AND    dt_inico_vigen <= p_dt_procm
        AND    dt_fim_vigen >= p_dt_procm;
        --
        RETURN v_id_prdut;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 3;
            p_msg_erro := 'Erro ModuloProdutoValido: ' || SQLERRM;
            --
            RETURN 0;
            --
    END ModuloProdutoValido;

    --
    --------------------------------------------------------------------------
    --      IsDataValida:   Valida se uma determinada data est no padro   --
    --                      valido para o projeto: YYYYMMDD.                --
    --------------------------------------------------------------------------
    --
    FUNCTION IsDataValida(p_data_in  IN VARCHAR2
                         ,p_data_out OUT DATE) RETURN BOOLEAN IS
        --
        v_data_teste DATE;
        --
    BEGIN
        --
        IF p_data_in IS NULL THEN
            --
            RETURN FALSE;
            --
        ELSE
            --
            p_data_out := To_Date(p_data_in, 'YYYYMMDD');
            --
            RETURN TRUE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            RETURN FALSE;
            --
    END IsDataValida;

    --
    --------------------------------------------------------------------------
    --      RetornaDtProcm: Busca a data de processamento. Se a data        --
    --                      estiver nula ou invlida, assumir a data do dia.--
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaDtProcm RETURN DATE IS
        --
        v_dt_procm DATE;
        v_ambiente VARCHAR2(4);
        --
    BEGIN
        --
        SELECT ds_param_cc
        INTO   v_ambiente
        FROM   cta0008_param_cc
        WHERE  cd_segmt_prdut = 1
        AND    nm_param_cc = 'AMBIENTE';
        --
        IF v_ambiente = 'CTAP' THEN
            --
            v_dt_procm := Trunc(SYSDATE);
            --
            RETURN v_dt_procm;
            --
        ELSE
            --
            BEGIN
                --
                SELECT To_Date(ds_param_cc, 'YYYYMMDD')
                INTO   v_dt_procm
                FROM   cta0008_param_cc
                WHERE  cd_segmt_prdut = 1
                AND    nm_param_cc = 'DATA_PROCESSAMENTO';
                --
                RETURN v_dt_procm;
                --
            EXCEPTION
                --
                WHEN No_Data_Found THEN
                    --
                    BEGIN
                        --
                        v_dt_procm := SSVRPFU0001_001;
                        --
                        RETURN v_dt_procm;
                        --
                    EXCEPTION
                        --
                        WHEN OTHERS THEN
                            --
                            v_dt_procm := Trunc(SYSDATE);
                            --
                            RETURN v_dt_procm;
                            --
                    END;
                    --
                WHEN OTHERS THEN
                    --
                    v_dt_procm := Trunc(SYSDATE);
                    --
                    RETURN v_dt_procm;
                    --
            END;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            v_dt_procm := Trunc(SYSDATE);
            --
            RETURN v_dt_procm;
            --
    END RetornaDtProcm;

    --
    --------------------------------------------------------------------------
    --      IsDataValida:   Valida se uma determinada data est no padro   --
    --                      valido para o projeto: YYYYMMDD.                --
    --------------------------------------------------------------------------
    --
    FUNCTION IsSegmentoValido(p_cd_segmt_prdut IN NUMBER
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_cd_segmt_prdut cta0006_segmt_prdut.cd_segmt_prdut%TYPE;
        --
    BEGIN
        --
        SELECT cd_segmt_prdut
        INTO   v_cd_segmt_prdut
        FROM   cta0006_segmt_prdut
        WHERE  cd_segmt_prdut = p_cd_segmt_prdut;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 100;
            p_msg_erro := 'Cdigo de segmento invlido';
            --
            RETURN FALSE;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 100;
            p_msg_erro := 'Erro IsSegmentoValido: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END IsSegmentoValido;

    --
    --------------------------------------------------------------------------
    --      RetornaSegmentoProduto: Busca o segmento do produto atravs do  --
    --                              sistema chamador, produto e data de     --
    --                              processamento.                          --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaSegmentoProduto(p_sistema_chamador IN VARCHAR2
                                   ,p_cd_produto       IN VARCHAR2
                                   ,p_dt_procm         IN DATE
                                   ,p_cd_erro          OUT NUMBER
                                   ,p_msg_erro         OUT VARCHAR2) RETURN NUMBER IS
        --
        v_cd_segmt_prdut   cta0001_prdut.cd_segmt_prdut%TYPE;
        v_sistema_chamador cta0001_prdut.sg_sistm_origm_prdut%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        --      Se o sistema chamador for o KCW, usar o SSV para a
        --      pesquisa
        --
        IF Upper(p_sistema_chamador) IN ('KCW', 'SPE', 'MUL') THEN
            --
            v_sistema_chamador := 'SSV';
            --
        ELSE
            --
            v_sistema_chamador := Upper(p_sistema_chamador);
            --
        END IF;
        --
        SELECT cd_segmt_prdut
        INTO   v_cd_segmt_prdut
        FROM   cta0001_prdut
        WHERE  sg_sistm_origm_prdut = v_sistema_chamador
        AND    cd_prdut_sistm_origm = p_cd_produto
        AND    dt_inico_vigen <= p_dt_procm
        AND    dt_fim_vigen >= p_dt_procm;
        --
        RETURN v_cd_segmt_prdut;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 17;
            p_msg_erro := 'Segmento do produto no encontrado';
            --
            RETURN NULL;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 18;
            p_msg_erro := 'Erro ao consultar segmento do produto: ' || SQLERRM;
            --
            RETURN NULL;
            --
    END RetornaSegmentoProduto;

    --
    --------------------------------------------------------------------------
    --      IsCorretorBloqueado:    Verifica se o corretor est bloqueado   --
    --                              para aquele segmento.                   --
    --------------------------------------------------------------------------
    --
    FUNCTION IsCorretorBloqueado(p_cd_crtor       IN NUMBER
                                ,p_cd_segmt_prdut IN NUMBER
                                ,p_cd_erro        OUT NUMBER
                                ,p_msg_erro       OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_ic_crtor_ativo_segmt cta0016_crtor_segmt.ic_crtor_ativo_segmt%TYPE;
        v_nm_segmt_prdut       cta0006_segmt_prdut.nm_segmt_prdut%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        BEGIN
            --
            SELECT ic_crtor_ativo_segmt
            INTO   v_ic_crtor_ativo_segmt
            FROM   cta0016_crtor_segmt
            WHERE  cd_crtor_segur = p_cd_crtor
            AND    cd_segmt_prdut = p_cd_segmt_prdut;
            --
        EXCEPTION
            --
            WHEN No_Data_Found THEN
                --
                RETURN FALSE;
                --
                v_ic_crtor_ativo_segmt := 'X'; --      Corretor desbloqueado
            --
            WHEN OTHERS THEN
                --
                p_cd_erro  := 19;
                p_msg_erro := 'Erro ao consultar corretor por segmento: ' || SQLERRM;
                --
                RETURN TRUE;
                --
        END;
        --
        --      Se o indicador estiver com N, significa que o corretor
        --      no est ativo para o segmento.
        --
        IF v_ic_crtor_ativo_segmt = 'N' THEN
            --
            BEGIN
                --
                SELECT nm_segmt_prdut
                INTO   v_nm_segmt_prdut
                FROM   cta0006_segmt_prdut
                WHERE  cd_segmt_prdut = p_cd_segmt_prdut;
                --
            EXCEPTION
                --
                WHEN OTHERS THEN
                    --
                    v_nm_segmt_prdut := NULL;
                    --
            END;
            --
            p_cd_erro  := 20;
            p_msg_erro := 'Corretor ' || p_cd_crtor || ' no autorizado a utilizar o conta-corrente para o segmento ' || v_nm_segmt_prdut;
            --
            RETURN TRUE;
            --
        ELSE
            --
            RETURN FALSE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 20;
            p_msg_erro := 'Erro IsCorretorBloqueado: ' || SQLERRM;
            --
            RETURN TRUE;
            --
    END IsCorretorBloqueado;

    --
    --------------------------------------------------------------------------
    --      BuscaSaldo:     Busca o saldo de verba ativa do corretor.       --
    --------------------------------------------------------------------------
    --
    FUNCTION BuscaSaldo(p_cd_crtor       IN NUMBER
                       ,p_cd_segmt_prdut IN NUMBER
                       ,p_dt_procm       IN DATE
                       ,p_cd_erro        OUT NUMBER
                       ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_vl_saldo_verba cta0002_verba.vl_saldo_verba%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT Nvl(SUM(vl_saldo_verba), 0)
        INTO   v_vl_saldo_verba
        FROM   cta0002_verba
        WHERE  cd_crtor_segur = p_cd_crtor
        AND    cd_segmt_prdut = p_cd_segmt_prdut
        AND    cd_situc_verba = 'ATI'
        AND    dt_inico_vigen <= p_dt_procm
        AND    dt_fim_vigen >= p_dt_procm;
        --
        RETURN v_vl_saldo_verba;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 22;
            p_msg_erro := 'Erro ao consultar saldo do corretor: ' || p_cd_crtor || ' Segmento: ' || p_cd_segmt_prdut || ' - ' || SQLERRM;
            --
            RETURN NULL;
            --
    END;

    --
    --------------------------------------------------------------------------
    --      ValidaSaldo:     Valida o saldo de verba ativa do corretor.     --
    --------------------------------------------------------------------------
    --
    FUNCTION ValidaSaldo(p_sq_log           IN NUMBER
                        ,p_sistema_chamador IN VARCHAR2
                        ,p_cd_crtor         IN NUMBER
                        ,p_vl_saldo_verba   IN NUMBER) RETURN NUMBER IS
        --
    BEGIN
        --
        IF p_sistema_chamador IN ('KCW', 'MUL') AND
           p_cd_crtor IN (83501) AND
           NOT(ConsultaSaldoCCStder) THEN
            --
            GravaLog(p_sq_log, '[Valida Saldo] Saldo da verba  zero porque o Sistema Chamador: KCW e o corretor 83501 e o Parametro: PERMITE_DESC_KWC_STD');
            RETURN 0;
            --
        ELSE
            --
            GravaLog(p_sq_log, '[Valida Saldo] Saldo liberado ' || p_vl_saldo_verba);
            RETURN p_vl_saldo_verba;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            GravaLog(p_sq_log, '[Valida Saldo] Erro ao validar regra de valor de saldo '  || SQLERRM);
            RETURN 0;
            --
    END;

    --
    --------------------------------------------------------------------------
    --      BuscaValorDescontoMaximo:     Busca Valor de Desconto Maximo.   --
    --------------------------------------------------------------------------
    --
    FUNCTION BuscaValorDescontoMaximo(p_sq_log           IN NUMBER
                                     ,p_cd_crtor         IN NUMBER
                                     ,p_pc_comis         IN NUMBER
                                     ,p_vl_premio        IN NUMBER
                                     ,p_pc_maxmo_desct   IN NUMBER) RETURN NUMBER IS
        --
        v_vl_max_desconto NUMBER;
        --
    BEGIN
        --
        v_vl_max_desconto := 0;
        --
        IF p_cd_crtor IN (83501) THEN
            --
            IF p_pc_comis > 0 AND p_pc_comis <= 10 THEN
                --
                IF p_vl_premio > 0 AND p_vl_premio <= 2000 THEN
                    --
                    v_vl_max_desconto := 200;
                    --
                ELSIF p_vl_premio > 2001 AND p_vl_premio <= 3000 THEN
                    --
                    v_vl_max_desconto := 300;
                    --
                ELSIF p_vl_premio > 3001 AND p_vl_premio <= 4000 THEN
                    --
                    v_vl_max_desconto := 400;
                    --
                ELSIF p_vl_premio > 4001 THEN
                    --
                    v_vl_max_desconto := 500;
                    --
                END IF;
                --
            END IF;
            --
        ELSE
            --
            v_vl_max_desconto := Trunc(p_vl_premio * (p_pc_maxmo_desct / 100), 2);
            --
        END IF;
        --
        GravaLog(p_sq_log, '[Busca Valor Desconto Maximo] Corretor ' || p_cd_crtor ||
                           ' / Comisso ' || p_pc_comis ||
                           ' / Premio ' || p_pc_maxmo_desct ||
                           ' / Percentual Maximo Desconto ' || p_pc_maxmo_desct ||
                           ' - Valor Calculado ' || v_vl_max_desconto);
        --
        RETURN v_vl_max_desconto;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            GravaLog(p_sq_log, '[Busca Valor Desconto Maximo] ao executar o valor de desconto mximo '  || SQLERRM);
            RETURN 0;
            --
    END;

    --
    --------------------------------------------------------------------------
    --      RetornaProvisaoEnd:     Verifica se j existe proviso para o   --
    --                              item / negcio do endosso.              --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaProvisaoEnd(p_cd_ngoco       IN NUMBER
                               ,p_nr_item        IN NUMBER
                               ,p_cd_crtor       IN NUMBER
                               ,p_tp_desct_agrvo OUT VARCHAR2
                               ,p_cd_erro        OUT NUMBER
                               ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_vl_lacto cta0004_lacto.vl_lacto%TYPE;
        erro_duplicidade EXCEPTION;
        --
        CURSOR c_lactos IS
        --
            SELECT a.vl_lacto
                  ,a.tp_desct_agrvo
            FROM   cta0004_lacto a
                  ,cta0002_verba b
            WHERE  a.id_verba = b.id_verba
            AND    a.cd_ctrat = p_cd_ngoco
            AND    a.cd_item_ctrat = p_nr_item
            AND    a.cd_situc_lacto = 'EFT'
            AND    a.id_lacto_estor IS NULL
            AND    b.cd_crtor_segur = p_cd_crtor
            AND    a.tp_desct_agrvo IN ('A', 'D');
    BEGIN
        --
        p_cd_erro        := 0;
        p_msg_erro       := NULL;
        p_tp_desct_agrvo := NULL;
        v_vl_lacto       := 0;
        --
        FOR r_lactos IN c_lactos LOOP
            --
            v_vl_lacto := v_vl_lacto + r_lactos.vl_lacto;
            --
            IF p_tp_desct_agrvo IS NULL THEN
                --
                p_tp_desct_agrvo := r_lactos.tp_desct_agrvo;
                --
            ELSIF p_tp_desct_agrvo <> r_lactos.tp_desct_agrvo THEN
                --
                RAISE erro_duplicidade;
                --
            END IF;
            --
        END LOOP;
        --
        RETURN v_vl_lacto;
        --
    EXCEPTION
        --
        WHEN erro_duplicidade THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Existem dos tipos de lanamento para o mesmo negcio / item';
            --
            RETURN 0;
            --
        WHEN No_Data_Found THEN
            --
            RETURN 0;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 21;
            p_msg_erro := 'Erro ao consultar existncia de proviso para o Negcio: ' || p_cd_ngoco || ' Item: ' || p_nr_item || ' Corretor: ' ||
                          p_cd_crtor || ' ' || SQLERRM;
            --
            RETURN 0;
            --
    END RetornaProvisaoEnd;

    --
    --------------------------------------------------------------------------
    --      RetornaProvisao:        Verifica se j existe proviso para o   --
    --                              item / negcio.                         --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaProvisao(p_cd_ngoco       IN NUMBER
                            ,p_nr_item        IN NUMBER
                            ,p_cd_crtor       IN NUMBER
                            ,p_tp_desct_agrvo OUT VARCHAR2
                            ,p_cd_erro        OUT NUMBER
                            ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_vl_lacto cta0004_lacto.vl_lacto%TYPE;
        erro_duplicidade EXCEPTION;
        --
        CURSOR c_lactos IS
        --
            SELECT a.vl_lacto
                  ,a.tp_desct_agrvo
            FROM   cta0004_lacto a
                  ,cta0002_verba b
            WHERE  a.id_verba = b.id_verba
            AND    a.cd_ctrat = p_cd_ngoco
            AND    a.cd_item_ctrat = p_nr_item
            AND    a.cd_situc_lacto IN ('PRO', 'LIB')
            AND    a.id_lacto_estor IS NULL
            AND    b.cd_crtor_segur = p_cd_crtor
            AND    a.tp_desct_agrvo IN ('A', 'D');
    BEGIN
        --
        p_cd_erro        := 0;
        p_msg_erro       := NULL;
        p_tp_desct_agrvo := NULL;
        v_vl_lacto       := 0;
        --
        FOR r_lactos IN c_lactos LOOP
            --
            v_vl_lacto := v_vl_lacto + r_lactos.vl_lacto;
            --
            IF p_tp_desct_agrvo IS NULL THEN
                --
                p_tp_desct_agrvo := r_lactos.tp_desct_agrvo;
                --
            ELSIF p_tp_desct_agrvo <> r_lactos.tp_desct_agrvo THEN
                --
                RAISE erro_duplicidade;
                --
            END IF;
            --
        END LOOP;
        --
        RETURN v_vl_lacto;
        --
    EXCEPTION
        --
        WHEN erro_duplicidade THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Existem dos tipos de lanamento para o mesmo negcio / item';
            --
            RETURN 0;
            --
        WHEN No_Data_Found THEN
            --
            RETURN 0;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 21;
            p_msg_erro := 'Erro ao consultar existncia de proviso para o Negcio: ' || p_cd_ngoco || ' Item: ' || p_nr_item || ' Corretor: ' ||
                          p_cd_crtor || ' ' || SQLERRM;
            --
            RETURN 0;
            --
    END RetornaProvisao;

    --
    --------------------------------------------------------------------------
    --      BuscaDescontoMax:       Busca o desconto maximo que o corretor  --
    --                              pode conceder.                          --
    --------------------------------------------------------------------------
    --
    FUNCTION BuscaDescontoMax(p_cd_mdupr       IN NUMBER
                             ,p_pc_comiss      IN NUMBER
                             ,p_dt_inico_vigen IN DATE
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_pc_maxmo_desct cta0009_pctis_comis_desct.pc_maxmo_desct%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT pc_maxmo_desct
        INTO   v_pc_maxmo_desct
        FROM   cta0009_pctis_comis_desct
        WHERE  cd_mdupr = p_cd_mdupr
        AND    pc_minmo_comis <= p_pc_comiss
        AND    pc_maxmo_comis >= p_pc_comiss
        AND    dt_inico_vigen <= p_dt_inico_vigen
        AND    dt_fim_vigen >= p_dt_inico_vigen;
        --
        RETURN v_pc_maxmo_desct;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 23;
            p_msg_erro := 'Desconto mximo no encontrado. Produto: ' || p_cd_mdupr || ' PcComissao: ' || p_pc_comiss || ' Vigncia: ' ||
                          To_Char(p_dt_inico_vigen, 'DD/MM/YYYY');
            --
            RETURN 0;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 23;
            p_msg_erro := 'Erro ao consultar desconto mximo: ' || p_cd_mdupr || ' ' || p_pc_comiss || ' - ' ||
                          To_Char(p_dt_inico_vigen, 'DD/MM/YYYY') || ' - ' || SQLERRM;
            --
            RETURN 0;
            --
    END BuscaDescontoMax;

    --
    --------------------------------------------------------------------------
    --      BuscaAgravoMax: Busca o agravo maximo que o corretor pode       --
    --                      realizar.                                       --
    --------------------------------------------------------------------------
    --
    FUNCTION BuscaAgravoMax(p_cd_segmt_prdut IN NUMBER
                           ,p_dt_procm       IN DATE
                           ,p_cd_erro        OUT NUMBER
                           ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_ds_param_cc cta0008_param_cc.ds_param_cc%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT ds_param_cc
        INTO   v_ds_param_cc
        FROM   cta0008_param_cc
        WHERE  cd_segmt_prdut = p_cd_segmt_prdut
        AND    nm_param_cc = 'AGRAVO_MAXIMO'
        AND    dt_inico_vigen_param <= p_dt_procm
        AND    dt_fim_vigen_param >= p_dt_procm;
        --
        RETURN v_ds_param_cc;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 27;
            p_msg_erro := 'Agravo mximo no encontrado para o segmento: ' || p_cd_segmt_prdut || ' data: ' || p_dt_procm || ' ' || SQLERRM;
            --
            RETURN NULL;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 27;
            p_msg_erro := 'Erro ao consultar agravo mximo para o segmento: ' || p_cd_segmt_prdut || ' data: ' || p_dt_procm || ' ' || SQLERRM;
            --
            RETURN NULL;
            --
    END BuscaAgravoMax;

    --
    --------------------------------------------------------------------------
    --      IsSistemaIndisponivel:  Verifica se o sistema est indisponvel --
    --------------------------------------------------------------------------
    --
    FUNCTION IsSistemaIndisponivel(p_cd_erro  OUT NUMBER
                                  ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_ds_param_cc cta0008_param_cc.ds_param_cc%TYPE;
        v_previsao    cta0008_param_cc.ds_param_cc%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT ds_param_cc
        INTO   v_ds_param_cc
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'SISTEMA_INDISPONIVEL';
        --
        BEGIN
            --
            SELECT ds_param_cc
            INTO   v_previsao
            FROM   cta0008_param_cc
            WHERE  nm_param_cc = 'PREVISAO_RETORNO';
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                v_previsao := NULL;
                --
        END;
        --
        IF v_ds_param_cc = 'S' THEN
            --
            p_cd_erro  := 32;
            p_msg_erro := 'Sistema conta-corrente indisponvel. Previso de normalizao: ' || v_previsao;
            --
            RETURN TRUE;
            --
        ELSE
            --
            RETURN FALSE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 33;
            p_msg_erro := 'Parmetro SISTEMA_INDISPONIVEL no cadastrado.';
            --
            RETURN TRUE;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 33;
            p_msg_erro := 'Erro ao consultar parmetro SISTEMA_INDISPONIVEL: ' || SQLERRM;
            --
            RETURN TRUE;
            --
    END IsSistemaIndisponivel;

    --
    --------------------------------------------------------------------------
    --      RetornaQtDiasEstorno:   Busca a quantidade de dias de estorno.  --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaQtDiasEstorno(p_cd_segmt_prdut IN NUMBER
                                 ,p_cd_erro        OUT NUMBER
                                 ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_qt_dias_estorno NUMBER;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT ds_param_cc
        INTO   v_qt_dias_estorno
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'QT_DIAS_ESTORNO'
        AND    cd_segmt_prdut = p_cd_segmt_prdut;
        --
        RETURN v_qt_dias_estorno;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 40;
            p_msg_erro := 'Parmetro QT_DIAS_ESTORNO no encontrado.';
            --
            RETURN NULL;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 40;
            p_msg_erro := 'Erro RetornaQtDiasEstorno: ' || SQLERRM;
            --
            RETURN NULL;
            --
    END RetornaQtDiasEstorno;

    --
    --------------------------------------------------------------------------
    --      ExisteCorretor: Verifica se um determinado corretor existe nas  --
    --                      bases do conta corrente corretor.               --
    --------------------------------------------------------------------------
    --
    FUNCTION ExisteCorretor(p_cd_crtor IN NUMBER
                           ,p_cd_erro  OUT NUMBER
                           ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_cd_crtor cta0012_crtor.cd_crtor_segur%TYPE;
        --
    BEGIN
        --
        SELECT cd_crtor_segur
        INTO   v_cd_crtor
        FROM   cta0012_crtor
        WHERE  cd_crtor_segur = p_cd_crtor;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 64;
            p_msg_erro := 'Corretor: ' || p_cd_crtor || ' no cadastrado no conta-corrente';
            --
            RETURN FALSE;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 63;
            p_msg_erro := 'Erro ExisteCorretor: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ExisteCorretor;

    --
    --------------------------------------------------------------------------
    --      IsCorretorDesabilitado: Verifica se o corretor est             --
    --                              desabilitado.                           --
    --------------------------------------------------------------------------
    --
    FUNCTION IsCorretorHabilitado(p_cd_crtor    IN NUMBER
                                 ,p_segmt_prdut IN NUMBER
                                 ,p_cd_erro     OUT NUMBER
                                 ,p_msg_erro    OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_piloto         cta0008_param_cc.ds_param_cc%TYPE;
        v_cd_crtor       cta0016_crtor_segmt.cd_crtor_segur%TYPE;
        v_nm_segmt_prdut cta0006_segmt_prdut.nm_segmt_prdut%TYPE;
        --
    BEGIN
        --
        BEGIN
            --
            SELECT ds_param_cc
            INTO   v_piloto
            FROM   cta0008_param_cc
            WHERE  nm_param_cc = 'PILOTO';
            --
        EXCEPTION
            --
            WHEN No_Data_Found THEN
                --
                p_cd_erro  := 65;
                p_msg_erro := 'Parmetro PILOTO no encontrado';
                --
                RETURN FALSE;
                --
            WHEN OTHERS THEN
                --
                p_cd_erro  := 66;
                p_msg_erro := 'Erro ao consultar tabela de parmetros [PILOTO]: ' || SQLERRM;
                --
                RETURN FALSE;
                --
        END;
        --
        IF v_piloto NOT IN ('N', 'S') THEN
            --
            p_cd_erro  := 67;
            p_msg_erro := 'Parmetro PILOTO com valor invlido: ' || v_piloto;
            --
            RETURN FALSE;
            --
        END IF;
        --
        BEGIN
            --
            SELECT nm_segmt_prdut
            INTO   v_nm_segmt_prdut
            FROM   cta0006_segmt_prdut
            WHERE  cd_segmt_prdut = p_segmt_prdut;
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                v_nm_segmt_prdut := NULL;
                --
        END;
        --
        IF v_piloto = 'S' THEN
            --
            BEGIN
                --
                SELECT cd_crtor_segur
                INTO   v_cd_crtor
                FROM   cta0016_crtor_segmt
                WHERE  cd_crtor_segur = p_cd_crtor
                AND    cd_segmt_prdut = p_segmt_prdut
                AND    ic_crtor_ativo_segmt = 'S';
                --
            EXCEPTION
                --
                WHEN No_Data_Found THEN
                    --
                    p_cd_erro  := 68;
                    p_msg_erro := 'Corretor: ' || p_cd_crtor || ' no est autorizado a utilizar o conta-corrente para o segmento: ' ||
                                  v_nm_segmt_prdut;
                    --
                    RETURN FALSE;
                    --
                WHEN OTHERS THEN
                    --
                    p_cd_erro  := 69;
                    p_msg_erro := 'Erro ao consultar corretor: ' || SQLERRM;
                    --
                    RETURN FALSE;
                    --
            END;
            --
        ELSE
            --
            BEGIN
                --
                SELECT cd_crtor_segur
                INTO   v_cd_crtor
                FROM   cta0016_crtor_segmt
                WHERE  cd_crtor_segur = p_cd_crtor
                AND    cd_segmt_prdut = p_segmt_prdut
                AND    ic_crtor_ativo_segmt = 'N';
                --
                p_cd_erro  := 68;
                p_msg_erro := 'Corretor: ' || p_cd_crtor || ' no est autorizado a utilizar o conta-corrente para o segmento: ' || v_nm_segmt_prdut;
                --
                RETURN FALSE;
                --
            EXCEPTION
                --
                WHEN No_Data_Found THEN
                    --
                    RETURN TRUE;
                    --
                WHEN OTHERS THEN
                    --
                    p_cd_erro  := 69;
                    p_msg_erro := 'Erro ao consultar corretor: ' || SQLERRM;
                    --
                    RETURN FALSE;
                    --
            END;
            --
        END IF;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 69;
            p_msg_erro := 'IsCorretorHabilitado: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END IsCorretorHabilitado;

    --
    --------------------------------------------------------------------------
    --      IsAssessoriaAtiva:      Verifica se uma determinada assessoria  --
    --                              est ativa no Acsel.                    --
    --------------------------------------------------------------------------
    --
    FUNCTION IsAssessoriaAtiva(p_cd_assess IN NUMBER
                              ,p_cd_erro   OUT NUMBER
                              ,p_msg_erro  OUT VARCHAR2) RETURN BOOLEAN IS
        --
        po_reg           acxcdpa0040_001.tab_corretor@DBL_APPLKSSVACX01;
        po_mensagem      acxcdpa0040_001.rec_mensagem@DBL_APPLKSSVACX01;
        qtde_ocorrencias NUMBER(5);
        v_chave          VARCHAR2(6);
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        v_chave := LPad(p_cd_assess, 6, '0');
        --
        BEGIN
            --
            acxcdpa0040_001.p_get_corretor@DBL_APPLKSSVACX01('000040', 2, 1, 1, po_reg, po_mensagem);
            --
        EXCEPTION
            --
            WHEN OTHERS THEN
                --
                p_cd_erro  := 70;
                p_msg_erro := 'Erro ao consultar assessoria: ' || SQLERRM;
                --
                RETURN FALSE;
                --
        END;
        --
        IF po_mensagem.status_retorno <> 0 THEN
            --
            p_cd_erro  := 70;
            p_msg_erro := po_mensagem.status_retorno || ' ' || po_mensagem.mensagem_retorno;
            --
            RETURN FALSE;
            --
        ELSE
            --
            IF po_reg(1).Statuscor <> 'ACT' THEN
                --
                p_cd_erro  := 71;
                p_msg_erro := 'Assessoria: ' || p_cd_assess || ' no est ativa.';
                --
                RETURN FALSE;
                --
            END IF;
            --
        END IF;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 70;
            p_msg_erro := 'Erro IsAssessoriaAtiva: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END IsAssessoriaAtiva;

    --
    --------------------------------------------------------------------------
    --      ValidaIdProcesso:       A partir de um cdigo de processo       --
    --                              retorna o id do mesmo                   --
    --------------------------------------------------------------------------
    --
    FUNCTION ValidaCdProcesso(p_cd_tp_processo IN NUMBER
                             ,p_cd_erro        OUT NUMBER
                             ,p_msg_erro       OUT VARCHAR2) RETURN NUMBER IS
        --
        v_id_procs cta0007_procs.id_procs%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT id_procs
        INTO   v_id_procs
        FROM   cta0007_procs
        WHERE  cd_tipo_procs = p_cd_tp_processo;
        --
        RETURN v_id_procs;
        --
    EXCEPTION
        --
        WHEN No_Data_Found THEN
            --
            p_cd_erro  := 85;
            p_msg_erro := 'Processo: ' || p_cd_tp_processo || ' no encontrado.';
            --
            RETURN NULL;
            --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 85;
            p_msg_erro := 'Erro ValidaIdProcesso - Processo: ' || p_cd_tp_processo || ' - Erro: ' || SQLERRM;
            --
            RETURN NULL;
            --
    END ValidaCdProcesso;

    --
    --------------------------------------------------------------------------
    --      RetornaDadosCorretor:   Retorna as informaes cadastrais       --
    --                              do corretor                             --
    --------------------------------------------------------------------------
    --
    PROCEDURE RetornaDadosCorretor(p_cd_crtor   IN NUMBER
                                  ,p_t_corretor OUT t_corretor) IS
        --
    BEGIN
        --
        SELECT cd_crtor_segur
              ,nm_crtor_segur
              ,cd_susep_crtor
              ,nr_cpf_cnpj_crtor
              ,cd_sucsl_comrl
              ,nm_sucsl
              ,tp_pesoa
              ,cd_diret_comrl
              ,cd_local_captc
              ,cd_asses
        INTO   p_t_corretor.cd_crtor_segur
              ,p_t_corretor.nm_crtor_segur
              ,p_t_corretor.cd_susep_crtor
              ,p_t_corretor.nr_cpf_cnpj_crtor
              ,p_t_corretor.cd_sucsl_comrl
              ,p_t_corretor.nm_sucsl
              ,p_t_corretor.tp_pesoa
              ,p_t_corretor.cd_diret_comrl
              ,p_t_corretor.cd_local_captc
              ,p_t_corretor.cd_asses
        FROM   cta0012_crtor
        WHERE  cd_crtor_segur = p_cd_crtor;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_t_corretor.cd_crtor_segur    := NULL;
            p_t_corretor.nm_crtor_segur    := NULL;
            p_t_corretor.cd_susep_crtor    := NULL;
            p_t_corretor.nr_cpf_cnpj_crtor := NULL;
            p_t_corretor.cd_sucsl_comrl    := NULL;
            p_t_corretor.nm_sucsl          := NULL;
            p_t_corretor.tp_pesoa          := NULL;
            p_t_corretor.cd_diret_comrl    := NULL;
            p_t_corretor.cd_local_captc    := NULL;
            p_t_corretor.cd_asses          := NULL;
            --
    END RetornaDadosCorretor;

    --
    --------------------------------------------------------------------------
    --      RetornaDiretoria:       Retorna o cdigo de diretoria a partir  --
    --                              de uma sucursal.                        --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaDiretoria(p_cd_sucursal IN NUMBER) RETURN NUMBER IS
        --
        v_po_loc_hierarq acxcdpa0020_001.tab_loc_hierarq@DBL_APPLKSSVACX01;
        v_po_mensagem    acxcdpa0020_001.rec_mensagem@DBL_APPLKSSVACX01;
        v_empresa        VARCHAR2(15) := 'RPSSA';
        v_tipo_local     VARCHAR2(02) := 80;
        v_vinculo        VARCHAR2(02) := 40;
        p_chave          VARCHAR2(34);
        v_cd_diret       NUMBER(5);
        --
    BEGIN
        --
        p_chave := RPad(v_empresa, 15, ' ') || v_tipo_local || LPad(p_cd_sucursal, 15, 0) || v_vinculo;
        --
        ACXCDPA0020_001.P_GET_LOCHIERAQ@DBL_APPLKSSVACX01(p_chave, 1, 1, v_po_loc_hierarq, v_po_mensagem);
        --
        IF v_po_mensagem.status_retorno = 0 THEN
            --
            IF v_po_loc_hierarq(1).codlocadm IS NULL THEN
                --
                RETURN NULL;
                --
            ELSE
                --
                v_cd_diret := v_po_loc_hierarq(1).codlocadm;
                --
                RETURN v_cd_diret;
                --
            END IF;
            --
        ELSE
            --
            RETURN NULL;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            RETURN NULL;
            --
    END RetornaDiretoria;

    --
    --------------------------------------------------------------------------
    --      RetornaDadosAssessoria: Retorna as informaes de uma           --
    --                              assessoria                              --
    --------------------------------------------------------------------------
    --
    PROCEDURE RetornaDadosAssessoria(p_cd_assessoria     IN NUMBER
                                    ,p_tp_pesoa          OUT VARCHAR2
                                    ,p_nm_crtor_segur    OUT VARCHAR2
                                    ,p_nr_cpf_cnpj_crtor OUT VARCHAR2
                                    ,p_cd_sucsl          OUT NUMBER
                                    ,p_cd_diret          OUT NUMBER
                                    ,p_cd_erro           OUT NUMBER
                                    ,p_msg_erro          OUT VARCHAR2) IS
        --
        po_reg      acxcdpa0050_001.tab_plataforma@DBL_APPLKSSVACX01;
        po_mensagem acxcdpa0050_001.rec_mensagem@DBL_APPLKSSVACX01;
        --
    BEGIN
        --
        acxcdpa0050_001.p_get_plataforma@DBL_APPLKSSVACX01(LPad(p_cd_assessoria, 7, '0'), 2, 1, 1, po_reg, po_mensagem);
        --
        IF po_mensagem.status_retorno <> 0 THEN
            --
            p_cd_erro  := po_mensagem.status_retorno;
            p_msg_erro := po_mensagem.mensagem_retorno;
            --
            RETURN;
            --
        END IF;
        --
        p_nr_cpf_cnpj_crtor := po_reg(1).Num_id || po_reg(1).Dv_id;
        --
        IF po_reg(1).Tipo_ter = 'E' THEN
            --
            p_tp_pesoa := 'J';
            --
        ELSE
            --
            p_tp_pesoa := 'F';
            --
        END IF;
        --
        p_nm_crtor_segur := po_reg(1).Nom_Plataforma;
        p_cd_sucsl       := po_reg(1).Cod_sucursal;
        p_cd_diret       := RetornaDiretoria(po_reg(1).Cod_sucursal);
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Erro RetornaDadosAssessoria: ' || SQLERRM;
            --
    END RetornaDadosAssessoria;

    --
    --------------------------------------------------------------------------
    --      ValidaValorDescAgrav:   Valida se o valor de desconto ou de     --
    --                              agravo que est sendo concedido  maior --
    --                              do que o permitido                      --
    --------------------------------------------------------------------------
    --
    FUNCTION ValidaValorDescAgrav(p_vl_descagrav IN NUMBER
                                 ,p_cd_erro      OUT NUMBER
                                 ,p_msg_erro     OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_vl_max NUMBER;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT ds_param_cc
        INTO   v_vl_max
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'VALOR_MAX_DESC_AGRAV';
        --
        IF p_vl_descagrav > v_vl_max THEN
            --
            p_cd_erro  := 101;
            p_msg_erro := 'Valor excede o limite de desconto/agravo permitido: ' || v_vl_max;
            --
            RETURN FALSE;
            --
        END IF;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Erro ValidaValorDescAgrav: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ValidaValorDescAgrav;

    --
    --------------------------------------------------------------------------------
    --      ValidaValorMinimoAgravDesc:   Valida se o valor de desconto ou de     --
    --                              agravo que est sendo concedido  menor       --
    --                              do que o permitido                            --
    --------------------------------------------------------------------------------
    --
    FUNCTION ValidaValorMinimoAgravDesc(p_vl_descagrav IN NUMBER
                                       ,p_cd_erro      OUT NUMBER
                                       ,p_msg_erro     OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_vl_min NUMBER;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        SELECT ds_param_cc
        INTO   v_vl_min
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'VALOR_MIN_DESC_AGRAV';
        --
        IF p_vl_descagrav < v_vl_min THEN
            --
            p_cd_erro  := 101;
            p_msg_erro := 'Valor excede o limite mnimo de desconto/agravo permitido: ' || v_vl_min;
            --
            RETURN FALSE;
            --
        END IF;
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 1;
            p_msg_erro := 'Erro ValidaValorMinimoAgravDesc: ' || SQLERRM;
            --
            RETURN FALSE;
            --
    END ValidaValorMinimoAgravDesc;
    --

    --
    --------------------------------------------------------------------------
    --      RetornaParametro:       Retorna o valor de um parmetro da      --
    --                              tabela de parmetros                    --
    --------------------------------------------------------------------------
    --
    FUNCTION RetornaParametro(p_nm_param IN VARCHAR2) RETURN VARCHAR2 IS
        --
        v_ds_param_cc VARCHAR2(4000);
        --
    BEGIN
        --
        SELECT ds_param_cc
        INTO   v_ds_param_cc
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = p_nm_param;
        --
        RETURN v_ds_param_cc;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            v_ds_param_cc := NULL;
            --
            RETURN v_ds_param_cc;
            --
    END RetornaParametro;

    --
    --------------------------------------------------------------------------
    --      IsCorretorValido:       Verifica se um determinado corretor     --
    --                              est cadastrado no conta corrente       --
    --------------------------------------------------------------------------
    --
    FUNCTION IsCorretorValido(p_cd_crtor IN NUMBER
                             ,p_cd_erro  OUT NUMBER
                             ,p_msg_erro OUT VARCHAR2) RETURN BOOLEAN IS
        --
        v_cd_crtor_segur cta0012_crtor.cd_crtor_segur%TYPE;
        --
    BEGIN
        --
        p_cd_erro  := 0;
        p_msg_erro := NULL;
        --
        IF p_cd_crtor IS NOT NULL THEN
            --
            SELECT cd_crtor_segur
            INTO   v_cd_crtor_segur
            FROM   cta0012_crtor
            WHERE  cd_crtor_segur = p_cd_crtor;
            --
            RETURN TRUE;
            --
        ELSE
            --
            p_cd_erro  := 4;
            p_msg_erro := 'O cdigo de corretor est nulo.';
            --
            RETURN FALSE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := 4;
            p_msg_erro := 'Corretor invlido: ' || p_cd_crtor;
            --
            RETURN FALSE;
            --
    END IsCorretorValido;

    --
    -----------------------------------------------------------------------------------
    --      IsPermiteAgravoCorretor: Verifica se o corretor passado est na lista de --
    --                               corretores que NO pode receber valor de agravo --
    -----------------------------------------------------------------------------------
    --
    FUNCTION IsPermiteAgravoCorretor(p_cd_crtor        IN NUMBER
                                    ,p_agravo_desconto IN VARCHAR2
                                    ,p_cd_erro         OUT NUMBER
                                    ,p_msg_erro        OUT VARCHAR2) RETURN BOOLEAN IS
        --
    BEGIN
        --
        IF p_cd_crtor = 83501 AND
           p_agravo_desconto = 'A' THEN
            --
            RETURN FALSE;
            --
        ELSE
            --
            RETURN TRUE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_cd_erro  := -9999;
            p_msg_erro := 'Erro no esperado p_cd_crtor: ' || p_cd_crtor || ' p_agravo_desconto: ' || p_agravo_desconto;
            --
            RETURN FALSE;
            --
    END IsPermiteAgravoCorretor;

    --
    --------------------------------------------------------------------------
    --      IniciaLog:      Grava um registro de incio de log nas tabelas  --
    --                      do conta corrente                               --
    --------------------------------------------------------------------------
    --
    PROCEDURE IniciaLog(p_id_servc          IN NUMBER
                       ,p_sg_sistm_origm    IN VARCHAR2
                       ,p_cd_crtor_segur    IN NUMBER
                       ,p_cd_asses          IN NUMBER
                       ,p_cd_ctrat          IN NUMBER
                       ,p_cd_item_ctrat     IN NUMBER
                       ,p_tp_pesoa          IN VARCHAR2
                       ,p_nr_cpf_cnpj_clien IN NUMBER
                       ,p_nm_clien_sgrdo    IN VARCHAR2
                       ,p_cd_usuro          IN VARCHAR2
                       ,p_cd_tipo_procs     IN NUMBER
                       ,p_sq_log            OUT NUMBER) IS
        --
        PRAGMA AUTONOMOUS_TRANSACTION;
        --
        v_ds_param_cc cta0008_param_cc.ds_param_cc%TYPE;
        --
    BEGIN
        --
        SELECT ctasq0017_log_servc.NEXTVAL
        INTO   p_sq_log
        FROM   dual;
        --
        INSERT INTO cta0017_log_servc
            (id_log_servc
            ,id_servc
            ,sg_sistm_origm
            ,cd_crtor_segur
            ,cd_asses
            ,cd_ctrat
            ,cd_item_ctrat
            ,tp_pesoa
            ,nr_cpf_cnpj_clien
            ,nm_clien_sgrdo
            ,cd_usuro
            ,cd_tipo_procs
            ,dt_hora_inico_log_servc
            ,dt_hora_fim_log_servc)
        --
        VALUES
            (p_sq_log
            ,p_id_servc
            ,p_sg_sistm_origm
            ,p_cd_crtor_segur
            ,p_cd_asses
            ,p_cd_ctrat
            ,p_cd_item_ctrat
            ,p_tp_pesoa
            ,p_nr_cpf_cnpj_clien
            ,p_nm_clien_sgrdo
            ,p_cd_usuro
            ,p_cd_tipo_procs
            ,SYSDATE
            ,NULL);
        --
        COMMIT;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            Dbms_Output.Put_Line('Erro IniciaLog: ' || SQLERRM);
            --
    END IniciaLog;

    --
    --------------------------------------------------------------------------
    --      GravaLog:       Grava um registro na tabela de logs             --
    --------------------------------------------------------------------------
    --
    PROCEDURE GravaLog(p_sq_log IN NUMBER
                      ,p_texto  IN VARCHAR2) IS
        --
        PRAGMA AUTONOMOUS_TRANSACTION;
        --
        arq_log  Utl_File.file_type;
        v_texto  VARCHAR2(4000);
        v_pedaco VARCHAR2(4000);
        --
    BEGIN
        --
        v_texto := p_texto;
        --
        WHILE v_texto IS NOT NULL LOOP
            --
            IF InStr(v_texto, Chr(10)) <> 0 THEN
                --
                v_pedaco := SubStr(v_texto, 1, InStr(v_texto, Chr(10)));
                --
                v_texto := SubStr(v_texto, InStr(v_texto, Chr(10)) + 1, Length(v_texto));
                --
                INSERT INTO cta0018_detal_log_servc
                    (id_detal_log_servc
                    ,id_log_servc
                    ,ds_linha_log
                    ,dt_hora_rgist_linha_log)
                --
                VALUES
                    (ctasq0018_detal_log_servc.NEXTVAL
                    ,p_sq_log
                    ,v_pedaco
                    ,SYSDATE);
                --
                COMMIT;
                --
            ELSE
                --
                INSERT INTO cta0018_detal_log_servc
                    (id_detal_log_servc
                    ,id_log_servc
                    ,ds_linha_log
                    ,dt_hora_rgist_linha_log)
                --
                VALUES
                    (ctasq0018_detal_log_servc.NEXTVAL
                    ,p_sq_log
                    ,v_texto
                    ,SYSDATE);
                --
                COMMIT;
                --
                v_texto := NULL;
                --
            END IF;
            --
        END LOOP;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            Dbms_Output.Put_Line('Erro GravaLog: ' || SQLERRM);
            --
    END GravaLog;

    --
    --------------------------------------------------------------------------
    --      FinalizaLog:    Grava a data de fim do processamento na tabela  --
    --                      de log                                          --
    --------------------------------------------------------------------------
    --
    PROCEDURE FinalizaLog(p_sq_log IN NUMBER) IS
        --
        PRAGMA AUTONOMOUS_TRANSACTION;
        --
    BEGIN
        --
        UPDATE cta0017_log_servc
        SET    dt_hora_fim_log_servc = SYSDATE
        WHERE  id_log_servc = p_sq_log;
        --
        COMMIT;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            Dbms_Output.Put_Line('Erro FinalizaLog: ' || SQLERRM);
            --
    END FinalizaLog;

    --
    --------------------------------------------------------------------------
    --      ValidaValorProvisionadoMaior:   Valida se valor esta dentro do  --
    --                                      diferencial permitido.          --
    --                                      Retorna TRUE se diferenca esta  --
    --                                      dentro do limite permitido.     --
    --                                      Retorna FALSE se diferenca no  --
    --                                      est dentro do limite permitido --
    --------------------------------------------------------------------------
    --
    FUNCTION ValidaValorProvisionadoMaior(p_cd_segm               IN NUMBER
                                         ,p_valor_agravo_desconto IN NUMBER
                                         ,p_valor_provisionado    IN NUMBER
                                         ,v_sq_log                IN NUMBER) RETURN BOOLEAN IS
        --
        v_valor_soma_amaior NUMBER;
        v_valor_confirmar   NUMBER;
        --
    BEGIN
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior] segmento informado: ' || p_cd_segm);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior] valor agravo / desconto: ' || p_valor_agravo_desconto);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior] valor provisionado: ' || p_valor_provisionado);
        --
        v_valor_soma_amaior := retornaValorSomaDescontoAgravo(p_cd_segm, v_sq_log);
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior]  valor limite: ' || v_valor_soma_amaior);
        --
        IF p_valor_agravo_desconto - p_valor_provisionado < 0 THEN
            --
            v_valor_confirmar := (p_valor_agravo_desconto - p_valor_provisionado) * -1;
            --
        ELSE
            --
            v_valor_confirmar := p_valor_agravo_desconto - p_valor_provisionado;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior]  diferenca de valores            -       ' || v_valor_confirmar -
                                  v_valor_soma_amaior);
        --
        IF v_valor_confirmar > v_valor_soma_amaior THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior] retorna FALSE se diferenca NAO esta dentro do limite permitido ');
            --
            RETURN FALSE;
            --
        END IF;
        --
        CTACTPA0100_001.GravaLog(v_sq_log, '[validaValorProvisionadoMaior] retorna TRUE se diferenca esta dentro do limite permitido ');
        --
        RETURN TRUE;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Erro validaValorProvisionadoMaior: ' || SQLERRM);
            --
            RETURN TRUE;
            --
    END validaValorProvisionadoMaior;

    --
    --------------------------------------------------------------------------
    --      retornaValorSomaDescontoAgravo: Retorna valor do parametro      --
    --                                      SOMA_DESCONTO_AGRAVO.           --
    --------------------------------------------------------------------------
    --
    FUNCTION retornaValorSomaDescontoAgravo(p_cd_segm IN NUMBER
                                           ,v_sq_log  IN NUMBER) RETURN NUMBER IS
        --
        v_param_soma_desconto_agravo VARCHAR2(10);
        --
    BEGIN
        --
        SELECT ds_param_cc
        INTO   v_param_soma_desconto_agravo
        FROM   cta0008_param_cc
        WHERE  nm_param_cc = 'SOMA_DESCONTO_AGRAVO'
        AND    cd_segmt_prdut = p_cd_segm;
        --
        RETURN To_Number(Nvl(v_param_soma_desconto_agravo, '0'));
        --
    EXCEPTION
        --
        --      Caso nao tenha registro para o parametro permite
        --      inserir registro para no atrapalhar funcionamento do
        --      processo por causa de duplicidade.
        --
        WHEN No_Data_Found THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Nao encontrou parametro: ' || v_param_soma_desconto_agravo);
            --
            RETURN 5;
            --
        WHEN OTHERS THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, 'Erro buscar valor soma desconto agravo. ' || SQLERRM);
            --
            RETURN 5;
            --
    END retornaValorSomaDescontoAgravo;

    --
    --------------------------------------------------------------------------
    --      CorretorNaoIncluiNovaVerbaEstorno: Funo responsvel por validar
    --      Se o corretor pode ou no incluir uma nova verba de estorno
    --------------------------------------------------------------------------
    --
    FUNCTION NaoIncluiNovaVerbaEstorno(p_cd_corretor IN NUMBER
                                      ,v_sq_log      IN NUMBER) RETURN BOOLEAN IS
        v_corretores cta0008_param_cc.ds_param_cc%TYPE;
    BEGIN
        --
        SELECT ';' || T.DS_PARAM_CC || ';'
        INTO   v_corretores
        FROM   CTA0008_PARAM_CC T
        WHERE  T.NM_PARAM_CC = 'NAO_INC_NOV_VERB_EST';
        --
        ---------------------------------------------------------------------
        -- Se achar o codigo do corretor no valor do parametro o corretor
        -- nao ser permitido incluir uma nova verba de estorno, mesmo que
        -- verba esteja perto da fim da vigencia.
        ---------------------------------------------------------------------
        --
        IF INSTR(v_corretores, ';' || p_cd_corretor || ';') > 0 THEN
            --
            RETURN TRUE;
            --
        ELSE
            --
            RETURN FALSE;
            --
        END IF;
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            CTACTPA0100_001.GravaLog(v_sq_log, '[CorretorNaoIncluiNovaVerbaEstorno] Ao validar se o corretor pode incluir um nova verba. ' || SQLERRM);
            --
            RETURN FALSE;
            --
    END NaoIncluiNovaVerbaEstorno;

    --
    --------------------------------------------------------------------------
    --      RetornaInfoCCCrtor
    --------------------------------------------------------------------------
    --
    PROCEDURE RetornaInfoCCCrtor(p_cd_crtor_segur IN NUMBER
                                ,p_dt_movto       IN DATE
                                ,p_vl_crd_verba   OUT NUMBER
                                ,p_vl_usado_verba OUT NUMBER
                                ,p_vl_saldo_verba OUT NUMBER) IS
        --
    BEGIN
        --
        SELECT Nvl(SUM(vl_inicl_verba), 0)
              ,Nvl(SUM(vl_eftdo_verba), 0)      +       Nvl(Sum(vl_prvsn_verba), 0)
              ,Nvl(SUM(vl_saldo_verba), 0)
        INTO   p_vl_crd_verba
              ,p_vl_usado_verba
              ,p_vl_saldo_verba
        FROM   cta0002_verba
        WHERE  cd_crtor_segur = p_cd_crtor_segur
        AND    Trunc(p_dt_movto) BETWEEN Trunc(dt_inico_vigen) AND Trunc(dt_fim_vigen)
        AND    cd_situc_verba IN ('ATI');
        --
    EXCEPTION
        --
        WHEN OTHERS THEN
            --
            p_vl_crd_verba   := 0;
            p_vl_usado_verba := 0;
            p_vl_saldo_verba := 0;
            --
    END RetornaInfoCCCrtor;
    --
        --
        --------------------------------------------------------------------------
        --      RetornaVerbasSucursal: Criado com a OS 11642 para liberar verba
        --                             automaticamente p/ corretor Santander
        --------------------------------------------------------------------------
        --
        PROCEDURE RetornaVerbasSucursal(p_cd_sucsl_comrl IN NUMBER
                                       ,p_cd_segmt_prdut IN NUMBER
                                       ,p_dt_consulta    IN DATE
                                       ,p_verbas_sucsl   OUT SYS_REFCURSOR) IS
                --
                v_sql VARCHAR2(4000);
                --
                v_dt_consulta VARCHAR2(4000);
                --
                c_cursor SYS_REFCURSOR;
                --
        BEGIN
                --
                v_dt_consulta := To_Char(p_dt_consulta, 'DD/MM/YYYY');
                --
                v_sql := 'SELECT id_verba,
                                vl_saldo_verba
                         FROM   cta0002_verba
                         WHERE   cd_sucsl_comrl  =       ' || p_cd_sucsl_comrl || '
                         AND     cd_segmt_prdut  =       ' || p_cd_segmt_prdut || '
                         AND     cd_situc_verba  =       ''ATI''
                         AND    dt_inico_vigen <= To_Date(''' || v_dt_consulta ||
                         ''',''DD/MM/YYYY'')
                         AND    dt_fim_vigen >= To_Date(''' || v_dt_consulta ||
                         ''',''DD/MM/YYYY'')
                         ORDER BY dt_inico_vigen';
                --
                OPEN p_verbas_sucsl FOR v_sql;
                --
        END RetornaVerbasSucursal;
        --
--
END CTACTPA0100_001;
/


CREATE OR REPLACE PACKAGE BODY CTACTPA0200_001 AS

        /* VERSAO V 7.8 */

        /*  CONSULTA SALDO CTA WAPPER - CTACTPA0001_001.CONSULTA_SALDO_DESCONTO_W
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_STRETORNO OUT NUMBER
            P_MSGRETORNO OUT VARCHAR2
            P_VLSALDODISPONIVEL OUT NUMBER
            P_VLDESCONTOMAXIMO OUT NUMBER
        */
        --
        PROCEDURE CONSULTA_SALDO_DESCONTO(P_SISTEMACHAMADOR IN VARCHAR2
                                         ,P_CDPRODUTO IN VARCHAR2
                                         ,P_CDCORRETOR IN NUMBER
                                         ,P_CDCONTRATO IN NUMBER
                                         ,P_CDITEMCONTRATO IN NUMBER
                                         ,P_VLPREMIOLIQUIDO IN NUMBER
                                         ,P_PCCOMISSAO IN NUMBER
                                         ,P_DTINICIOVIGENCIA IN VARCHAR2
                                         ,P_TPPESSOA IN VARCHAR2
                                         ,P_CPFCNPJCLIENTE IN NUMBER
                                         ,P_CDUSUARIO IN VARCHAR2
                                         ,P_CDPROCESSO IN NUMBER
                                         ,P_STRETORNO OUT NUMBER
                                         ,P_MSGRETORNO OUT VARCHAR2
                                         ,P_VLSALDODISPONIVEL OUT NUMBER
                                         ,P_VLDESCONTOMAXIMO OUT NUMBER) IS
          --
          V_IN       CONSULTA_SALDO_IN;
          V_OUT      CONSULTA_SALDO_OUT;
          V_DATA_PROVISAO_STDER_IN  DATE;
          --
          BEGIN
                  --
                  V_IN                      := CONSULTA_SALDO_IN(NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL);
                  --
                  V_OUT                     := CONSULTA_SALDO_OUT(NULL,
                                                                  NULL,
                                                                  NULL,
                                                                  NULL);
                  --
                  V_DATA_PROVISAO_STDER_IN  := NULL;
                  --
                  V_IN.SISTEMACHAMADOR   := P_SISTEMACHAMADOR;
                  V_IN.CDPRODUTO         := P_CDPRODUTO;
                  V_IN.CDCORRETOR        := P_CDCORRETOR;
                  V_IN.CDCONTRATO        := P_CDCONTRATO;
                  V_IN.CDITEMCONTRATO    := P_CDITEMCONTRATO;
                  V_IN.VLPREMIOLIQUIDO   := P_VLPREMIOLIQUIDO;
                  V_IN.PCCOMISSAO        := P_PCCOMISSAO;
                  V_IN.DTINICIOVIGENCIA  := P_DTINICIOVIGENCIA;
                  V_IN.TPPESSOA          := P_TPPESSOA;
                  V_IN.CPFCNPJCLIENTE    := P_CPFCNPJCLIENTE;
                  V_IN.CDUSUARIO         := P_CDUSUARIO;
                  V_IN.CDPROCESSO        := P_CDPROCESSO;
                  --
                  CTACTPA0001_001.CONSULTA_SALDO_DESCONTO(V_IN, V_OUT, V_DATA_PROVISAO_STDER_IN);
                  --
                  P_STRETORNO                         := V_OUT.STRETORNO;
                  P_MSGRETORNO                        := V_OUT.MSGRETORNO;
                  P_VLSALDODISPONIVEL                 := V_OUT.VLSALDODISPONIVEL;
                  P_VLDESCONTOMAXIMO                  := V_OUT.VLDESCONTOMAXIMO;
                  --
        END CONSULTA_SALDO_DESCONTO;
        --

        /*  VALIDA PROVISAO WAPPER - CTACTPA0002_001.VALIDA_VALOR
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_NMCLIENTE IN VARCHAR2
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_STRETORNO IN NUMBER
            P_MSGRETORNO IN VARCHAR2
        */
        --
        PROCEDURE VALIDA_VALOR(P_SISTEMACHAMADOR IN VARCHAR2
                              ,P_CDPRODUTO IN VARCHAR2
                              ,P_CDCORRETOR IN NUMBER
                              ,P_CDCONTRATO IN NUMBER
                              ,P_CDITEMCONTRATO IN NUMBER
                              ,P_INAGRAVODESCONTO IN VARCHAR2
                              ,P_VLAGRAVODESCONTO IN NUMBER
                              ,P_TPPESSOA IN VARCHAR2
                              ,P_CPFCNPJCLIENTE IN NUMBER
                              ,P_NMCLIENTE IN VARCHAR2
                              ,P_VLPREMIOLIQUIDO IN NUMBER
                              ,P_PCCOMISSAO IN NUMBER
                              ,P_DTINICIOVIGENCIA IN VARCHAR2
                              ,P_CDUSUARIO IN VARCHAR2
                              ,P_CDPROCESSO IN NUMBER
                              ,P_STRETORNO OUT NUMBER
                              ,P_MSGRETORNO OUT VARCHAR2) IS
          --
          V_IN       VALIDA_VALOR_IN;
          V_OUT      VALIDA_VALOR_OUT;
          --
          BEGIN
                  --
                  V_IN                   := VALIDA_VALOR_IN(NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL,
                                                            NULL);
                  --
                  V_OUT                  := VALIDA_VALOR_OUT(NULL,
                                                             NULL);
                  --
                  V_IN.SISTEMACHAMADOR  := P_SISTEMACHAMADOR;
                  V_IN.CDPRODUTO        := P_CDPRODUTO;
                  V_IN.CDCORRETOR       := P_CDCORRETOR;
                  V_IN.CDCONTRATO       := P_CDCONTRATO;
                  V_IN.CDITEMCONTRATO   := P_CDITEMCONTRATO;
                  V_IN.INAGRAVODESCONTO := P_INAGRAVODESCONTO;
                  V_IN.VLAGRAVODESCONTO := P_VLAGRAVODESCONTO;
                  V_IN.TPPESSOA         := P_TPPESSOA;
                  V_IN.CPFCNPJCLIENTE   := P_CPFCNPJCLIENTE;
                  V_IN.NMCLIENTE        := P_NMCLIENTE;
                  V_IN.VLPREMIOLIQUIDO  := P_VLPREMIOLIQUIDO;
                  V_IN.PCCOMISSAO       := P_PCCOMISSAO;
                  V_IN.DTINICIOVIGENCIA := P_DTINICIOVIGENCIA;
                  V_IN.CDUSUARIO        := P_CDUSUARIO;
                  V_IN.CDPROCESSO       := P_CDPROCESSO;
                  --
                  CTACTPA0002_001.VALIDA_VALOR  (V_IN, V_OUT);
                  --
                  P_STRETORNO   := V_OUT.STRETORNO;
                  P_MSGRETORNO  := V_OUT.MSGRETORNO;
                  --
        END VALIDA_VALOR;
        --

        /*  PROVISIONA VALOR WAPPER - CTACTPA0003_001.PROVISIONA_VALOR
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_NMCLIENTE IN VARCHAR2
            P_VLPREMIOLIQUIDO IN NUMBER
            P_PCCOMISSAO IN NUMBER
            P_DTINICIOVIGENCIA IN VARCHAR2
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_IDCORRELATION IN VARCHAR 2
            P_STRETORNO IN NUMBER
            P_MSGRETORNO IN VARCHAR2
            P_NRNEGOCIORESERVADO IN NUMBER
            P_NRITEMRESERVADO IN NUMBER
        */
        --
        PROCEDURE PROVISIONA_VALOR(P_SISTEMACHAMADOR IN VARCHAR2
                                  ,P_CDPRODUTO IN VARCHAR2
                                  ,P_CDCORRETOR IN NUMBER
                                  ,P_CDCONTRATO IN NUMBER
                                  ,P_CDITEMCONTRATO IN NUMBER
                                  ,P_INAGRAVODESCONTO IN VARCHAR2
                                  ,P_VLAGRAVODESCONTO IN NUMBER
                                  ,P_TPPESSOA IN VARCHAR2
                                  ,P_CPFCNPJCLIENTE IN NUMBER
                                  ,P_NMCLIENTE IN VARCHAR2
                                  ,P_VLPREMIOLIQUIDO IN NUMBER
                                  ,P_PCCOMISSAO IN NUMBER
                                  ,P_DTINICIOVIGENCIA IN VARCHAR2
                                  ,P_CDUSUARIO IN VARCHAR2
                                  ,P_CDPROCESSO IN NUMBER
                                  ,P_IDCORRELATION IN VARCHAR2
                                  ,P_STRETORNO OUT NUMBER
                                  ,P_MSGRETORNO OUT VARCHAR2
                                  ,P_NRNEGOCIORESERVADO OUT NUMBER
                                  ,P_NRITEMRESERVADO OUT NUMBER) IS
          --
          V_IN       PROVISIONA_VALOR_IN;
          V_OUT      PROVISIONA_VALOR_OUT;
          --
          BEGIN
                  --
                  V_IN                   := PROVISIONA_VALOR_IN(NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL);
                  --
                  V_OUT                  := PROVISIONA_VALOR_OUT(NULL,
                                                                 NULL,
                                                                 NULL,
                                                                 NULL);
                  --
                  V_IN.SISTEMACHAMADOR  := P_SISTEMACHAMADOR;
                  V_IN.CDPRODUTO        := P_CDPRODUTO;
                  V_IN.CDCORRETOR       := P_CDCORRETOR;
                  V_IN.CDCONTRATO       := P_CDCONTRATO;
                  V_IN.CDITEMCONTRATO   := P_CDITEMCONTRATO;
                  V_IN.INAGRAVODESCONTO := P_INAGRAVODESCONTO;
                  V_IN.VLAGRAVODESCONTO := P_VLAGRAVODESCONTO;
                  V_IN.TPPESSOA         := P_TPPESSOA;
                  V_IN.CPFCNPJCLIENTE   := P_CPFCNPJCLIENTE;
                  V_IN.NMCLIENTE        := P_NMCLIENTE;
                  V_IN.VLPREMIOLIQUIDO  := P_VLPREMIOLIQUIDO;
                  V_IN.PCCOMISSAO       := P_PCCOMISSAO;
                  V_IN.DTINICIOVIGENCIA := P_DTINICIOVIGENCIA;
                  V_IN.CDUSUARIO        := P_CDUSUARIO;
                  V_IN.CDPROCESSO       := P_CDPROCESSO;
                  V_IN.IDCORRELATION    := P_IDCORRELATION;
                  --
                  CTACTPA0003_001.PROVISIONA_VALOR(V_IN, V_OUT);
                  --
                  P_STRETORNO           := V_OUT.STRETORNO;
                  P_MSGRETORNO          := V_OUT.MSGRETORNO;
                  P_NRNEGOCIORESERVADO  := V_OUT.NRNEGOCIORESERVADO;
                  P_NRITEMRESERVADO     := V_OUT.NRITEMRESERVADO;
                  --
        END PROVISIONA_VALOR;
        --

        /*  ESTORNA PROVISAO WAPPER - CTACTPA0005_001.ESTORNA_PROVISAO
            P_SISTEMACHAMADOR IN VARCHAR2
            P_CDPRODUTO IN VARCHAR2
            P_CDCORRETOR IN NUMBER
            P_CDCONTRATO IN NUMBER
            P_CDITEMCONTRATO IN NUMBER
            P_INAGRAVODESCONTO IN VARCHAR2
            P_VLAGRAVODESCONTO IN NUMBER
            P_TPPESSOA IN VARCHAR2
            P_CPFCNPJCLIENTE IN NUMBER
            P_CDUSUARIO IN VARCHAR2
            P_CDPROCESSO IN NUMBER
            P_IDCORRELATION IN VARCHAR2;
            P_STRETORNO OUT NUMBER
            P_MSGRETORNO OUT VARCHAR2
        */
        --
        PROCEDURE ESTORNA_PROVISAO(P_SISTEMACHAMADOR IN VARCHAR2
                                  ,P_CDPRODUTO IN VARCHAR2
                                  ,P_CDCORRETOR IN NUMBER
                                  ,P_CDCONTRATO IN NUMBER
                                  ,P_CDITEMCONTRATO IN NUMBER
                                  ,P_INAGRAVODESCONTO IN VARCHAR2
                                  ,P_VLAGRAVODESCONTO IN NUMBER
                                  ,P_TPPESSOA IN VARCHAR2
                                  ,P_CPFCNPJCLIENTE IN NUMBER
                                  ,P_CDUSUARIO IN VARCHAR2
                                  ,P_CDPROCESSO IN NUMBER
                                  ,P_IDCORRELATION IN VARCHAR2
                                  ,P_STRETORNO OUT NUMBER
                                  ,P_MSGRETORNO OUT VARCHAR2) IS
          --
          V_IN       ESTORNA_PROVISAO_IN;
          V_OUT      ESTORNA_PROVISAO_OUT;
          --
          BEGIN
                  --
                  V_IN                   := ESTORNA_PROVISAO_IN(NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL,
                                                                NULL);
                  --
                  V_OUT                  := ESTORNA_PROVISAO_OUT(NULL,
                                                                 NULL);
                  --
                  V_IN.SISTEMACHAMADOR  := P_SISTEMACHAMADOR;
                  V_IN.CDPRODUTO        := P_CDPRODUTO;
                  V_IN.CDCORRETOR       := P_CDCORRETOR;
                  V_IN.CDCONTRATO       := P_CDCONTRATO;
                  V_IN.CDITEMCONTRATO   := P_CDITEMCONTRATO;
                  V_IN.INAGRAVODESCONTO := P_INAGRAVODESCONTO;
                  V_IN.VLAGRAVODESCONTO := P_VLAGRAVODESCONTO;
                  V_IN.TPPESSOA         := P_TPPESSOA;
                  V_IN.CPFCNPJCLIENTE   := P_CPFCNPJCLIENTE;
                  V_IN.CDUSUARIO        := P_CDUSUARIO;
                  V_IN.CDPROCESSO       := P_CDPROCESSO;
                  V_IN.IDCORRELATION    := P_IDCORRELATION;
                  --
                  CTACTPA0005_001.ESTORNA_PROVISAO  (V_IN, V_OUT);
                  --
                  P_STRETORNO   := V_OUT.STRETORNO;
                  P_MSGRETORNO  := V_OUT.MSGRETORNO;
                  --
        END ESTORNA_PROVISAO;
        --
END CTACTPA0200_001;
/


CREATE OR REPLACE PACKAGE BODY CTARELPA0002_STDER_FORA_PRAZO IS
        --
        FUNCTION        DtErro1000      (p_id_ppota_contr       IN      NUMBER)
        --
        RETURN          DATE    IS
        --
        v_dt_ultma_alter        DATE;
        --
        BEGIN
                --
                BEGIN
                        --
                        SELECT  Trunc(dt_ultma_alter)
                        INTO    v_dt_ultma_alter
                        FROM    ssv5050_erro_contr      a
                        WHERE   a.id_ppota_contr        =       p_id_ppota_contr
                        AND     a.cd_erro_rcel          =       1000
                        UNION
                        SELECT  Trunc(dt_ultma_alter)
                        FROM    ssv5120_histo_erro_contr        a
                        WHERE   a.id_ppota_contr        =       p_id_ppota_contr
                        AND     a.cd_erro_rcel          =       1000;
                        --
                EXCEPTION
                        --
                        WHEN Others THEN
                        --
                        v_dt_ultma_alter        :=      null;
                        --
                END;
                --
                RETURN  v_dt_ultma_alter;
                --
        END     DtErro1000;
        /*
        --------------------------------------------------------------------------
        --      PROCEDURE CARREGA_ERROS                                         --
        --------------------------------------------------------------------------
        --
        PROCEDURE       CARREGA_ERROS   IS
        --DECLARE
        --
        v_erro          NUMBER;
        --
        v_lst_err       VARCHAR2(4000);
        --
        BEGIN
                --
                v_lst_err       :=      '123,456';
                --
                WHILE   v_lst_err       IS      NOT     NULL    LOOP
                        --
                        IF      InStr(v_lst_err,        ',')    <>      0       THEN
                                --
                                v_erro  :=      SubStr(v_lst_err, 1,  InStr(v_lst_err, ',')-1);
                                --
                                v_erros(v_erro).cd_erro :=      v_erro;
                                --
                                v_lst_err       :=      SubStr(v_lst_err,       InStr(v_lst_err, ',')+1,        Length(v_lst_err));
                                --
                        ELSE
                                --
                                v_erro  :=      SubStr(v_lst_err, 1, Length(v_lst_err));
                                --
                                v_erros(v_erro).cd_erro :=      v_erro;
                                --
                                v_lst_err       :=      NULL;
                                --
                        END     IF;
                        --
                END     LOOP;
                --
                Dbms_Output.Put_Line('count: ' || v_erros.count);
                --
        EXCEPTION
                --
                WHEN    OTHERS  THEN
                        --
                        NULL;
                        --tms_gpa.erro    (v_gpa_id
                        --                ,'Erro CARREGA_ERROS: '||SQLERRM);
                        --
        END;
--        END     CARREGA_ERROS;
*/
        --
        PROCEDURE       RelatorioForaPrazo       (p_parametros   IN      admcta.t_param
                                                        ,relatorio      OUT     t_rec_retorno
                                                        ,cd_retorno     OUT     NUMBER
                                                        ,msg_retorno    OUT     VARCHAR2)       IS
        --
        v_cd_retorno    NUMBER;
        v_msg_retorno   VARCHAR2(4000);
        --
        i_retorno       NUMBER  :=      0;
        v_placa         ssv0076_itseg.cd_placa_veicu%TYPE;
        v_chassi        ssv0076_itseg.cd_chassi_veicu%TYPE;
        --
        v_qt_canc_arq_stder     NUMBER;
        --

        --
        CURSOR  c1      (p_dt_inicio    IN      DATE
                        ,p_dt_fim       IN      DATE)       IS
                --
                SELECT  a.id_ppota_stder,
                        a.cd_idetc_ppota_stder_vc,
                        b.nr_cpf_cnpj_sgrdo,
                        a.dt_inico_vigen_ppota,
                        a.dt_fim_vigen_ppota,
                        a.cd_forma_pagto
                FROM    spe1000_ppota_stder     a,
                        spe1018_sgrdo_ppota     b
                WHERE   a.id_ppota_stder                        =       b.id_ppota_stder(+)
                --AND     Trunc(a.dt_inico_vigen_ppota,   'MM')   =       To_Date(v_mes_relatorio,   'MMYYYY')
                AND     DtErro1000(a.id_ppota_stder)    BETWEEN p_dt_inicio     AND     p_dt_fim

                --
                UNION
                --
                SELECT  a.id_ppota_stder,
                        a.cd_idetc_ppota_stder_vc,
                        b.nr_cpf_cnpj_sgrdo,
                        a.dt_inico_vigen_ppota,
                        a.dt_fim_vigen_ppota,
                        a.cd_forma_pagto
                FROM    spe1100_histo_ppota_stder       a,
                        spe1118_histo_sgrdo_ppota       b
                WHERE   a.id_ppota_stder                        =       b.id_ppota_stder(+)
                --AND     Trunc(a.dt_inico_vigen_ppota,   'MM')   =       To_Date(v_mes_relatorio,   'MMYYYY')
                AND     DtErro1000(a.id_ppota_stder)    BETWEEN p_dt_inicio     AND     p_dt_fim
                --
                ORDER   BY      3,
                                2,
                                1       DESC;
                --
        CURSOR  c2      (v_proposta_vc  IN      NUMBER) IS
                --
                SELECT  a.id_ppota_contr,
                        a.cd_situc_ngoco,
                        a.cd_ngoco,
                        Decode  (a.cd_situc_ngoco
                                ,'COT', 1
                                ,'PRO', 2
                                ,'LIP', 3
                                ,'GRD', 4
                                ,'LIB', 5
                                ,'APO', 6)      AS      ranking_geral
                FROM    ssv0084_ngoco           a,
                        spe1000_ppota_stder     b
                WHERE   a.id_ppota_contr                =       b.id_ppota_stder
                AND     b.cd_idetc_ppota_stder_vc       =       v_proposta_vc
                --
                UNION
                --
                SELECT  c.id_ppota_contr,
                        c.cd_situc_ngoco,
                        c.cd_ngoco,
                        Decode  (c.cd_situc_ngoco
                                ,'COT', 1
                                ,'PRO', 2
                                ,'LIP', 3
                                ,'GRD', 4
                                ,'LIB', 5
                                ,'APO', 6)      AS      ranking_geral
                FROM    ssv0084_ngoco                   c,
                        spe1100_histo_ppota_stder       d
                WHERE   c.id_ppota_contr                =       d.id_ppota_stder
                AND     d.cd_idetc_ppota_stder_vc       =       v_proposta_vc
                --
                ORDER   BY      4       DESC;
                --
                v_dt_transmissao                DATE;
                v_id_ppota_contr                NUMBER;
                v_cd_mdupr                      NUMBER;
                v_cd_ngoco                      NUMBER;
                v_cd_rmseg                      NUMBER;
                v_dt_inico_vigen                DATE;
                v_dt_fim_vigen                  DATE;
                v_cd_situc_ngoco                VARCHAR2(3);
                v_id_forma_cobrc                NUMBER;
                v_nm_modulo_produto             VARCHAR2(400);
                v_tipo_cobranca                 VARCHAR2(15);
                v_atend_online                  VARCHAR2(4000);
                v_renovacao                     VARCHAR2(4000);
                --
                v_count_recusa_fase0            NUMBER;
                v_count_casos_nao_recusados     NUMBER;
                --
                v_cpf_cnpj_anterior             NUMBER;
                v_cpf_duplicado                 VARCHAR2(05);
                v_proposta_vc_anterior          NUMBER;
                --
                v_ranking_status                NUMBER;
                --
                v_proxima                       EXCEPTION;
                --
                v_dt_inicio                     DATE;
                v_dt_fim                        DATE;
                v_motivo_cancelamento           VARCHAR2(30);
                v_tp_restr_fechm_acetc          ssv0084_ngoco.tp_restr_fechm_acetc%TYPE;
                v_dt_emiss_apoli                ssv0007_apoli.dt_emiss_apoli%TYPE;
                v_qt_dias_emissao               NUMBER;
                v_mes_relatorio                 VARCHAR2(6);
                v_sq_log                NUMBER;
                v_propostas_vc          VARCHAR2(4000);
                --
        BEGIN
                --
                CTACTPA0100_001.IniciaLog       (191
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,1
                                ,v_sq_log);
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,p_parametros(1));
                --

                BEGIN
                        --
                        v_propostas_vc :=      p_parametros(1);
                        --
                EXCEPTION
                        --
                        WHEN    OTHERS  THEN
                                --
                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                                ,'erro v_propostas_vc' || SQLERRM);
                                --
                                cd_retorno      :=      01;
                                msg_retorno     :=      'v_propostas_vc em formato invalido. O formato correto  [proposta1],[proposta2].';
                                --
                END;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'passou do v_propostas_vc: ' || v_mes_relatorio);
                --
                FOR     r1      IN      c1      (v_dt_inicio
                                                ,v_dt_fim)       LOOP
                        --
                        BEGIN
                                --
                                --      Verificando se existe algum aquele VC
                                --      recusado na pre-recepcao
                                BEGIN
                                        --
                                        SELECT  Count(b.id_ppota_stder)
                                        INTO    v_count_recusa_fase0
                                        FROM    spe1000_ppota_stder             b
                                        WHERE   b.cd_situc_ppota                =       'R'
                                        AND     b.cd_idetc_ppota_stder_vc       =       r1.cd_idetc_ppota_stder_vc
                                        AND     NOT     EXISTS  (SELECT 1
                                                                 FROM   ssv5230_histo_ppota_contr       h
                                                                 WHERE  h.id_ppota_contr        =       b.id_ppota_stder)
                                        AND     NOT     EXISTS  (SELECT 1
                                                                 FROM   spe1000_ppota_stder     g
                                                                 WHERE  g.cd_situc_ppota                <>      'R'
                                                                 AND    g.cd_idetc_ppota_stder_vc       =       b.cd_idetc_ppota_stder_vc);
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                v_count_recusa_fase0    :=      0;
                                                --
                                END;
                                --
                                --      Verificando se no existe outro registro
                                --      com aquele VC que no esteja recusado
                                --
                                BEGIN
                                        --
                                        SELECT  Count(b.id_ppota_stder)
                                        INTO    v_count_casos_nao_recusados
                                        FROM    spe1000_ppota_stder             b,
                                                ssv5370_ppota_contr       g
                                        WHERE   b.id_ppota_stder                =       g.id_ppota_contr
                                        AND     b.cd_idetc_ppota_stder_vc       =       r1.cd_idetc_ppota_stder_vc
                                        AND     b.cd_situc_ppota                <>      'R'
                                        --
                                        UNION
                                        --
                                        SELECT  Count(b.id_ppota_stder)
                                        FROM    spe1000_ppota_stder             b,
                                                ssv5230_histo_ppota_contr       g
                                        WHERE   b.id_ppota_stder                =       g.id_ppota_contr
                                        AND     b.cd_idetc_ppota_stder_vc       =       r1.cd_idetc_ppota_stder_vc
                                        AND     b.cd_situc_ppota                <>      'R'
                                        --
                                        UNION
                                        --
                                        SELECT  Count(b.id_ppota_stder)
                                        FROM    spe1100_histo_ppota_stder             b,
                                                ssv5370_ppota_contr       g
                                        WHERE   b.id_ppota_stder                =       g.id_ppota_contr
                                        AND     b.cd_idetc_ppota_stder_vc       =       r1.cd_idetc_ppota_stder_vc
                                        AND     b.cd_situc_ppota                <>      'R'
                                        --
                                        UNION
                                        --
                                        SELECT  Count(b.id_ppota_stder)
                                        FROM    spe1100_histo_ppota_stder             b,
                                                ssv5230_histo_ppota_contr       g
                                        WHERE   b.id_ppota_stder                =       g.id_ppota_contr
                                        AND     b.cd_idetc_ppota_stder_vc       =       r1.cd_idetc_ppota_stder_vc
                                        AND     b.cd_situc_ppota                <>      'R';
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                v_count_casos_nao_recusados     :=      0;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        SELECT  Decode  (cd_situc_ngoco
                                                        ,'COT', 1
                                                        ,'PRO', 2
                                                        ,'LIP', 3
                                                        ,'GRD', 4
                                                        ,'LIB', 5
                                                        ,'APO', 6),
                                                cd_situc_ngoco,
                                                id_forma_cobrc,
                                                tp_restr_fechm_acetc
                                        INTO    v_ranking_status,
                                                v_cd_situc_ngoco,
                                                v_id_forma_cobrc,
                                                v_tp_restr_fechm_acetc
                                        FROM    ssv0084_ngoco
                                        WHERE   id_ppota_contr  =       r1.id_ppota_stder;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Erro ssv0084_ngoco: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || sqlerrm);
                                                --
                                                v_cd_situc_ngoco        :=      'REC';
                                                --
                                                v_id_forma_cobrc        :=      NULL;
                                                --
                                END;
                                --
                                --Dbms_Output.Put_Line('antes do loop ranking ' || r1.cd_idetc_ppota_stder_vc || ' ' || To_Char(SYSDATE,'hh:mi:ss'));
                                --
                                FOR     r2      IN      c2      (r1.cd_idetc_ppota_stder_vc)    LOOP
                                        --
                                        IF      v_ranking_status        <       r2.ranking_geral        THEN
                                                --
                                                --Dbms_Output.Put_Line('H proposta com status superior' || r1.id_ppota_stder || ' rank ' || v_ranking_status || ' rank geral ' || r2.ranking_geral);
                                                --
                                                RAISE   v_proxima;
                                                --
                                        END     IF;
                                        --
                                END     LOOP;
                                --
                                --Dbms_Output.Put_Line('apos o loop ranking' || To_Char(SYSDATE,'hh:mi:ss'));
                                --
                                IF      v_count_recusa_fase0            >       0
                                OR      v_count_casos_nao_recusados     >       0       THEN
                                        --
                                        --Dbms_Output.Put_Line('Quantidade de registros recusados - Fase 0: '||v_count_recusa_fase0 || r1.cd_idetc_ppota_stder_vc);
                                        --
                                        --Dbms_Output.Put_Line('Quantidade de casos no recusados - Fase 1: '||v_count_casos_nao_recusados || r1.cd_idetc_ppota_stder_vc);
                                        --
                                        RAISE   v_proxima;
                                        --
                                END     IF;
                                --
                                --      Busca proposta na recepo
                                --
                                BEGIN
                                        --
                                        SELECT  id_ppota_contr,
                                                cd_mdupr,
                                                cd_ngoco
                                        INTO    v_id_ppota_contr,
                                                v_cd_mdupr,
                                                v_cd_ngoco
                                        FROM    ssv5370_ppota_contr
                                        WHERE   id_ppota_contr  =       r1.id_ppota_stder
                                        --
                                        UNION
                                        --
                                        SELECT  id_ppota_contr,
                                                cd_mdupr,
                                                cd_ngoco
                                        FROM    ssv5230_histo_ppota_contr
                                        WHERE   id_ppota_contr  =       r1.id_ppota_stder;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'No achou proposta recepo' || r1.id_ppota_stder);
                                                --
                                                RAISE   v_proxima;
                                                --
                                END;
                                --
                                --      Busca data transmisso
                                --
                                BEGIN
                                        --
                                        SELECT  Trunc(dt_ultma_alter)
                                        INTO    v_dt_transmissao
                                        FROM    ssv5050_erro_contr
                                        WHERE   id_ppota_contr  =       r1.id_ppota_stder
                                        AND     cd_erro_rcel    =       293
                                        --
                                        UNION
                                        --
                                        SELECT  Trunc(dt_ultma_alter)
                                        FROM    ssv5120_histo_erro_contr
                                        WHERE   id_ppota_contr  =       r1.id_ppota_stder
                                        AND     cd_erro_rcel    =       293;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'No encontrou erro 293 na 5050/5120' || r1.id_ppota_stder);
                                                --
                                                RAISE   v_proxima;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        SELECT  InitCap(nm_mdulo_canal_tkmar)
                                        INTO    v_nm_modulo_produto
                                        FROM    ssv2048_mdupr  ssv2048
                                        WHERE   ssv2048.cd_mdupr        =       v_cd_mdupr
                                        AND     ssv2048.dt_inico_vigen  <=      SYSDATE
                                        AND     ssv2048.dt_fim_vigen    >=      SYSDATE;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                v_nm_modulo_produto     :=      NULL;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        SELECT  cd_rmseg,
                                                Trunc(dt_emiss_apoli)
                                        INTO    v_cd_rmseg,
                                                v_dt_emiss_apoli
                                        FROM    ssv0007_apoli
                                        WHERE   cd_ngoco        =       v_cd_ngoco;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                --Dbms_Output.Put_Line('erro ssv0007_apoli: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || sqlerrm);
                                                --
                                                v_cd_rmseg      :=      312;
                                                --
                                END;
                                --
                                BEGIN
                                        --
                                        SELECT  dt_inico_vigen,
                                                dt_fim_vigen
                                        INTO    v_dt_inico_vigen,
                                                v_dt_fim_vigen
                                        FROM    ssv0081_mdulo_ngoco
                                        WHERE   cd_ngoco        =       v_cd_ngoco;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,'Erro ssv0081_mdulo_ngoco: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || sqlerrm);
                                                --
                                                v_dt_inico_vigen        :=      r1.dt_inico_vigen_ppota;
                                                v_dt_fim_vigen          :=      r1.dt_fim_vigen_ppota;
                                                --
                                END;
                                --
                                IF      v_id_forma_cobrc        IS      NOT     NULL    THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  Decode  (tp_cobrc
                                                                ,'D',   'Dbito'
                                                                ,'F',   'Ficha'
                                                                ,tp_cobrc)
                                                INTO    v_tipo_cobranca
                                                FROM    ssv4015_forma_cobrc     ssv4015
                                                WHERE   ssv4015.id_forma_cobrc  =       v_id_forma_cobrc;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,'Erro 1 ssv4015_forma_cobrc: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || sqlerrm);
                                                        --
                                                        IF      r1.cd_forma_pagto       =       2       THEN
                                                                --
                                                                v_tipo_cobranca :=      'Dbito';
                                                                --
                                                        ELSIF   r1.cd_forma_pagto       =       5       THEN
                                                                --
                                                                v_tipo_cobranca :=      'Ficha';
                                                                --
                                                        ELSE
                                                                --
                                                                v_tipo_cobranca :=      NULL;
                                                                --
                                                        END     IF;
                                                        --
                                        END;
                                        --
                                ELSE
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'Erro 2 ssv4015_forma_cobrc: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || sqlerrm);
                                        --
                                        IF      r1.cd_forma_pagto       =       2       THEN
                                                --
                                                v_tipo_cobranca :=      'Dbito';
                                                --
                                        ELSIF   r1.cd_forma_pagto       =       5       THEN
                                                --
                                                v_tipo_cobranca :=      'Ficha';
                                                --
                                        ELSE
                                                --
                                                v_tipo_cobranca :=      NULL;
                                                --
                                        END     IF;
                                        --
                                END     IF;
                                --
                                --
                                IF      r1.nr_cpf_cnpj_sgrdo    =       v_cpf_cnpj_anterior     THEN
                                        --
                                        v_cpf_duplicado :=      'Sim';
                                        --
                                ELSE
                                        --
                                        v_cpf_duplicado :=      'No';
                                        --
                                END     IF;
                                --
                                BEGIN
                                        --
                                        SELECT  cd_placa_veicu,
                                                cd_chassi_veicu
                                        INTO    v_placa,
                                                v_chassi
                                        FROM    ssv0076_itseg
                                        WHERE   cd_ngoco        =       v_cd_ngoco;
                                        --
                                EXCEPTION
                                        --
                                        WHEN    OTHERS  THEN
                                                --
                                                CTACTPA0100_001.GravaLog        (v_sq_log
                                                ,SubStr('Erro ssv0076_itseg: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || SQLERRM,1,250));
                                                --
                                                v_placa         :=      NULL;
                                                v_chassi        :=      NULL;
                                                --
                                END;
                                --
                                IF      v_cd_situc_ngoco        =       'REC'   THEN
                                        --
                                        BEGIN
                                                --
                                                SELECT  Count(1)
                                                INTO    v_qt_canc_arq_stder
                                                FROM    ssv5120_histo_erro_contr        a
                                                WHERE   a.id_ppota_contr        =       r1.id_ppota_stder
                                                AND     a.cd_erro_rcel          =       1057;
                                                --
                                                IF      v_qt_canc_arq_stder     =       0       THEN
                                                        --
                                                        SELECT  Count(1)
                                                        INTO    v_qt_canc_arq_stder
                                                        FROM    ssv5050_erro_contr      a
                                                        WHERE   a.id_ppota_contr        =       r1.id_ppota_stder
                                                        AND     a.cd_erro_rcel          =       1057;
                                                        --
                                                END     IF;
                                                --
                                        EXCEPTION
                                                --
                                                WHEN    OTHERS  THEN
                                                        --
                                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                                        ,SubStr('Erro ssv5120_histo_erro_contr: ngoco ' || v_cd_ngoco || ' ppota : ' || r1.id_ppota_stder || SQLERRM,1,250));
                                                        --
                                                        v_qt_canc_arq_stder         :=      0;
                                        END;
                                        --
                                        IF      v_qt_canc_arq_stder     >       0       THEN
                                                --
                                                v_motivo_cancelamento   :=      'Arq Stder';
                                                --
                                        ELSE
                                                --
                                                IF      v_cd_ngoco      =       0       THEN
                                                        --
                                                        v_motivo_cancelamento   :=      'Proposta Rejeitada';
                                                        --
                                                ELSE
                                                        --
                                                        IF      v_tp_restr_fechm_acetc  =       'PAN'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Pagamento Antecipado';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'VIS'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Vistoria Prvia';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'CRI'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Crivo';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'AJU'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Ajuste';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'BON'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Bnus';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'CEN'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Cancelamento Emisso';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'REE'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Reenvio';
                                                                --
                                                        ELSIF   v_tp_restr_fechm_acetc  =       'DIV'   THEN
                                                                --
                                                                v_motivo_cancelamento   :=      'Diversas';
                                                                --
                                                        ELSE
                                                                --
                                                                v_motivo_cancelamento   :=      'No especificado';
                                                                --
                                                        END     IF;
                                                        --
                                                END     IF;
                                                --
                                        END     IF;
                                        --
                                ELSE
                                        --
                                        v_motivo_cancelamento   :=      NULL;
                                        --
                                END     IF;
                                --
                                IF      v_cd_situc_ngoco        =       'APO'   THEN
                                        --
                                        v_qt_dias_emissao       :=      v_dt_emiss_apoli        -       v_dt_transmissao;
                                        --
                                ELSE
                                        --
                                        v_qt_dias_emissao       :=      NULL;
                                        --
                                END     IF;
                                --
                                v_cpf_cnpj_anterior     :=      r1.nr_cpf_cnpj_sgrdo;
                                --
                                IF      r1.cd_idetc_ppota_stder_vc    =       v_proposta_vc_anterior  THEN
                                        --
                                        CTACTPA0100_001.GravaLog        (v_sq_log
                                        ,'VC duplicado' || r1.nr_cpf_cnpj_sgrdo || ' ' || r1.id_ppota_stder || ' ' || r1.cd_idetc_ppota_stder_vc);
                                        --
                                        RAISE   v_proxima;
                                        --
                                END     IF;
                                --
                                v_proposta_vc_anterior  :=      r1.cd_idetc_ppota_stder_vc;
                                --
                                i_retorno       :=      i_retorno       +       1;
                                --
                                relatorio(i_retorno).v_retorno_01       :=      r1.id_ppota_stder;
                                relatorio(i_retorno).v_retorno_02       :=      To_Char(v_dt_transmissao,'dd/mm/yyyy');
                                relatorio(i_retorno).v_retorno_03       :=      To_Char(v_dt_emiss_apoli,'dd/mm/yyyy');
                                relatorio(i_retorno).v_retorno_04       :=      r1.cd_idetc_ppota_stder_vc;
                                relatorio(i_retorno).v_retorno_05       :=      r1.nr_cpf_cnpj_sgrdo;
                                relatorio(i_retorno).v_retorno_06       :=      v_nm_modulo_produto;
                                relatorio(i_retorno).v_retorno_07       :=      v_cd_rmseg;
                                relatorio(i_retorno).v_retorno_08       :=      v_cd_ngoco;
                                relatorio(i_retorno).v_retorno_09       :=      To_Char(v_dt_inico_vigen,'dd/mm/yyyy');
                                relatorio(i_retorno).v_retorno_10       :=      To_Char(v_dt_fim_vigen,'dd/mm/yyyy');
                                relatorio(i_retorno).v_retorno_11       :=      v_cd_situc_ngoco;
                                relatorio(i_retorno).v_retorno_12       :=      v_motivo_cancelamento;
                                relatorio(i_retorno).v_retorno_13       :=      v_qt_dias_emissao;
                                relatorio(i_retorno).v_retorno_14       :=      v_placa;
                                relatorio(i_retorno).v_retorno_15       :=      v_chassi;
                                relatorio(i_retorno).v_retorno_16       :=      v_tipo_cobranca;
                                relatorio(i_retorno).v_retorno_17       :=      v_atend_online;
                                relatorio(i_retorno).v_retorno_18       :=      v_renovacao;
                                relatorio(i_retorno).v_retorno_19       :=      v_cpf_duplicado;
                                relatorio(i_retorno).v_retorno_20       :=      NULL;
                                --
                        EXCEPTION
                                --
                                WHEN    v_proxima       THEN
                                        --
                                        NULL;
                                        --
                        END;
                        --
                END     LOOP;
                --
                CTACTPA0100_001.GravaLog        (v_sq_log
                ,'Linhas geradas: ' || i_retorno);
                --
        END     RelatorioForaPrazo;
--
END CTARELPA0002_STDER_FORA_PRAZO;
/
